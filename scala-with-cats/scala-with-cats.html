<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="pandoc" />
<meta name="author" content="Noel Welsh and Dave Gurnell" />

<title>Scala with Cats</title>

<link href="data:text/css;charset=utf-8,%0Ahtml%20%7B%0Afont%2Dfamily%3A%20sans%2Dserif%3B%0A%2Dms%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%2Dwebkit%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%7D%0Abody%20%7B%0Amargin%3A%200%3B%0A%7D%0Aarticle%2C%0Aaside%2C%0Adetails%2C%0Afigcaption%2C%0Afigure%2C%0Afooter%2C%0Aheader%2C%0Ahgroup%2C%0Amain%2C%0Amenu%2C%0Anav%2C%0Asection%2C%0Asummary%20%7B%0Adisplay%3A%20block%3B%0A%7D%0Aaudio%2C%0Acanvas%2C%0Aprogress%2C%0Avideo%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Avertical%2Dalign%3A%20baseline%3B%0A%7D%0Aaudio%3Anot%28%5Bcontrols%5D%29%20%7B%0Adisplay%3A%20none%3B%0Aheight%3A%200%3B%0A%7D%0A%5Bhidden%5D%2C%0Atemplate%20%7B%0Adisplay%3A%20none%3B%0A%7D%0Aa%20%7B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0Aa%3Aactive%2C%0Aa%3Ahover%20%7B%0Aoutline%3A%200%3B%0A%7D%0Aabbr%5Btitle%5D%20%7B%0Aborder%2Dbottom%3A%201px%20dotted%3B%0A%7D%0Ab%2C%0Astrong%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Adfn%20%7B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0Ah1%20%7B%0Afont%2Dsize%3A%202em%3B%0Amargin%3A%200%2E67em%200%3B%0A%7D%0Amark%20%7B%0Abackground%3A%20%23ff0%3B%0Acolor%3A%20%23000%3B%0A%7D%0Asmall%20%7B%0Afont%2Dsize%3A%2080%25%3B%0A%7D%0Asub%2C%0Asup%20%7B%0Afont%2Dsize%3A%2075%25%3B%0Aline%2Dheight%3A%200%3B%0Aposition%3A%20relative%3B%0Avertical%2Dalign%3A%20baseline%3B%0A%7D%0Asup%20%7B%0Atop%3A%20%2D0%2E5em%3B%0A%7D%0Asub%20%7B%0Abottom%3A%20%2D0%2E25em%3B%0A%7D%0Aimg%20%7B%0Aborder%3A%200%3B%0A%7D%0Asvg%3Anot%28%3Aroot%29%20%7B%0Aoverflow%3A%20hidden%3B%0A%7D%0Afigure%20%7B%0Amargin%3A%201em%2040px%3B%0A%7D%0Ahr%20%7B%0Abox%2Dsizing%3A%20content%2Dbox%3B%0Aheight%3A%200%3B%0A%7D%0Apre%20%7B%0Aoverflow%3A%20auto%3B%0A%7D%0Acode%2C%0Akbd%2C%0Apre%2C%0Asamp%20%7B%0Afont%2Dfamily%3A%20monospace%2C%20monospace%3B%0Afont%2Dsize%3A%201em%3B%0A%7D%0Abutton%2C%0Ainput%2C%0Aoptgroup%2C%0Aselect%2C%0Atextarea%20%7B%0Acolor%3A%20inherit%3B%0Afont%3A%20inherit%3B%0Amargin%3A%200%3B%0A%7D%0Abutton%20%7B%0Aoverflow%3A%20visible%3B%0A%7D%0Abutton%2C%0Aselect%20%7B%0Atext%2Dtransform%3A%20none%3B%0A%7D%0Abutton%2C%0Ahtml%20input%5Btype%3D%22button%22%5D%2C%0Ainput%5Btype%3D%22reset%22%5D%2C%0Ainput%5Btype%3D%22submit%22%5D%20%7B%0A%2Dwebkit%2Dappearance%3A%20button%3B%0Acursor%3A%20pointer%3B%0A%7D%0Abutton%5Bdisabled%5D%2C%0Ahtml%20input%5Bdisabled%5D%20%7B%0Acursor%3A%20default%3B%0A%7D%0Abutton%3A%3A%2Dmoz%2Dfocus%2Dinner%2C%0Ainput%3A%3A%2Dmoz%2Dfocus%2Dinner%20%7B%0Aborder%3A%200%3B%0Apadding%3A%200%3B%0A%7D%0Ainput%20%7B%0Aline%2Dheight%3A%20normal%3B%0A%7D%0Ainput%5Btype%3D%22checkbox%22%5D%2C%0Ainput%5Btype%3D%22radio%22%5D%20%7B%0Abox%2Dsizing%3A%20border%2Dbox%3B%0Apadding%3A%200%3B%0A%7D%0Ainput%5Btype%3D%22number%22%5D%3A%3A%2Dwebkit%2Dinner%2Dspin%2Dbutton%2C%0Ainput%5Btype%3D%22number%22%5D%3A%3A%2Dwebkit%2Douter%2Dspin%2Dbutton%20%7B%0Aheight%3A%20auto%3B%0A%7D%0Ainput%5Btype%3D%22search%22%5D%20%7B%0A%2Dwebkit%2Dappearance%3A%20textfield%3B%0Abox%2Dsizing%3A%20content%2Dbox%3B%0A%7D%0Ainput%5Btype%3D%22search%22%5D%3A%3A%2Dwebkit%2Dsearch%2Dcancel%2Dbutton%2C%0Ainput%5Btype%3D%22search%22%5D%3A%3A%2Dwebkit%2Dsearch%2Ddecoration%20%7B%0A%2Dwebkit%2Dappearance%3A%20none%3B%0A%7D%0Afieldset%20%7B%0Aborder%3A%201px%20solid%20%23c0c0c0%3B%0Amargin%3A%200%202px%3B%0Apadding%3A%200%2E35em%200%2E625em%200%2E75em%3B%0A%7D%0Alegend%20%7B%0Aborder%3A%200%3B%0Apadding%3A%200%3B%0A%7D%0Atextarea%20%7B%0Aoverflow%3A%20auto%3B%0A%7D%0Aoptgroup%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Atable%20%7B%0Aborder%2Dcollapse%3A%20collapse%3B%0Aborder%2Dspacing%3A%200%3B%0A%7D%0Atd%2C%0Ath%20%7B%0Apadding%3A%200%3B%0A%7D%0A%0A%40media%20print%20%7B%0A%2A%2C%0A%2A%3Abefore%2C%0A%2A%3Aafter%20%7B%0Abackground%3A%20transparent%20%21important%3B%0Acolor%3A%20%23000%20%21important%3B%0Abox%2Dshadow%3A%20none%20%21important%3B%0Atext%2Dshadow%3A%20none%20%21important%3B%0A%7D%0Aa%2C%0Aa%3Avisited%20%7B%0Atext%2Ddecoration%3A%20underline%3B%0A%7D%0Aa%5Bhref%5D%3Aafter%20%7B%0Acontent%3A%20%22%20%28%22%20attr%28href%29%20%22%29%22%3B%0A%7D%0Aabbr%5Btitle%5D%3Aafter%20%7B%0Acontent%3A%20%22%20%28%22%20attr%28title%29%20%22%29%22%3B%0A%7D%0Aa%5Bhref%5E%3D%22%23%22%5D%3Aafter%2C%0Aa%5Bhref%5E%3D%22javascript%3A%22%5D%3Aafter%20%7B%0Acontent%3A%20%22%22%3B%0A%7D%0Apre%2C%0Ablockquote%20%7B%0Aborder%3A%201px%20solid%20%23999%3B%0Apage%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0Athead%20%7B%0Adisplay%3A%20table%2Dheader%2Dgroup%3B%0A%7D%0Atr%2C%0Aimg%20%7B%0Apage%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0Aimg%20%7B%0Amax%2Dwidth%3A%20100%25%20%21important%3B%0A%7D%0Ap%2C%0Ah2%2C%0Ah3%20%7B%0Aorphans%3A%203%3B%0Awidows%3A%203%3B%0A%7D%0Ah2%2C%0Ah3%20%7B%0Apage%2Dbreak%2Dafter%3A%20avoid%3B%0A%7D%0A%2Enavbar%20%7B%0Adisplay%3A%20none%3B%0A%7D%0A%2Ebtn%20%3E%20%2Ecaret%2C%0A%2Edropup%20%3E%20%2Ebtn%20%3E%20%2Ecaret%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23000%20%21important%3B%0A%7D%0A%2Elabel%20%7B%0Aborder%3A%201px%20solid%20%23000%3B%0A%7D%0A%2Etable%20%7B%0Aborder%2Dcollapse%3A%20collapse%20%21important%3B%0A%7D%0A%2Etable%20td%2C%0A%2Etable%20th%20%7B%0Abackground%2Dcolor%3A%20%23fff%20%21important%3B%0A%7D%0A%2Etable%2Dbordered%20th%2C%0A%2Etable%2Dbordered%20td%20%7B%0Aborder%3A%201px%20solid%20%23ddd%20%21important%3B%0A%7D%0A%7D%0A%2A%20%7B%0A%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0Abox%2Dsizing%3A%20border%2Dbox%3B%0A%7D%0A%2A%3Abefore%2C%0A%2A%3Aafter%20%7B%0A%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0Abox%2Dsizing%3A%20border%2Dbox%3B%0A%7D%0Ahtml%20%7B%0Afont%2Dsize%3A%2010px%3B%0A%2Dwebkit%2Dtap%2Dhighlight%2Dcolor%3A%20rgba%280%2C%200%2C%200%2C%200%29%3B%0A%7D%0Abody%20%7B%0Afont%2Dfamily%3A%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2020px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20%23333333%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0Ainput%2C%0Abutton%2C%0Aselect%2C%0Atextarea%20%7B%0Afont%2Dfamily%3A%20inherit%3B%0Afont%2Dsize%3A%20inherit%3B%0Aline%2Dheight%3A%20inherit%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%23337ab7%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%2C%0Aa%3Afocus%20%7B%0Acolor%3A%20%2323527c%3B%0Atext%2Ddecoration%3A%20underline%3B%0A%7D%0Aa%3Afocus%20%7B%0Aoutline%3A%205px%20auto%20%2Dwebkit%2Dfocus%2Dring%2Dcolor%3B%0Aoutline%2Doffset%3A%20%2D2px%3B%0A%7D%0Afigure%20%7B%0Amargin%3A%200%3B%0A%7D%0Aimg%20%7B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Eimg%2Dresponsive%20%7B%0Adisplay%3A%20block%3B%0Amax%2Dwidth%3A%20100%25%3B%0Aheight%3A%20auto%3B%0A%7D%0A%2Eimg%2Drounded%20%7B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Eimg%2Dthumbnail%20%7B%0Apadding%3A%204px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Aborder%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dradius%3A%200px%3B%0A%2Dwebkit%2Dtransition%3A%20all%200%2E2s%20ease%2Din%2Dout%3B%0A%2Do%2Dtransition%3A%20all%200%2E2s%20ease%2Din%2Dout%3B%0Atransition%3A%20all%200%2E2s%20ease%2Din%2Dout%3B%0Adisplay%3A%20inline%2Dblock%3B%0Amax%2Dwidth%3A%20100%25%3B%0Aheight%3A%20auto%3B%0A%7D%0A%2Eimg%2Dcircle%20%7B%0Aborder%2Dradius%3A%2050%25%3B%0A%7D%0Ahr%20%7B%0Amargin%2Dtop%3A%2035px%3B%0Amargin%2Dbottom%3A%2035px%3B%0Aborder%3A%200%3B%0Aborder%2Dtop%3A%201px%20solid%20%23eeeeee%3B%0A%7D%0A%2Esr%2Donly%20%7B%0Aposition%3A%20absolute%3B%0Awidth%3A%201px%3B%0Aheight%3A%201px%3B%0Amargin%3A%20%2D1px%3B%0Apadding%3A%200%3B%0Aoverflow%3A%20hidden%3B%0Aclip%3A%20rect%280%2C%200%2C%200%2C%200%29%3B%0Aborder%3A%200%3B%0A%7D%0A%2Esr%2Donly%2Dfocusable%3Aactive%2C%0A%2Esr%2Donly%2Dfocusable%3Afocus%20%7B%0Aposition%3A%20static%3B%0Awidth%3A%20auto%3B%0Aheight%3A%20auto%3B%0Amargin%3A%200%3B%0Aoverflow%3A%20visible%3B%0Aclip%3A%20auto%3B%0A%7D%0A%5Brole%3D%22button%22%5D%20%7B%0Acursor%3A%20pointer%3B%0A%7D%0Ah1%2C%0Ah2%2C%0Ah3%2C%0Ah4%2C%0Ah5%2C%0Ah6%2C%0A%2Eh1%2C%0A%2Eh2%2C%0A%2Eh3%2C%0A%2Eh4%2C%0A%2Eh5%2C%0A%2Eh6%20%7B%0Afont%2Dfamily%3A%20inherit%3B%0Afont%2Dweight%3A%20200%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20inherit%3B%0A%7D%0Ah1%20small%2C%0Ah2%20small%2C%0Ah3%20small%2C%0Ah4%20small%2C%0Ah5%20small%2C%0Ah6%20small%2C%0A%2Eh1%20small%2C%0A%2Eh2%20small%2C%0A%2Eh3%20small%2C%0A%2Eh4%20small%2C%0A%2Eh5%20small%2C%0A%2Eh6%20small%2C%0Ah1%20%2Esmall%2C%0Ah2%20%2Esmall%2C%0Ah3%20%2Esmall%2C%0Ah4%20%2Esmall%2C%0Ah5%20%2Esmall%2C%0Ah6%20%2Esmall%2C%0A%2Eh1%20%2Esmall%2C%0A%2Eh2%20%2Esmall%2C%0A%2Eh3%20%2Esmall%2C%0A%2Eh4%20%2Esmall%2C%0A%2Eh5%20%2Esmall%2C%0A%2Eh6%20%2Esmall%20%7B%0Afont%2Dweight%3A%20normal%3B%0Aline%2Dheight%3A%201%3B%0Acolor%3A%20%23777777%3B%0A%7D%0Ah1%2C%0A%2Eh1%2C%0Ah2%2C%0A%2Eh2%2C%0Ah3%2C%0A%2Eh3%20%7B%0Amargin%2Dtop%3A%2035px%3B%0Amargin%2Dbottom%3A%2017%2E5px%3B%0A%7D%0Ah1%20small%2C%0A%2Eh1%20small%2C%0Ah2%20small%2C%0A%2Eh2%20small%2C%0Ah3%20small%2C%0A%2Eh3%20small%2C%0Ah1%20%2Esmall%2C%0A%2Eh1%20%2Esmall%2C%0Ah2%20%2Esmall%2C%0A%2Eh2%20%2Esmall%2C%0Ah3%20%2Esmall%2C%0A%2Eh3%20%2Esmall%20%7B%0Afont%2Dsize%3A%2065%25%3B%0A%7D%0Ah4%2C%0A%2Eh4%2C%0Ah5%2C%0A%2Eh5%2C%0Ah6%2C%0A%2Eh6%20%7B%0Amargin%2Dtop%3A%2017%2E5px%3B%0Amargin%2Dbottom%3A%2017%2E5px%3B%0A%7D%0Ah4%20small%2C%0A%2Eh4%20small%2C%0Ah5%20small%2C%0A%2Eh5%20small%2C%0Ah6%20small%2C%0A%2Eh6%20small%2C%0Ah4%20%2Esmall%2C%0A%2Eh4%20%2Esmall%2C%0Ah5%20%2Esmall%2C%0A%2Eh5%20%2Esmall%2C%0Ah6%20%2Esmall%2C%0A%2Eh6%20%2Esmall%20%7B%0Afont%2Dsize%3A%2075%25%3B%0A%7D%0Ah1%2C%0A%2Eh1%20%7B%0Afont%2Dsize%3A%2052px%3B%0A%7D%0Ah2%2C%0A%2Eh2%20%7B%0Afont%2Dsize%3A%2043px%3B%0A%7D%0Ah3%2C%0A%2Eh3%20%7B%0Afont%2Dsize%3A%2034px%3B%0A%7D%0Ah4%2C%0A%2Eh4%20%7B%0Afont%2Dsize%3A%2025px%3B%0A%7D%0Ah5%2C%0A%2Eh5%20%7B%0Afont%2Dsize%3A%2020px%3B%0A%7D%0Ah6%2C%0A%2Eh6%20%7B%0Afont%2Dsize%3A%2017px%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%200%2017%2E5px%3B%0A%7D%0A%2Elead%20%7B%0Amargin%2Dbottom%3A%2035px%3B%0Afont%2Dsize%3A%2023px%3B%0Afont%2Dweight%3A%20300%3B%0Aline%2Dheight%3A%201%2E4%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Elead%20%7B%0Afont%2Dsize%3A%2030px%3B%0A%7D%0A%7D%0Asmall%2C%0A%2Esmall%20%7B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Amark%2C%0A%2Emark%20%7B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0Apadding%3A%20%2E2em%3B%0A%7D%0A%2Etext%2Dleft%20%7B%0Atext%2Dalign%3A%20left%3B%0A%7D%0A%2Etext%2Dright%20%7B%0Atext%2Dalign%3A%20right%3B%0A%7D%0A%2Etext%2Dcenter%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%2Etext%2Djustify%20%7B%0Atext%2Dalign%3A%20justify%3B%0A%7D%0A%2Etext%2Dnowrap%20%7B%0Awhite%2Dspace%3A%20nowrap%3B%0A%7D%0A%2Etext%2Dlowercase%20%7B%0Atext%2Dtransform%3A%20lowercase%3B%0A%7D%0A%2Etext%2Duppercase%20%7B%0Atext%2Dtransform%3A%20uppercase%3B%0A%7D%0A%2Etext%2Dcapitalize%20%7B%0Atext%2Dtransform%3A%20capitalize%3B%0A%7D%0A%2Etext%2Dmuted%20%7B%0Acolor%3A%20%23777777%3B%0A%7D%0A%2Etext%2Dprimary%20%7B%0Acolor%3A%20%23337ab7%3B%0A%7D%0Aa%2Etext%2Dprimary%3Ahover%2C%0Aa%2Etext%2Dprimary%3Afocus%20%7B%0Acolor%3A%20%23286090%3B%0A%7D%0A%2Etext%2Dsuccess%20%7B%0Acolor%3A%20%233c763d%3B%0A%7D%0Aa%2Etext%2Dsuccess%3Ahover%2C%0Aa%2Etext%2Dsuccess%3Afocus%20%7B%0Acolor%3A%20%232b542c%3B%0A%7D%0A%2Etext%2Dinfo%20%7B%0Acolor%3A%20%2331708f%3B%0A%7D%0Aa%2Etext%2Dinfo%3Ahover%2C%0Aa%2Etext%2Dinfo%3Afocus%20%7B%0Acolor%3A%20%23245269%3B%0A%7D%0A%2Etext%2Dwarning%20%7B%0Acolor%3A%20%238a6d3b%3B%0A%7D%0Aa%2Etext%2Dwarning%3Ahover%2C%0Aa%2Etext%2Dwarning%3Afocus%20%7B%0Acolor%3A%20%2366512c%3B%0A%7D%0A%2Etext%2Ddanger%20%7B%0Acolor%3A%20%23a94442%3B%0A%7D%0Aa%2Etext%2Ddanger%3Ahover%2C%0Aa%2Etext%2Ddanger%3Afocus%20%7B%0Acolor%3A%20%23843534%3B%0A%7D%0A%2Ebg%2Dprimary%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0A%7D%0Aa%2Ebg%2Dprimary%3Ahover%2C%0Aa%2Ebg%2Dprimary%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23286090%3B%0A%7D%0A%2Ebg%2Dsuccess%20%7B%0Abackground%2Dcolor%3A%20%23dff0d8%3B%0A%7D%0Aa%2Ebg%2Dsuccess%3Ahover%2C%0Aa%2Ebg%2Dsuccess%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23c1e2b3%3B%0A%7D%0A%2Ebg%2Dinfo%20%7B%0Abackground%2Dcolor%3A%20%23d9edf7%3B%0A%7D%0Aa%2Ebg%2Dinfo%3Ahover%2C%0Aa%2Ebg%2Dinfo%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23afd9ee%3B%0A%7D%0A%2Ebg%2Dwarning%20%7B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0A%7D%0Aa%2Ebg%2Dwarning%3Ahover%2C%0Aa%2Ebg%2Dwarning%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23f7ecb5%3B%0A%7D%0A%2Ebg%2Ddanger%20%7B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0A%7D%0Aa%2Ebg%2Ddanger%3Ahover%2C%0Aa%2Ebg%2Ddanger%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23e4b9b9%3B%0A%7D%0A%2Epage%2Dheader%20%7B%0Apadding%2Dbottom%3A%2016%2E5px%3B%0Amargin%3A%2070px%200%2035px%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23eeeeee%3B%0A%7D%0Aul%2C%0Aol%20%7B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%2017%2E5px%3B%0A%7D%0Aul%20ul%2C%0Aol%20ul%2C%0Aul%20ol%2C%0Aol%20ol%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Elist%2Dunstyled%20%7B%0Apadding%2Dleft%3A%200%3B%0Alist%2Dstyle%3A%20none%3B%0A%7D%0A%2Elist%2Dinline%20%7B%0Apadding%2Dleft%3A%200%3B%0Alist%2Dstyle%3A%20none%3B%0Amargin%2Dleft%3A%20%2D5px%3B%0A%7D%0A%2Elist%2Dinline%20%3E%20li%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Apadding%2Dleft%3A%205px%3B%0Apadding%2Dright%3A%205px%3B%0A%7D%0Adl%20%7B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%2035px%3B%0A%7D%0Adt%2C%0Add%20%7B%0Aline%2Dheight%3A%201%2E75%3B%0A%7D%0Adt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Add%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Edl%2Dhorizontal%20dt%20%7B%0Afloat%3A%20left%3B%0Awidth%3A%20160px%3B%0Aclear%3A%20left%3B%0Atext%2Dalign%3A%20right%3B%0Aoverflow%3A%20hidden%3B%0Atext%2Doverflow%3A%20ellipsis%3B%0Awhite%2Dspace%3A%20nowrap%3B%0A%7D%0A%2Edl%2Dhorizontal%20dd%20%7B%0Amargin%2Dleft%3A%20180px%3B%0A%7D%0A%7D%0Aabbr%5Btitle%5D%2C%0Aabbr%5Bdata%2Doriginal%2Dtitle%5D%20%7B%0Acursor%3A%20help%3B%0Aborder%2Dbottom%3A%201px%20dotted%20%23777777%3B%0A%7D%0A%2Einitialism%20%7B%0Afont%2Dsize%3A%2090%25%3B%0Atext%2Dtransform%3A%20uppercase%3B%0A%7D%0Ablockquote%20%7B%0Apadding%3A%2017%2E5px%2035px%3B%0Amargin%3A%200%200%2035px%3B%0Afont%2Dsize%3A%2025px%3B%0Aborder%2Dleft%3A%205px%20solid%20%23eeeeee%3B%0A%7D%0Ablockquote%20p%3Alast%2Dchild%2C%0Ablockquote%20ul%3Alast%2Dchild%2C%0Ablockquote%20ol%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Ablockquote%20footer%2C%0Ablockquote%20small%2C%0Ablockquote%20%2Esmall%20%7B%0Adisplay%3A%20block%3B%0Afont%2Dsize%3A%2080%25%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20%23777777%3B%0A%7D%0Ablockquote%20footer%3Abefore%2C%0Ablockquote%20small%3Abefore%2C%0Ablockquote%20%2Esmall%3Abefore%20%7B%0Acontent%3A%20%27%5C2014%20%5C00A0%27%3B%0A%7D%0A%2Eblockquote%2Dreverse%2C%0Ablockquote%2Epull%2Dright%20%7B%0Apadding%2Dright%3A%2015px%3B%0Apadding%2Dleft%3A%200%3B%0Aborder%2Dright%3A%205px%20solid%20%23eeeeee%3B%0Aborder%2Dleft%3A%200%3B%0Atext%2Dalign%3A%20right%3B%0A%7D%0A%2Eblockquote%2Dreverse%20footer%3Abefore%2C%0Ablockquote%2Epull%2Dright%20footer%3Abefore%2C%0A%2Eblockquote%2Dreverse%20small%3Abefore%2C%0Ablockquote%2Epull%2Dright%20small%3Abefore%2C%0A%2Eblockquote%2Dreverse%20%2Esmall%3Abefore%2C%0Ablockquote%2Epull%2Dright%20%2Esmall%3Abefore%20%7B%0Acontent%3A%20%27%27%3B%0A%7D%0A%2Eblockquote%2Dreverse%20footer%3Aafter%2C%0Ablockquote%2Epull%2Dright%20footer%3Aafter%2C%0A%2Eblockquote%2Dreverse%20small%3Aafter%2C%0Ablockquote%2Epull%2Dright%20small%3Aafter%2C%0A%2Eblockquote%2Dreverse%20%2Esmall%3Aafter%2C%0Ablockquote%2Epull%2Dright%20%2Esmall%3Aafter%20%7B%0Acontent%3A%20%27%5C00A0%20%5C2014%27%3B%0A%7D%0Aaddress%20%7B%0Amargin%2Dbottom%3A%2035px%3B%0Afont%2Dstyle%3A%20normal%3B%0Aline%2Dheight%3A%201%2E75%3B%0A%7D%0Acode%2C%0Akbd%2C%0Apre%2C%0Asamp%20%7B%0Afont%2Dfamily%3A%20Menlo%2C%20Monaco%2C%20Consolas%2C%20%22Courier%20New%22%2C%20monospace%3B%0A%7D%0Acode%20%7B%0Apadding%3A%202px%204px%3B%0Afont%2Dsize%3A%2090%25%3B%0Acolor%3A%20%23c7254e%3B%0Abackground%2Dcolor%3A%20%23f9f2f4%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0Akbd%20%7B%0Apadding%3A%202px%204px%3B%0Afont%2Dsize%3A%2090%25%3B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23333%3B%0Aborder%2Dradius%3A%200px%3B%0Abox%2Dshadow%3A%20inset%200%20%2D1px%200%20rgba%280%2C%200%2C%200%2C%200%2E25%29%3B%0A%7D%0Akbd%20kbd%20%7B%0Apadding%3A%200%3B%0Afont%2Dsize%3A%20100%25%3B%0Afont%2Dweight%3A%20bold%3B%0Abox%2Dshadow%3A%20none%3B%0A%7D%0Apre%20%7B%0Adisplay%3A%20block%3B%0Apadding%3A%2017px%3B%0Amargin%3A%200%200%2017%2E5px%3B%0Afont%2Dsize%3A%2019px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Aword%2Dbreak%3A%20break%2Dall%3B%0Aword%2Dwrap%3A%20break%2Dword%3B%0Acolor%3A%20%23333333%3B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0Apre%20code%20%7B%0Apadding%3A%200%3B%0Afont%2Dsize%3A%20inherit%3B%0Acolor%3A%20inherit%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%0Abackground%2Dcolor%3A%20transparent%3B%0Aborder%2Dradius%3A%200%3B%0A%7D%0A%2Epre%2Dscrollable%20%7B%0Amax%2Dheight%3A%20340px%3B%0Aoverflow%2Dy%3A%20scroll%3B%0A%7D%0A%2Econtainer%20%7B%0Amargin%2Dright%3A%20auto%3B%0Amargin%2Dleft%3A%20auto%3B%0Apadding%2Dleft%3A%2015px%3B%0Apadding%2Dright%3A%2015px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Econtainer%20%7B%0Awidth%3A%20750px%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20%7B%0A%2Econtainer%20%7B%0Awidth%3A%20970px%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Econtainer%20%7B%0Awidth%3A%20970px%3B%0A%7D%0A%7D%0A%2Econtainer%2Dfluid%20%7B%0Amargin%2Dright%3A%20auto%3B%0Amargin%2Dleft%3A%20auto%3B%0Apadding%2Dleft%3A%2015px%3B%0Apadding%2Dright%3A%2015px%3B%0A%7D%0A%2Erow%20%7B%0Amargin%2Dleft%3A%20%2D15px%3B%0Amargin%2Dright%3A%20%2D15px%3B%0A%7D%0A%2Ecol%2Dxs%2D1%2C%20%2Ecol%2Dsm%2D1%2C%20%2Ecol%2Dmd%2D1%2C%20%2Ecol%2Dlg%2D1%2C%20%2Ecol%2Dxs%2D2%2C%20%2Ecol%2Dsm%2D2%2C%20%2Ecol%2Dmd%2D2%2C%20%2Ecol%2Dlg%2D2%2C%20%2Ecol%2Dxs%2D3%2C%20%2Ecol%2Dsm%2D3%2C%20%2Ecol%2Dmd%2D3%2C%20%2Ecol%2Dlg%2D3%2C%20%2Ecol%2Dxs%2D4%2C%20%2Ecol%2Dsm%2D4%2C%20%2Ecol%2Dmd%2D4%2C%20%2Ecol%2Dlg%2D4%2C%20%2Ecol%2Dxs%2D5%2C%20%2Ecol%2Dsm%2D5%2C%20%2Ecol%2Dmd%2D5%2C%20%2Ecol%2Dlg%2D5%2C%20%2Ecol%2Dxs%2D6%2C%20%2Ecol%2Dsm%2D6%2C%20%2Ecol%2Dmd%2D6%2C%20%2Ecol%2Dlg%2D6%2C%20%2Ecol%2Dxs%2D7%2C%20%2Ecol%2Dsm%2D7%2C%20%2Ecol%2Dmd%2D7%2C%20%2Ecol%2Dlg%2D7%2C%20%2Ecol%2Dxs%2D8%2C%20%2Ecol%2Dsm%2D8%2C%20%2Ecol%2Dmd%2D8%2C%20%2Ecol%2Dlg%2D8%2C%20%2Ecol%2Dxs%2D9%2C%20%2Ecol%2Dsm%2D9%2C%20%2Ecol%2Dmd%2D9%2C%20%2Ecol%2Dlg%2D9%2C%20%2Ecol%2Dxs%2D10%2C%20%2Ecol%2Dsm%2D10%2C%20%2Ecol%2Dmd%2D10%2C%20%2Ecol%2Dlg%2D10%2C%20%2Ecol%2Dxs%2D11%2C%20%2Ecol%2Dsm%2D11%2C%20%2Ecol%2Dmd%2D11%2C%20%2Ecol%2Dlg%2D11%2C%20%2Ecol%2Dxs%2D12%2C%20%2Ecol%2Dsm%2D12%2C%20%2Ecol%2Dmd%2D12%2C%20%2Ecol%2Dlg%2D12%20%7B%0Aposition%3A%20relative%3B%0Amin%2Dheight%3A%201px%3B%0Apadding%2Dleft%3A%2015px%3B%0Apadding%2Dright%3A%2015px%3B%0A%7D%0A%2Ecol%2Dxs%2D1%2C%20%2Ecol%2Dxs%2D2%2C%20%2Ecol%2Dxs%2D3%2C%20%2Ecol%2Dxs%2D4%2C%20%2Ecol%2Dxs%2D5%2C%20%2Ecol%2Dxs%2D6%2C%20%2Ecol%2Dxs%2D7%2C%20%2Ecol%2Dxs%2D8%2C%20%2Ecol%2Dxs%2D9%2C%20%2Ecol%2Dxs%2D10%2C%20%2Ecol%2Dxs%2D11%2C%20%2Ecol%2Dxs%2D12%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%2Ecol%2Dxs%2D12%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dxs%2D11%20%7B%0Awidth%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2D10%20%7B%0Awidth%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2D9%20%7B%0Awidth%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dxs%2D8%20%7B%0Awidth%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2D7%20%7B%0Awidth%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2D6%20%7B%0Awidth%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dxs%2D5%20%7B%0Awidth%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2D4%20%7B%0Awidth%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2D3%20%7B%0Awidth%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dxs%2D2%20%7B%0Awidth%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2D1%20%7B%0Awidth%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D12%20%7B%0Aright%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D11%20%7B%0Aright%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D10%20%7B%0Aright%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D9%20%7B%0Aright%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D8%20%7B%0Aright%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D7%20%7B%0Aright%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D6%20%7B%0Aright%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D5%20%7B%0Aright%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D4%20%7B%0Aright%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D3%20%7B%0Aright%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D2%20%7B%0Aright%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D1%20%7B%0Aright%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpull%2D0%20%7B%0Aright%3A%20auto%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D12%20%7B%0Aleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D11%20%7B%0Aleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D10%20%7B%0Aleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D9%20%7B%0Aleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D8%20%7B%0Aleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D7%20%7B%0Aleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D6%20%7B%0Aleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D5%20%7B%0Aleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D4%20%7B%0Aleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D3%20%7B%0Aleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D2%20%7B%0Aleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D1%20%7B%0Aleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Dpush%2D0%20%7B%0Aleft%3A%20auto%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D12%20%7B%0Amargin%2Dleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D11%20%7B%0Amargin%2Dleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D10%20%7B%0Amargin%2Dleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D9%20%7B%0Amargin%2Dleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D8%20%7B%0Amargin%2Dleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D7%20%7B%0Amargin%2Dleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D6%20%7B%0Amargin%2Dleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D5%20%7B%0Amargin%2Dleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D4%20%7B%0Amargin%2Dleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D3%20%7B%0Amargin%2Dleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D2%20%7B%0Amargin%2Dleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D1%20%7B%0Amargin%2Dleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dxs%2Doffset%2D0%20%7B%0Amargin%2Dleft%3A%200%25%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Ecol%2Dsm%2D1%2C%20%2Ecol%2Dsm%2D2%2C%20%2Ecol%2Dsm%2D3%2C%20%2Ecol%2Dsm%2D4%2C%20%2Ecol%2Dsm%2D5%2C%20%2Ecol%2Dsm%2D6%2C%20%2Ecol%2Dsm%2D7%2C%20%2Ecol%2Dsm%2D8%2C%20%2Ecol%2Dsm%2D9%2C%20%2Ecol%2Dsm%2D10%2C%20%2Ecol%2Dsm%2D11%2C%20%2Ecol%2Dsm%2D12%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%2Ecol%2Dsm%2D12%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dsm%2D11%20%7B%0Awidth%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2D10%20%7B%0Awidth%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2D9%20%7B%0Awidth%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dsm%2D8%20%7B%0Awidth%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2D7%20%7B%0Awidth%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2D6%20%7B%0Awidth%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dsm%2D5%20%7B%0Awidth%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2D4%20%7B%0Awidth%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2D3%20%7B%0Awidth%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dsm%2D2%20%7B%0Awidth%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2D1%20%7B%0Awidth%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D12%20%7B%0Aright%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D11%20%7B%0Aright%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D10%20%7B%0Aright%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D9%20%7B%0Aright%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D8%20%7B%0Aright%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D7%20%7B%0Aright%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D6%20%7B%0Aright%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D5%20%7B%0Aright%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D4%20%7B%0Aright%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D3%20%7B%0Aright%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D2%20%7B%0Aright%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D1%20%7B%0Aright%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpull%2D0%20%7B%0Aright%3A%20auto%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D12%20%7B%0Aleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D11%20%7B%0Aleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D10%20%7B%0Aleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D9%20%7B%0Aleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D8%20%7B%0Aleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D7%20%7B%0Aleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D6%20%7B%0Aleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D5%20%7B%0Aleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D4%20%7B%0Aleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D3%20%7B%0Aleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D2%20%7B%0Aleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D1%20%7B%0Aleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Dpush%2D0%20%7B%0Aleft%3A%20auto%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D12%20%7B%0Amargin%2Dleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D11%20%7B%0Amargin%2Dleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D10%20%7B%0Amargin%2Dleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D9%20%7B%0Amargin%2Dleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D8%20%7B%0Amargin%2Dleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D7%20%7B%0Amargin%2Dleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D6%20%7B%0Amargin%2Dleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D5%20%7B%0Amargin%2Dleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D4%20%7B%0Amargin%2Dleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D3%20%7B%0Amargin%2Dleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D2%20%7B%0Amargin%2Dleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D1%20%7B%0Amargin%2Dleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dsm%2Doffset%2D0%20%7B%0Amargin%2Dleft%3A%200%25%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20%7B%0A%2Ecol%2Dmd%2D1%2C%20%2Ecol%2Dmd%2D2%2C%20%2Ecol%2Dmd%2D3%2C%20%2Ecol%2Dmd%2D4%2C%20%2Ecol%2Dmd%2D5%2C%20%2Ecol%2Dmd%2D6%2C%20%2Ecol%2Dmd%2D7%2C%20%2Ecol%2Dmd%2D8%2C%20%2Ecol%2Dmd%2D9%2C%20%2Ecol%2Dmd%2D10%2C%20%2Ecol%2Dmd%2D11%2C%20%2Ecol%2Dmd%2D12%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%2Ecol%2Dmd%2D12%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dmd%2D11%20%7B%0Awidth%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2D10%20%7B%0Awidth%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2D9%20%7B%0Awidth%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dmd%2D8%20%7B%0Awidth%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2D7%20%7B%0Awidth%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2D6%20%7B%0Awidth%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dmd%2D5%20%7B%0Awidth%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2D4%20%7B%0Awidth%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2D3%20%7B%0Awidth%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dmd%2D2%20%7B%0Awidth%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2D1%20%7B%0Awidth%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D12%20%7B%0Aright%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D11%20%7B%0Aright%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D10%20%7B%0Aright%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D9%20%7B%0Aright%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D8%20%7B%0Aright%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D7%20%7B%0Aright%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D6%20%7B%0Aright%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D5%20%7B%0Aright%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D4%20%7B%0Aright%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D3%20%7B%0Aright%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D2%20%7B%0Aright%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D1%20%7B%0Aright%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpull%2D0%20%7B%0Aright%3A%20auto%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D12%20%7B%0Aleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D11%20%7B%0Aleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D10%20%7B%0Aleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D9%20%7B%0Aleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D8%20%7B%0Aleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D7%20%7B%0Aleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D6%20%7B%0Aleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D5%20%7B%0Aleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D4%20%7B%0Aleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D3%20%7B%0Aleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D2%20%7B%0Aleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D1%20%7B%0Aleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Dpush%2D0%20%7B%0Aleft%3A%20auto%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D12%20%7B%0Amargin%2Dleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D11%20%7B%0Amargin%2Dleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D10%20%7B%0Amargin%2Dleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D9%20%7B%0Amargin%2Dleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D8%20%7B%0Amargin%2Dleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D7%20%7B%0Amargin%2Dleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D6%20%7B%0Amargin%2Dleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D5%20%7B%0Amargin%2Dleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D4%20%7B%0Amargin%2Dleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D3%20%7B%0Amargin%2Dleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D2%20%7B%0Amargin%2Dleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D1%20%7B%0Amargin%2Dleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dmd%2Doffset%2D0%20%7B%0Amargin%2Dleft%3A%200%25%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Ecol%2Dlg%2D1%2C%20%2Ecol%2Dlg%2D2%2C%20%2Ecol%2Dlg%2D3%2C%20%2Ecol%2Dlg%2D4%2C%20%2Ecol%2Dlg%2D5%2C%20%2Ecol%2Dlg%2D6%2C%20%2Ecol%2Dlg%2D7%2C%20%2Ecol%2Dlg%2D8%2C%20%2Ecol%2Dlg%2D9%2C%20%2Ecol%2Dlg%2D10%2C%20%2Ecol%2Dlg%2D11%2C%20%2Ecol%2Dlg%2D12%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%2Ecol%2Dlg%2D12%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dlg%2D11%20%7B%0Awidth%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2D10%20%7B%0Awidth%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2D9%20%7B%0Awidth%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dlg%2D8%20%7B%0Awidth%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2D7%20%7B%0Awidth%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2D6%20%7B%0Awidth%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dlg%2D5%20%7B%0Awidth%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2D4%20%7B%0Awidth%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2D3%20%7B%0Awidth%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dlg%2D2%20%7B%0Awidth%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2D1%20%7B%0Awidth%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D12%20%7B%0Aright%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D11%20%7B%0Aright%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D10%20%7B%0Aright%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D9%20%7B%0Aright%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D8%20%7B%0Aright%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D7%20%7B%0Aright%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D6%20%7B%0Aright%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D5%20%7B%0Aright%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D4%20%7B%0Aright%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D3%20%7B%0Aright%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D2%20%7B%0Aright%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D1%20%7B%0Aright%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpull%2D0%20%7B%0Aright%3A%20auto%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D12%20%7B%0Aleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D11%20%7B%0Aleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D10%20%7B%0Aleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D9%20%7B%0Aleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D8%20%7B%0Aleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D7%20%7B%0Aleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D6%20%7B%0Aleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D5%20%7B%0Aleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D4%20%7B%0Aleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D3%20%7B%0Aleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D2%20%7B%0Aleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D1%20%7B%0Aleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Dpush%2D0%20%7B%0Aleft%3A%20auto%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D12%20%7B%0Amargin%2Dleft%3A%20100%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D11%20%7B%0Amargin%2Dleft%3A%2091%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D10%20%7B%0Amargin%2Dleft%3A%2083%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D9%20%7B%0Amargin%2Dleft%3A%2075%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D8%20%7B%0Amargin%2Dleft%3A%2066%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D7%20%7B%0Amargin%2Dleft%3A%2058%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D6%20%7B%0Amargin%2Dleft%3A%2050%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D5%20%7B%0Amargin%2Dleft%3A%2041%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D4%20%7B%0Amargin%2Dleft%3A%2033%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D3%20%7B%0Amargin%2Dleft%3A%2025%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D2%20%7B%0Amargin%2Dleft%3A%2016%2E66666667%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D1%20%7B%0Amargin%2Dleft%3A%208%2E33333333%25%3B%0A%7D%0A%2Ecol%2Dlg%2Doffset%2D0%20%7B%0Amargin%2Dleft%3A%200%25%3B%0A%7D%0A%7D%0Atable%20%7B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0Acaption%20%7B%0Apadding%2Dtop%3A%208px%3B%0Apadding%2Dbottom%3A%208px%3B%0Acolor%3A%20%23777777%3B%0Atext%2Dalign%3A%20left%3B%0A%7D%0Ath%20%7B%0Atext%2Dalign%3A%20left%3B%0A%7D%0A%2Etable%20%7B%0Awidth%3A%20100%25%3B%0Amax%2Dwidth%3A%20100%25%3B%0Amargin%2Dbottom%3A%2035px%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Apadding%3A%208px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Avertical%2Dalign%3A%20top%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%20%7B%0Avertical%2Dalign%3A%20bottom%3B%0Aborder%2Dbottom%3A%202px%20solid%20%23ddd%3B%0A%7D%0A%2Etable%20%3E%20caption%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0A%2Etable%20%3E%20colgroup%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0A%2Etable%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0A%2Etable%20%3E%20caption%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0A%2Etable%20%3E%20colgroup%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0A%2Etable%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%20%7B%0Aborder%2Dtop%3A%200%3B%0A%7D%0A%2Etable%20%3E%20tbody%20%2B%20tbody%20%7B%0Aborder%2Dtop%3A%202px%20solid%20%23ddd%3B%0A%7D%0A%2Etable%20%2Etable%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Etable%2Dcondensed%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dcondensed%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dcondensed%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dcondensed%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0A%2Etable%2Dcondensed%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0A%2Etable%2Dcondensed%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Apadding%3A%205px%3B%0A%7D%0A%2Etable%2Dbordered%20%7B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0A%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0A%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%20%7B%0Aborder%2Dbottom%2Dwidth%3A%202px%3B%0A%7D%0A%2Etable%2Dstriped%20%3E%20tbody%20%3E%20tr%3Anth%2Dof%2Dtype%28odd%29%20%7B%0Abackground%2Dcolor%3A%20%23f9f9f9%3B%0A%7D%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%3Ahover%20%7B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0A%7D%0Atable%20col%5Bclass%2A%3D%22col%2D%22%5D%20%7B%0Aposition%3A%20static%3B%0Afloat%3A%20none%3B%0Adisplay%3A%20table%2Dcolumn%3B%0A%7D%0Atable%20td%5Bclass%2A%3D%22col%2D%22%5D%2C%0Atable%20th%5Bclass%2A%3D%22col%2D%22%5D%20%7B%0Aposition%3A%20static%3B%0Afloat%3A%20none%3B%0Adisplay%3A%20table%2Dcell%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2Eactive%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Eactive%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%2Eactive%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2Eactive%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Eactive%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2Eactive%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Eactive%20%3E%20td%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Eactive%20%3E%20td%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Eactive%20%3E%20td%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Eactive%20%3E%20th%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Eactive%20%3E%20th%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Eactive%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0A%7D%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Eactive%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Eactive%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Eactive%3Ahover%20%3E%20td%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%3Ahover%20%3E%20%2Eactive%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Eactive%3Ahover%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23e8e8e8%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2Esuccess%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Esuccess%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%2Esuccess%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2Esuccess%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Esuccess%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2Esuccess%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Esuccess%20%3E%20td%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Esuccess%20%3E%20td%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Esuccess%20%3E%20td%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Esuccess%20%3E%20th%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Esuccess%20%3E%20th%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Esuccess%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23dff0d8%3B%0A%7D%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Esuccess%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Esuccess%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Esuccess%3Ahover%20%3E%20td%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%3Ahover%20%3E%20%2Esuccess%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Esuccess%3Ahover%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23d0e9c6%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2Einfo%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Einfo%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%2Einfo%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2Einfo%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Einfo%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2Einfo%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Einfo%20%3E%20td%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Einfo%20%3E%20td%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Einfo%20%3E%20td%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Einfo%20%3E%20th%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Einfo%20%3E%20th%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Einfo%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23d9edf7%3B%0A%7D%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Einfo%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Einfo%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Einfo%3Ahover%20%3E%20td%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%3Ahover%20%3E%20%2Einfo%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Einfo%3Ahover%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23c4e3f3%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2Ewarning%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Ewarning%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%2Ewarning%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2Ewarning%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Ewarning%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2Ewarning%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Ewarning%20%3E%20td%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Ewarning%20%3E%20td%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Ewarning%20%3E%20td%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Ewarning%20%3E%20th%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Ewarning%20%3E%20th%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Ewarning%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0A%7D%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Ewarning%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Ewarning%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Ewarning%3Ahover%20%3E%20td%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%3Ahover%20%3E%20%2Ewarning%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Ewarning%3Ahover%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23faf2cc%3B%0A%7D%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2Edanger%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Edanger%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%2Edanger%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2Edanger%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Edanger%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2Edanger%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Edanger%20%3E%20td%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Edanger%20%3E%20td%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Edanger%20%3E%20td%2C%0A%2Etable%20%3E%20thead%20%3E%20tr%2Edanger%20%3E%20th%2C%0A%2Etable%20%3E%20tbody%20%3E%20tr%2Edanger%20%3E%20th%2C%0A%2Etable%20%3E%20tfoot%20%3E%20tr%2Edanger%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0A%7D%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20td%2Edanger%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%20%3E%20th%2Edanger%3Ahover%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Edanger%3Ahover%20%3E%20td%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%3Ahover%20%3E%20%2Edanger%2C%0A%2Etable%2Dhover%20%3E%20tbody%20%3E%20tr%2Edanger%3Ahover%20%3E%20th%20%7B%0Abackground%2Dcolor%3A%20%23ebcccc%3B%0A%7D%0A%2Etable%2Dresponsive%20%7B%0Aoverflow%2Dx%3A%20auto%3B%0Amin%2Dheight%3A%200%2E01%25%3B%0A%7D%0A%40media%20screen%20and%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Etable%2Dresponsive%20%7B%0Awidth%3A%20100%25%3B%0Amargin%2Dbottom%3A%2026%2E25px%3B%0Aoverflow%2Dy%3A%20hidden%3B%0A%2Dms%2Doverflow%2Dstyle%3A%20%2Dms%2Dautohiding%2Dscrollbar%3B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Awhite%2Dspace%3A%20nowrap%3B%0A%7D%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%7B%0Aborder%3A%200%3B%0A%7D%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%20%7B%0Aborder%2Dleft%3A%200%3B%0A%7D%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Alast%2Dchild%20%7B%0Aborder%2Dright%3A%200%3B%0A%7D%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20td%2C%0A%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20td%20%7B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%7D%0Afieldset%20%7B%0Apadding%3A%200%3B%0Amargin%3A%200%3B%0Aborder%3A%200%3B%0Amin%2Dwidth%3A%200%3B%0A%7D%0Alegend%20%7B%0Adisplay%3A%20block%3B%0Awidth%3A%20100%25%3B%0Apadding%3A%200%3B%0Amargin%2Dbottom%3A%2035px%3B%0Afont%2Dsize%3A%2030px%3B%0Aline%2Dheight%3A%20inherit%3B%0Acolor%3A%20%23333333%3B%0Aborder%3A%200%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23e5e5e5%3B%0A%7D%0Alabel%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amax%2Dwidth%3A%20100%25%3B%0Amargin%2Dbottom%3A%205px%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Ainput%5Btype%3D%22search%22%5D%20%7B%0A%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0Abox%2Dsizing%3A%20border%2Dbox%3B%0A%7D%0Ainput%5Btype%3D%22radio%22%5D%2C%0Ainput%5Btype%3D%22checkbox%22%5D%20%7B%0Amargin%3A%204px%200%200%3B%0Amargin%2Dtop%3A%201px%20%5C9%3B%0Aline%2Dheight%3A%20normal%3B%0A%7D%0Ainput%5Btype%3D%22file%22%5D%20%7B%0Adisplay%3A%20block%3B%0A%7D%0Ainput%5Btype%3D%22range%22%5D%20%7B%0Adisplay%3A%20block%3B%0Awidth%3A%20100%25%3B%0A%7D%0Aselect%5Bmultiple%5D%2C%0Aselect%5Bsize%5D%20%7B%0Aheight%3A%20auto%3B%0A%7D%0Ainput%5Btype%3D%22file%22%5D%3Afocus%2C%0Ainput%5Btype%3D%22radio%22%5D%3Afocus%2C%0Ainput%5Btype%3D%22checkbox%22%5D%3Afocus%20%7B%0Aoutline%3A%205px%20auto%20%2Dwebkit%2Dfocus%2Dring%2Dcolor%3B%0Aoutline%2Doffset%3A%20%2D2px%3B%0A%7D%0Aoutput%20%7B%0Adisplay%3A%20block%3B%0Apadding%2Dtop%3A%207px%3B%0Afont%2Dsize%3A%2020px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20%23555555%3B%0A%7D%0A%2Eform%2Dcontrol%20%7B%0Adisplay%3A%20block%3B%0Awidth%3A%20100%25%3B%0Aheight%3A%2049px%3B%0Apadding%3A%206px%2012px%3B%0Afont%2Dsize%3A%2020px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20%23555555%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Abackground%2Dimage%3A%20none%3B%0Aborder%3A%201px%20solid%20%23ccc%3B%0Aborder%2Dradius%3A%200px%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0A%2Dwebkit%2Dtransition%3A%20border%2Dcolor%20ease%2Din%2Dout%20%2E15s%2C%20box%2Dshadow%20ease%2Din%2Dout%20%2E15s%3B%0A%2Do%2Dtransition%3A%20border%2Dcolor%20ease%2Din%2Dout%20%2E15s%2C%20box%2Dshadow%20ease%2Din%2Dout%20%2E15s%3B%0Atransition%3A%20border%2Dcolor%20ease%2Din%2Dout%20%2E15s%2C%20box%2Dshadow%20ease%2Din%2Dout%20%2E15s%3B%0A%7D%0A%2Eform%2Dcontrol%3Afocus%20%7B%0Aborder%2Dcolor%3A%20%2366afe9%3B%0Aoutline%3A%200%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C0%2C0%2C%2E075%29%2C%200%200%208px%20rgba%28102%2C%20175%2C%20233%2C%200%2E6%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C0%2C0%2C%2E075%29%2C%200%200%208px%20rgba%28102%2C%20175%2C%20233%2C%200%2E6%29%3B%0A%7D%0A%2Eform%2Dcontrol%3A%3A%2Dmoz%2Dplaceholder%20%7B%0Acolor%3A%20%23999%3B%0Aopacity%3A%201%3B%0A%7D%0A%2Eform%2Dcontrol%3A%2Dms%2Dinput%2Dplaceholder%20%7B%0Acolor%3A%20%23999%3B%0A%7D%0A%2Eform%2Dcontrol%3A%3A%2Dwebkit%2Dinput%2Dplaceholder%20%7B%0Acolor%3A%20%23999%3B%0A%7D%0A%2Eform%2Dcontrol%3A%3A%2Dms%2Dexpand%20%7B%0Aborder%3A%200%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Eform%2Dcontrol%5Bdisabled%5D%2C%0A%2Eform%2Dcontrol%5Breadonly%5D%2C%0Afieldset%5Bdisabled%5D%20%2Eform%2Dcontrol%20%7B%0Abackground%2Dcolor%3A%20%23eeeeee%3B%0Aopacity%3A%201%3B%0A%7D%0A%2Eform%2Dcontrol%5Bdisabled%5D%2C%0Afieldset%5Bdisabled%5D%20%2Eform%2Dcontrol%20%7B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0Atextarea%2Eform%2Dcontrol%20%7B%0Aheight%3A%20auto%3B%0A%7D%0Ainput%5Btype%3D%22search%22%5D%20%7B%0A%2Dwebkit%2Dappearance%3A%20none%3B%0A%7D%0A%40media%20screen%20and%20%28%2Dwebkit%2Dmin%2Ddevice%2Dpixel%2Dratio%3A%200%29%20%7B%0Ainput%5Btype%3D%22date%22%5D%2Eform%2Dcontrol%2C%0Ainput%5Btype%3D%22time%22%5D%2Eform%2Dcontrol%2C%0Ainput%5Btype%3D%22datetime%2Dlocal%22%5D%2Eform%2Dcontrol%2C%0Ainput%5Btype%3D%22month%22%5D%2Eform%2Dcontrol%20%7B%0Aline%2Dheight%3A%2049px%3B%0A%7D%0Ainput%5Btype%3D%22date%22%5D%2Einput%2Dsm%2C%0Ainput%5Btype%3D%22time%22%5D%2Einput%2Dsm%2C%0Ainput%5Btype%3D%22datetime%2Dlocal%22%5D%2Einput%2Dsm%2C%0Ainput%5Btype%3D%22month%22%5D%2Einput%2Dsm%2C%0A%2Einput%2Dgroup%2Dsm%20input%5Btype%3D%22date%22%5D%2C%0A%2Einput%2Dgroup%2Dsm%20input%5Btype%3D%22time%22%5D%2C%0A%2Einput%2Dgroup%2Dsm%20input%5Btype%3D%22datetime%2Dlocal%22%5D%2C%0A%2Einput%2Dgroup%2Dsm%20input%5Btype%3D%22month%22%5D%20%7B%0Aline%2Dheight%3A%2037px%3B%0A%7D%0Ainput%5Btype%3D%22date%22%5D%2Einput%2Dlg%2C%0Ainput%5Btype%3D%22time%22%5D%2Einput%2Dlg%2C%0Ainput%5Btype%3D%22datetime%2Dlocal%22%5D%2Einput%2Dlg%2C%0Ainput%5Btype%3D%22month%22%5D%2Einput%2Dlg%2C%0A%2Einput%2Dgroup%2Dlg%20input%5Btype%3D%22date%22%5D%2C%0A%2Einput%2Dgroup%2Dlg%20input%5Btype%3D%22time%22%5D%2C%0A%2Einput%2Dgroup%2Dlg%20input%5Btype%3D%22datetime%2Dlocal%22%5D%2C%0A%2Einput%2Dgroup%2Dlg%20input%5Btype%3D%22month%22%5D%20%7B%0Aline%2Dheight%3A%2056px%3B%0A%7D%0A%7D%0A%2Eform%2Dgroup%20%7B%0Amargin%2Dbottom%3A%2015px%3B%0A%7D%0A%2Eradio%2C%0A%2Echeckbox%20%7B%0Aposition%3A%20relative%3B%0Adisplay%3A%20block%3B%0Amargin%2Dtop%3A%2010px%3B%0Amargin%2Dbottom%3A%2010px%3B%0A%7D%0A%2Eradio%20label%2C%0A%2Echeckbox%20label%20%7B%0Amin%2Dheight%3A%2035px%3B%0Apadding%2Dleft%3A%2020px%3B%0Amargin%2Dbottom%3A%200%3B%0Afont%2Dweight%3A%20normal%3B%0Acursor%3A%20pointer%3B%0A%7D%0A%2Eradio%20input%5Btype%3D%22radio%22%5D%2C%0A%2Eradio%2Dinline%20input%5Btype%3D%22radio%22%5D%2C%0A%2Echeckbox%20input%5Btype%3D%22checkbox%22%5D%2C%0A%2Echeckbox%2Dinline%20input%5Btype%3D%22checkbox%22%5D%20%7B%0Aposition%3A%20absolute%3B%0Amargin%2Dleft%3A%20%2D20px%3B%0Amargin%2Dtop%3A%204px%20%5C9%3B%0A%7D%0A%2Eradio%20%2B%20%2Eradio%2C%0A%2Echeckbox%20%2B%20%2Echeckbox%20%7B%0Amargin%2Dtop%3A%20%2D5px%3B%0A%7D%0A%2Eradio%2Dinline%2C%0A%2Echeckbox%2Dinline%20%7B%0Aposition%3A%20relative%3B%0Adisplay%3A%20inline%2Dblock%3B%0Apadding%2Dleft%3A%2020px%3B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0Afont%2Dweight%3A%20normal%3B%0Acursor%3A%20pointer%3B%0A%7D%0A%2Eradio%2Dinline%20%2B%20%2Eradio%2Dinline%2C%0A%2Echeckbox%2Dinline%20%2B%20%2Echeckbox%2Dinline%20%7B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dleft%3A%2010px%3B%0A%7D%0Ainput%5Btype%3D%22radio%22%5D%5Bdisabled%5D%2C%0Ainput%5Btype%3D%22checkbox%22%5D%5Bdisabled%5D%2C%0Ainput%5Btype%3D%22radio%22%5D%2Edisabled%2C%0Ainput%5Btype%3D%22checkbox%22%5D%2Edisabled%2C%0Afieldset%5Bdisabled%5D%20input%5Btype%3D%22radio%22%5D%2C%0Afieldset%5Bdisabled%5D%20input%5Btype%3D%22checkbox%22%5D%20%7B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%2Eradio%2Dinline%2Edisabled%2C%0A%2Echeckbox%2Dinline%2Edisabled%2C%0Afieldset%5Bdisabled%5D%20%2Eradio%2Dinline%2C%0Afieldset%5Bdisabled%5D%20%2Echeckbox%2Dinline%20%7B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%2Eradio%2Edisabled%20label%2C%0A%2Echeckbox%2Edisabled%20label%2C%0Afieldset%5Bdisabled%5D%20%2Eradio%20label%2C%0Afieldset%5Bdisabled%5D%20%2Echeckbox%20label%20%7B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%2Eform%2Dcontrol%2Dstatic%20%7B%0Apadding%2Dtop%3A%207px%3B%0Apadding%2Dbottom%3A%207px%3B%0Amargin%2Dbottom%3A%200%3B%0Amin%2Dheight%3A%2055px%3B%0A%7D%0A%2Eform%2Dcontrol%2Dstatic%2Einput%2Dlg%2C%0A%2Eform%2Dcontrol%2Dstatic%2Einput%2Dsm%20%7B%0Apadding%2Dleft%3A%200%3B%0Apadding%2Dright%3A%200%3B%0A%7D%0A%2Einput%2Dsm%20%7B%0Aheight%3A%2037px%3B%0Apadding%3A%205px%2010px%3B%0Afont%2Dsize%3A%2017px%3B%0Aline%2Dheight%3A%201%2E5%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0Aselect%2Einput%2Dsm%20%7B%0Aheight%3A%2037px%3B%0Aline%2Dheight%3A%2037px%3B%0A%7D%0Atextarea%2Einput%2Dsm%2C%0Aselect%5Bmultiple%5D%2Einput%2Dsm%20%7B%0Aheight%3A%20auto%3B%0A%7D%0A%2Eform%2Dgroup%2Dsm%20%2Eform%2Dcontrol%20%7B%0Aheight%3A%2037px%3B%0Apadding%3A%205px%2010px%3B%0Afont%2Dsize%3A%2017px%3B%0Aline%2Dheight%3A%201%2E5%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Eform%2Dgroup%2Dsm%20select%2Eform%2Dcontrol%20%7B%0Aheight%3A%2037px%3B%0Aline%2Dheight%3A%2037px%3B%0A%7D%0A%2Eform%2Dgroup%2Dsm%20textarea%2Eform%2Dcontrol%2C%0A%2Eform%2Dgroup%2Dsm%20select%5Bmultiple%5D%2Eform%2Dcontrol%20%7B%0Aheight%3A%20auto%3B%0A%7D%0A%2Eform%2Dgroup%2Dsm%20%2Eform%2Dcontrol%2Dstatic%20%7B%0Aheight%3A%2037px%3B%0Amin%2Dheight%3A%2052px%3B%0Apadding%3A%206px%2010px%3B%0Afont%2Dsize%3A%2017px%3B%0Aline%2Dheight%3A%201%2E5%3B%0A%7D%0A%2Einput%2Dlg%20%7B%0Aheight%3A%2056px%3B%0Apadding%3A%2010px%2016px%3B%0Afont%2Dsize%3A%2025px%3B%0Aline%2Dheight%3A%201%2E3333333%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0Aselect%2Einput%2Dlg%20%7B%0Aheight%3A%2056px%3B%0Aline%2Dheight%3A%2056px%3B%0A%7D%0Atextarea%2Einput%2Dlg%2C%0Aselect%5Bmultiple%5D%2Einput%2Dlg%20%7B%0Aheight%3A%20auto%3B%0A%7D%0A%2Eform%2Dgroup%2Dlg%20%2Eform%2Dcontrol%20%7B%0Aheight%3A%2056px%3B%0Apadding%3A%2010px%2016px%3B%0Afont%2Dsize%3A%2025px%3B%0Aline%2Dheight%3A%201%2E3333333%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Eform%2Dgroup%2Dlg%20select%2Eform%2Dcontrol%20%7B%0Aheight%3A%2056px%3B%0Aline%2Dheight%3A%2056px%3B%0A%7D%0A%2Eform%2Dgroup%2Dlg%20textarea%2Eform%2Dcontrol%2C%0A%2Eform%2Dgroup%2Dlg%20select%5Bmultiple%5D%2Eform%2Dcontrol%20%7B%0Aheight%3A%20auto%3B%0A%7D%0A%2Eform%2Dgroup%2Dlg%20%2Eform%2Dcontrol%2Dstatic%20%7B%0Aheight%3A%2056px%3B%0Amin%2Dheight%3A%2060px%3B%0Apadding%3A%2011px%2016px%3B%0Afont%2Dsize%3A%2025px%3B%0Aline%2Dheight%3A%201%2E3333333%3B%0A%7D%0A%2Ehas%2Dfeedback%20%7B%0Aposition%3A%20relative%3B%0A%7D%0A%2Ehas%2Dfeedback%20%2Eform%2Dcontrol%20%7B%0Apadding%2Dright%3A%2061%2E25px%3B%0A%7D%0A%2Eform%2Dcontrol%2Dfeedback%20%7B%0Aposition%3A%20absolute%3B%0Atop%3A%200%3B%0Aright%3A%200%3B%0Az%2Dindex%3A%202%3B%0Adisplay%3A%20block%3B%0Awidth%3A%2049px%3B%0Aheight%3A%2049px%3B%0Aline%2Dheight%3A%2049px%3B%0Atext%2Dalign%3A%20center%3B%0Apointer%2Devents%3A%20none%3B%0A%7D%0A%2Einput%2Dlg%20%2B%20%2Eform%2Dcontrol%2Dfeedback%2C%0A%2Einput%2Dgroup%2Dlg%20%2B%20%2Eform%2Dcontrol%2Dfeedback%2C%0A%2Eform%2Dgroup%2Dlg%20%2Eform%2Dcontrol%20%2B%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Awidth%3A%2056px%3B%0Aheight%3A%2056px%3B%0Aline%2Dheight%3A%2056px%3B%0A%7D%0A%2Einput%2Dsm%20%2B%20%2Eform%2Dcontrol%2Dfeedback%2C%0A%2Einput%2Dgroup%2Dsm%20%2B%20%2Eform%2Dcontrol%2Dfeedback%2C%0A%2Eform%2Dgroup%2Dsm%20%2Eform%2Dcontrol%20%2B%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Awidth%3A%2037px%3B%0Aheight%3A%2037px%3B%0Aline%2Dheight%3A%2037px%3B%0A%7D%0A%2Ehas%2Dsuccess%20%2Ehelp%2Dblock%2C%0A%2Ehas%2Dsuccess%20%2Econtrol%2Dlabel%2C%0A%2Ehas%2Dsuccess%20%2Eradio%2C%0A%2Ehas%2Dsuccess%20%2Echeckbox%2C%0A%2Ehas%2Dsuccess%20%2Eradio%2Dinline%2C%0A%2Ehas%2Dsuccess%20%2Echeckbox%2Dinline%2C%0A%2Ehas%2Dsuccess%2Eradio%20label%2C%0A%2Ehas%2Dsuccess%2Echeckbox%20label%2C%0A%2Ehas%2Dsuccess%2Eradio%2Dinline%20label%2C%0A%2Ehas%2Dsuccess%2Echeckbox%2Dinline%20label%20%7B%0Acolor%3A%20%233c763d%3B%0A%7D%0A%2Ehas%2Dsuccess%20%2Eform%2Dcontrol%20%7B%0Aborder%2Dcolor%3A%20%233c763d%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0A%7D%0A%2Ehas%2Dsuccess%20%2Eform%2Dcontrol%3Afocus%20%7B%0Aborder%2Dcolor%3A%20%232b542c%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%2C%200%200%206px%20%2367b168%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%2C%200%200%206px%20%2367b168%3B%0A%7D%0A%2Ehas%2Dsuccess%20%2Einput%2Dgroup%2Daddon%20%7B%0Acolor%3A%20%233c763d%3B%0Aborder%2Dcolor%3A%20%233c763d%3B%0Abackground%2Dcolor%3A%20%23dff0d8%3B%0A%7D%0A%2Ehas%2Dsuccess%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Acolor%3A%20%233c763d%3B%0A%7D%0A%2Ehas%2Dwarning%20%2Ehelp%2Dblock%2C%0A%2Ehas%2Dwarning%20%2Econtrol%2Dlabel%2C%0A%2Ehas%2Dwarning%20%2Eradio%2C%0A%2Ehas%2Dwarning%20%2Echeckbox%2C%0A%2Ehas%2Dwarning%20%2Eradio%2Dinline%2C%0A%2Ehas%2Dwarning%20%2Echeckbox%2Dinline%2C%0A%2Ehas%2Dwarning%2Eradio%20label%2C%0A%2Ehas%2Dwarning%2Echeckbox%20label%2C%0A%2Ehas%2Dwarning%2Eradio%2Dinline%20label%2C%0A%2Ehas%2Dwarning%2Echeckbox%2Dinline%20label%20%7B%0Acolor%3A%20%238a6d3b%3B%0A%7D%0A%2Ehas%2Dwarning%20%2Eform%2Dcontrol%20%7B%0Aborder%2Dcolor%3A%20%238a6d3b%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0A%7D%0A%2Ehas%2Dwarning%20%2Eform%2Dcontrol%3Afocus%20%7B%0Aborder%2Dcolor%3A%20%2366512c%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%2C%200%200%206px%20%23c0a16b%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%2C%200%200%206px%20%23c0a16b%3B%0A%7D%0A%2Ehas%2Dwarning%20%2Einput%2Dgroup%2Daddon%20%7B%0Acolor%3A%20%238a6d3b%3B%0Aborder%2Dcolor%3A%20%238a6d3b%3B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0A%7D%0A%2Ehas%2Dwarning%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Acolor%3A%20%238a6d3b%3B%0A%7D%0A%2Ehas%2Derror%20%2Ehelp%2Dblock%2C%0A%2Ehas%2Derror%20%2Econtrol%2Dlabel%2C%0A%2Ehas%2Derror%20%2Eradio%2C%0A%2Ehas%2Derror%20%2Echeckbox%2C%0A%2Ehas%2Derror%20%2Eradio%2Dinline%2C%0A%2Ehas%2Derror%20%2Echeckbox%2Dinline%2C%0A%2Ehas%2Derror%2Eradio%20label%2C%0A%2Ehas%2Derror%2Echeckbox%20label%2C%0A%2Ehas%2Derror%2Eradio%2Dinline%20label%2C%0A%2Ehas%2Derror%2Echeckbox%2Dinline%20label%20%7B%0Acolor%3A%20%23a94442%3B%0A%7D%0A%2Ehas%2Derror%20%2Eform%2Dcontrol%20%7B%0Aborder%2Dcolor%3A%20%23a94442%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%3B%0A%7D%0A%2Ehas%2Derror%20%2Eform%2Dcontrol%3Afocus%20%7B%0Aborder%2Dcolor%3A%20%23843534%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%2C%200%200%206px%20%23ce8483%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E075%29%2C%200%200%206px%20%23ce8483%3B%0A%7D%0A%2Ehas%2Derror%20%2Einput%2Dgroup%2Daddon%20%7B%0Acolor%3A%20%23a94442%3B%0Aborder%2Dcolor%3A%20%23a94442%3B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0A%7D%0A%2Ehas%2Derror%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Acolor%3A%20%23a94442%3B%0A%7D%0A%2Ehas%2Dfeedback%20label%20%7E%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Atop%3A%2040px%3B%0A%7D%0A%2Ehas%2Dfeedback%20label%2Esr%2Donly%20%7E%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Atop%3A%200%3B%0A%7D%0A%2Ehelp%2Dblock%20%7B%0Adisplay%3A%20block%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%2010px%3B%0Acolor%3A%20%23737373%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Eform%2Dinline%20%2Eform%2Dgroup%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Eform%2Dinline%20%2Eform%2Dcontrol%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Awidth%3A%20auto%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Eform%2Dinline%20%2Eform%2Dcontrol%2Dstatic%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0A%7D%0A%2Eform%2Dinline%20%2Einput%2Dgroup%20%7B%0Adisplay%3A%20inline%2Dtable%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Eform%2Dinline%20%2Einput%2Dgroup%20%2Einput%2Dgroup%2Daddon%2C%0A%2Eform%2Dinline%20%2Einput%2Dgroup%20%2Einput%2Dgroup%2Dbtn%2C%0A%2Eform%2Dinline%20%2Einput%2Dgroup%20%2Eform%2Dcontrol%20%7B%0Awidth%3A%20auto%3B%0A%7D%0A%2Eform%2Dinline%20%2Einput%2Dgroup%20%3E%20%2Eform%2Dcontrol%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Eform%2Dinline%20%2Econtrol%2Dlabel%20%7B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Eform%2Dinline%20%2Eradio%2C%0A%2Eform%2Dinline%20%2Echeckbox%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Eform%2Dinline%20%2Eradio%20label%2C%0A%2Eform%2Dinline%20%2Echeckbox%20label%20%7B%0Apadding%2Dleft%3A%200%3B%0A%7D%0A%2Eform%2Dinline%20%2Eradio%20input%5Btype%3D%22radio%22%5D%2C%0A%2Eform%2Dinline%20%2Echeckbox%20input%5Btype%3D%22checkbox%22%5D%20%7B%0Aposition%3A%20relative%3B%0Amargin%2Dleft%3A%200%3B%0A%7D%0A%2Eform%2Dinline%20%2Ehas%2Dfeedback%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Atop%3A%200%3B%0A%7D%0A%7D%0A%2Eform%2Dhorizontal%20%2Eradio%2C%0A%2Eform%2Dhorizontal%20%2Echeckbox%2C%0A%2Eform%2Dhorizontal%20%2Eradio%2Dinline%2C%0A%2Eform%2Dhorizontal%20%2Echeckbox%2Dinline%20%7B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%200%3B%0Apadding%2Dtop%3A%207px%3B%0A%7D%0A%2Eform%2Dhorizontal%20%2Eradio%2C%0A%2Eform%2Dhorizontal%20%2Echeckbox%20%7B%0Amin%2Dheight%3A%2042px%3B%0A%7D%0A%2Eform%2Dhorizontal%20%2Eform%2Dgroup%20%7B%0Amargin%2Dleft%3A%20%2D15px%3B%0Amargin%2Dright%3A%20%2D15px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Eform%2Dhorizontal%20%2Econtrol%2Dlabel%20%7B%0Atext%2Dalign%3A%20right%3B%0Amargin%2Dbottom%3A%200%3B%0Apadding%2Dtop%3A%207px%3B%0A%7D%0A%7D%0A%2Eform%2Dhorizontal%20%2Ehas%2Dfeedback%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Aright%3A%2015px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Eform%2Dhorizontal%20%2Eform%2Dgroup%2Dlg%20%2Econtrol%2Dlabel%20%7B%0Apadding%2Dtop%3A%2011px%3B%0Afont%2Dsize%3A%2025px%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Eform%2Dhorizontal%20%2Eform%2Dgroup%2Dsm%20%2Econtrol%2Dlabel%20%7B%0Apadding%2Dtop%3A%206px%3B%0Afont%2Dsize%3A%2017px%3B%0A%7D%0A%7D%0A%2Ebtn%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amargin%2Dbottom%3A%200%3B%0Afont%2Dweight%3A%20normal%3B%0Atext%2Dalign%3A%20center%3B%0Avertical%2Dalign%3A%20middle%3B%0Atouch%2Daction%3A%20manipulation%3B%0Acursor%3A%20pointer%3B%0Abackground%2Dimage%3A%20none%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Awhite%2Dspace%3A%20nowrap%3B%0Apadding%3A%206px%2012px%3B%0Afont%2Dsize%3A%2020px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Aborder%2Dradius%3A%200px%3B%0A%2Dwebkit%2Duser%2Dselect%3A%20none%3B%0A%2Dmoz%2Duser%2Dselect%3A%20none%3B%0A%2Dms%2Duser%2Dselect%3A%20none%3B%0Auser%2Dselect%3A%20none%3B%0A%7D%0A%2Ebtn%3Afocus%2C%0A%2Ebtn%3Aactive%3Afocus%2C%0A%2Ebtn%2Eactive%3Afocus%2C%0A%2Ebtn%2Efocus%2C%0A%2Ebtn%3Aactive%2Efocus%2C%0A%2Ebtn%2Eactive%2Efocus%20%7B%0Aoutline%3A%205px%20auto%20%2Dwebkit%2Dfocus%2Dring%2Dcolor%3B%0Aoutline%2Doffset%3A%20%2D2px%3B%0A%7D%0A%2Ebtn%3Ahover%2C%0A%2Ebtn%3Afocus%2C%0A%2Ebtn%2Efocus%20%7B%0Acolor%3A%20%23333%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0A%2Ebtn%3Aactive%2C%0A%2Ebtn%2Eactive%20%7B%0Aoutline%3A%200%3B%0Abackground%2Dimage%3A%20none%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%203px%205px%20rgba%280%2C%200%2C%200%2C%200%2E125%29%3B%0Abox%2Dshadow%3A%20inset%200%203px%205px%20rgba%280%2C%200%2C%200%2C%200%2E125%29%3B%0A%7D%0A%2Ebtn%2Edisabled%2C%0A%2Ebtn%5Bdisabled%5D%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%20%7B%0Acursor%3A%20not%2Dallowed%3B%0Aopacity%3A%200%2E65%3B%0Afilter%3A%20alpha%28opacity%3D65%29%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20none%3B%0Abox%2Dshadow%3A%20none%3B%0A%7D%0Aa%2Ebtn%2Edisabled%2C%0Afieldset%5Bdisabled%5D%20a%2Ebtn%20%7B%0Apointer%2Devents%3A%20none%3B%0A%7D%0A%2Ebtn%2Ddefault%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%2Ebtn%2Ddefault%3Afocus%2C%0A%2Ebtn%2Ddefault%2Efocus%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20%23dedede%3B%0Aborder%2Dcolor%3A%20%23b7b7b7%3B%0A%7D%0A%2Ebtn%2Ddefault%3Ahover%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20%23dedede%3B%0Aborder%2Dcolor%3A%20%23d8d8d8%3B%0A%7D%0A%2Ebtn%2Ddefault%3Aactive%2C%0A%2Ebtn%2Ddefault%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddefault%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20%23dedede%3B%0Aborder%2Dcolor%3A%20%23d8d8d8%3B%0A%7D%0A%2Ebtn%2Ddefault%3Aactive%3Ahover%2C%0A%2Ebtn%2Ddefault%2Eactive%3Ahover%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddefault%3Ahover%2C%0A%2Ebtn%2Ddefault%3Aactive%3Afocus%2C%0A%2Ebtn%2Ddefault%2Eactive%3Afocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddefault%3Afocus%2C%0A%2Ebtn%2Ddefault%3Aactive%2Efocus%2C%0A%2Ebtn%2Ddefault%2Eactive%2Efocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddefault%2Efocus%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20%23cccccc%3B%0Aborder%2Dcolor%3A%20%23b7b7b7%3B%0A%7D%0A%2Ebtn%2Ddefault%3Aactive%2C%0A%2Ebtn%2Ddefault%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddefault%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%2Ebtn%2Ddefault%2Edisabled%3Ahover%2C%0A%2Ebtn%2Ddefault%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Ddefault%3Ahover%2C%0A%2Ebtn%2Ddefault%2Edisabled%3Afocus%2C%0A%2Ebtn%2Ddefault%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Ddefault%3Afocus%2C%0A%2Ebtn%2Ddefault%2Edisabled%2Efocus%2C%0A%2Ebtn%2Ddefault%5Bdisabled%5D%2Efocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Ddefault%2Efocus%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%2Ebtn%2Ddefault%20%2Ebadge%20%7B%0Acolor%3A%20%23f7f7f7%3B%0Abackground%2Dcolor%3A%20%23333%3B%0A%7D%0A%2Ebtn%2Dprimary%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0Aborder%2Dcolor%3A%20%232e6da4%3B%0A%7D%0A%2Ebtn%2Dprimary%3Afocus%2C%0A%2Ebtn%2Dprimary%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23286090%3B%0Aborder%2Dcolor%3A%20%23122b40%3B%0A%7D%0A%2Ebtn%2Dprimary%3Ahover%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23286090%3B%0Aborder%2Dcolor%3A%20%23204d74%3B%0A%7D%0A%2Ebtn%2Dprimary%3Aactive%2C%0A%2Ebtn%2Dprimary%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dprimary%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23286090%3B%0Aborder%2Dcolor%3A%20%23204d74%3B%0A%7D%0A%2Ebtn%2Dprimary%3Aactive%3Ahover%2C%0A%2Ebtn%2Dprimary%2Eactive%3Ahover%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dprimary%3Ahover%2C%0A%2Ebtn%2Dprimary%3Aactive%3Afocus%2C%0A%2Ebtn%2Dprimary%2Eactive%3Afocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dprimary%3Afocus%2C%0A%2Ebtn%2Dprimary%3Aactive%2Efocus%2C%0A%2Ebtn%2Dprimary%2Eactive%2Efocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dprimary%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23204d74%3B%0Aborder%2Dcolor%3A%20%23122b40%3B%0A%7D%0A%2Ebtn%2Dprimary%3Aactive%2C%0A%2Ebtn%2Dprimary%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dprimary%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%2Ebtn%2Dprimary%2Edisabled%3Ahover%2C%0A%2Ebtn%2Dprimary%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dprimary%3Ahover%2C%0A%2Ebtn%2Dprimary%2Edisabled%3Afocus%2C%0A%2Ebtn%2Dprimary%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dprimary%3Afocus%2C%0A%2Ebtn%2Dprimary%2Edisabled%2Efocus%2C%0A%2Ebtn%2Dprimary%5Bdisabled%5D%2Efocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dprimary%2Efocus%20%7B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0Aborder%2Dcolor%3A%20%232e6da4%3B%0A%7D%0A%2Ebtn%2Dprimary%20%2Ebadge%20%7B%0Acolor%3A%20%23337ab7%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Ebtn%2Dsuccess%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%235cb85c%3B%0Aborder%2Dcolor%3A%20%234cae4c%3B%0A%7D%0A%2Ebtn%2Dsuccess%3Afocus%2C%0A%2Ebtn%2Dsuccess%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23449d44%3B%0Aborder%2Dcolor%3A%20%23255625%3B%0A%7D%0A%2Ebtn%2Dsuccess%3Ahover%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23449d44%3B%0Aborder%2Dcolor%3A%20%23398439%3B%0A%7D%0A%2Ebtn%2Dsuccess%3Aactive%2C%0A%2Ebtn%2Dsuccess%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dsuccess%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23449d44%3B%0Aborder%2Dcolor%3A%20%23398439%3B%0A%7D%0A%2Ebtn%2Dsuccess%3Aactive%3Ahover%2C%0A%2Ebtn%2Dsuccess%2Eactive%3Ahover%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dsuccess%3Ahover%2C%0A%2Ebtn%2Dsuccess%3Aactive%3Afocus%2C%0A%2Ebtn%2Dsuccess%2Eactive%3Afocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dsuccess%3Afocus%2C%0A%2Ebtn%2Dsuccess%3Aactive%2Efocus%2C%0A%2Ebtn%2Dsuccess%2Eactive%2Efocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dsuccess%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23398439%3B%0Aborder%2Dcolor%3A%20%23255625%3B%0A%7D%0A%2Ebtn%2Dsuccess%3Aactive%2C%0A%2Ebtn%2Dsuccess%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dsuccess%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%2Ebtn%2Dsuccess%2Edisabled%3Ahover%2C%0A%2Ebtn%2Dsuccess%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dsuccess%3Ahover%2C%0A%2Ebtn%2Dsuccess%2Edisabled%3Afocus%2C%0A%2Ebtn%2Dsuccess%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dsuccess%3Afocus%2C%0A%2Ebtn%2Dsuccess%2Edisabled%2Efocus%2C%0A%2Ebtn%2Dsuccess%5Bdisabled%5D%2Efocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dsuccess%2Efocus%20%7B%0Abackground%2Dcolor%3A%20%235cb85c%3B%0Aborder%2Dcolor%3A%20%234cae4c%3B%0A%7D%0A%2Ebtn%2Dsuccess%20%2Ebadge%20%7B%0Acolor%3A%20%235cb85c%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Ebtn%2Dinfo%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%235bc0de%3B%0Aborder%2Dcolor%3A%20%2346b8da%3B%0A%7D%0A%2Ebtn%2Dinfo%3Afocus%2C%0A%2Ebtn%2Dinfo%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%2331b0d5%3B%0Aborder%2Dcolor%3A%20%231b6d85%3B%0A%7D%0A%2Ebtn%2Dinfo%3Ahover%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%2331b0d5%3B%0Aborder%2Dcolor%3A%20%23269abc%3B%0A%7D%0A%2Ebtn%2Dinfo%3Aactive%2C%0A%2Ebtn%2Dinfo%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dinfo%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%2331b0d5%3B%0Aborder%2Dcolor%3A%20%23269abc%3B%0A%7D%0A%2Ebtn%2Dinfo%3Aactive%3Ahover%2C%0A%2Ebtn%2Dinfo%2Eactive%3Ahover%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dinfo%3Ahover%2C%0A%2Ebtn%2Dinfo%3Aactive%3Afocus%2C%0A%2Ebtn%2Dinfo%2Eactive%3Afocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dinfo%3Afocus%2C%0A%2Ebtn%2Dinfo%3Aactive%2Efocus%2C%0A%2Ebtn%2Dinfo%2Eactive%2Efocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dinfo%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23269abc%3B%0Aborder%2Dcolor%3A%20%231b6d85%3B%0A%7D%0A%2Ebtn%2Dinfo%3Aactive%2C%0A%2Ebtn%2Dinfo%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dinfo%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%2Ebtn%2Dinfo%2Edisabled%3Ahover%2C%0A%2Ebtn%2Dinfo%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dinfo%3Ahover%2C%0A%2Ebtn%2Dinfo%2Edisabled%3Afocus%2C%0A%2Ebtn%2Dinfo%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dinfo%3Afocus%2C%0A%2Ebtn%2Dinfo%2Edisabled%2Efocus%2C%0A%2Ebtn%2Dinfo%5Bdisabled%5D%2Efocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dinfo%2Efocus%20%7B%0Abackground%2Dcolor%3A%20%235bc0de%3B%0Aborder%2Dcolor%3A%20%2346b8da%3B%0A%7D%0A%2Ebtn%2Dinfo%20%2Ebadge%20%7B%0Acolor%3A%20%235bc0de%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Ebtn%2Dwarning%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23f0ad4e%3B%0Aborder%2Dcolor%3A%20%23eea236%3B%0A%7D%0A%2Ebtn%2Dwarning%3Afocus%2C%0A%2Ebtn%2Dwarning%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23ec971f%3B%0Aborder%2Dcolor%3A%20%23985f0d%3B%0A%7D%0A%2Ebtn%2Dwarning%3Ahover%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23ec971f%3B%0Aborder%2Dcolor%3A%20%23d58512%3B%0A%7D%0A%2Ebtn%2Dwarning%3Aactive%2C%0A%2Ebtn%2Dwarning%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dwarning%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23ec971f%3B%0Aborder%2Dcolor%3A%20%23d58512%3B%0A%7D%0A%2Ebtn%2Dwarning%3Aactive%3Ahover%2C%0A%2Ebtn%2Dwarning%2Eactive%3Ahover%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dwarning%3Ahover%2C%0A%2Ebtn%2Dwarning%3Aactive%3Afocus%2C%0A%2Ebtn%2Dwarning%2Eactive%3Afocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dwarning%3Afocus%2C%0A%2Ebtn%2Dwarning%3Aactive%2Efocus%2C%0A%2Ebtn%2Dwarning%2Eactive%2Efocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dwarning%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23d58512%3B%0Aborder%2Dcolor%3A%20%23985f0d%3B%0A%7D%0A%2Ebtn%2Dwarning%3Aactive%2C%0A%2Ebtn%2Dwarning%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Dwarning%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%2Ebtn%2Dwarning%2Edisabled%3Ahover%2C%0A%2Ebtn%2Dwarning%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dwarning%3Ahover%2C%0A%2Ebtn%2Dwarning%2Edisabled%3Afocus%2C%0A%2Ebtn%2Dwarning%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dwarning%3Afocus%2C%0A%2Ebtn%2Dwarning%2Edisabled%2Efocus%2C%0A%2Ebtn%2Dwarning%5Bdisabled%5D%2Efocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dwarning%2Efocus%20%7B%0Abackground%2Dcolor%3A%20%23f0ad4e%3B%0Aborder%2Dcolor%3A%20%23eea236%3B%0A%7D%0A%2Ebtn%2Dwarning%20%2Ebadge%20%7B%0Acolor%3A%20%23f0ad4e%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Ebtn%2Ddanger%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23d9534f%3B%0Aborder%2Dcolor%3A%20%23d43f3a%3B%0A%7D%0A%2Ebtn%2Ddanger%3Afocus%2C%0A%2Ebtn%2Ddanger%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23c9302c%3B%0Aborder%2Dcolor%3A%20%23761c19%3B%0A%7D%0A%2Ebtn%2Ddanger%3Ahover%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23c9302c%3B%0Aborder%2Dcolor%3A%20%23ac2925%3B%0A%7D%0A%2Ebtn%2Ddanger%3Aactive%2C%0A%2Ebtn%2Ddanger%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddanger%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23c9302c%3B%0Aborder%2Dcolor%3A%20%23ac2925%3B%0A%7D%0A%2Ebtn%2Ddanger%3Aactive%3Ahover%2C%0A%2Ebtn%2Ddanger%2Eactive%3Ahover%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddanger%3Ahover%2C%0A%2Ebtn%2Ddanger%3Aactive%3Afocus%2C%0A%2Ebtn%2Ddanger%2Eactive%3Afocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddanger%3Afocus%2C%0A%2Ebtn%2Ddanger%3Aactive%2Efocus%2C%0A%2Ebtn%2Ddanger%2Eactive%2Efocus%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddanger%2Efocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23ac2925%3B%0Aborder%2Dcolor%3A%20%23761c19%3B%0A%7D%0A%2Ebtn%2Ddanger%3Aactive%2C%0A%2Ebtn%2Ddanger%2Eactive%2C%0A%2Eopen%20%3E%20%2Edropdown%2Dtoggle%2Ebtn%2Ddanger%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%2Ebtn%2Ddanger%2Edisabled%3Ahover%2C%0A%2Ebtn%2Ddanger%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Ddanger%3Ahover%2C%0A%2Ebtn%2Ddanger%2Edisabled%3Afocus%2C%0A%2Ebtn%2Ddanger%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Ddanger%3Afocus%2C%0A%2Ebtn%2Ddanger%2Edisabled%2Efocus%2C%0A%2Ebtn%2Ddanger%5Bdisabled%5D%2Efocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Ddanger%2Efocus%20%7B%0Abackground%2Dcolor%3A%20%23d9534f%3B%0Aborder%2Dcolor%3A%20%23d43f3a%3B%0A%7D%0A%2Ebtn%2Ddanger%20%2Ebadge%20%7B%0Acolor%3A%20%23d9534f%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Ebtn%2Dlink%20%7B%0Acolor%3A%20%23337ab7%3B%0Afont%2Dweight%3A%20normal%3B%0Aborder%2Dradius%3A%200%3B%0A%7D%0A%2Ebtn%2Dlink%2C%0A%2Ebtn%2Dlink%3Aactive%2C%0A%2Ebtn%2Dlink%2Eactive%2C%0A%2Ebtn%2Dlink%5Bdisabled%5D%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dlink%20%7B%0Abackground%2Dcolor%3A%20transparent%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20none%3B%0Abox%2Dshadow%3A%20none%3B%0A%7D%0A%2Ebtn%2Dlink%2C%0A%2Ebtn%2Dlink%3Ahover%2C%0A%2Ebtn%2Dlink%3Afocus%2C%0A%2Ebtn%2Dlink%3Aactive%20%7B%0Aborder%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Ebtn%2Dlink%3Ahover%2C%0A%2Ebtn%2Dlink%3Afocus%20%7B%0Acolor%3A%20%2323527c%3B%0Atext%2Ddecoration%3A%20underline%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Ebtn%2Dlink%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dlink%3Ahover%2C%0A%2Ebtn%2Dlink%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Ebtn%2Dlink%3Afocus%20%7B%0Acolor%3A%20%23777777%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0A%2Ebtn%2Dlg%20%7B%0Apadding%3A%2010px%2016px%3B%0Afont%2Dsize%3A%2025px%3B%0Aline%2Dheight%3A%201%2E3333333%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Ebtn%2Dsm%20%7B%0Apadding%3A%205px%2010px%3B%0Afont%2Dsize%3A%2017px%3B%0Aline%2Dheight%3A%201%2E5%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Ebtn%2Dxs%20%7B%0Apadding%3A%201px%205px%3B%0Afont%2Dsize%3A%2017px%3B%0Aline%2Dheight%3A%201%2E5%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Ebtn%2Dblock%20%7B%0Adisplay%3A%20block%3B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Ebtn%2Dblock%20%2B%20%2Ebtn%2Dblock%20%7B%0Amargin%2Dtop%3A%205px%3B%0A%7D%0Ainput%5Btype%3D%22submit%22%5D%2Ebtn%2Dblock%2C%0Ainput%5Btype%3D%22reset%22%5D%2Ebtn%2Dblock%2C%0Ainput%5Btype%3D%22button%22%5D%2Ebtn%2Dblock%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Efade%20%7B%0Aopacity%3A%200%3B%0A%2Dwebkit%2Dtransition%3A%20opacity%200%2E15s%20linear%3B%0A%2Do%2Dtransition%3A%20opacity%200%2E15s%20linear%3B%0Atransition%3A%20opacity%200%2E15s%20linear%3B%0A%7D%0A%2Efade%2Ein%20%7B%0Aopacity%3A%201%3B%0A%7D%0A%2Ecollapse%20%7B%0Adisplay%3A%20none%3B%0A%7D%0A%2Ecollapse%2Ein%20%7B%0Adisplay%3A%20block%3B%0A%7D%0Atr%2Ecollapse%2Ein%20%7B%0Adisplay%3A%20table%2Drow%3B%0A%7D%0Atbody%2Ecollapse%2Ein%20%7B%0Adisplay%3A%20table%2Drow%2Dgroup%3B%0A%7D%0A%2Ecollapsing%20%7B%0Aposition%3A%20relative%3B%0Aheight%3A%200%3B%0Aoverflow%3A%20hidden%3B%0A%2Dwebkit%2Dtransition%2Dproperty%3A%20height%2C%20visibility%3B%0Atransition%2Dproperty%3A%20height%2C%20visibility%3B%0A%2Dwebkit%2Dtransition%2Dduration%3A%200%2E35s%3B%0Atransition%2Dduration%3A%200%2E35s%3B%0A%2Dwebkit%2Dtransition%2Dtiming%2Dfunction%3A%20ease%3B%0Atransition%2Dtiming%2Dfunction%3A%20ease%3B%0A%7D%0A%2Ecaret%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Awidth%3A%200%3B%0Aheight%3A%200%3B%0Amargin%2Dleft%3A%202px%3B%0Avertical%2Dalign%3A%20middle%3B%0Aborder%2Dtop%3A%204px%20dashed%3B%0Aborder%2Dtop%3A%204px%20solid%20%5C9%3B%0Aborder%2Dright%3A%204px%20solid%20transparent%3B%0Aborder%2Dleft%3A%204px%20solid%20transparent%3B%0A%7D%0A%2Edropup%2C%0A%2Edropdown%20%7B%0Aposition%3A%20relative%3B%0A%7D%0A%2Edropdown%2Dtoggle%3Afocus%20%7B%0Aoutline%3A%200%3B%0A%7D%0A%2Edropdown%2Dmenu%20%7B%0Aposition%3A%20absolute%3B%0Atop%3A%20100%25%3B%0Aleft%3A%200%3B%0Az%2Dindex%3A%201000%3B%0Adisplay%3A%20none%3B%0Afloat%3A%20left%3B%0Amin%2Dwidth%3A%20160px%3B%0Apadding%3A%205px%200%3B%0Amargin%3A%202px%200%200%3B%0Alist%2Dstyle%3A%20none%3B%0Afont%2Dsize%3A%2020px%3B%0Atext%2Dalign%3A%20left%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Aborder%3A%201px%20solid%20%23ccc%3B%0Aborder%3A%201px%20solid%20rgba%280%2C%200%2C%200%2C%200%2E15%29%3B%0Aborder%2Dradius%3A%200px%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%200%206px%2012px%20rgba%280%2C%200%2C%200%2C%200%2E175%29%3B%0Abox%2Dshadow%3A%200%206px%2012px%20rgba%280%2C%200%2C%200%2C%200%2E175%29%3B%0Abackground%2Dclip%3A%20padding%2Dbox%3B%0A%7D%0A%2Edropdown%2Dmenu%2Epull%2Dright%20%7B%0Aright%3A%200%3B%0Aleft%3A%20auto%3B%0A%7D%0A%2Edropdown%2Dmenu%20%2Edivider%20%7B%0Aheight%3A%201px%3B%0Amargin%3A%2016%2E5px%200%3B%0Aoverflow%3A%20hidden%3B%0Abackground%2Dcolor%3A%20%23e5e5e5%3B%0A%7D%0A%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%20%7B%0Adisplay%3A%20block%3B%0Apadding%3A%203px%2020px%3B%0Aclear%3A%20both%3B%0Afont%2Dweight%3A%20normal%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20%23333333%3B%0Awhite%2Dspace%3A%20nowrap%3B%0A%7D%0A%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Atext%2Ddecoration%3A%20none%3B%0Acolor%3A%20%23262626%3B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0A%7D%0A%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Atext%2Ddecoration%3A%20none%3B%0Aoutline%3A%200%3B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%2C%0A%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23777777%3B%0A%7D%0A%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Afocus%20%7B%0Atext%2Ddecoration%3A%20none%3B%0Abackground%2Dcolor%3A%20transparent%3B%0Abackground%2Dimage%3A%20none%3B%0Afilter%3A%20progid%3ADXImageTransform%2EMicrosoft%2Egradient%28enabled%20%3D%20false%29%3B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%2Eopen%20%3E%20%2Edropdown%2Dmenu%20%7B%0Adisplay%3A%20block%3B%0A%7D%0A%2Eopen%20%3E%20a%20%7B%0Aoutline%3A%200%3B%0A%7D%0A%2Edropdown%2Dmenu%2Dright%20%7B%0Aleft%3A%20auto%3B%0Aright%3A%200%3B%0A%7D%0A%2Edropdown%2Dmenu%2Dleft%20%7B%0Aleft%3A%200%3B%0Aright%3A%20auto%3B%0A%7D%0A%2Edropdown%2Dheader%20%7B%0Adisplay%3A%20block%3B%0Apadding%3A%203px%2020px%3B%0Afont%2Dsize%3A%2017px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Acolor%3A%20%23777777%3B%0Awhite%2Dspace%3A%20nowrap%3B%0A%7D%0A%2Edropdown%2Dbackdrop%20%7B%0Aposition%3A%20fixed%3B%0Aleft%3A%200%3B%0Aright%3A%200%3B%0Abottom%3A%200%3B%0Atop%3A%200%3B%0Az%2Dindex%3A%20990%3B%0A%7D%0A%2Epull%2Dright%20%3E%20%2Edropdown%2Dmenu%20%7B%0Aright%3A%200%3B%0Aleft%3A%20auto%3B%0A%7D%0A%2Edropup%20%2Ecaret%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%2Edropdown%20%2Ecaret%20%7B%0Aborder%2Dtop%3A%200%3B%0Aborder%2Dbottom%3A%204px%20dashed%3B%0Aborder%2Dbottom%3A%204px%20solid%20%5C9%3B%0Acontent%3A%20%22%22%3B%0A%7D%0A%2Edropup%20%2Edropdown%2Dmenu%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%2Edropdown%20%2Edropdown%2Dmenu%20%7B%0Atop%3A%20auto%3B%0Abottom%3A%20100%25%3B%0Amargin%2Dbottom%3A%202px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dright%20%2Edropdown%2Dmenu%20%7B%0Aleft%3A%20auto%3B%0Aright%3A%200%3B%0A%7D%0A%2Enavbar%2Dright%20%2Edropdown%2Dmenu%2Dleft%20%7B%0Aleft%3A%200%3B%0Aright%3A%20auto%3B%0A%7D%0A%7D%0A%2Enav%20%7B%0Amargin%2Dbottom%3A%200%3B%0Apadding%2Dleft%3A%200%3B%0Alist%2Dstyle%3A%20none%3B%0A%7D%0A%2Enav%20%3E%20li%20%7B%0Aposition%3A%20relative%3B%0Adisplay%3A%20block%3B%0A%7D%0A%2Enav%20%3E%20li%20%3E%20a%20%7B%0Aposition%3A%20relative%3B%0Adisplay%3A%20block%3B%0Apadding%3A%2010px%2015px%3B%0A%7D%0A%2Enav%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Enav%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Atext%2Ddecoration%3A%20none%3B%0Abackground%2Dcolor%3A%20%23eeeeee%3B%0A%7D%0A%2Enav%20%3E%20li%2Edisabled%20%3E%20a%20%7B%0Acolor%3A%20%23777777%3B%0A%7D%0A%2Enav%20%3E%20li%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Enav%20%3E%20li%2Edisabled%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23777777%3B%0Atext%2Ddecoration%3A%20none%3B%0Abackground%2Dcolor%3A%20transparent%3B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%2Enav%20%2Eopen%20%3E%20a%2C%0A%2Enav%20%2Eopen%20%3E%20a%3Ahover%2C%0A%2Enav%20%2Eopen%20%3E%20a%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23eeeeee%3B%0Aborder%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Enav%20%2Enav%2Ddivider%20%7B%0Aheight%3A%201px%3B%0Amargin%3A%2016%2E5px%200%3B%0Aoverflow%3A%20hidden%3B%0Abackground%2Dcolor%3A%20%23e5e5e5%3B%0A%7D%0A%2Enav%20%3E%20li%20%3E%20a%20%3E%20img%20%7B%0Amax%2Dwidth%3A%20none%3B%0A%7D%0A%2Enav%2Dtabs%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Enav%2Dtabs%20%3E%20li%20%7B%0Afloat%3A%20left%3B%0Amargin%2Dbottom%3A%20%2D1px%3B%0A%7D%0A%2Enav%2Dtabs%20%3E%20li%20%3E%20a%20%7B%0Amargin%2Dright%3A%202px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Aborder%2Dradius%3A%200px%200px%200%200%3B%0A%7D%0A%2Enav%2Dtabs%20%3E%20li%20%3E%20a%3Ahover%20%7B%0Aborder%2Dcolor%3A%20%23eeeeee%20%23eeeeee%20%23ddd%3B%0A%7D%0A%2Enav%2Dtabs%20%3E%20li%2Eactive%20%3E%20a%2C%0A%2Enav%2Dtabs%20%3E%20li%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enav%2Dtabs%20%3E%20li%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23555555%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Aborder%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dbottom%2Dcolor%3A%20transparent%3B%0Acursor%3A%20default%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%7B%0Awidth%3A%20100%25%3B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20li%20%7B%0Afloat%3A%20none%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Atext%2Dalign%3A%20center%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Edropdown%20%2Edropdown%2Dmenu%20%7B%0Atop%3A%20auto%3B%0Aleft%3A%20auto%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20li%20%7B%0Adisplay%3A%20table%2Dcell%3B%0Awidth%3A%201%25%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Amargin%2Dright%3A%200%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dradius%3A%200px%200px%200%200%3B%0A%7D%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enav%2Dtabs%2Enav%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23fff%3B%0A%7D%0A%7D%0A%2Enav%2Dpills%20%3E%20li%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%2Enav%2Dpills%20%3E%20li%20%3E%20a%20%7B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Enav%2Dpills%20%3E%20li%20%2B%20li%20%7B%0Amargin%2Dleft%3A%202px%3B%0A%7D%0A%2Enav%2Dpills%20%3E%20li%2Eactive%20%3E%20a%2C%0A%2Enav%2Dpills%20%3E%20li%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enav%2Dpills%20%3E%20li%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Enav%2Dstacked%20%3E%20li%20%7B%0Afloat%3A%20none%3B%0A%7D%0A%2Enav%2Dstacked%20%3E%20li%20%2B%20li%20%7B%0Amargin%2Dtop%3A%202px%3B%0Amargin%2Dleft%3A%200%3B%0A%7D%0A%2Enav%2Djustified%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Enav%2Djustified%20%3E%20li%20%7B%0Afloat%3A%20none%3B%0A%7D%0A%2Enav%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Atext%2Dalign%3A%20center%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%2Enav%2Djustified%20%3E%20%2Edropdown%20%2Edropdown%2Dmenu%20%7B%0Atop%3A%20auto%3B%0Aleft%3A%20auto%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enav%2Djustified%20%3E%20li%20%7B%0Adisplay%3A%20table%2Dcell%3B%0Awidth%3A%201%25%3B%0A%7D%0A%2Enav%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%7D%0A%2Enav%2Dtabs%2Djustified%20%7B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%2Enav%2Dtabs%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Amargin%2Dright%3A%200%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Enav%2Dtabs%2Djustified%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enav%2Dtabs%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enav%2Dtabs%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enav%2Dtabs%2Djustified%20%3E%20li%20%3E%20a%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dradius%3A%200px%200px%200%200%3B%0A%7D%0A%2Enav%2Dtabs%2Djustified%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enav%2Dtabs%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enav%2Dtabs%2Djustified%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23fff%3B%0A%7D%0A%7D%0A%2Etab%2Dcontent%20%3E%20%2Etab%2Dpane%20%7B%0Adisplay%3A%20none%3B%0A%7D%0A%2Etab%2Dcontent%20%3E%20%2Eactive%20%7B%0Adisplay%3A%20block%3B%0A%7D%0A%2Enav%2Dtabs%20%2Edropdown%2Dmenu%20%7B%0Amargin%2Dtop%3A%20%2D1px%3B%0Aborder%2Dtop%2Dright%2Dradius%3A%200%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%200%3B%0A%7D%0A%2Enavbar%20%7B%0Aposition%3A%20relative%3B%0Amin%2Dheight%3A%2050px%3B%0Amargin%2Dbottom%3A%2035px%3B%0Aborder%3A%201px%20solid%20transparent%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%20%7B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dheader%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%7D%0A%2Enavbar%2Dcollapse%20%7B%0Aoverflow%2Dx%3A%20visible%3B%0Apadding%2Dright%3A%2015px%3B%0Apadding%2Dleft%3A%2015px%3B%0Aborder%2Dtop%3A%201px%20solid%20transparent%3B%0Abox%2Dshadow%3A%20inset%200%201px%200%20rgba%28255%2C%20255%2C%20255%2C%200%2E1%29%3B%0A%2Dwebkit%2Doverflow%2Dscrolling%3A%20touch%3B%0A%7D%0A%2Enavbar%2Dcollapse%2Ein%20%7B%0Aoverflow%2Dy%3A%20auto%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dcollapse%20%7B%0Awidth%3A%20auto%3B%0Aborder%2Dtop%3A%200%3B%0Abox%2Dshadow%3A%20none%3B%0A%7D%0A%2Enavbar%2Dcollapse%2Ecollapse%20%7B%0Adisplay%3A%20block%20%21important%3B%0Aheight%3A%20auto%20%21important%3B%0Apadding%2Dbottom%3A%200%3B%0Aoverflow%3A%20visible%20%21important%3B%0A%7D%0A%2Enavbar%2Dcollapse%2Ein%20%7B%0Aoverflow%2Dy%3A%20visible%3B%0A%7D%0A%2Enavbar%2Dfixed%2Dtop%20%2Enavbar%2Dcollapse%2C%0A%2Enavbar%2Dstatic%2Dtop%20%2Enavbar%2Dcollapse%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%2Enavbar%2Dcollapse%20%7B%0Apadding%2Dleft%3A%200%3B%0Apadding%2Dright%3A%200%3B%0A%7D%0A%7D%0A%2Enavbar%2Dfixed%2Dtop%20%2Enavbar%2Dcollapse%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%2Enavbar%2Dcollapse%20%7B%0Amax%2Dheight%3A%20340px%3B%0A%7D%0A%40media%20%28max%2Ddevice%2Dwidth%3A%20480px%29%20and%20%28orientation%3A%20landscape%29%20%7B%0A%2Enavbar%2Dfixed%2Dtop%20%2Enavbar%2Dcollapse%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%2Enavbar%2Dcollapse%20%7B%0Amax%2Dheight%3A%20200px%3B%0A%7D%0A%7D%0A%2Econtainer%20%3E%20%2Enavbar%2Dheader%2C%0A%2Econtainer%2Dfluid%20%3E%20%2Enavbar%2Dheader%2C%0A%2Econtainer%20%3E%20%2Enavbar%2Dcollapse%2C%0A%2Econtainer%2Dfluid%20%3E%20%2Enavbar%2Dcollapse%20%7B%0Amargin%2Dright%3A%20%2D15px%3B%0Amargin%2Dleft%3A%20%2D15px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Econtainer%20%3E%20%2Enavbar%2Dheader%2C%0A%2Econtainer%2Dfluid%20%3E%20%2Enavbar%2Dheader%2C%0A%2Econtainer%20%3E%20%2Enavbar%2Dcollapse%2C%0A%2Econtainer%2Dfluid%20%3E%20%2Enavbar%2Dcollapse%20%7B%0Amargin%2Dright%3A%200%3B%0Amargin%2Dleft%3A%200%3B%0A%7D%0A%7D%0A%2Enavbar%2Dstatic%2Dtop%20%7B%0Az%2Dindex%3A%201000%3B%0Aborder%2Dwidth%3A%200%200%201px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dstatic%2Dtop%20%7B%0Aborder%2Dradius%3A%200%3B%0A%7D%0A%7D%0A%2Enavbar%2Dfixed%2Dtop%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%7B%0Aposition%3A%20fixed%3B%0Aright%3A%200%3B%0Aleft%3A%200%3B%0Az%2Dindex%3A%201030%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dfixed%2Dtop%2C%0A%2Enavbar%2Dfixed%2Dbottom%20%7B%0Aborder%2Dradius%3A%200%3B%0A%7D%0A%7D%0A%2Enavbar%2Dfixed%2Dtop%20%7B%0Atop%3A%200%3B%0Aborder%2Dwidth%3A%200%200%201px%3B%0A%7D%0A%2Enavbar%2Dfixed%2Dbottom%20%7B%0Abottom%3A%200%3B%0Amargin%2Dbottom%3A%200%3B%0Aborder%2Dwidth%3A%201px%200%200%3B%0A%7D%0A%2Enavbar%2Dbrand%20%7B%0Afloat%3A%20left%3B%0Apadding%3A%207%2E5px%2015px%3B%0Afont%2Dsize%3A%2025px%3B%0Aline%2Dheight%3A%2035px%3B%0Aheight%3A%2050px%3B%0A%7D%0A%2Enavbar%2Dbrand%3Ahover%2C%0A%2Enavbar%2Dbrand%3Afocus%20%7B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0A%2Enavbar%2Dbrand%20%3E%20img%20%7B%0Adisplay%3A%20block%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%20%3E%20%2Econtainer%20%2Enavbar%2Dbrand%2C%0A%2Enavbar%20%3E%20%2Econtainer%2Dfluid%20%2Enavbar%2Dbrand%20%7B%0Amargin%2Dleft%3A%20%2D15px%3B%0A%7D%0A%7D%0A%2Enavbar%2Dtoggle%20%7B%0Aposition%3A%20relative%3B%0Afloat%3A%20right%3B%0Amargin%2Dright%3A%2015px%3B%0Apadding%3A%209px%2010px%3B%0Amargin%2Dtop%3A%208px%3B%0Amargin%2Dbottom%3A%208px%3B%0Abackground%2Dcolor%3A%20transparent%3B%0Abackground%2Dimage%3A%20none%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Enavbar%2Dtoggle%3Afocus%20%7B%0Aoutline%3A%200%3B%0A%7D%0A%2Enavbar%2Dtoggle%20%2Eicon%2Dbar%20%7B%0Adisplay%3A%20block%3B%0Awidth%3A%2022px%3B%0Aheight%3A%202px%3B%0Aborder%2Dradius%3A%201px%3B%0A%7D%0A%2Enavbar%2Dtoggle%20%2Eicon%2Dbar%20%2B%20%2Eicon%2Dbar%20%7B%0Amargin%2Dtop%3A%204px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dtoggle%20%7B%0Adisplay%3A%20none%3B%0A%7D%0A%7D%0A%2Enavbar%2Dnav%20%7B%0Amargin%3A%203%2E75px%20%2D15px%3B%0A%7D%0A%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%2010px%3B%0Aline%2Dheight%3A%2035px%3B%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%7B%0Aposition%3A%20static%3B%0Afloat%3A%20none%3B%0Awidth%3A%20auto%3B%0Amargin%2Dtop%3A%200%3B%0Abackground%2Dcolor%3A%20transparent%3B%0Aborder%3A%200%3B%0Abox%2Dshadow%3A%20none%3B%0A%7D%0A%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%2C%0A%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%2Edropdown%2Dheader%20%7B%0Apadding%3A%205px%2015px%205px%2025px%3B%0A%7D%0A%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%20%7B%0Aline%2Dheight%3A%2035px%3B%0A%7D%0A%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Abackground%2Dimage%3A%20none%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dnav%20%7B%0Afloat%3A%20left%3B%0Amargin%3A%200%3B%0A%7D%0A%2Enavbar%2Dnav%20%3E%20li%20%7B%0Afloat%3A%20left%3B%0A%7D%0A%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%207%2E5px%3B%0Apadding%2Dbottom%3A%207%2E5px%3B%0A%7D%0A%7D%0A%2Enavbar%2Dform%20%7B%0Amargin%2Dleft%3A%20%2D15px%3B%0Amargin%2Dright%3A%20%2D15px%3B%0Apadding%3A%2010px%2015px%3B%0Aborder%2Dtop%3A%201px%20solid%20transparent%3B%0Aborder%2Dbottom%3A%201px%20solid%20transparent%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%200%20rgba%28255%2C%20255%2C%20255%2C%200%2E1%29%2C%200%201px%200%20rgba%28255%2C%20255%2C%20255%2C%200%2E1%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%200%20rgba%28255%2C%20255%2C%20255%2C%200%2E1%29%2C%200%201px%200%20rgba%28255%2C%20255%2C%20255%2C%200%2E1%29%3B%0Amargin%2Dtop%3A%200%2E5px%3B%0Amargin%2Dbottom%3A%200%2E5px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dform%20%2Eform%2Dgroup%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Enavbar%2Dform%20%2Eform%2Dcontrol%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Awidth%3A%20auto%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Enavbar%2Dform%20%2Eform%2Dcontrol%2Dstatic%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0A%7D%0A%2Enavbar%2Dform%20%2Einput%2Dgroup%20%7B%0Adisplay%3A%20inline%2Dtable%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Enavbar%2Dform%20%2Einput%2Dgroup%20%2Einput%2Dgroup%2Daddon%2C%0A%2Enavbar%2Dform%20%2Einput%2Dgroup%20%2Einput%2Dgroup%2Dbtn%2C%0A%2Enavbar%2Dform%20%2Einput%2Dgroup%20%2Eform%2Dcontrol%20%7B%0Awidth%3A%20auto%3B%0A%7D%0A%2Enavbar%2Dform%20%2Einput%2Dgroup%20%3E%20%2Eform%2Dcontrol%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0A%2Enavbar%2Dform%20%2Econtrol%2Dlabel%20%7B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Enavbar%2Dform%20%2Eradio%2C%0A%2Enavbar%2Dform%20%2Echeckbox%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%200%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0A%2Enavbar%2Dform%20%2Eradio%20label%2C%0A%2Enavbar%2Dform%20%2Echeckbox%20label%20%7B%0Apadding%2Dleft%3A%200%3B%0A%7D%0A%2Enavbar%2Dform%20%2Eradio%20input%5Btype%3D%22radio%22%5D%2C%0A%2Enavbar%2Dform%20%2Echeckbox%20input%5Btype%3D%22checkbox%22%5D%20%7B%0Aposition%3A%20relative%3B%0Amargin%2Dleft%3A%200%3B%0A%7D%0A%2Enavbar%2Dform%20%2Ehas%2Dfeedback%20%2Eform%2Dcontrol%2Dfeedback%20%7B%0Atop%3A%200%3B%0A%7D%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Enavbar%2Dform%20%2Eform%2Dgroup%20%7B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%2Enavbar%2Dform%20%2Eform%2Dgroup%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dform%20%7B%0Awidth%3A%20auto%3B%0Aborder%3A%200%3B%0Amargin%2Dleft%3A%200%3B%0Amargin%2Dright%3A%200%3B%0Apadding%2Dtop%3A%200%3B%0Apadding%2Dbottom%3A%200%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20none%3B%0Abox%2Dshadow%3A%20none%3B%0A%7D%0A%7D%0A%2Enavbar%2Dnav%20%3E%20li%20%3E%20%2Edropdown%2Dmenu%20%7B%0Amargin%2Dtop%3A%200%3B%0Aborder%2Dtop%2Dright%2Dradius%3A%200%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%200%3B%0A%7D%0A%2Enavbar%2Dfixed%2Dbottom%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20%2Edropdown%2Dmenu%20%7B%0Amargin%2Dbottom%3A%200%3B%0Aborder%2Dtop%2Dright%2Dradius%3A%200px%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%200px%3B%0Aborder%2Dbottom%2Dright%2Dradius%3A%200%3B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%200%3B%0A%7D%0A%2Enavbar%2Dbtn%20%7B%0Amargin%2Dtop%3A%200%2E5px%3B%0Amargin%2Dbottom%3A%200%2E5px%3B%0A%7D%0A%2Enavbar%2Dbtn%2Ebtn%2Dsm%20%7B%0Amargin%2Dtop%3A%206%2E5px%3B%0Amargin%2Dbottom%3A%206%2E5px%3B%0A%7D%0A%2Enavbar%2Dbtn%2Ebtn%2Dxs%20%7B%0Amargin%2Dtop%3A%2014px%3B%0Amargin%2Dbottom%3A%2014px%3B%0A%7D%0A%2Enavbar%2Dtext%20%7B%0Amargin%2Dtop%3A%207%2E5px%3B%0Amargin%2Dbottom%3A%207%2E5px%3B%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dtext%20%7B%0Afloat%3A%20left%3B%0Amargin%2Dleft%3A%2015px%3B%0Amargin%2Dright%3A%2015px%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%2Enavbar%2Dleft%20%7B%0Afloat%3A%20left%20%21important%3B%0A%7D%0A%2Enavbar%2Dright%20%7B%0Afloat%3A%20right%20%21important%3B%0Amargin%2Dright%3A%20%2D15px%3B%0A%7D%0A%2Enavbar%2Dright%20%7E%20%2Enavbar%2Dright%20%7B%0Amargin%2Dright%3A%200%3B%0A%7D%0A%7D%0A%2Enavbar%2Ddefault%20%7B%0Abackground%2Dcolor%3A%20%23f8f8f8%3B%0Aborder%2Dcolor%3A%20%23e7e7e7%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dbrand%20%7B%0Acolor%3A%20%23777%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dbrand%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dbrand%3Afocus%20%7B%0Acolor%3A%20%235e5e5e%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dtext%20%7B%0Acolor%3A%20%23777%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%20%7B%0Acolor%3A%20%23777%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23555%3B%0Abackground%2Dcolor%3A%20%23e7e7e7%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Edisabled%20%3E%20a%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Edisabled%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23ccc%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dtoggle%20%7B%0Aborder%2Dcolor%3A%20%23ddd%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dtoggle%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dtoggle%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23ddd%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dtoggle%20%2Eicon%2Dbar%20%7B%0Abackground%2Dcolor%3A%20%23888%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dcollapse%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dform%20%7B%0Aborder%2Dcolor%3A%20%23e7e7e7%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Eopen%20%3E%20a%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Eopen%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%3E%20%2Eopen%20%3E%20a%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23e7e7e7%3B%0Acolor%3A%20%23555%3B%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%20%7B%0Acolor%3A%20%23777%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23333%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23555%3B%0Abackground%2Dcolor%3A%20%23e7e7e7%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23ccc%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dlink%20%7B%0Acolor%3A%20%23777%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Enavbar%2Dlink%3Ahover%20%7B%0Acolor%3A%20%23333%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%20%7B%0Acolor%3A%20%23777%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%3Afocus%20%7B%0Acolor%3A%20%23333%3B%0A%7D%0A%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%3Ahover%2C%0A%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Enavbar%2Ddefault%20%2Ebtn%2Dlink%3Afocus%20%7B%0Acolor%3A%20%23ccc%3B%0A%7D%0A%2Enavbar%2Dinverse%20%7B%0Abackground%2Dcolor%3A%20%23222%3B%0Aborder%2Dcolor%3A%20%23080808%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dbrand%20%7B%0Acolor%3A%20%239d9d9d%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dbrand%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dbrand%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dtext%20%7B%0Acolor%3A%20%239d9d9d%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%20%7B%0Acolor%3A%20%239d9d9d%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23080808%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Edisabled%20%3E%20a%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Edisabled%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23444%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dtoggle%20%7B%0Aborder%2Dcolor%3A%20%23333%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dtoggle%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dtoggle%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23333%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dtoggle%20%2Eicon%2Dbar%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dcollapse%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dform%20%7B%0Aborder%2Dcolor%3A%20%23101010%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Eopen%20%3E%20a%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Eopen%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%3E%20%2Eopen%20%3E%20a%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23080808%3B%0Acolor%3A%20%23fff%3B%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edropdown%2Dheader%20%7B%0Aborder%2Dcolor%3A%20%23080808%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%2Edivider%20%7B%0Abackground%2Dcolor%3A%20%23080808%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%20%7B%0Acolor%3A%20%239d9d9d%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20li%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Eactive%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23080808%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dnav%20%2Eopen%20%2Edropdown%2Dmenu%20%3E%20%2Edisabled%20%3E%20a%3Afocus%20%7B%0Acolor%3A%20%23444%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dlink%20%7B%0Acolor%3A%20%239d9d9d%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Enavbar%2Dlink%3Ahover%20%7B%0Acolor%3A%20%23fff%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%20%7B%0Acolor%3A%20%239d9d9d%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0A%7D%0A%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%5Bdisabled%5D%3Ahover%2C%0Afieldset%5Bdisabled%5D%20%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%3Ahover%2C%0A%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%5Bdisabled%5D%3Afocus%2C%0Afieldset%5Bdisabled%5D%20%2Enavbar%2Dinverse%20%2Ebtn%2Dlink%3Afocus%20%7B%0Acolor%3A%20%23444%3B%0A%7D%0A%2Elabel%20%7B%0Adisplay%3A%20inline%3B%0Apadding%3A%20%2E2em%20%2E6em%20%2E3em%3B%0Afont%2Dsize%3A%2075%25%3B%0Afont%2Dweight%3A%20bold%3B%0Aline%2Dheight%3A%201%3B%0Acolor%3A%20%23fff%3B%0Atext%2Dalign%3A%20center%3B%0Awhite%2Dspace%3A%20nowrap%3B%0Avertical%2Dalign%3A%20baseline%3B%0Aborder%2Dradius%3A%20%2E25em%3B%0A%7D%0Aa%2Elabel%3Ahover%2C%0Aa%2Elabel%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Atext%2Ddecoration%3A%20none%3B%0Acursor%3A%20pointer%3B%0A%7D%0A%2Elabel%3Aempty%20%7B%0Adisplay%3A%20none%3B%0A%7D%0A%2Ebtn%20%2Elabel%20%7B%0Aposition%3A%20relative%3B%0Atop%3A%20%2D1px%3B%0A%7D%0A%2Elabel%2Ddefault%20%7B%0Abackground%2Dcolor%3A%20%23777777%3B%0A%7D%0A%2Elabel%2Ddefault%5Bhref%5D%3Ahover%2C%0A%2Elabel%2Ddefault%5Bhref%5D%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%235e5e5e%3B%0A%7D%0A%2Elabel%2Dprimary%20%7B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Elabel%2Dprimary%5Bhref%5D%3Ahover%2C%0A%2Elabel%2Dprimary%5Bhref%5D%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23286090%3B%0A%7D%0A%2Elabel%2Dsuccess%20%7B%0Abackground%2Dcolor%3A%20%235cb85c%3B%0A%7D%0A%2Elabel%2Dsuccess%5Bhref%5D%3Ahover%2C%0A%2Elabel%2Dsuccess%5Bhref%5D%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23449d44%3B%0A%7D%0A%2Elabel%2Dinfo%20%7B%0Abackground%2Dcolor%3A%20%235bc0de%3B%0A%7D%0A%2Elabel%2Dinfo%5Bhref%5D%3Ahover%2C%0A%2Elabel%2Dinfo%5Bhref%5D%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%2331b0d5%3B%0A%7D%0A%2Elabel%2Dwarning%20%7B%0Abackground%2Dcolor%3A%20%23f0ad4e%3B%0A%7D%0A%2Elabel%2Dwarning%5Bhref%5D%3Ahover%2C%0A%2Elabel%2Dwarning%5Bhref%5D%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23ec971f%3B%0A%7D%0A%2Elabel%2Ddanger%20%7B%0Abackground%2Dcolor%3A%20%23d9534f%3B%0A%7D%0A%2Elabel%2Ddanger%5Bhref%5D%3Ahover%2C%0A%2Elabel%2Ddanger%5Bhref%5D%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23c9302c%3B%0A%7D%0A%2Ebadge%20%7B%0Adisplay%3A%20inline%2Dblock%3B%0Amin%2Dwidth%3A%2010px%3B%0Apadding%3A%203px%207px%3B%0Afont%2Dsize%3A%2017px%3B%0Afont%2Dweight%3A%20bold%3B%0Acolor%3A%20%23fff%3B%0Aline%2Dheight%3A%201%3B%0Avertical%2Dalign%3A%20middle%3B%0Awhite%2Dspace%3A%20nowrap%3B%0Atext%2Dalign%3A%20center%3B%0Abackground%2Dcolor%3A%20%23777777%3B%0Aborder%2Dradius%3A%2010px%3B%0A%7D%0A%2Ebadge%3Aempty%20%7B%0Adisplay%3A%20none%3B%0A%7D%0A%2Ebtn%20%2Ebadge%20%7B%0Aposition%3A%20relative%3B%0Atop%3A%20%2D1px%3B%0A%7D%0A%2Ebtn%2Dxs%20%2Ebadge%2C%0A%2Ebtn%2Dgroup%2Dxs%20%3E%20%2Ebtn%20%2Ebadge%20%7B%0Atop%3A%200%3B%0Apadding%3A%201px%205px%3B%0A%7D%0Aa%2Ebadge%3Ahover%2C%0Aa%2Ebadge%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Atext%2Ddecoration%3A%20none%3B%0Acursor%3A%20pointer%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Eactive%20%3E%20%2Ebadge%2C%0A%2Enav%2Dpills%20%3E%20%2Eactive%20%3E%20a%20%3E%20%2Ebadge%20%7B%0Acolor%3A%20%23337ab7%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%20%3E%20%2Ebadge%20%7B%0Afloat%3A%20right%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%20%3E%20%2Ebadge%20%2B%20%2Ebadge%20%7B%0Amargin%2Dright%3A%205px%3B%0A%7D%0A%2Enav%2Dpills%20%3E%20li%20%3E%20a%20%3E%20%2Ebadge%20%7B%0Amargin%2Dleft%3A%203px%3B%0A%7D%0A%2Ealert%20%7B%0Apadding%3A%2015px%3B%0Amargin%2Dbottom%3A%2035px%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Ealert%20h4%20%7B%0Amargin%2Dtop%3A%200%3B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Ealert%20%2Ealert%2Dlink%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ealert%20%3E%20p%2C%0A%2Ealert%20%3E%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Ealert%20%3E%20p%20%2B%20p%20%7B%0Amargin%2Dtop%3A%205px%3B%0A%7D%0A%2Ealert%2Ddismissable%2C%0A%2Ealert%2Ddismissible%20%7B%0Apadding%2Dright%3A%2035px%3B%0A%7D%0A%2Ealert%2Ddismissable%20%2Eclose%2C%0A%2Ealert%2Ddismissible%20%2Eclose%20%7B%0Aposition%3A%20relative%3B%0Atop%3A%20%2D2px%3B%0Aright%3A%20%2D21px%3B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Ealert%2Dsuccess%20%7B%0Abackground%2Dcolor%3A%20%23dff0d8%3B%0Aborder%2Dcolor%3A%20%23d6e9c6%3B%0Acolor%3A%20%233c763d%3B%0A%7D%0A%2Ealert%2Dsuccess%20hr%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23c9e2b3%3B%0A%7D%0A%2Ealert%2Dsuccess%20%2Ealert%2Dlink%20%7B%0Acolor%3A%20%232b542c%3B%0A%7D%0A%2Ealert%2Dinfo%20%7B%0Abackground%2Dcolor%3A%20%23d9edf7%3B%0Aborder%2Dcolor%3A%20%23bce8f1%3B%0Acolor%3A%20%2331708f%3B%0A%7D%0A%2Ealert%2Dinfo%20hr%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23a6e1ec%3B%0A%7D%0A%2Ealert%2Dinfo%20%2Ealert%2Dlink%20%7B%0Acolor%3A%20%23245269%3B%0A%7D%0A%2Ealert%2Dwarning%20%7B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0Aborder%2Dcolor%3A%20%23faebcc%3B%0Acolor%3A%20%238a6d3b%3B%0A%7D%0A%2Ealert%2Dwarning%20hr%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23f7e1b5%3B%0A%7D%0A%2Ealert%2Dwarning%20%2Ealert%2Dlink%20%7B%0Acolor%3A%20%2366512c%3B%0A%7D%0A%2Ealert%2Ddanger%20%7B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0Aborder%2Dcolor%3A%20%23ebccd1%3B%0Acolor%3A%20%23a94442%3B%0A%7D%0A%2Ealert%2Ddanger%20hr%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23e4b9c0%3B%0A%7D%0A%2Ealert%2Ddanger%20%2Ealert%2Dlink%20%7B%0Acolor%3A%20%23843534%3B%0A%7D%0A%2Elist%2Dgroup%20%7B%0Amargin%2Dbottom%3A%2020px%3B%0Apadding%2Dleft%3A%200%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%20%7B%0Aposition%3A%20relative%3B%0Adisplay%3A%20block%3B%0Apadding%3A%2010px%2015px%3B%0Amargin%2Dbottom%3A%20%2D1px%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%2Dright%2Dradius%3A%200px%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%200px%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0Aborder%2Dbottom%2Dright%2Dradius%3A%200px%3B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%200px%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2C%0Abutton%2Elist%2Dgroup%2Ditem%20%7B%0Acolor%3A%20%23555%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0Abutton%2Elist%2Dgroup%2Ditem%20%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Acolor%3A%20%23333%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%3Afocus%20%7B%0Atext%2Ddecoration%3A%20none%3B%0Acolor%3A%20%23555%3B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0A%7D%0Abutton%2Elist%2Dgroup%2Ditem%20%7B%0Awidth%3A%20100%25%3B%0Atext%2Dalign%3A%20left%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Edisabled%2C%0A%2Elist%2Dgroup%2Ditem%2Edisabled%3Ahover%2C%0A%2Elist%2Dgroup%2Ditem%2Edisabled%3Afocus%20%7B%0Abackground%2Dcolor%3A%20%23eeeeee%3B%0Acolor%3A%20%23777777%3B%0Acursor%3A%20not%2Dallowed%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Edisabled%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0A%2Elist%2Dgroup%2Ditem%2Edisabled%3Ahover%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0A%2Elist%2Dgroup%2Ditem%2Edisabled%3Afocus%20%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Edisabled%20%2Elist%2Dgroup%2Ditem%2Dtext%2C%0A%2Elist%2Dgroup%2Ditem%2Edisabled%3Ahover%20%2Elist%2Dgroup%2Ditem%2Dtext%2C%0A%2Elist%2Dgroup%2Ditem%2Edisabled%3Afocus%20%2Elist%2Dgroup%2Ditem%2Dtext%20%7B%0Acolor%3A%20%23777777%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Eactive%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Ahover%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Afocus%20%7B%0Az%2Dindex%3A%202%3B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0Aborder%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Eactive%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Ahover%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Afocus%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%20%2Elist%2Dgroup%2Ditem%2Dheading%20%3E%20small%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Ahover%20%2Elist%2Dgroup%2Ditem%2Dheading%20%3E%20small%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Afocus%20%2Elist%2Dgroup%2Ditem%2Dheading%20%3E%20small%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%20%2Elist%2Dgroup%2Ditem%2Dheading%20%3E%20%2Esmall%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Ahover%20%2Elist%2Dgroup%2Ditem%2Dheading%20%3E%20%2Esmall%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Afocus%20%2Elist%2Dgroup%2Ditem%2Dheading%20%3E%20%2Esmall%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Eactive%20%2Elist%2Dgroup%2Ditem%2Dtext%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Ahover%20%2Elist%2Dgroup%2Ditem%2Dtext%2C%0A%2Elist%2Dgroup%2Ditem%2Eactive%3Afocus%20%2Elist%2Dgroup%2Ditem%2Dtext%20%7B%0Acolor%3A%20%23c7ddef%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Dsuccess%20%7B%0Acolor%3A%20%233c763d%3B%0Abackground%2Dcolor%3A%20%23dff0d8%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%20%7B%0Acolor%3A%20%233c763d%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%20%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%3Afocus%20%7B%0Acolor%3A%20%233c763d%3B%0Abackground%2Dcolor%3A%20%23d0e9c6%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%2Eactive%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%2Eactive%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%2Eactive%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%2Eactive%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dsuccess%2Eactive%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dsuccess%2Eactive%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%233c763d%3B%0Aborder%2Dcolor%3A%20%233c763d%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Dinfo%20%7B%0Acolor%3A%20%2331708f%3B%0Abackground%2Dcolor%3A%20%23d9edf7%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%20%7B%0Acolor%3A%20%2331708f%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%20%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%3Afocus%20%7B%0Acolor%3A%20%2331708f%3B%0Abackground%2Dcolor%3A%20%23c4e3f3%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%2Eactive%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%2Eactive%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%2Eactive%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%2Eactive%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dinfo%2Eactive%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dinfo%2Eactive%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%2331708f%3B%0Aborder%2Dcolor%3A%20%2331708f%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Dwarning%20%7B%0Acolor%3A%20%238a6d3b%3B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%20%7B%0Acolor%3A%20%238a6d3b%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%20%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%3Afocus%20%7B%0Acolor%3A%20%238a6d3b%3B%0Abackground%2Dcolor%3A%20%23faf2cc%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%2Eactive%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%2Eactive%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%2Eactive%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%2Eactive%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Dwarning%2Eactive%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Dwarning%2Eactive%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%238a6d3b%3B%0Aborder%2Dcolor%3A%20%238a6d3b%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Ddanger%20%7B%0Acolor%3A%20%23a94442%3B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%20%7B%0Acolor%3A%20%23a94442%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%20%2Elist%2Dgroup%2Ditem%2Dheading%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%20%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%3Afocus%20%7B%0Acolor%3A%20%23a94442%3B%0Abackground%2Dcolor%3A%20%23ebcccc%3B%0A%7D%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%2Eactive%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%2Eactive%2C%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%2Eactive%3Ahover%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%2Eactive%3Ahover%2C%0Aa%2Elist%2Dgroup%2Ditem%2Ddanger%2Eactive%3Afocus%2C%0Abutton%2Elist%2Dgroup%2Ditem%2Ddanger%2Eactive%3Afocus%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23a94442%3B%0Aborder%2Dcolor%3A%20%23a94442%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Dheading%20%7B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%2Elist%2Dgroup%2Ditem%2Dtext%20%7B%0Amargin%2Dbottom%3A%200%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%2Epanel%20%7B%0Amargin%2Dbottom%3A%2035px%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0Aborder%3A%201px%20solid%20transparent%3B%0Aborder%2Dradius%3A%200px%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E05%29%3B%0Abox%2Dshadow%3A%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E05%29%3B%0A%7D%0A%2Epanel%2Dbody%20%7B%0Apadding%3A%2015px%3B%0A%7D%0A%2Epanel%2Dheading%20%7B%0Apadding%3A%2010px%2015px%3B%0Aborder%2Dbottom%3A%201px%20solid%20transparent%3B%0Aborder%2Dtop%2Dright%2Dradius%3A%20%2D1px%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%2Dheading%20%3E%20%2Edropdown%20%2Edropdown%2Dtoggle%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Epanel%2Dtitle%20%7B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dbottom%3A%200%3B%0Afont%2Dsize%3A%2023px%3B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Epanel%2Dtitle%20%3E%20a%2C%0A%2Epanel%2Dtitle%20%3E%20small%2C%0A%2Epanel%2Dtitle%20%3E%20%2Esmall%2C%0A%2Epanel%2Dtitle%20%3E%20small%20%3E%20a%2C%0A%2Epanel%2Dtitle%20%3E%20%2Esmall%20%3E%20a%20%7B%0Acolor%3A%20inherit%3B%0A%7D%0A%2Epanel%2Dfooter%20%7B%0Apadding%3A%2010px%2015px%3B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dbottom%2Dright%2Dradius%3A%20%2D1px%3B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Elist%2Dgroup%2C%0A%2Epanel%20%3E%20%2Epanel%2Dcollapse%20%3E%20%2Elist%2Dgroup%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Elist%2Dgroup%20%2Elist%2Dgroup%2Ditem%2C%0A%2Epanel%20%3E%20%2Epanel%2Dcollapse%20%3E%20%2Elist%2Dgroup%20%2Elist%2Dgroup%2Ditem%20%7B%0Aborder%2Dwidth%3A%201px%200%3B%0Aborder%2Dradius%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Elist%2Dgroup%3Afirst%2Dchild%20%2Elist%2Dgroup%2Ditem%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Epanel%2Dcollapse%20%3E%20%2Elist%2Dgroup%3Afirst%2Dchild%20%2Elist%2Dgroup%2Ditem%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%3A%200%3B%0Aborder%2Dtop%2Dright%2Dradius%3A%20%2D1px%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Elist%2Dgroup%3Alast%2Dchild%20%2Elist%2Dgroup%2Ditem%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Epanel%2Dcollapse%20%3E%20%2Elist%2Dgroup%3Alast%2Dchild%20%2Elist%2Dgroup%2Ditem%3Alast%2Dchild%20%7B%0Aborder%2Dbottom%3A%200%3B%0Aborder%2Dbottom%2Dright%2Dradius%3A%20%2D1px%3B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Elist%2Dgroup%20%2Elist%2Dgroup%2Ditem%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%2Dright%2Dradius%3A%200%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%200%3B%0A%7D%0A%2Epanel%2Dheading%20%2B%20%2Elist%2Dgroup%20%2Elist%2Dgroup%2Ditem%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%2Dwidth%3A%200%3B%0A%7D%0A%2Elist%2Dgroup%20%2B%20%2Epanel%2Dfooter%20%7B%0Aborder%2Dtop%2Dwidth%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2C%0A%2Epanel%20%3E%20%2Epanel%2Dcollapse%20%3E%20%2Etable%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%20caption%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%20caption%2C%0A%2Epanel%20%3E%20%2Epanel%2Dcollapse%20%3E%20%2Etable%20caption%20%7B%0Apadding%2Dleft%3A%2015px%3B%0Apadding%2Dright%3A%2015px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%2Dright%2Dradius%3A%20%2D1px%3B%0Aborder%2Dtop%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%2Dleft%2Dradius%3A%20%2D1px%3B%0Aborder%2Dtop%2Dright%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Afirst%2Dchild%20%7B%0Aborder%2Dtop%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Afirst%2Dchild%20%3E%20%2Etable%3Afirst%2Dchild%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%3Alast%2Dchild%20%7B%0Aborder%2Dtop%2Dright%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%7B%0Aborder%2Dbottom%2Dright%2Dradius%3A%20%2D1px%3B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20%7B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%20%2D1px%3B%0Aborder%2Dbottom%2Dright%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Afirst%2Dchild%20%7B%0Aborder%2Dbottom%2Dleft%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tbody%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%3Alast%2Dchild%20%3E%20%2Etable%3Alast%2Dchild%20%3E%20tfoot%3Alast%2Dchild%20%3E%20tr%3Alast%2Dchild%20th%3Alast%2Dchild%20%7B%0Aborder%2Dbottom%2Dright%2Dradius%3A%20%2D1px%3B%0A%7D%0A%2Epanel%20%3E%20%2Epanel%2Dbody%20%2B%20%2Etable%2C%0A%2Epanel%20%3E%20%2Epanel%2Dbody%20%2B%20%2Etable%2Dresponsive%2C%0A%2Epanel%20%3E%20%2Etable%20%2B%20%2Epanel%2Dbody%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%2B%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20th%2C%0A%2Epanel%20%3E%20%2Etable%20%3E%20tbody%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20td%20%7B%0Aborder%2Dtop%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2Dbordered%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%7B%0Aborder%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%20%7B%0Aborder%2Dleft%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Alast%2Dchild%20%7B%0Aborder%2Dright%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%20%7B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20td%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0A%2Epanel%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20th%20%7B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%2Epanel%20%3E%20%2Etable%2Dresponsive%20%7B%0Aborder%3A%200%3B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Epanel%2Dgroup%20%7B%0Amargin%2Dbottom%3A%2035px%3B%0A%7D%0A%2Epanel%2Dgroup%20%2Epanel%20%7B%0Amargin%2Dbottom%3A%200%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Epanel%2Dgroup%20%2Epanel%20%2B%20%2Epanel%20%7B%0Amargin%2Dtop%3A%205px%3B%0A%7D%0A%2Epanel%2Dgroup%20%2Epanel%2Dheading%20%7B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%2Epanel%2Dgroup%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%2C%0A%2Epanel%2Dgroup%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Elist%2Dgroup%20%7B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Epanel%2Dgroup%20%2Epanel%2Dfooter%20%7B%0Aborder%2Dtop%3A%200%3B%0A%7D%0A%2Epanel%2Dgroup%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%2Epanel%2Ddefault%20%7B%0Aborder%2Dcolor%3A%20%23ddd%3B%0A%7D%0A%2Epanel%2Ddefault%20%3E%20%2Epanel%2Dheading%20%7B%0Acolor%3A%20%23333333%3B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0Aborder%2Dcolor%3A%20%23ddd%3B%0A%7D%0A%2Epanel%2Ddefault%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23ddd%3B%0A%7D%0A%2Epanel%2Ddefault%20%3E%20%2Epanel%2Dheading%20%2Ebadge%20%7B%0Acolor%3A%20%23f5f5f5%3B%0Abackground%2Dcolor%3A%20%23333333%3B%0A%7D%0A%2Epanel%2Ddefault%20%3E%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23ddd%3B%0A%7D%0A%2Epanel%2Dprimary%20%7B%0Aborder%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Epanel%2Dprimary%20%3E%20%2Epanel%2Dheading%20%7B%0Acolor%3A%20%23fff%3B%0Abackground%2Dcolor%3A%20%23337ab7%3B%0Aborder%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Epanel%2Dprimary%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Epanel%2Dprimary%20%3E%20%2Epanel%2Dheading%20%2Ebadge%20%7B%0Acolor%3A%20%23337ab7%3B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Epanel%2Dprimary%20%3E%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23337ab7%3B%0A%7D%0A%2Epanel%2Dsuccess%20%7B%0Aborder%2Dcolor%3A%20%23d6e9c6%3B%0A%7D%0A%2Epanel%2Dsuccess%20%3E%20%2Epanel%2Dheading%20%7B%0Acolor%3A%20%233c763d%3B%0Abackground%2Dcolor%3A%20%23dff0d8%3B%0Aborder%2Dcolor%3A%20%23d6e9c6%3B%0A%7D%0A%2Epanel%2Dsuccess%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23d6e9c6%3B%0A%7D%0A%2Epanel%2Dsuccess%20%3E%20%2Epanel%2Dheading%20%2Ebadge%20%7B%0Acolor%3A%20%23dff0d8%3B%0Abackground%2Dcolor%3A%20%233c763d%3B%0A%7D%0A%2Epanel%2Dsuccess%20%3E%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23d6e9c6%3B%0A%7D%0A%2Epanel%2Dinfo%20%7B%0Aborder%2Dcolor%3A%20%23bce8f1%3B%0A%7D%0A%2Epanel%2Dinfo%20%3E%20%2Epanel%2Dheading%20%7B%0Acolor%3A%20%2331708f%3B%0Abackground%2Dcolor%3A%20%23d9edf7%3B%0Aborder%2Dcolor%3A%20%23bce8f1%3B%0A%7D%0A%2Epanel%2Dinfo%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23bce8f1%3B%0A%7D%0A%2Epanel%2Dinfo%20%3E%20%2Epanel%2Dheading%20%2Ebadge%20%7B%0Acolor%3A%20%23d9edf7%3B%0Abackground%2Dcolor%3A%20%2331708f%3B%0A%7D%0A%2Epanel%2Dinfo%20%3E%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23bce8f1%3B%0A%7D%0A%2Epanel%2Dwarning%20%7B%0Aborder%2Dcolor%3A%20%23faebcc%3B%0A%7D%0A%2Epanel%2Dwarning%20%3E%20%2Epanel%2Dheading%20%7B%0Acolor%3A%20%238a6d3b%3B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0Aborder%2Dcolor%3A%20%23faebcc%3B%0A%7D%0A%2Epanel%2Dwarning%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23faebcc%3B%0A%7D%0A%2Epanel%2Dwarning%20%3E%20%2Epanel%2Dheading%20%2Ebadge%20%7B%0Acolor%3A%20%23fcf8e3%3B%0Abackground%2Dcolor%3A%20%238a6d3b%3B%0A%7D%0A%2Epanel%2Dwarning%20%3E%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23faebcc%3B%0A%7D%0A%2Epanel%2Ddanger%20%7B%0Aborder%2Dcolor%3A%20%23ebccd1%3B%0A%7D%0A%2Epanel%2Ddanger%20%3E%20%2Epanel%2Dheading%20%7B%0Acolor%3A%20%23a94442%3B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0Aborder%2Dcolor%3A%20%23ebccd1%3B%0A%7D%0A%2Epanel%2Ddanger%20%3E%20%2Epanel%2Dheading%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dtop%2Dcolor%3A%20%23ebccd1%3B%0A%7D%0A%2Epanel%2Ddanger%20%3E%20%2Epanel%2Dheading%20%2Ebadge%20%7B%0Acolor%3A%20%23f2dede%3B%0Abackground%2Dcolor%3A%20%23a94442%3B%0A%7D%0A%2Epanel%2Ddanger%20%3E%20%2Epanel%2Dfooter%20%2B%20%2Epanel%2Dcollapse%20%3E%20%2Epanel%2Dbody%20%7B%0Aborder%2Dbottom%2Dcolor%3A%20%23ebccd1%3B%0A%7D%0A%2Ewell%20%7B%0Amin%2Dheight%3A%2020px%3B%0Apadding%3A%2019px%3B%0Amargin%2Dbottom%3A%2020px%3B%0Abackground%2Dcolor%3A%20%23f5f5f5%3B%0Aborder%3A%201px%20solid%20%23e3e3e3%3B%0Aborder%2Dradius%3A%200px%3B%0A%2Dwebkit%2Dbox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E05%29%3B%0Abox%2Dshadow%3A%20inset%200%201px%201px%20rgba%280%2C%200%2C%200%2C%200%2E05%29%3B%0A%7D%0A%2Ewell%20blockquote%20%7B%0Aborder%2Dcolor%3A%20%23ddd%3B%0Aborder%2Dcolor%3A%20rgba%280%2C%200%2C%200%2C%200%2E15%29%3B%0A%7D%0A%2Ewell%2Dlg%20%7B%0Apadding%3A%2024px%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Ewell%2Dsm%20%7B%0Apadding%3A%209px%3B%0Aborder%2Dradius%3A%200px%3B%0A%7D%0A%2Eclose%20%7B%0Afloat%3A%20right%3B%0Afont%2Dsize%3A%2030px%3B%0Afont%2Dweight%3A%20bold%3B%0Aline%2Dheight%3A%201%3B%0Acolor%3A%20%23000%3B%0Atext%2Dshadow%3A%200%201px%200%20%23fff%3B%0Aopacity%3A%200%2E2%3B%0Afilter%3A%20alpha%28opacity%3D20%29%3B%0A%7D%0A%2Eclose%3Ahover%2C%0A%2Eclose%3Afocus%20%7B%0Acolor%3A%20%23000%3B%0Atext%2Ddecoration%3A%20none%3B%0Acursor%3A%20pointer%3B%0Aopacity%3A%200%2E5%3B%0Afilter%3A%20alpha%28opacity%3D50%29%3B%0A%7D%0Abutton%2Eclose%20%7B%0Apadding%3A%200%3B%0Acursor%3A%20pointer%3B%0Abackground%3A%20transparent%3B%0Aborder%3A%200%3B%0A%2Dwebkit%2Dappearance%3A%20none%3B%0A%7D%0A%2Eclearfix%3Abefore%2C%0A%2Eclearfix%3Aafter%2C%0A%2Edl%2Dhorizontal%20dd%3Abefore%2C%0A%2Edl%2Dhorizontal%20dd%3Aafter%2C%0A%2Econtainer%3Abefore%2C%0A%2Econtainer%3Aafter%2C%0A%2Econtainer%2Dfluid%3Abefore%2C%0A%2Econtainer%2Dfluid%3Aafter%2C%0A%2Erow%3Abefore%2C%0A%2Erow%3Aafter%2C%0A%2Eform%2Dhorizontal%20%2Eform%2Dgroup%3Abefore%2C%0A%2Eform%2Dhorizontal%20%2Eform%2Dgroup%3Aafter%2C%0A%2Enav%3Abefore%2C%0A%2Enav%3Aafter%2C%0A%2Enavbar%3Abefore%2C%0A%2Enavbar%3Aafter%2C%0A%2Enavbar%2Dheader%3Abefore%2C%0A%2Enavbar%2Dheader%3Aafter%2C%0A%2Enavbar%2Dcollapse%3Abefore%2C%0A%2Enavbar%2Dcollapse%3Aafter%2C%0A%2Epanel%2Dbody%3Abefore%2C%0A%2Epanel%2Dbody%3Aafter%20%7B%0Acontent%3A%20%22%20%22%3B%0Adisplay%3A%20table%3B%0A%7D%0A%2Eclearfix%3Aafter%2C%0A%2Edl%2Dhorizontal%20dd%3Aafter%2C%0A%2Econtainer%3Aafter%2C%0A%2Econtainer%2Dfluid%3Aafter%2C%0A%2Erow%3Aafter%2C%0A%2Eform%2Dhorizontal%20%2Eform%2Dgroup%3Aafter%2C%0A%2Enav%3Aafter%2C%0A%2Enavbar%3Aafter%2C%0A%2Enavbar%2Dheader%3Aafter%2C%0A%2Enavbar%2Dcollapse%3Aafter%2C%0A%2Epanel%2Dbody%3Aafter%20%7B%0Aclear%3A%20both%3B%0A%7D%0A%2Ecenter%2Dblock%20%7B%0Adisplay%3A%20block%3B%0Amargin%2Dleft%3A%20auto%3B%0Amargin%2Dright%3A%20auto%3B%0A%7D%0A%2Epull%2Dright%20%7B%0Afloat%3A%20right%20%21important%3B%0A%7D%0A%2Epull%2Dleft%20%7B%0Afloat%3A%20left%20%21important%3B%0A%7D%0A%2Ehide%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%2Eshow%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0A%2Einvisible%20%7B%0Avisibility%3A%20hidden%3B%0A%7D%0A%2Etext%2Dhide%20%7B%0Afont%3A%200%2F0%20a%3B%0Acolor%3A%20transparent%3B%0Atext%2Dshadow%3A%20none%3B%0Abackground%2Dcolor%3A%20transparent%3B%0Aborder%3A%200%3B%0A%7D%0A%2Ehidden%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%2Eaffix%20%7B%0Aposition%3A%20fixed%3B%0A%7D%0A%40%2Dms%2Dviewport%20%7B%0Awidth%3A%20device%2Dwidth%3B%0A%7D%0A%2Evisible%2Dxs%2C%0A%2Evisible%2Dsm%2C%0A%2Evisible%2Dmd%2C%0A%2Evisible%2Dlg%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%2Evisible%2Dxs%2Dblock%2C%0A%2Evisible%2Dxs%2Dinline%2C%0A%2Evisible%2Dxs%2Dinline%2Dblock%2C%0A%2Evisible%2Dsm%2Dblock%2C%0A%2Evisible%2Dsm%2Dinline%2C%0A%2Evisible%2Dsm%2Dinline%2Dblock%2C%0A%2Evisible%2Dmd%2Dblock%2C%0A%2Evisible%2Dmd%2Dinline%2C%0A%2Evisible%2Dmd%2Dinline%2Dblock%2C%0A%2Evisible%2Dlg%2Dblock%2C%0A%2Evisible%2Dlg%2Dinline%2C%0A%2Evisible%2Dlg%2Dinline%2Dblock%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Evisible%2Dxs%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0Atable%2Evisible%2Dxs%20%7B%0Adisplay%3A%20table%20%21important%3B%0A%7D%0Atr%2Evisible%2Dxs%20%7B%0Adisplay%3A%20table%2Drow%20%21important%3B%0A%7D%0Ath%2Evisible%2Dxs%2C%0Atd%2Evisible%2Dxs%20%7B%0Adisplay%3A%20table%2Dcell%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Evisible%2Dxs%2Dblock%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Evisible%2Dxs%2Dinline%20%7B%0Adisplay%3A%20inline%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Evisible%2Dxs%2Dinline%2Dblock%20%7B%0Adisplay%3A%20inline%2Dblock%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20and%20%28max%2Dwidth%3A%20991px%29%20%7B%0A%2Evisible%2Dsm%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0Atable%2Evisible%2Dsm%20%7B%0Adisplay%3A%20table%20%21important%3B%0A%7D%0Atr%2Evisible%2Dsm%20%7B%0Adisplay%3A%20table%2Drow%20%21important%3B%0A%7D%0Ath%2Evisible%2Dsm%2C%0Atd%2Evisible%2Dsm%20%7B%0Adisplay%3A%20table%2Dcell%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20and%20%28max%2Dwidth%3A%20991px%29%20%7B%0A%2Evisible%2Dsm%2Dblock%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20and%20%28max%2Dwidth%3A%20991px%29%20%7B%0A%2Evisible%2Dsm%2Dinline%20%7B%0Adisplay%3A%20inline%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20and%20%28max%2Dwidth%3A%20991px%29%20%7B%0A%2Evisible%2Dsm%2Dinline%2Dblock%20%7B%0Adisplay%3A%20inline%2Dblock%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20and%20%28max%2Dwidth%3A%201199px%29%20%7B%0A%2Evisible%2Dmd%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0Atable%2Evisible%2Dmd%20%7B%0Adisplay%3A%20table%20%21important%3B%0A%7D%0Atr%2Evisible%2Dmd%20%7B%0Adisplay%3A%20table%2Drow%20%21important%3B%0A%7D%0Ath%2Evisible%2Dmd%2C%0Atd%2Evisible%2Dmd%20%7B%0Adisplay%3A%20table%2Dcell%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20and%20%28max%2Dwidth%3A%201199px%29%20%7B%0A%2Evisible%2Dmd%2Dblock%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20and%20%28max%2Dwidth%3A%201199px%29%20%7B%0A%2Evisible%2Dmd%2Dinline%20%7B%0Adisplay%3A%20inline%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20and%20%28max%2Dwidth%3A%201199px%29%20%7B%0A%2Evisible%2Dmd%2Dinline%2Dblock%20%7B%0Adisplay%3A%20inline%2Dblock%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Evisible%2Dlg%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0Atable%2Evisible%2Dlg%20%7B%0Adisplay%3A%20table%20%21important%3B%0A%7D%0Atr%2Evisible%2Dlg%20%7B%0Adisplay%3A%20table%2Drow%20%21important%3B%0A%7D%0Ath%2Evisible%2Dlg%2C%0Atd%2Evisible%2Dlg%20%7B%0Adisplay%3A%20table%2Dcell%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Evisible%2Dlg%2Dblock%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Evisible%2Dlg%2Dinline%20%7B%0Adisplay%3A%20inline%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Evisible%2Dlg%2Dinline%2Dblock%20%7B%0Adisplay%3A%20inline%2Dblock%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28max%2Dwidth%3A%20767px%29%20%7B%0A%2Ehidden%2Dxs%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20768px%29%20and%20%28max%2Dwidth%3A%20991px%29%20%7B%0A%2Ehidden%2Dsm%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%20992px%29%20and%20%28max%2Dwidth%3A%201199px%29%20%7B%0A%2Ehidden%2Dmd%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%7D%0A%40media%20%28min%2Dwidth%3A%201200px%29%20%7B%0A%2Ehidden%2Dlg%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%7D%0A%2Evisible%2Dprint%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%40media%20print%20%7B%0A%2Evisible%2Dprint%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0Atable%2Evisible%2Dprint%20%7B%0Adisplay%3A%20table%20%21important%3B%0A%7D%0Atr%2Evisible%2Dprint%20%7B%0Adisplay%3A%20table%2Drow%20%21important%3B%0A%7D%0Ath%2Evisible%2Dprint%2C%0Atd%2Evisible%2Dprint%20%7B%0Adisplay%3A%20table%2Dcell%20%21important%3B%0A%7D%0A%7D%0A%2Evisible%2Dprint%2Dblock%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%40media%20print%20%7B%0A%2Evisible%2Dprint%2Dblock%20%7B%0Adisplay%3A%20block%20%21important%3B%0A%7D%0A%7D%0A%2Evisible%2Dprint%2Dinline%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%40media%20print%20%7B%0A%2Evisible%2Dprint%2Dinline%20%7B%0Adisplay%3A%20inline%20%21important%3B%0A%7D%0A%7D%0A%2Evisible%2Dprint%2Dinline%2Dblock%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%40media%20print%20%7B%0A%2Evisible%2Dprint%2Dinline%2Dblock%20%7B%0Adisplay%3A%20inline%2Dblock%20%21important%3B%0A%7D%0A%7D%0A%40media%20print%20%7B%0A%2Ehidden%2Dprint%20%7B%0Adisplay%3A%20none%20%21important%3B%0A%7D%0A%7D%0A%2Ehero%20%7B%0Aposition%3A%20relative%3B%0Acolor%3A%20white%3B%0Abackground%3A%20%232e5943%3B%0A%7D%0A%2Ehero%20%2Econtainer%20%7B%0Aposition%3A%20relative%3B%0Aheight%3A%2050vh%3B%0Amin%2Dheight%3A%20637%2E5px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%7B%0Aposition%3A%20absolute%3B%0Atop%3A%200%3B%0Aleft%3A%200%3B%0Aright%3A%200%3B%0Abottom%3A%2030px%3B%0Amargin%3A%20auto%3B%0Aheight%3A%20397%2E5px%3B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%2Etitle%20%7B%0Amargin%3A%200%200%2035px%3B%0Aline%2Dheight%3A%2070px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%2Etitle%2Ewith%2Dsubtitle%20%7B%0Amargin%2Dtop%3A%20%2D35px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%2Esubtitle%20%7B%0Adisplay%3A%20block%3B%0Afont%2Dsize%3A%2066%25%3B%0Aline%2Dheight%3A%2042px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%2Eauthor%20%7B%0Amargin%3A%200%200%2035px%3B%0Aline%2Dheight%3A%2052%2E5px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%2Edate%20%7B%0Amargin%3A%200%200%2070px%3B%0Aline%2Dheight%3A%2035px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%2Ebrand%2Dlogo%20%7B%0Adisplay%3A%20block%3B%0Aheight%3A%20100px%3B%0Amargin%3A%200%20auto%3B%0A%7D%0A%2Ehero%2Dleft%2Doverlay%2Dwhite%2C%0A%2Ehero%2Dleft%2Doverlay%2Dblack%2C%0A%2Ehero%2Dright%2Doverlay%2Dwhite%2C%0A%2Ehero%2Dright%2Doverlay%2Dblack%2C%0A%2Ehero%2Darrow%2Doverlay%2Dwhite%20%7B%0Aposition%3A%20absolute%3B%0Atop%3A%200%3B%0Aleft%3A%200%3B%0Aright%3A%200%3B%0Abottom%3A%200%3B%0Az%2Dindex%3A%201%3B%0Abackground%2Dsize%3A%20cover%3B%0Apointer%2Devents%3A%20none%3B%0A%7D%0A%2Ehero%2Dleft%2Doverlay%2Dwhite%20%7B%0Abackground%2Dimage%3A%20url%28%22data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJ5ZXMiPz4KPCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgNjAiPgogIDxwb2x5Z29uIGZpbGw9InJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKSIgcG9pbnRzPSIwLDAgMzAsMCAwLDE1IiAvPgogIDxwb2x5Z29uIGZpbGw9InJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKSIgcG9pbnRzPSIwLDAgMTUsMCAwLDEwMCIgLz4KPC9zdmc%2BCg%3D%3D%22%29%3B%0Abackground%2Dposition%3A%20left%20top%3B%0A%7D%0A%2Ehero%2Dright%2Doverlay%2Dwhite%20%7B%0Abackground%2Dimage%3A%20url%28%22data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJ5ZXMiPz4KPCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgNjAiPgogIDxwb2x5Z29uIGZpbGw9InJnYmEoMjU1LCAyNTUsIDI1NSwgMC4xKSIgcG9pbnRzPSI4MCwwIDEwMCwwIDEwMCw2MCIgLz4KICA8cG9seWdvbiBmaWxsPSJyZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSkiIHBvaW50cz0iMTAwLDQwIDEwMCw2MCA4MCw2MCIgLz4KPC9zdmc%2BCg%3D%3D%22%29%3B%0Abackground%2Dposition%3A%20right%20bottom%3B%0A%7D%0A%2Ehero%2Darrow%2Doverlay%2Dwhite%20%7B%0Atop%3A%20auto%3B%0Aheight%3A%2030px%3B%0Az%2Dindex%3A%202%3B%0Abackground%2Dimage%3A%20url%28%22data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJ5ZXMiPz4KPCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAwMCA0MCI%2BCiAgPHBvbHlnb24gZmlsbD0icmdiKDI1NSwgMjU1LCAyNTUpIiBwb2ludHM9IjAsMCA0OTcwLDAgNTAwMCwzMCA1MDMwLDAgMTAwMDAsMCAxMDAwMCw1MCAwLDUwIiAvPgo8L3N2Zz4K%22%29%3B%0Abackground%2Dposition%3A%20center%20bottom%3B%0A%7D%0A%2Ehero%2Doverlay%2Dsoft%20%7B%0Aopacity%3A%20%2E4%3B%0A%7D%0Anav%2Etoc%20%2Econtainer%20%7B%0Awidth%3A%20100%25%3B%0A%7D%0Anav%2Etoc%20h1%20%7B%0Amargin%2Dtop%3A%2035px%3B%0A%7D%0Anav%2Etoc%20%2Etoc%2Dcontents%20%7B%0Adisplay%3A%20none%3B%0Amargin%2Dtop%3A%201em%3B%0A%7D%0Anav%2Etoc%20%2Etoc%2Dcontents%20ul%20%7B%0Apadding%2Dleft%3A%200%3B%0Alist%2Dstyle%3A%20none%3B%0A%7D%0Anav%2Etoc%20%2Etoc%2Dcontents%20ul%20a%20%7B%0Adisplay%3A%20block%3B%0A%7D%0Anav%2Etoc%20%2Etoc%2Dcontents%20ul%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%2035px%3B%0Afont%2Dsize%3A%2024px%3B%0A%7D%0Anav%2Etoc%20%2Etoc%2Dcontents%20ul%20%3E%20li%20%3E%20ul%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%208%2E75px%3B%0Apadding%2Dbottom%3A%200px%3B%0Afont%2Dsize%3A%2020px%3B%0A%7D%0Anav%2Etoc%20%2Etoc%2Dtoggle%20%7B%0Amargin%2Dtop%3A%2017%2E5px%3B%0A%7D%0Aol%2Etoc%20%7B%0Apadding%2Dleft%3A%200%3B%0Alist%2Dstyle%3A%20none%3B%0A%7D%0Aol%2Etoc%20a%20%7B%0Adisplay%3A%20block%3B%0A%7D%0Aol%2Etoc%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%2035px%3B%0Afont%2Dsize%3A%2030px%3B%0A%7D%0Aol%2Etoc%20%3E%20li%20%3E%20ol%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%2035px%3B%0Apadding%2Dbottom%3A%2017%2E5px%3B%0Afont%2Dsize%3A%2024px%3B%0A%7D%0Aol%2Etoc%20%3E%20li%20%3E%20ol%20%3E%20li%20%3E%20ol%20%3E%20li%20%3E%20a%20%7B%0Apadding%2Dtop%3A%208%2E75px%3B%0Apadding%2Dbottom%3A%200%3B%0Afont%2Dsize%3A%2020px%3B%0A%7D%0A%40media%20screen%20%7B%0A%2Ehighlight%20%7B%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%7D%0A%2Ehighlight%20pre%20%7B%0Abackground%3A%20%23181818%3B%0Acolor%3A%20%23F8F8F8%3B%0Aborder%3A%20none%3B%0A%7D%0A%2Ehighlight%20code%20%2A%20%7B%0Afont%2Dfamily%3A%20Menlo%2C%20Monaco%2C%20Consolas%2C%20%22Lucida%20Console%22%2C%20%22Courier%20New%22%2C%20monospace%3B%0A%7D%0A%2Ehighlight%20code%20%2Ehll%20%7B%0Abackground%3A%20%23ffffcc%3B%0A%7D%0A%2Ehighlight%20code%20%2Ec%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Eerr%20%7B%0Aborder%3A%20%23B22518%3B%0A%7D%0A%2Ehighlight%20code%20%2Ek%20%7B%0Acolor%3A%20%23CDA869%3B%0A%7D%0A%2Ehighlight%20code%20%2Ecm%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Ecp%20%7B%0Acolor%3A%20%235F5A60%3B%0A%7D%0A%2Ehighlight%20code%20%2Ec1%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Ecs%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Egd%20%7B%0Abackground%3A%20%23420E09%3B%0A%7D%0A%2Ehighlight%20code%20%2Ege%20%7B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Egr%20%7B%0Abackground%3A%20%23B22518%3B%0A%7D%0A%2Ehighlight%20code%20%2Egh%20%7B%0Acolor%3A%20%23000080%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Egi%20%7B%0Abackground%3A%20%23253B22%3B%0A%7D%0A%2Ehighlight%20code%20%2Egp%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Egs%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Egu%20%7B%0Acolor%3A%20%23800080%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Ekd%20%7B%0Acolor%3A%20%23e9df8f%3B%0A%7D%0A%2Ehighlight%20code%20%2Ekp%20%7B%0Acolor%3A%20%239B703F%3B%0A%7D%0A%2Ehighlight%20code%20%2Es%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Ena%20%7B%0Acolor%3A%20%23F9EE98%3B%0A%7D%0A%2Ehighlight%20code%20%2Enb%20%7B%0Acolor%3A%20%23CDA869%3B%0A%7D%0A%2Ehighlight%20code%20%2Enc%20%7B%0Acolor%3A%20%239B859D%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Eno%20%7B%0Acolor%3A%20%239B859D%3B%0A%7D%0A%2Ehighlight%20code%20%2End%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Eni%20%7B%0Acolor%3A%20%23CF6A4C%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Enf%20%7B%0Acolor%3A%20%239B703F%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Enn%20%7B%0Acolor%3A%20%239B859D%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Ent%20%7B%0Acolor%3A%20%23CDA869%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Env%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Eow%20%7B%0Acolor%3A%20%23AA22FF%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Ew%20%7B%0Acolor%3A%20%23141414%3B%0A%7D%0A%2Ehighlight%20code%20%2Emf%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Emh%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Emi%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Emo%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Esb%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esc%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esd%20%7B%0Acolor%3A%20%238F9D6A%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Es2%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Ese%20%7B%0Acolor%3A%20%23F9EE98%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Esh%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esi%20%7B%0Acolor%3A%20%23DAEFA3%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Esx%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esr%20%7B%0Acolor%3A%20%23E9C062%3B%0A%7D%0A%2Ehighlight%20code%20%2Es1%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Ess%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Ebp%20%7B%0Acolor%3A%20%2300aaaa%3B%0A%7D%0A%2Ehighlight%20code%20%2Evc%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Evg%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Evi%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Eil%20%7B%0Acolor%3A%20%23009999%3B%0A%7D%0A%7D%0A%40media%20print%20%7B%0A%2Ehighlight%20%7B%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A%7D%0A%2Ehighlight%20pre%20%7B%0Abackground%3A%20%23181818%3B%0Acolor%3A%20%23F8F8F8%3B%0Aborder%3A%20none%3B%0A%7D%0A%2Ehighlight%20code%20%2A%20%7B%0Afont%2Dfamily%3A%20Menlo%2C%20Monaco%2C%20Consolas%2C%20%22Lucida%20Console%22%2C%20%22Courier%20New%22%2C%20monospace%3B%0A%7D%0A%2Ehighlight%20code%20%2Ehll%20%7B%0Abackground%3A%20%23ffffcc%3B%0A%7D%0A%2Ehighlight%20code%20%2Ec%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Eerr%20%7B%0Aborder%3A%20%23B22518%3B%0A%7D%0A%2Ehighlight%20code%20%2Ek%20%7B%0Acolor%3A%20%23CDA869%3B%0A%7D%0A%2Ehighlight%20code%20%2Ecm%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Ecp%20%7B%0Acolor%3A%20%235F5A60%3B%0A%7D%0A%2Ehighlight%20code%20%2Ec1%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Ecs%20%7B%0Acolor%3A%20%235F5A60%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Egd%20%7B%0Abackground%3A%20%23420E09%3B%0A%7D%0A%2Ehighlight%20code%20%2Ege%20%7B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Egr%20%7B%0Abackground%3A%20%23B22518%3B%0A%7D%0A%2Ehighlight%20code%20%2Egh%20%7B%0Acolor%3A%20%23000080%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Egi%20%7B%0Abackground%3A%20%23253B22%3B%0A%7D%0A%2Ehighlight%20code%20%2Egp%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Egs%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Egu%20%7B%0Acolor%3A%20%23800080%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Ekd%20%7B%0Acolor%3A%20%23e9df8f%3B%0A%7D%0A%2Ehighlight%20code%20%2Ekp%20%7B%0Acolor%3A%20%239B703F%3B%0A%7D%0A%2Ehighlight%20code%20%2Es%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Ena%20%7B%0Acolor%3A%20%23F9EE98%3B%0A%7D%0A%2Ehighlight%20code%20%2Enb%20%7B%0Acolor%3A%20%23CDA869%3B%0A%7D%0A%2Ehighlight%20code%20%2Enc%20%7B%0Acolor%3A%20%239B859D%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Eno%20%7B%0Acolor%3A%20%239B859D%3B%0A%7D%0A%2Ehighlight%20code%20%2End%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Eni%20%7B%0Acolor%3A%20%23CF6A4C%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Enf%20%7B%0Acolor%3A%20%239B703F%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Enn%20%7B%0Acolor%3A%20%239B859D%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Ent%20%7B%0Acolor%3A%20%23CDA869%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Env%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Eow%20%7B%0Acolor%3A%20%23AA22FF%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Ew%20%7B%0Acolor%3A%20%23141414%3B%0A%7D%0A%2Ehighlight%20code%20%2Emf%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Emh%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Emi%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Emo%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Esb%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esc%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esd%20%7B%0Acolor%3A%20%238F9D6A%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0A%2Ehighlight%20code%20%2Es2%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Ese%20%7B%0Acolor%3A%20%23F9EE98%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Esh%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esi%20%7B%0Acolor%3A%20%23DAEFA3%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0A%2Ehighlight%20code%20%2Esx%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Esr%20%7B%0Acolor%3A%20%23E9C062%3B%0A%7D%0A%2Ehighlight%20code%20%2Es1%20%7B%0Acolor%3A%20%238F9D6A%3B%0A%7D%0A%2Ehighlight%20code%20%2Ess%20%7B%0Acolor%3A%20%23CF6A4C%3B%0A%7D%0A%2Ehighlight%20code%20%2Ebp%20%7B%0Acolor%3A%20%2300aaaa%3B%0A%7D%0A%2Ehighlight%20code%20%2Evc%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Evg%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Evi%20%7B%0Acolor%3A%20%237587A6%3B%0A%7D%0A%2Ehighlight%20code%20%2Eil%20%7B%0Acolor%3A%20%23009999%3B%0A%7D%0A%7D%0A%2Ecallout%20%7B%0Amargin%3A%2020px%200%3B%0Apadding%3A%2015px%2030px%2015px%2015px%3B%0Aborder%2Dleft%3A%205px%20solid%20%23eee%3B%0A%7D%0A%2Ecallout%20p%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0A%2Ecallout%20%2Ehighlight%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0A%2Ecallout%2Ecallout%2Dinfo%20%7B%0Abackground%2Dcolor%3A%20%23d9edf7%3B%0Aborder%2Dcolor%3A%20%23bce8f1%3B%0A%7D%0A%2Ecallout%2Ecallout%2Dwarning%20%7B%0Abackground%2Dcolor%3A%20%23fcf8e3%3B%0Aborder%2Dcolor%3A%20%23faebcc%3B%0A%7D%0A%2Ecallout%2Ecallout%2Ddanger%20%7B%0Abackground%2Dcolor%3A%20%23f2dede%3B%0Aborder%2Dcolor%3A%20%23ebccd1%3B%0A%7D%0Aol%20%7B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0Aol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Dalpha%3B%0A%7D%0Aol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Droman%3B%0A%7D%0Aol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Dalpha%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Droman%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Dalpha%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Droman%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Dalpha%3B%0A%7D%0Aol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20ol%20%7B%0Alist%2Dstyle%2Dtype%3A%20lower%2Droman%3B%0A%7D%0A%2Ebtn%20%7B%0Aborder%3A%20none%20%21important%3B%0A%7D%0A%2Ebtn%2Ebtn%2Ddefault%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23eaeaea%3B%0A%7D%0A%2Ebtn%2Ebtn%2Ddefault%3Ahover%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23dddddd%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dprimary%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%232e6da4%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dprimary%3Ahover%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23286090%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dsuccess%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%234cae4c%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dsuccess%3Ahover%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23449d44%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dinfo%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%2346b8da%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dinfo%3Ahover%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%2331b0d5%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dwarning%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23eea236%3B%0A%7D%0A%2Ebtn%2Ebtn%2Dwarning%3Ahover%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23ec971f%3B%0A%7D%0A%2Ebtn%2Ebtn%2Ddanger%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23d43f3a%3B%0A%7D%0A%2Ebtn%2Ebtn%2Ddanger%3Ahover%20%7B%0Abox%2Dshadow%3A%200%204px%200%20%23c9302c%3B%0A%7D%0Aarticle%20img%20%7B%0Adisplay%3A%20block%3B%0Amargin%2Dleft%3A%20auto%3B%0Amargin%2Dright%3A%20auto%3B%0Amax%2Dwidth%3A%20100%25%3B%0A%7D%0Aarticle%20%2Efigure%20%2Ecaption%2C%0Aarticle%20%2Esolution%20%2Ecaption%20%7B%0Atext%2Dalign%3A%20center%3B%0Acolor%3A%20%23777777%3B%0A%7D%0Atable%20%7B%0Awidth%3A%20100%25%3B%0Amax%2Dwidth%3A%20100%25%3B%0Amargin%2Dbottom%3A%2035px%3B%0Aborder%3A%201px%20solid%20%23ddd%3B%0Aoverflow%2Dx%3A%20auto%3B%0Amin%2Dheight%3A%200%2E01%25%3B%0A%7D%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0Atable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0Atable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Apadding%3A%208px%3B%0Aline%2Dheight%3A%201%2E75%3B%0Avertical%2Dalign%3A%20top%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0A%7D%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20th%20%7B%0Avertical%2Dalign%3A%20bottom%3B%0Aborder%2Dbottom%3A%202px%20solid%20%23ddd%3B%0A%7D%0Atable%20%3E%20caption%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0Atable%20%3E%20colgroup%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0Atable%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20%3E%20th%2C%0Atable%20%3E%20caption%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0Atable%20%3E%20colgroup%20%2B%20thead%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%2C%0Atable%20%3E%20thead%3Afirst%2Dchild%20%3E%20tr%3Afirst%2Dchild%20%3E%20td%20%7B%0Aborder%2Dtop%3A%200%3B%0A%7D%0Atable%20%3E%20tbody%20%2B%20tbody%20%7B%0Aborder%2Dtop%3A%202px%20solid%20%23ddd%3B%0A%7D%0Atable%20%2Etable%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0A%7D%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0Atable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0Atable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20thead%20%3E%20tr%20%3E%20td%20%7B%0Aborder%2Dbottom%2Dwidth%3A%202px%3B%0A%7D%0Atable%20%3E%20tbody%20%3E%20tr%3Anth%2Dof%2Dtype%28odd%29%20%7B%0Abackground%2Dcolor%3A%20%23f9f9f9%3B%0A%7D%0A%40media%20screen%20and%20%28max%2Dwidth%3A%20767px%29%20%7B%0Atable%20%7B%0Awidth%3A%20100%25%3B%0Amargin%2Dbottom%3A%2026%2E25px%3B%0Aoverflow%2Dy%3A%20hidden%3B%0A%2Dms%2Doverflow%2Dstyle%3A%20%2Dms%2Dautohiding%2Dscrollbar%3B%0Aborder%3A%201px%20solid%20%23ddd%3B%0A%7D%0Atable%20%3E%20%2Etable%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Atable%20%3E%20%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20th%2C%0Atable%20%3E%20%2Etable%20%3E%20thead%20%3E%20tr%20%3E%20td%2C%0Atable%20%3E%20%2Etable%20%3E%20tbody%20%3E%20tr%20%3E%20td%2C%0Atable%20%3E%20%2Etable%20%3E%20tfoot%20%3E%20tr%20%3E%20td%20%7B%0Awhite%2Dspace%3A%20nowrap%3B%0A%7D%0Atable%20%3E%20%2Etable%2Dbordered%20%7B%0Aborder%3A%200%3B%0A%7D%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Afirst%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Afirst%2Dchild%20%7B%0Aborder%2Dleft%3A%200%3B%0A%7D%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20th%3Alast%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20thead%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%20%3E%20td%3Alast%2Dchild%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%20%3E%20td%3Alast%2Dchild%20%7B%0Aborder%2Dright%3A%200%3B%0A%7D%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20th%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tbody%20%3E%20tr%3Alast%2Dchild%20%3E%20td%2C%0Atable%20%3E%20%2Etable%2Dbordered%20%3E%20tfoot%20%3E%20tr%3Alast%2Dchild%20%3E%20td%20%7B%0Aborder%2Dbottom%3A%200%3B%0A%7D%0A%7D%0Aa%20code%20%7B%0Acolor%3A%20%23337ab7%3B%0A%7D%0Afooter%20%7B%0Amargin%2Dtop%3A%2035px%3B%0Apadding%3A%2035px%200%3B%0Abackground%3A%20%235bc0de%3B%0Acolor%3A%20%23fff%3B%0A%7D%0Afooter%20a%20%7B%0Acolor%3A%20%23fff%3B%0A%7D%0Afooter%20h1%2C%0Afooter%20h2%2C%0Afooter%20h3%2C%0Afooter%20h4%2C%0Afooter%20h5%2C%0Afooter%20h6%20%7B%0Acolor%3A%20%23fff%3B%0A%7D%0Afooter%20%2Efooter%2Dbrand%20%7B%0Amargin%3A%200%3B%0A%7D%0Afooter%20%2Esitemap%20%7B%0Amargin%3A%200%200%2035px%3B%0Afont%2Dsize%3A%20%2E9em%3B%0A%7D%0Afooter%20%2Esitemap%20ul%20%7B%0Amargin%3A%200%3B%0A%7D%0Afooter%20%2Esitemap%20li%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Afooter%20%2Esitemap%20h5%20%7B%0Amargin%2Dtop%3A%2035px%3B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Afooter%20%2Esitemap%20h5%20a%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Afooter%20%2Esitemap%20a%20%7B%0Adisplay%3A%20block%3B%0Aoverflow%3A%20hidden%3B%0Atext%2Doverflow%3A%20ellipsis%3B%0Awhite%2Dspace%3A%20nowrap%3B%0Acolor%3A%20%23fff%3B%0Afont%2Dweight%3A%20200%3B%0A%7D%0Afooter%20%2Ecopyright%20%7B%0Amargin%3A%200%200%2035px%3B%0Afont%2Dsize%3A%20%2E8em%3B%0Afont%2Dweight%3A%20200%3B%0A%7D%0A%2Ehero%20%7B%0Aheight%3A%20auto%3B%0A%7D%0A%2Ehero%20%2Econtainer%20%7B%0Aheight%3A%20auto%3B%0Amin%2Dheight%3A%20400px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20%7B%0Atop%3A%20auto%3B%0Aheight%3A%20auto%3B%0Abottom%3A%200%3B%0Apadding%2Dtop%3A%200%3B%0Apadding%2Dbottom%3A%2060px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20h1%2Etitle%20%7B%0Amargin%2Dbottom%3A%200%3B%0Afont%2Dsize%3A%2036px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20h3%2Eauthor%20%7B%0Amargin%2Dbottom%3A%2010px%3B%0Afont%2Dsize%3A%2030px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20p%2Edate%20%7B%0Amargin%2Dbottom%3A%2030px%3B%0A%7D%0A%2Ehero%20%2Ehero%2Dtext%20img%2Ebrand%2Dlogo%20%7B%0Aheight%3A%2080px%3B%0A%7D%0Afooter%20%7B%0Abackground%3A%20%232e5943%3B%0A%7D%0A" rel="stylesheet">
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>



<script src="data:application/x-javascript;base64,KGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpO3Rocm93IGYuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBMaWJyYXJ5IHYyLjEuMQogKiBodHRwOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqCiAqIENvcHlyaWdodCAyMDA1LCAyMDE0IGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAxNC0wNS0wMVQxNzoxMVoKICovCgooZnVuY3Rpb24oIGdsb2JhbCwgZmFjdG9yeSApIHsKCglpZiAoIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gIm9iamVjdCIgKSB7CgkJLy8gRm9yIENvbW1vbkpTIGFuZCBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB3aGVyZSBhIHByb3BlciB3aW5kb3cgaXMgcHJlc2VudCwKCQkvLyBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5CgkJLy8gRm9yIGVudmlyb25tZW50cyB0aGF0IGRvIG5vdCBpbmhlcmVudGx5IHBvc3NlcyBhIHdpbmRvdyB3aXRoIGEgZG9jdW1lbnQKCQkvLyAoc3VjaCBhcyBOb2RlLmpzKSwgZXhwb3NlIGEgalF1ZXJ5LW1ha2luZyBmYWN0b3J5IGFzIG1vZHVsZS5leHBvcnRzCgkJLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCB3aW5kb3cKCQkvLyBlLmcuIHZhciBqUXVlcnkgPSByZXF1aXJlKCJqcXVlcnkiKSh3aW5kb3cpOwoJCS8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8KCQltb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5kb2N1bWVudCA/CgkJCWZhY3RvcnkoIGdsb2JhbCwgdHJ1ZSApIDoKCQkJZnVuY3Rpb24oIHcgKSB7CgkJCQlpZiAoICF3LmRvY3VtZW50ICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggImpRdWVyeSByZXF1aXJlcyBhIHdpbmRvdyB3aXRoIGEgZG9jdW1lbnQiICk7CgkJCQl9CgkJCQlyZXR1cm4gZmFjdG9yeSggdyApOwoJCQl9OwoJfSBlbHNlIHsKCQlmYWN0b3J5KCBnbG9iYWwgKTsKCX0KCi8vIFBhc3MgdGhpcyBpZiB3aW5kb3cgaXMgbm90IGRlZmluZWQgeWV0Cn0odHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiggd2luZG93LCBub0dsb2JhbCApIHsKCi8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UKLy8gdGhlIHN0YWNrIHZpYSBhcmd1bWVudHMuY2FsbGVyLmNhbGxlZSBhbmQgRmlyZWZveCBkaWVzIGlmCi8vIHlvdSB0cnkgdG8gdHJhY2UgdGhyb3VnaCAidXNlIHN0cmljdCIgY2FsbCBjaGFpbnMuICgjMTMzMzUpCi8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrCi8vCgp2YXIgYXJyID0gW107Cgp2YXIgc2xpY2UgPSBhcnIuc2xpY2U7Cgp2YXIgY29uY2F0ID0gYXJyLmNvbmNhdDsKCnZhciBwdXNoID0gYXJyLnB1c2g7Cgp2YXIgaW5kZXhPZiA9IGFyci5pbmRleE9mOwoKdmFyIGNsYXNzMnR5cGUgPSB7fTsKCnZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7Cgp2YXIgaGFzT3duID0gY2xhc3MydHlwZS5oYXNPd25Qcm9wZXJ0eTsKCnZhciBzdXBwb3J0ID0ge307CgoKCnZhcgoJLy8gVXNlIHRoZSBjb3JyZWN0IGRvY3VtZW50IGFjY29yZGluZ2x5IHdpdGggd2luZG93IGFyZ3VtZW50IChzYW5kYm94KQoJZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCgoJdmVyc2lvbiA9ICIyLjEuMSIsCgoJLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKCWpRdWVyeSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCQkvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKCQkvLyBOZWVkIGluaXQgaWYgalF1ZXJ5IGlzIGNhbGxlZCAoanVzdCBhbGxvdyBlcnJvciB0byBiZSB0aHJvd24gaWYgbm90IGluY2x1ZGVkKQoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0ICk7Cgl9LAoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQ8NC4xCgkvLyBNYWtlIHN1cmUgd2UgdHJpbSBCT00gYW5kIE5CU1AKCXJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAoKCS8vIE1hdGNoZXMgZGFzaGVkIHN0cmluZyBmb3IgY2FtZWxpemluZwoJcm1zUHJlZml4ID0gL14tbXMtLywKCXJkYXNoQWxwaGEgPSAvLShbXGRhLXpdKS9naSwKCgkvLyBVc2VkIGJ5IGpRdWVyeS5jYW1lbENhc2UgYXMgY2FsbGJhY2sgdG8gcmVwbGFjZSgpCglmY2FtZWxDYXNlID0gZnVuY3Rpb24oIGFsbCwgbGV0dGVyICkgewoJCXJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsKCX07CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoJLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBqUXVlcnkgYmVpbmcgdXNlZAoJanF1ZXJ5OiB2ZXJzaW9uLAoKCWNvbnN0cnVjdG9yOiBqUXVlcnksCgoJLy8gU3RhcnQgd2l0aCBhbiBlbXB0eSBzZWxlY3RvcgoJc2VsZWN0b3I6ICIiLAoKCS8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMAoJbGVuZ3RoOiAwLAoKCXRvQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgkJcmV0dXJuIG51bSAhPSBudWxsID8KCgkJCS8vIFJldHVybiBqdXN0IHRoZSBvbmUgZWxlbWVudCBmcm9tIHRoZSBzZXQKCQkJKCBudW0gPCAwID8gdGhpc1sgbnVtICsgdGhpcy5sZW5ndGggXSA6IHRoaXNbIG51bSBdICkgOgoKCQkJLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgaW4gYSBjbGVhbiBhcnJheQoJCQlzbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCQlyZXQuY29udGV4dCA9IHRoaXMuY29udGV4dDsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgoJLy8gKFlvdSBjYW4gc2VlZCB0aGUgYXJndW1lbnRzIHdpdGggYW4gYXJyYXkgb2YgYXJncywgYnV0IHRoaXMgaXMKCS8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjaywgYXJncyApIHsKCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1hcCh0aGlzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuIGNhbGxiYWNrLmNhbGwoIGVsZW0sIGksIGVsZW0gKTsKCQl9KSk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNsaWNlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCWVxOiBmdW5jdGlvbiggaSApIHsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGgsCgkJCWogPSAraSArICggaSA8IDAgPyBsZW4gOiAwICk7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqID49IDAgJiYgaiA8IGxlbiA/IFsgdGhpc1tqXSBdIDogW10gKTsKCX0sCgoJZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wcmV2T2JqZWN0IHx8IHRoaXMuY29uc3RydWN0b3IobnVsbCk7Cgl9LAoKCS8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KCS8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgoJcHVzaDogcHVzaCwKCXNvcnQ6IGFyci5zb3J0LAoJc3BsaWNlOiBhcnIuc3BsaWNlCn07CgpqUXVlcnkuZXh0ZW5kID0galF1ZXJ5LmZuLmV4dGVuZCA9IGZ1bmN0aW9uKCkgewoJdmFyIG9wdGlvbnMsIG5hbWUsIHNyYywgY29weSwgY29weUlzQXJyYXksIGNsb25lLAoJCXRhcmdldCA9IGFyZ3VtZW50c1swXSB8fCB7fSwKCQlpID0gMSwKCQlsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAoJCWRlZXAgPSBmYWxzZTsKCgkvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCglpZiAoIHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIiApIHsKCQlkZWVwID0gdGFyZ2V0OwoKCQkvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CgkJdGFyZ2V0ID0gYXJndW1lbnRzWyBpIF0gfHwge307CgkJaSsrOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSApIHsKCQl0YXJnZXQgPSB7fTsKCX0KCgkvLyBleHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCWlmICggaSA9PT0gbGVuZ3RoICkgewoJCXRhcmdldCA9IHRoaXM7CgkJaS0tOwoJfQoKCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKSB7CgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQkJc3JjID0gdGFyZ2V0WyBuYW1lIF07CgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKCQkJCWlmICggdGFyZ2V0ID09PSBjb3B5ICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCS8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwoJCQkJaWYgKCBkZWVwICYmIGNvcHkgJiYgKCBqUXVlcnkuaXNQbGFpbk9iamVjdChjb3B5KSB8fCAoY29weUlzQXJyYXkgPSBqUXVlcnkuaXNBcnJheShjb3B5KSkgKSApIHsKCQkJCQlpZiAoIGNvcHlJc0FycmF5ICkgewoJCQkJCQljb3B5SXNBcnJheSA9IGZhbHNlOwoJCQkJCQljbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWNsb25lID0gc3JjICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KHNyYykgPyBzcmMgOiB7fTsKCQkJCQl9CgoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsKCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CglyZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKCWV4cGFuZG86ICJqUXVlcnkiICsgKCB2ZXJzaW9uICsgTWF0aC5yYW5kb20oKSApLnJlcGxhY2UoIC9cRC9nLCAiIiApLAoKCS8vIEFzc3VtZSBqUXVlcnkgaXMgcmVhZHkgd2l0aG91dCB0aGUgcmVhZHkgbW9kdWxlCglpc1JlYWR5OiB0cnVlLAoKCWVycm9yOiBmdW5jdGlvbiggbXNnICkgewoJCXRocm93IG5ldyBFcnJvciggbXNnICk7Cgl9LAoKCW5vb3A6IGZ1bmN0aW9uKCkge30sCgoJLy8gU2VlIHRlc3QvdW5pdC9jb3JlLmpzIGZvciBkZXRhaWxzIGNvbmNlcm5pbmcgaXNGdW5jdGlvbi4KCS8vIFNpbmNlIHZlcnNpb24gMS4zLCBET00gbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGxpa2UgYWxlcnQKCS8vIGFyZW4ndCBzdXBwb3J0ZWQuIFRoZXkgcmV0dXJuIGZhbHNlIG9uIElFICgjMjk2OCkuCglpc0Z1bmN0aW9uOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBqUXVlcnkudHlwZShvYmopID09PSAiZnVuY3Rpb24iOwoJfSwKCglpc0FycmF5OiBBcnJheS5pc0FycmF5LAoKCWlzV2luZG93OiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7Cgl9LAoKCWlzTnVtZXJpYzogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBwYXJzZUZsb2F0IE5hTnMgbnVtZXJpYy1jYXN0IGZhbHNlIHBvc2l0aXZlcyAobnVsbHx0cnVlfGZhbHNlfCIiKQoJCS8vIC4uLmJ1dCBtaXNpbnRlcnByZXRzIGxlYWRpbmctbnVtYmVyIHN0cmluZ3MsIHBhcnRpY3VsYXJseSBoZXggbGl0ZXJhbHMgKCIweC4uLiIpCgkJLy8gc3VidHJhY3Rpb24gZm9yY2VzIGluZmluaXRpZXMgdG8gTmFOCgkJcmV0dXJuICFqUXVlcnkuaXNBcnJheSggb2JqICkgJiYgb2JqIC0gcGFyc2VGbG9hdCggb2JqICkgPj0gMDsKCX0sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQkvLyBOb3QgcGxhaW4gb2JqZWN0czoKCQkvLyAtIEFueSBvYmplY3Qgb3IgdmFsdWUgd2hvc2UgaW50ZXJuYWwgW1tDbGFzc11dIHByb3BlcnR5IGlzIG5vdCAiW29iamVjdCBPYmplY3RdIgoJCS8vIC0gRE9NIG5vZGVzCgkJLy8gLSB3aW5kb3cKCQlpZiAoIGpRdWVyeS50eXBlKCBvYmogKSAhPT0gIm9iamVjdCIgfHwgb2JqLm5vZGVUeXBlIHx8IGpRdWVyeS5pc1dpbmRvdyggb2JqICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggb2JqLmNvbnN0cnVjdG9yICYmCgkJCQkhaGFzT3duLmNhbGwoIG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIiApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBJZiB0aGUgZnVuY3Rpb24gaGFzbid0IHJldHVybmVkIGFscmVhZHksIHdlJ3JlIGNvbmZpZGVudCB0aGF0CgkJLy8gfG9ianwgaXMgYSBwbGFpbiBvYmplY3QsIGNyZWF0ZWQgYnkge30gb3IgY29uc3RydWN0ZWQgd2l0aCBuZXcgT2JqZWN0CgkJcmV0dXJuIHRydWU7Cgl9LAoKCWlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJdmFyIG5hbWU7CgkJZm9yICggbmFtZSBpbiBvYmogKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7CgkJaWYgKCBvYmogPT0gbnVsbCApIHsKCQkJcmV0dXJuIG9iaiArICIiOwoJCX0KCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDwgNC4wLCBpT1MgPCA2IChmdW5jdGlvbmlzaCBSZWdFeHApCgkJcmV0dXJuIHR5cGVvZiBvYmogPT09ICJvYmplY3QiIHx8IHR5cGVvZiBvYmogPT09ICJmdW5jdGlvbiIgPwoJCQljbGFzczJ0eXBlWyB0b1N0cmluZy5jYWxsKG9iaikgXSB8fCAib2JqZWN0IiA6CgkJCXR5cGVvZiBvYmo7Cgl9LAoKCS8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggY29kZSApIHsKCQl2YXIgc2NyaXB0LAoJCQlpbmRpcmVjdCA9IGV2YWw7CgoJCWNvZGUgPSBqUXVlcnkudHJpbSggY29kZSApOwoKCQlpZiAoIGNvZGUgKSB7CgkJCS8vIElmIHRoZSBjb2RlIGluY2x1ZGVzIGEgdmFsaWQsIHByb2xvZ3VlIHBvc2l0aW9uCgkJCS8vIHN0cmljdCBtb2RlIHByYWdtYSwgZXhlY3V0ZSBjb2RlIGJ5IGluamVjdGluZyBhCgkJCS8vIHNjcmlwdCB0YWcgaW50byB0aGUgZG9jdW1lbnQuCgkJCWlmICggY29kZS5pbmRleE9mKCJ1c2Ugc3RyaWN0IikgPT09IDEgKSB7CgkJCQlzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKCQkJCXNjcmlwdC50ZXh0ID0gY29kZTsKCQkJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoIHNjcmlwdCApLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJCQl9IGVsc2UgewoJCQkvLyBPdGhlcndpc2UsIGF2b2lkIHRoZSBET00gbm9kZSBjcmVhdGlvbiwgaW5zZXJ0aW9uCgkJCS8vIGFuZCByZW1vdmFsIGJ5IHVzaW5nIGFuIGluZGlyZWN0IGdsb2JhbCBldmFsCgkJCQlpbmRpcmVjdCggY29kZSApOwoJCQl9CgkJfQoJfSwKCgkvLyBDb252ZXJ0IGRhc2hlZCB0byBjYW1lbENhc2U7IHVzZWQgYnkgdGhlIGNzcyBhbmQgZGF0YSBtb2R1bGVzCgkvLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAoIzk1NzIpCgljYW1lbENhc2U6IGZ1bmN0aW9uKCBzdHJpbmcgKSB7CgkJcmV0dXJuIHN0cmluZy5yZXBsYWNlKCBybXNQcmVmaXgsICJtcy0iICkucmVwbGFjZSggcmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSApOwoJfSwKCglub2RlTmFtZTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCk7Cgl9LAoKCS8vIGFyZ3MgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCWVhY2g6IGZ1bmN0aW9uKCBvYmosIGNhbGxiYWNrLCBhcmdzICkgewoJCXZhciB2YWx1ZSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IG9iai5sZW5ndGgsCgkJCWlzQXJyYXkgPSBpc0FycmF5bGlrZSggb2JqICk7CgoJCWlmICggYXJncyApIHsKCQkJaWYgKCBpc0FycmF5ICkgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFsdWUgPSBjYWxsYmFjay5hcHBseSggb2JqWyBpIF0sIGFyZ3MgKTsKCgkJCQkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suYXBwbHkoIG9ialsgaSBdLCBhcmdzICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJLy8gQSBzcGVjaWFsLCBmYXN0LCBjYXNlIGZvciB0aGUgbW9zdCBjb21tb24gdXNlIG9mIGVhY2gKCQl9IGVsc2UgewoJCQlpZiAoIGlzQXJyYXkgKSB7CgkJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmNhbGwoIG9ialsgaSBdLCBpLCBvYmpbIGkgXSApOwoKCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaSBpbiBvYmogKSB7CgkJCQkJdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCgkJCQkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLy8gU3VwcG9ydDogQW5kcm9pZDw0LjEKCXRyaW06IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCXJldHVybiB0ZXh0ID09IG51bGwgPwoJCQkiIiA6CgkJCSggdGV4dCArICIiICkucmVwbGFjZSggcnRyaW0sICIiICk7Cgl9LAoKCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1ha2VBcnJheTogZnVuY3Rpb24oIGFyciwgcmVzdWx0cyApIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnIgIT0gbnVsbCApIHsKCQkJaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LAoJCQkJCXR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8KCQkJCQlbIGFyciBdIDogYXJyCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJcHVzaC5jYWxsKCByZXQsIGFyciApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglpbkFycmF5OiBmdW5jdGlvbiggZWxlbSwgYXJyLCBpICkgewoJCXJldHVybiBhcnIgPT0gbnVsbCA/IC0xIDogaW5kZXhPZi5jYWxsKCBhcnIsIGVsZW0sIGkgKTsKCX0sCgoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBsZW4gPSArc2Vjb25kLmxlbmd0aCwKCQkJaiA9IDAsCgkJCWkgPSBmaXJzdC5sZW5ndGg7CgoJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgewoJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKCQl9CgoJCWZpcnN0Lmxlbmd0aCA9IGk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ZXJ0ICkgewoJCXZhciBjYWxsYmFja0ludmVyc2UsCgkJCW1hdGNoZXMgPSBbXSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0OwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJY2FsbGJhY2tJbnZlcnNlID0gIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCApIHsKCQkJCW1hdGNoZXMucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gbWF0Y2hlczsKCX0sCgoJLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgltYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsKCQl2YXIgdmFsdWUsCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGgsCgkJCWlzQXJyYXkgPSBpc0FycmF5bGlrZSggZWxlbXMgKSwKCQkJcmV0ID0gW107CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpciBuZXcgdmFsdWVzCgkJaWYgKCBpc0FycmF5ICkgewoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXQucHVzaCggdmFsdWUgKTsKCQkJCX0KCQkJfQoKCQkvLyBHbyB0aHJvdWdoIGV2ZXJ5IGtleSBvbiB0aGUgb2JqZWN0LAoJCX0gZWxzZSB7CgkJCWZvciAoIGkgaW4gZWxlbXMgKSB7CgkJCQl2YWx1ZSA9IGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpLCBhcmcgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJcmV0LnB1c2goIHZhbHVlICk7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKCQlyZXR1cm4gY29uY2F0LmFwcGx5KCBbXSwgcmV0ICk7Cgl9LAoKCS8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cwoJZ3VpZDogMSwKCgkvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKCS8vIGFyZ3VtZW50cy4KCXByb3h5OiBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7CgkJdmFyIHRtcCwgYXJncywgcHJveHk7CgoJCWlmICggdHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciICkgewoJCQl0bXAgPSBmblsgY29udGV4dCBdOwoJCQljb250ZXh0ID0gZm47CgkJCWZuID0gdG1wOwoJCX0KCgkJLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKCQkvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgoJCWlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCBmbiApICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJLy8gU2ltdWxhdGVkIGJpbmQKCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAyICk7CgkJcHJveHkgPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGZuLmFwcGx5KCBjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7CgkJfTsKCgkJLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkCgkJcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgoJCXJldHVybiBwcm94eTsKCX0sCgoJbm93OiBEYXRlLm5vdywKCgkvLyBqUXVlcnkuc3VwcG9ydCBpcyBub3QgdXNlZCBpbiBDb3JlIGJ1dCBvdGhlciBwcm9qZWN0cyBhdHRhY2ggdGhlaXIKCS8vIHByb3BlcnRpZXMgdG8gaXQgc28gaXQgbmVlZHMgdG8gZXhpc3QuCglzdXBwb3J0OiBzdXBwb3J0Cn0pOwoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCmpRdWVyeS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIi5zcGxpdCgiICIpLCBmdW5jdGlvbihpLCBuYW1lKSB7CgljbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9KTsKCmZ1bmN0aW9uIGlzQXJyYXlsaWtlKCBvYmogKSB7Cgl2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aCwKCQl0eXBlID0galF1ZXJ5LnR5cGUoIG9iaiApOwoKCWlmICggdHlwZSA9PT0gImZ1bmN0aW9uIiB8fCBqUXVlcnkuaXNXaW5kb3coIG9iaiApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglpZiAoIG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGggKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJcmV0dXJuIHR5cGUgPT09ICJhcnJheSIgfHwgbGVuZ3RoID09PSAwIHx8CgkJdHlwZW9mIGxlbmd0aCA9PT0gIm51bWJlciIgJiYgbGVuZ3RoID4gMCAmJiAoIGxlbmd0aCAtIDEgKSBpbiBvYmo7Cn0KdmFyIFNpenpsZSA9Ci8qIQogKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZSB2MS4xMC4xOQogKiBodHRwOi8vc2l6emxlanMuY29tLwogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIERhdGU6IDIwMTQtMDQtMTgKICovCihmdW5jdGlvbiggd2luZG93ICkgewoKdmFyIGksCglzdXBwb3J0LAoJRXhwciwKCWdldFRleHQsCglpc1hNTCwKCXRva2VuaXplLAoJY29tcGlsZSwKCXNlbGVjdCwKCW91dGVybW9zdENvbnRleHQsCglzb3J0SW5wdXQsCgloYXNEdXBsaWNhdGUsCgoJLy8gTG9jYWwgZG9jdW1lbnQgdmFycwoJc2V0RG9jdW1lbnQsCglkb2N1bWVudCwKCWRvY0VsZW0sCglkb2N1bWVudElzSFRNTCwKCXJidWdneVFTQSwKCXJidWdneU1hdGNoZXMsCgltYXRjaGVzLAoJY29udGFpbnMsCgoJLy8gSW5zdGFuY2Utc3BlY2lmaWMgZGF0YQoJZXhwYW5kbyA9ICJzaXp6bGUiICsgLShuZXcgRGF0ZSgpKSwKCXByZWZlcnJlZERvYyA9IHdpbmRvdy5kb2N1bWVudCwKCWRpcnJ1bnMgPSAwLAoJZG9uZSA9IDAsCgljbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCXRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCglzb3J0T3JkZXIgPSBmdW5jdGlvbiggYSwgYiApIHsKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiAwOwoJfSwKCgkvLyBHZW5lcmFsLXB1cnBvc2UgY29uc3RhbnRzCglzdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLAoJTUFYX05FR0FUSVZFID0gMSA8PCAzMSwKCgkvLyBJbnN0YW5jZSBtZXRob2RzCgloYXNPd24gPSAoe30pLmhhc093blByb3BlcnR5LAoJYXJyID0gW10sCglwb3AgPSBhcnIucG9wLAoJcHVzaF9uYXRpdmUgPSBhcnIucHVzaCwKCXB1c2ggPSBhcnIucHVzaCwKCXNsaWNlID0gYXJyLnNsaWNlLAoJLy8gVXNlIGEgc3RyaXBwZWQtZG93biBpbmRleE9mIGlmIHdlIGNhbid0IHVzZSBhIG5hdGl2ZSBvbmUKCWluZGV4T2YgPSBhcnIuaW5kZXhPZiB8fCBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgaSA9IDAsCgkJCWxlbiA9IHRoaXMubGVuZ3RoOwoJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQlpZiAoIHRoaXNbaV0gPT09IGVsZW0gKSB7CgkJCQlyZXR1cm4gaTsKCQkJfQoJCX0KCQlyZXR1cm4gLTE7Cgl9LAoKCWJvb2xlYW5zID0gImNoZWNrZWR8c2VsZWN0ZWR8YXN5bmN8YXV0b2ZvY3VzfGF1dG9wbGF5fGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnxpc21hcHxsb29wfG11bHRpcGxlfG9wZW58cmVhZG9ubHl8cmVxdWlyZWR8c2NvcGVkIiwKCgkvLyBSZWd1bGFyIGV4cHJlc3Npb25zCgoJLy8gV2hpdGVzcGFjZSBjaGFyYWN0ZXJzIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCgl3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAoJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zeW50YXgvI2NoYXJhY3RlcnMKCWNoYXJhY3RlckVuY29kaW5nID0gIig/OlxcXFwufFtcXHctXXxbXlxceDAwLVxceGEwXSkrIiwKCgkvLyBMb29zZWx5IG1vZGVsZWQgb24gQ1NTIGlkZW50aWZpZXIgY2hhcmFjdGVycwoJLy8gQW4gdW5xdW90ZWQgdmFsdWUgc2hvdWxkIGJlIGEgQ1NTIGlkZW50aWZpZXIgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKCS8vIFByb3BlciBzeW50YXg6IGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCN2YWx1ZS1kZWYtaWRlbnRpZmllcgoJaWRlbnRpZmllciA9IGNoYXJhY3RlckVuY29kaW5nLnJlcGxhY2UoICJ3IiwgIncjIiApLAoKCS8vIEF0dHJpYnV0ZSBzZWxlY3RvcnM6IGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwoJYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpKD86IiArIHdoaXRlc3BhY2UgKwoJCS8vIE9wZXJhdG9yIChjYXB0dXJlIDIpCgkJIiooWypeJHwhfl0/PSkiICsgd2hpdGVzcGFjZSArCgkJLy8gIkF0dHJpYnV0ZSB2YWx1ZXMgbXVzdCBiZSBDU1MgaWRlbnRpZmllcnMgW2NhcHR1cmUgNV0gb3Igc3RyaW5ncyBbY2FwdHVyZSAzIG9yIGNhcHR1cmUgNF0iCgkJIiooPzonKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcInwoIiArIGlkZW50aWZpZXIgKyAiKSl8KSIgKyB3aGl0ZXNwYWNlICsKCQkiKlxcXSIsCgoJcHNldWRvcyA9ICI6KCIgKyBjaGFyYWN0ZXJFbmNvZGluZyArICIpKD86XFwoKCIgKwoJCS8vIFRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycyBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBwcmVGaWx0ZXIsIHByZWZlciBhcmd1bWVudHM6CgkJLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpCgkJIignKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcIil8IiArCgkJLy8gMi4gc2ltcGxlIChjYXB0dXJlIDYpCgkJIigoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzICsgIikqKXwiICsKCQkvLyAzLiBhbnl0aGluZyBlbHNlIChjYXB0dXJlIDIpCgkJIi4qIiArCgkJIilcXCl8KSIsCgoJLy8gTGVhZGluZyBhbmQgbm9uLWVzY2FwZWQgdHJhaWxpbmcgd2hpdGVzcGFjZSwgY2FwdHVyaW5nIHNvbWUgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVycyBwcmVjZWRpbmcgdGhlIGxhdHRlcgoJcnRyaW0gPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyB3aGl0ZXNwYWNlICsgIiskIiwgImciICksCgoJcmNvbW1hID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqLCIgKyB3aGl0ZXNwYWNlICsgIioiICksCglyY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIiooWz4rfl18IiArIHdoaXRlc3BhY2UgKyAiKSIgKyB3aGl0ZXNwYWNlICsgIioiICksCgoJcmF0dHJpYnV0ZVF1b3RlcyA9IG5ldyBSZWdFeHAoICI9IiArIHdoaXRlc3BhY2UgKyAiKihbXlxcXSdcIl0qPykiICsgd2hpdGVzcGFjZSArICIqXFxdIiwgImciICksCgoJcnBzZXVkbyA9IG5ldyBSZWdFeHAoIHBzZXVkb3MgKSwKCXJpZGVudGlmaWVyID0gbmV3IFJlZ0V4cCggIl4iICsgaWRlbnRpZmllciArICIkIiApLAoKCW1hdGNoRXhwciA9IHsKCQkiSUQiOiBuZXcgUmVnRXhwKCAiXiMoIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIlRBRyI6IG5ldyBSZWdFeHAoICJeKCIgKyBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAidyIsICJ3KiIgKSArICIpIiApLAoJCSJBVFRSIjogbmV3IFJlZ0V4cCggIl4iICsgYXR0cmlidXRlcyApLAoJCSJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksCgkJIkNISUxEIjogbmV3IFJlZ0V4cCggIl46KG9ubHl8Zmlyc3R8bGFzdHxudGh8bnRoLWxhc3QpLShjaGlsZHxvZi10eXBlKSg/OlxcKCIgKyB3aGl0ZXNwYWNlICsKCQkJIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsgd2hpdGVzcGFjZSArICIqKD86KFsrLV18KSIgKyB3aGl0ZXNwYWNlICsKCQkJIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwKCQkiYm9vbCI6IG5ldyBSZWdFeHAoICJeKD86IiArIGJvb2xlYW5zICsgIikkIiwgImkiICksCgkJLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCgkJLy8gV2UgdXNlIHRoaXMgZm9yIFBPUyBtYXRjaGluZyBpbiBgc2VsZWN0YAoJCSJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIipbPit+XXw6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCIgKwoJCQl3aGl0ZXNwYWNlICsgIiooKD86LVxcZCk/XFxkKikiICsgd2hpdGVzcGFjZSArICIqXFwpfCkoPz1bXi1dfCQpIiwgImkiICkKCX0sCgoJcmlucHV0cyA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksCglyaGVhZGVyID0gL15oXGQkL2ksCgoJcm5hdGl2ZSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKCgkvLyBFYXNpbHktcGFyc2VhYmxlL3JldHJpZXZhYmxlIElEIG9yIFRBRyBvciBDTEFTUyBzZWxlY3RvcnMKCXJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAoKCXJzaWJsaW5nID0gL1srfl0vLAoJcmVzY2FwZSA9IC8nfFxcL2csCgoJLy8gQ1NTIGVzY2FwZXMgaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwoJcnVuZXNjYXBlID0gbmV3IFJlZ0V4cCggIlxcXFwoW1xcZGEtZl17MSw2fSIgKyB3aGl0ZXNwYWNlICsgIj98KCIgKyB3aGl0ZXNwYWNlICsgIil8LikiLCAiaWciICksCglmdW5lc2NhcGUgPSBmdW5jdGlvbiggXywgZXNjYXBlZCwgZXNjYXBlZFdoaXRlc3BhY2UgKSB7CgkJdmFyIGhpZ2ggPSAiMHgiICsgZXNjYXBlZCAtIDB4MTAwMDA7CgkJLy8gTmFOIG1lYW5zIG5vbi1jb2RlcG9pbnQKCQkvLyBTdXBwb3J0OiBGaXJlZm94PDI0CgkJLy8gV29ya2Fyb3VuZCBlcnJvbmVvdXMgbnVtZXJpYyBpbnRlcnByZXRhdGlvbiBvZiArIjB4IgoJCXJldHVybiBoaWdoICE9PSBoaWdoIHx8IGVzY2FwZWRXaGl0ZXNwYWNlID8KCQkJZXNjYXBlZCA6CgkJCWhpZ2ggPCAwID8KCQkJCS8vIEJNUCBjb2RlcG9pbnQKCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOgoJCQkJLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpCgkJCQlTdHJpbmcuZnJvbUNoYXJDb2RlKCBoaWdoID4+IDEwIHwgMHhEODAwLCBoaWdoICYgMHgzRkYgfCAweERDMDAgKTsKCX07CgovLyBPcHRpbWl6ZSBmb3IgcHVzaC5hcHBseSggXywgTm9kZUxpc3QgKQp0cnkgewoJcHVzaC5hcHBseSgKCQkoYXJyID0gc2xpY2UuY2FsbCggcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMgKSksCgkJcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMKCSk7CgkvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMAoJLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQoJYXJyWyBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGggXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CglwdXNoID0geyBhcHBseTogYXJyLmxlbmd0aCA/CgoJCS8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCgkJZnVuY3Rpb24oIHRhcmdldCwgZWxzICkgewoJCQlwdXNoX25hdGl2ZS5hcHBseSggdGFyZ2V0LCBzbGljZS5jYWxsKGVscykgKTsKCQl9IDoKCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIE90aGVyd2lzZSBhcHBlbmQgZGlyZWN0bHkKCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7CgkJCXZhciBqID0gdGFyZ2V0Lmxlbmd0aCwKCQkJCWkgPSAwOwoJCQkvLyBDYW4ndCB0cnVzdCBOb2RlTGlzdC5sZW5ndGgKCQkJd2hpbGUgKCAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgKSB7fQoJCQl0YXJnZXQubGVuZ3RoID0gaiAtIDE7CgkJfQoJfTsKfQoKZnVuY3Rpb24gU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXZhciBtYXRjaCwgZWxlbSwgbSwgbm9kZVR5cGUsCgkJLy8gUVNBIHZhcnMKCQlpLCBncm91cHMsIG9sZCwgbmlkLCBuZXdDb250ZXh0LCBuZXdTZWxlY3RvcjsKCglpZiAoICggY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogcHJlZmVycmVkRG9jICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBjb250ZXh0ICk7Cgl9CgoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CglyZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCWlmICggKG5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZSkgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCWlmICggZG9jdW1lbnRJc0hUTUwgJiYgIXNlZWQgKSB7CgoJCS8vIFNob3J0Y3V0cwoJCWlmICggKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApKSApIHsKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKCQkJaWYgKCAobSA9IG1hdGNoWzFdKSApIHsKCQkJCWlmICggbm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKTsKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgKGpRdWVyeSAjNjk2MykKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAoJCQkJCWlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCgkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSApOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQoJCQl9IGVsc2UgaWYgKCAobSA9IG1hdGNoWzNdKSAmJiBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9CgkJfQoKCQkvLyBRU0EgcGF0aAoJCWlmICggc3VwcG9ydC5xc2EgJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KCBzZWxlY3RvciApKSApIHsKCQkJbmlkID0gb2xkID0gZXhwYW5kbzsKCQkJbmV3Q29udGV4dCA9IGNvbnRleHQ7CgkJCW5ld1NlbGVjdG9yID0gbm9kZVR5cGUgPT09IDkgJiYgc2VsZWN0b3I7CgoJCQkvLyBxU0Egd29ya3Mgc3RyYW5nZWx5IG9uIEVsZW1lbnQtcm9vdGVkIHF1ZXJpZXMKCQkJLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAoJCQkvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKCQkJLy8gSUUgOCBkb2Vzbid0IHdvcmsgb24gb2JqZWN0IGVsZW1lbnRzCgkJCWlmICggbm9kZVR5cGUgPT09IDEgJiYgY29udGV4dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAib2JqZWN0IiApIHsKCQkJCWdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKCQkJCWlmICggKG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCJpZCIpKSApIHsKCQkJCQluaWQgPSBvbGQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7CgkJCQl9IGVsc2UgewoJCQkJCWNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKCQkJCX0KCQkJCW5pZCA9ICJbaWQ9JyIgKyBuaWQgKyAiJ10gIjsKCgkJCQlpID0gZ3JvdXBzLmxlbmd0aDsKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCWdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwoJCQkJfQoJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8IGNvbnRleHQ7CgkJCQluZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCIsIik7CgkJCX0KCgkJCWlmICggbmV3U2VsZWN0b3IgKSB7CgkJCQl0cnkgewoJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsCgkJCQkJCW5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbCggbmV3U2VsZWN0b3IgKQoJCQkJCSk7CgkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQl9IGNhdGNoKHFzYUVycm9yKSB7CgkJCQl9IGZpbmFsbHkgewoJCQkJCWlmICggIW9sZCApIHsKCQkJCQkJY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoImlkIik7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIEFsbCBvdGhlcnMKCXJldHVybiBzZWxlY3QoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKTsKfQoKLyoqCiAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQogKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAqCXByb3BlcnR5IG5hbWUgdGhlIChzcGFjZS1zdWZmaXhlZCkgc3RyaW5nIGFuZCAoaWYgdGhlIGNhY2hlIGlzIGxhcmdlciB0aGFuIEV4cHIuY2FjaGVMZW5ndGgpCiAqCWRlbGV0aW5nIHRoZSBvbGRlc3QgZW50cnkKICovCmZ1bmN0aW9uIGNyZWF0ZUNhY2hlKCkgewoJdmFyIGtleXMgPSBbXTsKCglmdW5jdGlvbiBjYWNoZSgga2V5LCB2YWx1ZSApIHsKCQkvLyBVc2UgKGtleSArICIgIikgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggbmF0aXZlIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChzZWUgSXNzdWUgIzE1NykKCQlpZiAoIGtleXMucHVzaCgga2V5ICsgIiAiICkgPiBFeHByLmNhY2hlTGVuZ3RoICkgewoJCQkvLyBPbmx5IGtlZXAgdGhlIG1vc3QgcmVjZW50IGVudHJpZXMKCQkJZGVsZXRlIGNhY2hlWyBrZXlzLnNoaWZ0KCkgXTsKCQl9CgkJcmV0dXJuIChjYWNoZVsga2V5ICsgIiAiIF0gPSB2YWx1ZSk7Cgl9CglyZXR1cm4gY2FjaGU7Cn0KCi8qKgogKiBNYXJrIGEgZnVuY3Rpb24gZm9yIHNwZWNpYWwgdXNlIGJ5IFNpenpsZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gbWFyawogKi8KZnVuY3Rpb24gbWFya0Z1bmN0aW9uKCBmbiApIHsKCWZuWyBleHBhbmRvIF0gPSB0cnVlOwoJcmV0dXJuIGZuOwp9CgovKioKICogU3VwcG9ydCB0ZXN0aW5nIHVzaW5nIGFuIGVsZW1lbnQKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGRpdiBhbmQgZXhwZWN0cyBhIGJvb2xlYW4gcmVzdWx0CiAqLwpmdW5jdGlvbiBhc3NlcnQoIGZuICkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKCXRyeSB7CgkJcmV0dXJuICEhZm4oIGRpdiApOwoJfSBjYXRjaCAoZSkgewoJCXJldHVybiBmYWxzZTsKCX0gZmluYWxseSB7CgkJLy8gUmVtb3ZlIGZyb20gaXRzIHBhcmVudCBieSBkZWZhdWx0CgkJaWYgKCBkaXYucGFyZW50Tm9kZSApIHsKCQkJZGl2LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGRpdiApOwoJCX0KCQkvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQoJCWRpdiA9IG51bGw7Cgl9Cn0KCi8qKgogKiBBZGRzIHRoZSBzYW1lIGhhbmRsZXIgZm9yIGFsbCBvZiB0aGUgc3BlY2lmaWVkIGF0dHJzCiAqIEBwYXJhbSB7U3RyaW5nfSBhdHRycyBQaXBlLXNlcGFyYXRlZCBsaXN0IG9mIGF0dHJpYnV0ZXMKICogQHBhcmFtIHtGdW5jdGlvbn0gaGFuZGxlciBUaGUgbWV0aG9kIHRoYXQgd2lsbCBiZSBhcHBsaWVkCiAqLwpmdW5jdGlvbiBhZGRIYW5kbGUoIGF0dHJzLCBoYW5kbGVyICkgewoJdmFyIGFyciA9IGF0dHJzLnNwbGl0KCJ8IiksCgkJaSA9IGF0dHJzLmxlbmd0aDsKCgl3aGlsZSAoIGktLSApIHsKCQlFeHByLmF0dHJIYW5kbGVbIGFycltpXSBdID0gaGFuZGxlcjsKCX0KfQoKLyoqCiAqIENoZWNrcyBkb2N1bWVudCBvcmRlciBvZiB0d28gc2libGluZ3MKICogQHBhcmFtIHtFbGVtZW50fSBhCiAqIEBwYXJhbSB7RWxlbWVudH0gYgogKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGxlc3MgdGhhbiAwIGlmIGEgcHJlY2VkZXMgYiwgZ3JlYXRlciB0aGFuIDAgaWYgYSBmb2xsb3dzIGIKICovCmZ1bmN0aW9uIHNpYmxpbmdDaGVjayggYSwgYiApIHsKCXZhciBjdXIgPSBiICYmIGEsCgkJZGlmZiA9IGN1ciAmJiBhLm5vZGVUeXBlID09PSAxICYmIGIubm9kZVR5cGUgPT09IDEgJiYKCQkJKCB+Yi5zb3VyY2VJbmRleCB8fCBNQVhfTkVHQVRJVkUgKSAtCgkJCSggfmEuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFICk7CgoJLy8gVXNlIElFIHNvdXJjZUluZGV4IGlmIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCglpZiAoIGRpZmYgKSB7CgkJcmV0dXJuIGRpZmY7Cgl9CgoJLy8gQ2hlY2sgaWYgYiBmb2xsb3dzIGEKCWlmICggY3VyICkgewoJCXdoaWxlICggKGN1ciA9IGN1ci5uZXh0U2libGluZykgKSB7CgkJCWlmICggY3VyID09PSBiICkgewoJCQkJcmV0dXJuIC0xOwoJCQl9CgkJfQoJfQoKCXJldHVybiBhID8gMSA6IC0xOwp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwogKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogKi8KZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8oIHR5cGUgKSB7CglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSB0eXBlOwoJfTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgYnV0dG9ucwogKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogKi8KZnVuY3Rpb24gY3JlYXRlQnV0dG9uUHNldWRvKCB0eXBlICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXJldHVybiAobmFtZSA9PT0gImlucHV0IiB8fCBuYW1lID09PSAiYnV0dG9uIikgJiYgZWxlbS50eXBlID09PSB0eXBlOwoJfTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgcG9zaXRpb25hbHMKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4KICovCmZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oIGZuICkgewoJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggYXJndW1lbnQgKSB7CgkJYXJndW1lbnQgPSArYXJndW1lbnQ7CgkJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsKCQkJdmFyIGosCgkJCQltYXRjaEluZGV4ZXMgPSBmbiggW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCApLAoJCQkJaSA9IG1hdGNoSW5kZXhlcy5sZW5ndGg7CgoJCQkvLyBNYXRjaCBlbGVtZW50cyBmb3VuZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4ZXMKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoIHNlZWRbIChqID0gbWF0Y2hJbmRleGVzW2ldKSBdICkgewoJCQkJCXNlZWRbal0gPSAhKG1hdGNoZXNbal0gPSBzZWVkW2pdKTsKCQkJCX0KCQkJfQoJCX0pOwoJfSk7Cn0KCi8qKgogKiBDaGVja3MgYSBub2RlIGZvciB2YWxpZGl0eSBhcyBhIFNpenpsZSBjb250ZXh0CiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3Q9fSBjb250ZXh0CiAqIEByZXR1cm5zIHtFbGVtZW50fE9iamVjdHxCb29sZWFufSBUaGUgaW5wdXQgbm9kZSBpZiBhY2NlcHRhYmxlLCBvdGhlcndpc2UgYSBmYWxzeSB2YWx1ZQogKi8KZnVuY3Rpb24gdGVzdENvbnRleHQoIGNvbnRleHQgKSB7CglyZXR1cm4gY29udGV4dCAmJiB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmIGNvbnRleHQ7Cn0KCi8vIEV4cG9zZSBzdXBwb3J0IHZhcnMgZm9yIGNvbnZlbmllbmNlCnN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwoKLyoqCiAqIERldGVjdHMgWE1MIG5vZGVzCiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IGVsZW0gQW4gZWxlbWVudCBvciBhIGRvY3VtZW50CiAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmZiBlbGVtIGlzIGEgbm9uLUhUTUwgWE1MIG5vZGUKICovCmlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CgkvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykKCXZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwoJcmV0dXJuIGRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gIkhUTUwiIDogZmFsc2U7Cn07CgovKioKICogU2V0cyBkb2N1bWVudC1yZWxhdGVkIHZhcmlhYmxlcyBvbmNlIGJhc2VkIG9uIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IFtkb2NdIEFuIGVsZW1lbnQgb3IgZG9jdW1lbnQgb2JqZWN0IHRvIHVzZSB0byBzZXQgdGhlIGRvY3VtZW50CiAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGN1cnJlbnQgZG9jdW1lbnQKICovCnNldERvY3VtZW50ID0gU2l6emxlLnNldERvY3VtZW50ID0gZnVuY3Rpb24oIG5vZGUgKSB7Cgl2YXIgaGFzQ29tcGFyZSwKCQlkb2MgPSBub2RlID8gbm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUgOiBwcmVmZXJyZWREb2MsCgkJcGFyZW50ID0gZG9jLmRlZmF1bHRWaWV3OwoKCS8vIElmIG5vIGRvY3VtZW50IGFuZCBkb2N1bWVudEVsZW1lbnQgaXMgYXZhaWxhYmxlLCByZXR1cm4KCWlmICggZG9jID09PSBkb2N1bWVudCB8fCBkb2Mubm9kZVR5cGUgIT09IDkgfHwgIWRvYy5kb2N1bWVudEVsZW1lbnQgKSB7CgkJcmV0dXJuIGRvY3VtZW50OwoJfQoKCS8vIFNldCBvdXIgZG9jdW1lbnQKCWRvY3VtZW50ID0gZG9jOwoJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgoJLy8gU3VwcG9ydCB0ZXN0cwoJZG9jdW1lbnRJc0hUTUwgPSAhaXNYTUwoIGRvYyApOwoKCS8vIFN1cHBvcnQ6IElFPjgKCS8vIElmIGlmcmFtZSBkb2N1bWVudCBpcyBhc3NpZ25lZCB0byAiZG9jdW1lbnQiIHZhcmlhYmxlIGFuZCBpZiBpZnJhbWUgaGFzIGJlZW4gcmVsb2FkZWQsCgkvLyBJRSB3aWxsIHRocm93ICJwZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBhY2Nlc3NpbmcgImRvY3VtZW50IiB2YXJpYWJsZSwgc2VlIGpRdWVyeSAjMTM5MzYKCS8vIElFNi04IGRvIG5vdCBzdXBwb3J0IHRoZSBkZWZhdWx0VmlldyBwcm9wZXJ0eSBzbyBwYXJlbnQgd2lsbCBiZSB1bmRlZmluZWQKCWlmICggcGFyZW50ICYmIHBhcmVudCAhPT0gcGFyZW50LnRvcCApIHsKCQkvLyBJRTExIGRvZXMgbm90IGhhdmUgYXR0YWNoRXZlbnQsIHNvIGFsbCBtdXN0IHN1ZmZlcgoJCWlmICggcGFyZW50LmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJCXBhcmVudC5hZGRFdmVudExpc3RlbmVyKCAidW5sb2FkIiwgZnVuY3Rpb24oKSB7CgkJCQlzZXREb2N1bWVudCgpOwoJCQl9LCBmYWxzZSApOwoJCX0gZWxzZSBpZiAoIHBhcmVudC5hdHRhY2hFdmVudCApIHsKCQkJcGFyZW50LmF0dGFjaEV2ZW50KCAib251bmxvYWQiLCBmdW5jdGlvbigpIHsKCQkJCXNldERvY3VtZW50KCk7CgkJCX0pOwoJCX0KCX0KCgkvKiBBdHRyaWJ1dGVzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gU3VwcG9ydDogSUU8OAoJLy8gVmVyaWZ5IHRoYXQgZ2V0QXR0cmlidXRlIHJlYWxseSByZXR1cm5zIGF0dHJpYnV0ZXMgYW5kIG5vdCBwcm9wZXJ0aWVzIChleGNlcHRpbmcgSUU4IGJvb2xlYW5zKQoJc3VwcG9ydC5hdHRyaWJ1dGVzID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmNsYXNzTmFtZSA9ICJpIjsKCQlyZXR1cm4gIWRpdi5nZXRBdHRyaWJ1dGUoImNsYXNzTmFtZSIpOwoJfSk7CgoJLyogZ2V0RWxlbWVudChzKUJ5KgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikgcmV0dXJucyBvbmx5IGVsZW1lbnRzCglzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmFwcGVuZENoaWxkKCBkb2MuY3JlYXRlQ29tbWVudCgiIikgKTsKCQlyZXR1cm4gIWRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aDsKCX0pOwoKCS8vIENoZWNrIGlmIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgY2FuIGJlIHRydXN0ZWQKCXN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9IHJuYXRpdmUudGVzdCggZG9jLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgKSAmJiBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J2EnPjwvZGl2PjxkaXYgY2xhc3M9J2EgaSc+PC9kaXY+IjsKCgkJLy8gU3VwcG9ydDogU2FmYXJpPDQKCQkvLyBDYXRjaCBjbGFzcyBvdmVyLWNhY2hpbmcKCQlkaXYuZmlyc3RDaGlsZC5jbGFzc05hbWUgPSAiaSI7CgkJLy8gU3VwcG9ydDogT3BlcmE8MTAKCQkvLyBDYXRjaCBnRUJDTiBmYWlsdXJlIHRvIGZpbmQgbm9uLWxlYWRpbmcgY2xhc3NlcwoJCXJldHVybiBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiaSIpLmxlbmd0aCA9PT0gMjsKCX0pOwoKCS8vIFN1cHBvcnQ6IElFPDEwCgkvLyBDaGVjayBpZiBnZXRFbGVtZW50QnlJZCByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUKCS8vIFRoZSBicm9rZW4gZ2V0RWxlbWVudEJ5SWQgbWV0aG9kcyBkb24ndCBwaWNrIHVwIHByb2dyYW1hdGljYWxseS1zZXQgbmFtZXMsCgkvLyBzbyB1c2UgYSByb3VuZGFib3V0IGdldEVsZW1lbnRzQnlOYW1lIHRlc3QKCXN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCWRvY0VsZW0uYXBwZW5kQ2hpbGQoIGRpdiApLmlkID0gZXhwYW5kbzsKCQlyZXR1cm4gIWRvYy5nZXRFbGVtZW50c0J5TmFtZSB8fCAhZG9jLmdldEVsZW1lbnRzQnlOYW1lKCBleHBhbmRvICkubGVuZ3RoOwoJfSk7CgoJLy8gSUQgZmluZCBhbmQgZmlsdGVyCglpZiAoIHN1cHBvcnQuZ2V0QnlJZCApIHsKCQlFeHByLmZpbmRbIklEIl0gPSBmdW5jdGlvbiggaWQsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCApIHsKCQkJCXZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsKCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCgkJCQlyZXR1cm4gbSAmJiBtLnBhcmVudE5vZGUgPyBbIG0gXSA6IFtdOwoJCQl9CgkJfTsKCQlFeHByLmZpbHRlclsiSUQiXSA9IGZ1bmN0aW9uKCBpZCApIHsKCQkJdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaWQiKSA9PT0gYXR0cklkOwoJCQl9OwoJCX07Cgl9IGVsc2UgewoJCS8vIFN1cHBvcnQ6IElFNi83CgkJLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dAoJCWRlbGV0ZSBFeHByLmZpbmRbIklEIl07CgoJCUV4cHIuZmlsdGVyWyJJRCJdID0gIGZ1bmN0aW9uKCBpZCApIHsKCQkJdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciBub2RlID0gdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCQkJCXJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKCQkJfTsKCQl9OwoJfQoKCS8vIFRhZwoJRXhwci5maW5kWyJUQUciXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPwoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09IHN0cnVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCQkJfQoJCX0gOgoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCXZhciBlbGVtLAoJCQkJdG1wID0gW10sCgkJCQlpID0gMCwKCQkJCXJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCB0YWcgKTsKCgkJCS8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKCQkJaWYgKCB0YWcgPT09ICIqIiApIHsKCQkJCXdoaWxlICggKGVsZW0gPSByZXN1bHRzW2krK10pICkgewoJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJdG1wLnB1c2goIGVsZW0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHRtcDsKCQkJfQoJCQlyZXR1cm4gcmVzdWx0czsKCQl9OwoKCS8vIENsYXNzCglFeHByLmZpbmRbIkNMQVNTIl0gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgZnVuY3Rpb24oIGNsYXNzTmFtZSwgY29udGV4dCApIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09IHN0cnVuZGVmaW5lZCAmJiBkb2N1bWVudElzSFRNTCApIHsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggY2xhc3NOYW1lICk7CgkJfQoJfTsKCgkvKiBRU0EvbWF0Y2hlc1NlbGVjdG9yCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gUVNBIGFuZCBtYXRjaGVzU2VsZWN0b3Igc3VwcG9ydAoKCS8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpCglyYnVnZ3lNYXRjaGVzID0gW107CgoJLy8gcVNhKDpmb2N1cykgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKENocm9tZSAyMSkKCS8vIFdlIGFsbG93IHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBJRTgvOSB0aGF0IHRocm93cyBhbiBlcnJvcgoJLy8gd2hlbmV2ZXIgYGRvY3VtZW50LmFjdGl2ZUVsZW1lbnRgIGlzIGFjY2Vzc2VkIG9uIGFuIGlmcmFtZQoJLy8gU28sIHdlIGFsbG93IDpmb2N1cyB0byBwYXNzIHRocm91Z2ggUVNBIGFsbCB0aGUgdGltZSB0byBhdm9pZCB0aGUgSUUgZXJyb3IKCS8vIFNlZSBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMzM3OAoJcmJ1Z2d5UVNBID0gW107CgoJaWYgKCAoc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoIGRvYy5xdWVyeVNlbGVjdG9yQWxsICkpICkgewoJCS8vIEJ1aWxkIFFTQSByZWdleAoJCS8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQkJLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQoJCQkvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY2l0bHkKCQkJLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsCgkJCS8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMzU5CgkJCWRpdi5pbm5lckhUTUwgPSAiPHNlbGVjdCBtc2FsbG93Y2xpcD0nJz48b3B0aW9uIHNlbGVjdGVkPScnPjwvb3B0aW9uPjwvc2VsZWN0PiI7CgoJCQkvLyBTdXBwb3J0OiBJRTgsIE9wZXJhIDExLTEyLjE2CgkJCS8vIE5vdGhpbmcgc2hvdWxkIGJlIHNlbGVjdGVkIHdoZW4gZW1wdHkgc3RyaW5ncyBmb2xsb3cgXj0gb3IgJD0gb3IgKj0KCQkJLy8gVGhlIHRlc3QgYXR0cmlidXRlIG11c3QgYmUgdW5rbm93biBpbiBPcGVyYSBidXQgInNhZmUiIGZvciBXaW5SVAoJCQkvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg0NjUzODguYXNweCNhdHRyaWJ1dGVfc2VjdGlvbgoJCQlpZiAoIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbbXNhbGxvd2NsaXBePScnXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiWypeJF09IiArIHdoaXRlc3BhY2UgKyAiKig/OicnfFwiXCIpIiApOwoJCQl9CgoJCQkvLyBTdXBwb3J0OiBJRTgKCQkJLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGFuZCAidmFsdWUiIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooPzp2YWx1ZXwiICsgYm9vbGVhbnMgKyAiKSIgKTsKCQkJfQoKCQkJLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKCQkJaWYgKCAhZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIjpjaGVja2VkIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goIjpjaGVja2VkIik7CgkJCX0KCQl9KTsKCgkJYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJCS8vIFN1cHBvcnQ6IFdpbmRvd3MgOCBOYXRpdmUgQXBwcwoJCQkvLyBUaGUgdHlwZSBhbmQgbmFtZSBhdHRyaWJ1dGVzIGFyZSByZXN0cmljdGVkIGR1cmluZyAuaW5uZXJIVE1MIGFzc2lnbm1lbnQKCQkJdmFyIGlucHV0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkJCWlucHV0LnNldEF0dHJpYnV0ZSggInR5cGUiLCAiaGlkZGVuIiApOwoJCQlkaXYuYXBwZW5kQ2hpbGQoIGlucHV0ICkuc2V0QXR0cmlidXRlKCAibmFtZSIsICJEIiApOwoKCQkJLy8gU3VwcG9ydDogSUU4CgkJCS8vIEVuZm9yY2UgY2FzZS1zZW5zaXRpdml0eSBvZiBuYW1lIGF0dHJpYnV0ZQoJCQlpZiAoIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCJbbmFtZT1kXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAibmFtZSIgKyB3aGl0ZXNwYWNlICsgIipbKl4kfCF+XT89IiApOwoJCQl9CgoJCQkvLyBGRiAzLjUgLSA6ZW5hYmxlZC86ZGlzYWJsZWQgYW5kIGhpZGRlbiBlbGVtZW50cyAoaGlkZGVuIGVsZW1lbnRzIGFyZSBzdGlsbCBlbmFibGVkKQoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIjplbmFibGVkIiwgIjpkaXNhYmxlZCIgKTsKCQkJfQoKCQkJLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MKCQkJZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsKCQkJcmJ1Z2d5UVNBLnB1c2goIiwuKjoiKTsKCQl9KTsKCX0KCglpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdCggKG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwKCQlkb2NFbGVtLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKCQkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKCQkJc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCA9IG1hdGNoZXMuY2FsbCggZGl2LCAiZGl2IiApOwoKCQkJLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgoJCQkvLyBHZWNrbyBkb2VzIG5vdCBlcnJvciwgcmV0dXJucyBmYWxzZSBpbnN0ZWFkCgkJCW1hdGNoZXMuY2FsbCggZGl2LCAiW3MhPScnXTp4IiApOwoJCQlyYnVnZ3lNYXRjaGVzLnB1c2goICIhPSIsIHBzZXVkb3MgKTsKCQl9KTsKCX0KCglyYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAoIHJidWdneVFTQS5qb2luKCJ8IikgKTsKCXJidWdneU1hdGNoZXMgPSByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lNYXRjaGVzLmpvaW4oInwiKSApOwoKCS8qIENvbnRhaW5zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgloYXNDb21wYXJlID0gcm5hdGl2ZS50ZXN0KCBkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICk7CgoJLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyCgkvLyBQdXJwb3NlZnVsbHkgZG9lcyBub3QgaW1wbGVtZW50IGluY2x1c2l2ZSBkZXNjZW5kZW50CgkvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgoJY29udGFpbnMgPSBoYXNDb21wYXJlIHx8IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb250YWlucyApID8KCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJCWJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwoJCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKCQkJCWFkb3duLmNvbnRhaW5zID8KCQkJCQlhZG93bi5jb250YWlucyggYnVwICkgOgoJCQkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgoJCQkpKTsKCQl9IDoKCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJaWYgKCBiICkgewoJCQkJd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CgkJCQkJaWYgKCBiID09PSBhICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJLyogU29ydGluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKCXNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgoJCS8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCS8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24KCQl2YXIgY29tcGFyZSA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CgkJaWYgKCBjb21wYXJlICkgewoJCQlyZXR1cm4gY29tcGFyZTsKCQl9CgoJCS8vIENhbGN1bGF0ZSBwb3NpdGlvbiBpZiBib3RoIGlucHV0cyBiZWxvbmcgdG8gdGhlIHNhbWUgZG9jdW1lbnQKCQljb21wYXJlID0gKCBhLm93bmVyRG9jdW1lbnQgfHwgYSApID09PSAoIGIub3duZXJEb2N1bWVudCB8fCBiICkgPwoJCQlhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBiICkgOgoKCQkJLy8gT3RoZXJ3aXNlIHdlIGtub3cgdGhleSBhcmUgZGlzY29ubmVjdGVkCgkJCTE7CgoJCS8vIERpc2Nvbm5lY3RlZCBub2RlcwoJCWlmICggY29tcGFyZSAmIDEgfHwKCQkJKCFzdXBwb3J0LnNvcnREZXRhY2hlZCAmJiBiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBhICkgPT09IGNvbXBhcmUpICkgewoKCQkJLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CgkJCWlmICggYSA9PT0gZG9jIHx8IGEub3duZXJEb2N1bWVudCA9PT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYSkgKSB7CgkJCQlyZXR1cm4gLTE7CgkJCX0KCQkJaWYgKCBiID09PSBkb2MgfHwgYi5vd25lckRvY3VtZW50ID09PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBiKSApIHsKCQkJCXJldHVybiAxOwoJCQl9CgoJCQkvLyBNYWludGFpbiBvcmlnaW5hbCBvcmRlcgoJCQlyZXR1cm4gc29ydElucHV0ID8KCQkJCSggaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGEgKSAtIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBiICkgKSA6CgkJCQkwOwoJCX0KCgkJcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwoJfSA6CglmdW5jdGlvbiggYSwgYiApIHsKCQkvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCXZhciBjdXIsCgkJCWkgPSAwLAoJCQlhdXAgPSBhLnBhcmVudE5vZGUsCgkJCWJ1cCA9IGIucGFyZW50Tm9kZSwKCQkJYXAgPSBbIGEgXSwKCQkJYnAgPSBbIGIgXTsKCgkJLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKCQlpZiAoICFhdXAgfHwgIWJ1cCApIHsKCQkJcmV0dXJuIGEgPT09IGRvYyA/IC0xIDoKCQkJCWIgPT09IGRvYyA/IDEgOgoJCQkJYXVwID8gLTEgOgoJCQkJYnVwID8gMSA6CgkJCQlzb3J0SW5wdXQgPwoJCQkJKCBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYSApIC0gaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGIgKSApIDoKCQkJCTA7CgoJCS8vIElmIHRoZSBub2RlcyBhcmUgc2libGluZ3MsIHdlIGNhbiBkbyBhIHF1aWNrIGNoZWNrCgkJfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7CgkJCXJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKCQl9CgoJCS8vIE90aGVyd2lzZSB3ZSBuZWVkIGZ1bGwgbGlzdHMgb2YgdGhlaXIgYW5jZXN0b3JzIGZvciBjb21wYXJpc29uCgkJY3VyID0gYTsKCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7CgkJCWFwLnVuc2hpZnQoIGN1ciApOwoJCX0KCQljdXIgPSBiOwoJCXdoaWxlICggKGN1ciA9IGN1ci5wYXJlbnROb2RlKSApIHsKCQkJYnAudW5zaGlmdCggY3VyICk7CgkJfQoKCQkvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQoJCXdoaWxlICggYXBbaV0gPT09IGJwW2ldICkgewoJCQlpKys7CgkJfQoKCQlyZXR1cm4gaSA/CgkJCS8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgoJCQlzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApIDoKCgkJCS8vIE90aGVyd2lzZSBub2RlcyBpbiBvdXIgZG9jdW1lbnQgc29ydCBmaXJzdAoJCQlhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOgoJCQlicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6CgkJCTA7Cgl9OwoKCXJldHVybiBkb2M7Cn07CgpTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBlbGVtZW50cyApIHsKCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzICk7Cn07CgpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIGVsZW0sIGV4cHIgKSB7CgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKCWlmICggKCBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggZWxlbSApOwoJfQoKCS8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZAoJZXhwciA9IGV4cHIucmVwbGFjZSggcmF0dHJpYnV0ZVF1b3RlcywgIj0nJDEnXSIgKTsKCglpZiAoIHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmIGRvY3VtZW50SXNIVE1MICYmCgkJKCAhcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KCBleHByICkgKSAmJgoJCSggIXJidWdneVFTQSAgICAgfHwgIXJidWdneVFTQS50ZXN0KCBleHByICkgKSApIHsKCgkJdHJ5IHsKCQkJdmFyIHJldCA9IG1hdGNoZXMuY2FsbCggZWxlbSwgZXhwciApOwoKCQkJLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoJCQlpZiAoIHJldCB8fCBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoIHx8CgkJCQkJLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKCQkJCQkvLyBmcmFnbWVudCBpbiBJRSA5CgkJCQkJZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSApIHsKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9IGNhdGNoKGUpIHt9Cgl9CgoJcmV0dXJuIFNpenpsZSggZXhwciwgZG9jdW1lbnQsIG51bGwsIFsgZWxlbSBdICkubGVuZ3RoID4gMDsKfTsKClNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uKCBjb250ZXh0LCBlbGVtICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQgKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsKCX0KCXJldHVybiBjb250YWlucyggY29udGV4dCwgZWxlbSApOwp9OwoKU2l6emxlLmF0dHIgPSBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBlbGVtICk7Cgl9CgoJdmFyIGZuID0gRXhwci5hdHRySGFuZGxlWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSwKCQkvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykKCQl2YWwgPSBmbiAmJiBoYXNPd24uY2FsbCggRXhwci5hdHRySGFuZGxlLCBuYW1lLnRvTG93ZXJDYXNlKCkgKSA/CgkJCWZuKCBlbGVtLCBuYW1lLCAhZG9jdW1lbnRJc0hUTUwgKSA6CgkJCXVuZGVmaW5lZDsKCglyZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgPwoJCXZhbCA6CgkJc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFkb2N1bWVudElzSFRNTCA/CgkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICkgOgoJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCXZhbC52YWx1ZSA6CgkJCQludWxsOwp9OwoKU2l6emxlLmVycm9yID0gZnVuY3Rpb24oIG1zZyApIHsKCXRocm93IG5ldyBFcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cgKTsKfTsKCi8qKgogKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAqIEBwYXJhbSB7QXJyYXlMaWtlfSByZXN1bHRzCiAqLwpTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uKCByZXN1bHRzICkgewoJdmFyIGVsZW0sCgkJZHVwbGljYXRlcyA9IFtdLAoJCWogPSAwLAoJCWkgPSAwOwoKCS8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKCWhhc0R1cGxpY2F0ZSA9ICFzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXM7Cglzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoIDAgKTsKCXJlc3VsdHMuc29ydCggc29ydE9yZGVyICk7CgoJaWYgKCBoYXNEdXBsaWNhdGUgKSB7CgkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCWlmICggZWxlbSA9PT0gcmVzdWx0c1sgaSBdICkgewoJCQkJaiA9IGR1cGxpY2F0ZXMucHVzaCggaSApOwoJCQl9CgkJfQoJCXdoaWxlICggai0tICkgewoJCQlyZXN1bHRzLnNwbGljZSggZHVwbGljYXRlc1sgaiBdLCAxICk7CgkJfQoJfQoKCS8vIENsZWFyIGlucHV0IGFmdGVyIHNvcnRpbmcgdG8gcmVsZWFzZSBvYmplY3RzCgkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9zaXp6bGUvcHVsbC8yMjUKCXNvcnRJbnB1dCA9IG51bGw7CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKioKICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAqLwpnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub2RlLAoJCXJldCA9ICIiLAoJCWkgPSAwLAoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCglpZiAoICFub2RlVHlwZSApIHsKCQkvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQoJCXdoaWxlICggKG5vZGUgPSBlbGVtW2krK10pICkgewoJCQkvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwoJCQlyZXQgKz0gZ2V0VGV4dCggbm9kZSApOwoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSApIHsKCQkvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCgkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoalF1ZXJ5ICMxMTE1MykKCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CgkJfSBlbHNlIHsKCQkJLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsKCQkJfQoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgewoJCXJldHVybiBlbGVtLm5vZGVWYWx1ZTsKCX0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKCXJldHVybiByZXQ7Cn07CgpFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCgkvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKCWNhY2hlTGVuZ3RoOiA1MCwKCgljcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKCgltYXRjaDogbWF0Y2hFeHByLAoKCWF0dHJIYW5kbGU6IHt9LAoKCWZpbmQ6IHt9LAoKCXJlbGF0aXZlOiB7CgkJIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAoJCSIgIjogeyBkaXI6ICJwYXJlbnROb2RlIiB9LAoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LAoJCSJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KCX0sCgoJcHJlRmlsdGVyOiB7CgkJIkFUVFIiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCgkJCW1hdGNoWzNdID0gKCBtYXRjaFszXSB8fCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQkvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKCQkJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKCQkJCTMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCgkJCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQoJCQkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAoJCQkJNiB4IG9mIHhuLWNvbXBvbmVudAoJCQkJNyBzaWduIG9mIHktY29tcG9uZW50CgkJCQk4IHkgb2YgeS1jb21wb25lbnQKCQkJKi8KCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCBtYXRjaFsxXS5zbGljZSggMCwgMyApID09PSAibnRoIiApIHsKCQkJCS8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CgkJCQlpZiAoICFtYXRjaFszXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCgkJCQltYXRjaFs0XSA9ICsoIG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKCBtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIiApICk7CgkJCQltYXRjaFs1XSA9ICsoICggbWF0Y2hbN10gKyBtYXRjaFs4XSApIHx8IG1hdGNoWzNdID09PSAib2RkIiApOwoKCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzNdICkgewoJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJdmFyIGV4Y2VzcywKCQkJCXVucXVvdGVkID0gIW1hdGNoWzZdICYmIG1hdGNoWzJdOwoKCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQkvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwoJCQlpZiAoIG1hdGNoWzNdICkgewoJCQkJbWF0Y2hbMl0gPSBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIjsKCgkJCS8vIFN0cmlwIGV4Y2VzcyBjaGFyYWN0ZXJzIGZyb20gdW5xdW90ZWQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIHVucXVvdGVkICYmIHJwc2V1ZG8udGVzdCggdW5xdW90ZWQgKSAmJgoJCQkJLy8gR2V0IGV4Y2VzcyBmcm9tIHRva2VuaXplIChyZWN1cnNpdmVseSkKCQkJCShleGNlc3MgPSB0b2tlbml6ZSggdW5xdW90ZWQsIHRydWUgKSkgJiYKCQkJCS8vIGFkdmFuY2UgdG8gdGhlIG5leHQgY2xvc2luZyBwYXJlbnRoZXNpcwoJCQkJKGV4Y2VzcyA9IHVucXVvdGVkLmluZGV4T2YoICIpIiwgdW5xdW90ZWQubGVuZ3RoIC0gZXhjZXNzICkgLSB1bnF1b3RlZC5sZW5ndGgpICkgewoKCQkJCS8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CgkJCQltYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwLCBleGNlc3MgKTsKCQkJCW1hdGNoWzJdID0gdW5xdW90ZWQuc2xpY2UoIDAsIGV4Y2VzcyApOwoJCQl9CgoJCQkvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCAzICk7CgkJfQoJfSwKCglmaWx0ZXI6IHsKCgkJIlRBRyI6IGZ1bmN0aW9uKCBub2RlTmFtZVNlbGVjdG9yICkgewoJCQl2YXIgbm9kZU5hbWUgPSBub2RlTmFtZVNlbGVjdG9yLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICkudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIG5vZGVOYW1lU2VsZWN0b3IgPT09ICIqIiA/CgkJCQlmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH0gOgoJCQkJZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZTsKCQkJCX07CgkJfSwKCgkJIkNMQVNTIjogZnVuY3Rpb24oIGNsYXNzTmFtZSApIHsKCQkJdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlWyBjbGFzc05hbWUgKyAiICIgXTsKCgkJCXJldHVybiBwYXR0ZXJuIHx8CgkJCQkocGF0dGVybiA9IG5ldyBSZWdFeHAoICIoXnwiICsgd2hpdGVzcGFjZSArICIpIiArIGNsYXNzTmFtZSArICIoIiArIHdoaXRlc3BhY2UgKyAifCQpIiApKSAmJgoJCQkJY2xhc3NDYWNoZSggY2xhc3NOYW1lLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gcGF0dGVybi50ZXN0KCB0eXBlb2YgZWxlbS5jbGFzc05hbWUgPT09ICJzdHJpbmciICYmIGVsZW0uY2xhc3NOYW1lIHx8IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gc3RydW5kZWZpbmVkICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiICk7CgkJCQl9KTsKCQl9LAoKCQkiQVRUUiI6IGZ1bmN0aW9uKCBuYW1lLCBvcGVyYXRvciwgY2hlY2sgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciByZXN1bHQgPSBTaXp6bGUuYXR0ciggZWxlbSwgbmFtZSApOwoKCQkJCWlmICggcmVzdWx0ID09IG51bGwgKSB7CgkJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiIT0iOwoJCQkJfQoJCQkJaWYgKCAhb3BlcmF0b3IgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgoJCQkJcmVzdWx0ICs9ICIiOwoKCQkJCXJldHVybiBvcGVyYXRvciA9PT0gIj0iID8gcmVzdWx0ID09PSBjaGVjayA6CgkJCQkJb3BlcmF0b3IgPT09ICIhPSIgPyByZXN1bHQgIT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIl49IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKCBjaGVjayApID09PSAwIDoKCQkJCQlvcGVyYXRvciA9PT0gIio9IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKCBjaGVjayApID4gLTEgOgoJCQkJCW9wZXJhdG9yID09PSAiJD0iID8gY2hlY2sgJiYgcmVzdWx0LnNsaWNlKCAtY2hlY2subGVuZ3RoICkgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIn49IiA/ICggIiAiICsgcmVzdWx0ICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKCQkJCQlvcGVyYXRvciA9PT0gInw9IiA/IHJlc3VsdCA9PT0gY2hlY2sgfHwgcmVzdWx0LnNsaWNlKCAwLCBjaGVjay5sZW5ndGggKyAxICkgPT09IGNoZWNrICsgIi0iIDoKCQkJCQlmYWxzZTsKCQkJfTsKCQl9LAoKCQkiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0ICkgewoJCQl2YXIgc2ltcGxlID0gdHlwZS5zbGljZSggMCwgMyApICE9PSAibnRoIiwKCQkJCWZvcndhcmQgPSB0eXBlLnNsaWNlKCAtNCApICE9PSAibGFzdCIsCgkJCQlvZlR5cGUgPSB3aGF0ID09PSAib2YtdHlwZSI7CgoJCQlyZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/CgoJCQkJLy8gU2hvcnRjdXQgZm9yIDpudGgtKihuKQoJCQkJZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuICEhZWxlbS5wYXJlbnROb2RlOwoJCQkJfSA6CgoJCQkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJCQl2YXIgY2FjaGUsIG91dGVyQ2FjaGUsIG5vZGUsIGRpZmYsIG5vZGVJbmRleCwgc3RhcnQsCgkJCQkJCWRpciA9IHNpbXBsZSAhPT0gZm9yd2FyZCA/ICJuZXh0U2libGluZyIgOiAicHJldmlvdXNTaWJsaW5nIiwKCQkJCQkJcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlLAoJCQkJCQluYW1lID0gb2ZUeXBlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJCQkJdXNlQ2FjaGUgPSAheG1sICYmICFvZlR5cGU7CgoJCQkJCWlmICggcGFyZW50ICkgewoKCQkJCQkJLy8gOihmaXJzdHxsYXN0fG9ubHkpLShjaGlsZHxvZi10eXBlKQoJCQkJCQlpZiAoIHNpbXBsZSApIHsKCQkJCQkJCXdoaWxlICggZGlyICkgewoJCQkJCQkJCW5vZGUgPSBlbGVtOwoJCQkJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlWyBkaXIgXSkgKSB7CgkJCQkJCQkJCWlmICggb2ZUeXBlID8gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDogbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCQkJCQkJCQkvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykKCQkJCQkJCQlzdGFydCA9IGRpciA9IHR5cGUgPT09ICJvbmx5IiAmJiAhc3RhcnQgJiYgIm5leHRTaWJsaW5nIjsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQl9CgoJCQkJCQlzdGFydCA9IFsgZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZCBdOwoKCQkJCQkJLy8gbm9uLXhtbCA6bnRoLWNoaWxkKC4uLikgc3RvcmVzIGNhY2hlIGRhdGEgb24gYHBhcmVudGAKCQkJCQkJaWYgKCBmb3J3YXJkICYmIHVzZUNhY2hlICkgewoJCQkJCQkJLy8gU2VlayBgZWxlbWAgZnJvbSBhIHByZXZpb3VzbHktY2FjaGVkIGluZGV4CgkJCQkJCQlvdXRlckNhY2hlID0gcGFyZW50WyBleHBhbmRvIF0gfHwgKHBhcmVudFsgZXhwYW5kbyBdID0ge30pOwoJCQkJCQkJY2FjaGUgPSBvdXRlckNhY2hlWyB0eXBlIF0gfHwgW107CgkJCQkJCQlub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKCQkJCQkJCWRpZmYgPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsyXTsKCQkJCQkJCW5vZGUgPSBub2RlSW5kZXggJiYgcGFyZW50LmNoaWxkTm9kZXNbIG5vZGVJbmRleCBdOwoKCQkJCQkJCXdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8CgoJCQkJCQkJCS8vIEZhbGxiYWNrIHRvIHNlZWtpbmcgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CgkJCQkJCQkJKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgKSB7CgoJCQkJCQkJCS8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCgkJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICYmICsrZGlmZiAmJiBub2RlID09PSBlbGVtICkgewoJCQkJCQkJCQlvdXRlckNhY2hlWyB0eXBlIF0gPSBbIGRpcnJ1bnMsIG5vZGVJbmRleCwgZGlmZiBdOwoJCQkJCQkJCQlicmVhazsKCQkJCQkJCQl9CgkJCQkJCQl9CgoJCQkJCQkvLyBVc2UgcHJldmlvdXNseS1jYWNoZWQgZWxlbWVudCBpbmRleCBpZiBhdmFpbGFibGUKCQkJCQkJfSBlbHNlIGlmICggdXNlQ2FjaGUgJiYgKGNhY2hlID0gKGVsZW1bIGV4cGFuZG8gXSB8fCAoZWxlbVsgZXhwYW5kbyBdID0ge30pKVsgdHlwZSBdKSAmJiBjYWNoZVswXSA9PT0gZGlycnVucyApIHsKCQkJCQkJCWRpZmYgPSBjYWNoZVsxXTsKCgkJCQkJCS8vIHhtbCA6bnRoLWNoaWxkKC4uLikgb3IgOm50aC1sYXN0LWNoaWxkKC4uLikgb3IgOm50aCgtbGFzdCk/LW9mLXR5cGUoLi4uKQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gVXNlIHRoZSBzYW1lIGxvb3AgYXMgYWJvdmUgdG8gc2VlayBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKCQkJCQkJCXdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8CgkJCQkJCQkJKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgKSB7CgoJCQkJCQkJCWlmICggKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgJiYgKytkaWZmICkgewoJCQkJCQkJCQkvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CgkJCQkJCQkJCWlmICggdXNlQ2FjaGUgKSB7CgkJCQkJCQkJCQkobm9kZVsgZXhwYW5kbyBdIHx8IChub2RlWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0gPSBbIGRpcnJ1bnMsIGRpZmYgXTsKCQkJCQkJCQkJfQoKCQkJCQkJCQkJaWYgKCBub2RlID09PSBlbGVtICkgewoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCgkJCQkJCS8vIEluY29ycG9yYXRlIHRoZSBvZmZzZXQsIHRoZW4gY2hlY2sgYWdhaW5zdCBjeWNsZSBzaXplCgkJCQkJCWRpZmYgLT0gbGFzdDsKCQkJCQkJcmV0dXJuIGRpZmYgPT09IGZpcnN0IHx8ICggZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwICk7CgkJCQkJfQoJCQkJfTsKCQl9LAoKCQkiUFNFVURPIjogZnVuY3Rpb24oIHBzZXVkbywgYXJndW1lbnQgKSB7CgkJCS8vIHBzZXVkby1jbGFzcyBuYW1lcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZQoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI3BzZXVkby1jbGFzc2VzCgkJCS8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzCgkJCS8vIFJlbWVtYmVyIHRoYXQgc2V0RmlsdGVycyBpbmhlcml0cyBmcm9tIHBzZXVkb3MKCQkJdmFyIGFyZ3MsCgkJCQlmbiA9IEV4cHIucHNldWRvc1sgcHNldWRvIF0gfHwgRXhwci5zZXRGaWx0ZXJzWyBwc2V1ZG8udG9Mb3dlckNhc2UoKSBdIHx8CgkJCQkJU2l6emxlLmVycm9yKCAidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgcHNldWRvICk7CgoJCQkvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0CgkJCS8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCgkJCS8vIGp1c3QgYXMgU2l6emxlIGRvZXMKCQkJaWYgKCBmblsgZXhwYW5kbyBdICkgewoJCQkJcmV0dXJuIGZuKCBhcmd1bWVudCApOwoJCQl9CgoJCQkvLyBCdXQgbWFpbnRhaW4gc3VwcG9ydCBmb3Igb2xkIHNpZ25hdHVyZXMKCQkJaWYgKCBmbi5sZW5ndGggPiAxICkgewoJCQkJYXJncyA9IFsgcHNldWRvLCBwc2V1ZG8sICIiLCBhcmd1bWVudCBdOwoJCQkJcmV0dXJuIEV4cHIuc2V0RmlsdGVycy5oYXNPd25Qcm9wZXJ0eSggcHNldWRvLnRvTG93ZXJDYXNlKCkgKSA/CgkJCQkJbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWVkLCBtYXRjaGVzICkgewoJCQkJCQl2YXIgaWR4LAoJCQkJCQkJbWF0Y2hlZCA9IGZuKCBzZWVkLCBhcmd1bWVudCApLAoJCQkJCQkJaSA9IG1hdGNoZWQubGVuZ3RoOwoJCQkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQkJCWlkeCA9IGluZGV4T2YuY2FsbCggc2VlZCwgbWF0Y2hlZFtpXSApOwoJCQkJCQkJc2VlZFsgaWR4IF0gPSAhKCBtYXRjaGVzWyBpZHggXSA9IG1hdGNoZWRbaV0gKTsKCQkJCQkJfQoJCQkJCX0pIDoKCQkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQkJcmV0dXJuIGZuKCBlbGVtLCAwLCBhcmdzICk7CgkJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIGZuOwoJCX0KCX0sCgoJcHNldWRvczogewoJCS8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwoJCSJub3QiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCQkvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQoJCQkvLyB0byBhdm9pZCB0cmVhdGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZwoJCQkvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMKCQkJdmFyIGlucHV0ID0gW10sCgkJCQlyZXN1bHRzID0gW10sCgkJCQltYXRjaGVyID0gY29tcGlsZSggc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKSApOwoKCQkJcmV0dXJuIG1hdGNoZXJbIGV4cGFuZG8gXSA/CgkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMsIGNvbnRleHQsIHhtbCApIHsKCQkJCQl2YXIgZWxlbSwKCQkJCQkJdW5tYXRjaGVkID0gbWF0Y2hlciggc2VlZCwgbnVsbCwgeG1sLCBbXSApLAoJCQkJCQlpID0gc2VlZC5sZW5ndGg7CgoJCQkJCS8vIE1hdGNoIGVsZW1lbnRzIHVubWF0Y2hlZCBieSBgbWF0Y2hlcmAKCQkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQkJaWYgKCAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgKSB7CgkJCQkJCQlzZWVkW2ldID0gIShtYXRjaGVzW2ldID0gZWxlbSk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KSA6CgkJCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQkJCWlucHV0WzBdID0gZWxlbTsKCQkJCQltYXRjaGVyKCBpbnB1dCwgbnVsbCwgeG1sLCByZXN1bHRzICk7CgkJCQkJcmV0dXJuICFyZXN1bHRzLnBvcCgpOwoJCQkJfTsKCQl9KSwKCgkJImhhcyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiBTaXp6bGUoIHNlbGVjdG9yLCBlbGVtICkubGVuZ3RoID4gMDsKCQkJfTsKCQl9KSwKCgkJImNvbnRhaW5zIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCB0ZXh0ICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gKCBlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IGdldFRleHQoIGVsZW0gKSApLmluZGV4T2YoIHRleHQgKSA+IC0xOwoJCQl9OwoJCX0pLAoKCQkvLyAiV2hldGhlciBhbiBlbGVtZW50IGlzIHJlcHJlc2VudGVkIGJ5IGEgOmxhbmcoKSBzZWxlY3RvcgoJCS8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCgkJLy8gYmVpbmcgZXF1YWwgdG8gdGhlIGlkZW50aWZpZXIgQywKCQkvLyBvciBiZWdpbm5pbmcgd2l0aCB0aGUgaWRlbnRpZmllciBDIGltbWVkaWF0ZWx5IGZvbGxvd2VkIGJ5ICItIi4KCQkvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KCQkvLyBUaGUgaWRlbnRpZmllciBDIGRvZXMgbm90IGhhdmUgdG8gYmUgYSB2YWxpZCBsYW5ndWFnZSBuYW1lLiIKCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2xhbmctcHNldWRvCgkJImxhbmciOiBtYXJrRnVuY3Rpb24oIGZ1bmN0aW9uKCBsYW5nICkgewoJCQkvLyBsYW5nIHZhbHVlIG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWVyCgkJCWlmICggIXJpZGVudGlmaWVyLnRlc3QobGFuZyB8fCAiIikgKSB7CgkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBsYW5nOiAiICsgbGFuZyApOwoJCQl9CgkJCWxhbmcgPSBsYW5nLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICkudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIGVsZW1MYW5nOwoJCQkJZG8gewoJCQkJCWlmICggKGVsZW1MYW5nID0gZG9jdW1lbnRJc0hUTUwgPwoJCQkJCQllbGVtLmxhbmcgOgoJCQkJCQllbGVtLmdldEF0dHJpYnV0ZSgieG1sOmxhbmciKSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgibGFuZyIpKSApIHsKCgkJCQkJCWVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsKCQkJCQkJcmV0dXJuIGVsZW1MYW5nID09PSBsYW5nIHx8IGVsZW1MYW5nLmluZGV4T2YoIGxhbmcgKyAiLSIgKSA9PT0gMDsKCQkJCQl9CgkJCQl9IHdoaWxlICggKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfTsKCQl9KSwKCgkJLy8gTWlzY2VsbGFuZW91cwoJCSJ0YXJnZXQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhhc2g7CgkJCXJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoIDEgKSA9PT0gZWxlbS5pZDsKCQl9LAoKCQkicm9vdCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jRWxlbTsKCQl9LAoKCQkiZm9jdXMiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgKCFkb2N1bWVudC5oYXNGb2N1cyB8fCBkb2N1bWVudC5oYXNGb2N1cygpKSAmJiAhIShlbGVtLnR5cGUgfHwgZWxlbS5ocmVmIHx8IH5lbGVtLnRhYkluZGV4KTsKCQl9LAoKCQkvLyBCb29sZWFuIHByb3BlcnRpZXMKCQkiZW5hYmxlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2U7CgkJfSwKCgkJImRpc2FibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlOwoJCX0sCgoJCSJjaGVja2VkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIEluIENTUzMsIDpjaGVja2VkIHNob3VsZCByZXR1cm4gYm90aCBjaGVja2VkIGFuZCBzZWxlY3RlZCBlbGVtZW50cwoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAoJCQl2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgISFlbGVtLmNoZWNrZWQpIHx8IChub2RlTmFtZSA9PT0gIm9wdGlvbiIgJiYgISFlbGVtLnNlbGVjdGVkKTsKCQl9LAoKCQkic2VsZWN0ZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdAoJCQkvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CgkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgewoJCQkJZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCX0KCgkJCXJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwoJCX0sCgoJCS8vIENvbnRlbnRzCgkJImVtcHR5IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCgkJCS8vIDplbXB0eSBpcyBuZWdhdGVkIGJ5IGVsZW1lbnQgKDEpIG9yIGNvbnRlbnQgbm9kZXMgKHRleHQ6IDM7IGNkYXRhOiA0OyBlbnRpdHkgcmVmOiA1KSwKCQkJLy8gICBidXQgbm90IGJ5IG90aGVycyAoY29tbWVudDogODsgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbjogNzsgZXRjLikKCQkJLy8gbm9kZVR5cGUgPCA2IHdvcmtzIGJlY2F1c2UgYXR0cmlidXRlcyAoMikgZG8gbm90IGFwcGVhciBhcyBjaGlsZHJlbgoJCQlmb3IgKCBlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZyApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA8IDYgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCSJwYXJlbnQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICFFeHByLnBzZXVkb3NbImVtcHR5Il0oIGVsZW0gKTsKCQl9LAoKCQkvLyBFbGVtZW50L2lucHV0IHR5cGVzCgkJImhlYWRlciI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gcmhlYWRlci50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCgkJImlucHV0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaW5wdXRzLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiYnV0dG9uIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJidXR0b24iIHx8IG5hbWUgPT09ICJidXR0b24iOwoJCX0sCgoJCSJ0ZXh0IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBhdHRyOwoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmCgkJCQllbGVtLnR5cGUgPT09ICJ0ZXh0IiAmJgoKCQkJCS8vIFN1cHBvcnQ6IElFPDgKCQkJCS8vIE5ldyBIVE1MNSBhdHRyaWJ1dGUgdmFsdWVzIChlLmcuLCAic2VhcmNoIikgYXBwZWFyIHdpdGggZWxlbS50eXBlID09PSAidGV4dCIKCQkJCSggKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gInRleHQiICk7CgkJfSwKCgkJLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgoJCSJmaXJzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oKSB7CgkJCXJldHVybiBbIDAgXTsKCQl9KSwKCgkJImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJcmV0dXJuIFsgbGVuZ3RoIC0gMSBdOwoJCX0pLAoKCQkiZXEiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXJldHVybiBbIGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQgXTsKCQl9KSwKCgkJImV2ZW4iOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJIm9kZCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQl2YXIgaSA9IDE7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKCQkJZm9yICggOyAtLWkgPj0gMDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSksCgoJCSJndCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwoJCQlmb3IgKCA7ICsraSA8IGxlbmd0aDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSkKCX0KfTsKCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgovLyBBZGQgYnV0dG9uL2lucHV0IHR5cGUgcHNldWRvcwpmb3IgKCBpIGluIHsgcmFkaW86IHRydWUsIGNoZWNrYm94OiB0cnVlLCBmaWxlOiB0cnVlLCBwYXNzd29yZDogdHJ1ZSwgaW1hZ2U6IHRydWUgfSApIHsKCUV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlSW5wdXRQc2V1ZG8oIGkgKTsKfQpmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCByZXNldDogdHJ1ZSB9ICkgewoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oIGkgKTsKfQoKLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCmZ1bmN0aW9uIHNldEZpbHRlcnMoKSB7fQpzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKRXhwci5zZXRGaWx0ZXJzID0gbmV3IHNldEZpbHRlcnMoKTsKCnRva2VuaXplID0gU2l6emxlLnRva2VuaXplID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBwYXJzZU9ubHkgKSB7Cgl2YXIgbWF0Y2hlZCwgbWF0Y2gsIHRva2VucywgdHlwZSwKCQlzb0ZhciwgZ3JvdXBzLCBwcmVGaWx0ZXJzLAoJCWNhY2hlZCA9IHRva2VuQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCBjYWNoZWQgKSB7CgkJcmV0dXJuIHBhcnNlT25seSA/IDAgOiBjYWNoZWQuc2xpY2UoIDAgKTsKCX0KCglzb0ZhciA9IHNlbGVjdG9yOwoJZ3JvdXBzID0gW107CglwcmVGaWx0ZXJzID0gRXhwci5wcmVGaWx0ZXI7CgoJd2hpbGUgKCBzb0ZhciApIHsKCgkJLy8gQ29tbWEgYW5kIGZpcnN0IHJ1bgoJCWlmICggIW1hdGNoZWQgfHwgKG1hdGNoID0gcmNvbW1hLmV4ZWMoIHNvRmFyICkpICkgewoJCQlpZiAoIG1hdGNoICkgewoJCQkJLy8gRG9uJ3QgY29uc3VtZSB0cmFpbGluZyBjb21tYXMgYXMgdmFsaWQKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoWzBdLmxlbmd0aCApIHx8IHNvRmFyOwoJCQl9CgkJCWdyb3Vwcy5wdXNoKCAodG9rZW5zID0gW10pICk7CgkJfQoKCQltYXRjaGVkID0gZmFsc2U7CgoJCS8vIENvbWJpbmF0b3JzCgkJaWYgKCAobWF0Y2ggPSByY29tYmluYXRvcnMuZXhlYyggc29GYXIgKSkgKSB7CgkJCW1hdGNoZWQgPSBtYXRjaC5zaGlmdCgpOwoJCQl0b2tlbnMucHVzaCh7CgkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCS8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQoJCQkJdHlwZTogbWF0Y2hbMF0ucmVwbGFjZSggcnRyaW0sICIgIiApCgkJCX0pOwoJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOwoJCX0KCgkJLy8gRmlsdGVycwoJCWZvciAoIHR5cGUgaW4gRXhwci5maWx0ZXIgKSB7CgkJCWlmICggKG1hdGNoID0gbWF0Y2hFeHByWyB0eXBlIF0uZXhlYyggc29GYXIgKSkgJiYgKCFwcmVGaWx0ZXJzWyB0eXBlIF0gfHwKCQkJCShtYXRjaCA9IHByZUZpbHRlcnNbIHR5cGUgXSggbWF0Y2ggKSkpICkgewoJCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCQl0b2tlbnMucHVzaCh7CgkJCQkJdmFsdWU6IG1hdGNoZWQsCgkJCQkJdHlwZTogdHlwZSwKCQkJCQltYXRjaGVzOiBtYXRjaAoJCQkJfSk7CgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaGVkLmxlbmd0aCApOwoJCQl9CgkJfQoKCQlpZiAoICFtYXRjaGVkICkgewoJCQlicmVhazsKCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCgkvLyBpZiB3ZSdyZSBqdXN0IHBhcnNpbmcKCS8vIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3Igb3IgcmV0dXJuIHRva2VucwoJcmV0dXJuIHBhcnNlT25seSA/CgkJc29GYXIubGVuZ3RoIDoKCQlzb0ZhciA/CgkJCVNpenpsZS5lcnJvciggc2VsZWN0b3IgKSA6CgkJCS8vIENhY2hlIHRoZSB0b2tlbnMKCQkJdG9rZW5DYWNoZSggc2VsZWN0b3IsIGdyb3VwcyApLnNsaWNlKCAwICk7Cn07CgpmdW5jdGlvbiB0b1NlbGVjdG9yKCB0b2tlbnMgKSB7Cgl2YXIgaSA9IDAsCgkJbGVuID0gdG9rZW5zLmxlbmd0aCwKCQlzZWxlY3RvciA9ICIiOwoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJc2VsZWN0b3IgKz0gdG9rZW5zW2ldLnZhbHVlOwoJfQoJcmV0dXJuIHNlbGVjdG9yOwp9CgpmdW5jdGlvbiBhZGRDb21iaW5hdG9yKCBtYXRjaGVyLCBjb21iaW5hdG9yLCBiYXNlICkgewoJdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLAoJCWNoZWNrTm9uRWxlbWVudHMgPSBiYXNlICYmIGRpciA9PT0gInBhcmVudE5vZGUiLAoJCWRvbmVOYW1lID0gZG9uZSsrOwoKCXJldHVybiBjb21iaW5hdG9yLmZpcnN0ID8KCQkvLyBDaGVjayBhZ2FpbnN0IGNsb3Nlc3QgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnQKCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJcmV0dXJuIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApOwoJCQkJfQoJCQl9CgkJfSA6CgoJCS8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCXZhciBvbGRDYWNoZSwgb3V0ZXJDYWNoZSwKCQkJCW5ld0NhY2hlID0gWyBkaXJydW5zLCBkb25lTmFtZSBdOwoKCQkJLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gZGlyIGNhY2hpbmcKCQkJaWYgKCB4bWwgKSB7CgkJCQl3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewoJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCQlpZiAoIG1hdGNoZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQl3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICkgewoJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCQlvdXRlckNhY2hlID0gZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSk7CgkJCQkJCWlmICggKG9sZENhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0pICYmCgkJCQkJCQlvbGRDYWNoZVsgMCBdID09PSBkaXJydW5zICYmIG9sZENhY2hlWyAxIF0gPT09IGRvbmVOYW1lICkgewoKCQkJCQkJCS8vIEFzc2lnbiB0byBuZXdDYWNoZSBzbyByZXN1bHRzIGJhY2stcHJvcGFnYXRlIHRvIHByZXZpb3VzIGVsZW1lbnRzCgkJCQkJCQlyZXR1cm4gKG5ld0NhY2hlWyAyIF0gPSBvbGRDYWNoZVsgMiBdKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIFJldXNlIG5ld2NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKCQkJCQkJCW91dGVyQ2FjaGVbIGRpciBdID0gbmV3Q2FjaGU7CgoJCQkJCQkJLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nCgkJCQkJCQlpZiAoIChuZXdDYWNoZVsgMiBdID0gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkpICkgewoJCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfTsKfQoKZnVuY3Rpb24gZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICkgewoJcmV0dXJuIG1hdGNoZXJzLmxlbmd0aCA+IDEgPwoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCXZhciBpID0gbWF0Y2hlcnMubGVuZ3RoOwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWlmICggIW1hdGNoZXJzW2ldKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSA6CgkJbWF0Y2hlcnNbMF07Cn0KCmZ1bmN0aW9uIG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yLCBjb250ZXh0cywgcmVzdWx0cyApIHsKCXZhciBpID0gMCwKCQlsZW4gPSBjb250ZXh0cy5sZW5ndGg7Cglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlTaXp6bGUoIHNlbGVjdG9yLCBjb250ZXh0c1tpXSwgcmVzdWx0cyApOwoJfQoJcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIGNvbmRlbnNlKCB1bm1hdGNoZWQsIG1hcCwgZmlsdGVyLCBjb250ZXh0LCB4bWwgKSB7Cgl2YXIgZWxlbSwKCQluZXdVbm1hdGNoZWQgPSBbXSwKCQlpID0gMCwKCQlsZW4gPSB1bm1hdGNoZWQubGVuZ3RoLAoJCW1hcHBlZCA9IG1hcCAhPSBudWxsOwoKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCWlmICggKGVsZW0gPSB1bm1hdGNoZWRbaV0pICkgewoJCQlpZiAoICFmaWx0ZXIgfHwgZmlsdGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCW5ld1VubWF0Y2hlZC5wdXNoKCBlbGVtICk7CgkJCQlpZiAoIG1hcHBlZCApIHsKCQkJCQltYXAucHVzaCggaSApOwoJCQkJfQoJCQl9CgkJfQoJfQoKCXJldHVybiBuZXdVbm1hdGNoZWQ7Cn0KCmZ1bmN0aW9uIHNldE1hdGNoZXIoIHByZUZpbHRlciwgc2VsZWN0b3IsIG1hdGNoZXIsIHBvc3RGaWx0ZXIsIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvciApIHsKCWlmICggcG9zdEZpbHRlciAmJiAhcG9zdEZpbHRlclsgZXhwYW5kbyBdICkgewoJCXBvc3RGaWx0ZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmlsdGVyICk7Cgl9CglpZiAoIHBvc3RGaW5kZXIgJiYgIXBvc3RGaW5kZXJbIGV4cGFuZG8gXSApIHsKCQlwb3N0RmluZGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yICk7Cgl9CglyZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWVkLCByZXN1bHRzLCBjb250ZXh0LCB4bWwgKSB7CgkJdmFyIHRlbXAsIGksIGVsZW0sCgkJCXByZU1hcCA9IFtdLAoJCQlwb3N0TWFwID0gW10sCgkJCXByZWV4aXN0aW5nID0gcmVzdWx0cy5sZW5ndGgsCgoJCQkvLyBHZXQgaW5pdGlhbCBlbGVtZW50cyBmcm9tIHNlZWQgb3IgY29udGV4dAoJCQllbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IgfHwgIioiLCBjb250ZXh0Lm5vZGVUeXBlID8gWyBjb250ZXh0IF0gOiBjb250ZXh0LCBbXSApLAoKCQkJLy8gUHJlZmlsdGVyIHRvIGdldCBtYXRjaGVyIGlucHV0LCBwcmVzZXJ2aW5nIGEgbWFwIGZvciBzZWVkLXJlc3VsdHMgc3luY2hyb25pemF0aW9uCgkJCW1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoIHNlZWQgfHwgIXNlbGVjdG9yICkgPwoJCQkJY29uZGVuc2UoIGVsZW1zLCBwcmVNYXAsIHByZUZpbHRlciwgY29udGV4dCwgeG1sICkgOgoJCQkJZWxlbXMsCgoJCQltYXRjaGVyT3V0ID0gbWF0Y2hlciA/CgkJCQkvLyBJZiB3ZSBoYXZlIGEgcG9zdEZpbmRlciwgb3IgZmlsdGVyZWQgc2VlZCwgb3Igbm9uLXNlZWQgcG9zdEZpbHRlciBvciBwcmVleGlzdGluZyByZXN1bHRzLAoJCQkJcG9zdEZpbmRlciB8fCAoIHNlZWQgPyBwcmVGaWx0ZXIgOiBwcmVleGlzdGluZyB8fCBwb3N0RmlsdGVyICkgPwoKCQkJCQkvLyAuLi5pbnRlcm1lZGlhdGUgcHJvY2Vzc2luZyBpcyBuZWNlc3NhcnkKCQkJCQlbXSA6CgoJCQkJCS8vIC4uLm90aGVyd2lzZSB1c2UgcmVzdWx0cyBkaXJlY3RseQoJCQkJCXJlc3VsdHMgOgoJCQkJbWF0Y2hlckluOwoKCQkvLyBGaW5kIHByaW1hcnkgbWF0Y2hlcwoJCWlmICggbWF0Y2hlciApIHsKCQkJbWF0Y2hlciggbWF0Y2hlckluLCBtYXRjaGVyT3V0LCBjb250ZXh0LCB4bWwgKTsKCQl9CgoJCS8vIEFwcGx5IHBvc3RGaWx0ZXIKCQlpZiAoIHBvc3RGaWx0ZXIgKSB7CgkJCXRlbXAgPSBjb25kZW5zZSggbWF0Y2hlck91dCwgcG9zdE1hcCApOwoJCQlwb3N0RmlsdGVyKCB0ZW1wLCBbXSwgY29udGV4dCwgeG1sICk7CgoJCQkvLyBVbi1tYXRjaCBmYWlsaW5nIGVsZW1lbnRzIGJ5IG1vdmluZyB0aGVtIGJhY2sgdG8gbWF0Y2hlckluCgkJCWkgPSB0ZW1wLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoIChlbGVtID0gdGVtcFtpXSkgKSB7CgkJCQkJbWF0Y2hlck91dFsgcG9zdE1hcFtpXSBdID0gIShtYXRjaGVySW5bIHBvc3RNYXBbaV0gXSA9IGVsZW0pOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoIHNlZWQgKSB7CgkJCWlmICggcG9zdEZpbmRlciB8fCBwcmVGaWx0ZXIgKSB7CgkJCQlpZiAoIHBvc3RGaW5kZXIgKSB7CgkJCQkJLy8gR2V0IHRoZSBmaW5hbCBtYXRjaGVyT3V0IGJ5IGNvbmRlbnNpbmcgdGhpcyBpbnRlcm1lZGlhdGUgaW50byBwb3N0RmluZGVyIGNvbnRleHRzCgkJCQkJdGVtcCA9IFtdOwoJCQkJCWkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKCQkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQkJaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICkgewoJCQkJCQkJLy8gUmVzdG9yZSBtYXRjaGVySW4gc2luY2UgZWxlbSBpcyBub3QgeWV0IGEgZmluYWwgbWF0Y2gKCQkJCQkJCXRlbXAucHVzaCggKG1hdGNoZXJJbltpXSA9IGVsZW0pICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcG9zdEZpbmRlciggbnVsbCwgKG1hdGNoZXJPdXQgPSBbXSksIHRlbXAsIHhtbCApOwoJCQkJfQoKCQkJCS8vIE1vdmUgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHNlZWQgdG8gcmVzdWx0cyB0byBrZWVwIHRoZW0gc3luY2hyb25pemVkCgkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7CgkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQlpZiAoIChlbGVtID0gbWF0Y2hlck91dFtpXSkgJiYKCQkJCQkJKHRlbXAgPSBwb3N0RmluZGVyID8gaW5kZXhPZi5jYWxsKCBzZWVkLCBlbGVtICkgOiBwcmVNYXBbaV0pID4gLTEgKSB7CgoJCQkJCQlzZWVkW3RlbXBdID0gIShyZXN1bHRzW3RlbXBdID0gZWxlbSk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEFkZCBlbGVtZW50cyB0byByZXN1bHRzLCB0aHJvdWdoIHBvc3RGaW5kZXIgaWYgZGVmaW5lZAoJCX0gZWxzZSB7CgkJCW1hdGNoZXJPdXQgPSBjb25kZW5zZSgKCQkJCW1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPwoJCQkJCW1hdGNoZXJPdXQuc3BsaWNlKCBwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGggKSA6CgkJCQkJbWF0Y2hlck91dAoJCQkpOwoJCQlpZiAoIHBvc3RGaW5kZXIgKSB7CgkJCQlwb3N0RmluZGVyKCBudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIG1hdGNoZXJPdXQgKTsKCQkJfQoJCX0KCX0pOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zICkgewoJdmFyIGNoZWNrQ29udGV4dCwgbWF0Y2hlciwgaiwKCQlsZW4gPSB0b2tlbnMubGVuZ3RoLAoJCWxlYWRpbmdSZWxhdGl2ZSA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1swXS50eXBlIF0sCgkJaW1wbGljaXRSZWxhdGl2ZSA9IGxlYWRpbmdSZWxhdGl2ZSB8fCBFeHByLnJlbGF0aXZlWyIgIl0sCgkJaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAoKCQkvLyBUaGUgZm91bmRhdGlvbmFsIG1hdGNoZXIgZW5zdXJlcyB0aGF0IGVsZW1lbnRzIGFyZSByZWFjaGFibGUgZnJvbSB0b3AtbGV2ZWwgY29udGV4dChzKQoJCW1hdGNoQ29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwoJCX0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwKCQltYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGluZGV4T2YuY2FsbCggY2hlY2tDb250ZXh0LCBlbGVtICkgPiAtMTsKCQl9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlICksCgkJbWF0Y2hlcnMgPSBbIGZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCXJldHVybiAoICFsZWFkaW5nUmVsYXRpdmUgJiYgKCB4bWwgfHwgY29udGV4dCAhPT0gb3V0ZXJtb3N0Q29udGV4dCApICkgfHwgKAoJCQkJKGNoZWNrQ29udGV4dCA9IGNvbnRleHQpLm5vZGVUeXBlID8KCQkJCQltYXRjaENvbnRleHQoIGVsZW0sIGNvbnRleHQsIHhtbCApIDoKCQkJCQltYXRjaEFueUNvbnRleHQoIGVsZW0sIGNvbnRleHQsIHhtbCApICk7CgkJfSBdOwoKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCWlmICggKG1hdGNoZXIgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbaV0udHlwZSBdKSApIHsKCQkJbWF0Y2hlcnMgPSBbIGFkZENvbWJpbmF0b3IoZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksIG1hdGNoZXIpIF07CgkJfSBlbHNlIHsKCQkJbWF0Y2hlciA9IEV4cHIuZmlsdGVyWyB0b2tlbnNbaV0udHlwZSBdLmFwcGx5KCBudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyApOwoKCQkJLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKCQkJaWYgKCBtYXRjaGVyWyBleHBhbmRvIF0gKSB7CgkJCQkvLyBGaW5kIHRoZSBuZXh0IHJlbGF0aXZlIG9wZXJhdG9yIChpZiBhbnkpIGZvciBwcm9wZXIgaGFuZGxpbmcKCQkJCWogPSArK2k7CgkJCQlmb3IgKCA7IGogPCBsZW47IGorKyApIHsKCQkJCQlpZiAoIEV4cHIucmVsYXRpdmVbIHRva2Vuc1tqXS50eXBlIF0gKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBzZXRNYXRjaGVyKAoJCQkJCWkgPiAxICYmIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLAoJCQkJCWkgPiAxICYmIHRvU2VsZWN0b3IoCgkJCQkJCS8vIElmIHRoZSBwcmVjZWRpbmcgdG9rZW4gd2FzIGEgZGVzY2VuZGFudCBjb21iaW5hdG9yLCBpbnNlcnQgYW4gaW1wbGljaXQgYW55LWVsZW1lbnQgYCpgCgkJCQkJCXRva2Vucy5zbGljZSggMCwgaSAtIDEgKS5jb25jYXQoeyB2YWx1ZTogdG9rZW5zWyBpIC0gMiBdLnR5cGUgPT09ICIgIiA/ICIqIiA6ICIiIH0pCgkJCQkJKS5yZXBsYWNlKCBydHJpbSwgIiQxIiApLAoJCQkJCW1hdGNoZXIsCgkJCQkJaSA8IGogJiYgbWF0Y2hlckZyb21Ub2tlbnMoIHRva2Vucy5zbGljZSggaSwgaiApICksCgkJCQkJaiA8IGxlbiAmJiBtYXRjaGVyRnJvbVRva2VucyggKHRva2VucyA9IHRva2Vucy5zbGljZSggaiApKSApLAoJCQkJCWogPCBsZW4gJiYgdG9TZWxlY3RvciggdG9rZW5zICkKCQkJCSk7CgkJCX0KCQkJbWF0Y2hlcnMucHVzaCggbWF0Y2hlciApOwoJCX0KCX0KCglyZXR1cm4gZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICk7Cn0KCmZ1bmN0aW9uIG1hdGNoZXJGcm9tR3JvdXBNYXRjaGVycyggZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycyApIHsKCXZhciBieVNldCA9IHNldE1hdGNoZXJzLmxlbmd0aCA+IDAsCgkJYnlFbGVtZW50ID0gZWxlbWVudE1hdGNoZXJzLmxlbmd0aCA+IDAsCgkJc3VwZXJNYXRjaGVyID0gZnVuY3Rpb24oIHNlZWQsIGNvbnRleHQsIHhtbCwgcmVzdWx0cywgb3V0ZXJtb3N0ICkgewoJCQl2YXIgZWxlbSwgaiwgbWF0Y2hlciwKCQkJCW1hdGNoZWRDb3VudCA9IDAsCgkJCQlpID0gIjAiLAoJCQkJdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwKCQkJCXNldE1hdGNoZWQgPSBbXSwKCQkJCWNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LAoJCQkJLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBvdXRlcm1vc3QgY29udGV4dAoJCQkJZWxlbXMgPSBzZWVkIHx8IGJ5RWxlbWVudCAmJiBFeHByLmZpbmRbIlRBRyJdKCAiKiIsIG91dGVybW9zdCApLAoJCQkJLy8gVXNlIGludGVnZXIgZGlycnVucyBpZmYgdGhpcyBpcyB0aGUgb3V0ZXJtb3N0IG1hdGNoZXIKCQkJCWRpcnJ1bnNVbmlxdWUgPSAoZGlycnVucyArPSBjb250ZXh0QmFja3VwID09IG51bGwgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAwLjEpLAoJCQkJbGVuID0gZWxlbXMubGVuZ3RoOwoKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCAhPT0gZG9jdW1lbnQgJiYgY29udGV4dDsKCQkJfQoKCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKCQkJLy8gS2VlcCBgaWAgYSBzdHJpbmcgaWYgdGhlcmUgYXJlIG5vIGVsZW1lbnRzIHNvIGBtYXRjaGVkQ291bnRgIHdpbGwgYmUgIjAwIiBiZWxvdwoJCQkvLyBTdXBwb3J0OiBJRTw5LCBTYWZhcmkKCQkJLy8gVG9sZXJhdGUgTm9kZUxpc3QgcHJvcGVydGllcyAoSUU6ICJsZW5ndGgiOyBTYWZhcmk6IDxudW1iZXI+KSBtYXRjaGluZyBlbGVtZW50cyBieSBpZAoJCQlmb3IgKCA7IGkgIT09IGxlbiAmJiAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGJ5RWxlbWVudCAmJiBlbGVtICkgewoJCQkJCWogPSAwOwoJCQkJCXdoaWxlICggKG1hdGNoZXIgPSBlbGVtZW50TWF0Y2hlcnNbaisrXSkgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXN1bHRzLnB1c2goIGVsZW0gKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmICggb3V0ZXJtb3N0ICkgewoJCQkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwoJCQkJaWYgKCBieVNldCApIHsKCQkJCQkvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCgkJCQkJaWYgKCAoZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0pICkgewoJCQkJCQltYXRjaGVkQ291bnQtLTsKCQkJCQl9CgoJCQkJCS8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKCQkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJCXVubWF0Y2hlZC5wdXNoKCBlbGVtICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBBcHBseSBzZXQgZmlsdGVycyB0byB1bm1hdGNoZWQgZWxlbWVudHMKCQkJbWF0Y2hlZENvdW50ICs9IGk7CgkJCWlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewoJCQkJaiA9IDA7CgkJCQl3aGlsZSAoIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgKSB7CgkJCQkJbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCgkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwoJCQkJCWlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZiAoICEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pICkgewoJCQkJCQkJCXNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwoJCQkJCXNldE1hdGNoZWQgPSBjb25kZW5zZSggc2V0TWF0Y2hlZCApOwoJCQkJfQoKCQkJCS8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsKCgkJCQkvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgoJCQkJCSggbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoICkgPiAxICkgewoKCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwoJCQkJfQoJCQl9CgoJCQkvLyBPdmVycmlkZSBtYW5pcHVsYXRpb24gb2YgZ2xvYmFscyBieSBuZXN0ZWQgbWF0Y2hlcnMKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0QmFja3VwOwoJCQl9CgoJCQlyZXR1cm4gdW5tYXRjaGVkOwoJCX07CgoJcmV0dXJuIGJ5U2V0ID8KCQltYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKCQlzdXBlck1hdGNoZXI7Cn0KCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgbWF0Y2ggLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7Cgl2YXIgaSwKCQlzZXRNYXRjaGVycyA9IFtdLAoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLAoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCAhY2FjaGVkICkgewoJCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAoJCWlmICggIW1hdGNoICkgewoJCQltYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoJCX0KCQlpID0gbWF0Y2gubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQljYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyggbWF0Y2hbaV0gKTsKCQkJaWYgKCBjYWNoZWRbIGV4cGFuZG8gXSApIHsKCQkJCXNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9CgkJfQoKCQkvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KCQljYWNoZWQgPSBjb21waWxlckNhY2hlKCBzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgKTsKCgkJLy8gU2F2ZSBzZWxlY3RvciBhbmQgdG9rZW5pemF0aW9uCgkJY2FjaGVkLnNlbGVjdG9yID0gc2VsZWN0b3I7Cgl9CglyZXR1cm4gY2FjaGVkOwp9OwoKLyoqCiAqIEEgbG93LWxldmVsIHNlbGVjdGlvbiBmdW5jdGlvbiB0aGF0IHdvcmtzIHdpdGggU2l6emxlJ3MgY29tcGlsZWQKICogIHNlbGVjdG9yIGZ1bmN0aW9ucwogKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogKiAgc2VsZWN0b3IgZnVuY3Rpb24gYnVpbHQgd2l0aCBTaXp6bGUuY29tcGlsZQogKiBAcGFyYW0ge0VsZW1lbnR9IGNvbnRleHQKICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAqIEBwYXJhbSB7QXJyYXl9IFtzZWVkXSBBIHNldCBvZiBlbGVtZW50cyB0byBtYXRjaCBhZ2FpbnN0CiAqLwpzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCgkJY29tcGlsZWQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgJiYgc2VsZWN0b3IsCgkJbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZSggKHNlbGVjdG9yID0gY29tcGlsZWQuc2VsZWN0b3IgfHwgc2VsZWN0b3IpICk7CgoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgoJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgbm8gc2VlZCBhbmQgb25seSBvbmUgZ3JvdXAKCWlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoKCQkvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAoJCXRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAgKTsKCQlpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJgoJCQkJc3VwcG9ydC5nZXRCeUlkICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYKCQkJCUV4cHIucmVsYXRpdmVbIHRva2Vuc1sxXS50eXBlIF0gKSB7CgoJCQljb250ZXh0ID0gKCBFeHByLmZpbmRbIklEIl0oIHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIGNvbnRleHQgKSB8fCBbXSApWzBdOwoJCQlpZiAoICFjb250ZXh0ICkgewoJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkvLyBQcmVjb21waWxlZCBtYXRjaGVycyB3aWxsIHN0aWxsIHZlcmlmeSBhbmNlc3RyeSwgc28gc3RlcCB1cCBhIGxldmVsCgkJCX0gZWxzZSBpZiAoIGNvbXBpbGVkICkgewoJCQkJY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsKCQkJfQoKCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7CgkJfQoKCQkvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nCgkJaSA9IG1hdGNoRXhwclsibmVlZHNDb250ZXh0Il0udGVzdCggc2VsZWN0b3IgKSA/IDAgOiB0b2tlbnMubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQl0b2tlbiA9IHRva2Vuc1tpXTsKCgkJCS8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKCQkJaWYgKCBFeHByLnJlbGF0aXZlWyAodHlwZSA9IHRva2VuLnR5cGUpIF0gKSB7CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoIChmaW5kID0gRXhwci5maW5kWyB0eXBlIF0pICkgewoJCQkJLy8gU2VhcmNoLCBleHBhbmRpbmcgY29udGV4dCBmb3IgbGVhZGluZyBzaWJsaW5nIGNvbWJpbmF0b3JzCgkJCQlpZiAoIChzZWVkID0gZmluZCgKCQkJCQl0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICksCgkJCQkJcnNpYmxpbmcudGVzdCggdG9rZW5zWzBdLnR5cGUgKSAmJiB0ZXN0Q29udGV4dCggY29udGV4dC5wYXJlbnROb2RlICkgfHwgY29udGV4dAoJCQkJKSkgKSB7CgoJCQkJCS8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQoJCQkJCXRva2Vucy5zcGxpY2UoIGksIDEgKTsKCQkJCQlzZWxlY3RvciA9IHNlZWQubGVuZ3RoICYmIHRvU2VsZWN0b3IoIHRva2VucyApOwoJCQkJCWlmICggIXNlbGVjdG9yICkgewoJCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBzZWVkICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbiBpZiBvbmUgaXMgbm90IHByb3ZpZGVkCgkvLyBQcm92aWRlIGBtYXRjaGAgdG8gYXZvaWQgcmV0b2tlbml6YXRpb24gaWYgd2UgbW9kaWZpZWQgdGhlIHNlbGVjdG9yIGFib3ZlCgkoIGNvbXBpbGVkIHx8IGNvbXBpbGUoIHNlbGVjdG9yLCBtYXRjaCApICkoCgkJc2VlZCwKCQljb250ZXh0LAoJCSFkb2N1bWVudElzSFRNTCwKCQlyZXN1bHRzLAoJCXJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8IGNvbnRleHQKCSk7CglyZXR1cm4gcmVzdWx0czsKfTsKCi8vIE9uZS10aW1lIGFzc2lnbm1lbnRzCgovLyBTb3J0IHN0YWJpbGl0eQpzdXBwb3J0LnNvcnRTdGFibGUgPSBleHBhbmRvLnNwbGl0KCIiKS5zb3J0KCBzb3J0T3JkZXIgKS5qb2luKCIiKSA9PT0gZXhwYW5kbzsKCi8vIFN1cHBvcnQ6IENocm9tZTwxNAovLyBBbHdheXMgYXNzdW1lIGR1cGxpY2F0ZXMgaWYgdGhleSBhcmVuJ3QgcGFzc2VkIHRvIHRoZSBjb21wYXJpc29uIGZ1bmN0aW9uCnN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlcyA9ICEhaGFzRHVwbGljYXRlOwoKLy8gSW5pdGlhbGl6ZSBhZ2FpbnN0IHRoZSBkZWZhdWx0IGRvY3VtZW50CnNldERvY3VtZW50KCk7CgovLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQovLyBEZXRhY2hlZCBub2RlcyBjb25mb3VuZGluZ2x5IGZvbGxvdyAqZWFjaCBvdGhlcioKc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdjEgKSB7CgkvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKCXJldHVybiBkaXYxLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApICYgMTsKfSk7CgovLyBTdXBwb3J0OiBJRTw4Ci8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIgovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKCXJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIiMiIDsKfSkgKSB7CglhZGRIYW5kbGUoICJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIG5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInR5cGUiID8gMSA6IDIgKTsKCQl9Cgl9KTsKfQoKLy8gU3VwcG9ydDogSUU8OQovLyBVc2UgZGVmYXVsdFZhbHVlIGluIHBsYWNlIG9mIGdldEF0dHJpYnV0ZSgidmFsdWUiKQppZiAoICFzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQvPiI7CglkaXYuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwp9KSApIHsKCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsKCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwoJCX0KCX0pOwp9CgovLyBTdXBwb3J0OiBJRTw5Ci8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CglyZXR1cm4gZGl2LmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PSBudWxsOwp9KSApIHsKCWFkZEhhbmRsZSggYm9vbGVhbnMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQl2YXIgdmFsOwoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gZWxlbVsgbmFtZSBdID09PSB0cnVlID8gbmFtZS50b0xvd2VyQ2FzZSgpIDoKCQkJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCBuYW1lICkpICYmIHZhbC5zcGVjaWZpZWQgPwoJCQkJCXZhbC52YWx1ZSA6CgkJCQludWxsOwoJCX0KCX0pOwp9CgpyZXR1cm4gU2l6emxlOwoKfSkoIHdpbmRvdyApOwoKCgpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgoKdmFyIHJuZWVkc0NvbnRleHQgPSBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQ7Cgp2YXIgcnNpbmdsZVRhZyA9ICgvXjwoXHcrKVxzKlwvPz4oPzo8XC9cMT58KSQvKTsKCgoKdmFyIHJpc1NpbXBsZSA9IC9eLlteOiNcW1wuLF0qJC87CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdApmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIG5vdCApIHsKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQkvKiBqc2hpbnQgLVcwMTggKi8KCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90OwoJCX0pOwoKCX0KCglpZiAoIHF1YWxpZmllci5ub2RlVHlwZSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgIT09IG5vdDsKCQl9KTsKCgl9CgoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsKCQlpZiAoIHJpc1NpbXBsZS50ZXN0KCBxdWFsaWZpZXIgKSApIHsKCQkJcmV0dXJuIGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZWxlbWVudHMsIG5vdCApOwoJCX0KCgkJcXVhbGlmaWVyID0galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBlbGVtZW50cyApOwoJfQoKCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAoIGluZGV4T2YuY2FsbCggcXVhbGlmaWVyLCBlbGVtICkgPj0gMCApICE9PSBub3Q7Cgl9KTsKfQoKalF1ZXJ5LmZpbHRlciA9IGZ1bmN0aW9uKCBleHByLCBlbGVtcywgbm90ICkgewoJdmFyIGVsZW0gPSBlbGVtc1sgMCBdOwoKCWlmICggbm90ICkgewoJCWV4cHIgPSAiOm5vdCgiICsgZXhwciArICIpIjsKCX0KCglyZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgPwoJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggZWxlbSwgZXhwciApID8gWyBlbGVtIF0gOiBbXSA6CgkJalF1ZXJ5LmZpbmQubWF0Y2hlcyggZXhwciwgalF1ZXJ5LmdyZXAoIGVsZW1zLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CgkJfSkpOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmaW5kOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGksCgkJCWxlbiA9IHRoaXMubGVuZ3RoLAoJCQlyZXQgPSBbXSwKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkoIHNlbGVjdG9yICkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggc2VsZlsgaSBdLCB0aGlzICkgKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfSkgKTsKCQl9CgoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWpRdWVyeS5maW5kKCBzZWxlY3Rvciwgc2VsZlsgaSBdLCByZXQgKTsKCQl9CgoJCS8vIE5lZWRlZCBiZWNhdXNlICQoIHNlbGVjdG9yLCBjb250ZXh0ICkgYmVjb21lcyAkKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKQoJCXJldCA9IHRoaXMucHVzaFN0YWNrKCBsZW4gPiAxID8galF1ZXJ5LnVuaXF1ZSggcmV0ICkgOiByZXQgKTsKCQlyZXQuc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yID8gdGhpcy5zZWxlY3RvciArICIgIiArIHNlbGVjdG9yIDogc2VsZWN0b3I7CgkJcmV0dXJuIHJldDsKCX0sCglmaWx0ZXI6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgZmFsc2UpICk7Cgl9LAoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIHRydWUpICk7Cgl9LAoJaXM6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gISF3aW5ub3coCgkJCXRoaXMsCgoJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CgkJCS8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KCQkJdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiAmJiBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICkgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciApIDoKCQkJCXNlbGVjdG9yIHx8IFtdLAoJCQlmYWxzZQoJCSkubGVuZ3RoOwoJfQp9KTsKCgovLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAoKCi8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQp2YXIgcm9vdGpRdWVyeSwKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCglycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0qKSkkLywKCglpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJdmFyIG1hdGNoLCBlbGVtOwoKCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCBzZWxlY3RvclswXSA9PT0gIjwiICYmIHNlbGVjdG9yWyBzZWxlY3Rvci5sZW5ndGggLSAxIF0gPT09ICI+IiAmJiBzZWxlY3Rvci5sZW5ndGggPj0gMyApIHsKCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrCgkJCQltYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCgkJCX0gZWxzZSB7CgkJCQltYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCQkJfQoKCQkJLy8gTWF0Y2ggaHRtbCBvciBtYWtlIHN1cmUgbm8gY29udGV4dCBpcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkgKSB7CgoJCQkJLy8gSEFORExFOiAkKGh0bWwpIC0+ICQoYXJyYXkpCgkJCQlpZiAoIG1hdGNoWzFdICkgewoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CgoJCQkJCS8vIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKCQkJCQkvLyBJbnRlbnRpb25hbGx5IGxldCB0aGUgZXJyb3IgYmUgdGhyb3duIGlmIHBhcnNlSFRNTCBpcyBub3QgcHJlc2VudAoJCQkJCWpRdWVyeS5tZXJnZSggdGhpcywgalF1ZXJ5LnBhcnNlSFRNTCgKCQkJCQkJbWF0Y2hbMV0sCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsCgkJCQkJCXRydWUKCQkJCQkpICk7CgoJCQkJCS8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbMV0gKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdCggY29udGV4dCApICkgewoJCQkJCQlmb3IgKCBtYXRjaCBpbiBjb250ZXh0ICkgewoJCQkJCQkJLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQoJCQkJCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdGhpc1sgbWF0Y2ggXSApICkgewoJCQkJCQkJCXRoaXNbIG1hdGNoIF0oIGNvbnRleHRbIG1hdGNoIF0gKTsKCgkJCQkJCQkvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXRoaXMuYXR0ciggbWF0Y2gsIGNvbnRleHRbIG1hdGNoIF0gKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJcmV0dXJuIHRoaXM7CgoJCQkJLy8gSEFORExFOiAkKCNpZCkKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCXRoaXNbMF0gPSBlbGVtOwoJCQkJCX0KCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7CgkJCQlyZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKCBzZWxlY3RvciApOwoKCQkJLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCgkJCS8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOwoJCQl9CgoJCS8vIEhBTkRMRTogJChET01FbGVtZW50KQoJCX0gZWxzZSBpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsKCQkJcmV0dXJuIHR5cGVvZiByb290alF1ZXJ5LnJlYWR5ICE9PSAidW5kZWZpbmVkIiA/CgkJCQlyb290alF1ZXJ5LnJlYWR5KCBzZWxlY3RvciApIDoKCQkJCS8vIEV4ZWN1dGUgaW1tZWRpYXRlbHkgaWYgcmVhZHkgaXMgbm90IHByZXNlbnQKCQkJCXNlbGVjdG9yKCBqUXVlcnkgKTsKCQl9CgoJCWlmICggc2VsZWN0b3Iuc2VsZWN0b3IgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yLnNlbGVjdG9yOwoJCQl0aGlzLmNvbnRleHQgPSBzZWxlY3Rvci5jb250ZXh0OwoJCX0KCgkJcmV0dXJuIGpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yLCB0aGlzICk7Cgl9OwoKLy8gR2l2ZSB0aGUgaW5pdCBmdW5jdGlvbiB0aGUgalF1ZXJ5IHByb3RvdHlwZSBmb3IgbGF0ZXIgaW5zdGFudGlhdGlvbgppbml0LnByb3RvdHlwZSA9IGpRdWVyeS5mbjsKCi8vIEluaXRpYWxpemUgY2VudHJhbCByZWZlcmVuY2UKcm9vdGpRdWVyeSA9IGpRdWVyeSggZG9jdW1lbnQgKTsKCgp2YXIgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCgkvLyBtZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAoJZ3VhcmFudGVlZFVuaXF1ZSA9IHsKCQljaGlsZHJlbjogdHJ1ZSwKCQljb250ZW50czogdHJ1ZSwKCQluZXh0OiB0cnVlLAoJCXByZXY6IHRydWUKCX07CgpqUXVlcnkuZXh0ZW5kKHsKCWRpcjogZnVuY3Rpb24oIGVsZW0sIGRpciwgdW50aWwgKSB7CgkJdmFyIG1hdGNoZWQgPSBbXSwKCQkJdHJ1bmNhdGUgPSB1bnRpbCAhPT0gdW5kZWZpbmVkOwoKCQl3aGlsZSAoIChlbGVtID0gZWxlbVsgZGlyIF0pICYmIGVsZW0ubm9kZVR5cGUgIT09IDkgKSB7CgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCWlmICggdHJ1bmNhdGUgJiYgalF1ZXJ5KCBlbGVtICkuaXMoIHVudGlsICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCQltYXRjaGVkLnB1c2goIGVsZW0gKTsKCQkJfQoJCX0KCQlyZXR1cm4gbWF0Y2hlZDsKCX0sCgoJc2libGluZzogZnVuY3Rpb24oIG4sIGVsZW0gKSB7CgkJdmFyIG1hdGNoZWQgPSBbXTsKCgkJZm9yICggOyBuOyBuID0gbi5uZXh0U2libGluZyApIHsKCQkJaWYgKCBuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0gKSB7CgkJCQltYXRjaGVkLnB1c2goIG4gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIG1hdGNoZWQ7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CgloYXM6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIHRhcmdldHMgPSBqUXVlcnkoIHRhcmdldCwgdGhpcyApLAoJCQlsID0gdGFyZ2V0cy5sZW5ndGg7CgoJCXJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggdGhpcywgdGFyZ2V0c1tpXSApICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQl9CgkJfSk7Cgl9LAoKCWNsb3Nlc3Q6IGZ1bmN0aW9uKCBzZWxlY3RvcnMsIGNvbnRleHQgKSB7CgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aCwKCQkJbWF0Y2hlZCA9IFtdLAoJCQlwb3MgPSBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciID8KCQkJCWpRdWVyeSggc2VsZWN0b3JzLCBjb250ZXh0IHx8IHRoaXMuY29udGV4dCApIDoKCQkJCTA7CgoJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJZm9yICggY3VyID0gdGhpc1tpXTsgY3VyICYmIGN1ciAhPT0gY29udGV4dDsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgkJCQkvLyBBbHdheXMgc2tpcCBkb2N1bWVudCBmcmFnbWVudHMKCQkJCWlmICggY3VyLm5vZGVUeXBlIDwgMTEgJiYgKHBvcyA/CgkJCQkJcG9zLmluZGV4KGN1cikgPiAtMSA6CgoJCQkJCS8vIERvbid0IHBhc3Mgbm9uLWVsZW1lbnRzIHRvIFNpenpsZQoJCQkJCWN1ci5ub2RlVHlwZSA9PT0gMSAmJgoJCQkJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoY3VyLCBzZWxlY3RvcnMpKSApIHsKCgkJCQkJbWF0Y2hlZC5wdXNoKCBjdXIgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkLmxlbmd0aCA+IDEgPyBqUXVlcnkudW5pcXVlKCBtYXRjaGVkICkgOiBtYXRjaGVkICk7Cgl9LAoKCS8vIERldGVybWluZSB0aGUgcG9zaXRpb24gb2YgYW4gZWxlbWVudCB3aXRoaW4KCS8vIHRoZSBtYXRjaGVkIHNldCBvZiBlbGVtZW50cwoJaW5kZXg6IGZ1bmN0aW9uKCBlbGVtICkgewoKCQkvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAoJCWlmICggIWVsZW0gKSB7CgkJCXJldHVybiAoIHRoaXNbIDAgXSAmJiB0aGlzWyAwIF0ucGFyZW50Tm9kZSApID8gdGhpcy5maXJzdCgpLnByZXZBbGwoKS5sZW5ndGggOiAtMTsKCQl9CgoJCS8vIGluZGV4IGluIHNlbGVjdG9yCgkJaWYgKCB0eXBlb2YgZWxlbSA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBpbmRleE9mLmNhbGwoIGpRdWVyeSggZWxlbSApLCB0aGlzWyAwIF0gKTsKCQl9CgoJCS8vIExvY2F0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIGRlc2lyZWQgZWxlbWVudAoJCXJldHVybiBpbmRleE9mLmNhbGwoIHRoaXMsCgoJCQkvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKCQkJZWxlbS5qcXVlcnkgPyBlbGVtWyAwIF0gOiBlbGVtCgkJKTsKCX0sCgoJYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKAoJCQlqUXVlcnkudW5pcXVlKAoJCQkJalF1ZXJ5Lm1lcmdlKCB0aGlzLmdldCgpLCBqUXVlcnkoIHNlbGVjdG9yLCBjb250ZXh0ICkgKQoJCQkpCgkJKTsKCX0sCgoJYWRkQmFjazogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpCgkJKTsKCX0KfSk7CgpmdW5jdGlvbiBzaWJsaW5nKCBjdXIsIGRpciApIHsKCXdoaWxlICggKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEgKSB7fQoJcmV0dXJuIGN1cjsKfQoKalF1ZXJ5LmVhY2goewoJcGFyZW50OiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCXJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7Cgl9LAoJcGFyZW50czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwoJfSwKCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIsIHVudGlsICk7Cgl9LAoJbmV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gc2libGluZyggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXZBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAibmV4dFNpYmxpbmciLCB1bnRpbCApOwoJfSwKCXByZXZVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglzaWJsaW5nczogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCAoIGVsZW0ucGFyZW50Tm9kZSB8fCB7fSApLmZpcnN0Q2hpbGQsIGVsZW0gKTsKCX0sCgljaGlsZHJlbjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5zaWJsaW5nKCBlbGVtLmZpcnN0Q2hpbGQgKTsKCX0sCgljb250ZW50czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGVsZW0uY29udGVudERvY3VtZW50IHx8IGpRdWVyeS5tZXJnZSggW10sIGVsZW0uY2hpbGROb2RlcyApOwoJfQp9LCBmdW5jdGlvbiggbmFtZSwgZm4gKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCB1bnRpbCwgc2VsZWN0b3IgKSB7CgkJdmFyIG1hdGNoZWQgPSBqUXVlcnkubWFwKCB0aGlzLCBmbiwgdW50aWwgKTsKCgkJaWYgKCBuYW1lLnNsaWNlKCAtNSApICE9PSAiVW50aWwiICkgewoJCQlzZWxlY3RvciA9IHVudGlsOwoJCX0KCgkJaWYgKCBzZWxlY3RvciAmJiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQltYXRjaGVkID0galF1ZXJ5LmZpbHRlciggc2VsZWN0b3IsIG1hdGNoZWQgKTsKCQl9CgoJCWlmICggdGhpcy5sZW5ndGggPiAxICkgewoJCQkvLyBSZW1vdmUgZHVwbGljYXRlcwoJCQlpZiAoICFndWFyYW50ZWVkVW5pcXVlWyBuYW1lIF0gKSB7CgkJCQlqUXVlcnkudW5pcXVlKCBtYXRjaGVkICk7CgkJCX0KCgkJCS8vIFJldmVyc2Ugb3JkZXIgZm9yIHBhcmVudHMqIGFuZCBwcmV2LWRlcml2YXRpdmVzCgkJCWlmICggcnBhcmVudHNwcmV2LnRlc3QoIG5hbWUgKSApIHsKCQkJCW1hdGNoZWQucmV2ZXJzZSgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIG1hdGNoZWQgKTsKCX07Cn0pOwp2YXIgcm5vdHdoaXRlID0gKC9cUysvZyk7CgoKCi8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXSwgZnVuY3Rpb24oIF8sIGZsYWcgKSB7CgkJb2JqZWN0WyBmbGFnIF0gPSB0cnVlOwoJfSk7CglyZXR1cm4gb2JqZWN0Owp9CgovKgogKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICoKICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICoKICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICoKICogUG9zc2libGUgb3B0aW9uczoKICoKICoJb25jZToJCQl3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAqCQkJCQlhZnRlciB0aGUgbGlzdCBoYXMgYmVlbiBmaXJlZCByaWdodCBhd2F5IHdpdGggdGhlIGxhdGVzdCAibWVtb3JpemVkIgogKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqCXVuaXF1ZToJCQl3aWxsIGVuc3VyZSBhIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGFkZGVkIG9uY2UgKG5vIGR1cGxpY2F0ZSBpbiB0aGUgbGlzdCkKICoKICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogKgogKi8KalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCS8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQKCS8vICh3ZSBjaGVjayBpbiBjYWNoZSBmaXJzdCkKCW9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPwoJCSggb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gfHwgY3JlYXRlT3B0aW9ucyggb3B0aW9ucyApICkgOgoJCWpRdWVyeS5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJdmFyIC8vIExhc3QgZmlyZSB2YWx1ZSAoZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cykKCQltZW1vcnksCgkJLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKCQlmaXJlZCwKCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCBpcyBjdXJyZW50bHkgZmlyaW5nCgkJZmlyaW5nLAoJCS8vIEZpcnN0IGNhbGxiYWNrIHRvIGZpcmUgKHVzZWQgaW50ZXJuYWxseSBieSBhZGQgYW5kIGZpcmVXaXRoKQoJCWZpcmluZ1N0YXJ0LAoJCS8vIEVuZCBvZiB0aGUgbG9vcCB3aGVuIGZpcmluZwoJCWZpcmluZ0xlbmd0aCwKCQkvLyBJbmRleCBvZiBjdXJyZW50bHkgZmlyaW5nIGNhbGxiYWNrIChtb2RpZmllZCBieSByZW1vdmUgaWYgbmVlZGVkKQoJCWZpcmluZ0luZGV4LAoJCS8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CgkJbGlzdCA9IFtdLAoJCS8vIFN0YWNrIG9mIGZpcmUgY2FsbHMgZm9yIHJlcGVhdGFibGUgbGlzdHMKCQlzdGFjayA9ICFvcHRpb25zLm9uY2UgJiYgW10sCgkJLy8gRmlyZSBjYWxsYmFja3MKCQlmaXJlID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkJCW1lbW9yeSA9IG9wdGlvbnMubWVtb3J5ICYmIGRhdGE7CgkJCWZpcmVkID0gdHJ1ZTsKCQkJZmlyaW5nSW5kZXggPSBmaXJpbmdTdGFydCB8fCAwOwoJCQlmaXJpbmdTdGFydCA9IDA7CgkJCWZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwoJCQlmaXJpbmcgPSB0cnVlOwoJCQlmb3IgKCA7IGxpc3QgJiYgZmlyaW5nSW5kZXggPCBmaXJpbmdMZW5ndGg7IGZpcmluZ0luZGV4KysgKSB7CgkJCQlpZiAoIGxpc3RbIGZpcmluZ0luZGV4IF0uYXBwbHkoIGRhdGFbIDAgXSwgZGF0YVsgMSBdICkgPT09IGZhbHNlICYmIG9wdGlvbnMuc3RvcE9uRmFsc2UgKSB7CgkJCQkJbWVtb3J5ID0gZmFsc2U7IC8vIFRvIHByZXZlbnQgZnVydGhlciBjYWxscyB1c2luZyBhZGQKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQlmaXJpbmcgPSBmYWxzZTsKCQkJaWYgKCBsaXN0ICkgewoJCQkJaWYgKCBzdGFjayApIHsKCQkJCQlpZiAoIHN0YWNrLmxlbmd0aCApIHsKCQkJCQkJZmlyZSggc3RhY2suc2hpZnQoKSApOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIG1lbW9yeSApIHsKCQkJCQlsaXN0ID0gW107CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYuZGlzYWJsZSgpOwoJCQkJfQoJCQl9CgkJfSwKCQkvLyBBY3R1YWwgQ2FsbGJhY2tzIG9iamVjdAoJCXNlbGYgPSB7CgkJCS8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKCQkJYWRkOiBmdW5jdGlvbigpIHsKCQkJCWlmICggbGlzdCApIHsKCQkJCQkvLyBGaXJzdCwgd2Ugc2F2ZSB0aGUgY3VycmVudCBsZW5ndGgKCQkJCQl2YXIgc3RhcnQgPSBsaXN0Lmxlbmd0aDsKCQkJCQkoZnVuY3Rpb24gYWRkKCBhcmdzICkgewoJCQkJCQlqUXVlcnkuZWFjaCggYXJncywgZnVuY3Rpb24oIF8sIGFyZyApIHsKCQkJCQkJCXZhciB0eXBlID0galF1ZXJ5LnR5cGUoIGFyZyApOwoJCQkJCQkJaWYgKCB0eXBlID09PSAiZnVuY3Rpb24iICkgewoJCQkJCQkJCWlmICggIW9wdGlvbnMudW5pcXVlIHx8ICFzZWxmLmhhcyggYXJnICkgKSB7CgkJCQkJCQkJCWxpc3QucHVzaCggYXJnICk7CgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIGlmICggYXJnICYmIGFyZy5sZW5ndGggJiYgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCQkJCQkJLy8gSW5zcGVjdCByZWN1cnNpdmVseQoJCQkJCQkJCWFkZCggYXJnICk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0pKCBhcmd1bWVudHMgKTsKCQkJCQkvLyBEbyB3ZSBuZWVkIHRvIGFkZCB0aGUgY2FsbGJhY2tzIHRvIHRoZQoJCQkJCS8vIGN1cnJlbnQgZmlyaW5nIGJhdGNoPwoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlmaXJpbmdMZW5ndGggPSBsaXN0Lmxlbmd0aDsKCQkJCQkvLyBXaXRoIG1lbW9yeSwgaWYgd2UncmUgbm90IGZpcmluZyB0aGVuCgkJCQkJLy8gd2Ugc2hvdWxkIGNhbGwgcmlnaHQgYXdheQoJCQkJCX0gZWxzZSBpZiAoIG1lbW9yeSApIHsKCQkJCQkJZmlyaW5nU3RhcnQgPSBzdGFydDsKCQkJCQkJZmlyZSggbWVtb3J5ICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFJlbW92ZSBhIGNhbGxiYWNrIGZyb20gdGhlIGxpc3QKCQkJcmVtb3ZlOiBmdW5jdGlvbigpIHsKCQkJCWlmICggbGlzdCApIHsKCQkJCQlqUXVlcnkuZWFjaCggYXJndW1lbnRzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCQl2YXIgaW5kZXg7CgkJCQkJCXdoaWxlICggKCBpbmRleCA9IGpRdWVyeS5pbkFycmF5KCBhcmcsIGxpc3QsIGluZGV4ICkgKSA+IC0xICkgewoJCQkJCQkJbGlzdC5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQkJCQkvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKCQkJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nTGVuZ3RoICkgewoJCQkJCQkJCQlmaXJpbmdMZW5ndGgtLTsKCQkJCQkJCQl9CgkJCQkJCQkJaWYgKCBpbmRleCA8PSBmaXJpbmdJbmRleCApIHsKCQkJCQkJCQkJZmlyaW5nSW5kZXgtLTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0LgoJCQkvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KCQkJaGFzOiBmdW5jdGlvbiggZm4gKSB7CgkJCQlyZXR1cm4gZm4gPyBqUXVlcnkuaW5BcnJheSggZm4sIGxpc3QgKSA+IC0xIDogISEoIGxpc3QgJiYgbGlzdC5sZW5ndGggKTsKCQkJfSwKCQkJLy8gUmVtb3ZlIGFsbCBjYWxsYmFja3MgZnJvbSB0aGUgbGlzdAoJCQllbXB0eTogZnVuY3Rpb24oKSB7CgkJCQlsaXN0ID0gW107CgkJCQlmaXJpbmdMZW5ndGggPSAwOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIEhhdmUgdGhlIGxpc3QgZG8gbm90aGluZyBhbnltb3JlCgkJCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IHN0YWNrID0gbWVtb3J5ID0gdW5kZWZpbmVkOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIElzIGl0IGRpc2FibGVkPwoJCQlkaXNhYmxlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIWxpc3Q7CgkJCX0sCgkJCS8vIExvY2sgdGhlIGxpc3QgaW4gaXRzIGN1cnJlbnQgc3RhdGUKCQkJbG9jazogZnVuY3Rpb24oKSB7CgkJCQlzdGFjayA9IHVuZGVmaW5lZDsKCQkJCWlmICggIW1lbW9yeSApIHsKCQkJCQlzZWxmLmRpc2FibGUoKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBsb2NrZWQ/CgkJCWxvY2tlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIXN0YWNrOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBhbmQgYXJndW1lbnRzCgkJCWZpcmVXaXRoOiBmdW5jdGlvbiggY29udGV4dCwgYXJncyApIHsKCQkJCWlmICggbGlzdCAmJiAoICFmaXJlZCB8fCBzdGFjayApICkgewoJCQkJCWFyZ3MgPSBhcmdzIHx8IFtdOwoJCQkJCWFyZ3MgPSBbIGNvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzIF07CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCXN0YWNrLnB1c2goIGFyZ3MgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlmaXJlKCBhcmdzICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCgkJCWZpcmU6IGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5maXJlV2l0aCggdGhpcywgYXJndW1lbnRzICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gVG8ga25vdyBpZiB0aGUgY2FsbGJhY2tzIGhhdmUgYWxyZWFkeSBiZWVuIGNhbGxlZCBhdCBsZWFzdCBvbmNlCgkJCWZpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAhIWZpcmVkOwoJCQl9CgkJfTsKCglyZXR1cm4gc2VsZjsKfTsKCgpqUXVlcnkuZXh0ZW5kKHsKCglEZWZlcnJlZDogZnVuY3Rpb24oIGZ1bmMgKSB7CgkJdmFyIHR1cGxlcyA9IFsKCQkJCS8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBsaXN0ZW5lciBsaXN0LCBmaW5hbCBzdGF0ZQoJCQkJWyAicmVzb2x2ZSIsICJkb25lIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgInJlc29sdmVkIiBdLAoJCQkJWyAicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAicmVqZWN0ZWQiIF0sCgkJCQlbICJub3RpZnkiLCAicHJvZ3Jlc3MiLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSBdCgkJCV0sCgkJCXN0YXRlID0gInBlbmRpbmciLAoJCQlwcm9taXNlID0gewoJCQkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZTsKCQkJCX0sCgkJCQlhbHdheXM6IGZ1bmN0aW9uKCkgewoJCQkJCWRlZmVycmVkLmRvbmUoIGFyZ3VtZW50cyApLmZhaWwoIGFyZ3VtZW50cyApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCQkJCXRoZW46IGZ1bmN0aW9uKCAvKiBmbkRvbmUsIGZuRmFpbCwgZm5Qcm9ncmVzcyAqLyApIHsKCQkJCQl2YXIgZm5zID0gYXJndW1lbnRzOwoJCQkJCXJldHVybiBqUXVlcnkuRGVmZXJyZWQoZnVuY3Rpb24oIG5ld0RlZmVyICkgewoJCQkJCQlqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CgkJCQkJCQl2YXIgZm4gPSBqUXVlcnkuaXNGdW5jdGlvbiggZm5zWyBpIF0gKSAmJiBmbnNbIGkgXTsKCQkJCQkJCS8vIGRlZmVycmVkWyBkb25lIHwgZmFpbCB8IHByb2dyZXNzIF0gZm9yIGZvcndhcmRpbmcgYWN0aW9ucyB0byBuZXdEZWZlcgoJCQkJCQkJZGVmZXJyZWRbIHR1cGxlWzFdIF0oZnVuY3Rpb24oKSB7CgkJCQkJCQkJdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCQkJCWlmICggcmV0dXJuZWQgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHJldHVybmVkLnByb21pc2UgKSApIHsKCQkJCQkJCQkJcmV0dXJuZWQucHJvbWlzZSgpCgkJCQkJCQkJCQkuZG9uZSggbmV3RGVmZXIucmVzb2x2ZSApCgkJCQkJCQkJCQkuZmFpbCggbmV3RGVmZXIucmVqZWN0ICkKCQkJCQkJCQkJCS5wcm9ncmVzcyggbmV3RGVmZXIubm90aWZ5ICk7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJbmV3RGVmZXJbIHR1cGxlWyAwIF0gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7CgkJCQkJCQkJfQoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCQlmbnMgPSBudWxsOwoJCQkJCX0pLnByb21pc2UoKTsKCQkJCX0sCgkJCQkvLyBHZXQgYSBwcm9taXNlIGZvciB0aGlzIGRlZmVycmVkCgkJCQkvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CgkJCQlwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewoJCQkJCXJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQoIG9iaiwgcHJvbWlzZSApIDogcHJvbWlzZTsKCQkJCX0KCQkJfSwKCQkJZGVmZXJyZWQgPSB7fTsKCgkJLy8gS2VlcCBwaXBlIGZvciBiYWNrLWNvbXBhdAoJCXByb21pc2UucGlwZSA9IHByb21pc2UudGhlbjsKCgkJLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwoJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJdmFyIGxpc3QgPSB0dXBsZVsgMiBdLAoJCQkJc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOwoKCQkJLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKCQkJcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOwoKCQkJLy8gSGFuZGxlIHN0YXRlCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7CgkJCQlsaXN0LmFkZChmdW5jdGlvbigpIHsKCQkJCQkvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCgkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsKCgkJCQkvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCgkJCQl9LCB0dXBsZXNbIGkgXiAxIF1bIDIgXS5kaXNhYmxlLCB0dXBsZXNbIDIgXVsgMiBdLmxvY2sgKTsKCQkJfQoKCQkJLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gXSA9IGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWRbIHR1cGxlWzBdICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gcHJvbWlzZSA6IHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX07CgkJCWRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKCQl9KTsKCgkJLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCgkJcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKCQkvLyBDYWxsIGdpdmVuIGZ1bmMgaWYgYW55CgkJaWYgKCBmdW5jICkgewoJCQlmdW5jLmNhbGwoIGRlZmVycmVkLCBkZWZlcnJlZCApOwoJCX0KCgkJLy8gQWxsIGRvbmUhCgkJcmV0dXJuIGRlZmVycmVkOwoJfSwKCgkvLyBEZWZlcnJlZCBoZWxwZXIKCXdoZW46IGZ1bmN0aW9uKCBzdWJvcmRpbmF0ZSAvKiAsIC4uLiwgc3Vib3JkaW5hdGVOICovICkgewoJCXZhciBpID0gMCwKCQkJcmVzb2x2ZVZhbHVlcyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApLAoJCQlsZW5ndGggPSByZXNvbHZlVmFsdWVzLmxlbmd0aCwKCgkJCS8vIHRoZSBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKCQkJcmVtYWluaW5nID0gbGVuZ3RoICE9PSAxIHx8ICggc3Vib3JkaW5hdGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIHN1Ym9yZGluYXRlLnByb21pc2UgKSApID8gbGVuZ3RoIDogMCwKCgkJCS8vIHRoZSBtYXN0ZXIgRGVmZXJyZWQuIElmIHJlc29sdmVWYWx1ZXMgY29uc2lzdCBvZiBvbmx5IGEgc2luZ2xlIERlZmVycmVkLCBqdXN0IHVzZSB0aGF0LgoJCQlkZWZlcnJlZCA9IHJlbWFpbmluZyA9PT0gMSA/IHN1Ym9yZGluYXRlIDogalF1ZXJ5LkRlZmVycmVkKCksCgoJCQkvLyBVcGRhdGUgZnVuY3Rpb24gZm9yIGJvdGggcmVzb2x2ZSBhbmQgcHJvZ3Jlc3MgdmFsdWVzCgkJCXVwZGF0ZUZ1bmMgPSBmdW5jdGlvbiggaSwgY29udGV4dHMsIHZhbHVlcyApIHsKCQkJCXJldHVybiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJY29udGV4dHNbIGkgXSA9IHRoaXM7CgkJCQkJdmFsdWVzWyBpIF0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApIDogdmFsdWU7CgkJCQkJaWYgKCB2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzICkgewoJCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgkJCQkJfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKCQkJCQl9CgkJCQl9OwoJCQl9LAoKCQkJcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCgkJLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAoJCWlmICggbGVuZ3RoID4gMSApIHsKCQkJcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHJlc29sdmVWYWx1ZXNbIGkgXSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UgKSApIHsKCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSgpCgkJCQkJCS5kb25lKCB1cGRhdGVGdW5jKCBpLCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKSApCgkJCQkJCS5mYWlsKCBkZWZlcnJlZC5yZWplY3QgKQoJCQkJCQkucHJvZ3Jlc3MoIHVwZGF0ZUZ1bmMoIGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLS1yZW1haW5pbmc7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKCQlpZiAoICFyZW1haW5pbmcgKSB7CgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Cn0pOwoKCi8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQp2YXIgcmVhZHlMaXN0OwoKalF1ZXJ5LmZuLnJlYWR5ID0gZnVuY3Rpb24oIGZuICkgewoJLy8gQWRkIHRoZSBjYWxsYmFjawoJalF1ZXJ5LnJlYWR5LnByb21pc2UoKS5kb25lKCBmbiApOwoKCXJldHVybiB0aGlzOwp9OwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKCWhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CgkJaWYgKCBob2xkICkgewoJCQlqUXVlcnkucmVhZHlXYWl0Kys7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7CgkJfQoJfSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CgkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoKCQkvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQoJCWlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoKCQkvLyBUcmlnZ2VyIGFueSBib3VuZCByZWFkeSBldmVudHMKCQlpZiAoIGpRdWVyeS5mbi50cmlnZ2VySGFuZGxlciApIHsKCQkJalF1ZXJ5KCBkb2N1bWVudCApLnRyaWdnZXJIYW5kbGVyKCAicmVhZHkiICk7CgkJCWpRdWVyeSggZG9jdW1lbnQgKS5vZmYoICJyZWFkeSIgKTsKCQl9Cgl9Cn0pOwoKLyoqCiAqIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCiAqLwpmdW5jdGlvbiBjb21wbGV0ZWQoKSB7Cglkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCWpRdWVyeS5yZWFkeSgpOwp9CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CglpZiAoICFyZWFkeUxpc3QgKSB7CgoJCXJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKCQkvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KCQkvLyB3ZSBvbmNlIHRyaWVkIHRvIHVzZSByZWFkeVN0YXRlICJpbnRlcmFjdGl2ZSIgaGVyZSwgYnV0IGl0IGNhdXNlZCBpc3N1ZXMgbGlrZSB0aGUgb25lCgkJLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOwoKCQl9IGVsc2UgewoKCQkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCQl9Cgl9CglyZXR1cm4gcmVhZHlMaXN0LnByb21pc2UoIG9iaiApOwp9OwoKLy8gS2ljayBvZmYgdGhlIERPTSByZWFkeSBjaGVjayBldmVuIGlmIHRoZSB1c2VyIGRvZXMgbm90CmpRdWVyeS5yZWFkeS5wcm9taXNlKCk7CgoKCgovLyBNdWx0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyBvZiBhIGNvbGxlY3Rpb24KLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCnZhciBhY2Nlc3MgPSBqUXVlcnkuYWNjZXNzID0gZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3ICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IGVsZW1zLmxlbmd0aCwKCQlidWxrID0ga2V5ID09IG51bGw7CgoJLy8gU2V0cyBtYW55IHZhbHVlcwoJaWYgKCBqUXVlcnkudHlwZSgga2V5ICkgPT09ICJvYmplY3QiICkgewoJCWNoYWluYWJsZSA9IHRydWU7CgkJZm9yICggaSBpbiBrZXkgKSB7CgkJCWpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3ICk7CgkJfQoKCS8vIFNldHMgb25lIHZhbHVlCgl9IGVsc2UgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCWNoYWluYWJsZSA9IHRydWU7CgoJCWlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyYXcgPSB0cnVlOwoJCX0KCgkJaWYgKCBidWxrICkgewoJCQkvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKCQkJaWYgKCByYXcgKSB7CgkJCQlmbi5jYWxsKCBlbGVtcywgdmFsdWUgKTsKCQkJCWZuID0gbnVsbDsKCgkJCS8vIC4uLmV4Y2VwdCB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKCQkJfSBlbHNlIHsKCQkJCWJ1bGsgPSBmbjsKCQkJCWZuID0gZnVuY3Rpb24oIGVsZW0sIGtleSwgdmFsdWUgKSB7CgkJCQkJcmV0dXJuIGJ1bGsuY2FsbCggalF1ZXJ5KCBlbGVtICksIHZhbHVlICk7CgkJCQl9OwoJCQl9CgkJfQoKCQlpZiAoIGZuICkgewoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWZuKCBlbGVtc1tpXSwga2V5LCByYXcgPyB2YWx1ZSA6IHZhbHVlLmNhbGwoIGVsZW1zW2ldLCBpLCBmbiggZWxlbXNbaV0sIGtleSApICkgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gY2hhaW5hYmxlID8KCQllbGVtcyA6CgoJCS8vIEdldHMKCQlidWxrID8KCQkJZm4uY2FsbCggZWxlbXMgKSA6CgkJCWxlbiA/IGZuKCBlbGVtc1swXSwga2V5ICkgOiBlbXB0eUdldDsKfTsKCgovKioKICogRGV0ZXJtaW5lcyB3aGV0aGVyIGFuIG9iamVjdCBjYW4gaGF2ZSBkYXRhCiAqLwpqUXVlcnkuYWNjZXB0RGF0YSA9IGZ1bmN0aW9uKCBvd25lciApIHsKCS8vIEFjY2VwdHMgb25seToKCS8vICAtIE5vZGUKCS8vICAgIC0gTm9kZS5FTEVNRU5UX05PREUKCS8vICAgIC0gTm9kZS5ET0NVTUVOVF9OT0RFCgkvLyAgLSBPYmplY3QKCS8vICAgIC0gQW55CgkvKiBqc2hpbnQgLVcwMTggKi8KCXJldHVybiBvd25lci5ub2RlVHlwZSA9PT0gMSB8fCBvd25lci5ub2RlVHlwZSA9PT0gOSB8fCAhKCArb3duZXIubm9kZVR5cGUgKTsKfTsKCgpmdW5jdGlvbiBEYXRhKCkgewoJLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQsCgkvLyBPbGQgV2ViS2l0IGRvZXMgbm90IGhhdmUgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zL2ZyZWV6ZSBtZXRob2QsCgkvLyByZXR1cm4gbmV3IGVtcHR5IG9iamVjdCBpbnN0ZWFkIHdpdGggbm8gW1tzZXRdXSBhY2Nlc3NvcgoJT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLmNhY2hlID0ge30sIDAsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4ge307CgkJfQoJfSk7CgoJdGhpcy5leHBhbmRvID0galF1ZXJ5LmV4cGFuZG8gKyBNYXRoLnJhbmRvbSgpOwp9CgpEYXRhLnVpZCA9IDE7CkRhdGEuYWNjZXB0cyA9IGpRdWVyeS5hY2NlcHREYXRhOwoKRGF0YS5wcm90b3R5cGUgPSB7CglrZXk6IGZ1bmN0aW9uKCBvd25lciApIHsKCQkvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywKCQkvLyBidXQgd2Ugc2hvdWxkIG5vdCwgc2VlICM4MzM1LgoJCS8vIEFsd2F5cyByZXR1cm4gdGhlIGtleSBmb3IgYSBmcm96ZW4gb2JqZWN0LgoJCWlmICggIURhdGEuYWNjZXB0cyggb3duZXIgKSApIHsKCQkJcmV0dXJuIDA7CgkJfQoKCQl2YXIgZGVzY3JpcHRvciA9IHt9LAoJCQkvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUga2V5CgkJCXVubG9jayA9IG93bmVyWyB0aGlzLmV4cGFuZG8gXTsKCgkJLy8gSWYgbm90LCBjcmVhdGUgb25lCgkJaWYgKCAhdW5sb2NrICkgewoJCQl1bmxvY2sgPSBEYXRhLnVpZCsrOwoKCQkJLy8gU2VjdXJlIGl0IGluIGEgbm9uLWVudW1lcmFibGUsIG5vbi13cml0YWJsZSBwcm9wZXJ0eQoJCQl0cnkgewoJCQkJZGVzY3JpcHRvclsgdGhpcy5leHBhbmRvIF0gPSB7IHZhbHVlOiB1bmxvY2sgfTsKCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKCBvd25lciwgZGVzY3JpcHRvciApOwoKCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQKCQkJLy8gRmFsbGJhY2sgdG8gYSBsZXNzIHNlY3VyZSBkZWZpbml0aW9uCgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJZGVzY3JpcHRvclsgdGhpcy5leHBhbmRvIF0gPSB1bmxvY2s7CgkJCQlqUXVlcnkuZXh0ZW5kKCBvd25lciwgZGVzY3JpcHRvciApOwoJCQl9CgkJfQoKCQkvLyBFbnN1cmUgdGhlIGNhY2hlIG9iamVjdAoJCWlmICggIXRoaXMuY2FjaGVbIHVubG9jayBdICkgewoJCQl0aGlzLmNhY2hlWyB1bmxvY2sgXSA9IHt9OwoJCX0KCgkJcmV0dXJuIHVubG9jazsKCX0sCglzZXQ6IGZ1bmN0aW9uKCBvd25lciwgZGF0YSwgdmFsdWUgKSB7CgkJdmFyIHByb3AsCgkJCS8vIFRoZXJlIG1heSBiZSBhbiB1bmxvY2sgYXNzaWduZWQgdG8gdGhpcyBub2RlLAoJCQkvLyBpZiB0aGVyZSBpcyBubyBlbnRyeSBmb3IgdGhpcyAib3duZXIiLCBjcmVhdGUgb25lIGlubGluZQoJCQkvLyBhbmQgc2V0IHRoZSB1bmxvY2sgYXMgdGhvdWdoIGFuIG93bmVyIGVudHJ5IGhhZCBhbHdheXMgZXhpc3RlZAoJCQl1bmxvY2sgPSB0aGlzLmtleSggb3duZXIgKSwKCQkJY2FjaGUgPSB0aGlzLmNhY2hlWyB1bmxvY2sgXTsKCgkJLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgewoJCQljYWNoZVsgZGF0YSBdID0gdmFsdWU7CgoJCS8vIEhhbmRsZTogWyBvd25lciwgeyBwcm9wZXJ0aWVzIH0gXSBhcmdzCgkJfSBlbHNlIHsKCQkJLy8gRnJlc2ggYXNzaWdubWVudHMgYnkgb2JqZWN0IGFyZSBzaGFsbG93IGNvcGllZAoJCQlpZiAoIGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBjYWNoZSApICkgewoJCQkJalF1ZXJ5LmV4dGVuZCggdGhpcy5jYWNoZVsgdW5sb2NrIF0sIGRhdGEgKTsKCQkJLy8gT3RoZXJ3aXNlLCBjb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdAoJCQl9IGVsc2UgewoJCQkJZm9yICggcHJvcCBpbiBkYXRhICkgewoJCQkJCWNhY2hlWyBwcm9wIF0gPSBkYXRhWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIGNhY2hlOwoJfSwKCWdldDogZnVuY3Rpb24oIG93bmVyLCBrZXkgKSB7CgkJLy8gRWl0aGVyIGEgdmFsaWQgY2FjaGUgaXMgZm91bmQsIG9yIHdpbGwgYmUgY3JlYXRlZC4KCQkvLyBOZXcgY2FjaGVzIHdpbGwgYmUgY3JlYXRlZCBhbmQgdGhlIHVubG9jayByZXR1cm5lZCwKCQkvLyBhbGxvd2luZyBkaXJlY3QgYWNjZXNzIHRvIHRoZSBuZXdseSBjcmVhdGVkCgkJLy8gZW1wdHkgZGF0YSBvYmplY3QuIEEgdmFsaWQgb3duZXIgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuCgkJdmFyIGNhY2hlID0gdGhpcy5jYWNoZVsgdGhpcy5rZXkoIG93bmVyICkgXTsKCgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkID8KCQkJY2FjaGUgOiBjYWNoZVsga2V5IF07Cgl9LAoJYWNjZXNzOiBmdW5jdGlvbiggb3duZXIsIGtleSwgdmFsdWUgKSB7CgkJdmFyIHN0b3JlZDsKCQkvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkCgkJLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCgkJLy8KCQkvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lCgkJLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgoJCS8vCgkJLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdAoJCS8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKCQkvLwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgfHwKCQkJCSgoa2V5ICYmIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciKSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSApIHsKCgkJCXN0b3JlZCA9IHRoaXMuZ2V0KCBvd25lciwga2V5ICk7CgoJCQlyZXR1cm4gc3RvcmVkICE9PSB1bmRlZmluZWQgPwoJCQkJc3RvcmVkIDogdGhpcy5nZXQoIG93bmVyLCBqUXVlcnkuY2FtZWxDYXNlKGtleSkgKTsKCQl9CgoJCS8vIFsqXVdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCgkJLy8gYXJlIHNwZWNpZmllZCwgc2V0IG9yIGV4dGVuZCAoZXhpc3Rpbmcgb2JqZWN0cykgd2l0aCBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCgkJLy8gICAyLiBBIGtleSBhbmQgdmFsdWUKCQkvLwoJCXRoaXMuc2V0KCBvd25lciwga2V5LCB2YWx1ZSApOwoKCQkvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCgkJLy8gcmV0dXJuIHRoZSBleHBlY3RlZCBkYXRhIGJhc2VkIG9uIHdoaWNoIHBhdGggd2FzIHRha2VuWypdCgkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IGtleTsKCX0sCglyZW1vdmU6IGZ1bmN0aW9uKCBvd25lciwga2V5ICkgewoJCXZhciBpLCBuYW1lLCBjYW1lbCwKCQkJdW5sb2NrID0gdGhpcy5rZXkoIG93bmVyICksCgkJCWNhY2hlID0gdGhpcy5jYWNoZVsgdW5sb2NrIF07CgoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuY2FjaGVbIHVubG9jayBdID0ge307CgoJCX0gZWxzZSB7CgkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBrZXlzCgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIGtleSApICkgewoJCQkJLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KCQkJCS8vIFdoZW4gZGF0YSBpcyBpbml0aWFsbHkgY3JlYXRlZCwgdmlhICgia2V5IiwgInZhbCIpIHNpZ25hdHVyZSwKCQkJCS8vIGtleXMgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2FtZWxDYXNlLgoJCQkJLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKCQkJCS8vIGJvdGggcGxhaW4ga2V5IGFuZCBjYW1lbENhc2Uga2V5LiAjMTI3ODYKCQkJCS8vIFRoaXMgd2lsbCBvbmx5IHBlbmFsaXplIHRoZSBhcnJheSBhcmd1bWVudCBwYXRoLgoJCQkJbmFtZSA9IGtleS5jb25jYXQoIGtleS5tYXAoIGpRdWVyeS5jYW1lbENhc2UgKSApOwoJCQl9IGVsc2UgewoJCQkJY2FtZWwgPSBqUXVlcnkuY2FtZWxDYXNlKCBrZXkgKTsKCQkJCS8vIFRyeSB0aGUgc3RyaW5nIGFzIGEga2V5IGJlZm9yZSBhbnkgbWFuaXB1bGF0aW9uCgkJCQlpZiAoIGtleSBpbiBjYWNoZSApIHsKCQkJCQluYW1lID0gWyBrZXksIGNhbWVsIF07CgkJCQl9IGVsc2UgewoJCQkJCS8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4KCQkJCQkvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQoJCQkJCW5hbWUgPSBjYW1lbDsKCQkJCQluYW1lID0gbmFtZSBpbiBjYWNoZSA/CgkJCQkJCVsgbmFtZSBdIDogKCBuYW1lLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXSApOwoJCQkJfQoJCQl9CgoJCQlpID0gbmFtZS5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJZGVsZXRlIGNhY2hlWyBuYW1lWyBpIF0gXTsKCQkJfQoJCX0KCX0sCgloYXNEYXRhOiBmdW5jdGlvbiggb3duZXIgKSB7CgkJcmV0dXJuICFqUXVlcnkuaXNFbXB0eU9iamVjdCgKCQkJdGhpcy5jYWNoZVsgb3duZXJbIHRoaXMuZXhwYW5kbyBdIF0gfHwge30KCQkpOwoJfSwKCWRpc2NhcmQ6IGZ1bmN0aW9uKCBvd25lciApIHsKCQlpZiAoIG93bmVyWyB0aGlzLmV4cGFuZG8gXSApIHsKCQkJZGVsZXRlIHRoaXMuY2FjaGVbIG93bmVyWyB0aGlzLmV4cGFuZG8gXSBdOwoJCX0KCX0KfTsKdmFyIGRhdGFfcHJpdiA9IG5ldyBEYXRhKCk7Cgp2YXIgZGF0YV91c2VyID0gbmV3IERhdGEoKTsKCgoKLyoKCUltcGxlbWVudGF0aW9uIFN1bW1hcnkKCgkxLiBFbmZvcmNlIEFQSSBzdXJmYWNlIGFuZCBzZW1hbnRpYyBjb21wYXRpYmlsaXR5IHdpdGggMS45LnggYnJhbmNoCgkyLiBJbXByb3ZlIHRoZSBtb2R1bGUncyBtYWludGFpbmFiaWxpdHkgYnkgcmVkdWNpbmcgdGhlIHN0b3JhZ2UKCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uCgkzLiBVc2UgdGhlIHNhbWUgc2luZ2xlIG1lY2hhbmlzbSB0byBzdXBwb3J0ICJwcml2YXRlIiBhbmQgInVzZXIiIGRhdGEuCgk0LiBfTmV2ZXJfIGV4cG9zZSAicHJpdmF0ZSIgZGF0YSB0byB1c2VyIGNvZGUgKFRPRE86IERyb3AgX2RhdGEsIF9yZW1vdmVEYXRhKQoJNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpCgk2LiBQcm92aWRlIGEgY2xlYXIgcGF0aCBmb3IgaW1wbGVtZW50YXRpb24gdXBncmFkZSB0byBXZWFrTWFwIGluIDIwMTQKKi8KdmFyIHJicmFjZSA9IC9eKD86XHtbXHdcV10qXH18XFtbXHdcV10qXF0pJC8sCglybXVsdGlEYXNoID0gLyhbQS1aXSkvZzsKCmZ1bmN0aW9uIGRhdGFBdHRyKCBlbGVtLCBrZXksIGRhdGEgKSB7Cgl2YXIgbmFtZTsKCgkvLyBJZiBub3RoaW5nIHdhcyBmb3VuZCBpbnRlcm5hbGx5LCB0cnkgdG8gZmV0Y2ggYW55CgkvLyBkYXRhIGZyb20gdGhlIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUKCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJbmFtZSA9ICJkYXRhLSIgKyBrZXkucmVwbGFjZSggcm11bHRpRGFzaCwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpOwoJCWRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApOwoKCQlpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8galF1ZXJ5LnBhcnNlSlNPTiggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBzZXQgdGhlIGRhdGEgc28gaXQgaXNuJ3QgY2hhbmdlZCBsYXRlcgoJCQlkYXRhX3VzZXIuc2V0KCBlbGVtLCBrZXksIGRhdGEgKTsKCQl9IGVsc2UgewoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0KCX0KCXJldHVybiBkYXRhOwp9CgpqUXVlcnkuZXh0ZW5kKHsKCWhhc0RhdGE6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBkYXRhX3VzZXIuaGFzRGF0YSggZWxlbSApIHx8IGRhdGFfcHJpdi5oYXNEYXRhKCBlbGVtICk7Cgl9LAoKCWRhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCXJldHVybiBkYXRhX3VzZXIuYWNjZXNzKCBlbGVtLCBuYW1lLCBkYXRhICk7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWRhdGFfdXNlci5yZW1vdmUoIGVsZW0sIG5hbWUgKTsKCX0sCgoJLy8gVE9ETzogTm93IHRoYXQgYWxsIGNhbGxzIHRvIF9kYXRhIGFuZCBfcmVtb3ZlRGF0YSBoYXZlIGJlZW4gcmVwbGFjZWQKCS8vIHdpdGggZGlyZWN0IGNhbGxzIHRvIGRhdGFfcHJpdiBtZXRob2RzLCB0aGVzZSBjYW4gYmUgZGVwcmVjYXRlZC4KCV9kYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQlyZXR1cm4gZGF0YV9wcml2LmFjY2VzcyggZWxlbSwgbmFtZSwgZGF0YSApOwoJfSwKCglfcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkJZGF0YV9wcml2LnJlbW92ZSggZWxlbSwgbmFtZSApOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZGF0YTogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIGksIG5hbWUsIGRhdGEsCgkJCWVsZW0gPSB0aGlzWyAwIF0sCgkJCWF0dHJzID0gZWxlbSAmJiBlbGVtLmF0dHJpYnV0ZXM7CgoJCS8vIEdldHMgYWxsIHZhbHVlcwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CgkJCWlmICggdGhpcy5sZW5ndGggKSB7CgkJCQlkYXRhID0gZGF0YV91c2VyLmdldCggZWxlbSApOwoKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhZGF0YV9wcml2LmdldCggZWxlbSwgImhhc0RhdGFBdHRycyIgKSApIHsKCQkJCQlpID0gYXR0cnMubGVuZ3RoOwoJCQkJCXdoaWxlICggaS0tICkgewoKCQkJCQkJLy8gU3VwcG9ydDogSUUxMSsKCQkJCQkJLy8gVGhlIGF0dHJzIGVsZW1lbnRzIGNhbiBiZSBudWxsICgjMTQ4OTQpCgkJCQkJCWlmICggYXR0cnNbIGkgXSApIHsKCQkJCQkJCW5hbWUgPSBhdHRyc1sgaSBdLm5hbWU7CgkJCQkJCQlpZiAoIG5hbWUuaW5kZXhPZiggImRhdGEtIiApID09PSAwICkgewoJCQkJCQkJCW5hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lLnNsaWNlKDUpICk7CgkJCQkJCQkJZGF0YUF0dHIoIGVsZW0sIG5hbWUsIGRhdGFbIG5hbWUgXSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWRhdGFfcHJpdi5zZXQoIGVsZW0sICJoYXNEYXRhQXR0cnMiLCB0cnVlICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiBkYXRhOwoJCX0KCgkJLy8gU2V0cyBtdWx0aXBsZSB2YWx1ZXMKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJvYmplY3QiICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJZGF0YV91c2VyLnNldCggdGhpcywga2V5ICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZGF0YSwKCQkJCWNhbWVsS2V5ID0galF1ZXJ5LmNhbWVsQ2FzZSgga2V5ICk7CgoJCQkvLyBUaGUgY2FsbGluZyBqUXVlcnkgb2JqZWN0IChlbGVtZW50IG1hdGNoZXMpIGlzIG5vdCBlbXB0eQoJCQkvLyAoYW5kIHRoZXJlZm9yZSBoYXMgYW4gZWxlbWVudCBhcHBlYXJzIGF0IHRoaXNbIDAgXSkgYW5kIHRoZQoJCQkvLyBgdmFsdWVgIHBhcmFtZXRlciB3YXMgbm90IHVuZGVmaW5lZC4gQW4gZW1wdHkgalF1ZXJ5IG9iamVjdAoJCQkvLyB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBmb3IgZWxlbSA9IHRoaXNbIDAgXSB3aGljaCB3aWxsCgkJCS8vIHRocm93IGFuIGV4Y2VwdGlvbiBpZiBhbiBhdHRlbXB0IHRvIHJlYWQgYSBkYXRhIGNhY2hlIGlzIG1hZGUuCgkJCWlmICggZWxlbSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQXR0ZW1wdCB0byBnZXQgZGF0YSBmcm9tIHRoZSBjYWNoZQoJCQkJLy8gd2l0aCB0aGUga2V5IGFzLWlzCgkJCQlkYXRhID0gZGF0YV91c2VyLmdldCggZWxlbSwga2V5ICk7CgkJCQlpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0KCgkJCQkvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCgkJCQkvLyB3aXRoIHRoZSBrZXkgY2FtZWxpemVkCgkJCQlkYXRhID0gZGF0YV91c2VyLmdldCggZWxlbSwgY2FtZWxLZXkgKTsKCQkJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBkYXRhOwoJCQkJfQoKCQkJCS8vIEF0dGVtcHQgdG8gImRpc2NvdmVyIiB0aGUgZGF0YSBpbgoJCQkJLy8gSFRNTDUgY3VzdG9tIGRhdGEtKiBhdHRycwoJCQkJZGF0YSA9IGRhdGFBdHRyKCBlbGVtLCBjYW1lbEtleSwgdW5kZWZpbmVkICk7CgkJCQlpZiAoIGRhdGEgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0KCgkJCQkvLyBXZSB0cmllZCByZWFsbHkgaGFyZCwgYnV0IHRoZSBkYXRhIGRvZXNuJ3QgZXhpc3QuCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFNldCB0aGUgZGF0YS4uLgoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkvLyBGaXJzdCwgYXR0ZW1wdCB0byBzdG9yZSBhIGNvcHkgb3IgcmVmZXJlbmNlIG9mIGFueQoJCQkJLy8gZGF0YSB0aGF0IG1pZ2h0J3ZlIGJlZW4gc3RvcmUgd2l0aCBhIGNhbWVsQ2FzZWQga2V5LgoJCQkJdmFyIGRhdGEgPSBkYXRhX3VzZXIuZ2V0KCB0aGlzLCBjYW1lbEtleSApOwoKCQkJCS8vIEZvciBIVE1MNSBkYXRhLSogYXR0cmlidXRlIGludGVyb3AsIHdlIGhhdmUgdG8KCQkJCS8vIHN0b3JlIHByb3BlcnR5IG5hbWVzIHdpdGggZGFzaGVzIGluIGEgY2FtZWxDYXNlIGZvcm0uCgkJCQkvLyBUaGlzIG1pZ2h0IG5vdCBhcHBseSB0byBhbGwgcHJvcGVydGllcy4uLioKCQkJCWRhdGFfdXNlci5zZXQoIHRoaXMsIGNhbWVsS2V5LCB2YWx1ZSApOwoKCQkJCS8vICouLi4gSW4gdGhlIGNhc2Ugb2YgcHJvcGVydGllcyB0aGF0IG1pZ2h0IF9hY3R1YWxseV8KCQkJCS8vIGhhdmUgZGFzaGVzLCB3ZSBuZWVkIHRvIGFsc28gc3RvcmUgYSBjb3B5IG9mIHRoYXQKCQkJCS8vIHVuY2hhbmdlZCBwcm9wZXJ0eS4KCQkJCWlmICgga2V5LmluZGV4T2YoIi0iKSAhPT0gLTEgJiYgZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWRhdGFfdXNlci5zZXQoIHRoaXMsIGtleSwgdmFsdWUgKTsKCQkJCX0KCQkJfSk7CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlICk7Cgl9LAoKCXJlbW92ZURhdGE6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJZGF0YV91c2VyLnJlbW92ZSggdGhpcywga2V5ICk7CgkJfSk7Cgl9Cn0pOwoKCmpRdWVyeS5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBkYXRhICkgewoJCXZhciBxdWV1ZTsKCgkJaWYgKCBlbGVtICkgewoJCQl0eXBlID0gKCB0eXBlIHx8ICJmeCIgKSArICJxdWV1ZSI7CgkJCXF1ZXVlID0gZGF0YV9wcml2LmdldCggZWxlbSwgdHlwZSApOwoKCQkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAoJCQlpZiAoIGRhdGEgKSB7CgkJCQlpZiAoICFxdWV1ZSB8fCBqUXVlcnkuaXNBcnJheSggZGF0YSApICkgewoJCQkJCXF1ZXVlID0gZGF0YV9wcml2LmFjY2VzcyggZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSApOwoJCQkJfSBlbHNlIHsKCQkJCQlxdWV1ZS5wdXNoKCBkYXRhICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHF1ZXVlIHx8IFtdOwoJCX0KCX0sCgoJZGVxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksCgkJCXN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLAoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCksCgkJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCB0eXBlICksCgkJCW5leHQgPSBmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCBlbGVtLCB0eXBlICk7CgkJCX07CgoJCS8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKCQlpZiAoIGZuID09PSAiaW5wcm9ncmVzcyIgKSB7CgkJCWZuID0gcXVldWUuc2hpZnQoKTsKCQkJc3RhcnRMZW5ndGgtLTsKCQl9CgoJCWlmICggZm4gKSB7CgoJCQkvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCgkJCS8vIGF1dG9tYXRpY2FsbHkgZGVxdWV1ZWQKCQkJaWYgKCB0eXBlID09PSAiZngiICkgewoJCQkJcXVldWUudW5zaGlmdCggImlucHJvZ3Jlc3MiICk7CgkJCX0KCgkJCS8vIGNsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCWZuLmNhbGwoIGVsZW0sIG5leHQsIGhvb2tzICk7CgkJfQoKCQlpZiAoICFzdGFydExlbmd0aCAmJiBob29rcyApIHsKCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCX0KCX0sCgoJLy8gbm90IGludGVuZGVkIGZvciBwdWJsaWMgY29uc3VtcHRpb24gLSBnZW5lcmF0ZXMgYSBxdWV1ZUhvb2tzIG9iamVjdCwgb3IgcmV0dXJucyB0aGUgY3VycmVudCBvbmUKCV9xdWV1ZUhvb2tzOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKCQl2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsKCQlyZXR1cm4gZGF0YV9wcml2LmdldCggZWxlbSwga2V5ICkgfHwgZGF0YV9wcml2LmFjY2VzcyggZWxlbSwga2V5LCB7CgkJCWVtcHR5OiBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLmFkZChmdW5jdGlvbigpIHsKCQkJCWRhdGFfcHJpdi5yZW1vdmUoIGVsZW0sIFsgdHlwZSArICJxdWV1ZSIsIGtleSBdICk7CgkJCX0pCgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglxdWV1ZTogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIHNldHRlciA9IDI7CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlkYXRhID0gdHlwZTsKCQkJdHlwZSA9ICJmeCI7CgkJCXNldHRlci0tOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyICkgewoJCQlyZXR1cm4galF1ZXJ5LnF1ZXVlKCB0aGlzWzBdLCB0eXBlICk7CgkJfQoKCQlyZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgZGF0YSApOwoKCQkJCS8vIGVuc3VyZSBhIGhvb2tzIGZvciB0aGlzIHF1ZXVlCgkJCQlqUXVlcnkuX3F1ZXVlSG9va3MoIHRoaXMsIHR5cGUgKTsKCgkJCQlpZiAoIHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIiApIHsKCQkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCQkJfQoJCQl9KTsKCX0sCglkZXF1ZXVlOiBmdW5jdGlvbiggdHlwZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCX0pOwoJfSwKCWNsZWFyUXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiB0aGlzLnF1ZXVlKCB0eXBlIHx8ICJmeCIsIFtdICk7Cgl9LAoJLy8gR2V0IGEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHF1ZXVlcyBvZiBhIGNlcnRhaW4gdHlwZQoJLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCglwcm9taXNlOiBmdW5jdGlvbiggdHlwZSwgb2JqICkgewoJCXZhciB0bXAsCgkJCWNvdW50ID0gMSwKCQkJZGVmZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKCQkJZWxlbWVudHMgPSB0aGlzLAoJCQlpID0gdGhpcy5sZW5ndGgsCgkJCXJlc29sdmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggISggLS1jb3VudCApICkgewoJCQkJCWRlZmVyLnJlc29sdmVXaXRoKCBlbGVtZW50cywgWyBlbGVtZW50cyBdICk7CgkJCQl9CgkJCX07CgoJCWlmICggdHlwZW9mIHR5cGUgIT09ICJzdHJpbmciICkgewoJCQlvYmogPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQl3aGlsZSAoIGktLSApIHsKCQkJdG1wID0gZGF0YV9wcml2LmdldCggZWxlbWVudHNbIGkgXSwgdHlwZSArICJxdWV1ZUhvb2tzIiApOwoJCQlpZiAoIHRtcCAmJiB0bXAuZW1wdHkgKSB7CgkJCQljb3VudCsrOwoJCQkJdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwoJCQl9CgkJfQoJCXJlc29sdmUoKTsKCQlyZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7Cgl9Cn0pOwp2YXIgcG51bSA9ICgvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvKS5zb3VyY2U7Cgp2YXIgY3NzRXhwYW5kID0gWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdOwoKdmFyIGlzSGlkZGVuID0gZnVuY3Rpb24oIGVsZW0sIGVsICkgewoJCS8vIGlzSGlkZGVuIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CgkJLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CgkJZWxlbSA9IGVsIHx8IGVsZW07CgkJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cgl9OwoKdmFyIHJjaGVja2FibGVUeXBlID0gKC9eKD86Y2hlY2tib3h8cmFkaW8pJC9pKTsKCgoKKGZ1bmN0aW9uKCkgewoJdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCWRpdiA9IGZyYWdtZW50LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICksCgkJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiaW5wdXQiICk7CgoJLy8gIzExMjE3IC0gV2ViS2l0IGxvc2VzIGNoZWNrIHdoZW4gdGhlIG5hbWUgaXMgYWZ0ZXIgdGhlIGNoZWNrZWQgYXR0cmlidXRlCgkvLyBTdXBwb3J0OiBXaW5kb3dzIFdlYiBBcHBzIChXV0EpCgkvLyBgbmFtZWAgYW5kIGB0eXBlYCBuZWVkIC5zZXRBdHRyaWJ1dGUgZm9yIFdXQQoJaW5wdXQuc2V0QXR0cmlidXRlKCAidHlwZSIsICJyYWRpbyIgKTsKCWlucHV0LnNldEF0dHJpYnV0ZSggImNoZWNrZWQiLCAiY2hlY2tlZCIgKTsKCWlucHV0LnNldEF0dHJpYnV0ZSggIm5hbWUiLCAidCIgKTsKCglkaXYuYXBwZW5kQ2hpbGQoIGlucHV0ICk7CgoJLy8gU3VwcG9ydDogU2FmYXJpIDUuMSwgaU9TIDUuMSwgQW5kcm9pZCA0LngsIEFuZHJvaWQgMi4zCgkvLyBvbGQgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBkaXYuY2xvbmVOb2RlKCB0cnVlICkuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmNoZWNrZWQ7CgoJLy8gTWFrZSBzdXJlIHRleHRhcmVhIChhbmQgY2hlY2tib3gpIGRlZmF1bHRWYWx1ZSBpcyBwcm9wZXJseSBjbG9uZWQKCS8vIFN1cHBvcnQ6IElFOS1JRTExKwoJZGl2LmlubmVySFRNTCA9ICI8dGV4dGFyZWE+eDwvdGV4dGFyZWE+IjsKCXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSAhIWRpdi5jbG9uZU5vZGUoIHRydWUgKS5sYXN0Q2hpbGQuZGVmYXVsdFZhbHVlOwp9KSgpOwp2YXIgc3RydW5kZWZpbmVkID0gdHlwZW9mIHVuZGVmaW5lZDsKCgoKc3VwcG9ydC5mb2N1c2luQnViYmxlcyA9ICJvbmZvY3VzaW4iIGluIHdpbmRvdzsKCgp2YXIKCXJrZXlFdmVudCA9IC9ea2V5LywKCXJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxwb2ludGVyfGNvbnRleHRtZW51KXxjbGljay8sCglyZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKCXJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkkLzsKCmZ1bmN0aW9uIHJldHVyblRydWUoKSB7CglyZXR1cm4gdHJ1ZTsKfQoKZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgewoJdHJ5IHsKCQlyZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCX0gY2F0Y2ggKCBlcnIgKSB7IH0KfQoKLyoKICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgZXZlbnRzIC0tIG5vdCBwYXJ0IG9mIHRoZSBwdWJsaWMgaW50ZXJmYWNlLgogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogKi8KalF1ZXJ5LmV2ZW50ID0gewoKCWdsb2JhbDoge30sCgoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgewoKCQl2YXIgaGFuZGxlT2JqSW4sIGV2ZW50SGFuZGxlLCB0bXAsCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0gZGF0YV9wcml2LmdldCggZWxlbSApOwoKCQkvLyBEb24ndCBhdHRhY2ggZXZlbnRzIHRvIG5vRGF0YSBvciB0ZXh0L2NvbW1lbnQgbm9kZXMgKGJ1dCBhbGxvdyBwbGFpbiBvYmplY3RzKQoJCWlmICggIWVsZW1EYXRhICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gb2JqZWN0IG9mIGN1c3RvbSBkYXRhIGluIGxpZXUgb2YgdGhlIGhhbmRsZXIKCQlpZiAoIGhhbmRsZXIuaGFuZGxlciApIHsKCQkJaGFuZGxlT2JqSW4gPSBoYW5kbGVyOwoJCQloYW5kbGVyID0gaGFuZGxlT2JqSW4uaGFuZGxlcjsKCQkJc2VsZWN0b3IgPSBoYW5kbGVPYmpJbi5zZWxlY3RvcjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcgoJCWlmICggIWhhbmRsZXIuZ3VpZCApIHsKCQkJaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKCQl9CgoJCS8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKCQlpZiAoICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSApIHsKCQkJZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzID0ge307CgkJfQoJCWlmICggIShldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSkgKSB7CgkJCWV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7CgkJCQkvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZAoJCQkJLy8gd2hlbiBhbiBldmVudCBpcyBjYWxsZWQgYWZ0ZXIgYSBwYWdlIGhhcyB1bmxvYWRlZAoJCQkJcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09IHN0cnVuZGVmaW5lZCAmJiBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUgPwoJCQkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseSggZWxlbSwgYXJndW1lbnRzICkgOiB1bmRlZmluZWQ7CgkJCX07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIHJub3R3aGl0ZSApIHx8IFsgIiIgXTsKCQl0ID0gdHlwZXMubGVuZ3RoOwoJCXdoaWxlICggdC0tICkgewoJCQl0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKCB0eXBlc1t0XSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CgkJCW5hbWVzcGFjZXMgPSAoIHRtcFsyXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7CgoJCQkvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMKCQkJaWYgKCAhdHlwZSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoKCQkJLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCgkJCWhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewoJCQkJdHlwZTogdHlwZSwKCQkJCW9yaWdUeXBlOiBvcmlnVHlwZSwKCQkJCWRhdGE6IGRhdGEsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJZ3VpZDogaGFuZGxlci5ndWlkLAoJCQkJc2VsZWN0b3I6IHNlbGVjdG9yLAoJCQkJbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSwKCQkJCW5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKCQkJfSwgaGFuZGxlT2JqSW4gKTsKCgkJCS8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CgkJCWlmICggIShoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdKSApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCQkJCWhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJaWYgKCAhc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoIGVsZW0sIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKCBzcGVjaWFsLmFkZCApIHsKCQkJCXNwZWNpYWwuYWRkLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoKCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CgkJCQkJaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKCQkJCX0KCQkJfQoKCQkJLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWhhbmRsZXJzLnNwbGljZSggaGFuZGxlcnMuZGVsZWdhdGVDb3VudCsrLCAwLCBoYW5kbGVPYmogKTsKCQkJfSBlbHNlIHsKCQkJCWhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOwoJCQl9CgoJCQkvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCgkJCWpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSA9IHRydWU7CgkJfQoKCX0sCgoJLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CglyZW1vdmU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzICkgewoKCQl2YXIgaiwgb3JpZ0NvdW50LCB0bXAsCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0gZGF0YV9wcml2Lmhhc0RhdGEoIGVsZW0gKSAmJiBkYXRhX3ByaXYuZ2V0KCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwoJCQluYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQl0bXAgPSB0bXBbMl0gJiYgbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKTsKCgkJCS8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKCQkJb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOwoKCQkJCWlmICggKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYKCQkJCQkoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgoJCQkJCSggIXRtcCB8fCB0bXAudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgJiYKCQkJCQkoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvciApICkgewoJCQkJCWhhbmRsZXJzLnNwbGljZSggaiwgMSApOwoKCQkJCQlpZiAoIGhhbmRsZU9iai5zZWxlY3RvciApIHsKCQkJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudC0tOwoJCQkJCX0KCQkJCQlpZiAoIHNwZWNpYWwucmVtb3ZlICkgewoJCQkJCQlzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCgkJCWlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7CgkJCQlpZiAoICFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbCggZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CgkJCQl9CgoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQlkZWxldGUgZWxlbURhdGEuaGFuZGxlOwoJCQlkYXRhX3ByaXYucmVtb3ZlKCBlbGVtLCAiZXZlbnRzIiApOwoJCX0KCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7CgoJCXZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsCgkJCWV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLAoJCQl0eXBlID0gaGFzT3duLmNhbGwoIGV2ZW50LCAidHlwZSIgKSA/IGV2ZW50LnR5cGUgOiBldmVudCwKCQkJbmFtZXNwYWNlcyA9IGhhc093bi5jYWxsKCBldmVudCwgIm5hbWVzcGFjZSIgKSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgiLiIpIDogW107CgoJCWN1ciA9IHRtcCA9IGVsZW0gPSBlbGVtIHx8IGRvY3VtZW50OwoKCQkvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKCQlpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdHlwZS5pbmRleE9mKCIuIikgPj0gMCApIHsKCQkJLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQoJCQluYW1lc3BhY2VzID0gdHlwZS5zcGxpdCgiLiIpOwoJCQl0eXBlID0gbmFtZXNwYWNlcy5zaGlmdCgpOwoJCQluYW1lc3BhY2VzLnNvcnQoKTsKCQl9CgkJb250eXBlID0gdHlwZS5pbmRleE9mKCI6IikgPCAwICYmICJvbiIgKyB0eXBlOwoKCQkvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKCQlldmVudCA9IGV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8KCQkJZXZlbnQgOgoJCQluZXcgalF1ZXJ5LkV2ZW50KCB0eXBlLCB0eXBlb2YgZXZlbnQgPT09ICJvYmplY3QiICYmIGV2ZW50ICk7CgoJCS8vIFRyaWdnZXIgYml0bWFzazogJiAxIGZvciBuYXRpdmUgaGFuZGxlcnM7ICYgMiBmb3IgalF1ZXJ5IChhbHdheXMgdHJ1ZSkKCQlldmVudC5pc1RyaWdnZXIgPSBvbmx5SGFuZGxlcnMgPyAyIDogMzsKCQlldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oIi4iKTsKCQlldmVudC5uYW1lc3BhY2VfcmUgPSBldmVudC5uYW1lc3BhY2UgPwoJCQluZXcgUmVnRXhwKCAiKF58XFwuKSIgKyBuYW1lc3BhY2VzLmpvaW4oIlxcLig/Oi4qXFwufCkiKSArICIoXFwufCQpIiApIDoKCQkJbnVsbDsKCgkJLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCgkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwoJCWlmICggIWV2ZW50LnRhcmdldCApIHsKCQkJZXZlbnQudGFyZ2V0ID0gZWxlbTsKCQl9CgoJCS8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QKCQlkYXRhID0gZGF0YSA9PSBudWxsID8KCQkJWyBldmVudCBdIDoKCQkJalF1ZXJ5Lm1ha2VBcnJheSggZGF0YSwgWyBldmVudCBdICk7CgoJCS8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCgkJLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJYnViYmxlVHlwZSA9IHNwZWNpYWwuZGVsZWdhdGVUeXBlIHx8IHR5cGU7CgkJCWlmICggIXJmb2N1c01vcnBoLnRlc3QoIGJ1YmJsZVR5cGUgKyB0eXBlICkgKSB7CgkJCQljdXIgPSBjdXIucGFyZW50Tm9kZTsKCQkJfQoJCQlmb3IgKCA7IGN1cjsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgkJCQlldmVudFBhdGgucHVzaCggY3VyICk7CgkJCQl0bXAgPSBjdXI7CgkJCX0KCgkJCS8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQoJCQlpZiAoIHRtcCA9PT0gKGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCkgKSB7CgkJCQlldmVudFBhdGgucHVzaCggdG1wLmRlZmF1bHRWaWV3IHx8IHRtcC5wYXJlbnRXaW5kb3cgfHwgd2luZG93ICk7CgkJCX0KCQl9CgoJCS8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKCQlpID0gMDsKCQl3aGlsZSAoIChjdXIgPSBldmVudFBhdGhbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgoJCQlldmVudC50eXBlID0gaSA+IDEgPwoJCQkJYnViYmxlVHlwZSA6CgkJCQlzcGVjaWFsLmJpbmRUeXBlIHx8IHR5cGU7CgoJCQkvLyBqUXVlcnkgaGFuZGxlcgoJCQloYW5kbGUgPSAoIGRhdGFfcHJpdi5nZXQoIGN1ciwgImV2ZW50cyIgKSB8fCB7fSApWyBldmVudC50eXBlIF0gJiYgZGF0YV9wcml2LmdldCggY3VyLCAiaGFuZGxlIiApOwoJCQlpZiAoIGhhbmRsZSApIHsKCQkJCWhhbmRsZS5hcHBseSggY3VyLCBkYXRhICk7CgkJCX0KCgkJCS8vIE5hdGl2ZSBoYW5kbGVyCgkJCWhhbmRsZSA9IG9udHlwZSAmJiBjdXJbIG9udHlwZSBdOwoJCQlpZiAoIGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICkgewoJCQkJZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KCBjdXIsIGRhdGEgKTsKCQkJCWlmICggZXZlbnQucmVzdWx0ID09PSBmYWxzZSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgkJfQoJCWV2ZW50LnR5cGUgPSB0eXBlOwoKCQkvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCgkJCWlmICggKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoIGV2ZW50UGF0aC5wb3AoKSwgZGF0YSApID09PSBmYWxzZSkgJiYKCQkJCWpRdWVyeS5hY2NlcHREYXRhKCBlbGVtICkgKSB7CgoJCQkJLy8gQ2FsbCBhIG5hdGl2ZSBET00gbWV0aG9kIG9uIHRoZSB0YXJnZXQgd2l0aCB0aGUgc2FtZSBuYW1lIG5hbWUgYXMgdGhlIGV2ZW50LgoJCQkJLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQoJCQkJaWYgKCBvbnR5cGUgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIGVsZW1bIHR5cGUgXSApICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCQkJLy8gRG9uJ3QgcmUtdHJpZ2dlciBhbiBvbkZPTyBldmVudCB3aGVuIHdlIGNhbGwgaXRzIEZPTygpIG1ldGhvZAoJCQkJCXRtcCA9IGVsZW1bIG9udHlwZSBdOwoKCQkJCQlpZiAoIHRtcCApIHsKCQkJCQkJZWxlbVsgb250eXBlIF0gPSBudWxsOwoJCQkJCX0KCgkJCQkJLy8gUHJldmVudCByZS10cmlnZ2VyaW5nIG9mIHRoZSBzYW1lIGV2ZW50LCBzaW5jZSB3ZSBhbHJlYWR5IGJ1YmJsZWQgaXQgYWJvdmUKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdHlwZTsKCQkJCQllbGVtWyB0eXBlIF0oKTsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOwoKCQkJCQlpZiAoIHRtcCApIHsKCQkJCQkJZWxlbVsgb250eXBlIF0gPSB0bXA7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCglkaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKCQlldmVudCA9IGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICk7CgoJCXZhciBpLCBqLCByZXQsIG1hdGNoZWQsIGhhbmRsZU9iaiwKCQkJaGFuZGxlclF1ZXVlID0gW10sCgkJCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSwKCQkJaGFuZGxlcnMgPSAoIGRhdGFfcHJpdi5nZXQoIHRoaXMsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdIHx8IFtdLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGV2ZW50LnR5cGUgXSB8fCB7fTsKCgkJLy8gVXNlIHRoZSBmaXgtZWQgalF1ZXJ5LkV2ZW50IHJhdGhlciB0aGFuIHRoZSAocmVhZC1vbmx5KSBuYXRpdmUgZXZlbnQKCQlhcmdzWzBdID0gZXZlbnQ7CgkJZXZlbnQuZGVsZWdhdGVUYXJnZXQgPSB0aGlzOwoKCQkvLyBDYWxsIHRoZSBwcmVEaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUsIGFuZCBsZXQgaXQgYmFpbCBpZiBkZXNpcmVkCgkJaWYgKCBzcGVjaWFsLnByZURpc3BhdGNoICYmIHNwZWNpYWwucHJlRGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBoYW5kbGVycwoJCWhhbmRsZXJRdWV1ZSA9IGpRdWVyeS5ldmVudC5oYW5kbGVycy5jYWxsKCB0aGlzLCBldmVudCwgaGFuZGxlcnMgKTsKCgkJLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKCQlpID0gMDsKCQl3aGlsZSAoIChtYXRjaGVkID0gaGFuZGxlclF1ZXVlWyBpKysgXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgoJCQlqID0gMDsKCQkJd2hpbGUgKCAoaGFuZGxlT2JqID0gbWF0Y2hlZC5oYW5kbGVyc1sgaisrIF0pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKCQkJCS8vIFRyaWdnZXJlZCBldmVudCBtdXN0IGVpdGhlciAxKSBoYXZlIG5vIG5hbWVzcGFjZSwgb3IKCQkJCS8vIDIpIGhhdmUgbmFtZXNwYWNlKHMpIGEgc3Vic2V0IG9yIGVxdWFsIHRvIHRob3NlIGluIHRoZSBib3VuZCBldmVudCAoYm90aCBjYW4gaGF2ZSBubyBuYW1lc3BhY2UpLgoJCQkJaWYgKCAhZXZlbnQubmFtZXNwYWNlX3JlIHx8IGV2ZW50Lm5hbWVzcGFjZV9yZS50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSB7CgoJCQkJCWV2ZW50LmhhbmRsZU9iaiA9IGhhbmRsZU9iajsKCQkJCQlldmVudC5kYXRhID0gaGFuZGxlT2JqLmRhdGE7CgoJCQkJCXJldCA9ICggKGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSkuaGFuZGxlIHx8IGhhbmRsZU9iai5oYW5kbGVyICkKCQkJCQkJCS5hcHBseSggbWF0Y2hlZC5lbGVtLCBhcmdzICk7CgoJCQkJCWlmICggcmV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJCWlmICggKGV2ZW50LnJlc3VsdCA9IHJldCkgPT09IGZhbHNlICkgewoJCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBDYWxsIHRoZSBwb3N0RGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlCgkJaWYgKCBzcGVjaWFsLnBvc3REaXNwYXRjaCApIHsKCQkJc3BlY2lhbC5wb3N0RGlzcGF0Y2guY2FsbCggdGhpcywgZXZlbnQgKTsKCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWhhbmRsZXJzOiBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXJzICkgewoJCXZhciBpLCBtYXRjaGVzLCBzZWwsIGhhbmRsZU9iaiwKCQkJaGFuZGxlclF1ZXVlID0gW10sCgkJCWRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LAoJCQljdXIgPSBldmVudC50YXJnZXQ7CgoJCS8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKCQkvLyBCbGFjay1ob2xlIFNWRyA8dXNlPiBpbnN0YW5jZSB0cmVlcyAoIzEzMTgwKQoJCS8vIEF2b2lkIG5vbi1sZWZ0LWNsaWNrIGJ1YmJsaW5nIGluIEZpcmVmb3ggKCMzODYxKQoJCWlmICggZGVsZWdhdGVDb3VudCAmJiBjdXIubm9kZVR5cGUgJiYgKCFldmVudC5idXR0b24gfHwgZXZlbnQudHlwZSAhPT0gImNsaWNrIikgKSB7CgoJCQlmb3IgKCA7IGN1ciAhPT0gdGhpczsgY3VyID0gY3VyLnBhcmVudE5vZGUgfHwgdGhpcyApIHsKCgkJCQkvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkKCQkJCWlmICggY3VyLmRpc2FibGVkICE9PSB0cnVlIHx8IGV2ZW50LnR5cGUgIT09ICJjbGljayIgKSB7CgkJCQkJbWF0Y2hlcyA9IFtdOwoJCQkJCWZvciAoIGkgPSAwOyBpIDwgZGVsZWdhdGVDb3VudDsgaSsrICkgewoJCQkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaSBdOwoKCQkJCQkJLy8gRG9uJ3QgY29uZmxpY3Qgd2l0aCBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKCMxMzIwMykKCQkJCQkJc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yICsgIiAiOwoKCQkJCQkJaWYgKCBtYXRjaGVzWyBzZWwgXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJbWF0Y2hlc1sgc2VsIF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8KCQkJCQkJCQlqUXVlcnkoIHNlbCwgdGhpcyApLmluZGV4KCBjdXIgKSA+PSAwIDoKCQkJCQkJCQlqUXVlcnkuZmluZCggc2VsLCB0aGlzLCBudWxsLCBbIGN1ciBdICkubGVuZ3RoOwoJCQkJCQl9CgkJCQkJCWlmICggbWF0Y2hlc1sgc2VsIF0gKSB7CgkJCQkJCQltYXRjaGVzLnB1c2goIGhhbmRsZU9iaiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmICggbWF0Y2hlcy5sZW5ndGggKSB7CgkJCQkJCWhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogY3VyLCBoYW5kbGVyczogbWF0Y2hlcyB9KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEFkZCB0aGUgcmVtYWluaW5nIChkaXJlY3RseS1ib3VuZCkgaGFuZGxlcnMKCQlpZiAoIGRlbGVnYXRlQ291bnQgPCBoYW5kbGVycy5sZW5ndGggKSB7CgkJCWhhbmRsZXJRdWV1ZS5wdXNoKHsgZWxlbTogdGhpcywgaGFuZGxlcnM6IGhhbmRsZXJzLnNsaWNlKCBkZWxlZ2F0ZUNvdW50ICkgfSk7CgkJfQoKCQlyZXR1cm4gaGFuZGxlclF1ZXVlOwoJfSwKCgkvLyBJbmNsdWRlcyBzb21lIGV2ZW50IHByb3BzIHNoYXJlZCBieSBLZXlFdmVudCBhbmQgTW91c2VFdmVudAoJcHJvcHM6ICJhbHRLZXkgYnViYmxlcyBjYW5jZWxhYmxlIGN0cmxLZXkgY3VycmVudFRhcmdldCBldmVudFBoYXNlIG1ldGFLZXkgcmVsYXRlZFRhcmdldCBzaGlmdEtleSB0YXJnZXQgdGltZVN0YW1wIHZpZXcgd2hpY2giLnNwbGl0KCIgIiksCgoJZml4SG9va3M6IHt9LAoKCWtleUhvb2tzOiB7CgkJcHJvcHM6ICJjaGFyIGNoYXJDb2RlIGtleSBrZXlDb2RlIi5zcGxpdCgiICIpLAoJCWZpbHRlcjogZnVuY3Rpb24oIGV2ZW50LCBvcmlnaW5hbCApIHsKCgkJCS8vIEFkZCB3aGljaCBmb3Iga2V5IGV2ZW50cwoJCQlpZiAoIGV2ZW50LndoaWNoID09IG51bGwgKSB7CgkJCQlldmVudC53aGljaCA9IG9yaWdpbmFsLmNoYXJDb2RlICE9IG51bGwgPyBvcmlnaW5hbC5jaGFyQ29kZSA6IG9yaWdpbmFsLmtleUNvZGU7CgkJCX0KCgkJCXJldHVybiBldmVudDsKCQl9Cgl9LAoKCW1vdXNlSG9va3M6IHsKCQlwcm9wczogImJ1dHRvbiBidXR0b25zIGNsaWVudFggY2xpZW50WSBvZmZzZXRYIG9mZnNldFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIHRvRWxlbWVudCIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgkJCXZhciBldmVudERvYywgZG9jLCBib2R5LAoJCQkJYnV0dG9uID0gb3JpZ2luYWwuYnV0dG9uOwoKCQkJLy8gQ2FsY3VsYXRlIHBhZ2VYL1kgaWYgbWlzc2luZyBhbmQgY2xpZW50WC9ZIGF2YWlsYWJsZQoJCQlpZiAoIGV2ZW50LnBhZ2VYID09IG51bGwgJiYgb3JpZ2luYWwuY2xpZW50WCAhPSBudWxsICkgewoJCQkJZXZlbnREb2MgPSBldmVudC50YXJnZXQub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKCQkJCWRvYyA9IGV2ZW50RG9jLmRvY3VtZW50RWxlbWVudDsKCQkJCWJvZHkgPSBldmVudERvYy5ib2R5OwoKCQkJCWV2ZW50LnBhZ2VYID0gb3JpZ2luYWwuY2xpZW50WCArICggZG9jICYmIGRvYy5zY3JvbGxMZWZ0IHx8IGJvZHkgJiYgYm9keS5zY3JvbGxMZWZ0IHx8IDAgKSAtICggZG9jICYmIGRvYy5jbGllbnRMZWZ0IHx8IGJvZHkgJiYgYm9keS5jbGllbnRMZWZ0IHx8IDAgKTsKCQkJCWV2ZW50LnBhZ2VZID0gb3JpZ2luYWwuY2xpZW50WSArICggZG9jICYmIGRvYy5zY3JvbGxUb3AgIHx8IGJvZHkgJiYgYm9keS5zY3JvbGxUb3AgIHx8IDAgKSAtICggZG9jICYmIGRvYy5jbGllbnRUb3AgIHx8IGJvZHkgJiYgYm9keS5jbGllbnRUb3AgIHx8IDAgKTsKCQkJfQoKCQkJLy8gQWRkIHdoaWNoIGZvciBjbGljazogMSA9PT0gbGVmdDsgMiA9PT0gbWlkZGxlOyAzID09PSByaWdodAoJCQkvLyBOb3RlOiBidXR0b24gaXMgbm90IG5vcm1hbGl6ZWQsIHNvIGRvbid0IHVzZSBpdAoJCQlpZiAoICFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCApIHsKCQkJCWV2ZW50LndoaWNoID0gKCBidXR0b24gJiAxID8gMSA6ICggYnV0dG9uICYgMiA/IDMgOiAoIGJ1dHRvbiAmIDQgPyAyIDogMCApICkgKTsKCQkJfQoKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCX0sCgoJZml4OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSApIHsKCQkJcmV0dXJuIGV2ZW50OwoJCX0KCgkJLy8gQ3JlYXRlIGEgd3JpdGFibGUgY29weSBvZiB0aGUgZXZlbnQgb2JqZWN0IGFuZCBub3JtYWxpemUgc29tZSBwcm9wZXJ0aWVzCgkJdmFyIGksIHByb3AsIGNvcHksCgkJCXR5cGUgPSBldmVudC50eXBlLAoJCQlvcmlnaW5hbEV2ZW50ID0gZXZlbnQsCgkJCWZpeEhvb2sgPSB0aGlzLmZpeEhvb2tzWyB0eXBlIF07CgoJCWlmICggIWZpeEhvb2sgKSB7CgkJCXRoaXMuZml4SG9va3NbIHR5cGUgXSA9IGZpeEhvb2sgPQoJCQkJcm1vdXNlRXZlbnQudGVzdCggdHlwZSApID8gdGhpcy5tb3VzZUhvb2tzIDoKCQkJCXJrZXlFdmVudC50ZXN0KCB0eXBlICkgPyB0aGlzLmtleUhvb2tzIDoKCQkJCXt9OwoJCX0KCQljb3B5ID0gZml4SG9vay5wcm9wcyA/IHRoaXMucHJvcHMuY29uY2F0KCBmaXhIb29rLnByb3BzICkgOiB0aGlzLnByb3BzOwoKCQlldmVudCA9IG5ldyBqUXVlcnkuRXZlbnQoIG9yaWdpbmFsRXZlbnQgKTsKCgkJaSA9IGNvcHkubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQlwcm9wID0gY29weVsgaSBdOwoJCQlldmVudFsgcHJvcCBdID0gb3JpZ2luYWxFdmVudFsgcHJvcCBdOwoJCX0KCgkJLy8gU3VwcG9ydDogQ29yZG92YSAyLjUgKFdlYktpdCkgKCMxMzI1NSkKCQkvLyBBbGwgZXZlbnRzIHNob3VsZCBoYXZlIGEgdGFyZ2V0OyBDb3Jkb3ZhIGRldmljZXJlYWR5IGRvZXNuJ3QKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGRvY3VtZW50OwoJCX0KCgkJLy8gU3VwcG9ydDogU2FmYXJpIDYuMCssIENocm9tZSA8IDI4CgkJLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKCM1MDQsICMxMzE0MykKCQlpZiAoIGV2ZW50LnRhcmdldC5ub2RlVHlwZSA9PT0gMyApIHsKCQkJZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0LnBhcmVudE5vZGU7CgkJfQoKCQlyZXR1cm4gZml4SG9vay5maWx0ZXIgPyBmaXhIb29rLmZpbHRlciggZXZlbnQsIG9yaWdpbmFsRXZlbnQgKSA6IGV2ZW50OwoJfSwKCglzcGVjaWFsOiB7CgkJbG9hZDogewoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCgkJCW5vQnViYmxlOiB0cnVlCgkJfSwKCQlmb2N1czogewoJCQkvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgIT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5mb2N1cyApIHsKCQkJCQl0aGlzLmZvY3VzKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgoJCX0sCgkJYmx1cjogewoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcyA9PT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmJsdXIgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIKCQl9LAoJCWNsaWNrOiB7CgkJCS8vIEZvciBjaGVja2JveCwgZmlyZSBuYXRpdmUgZXZlbnQgc28gY2hlY2tlZCBzdGF0ZSB3aWxsIGJlIHJpZ2h0CgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgJiYgdGhpcy5jbGljayAmJiBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJpbnB1dCIgKSApIHsKCQkJCQl0aGlzLmNsaWNrKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoKCQkJLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIGRvbid0IGZpcmUgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCgkJCV9kZWZhdWx0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBldmVudC50YXJnZXQsICJhIiApOwoJCQl9CgkJfSwKCgkJYmVmb3JldW5sb2FkOiB7CgkJCXBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggMjArCgkJCQkvLyBGaXJlZm94IGRvZXNuJ3QgYWxlcnQgaWYgdGhlIHJldHVyblZhbHVlIGZpZWxkIGlzIG5vdCBzZXQuCgkJCQlpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIGV2ZW50Lm9yaWdpbmFsRXZlbnQgKSB7CgkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJc2ltdWxhdGU6IGZ1bmN0aW9uKCB0eXBlLCBlbGVtLCBldmVudCwgYnViYmxlICkgewoJCS8vIFBpZ2d5YmFjayBvbiBhIGRvbm9yIGV2ZW50IHRvIHNpbXVsYXRlIGEgZGlmZmVyZW50IG9uZS4KCQkvLyBGYWtlIG9yaWdpbmFsRXZlbnQgdG8gYXZvaWQgZG9ub3IncyBzdG9wUHJvcGFnYXRpb24sIGJ1dCBpZiB0aGUKCQkvLyBzaW11bGF0ZWQgZXZlbnQgcHJldmVudHMgZGVmYXVsdCB0aGVuIHdlIGRvIHRoZSBzYW1lIG9uIHRoZSBkb25vci4KCQl2YXIgZSA9IGpRdWVyeS5leHRlbmQoCgkJCW5ldyBqUXVlcnkuRXZlbnQoKSwKCQkJZXZlbnQsCgkJCXsKCQkJCXR5cGU6IHR5cGUsCgkJCQlpc1NpbXVsYXRlZDogdHJ1ZSwKCQkJCW9yaWdpbmFsRXZlbnQ6IHt9CgkJCX0KCQkpOwoJCWlmICggYnViYmxlICkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOwoJCX0gZWxzZSB7CgkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5jYWxsKCBlbGVtLCBlICk7CgkJfQoJCWlmICggZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9Cn07CgpqUXVlcnkucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiggZWxlbSwgdHlwZSwgaGFuZGxlICkgewoJaWYgKCBlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIgKSB7CgkJZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKCB0eXBlLCBoYW5kbGUsIGZhbHNlICk7Cgl9Cn07CgpqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiggc3JjLCBwcm9wcyApIHsKCS8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAoJaWYgKCAhKHRoaXMgaW5zdGFuY2VvZiBqUXVlcnkuRXZlbnQpICkgewoJCXJldHVybiBuZXcgalF1ZXJ5LkV2ZW50KCBzcmMsIHByb3BzICk7Cgl9CgoJLy8gRXZlbnQgb2JqZWN0CglpZiAoIHNyYyAmJiBzcmMudHlwZSApIHsKCQl0aGlzLm9yaWdpbmFsRXZlbnQgPSBzcmM7CgkJdGhpcy50eXBlID0gc3JjLnR5cGU7CgoJCS8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCgkJLy8gYnkgYSBoYW5kbGVyIGxvd2VyIGRvd24gdGhlIHRyZWU7IHJlZmxlY3QgdGhlIGNvcnJlY3QgdmFsdWUuCgkJdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fAoJCQkJc3JjLmRlZmF1bHRQcmV2ZW50ZWQgPT09IHVuZGVmaW5lZCAmJgoJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQuMAoJCQkJc3JjLnJldHVyblZhbHVlID09PSBmYWxzZSA/CgkJCXJldHVyblRydWUgOgoJCQlyZXR1cm5GYWxzZTsKCgkvLyBFdmVudCB0eXBlCgl9IGVsc2UgewoJCXRoaXMudHlwZSA9IHNyYzsKCX0KCgkvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAoJaWYgKCBwcm9wcyApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0aGlzLCBwcm9wcyApOwoJfQoKCS8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCgl0aGlzLnRpbWVTdGFtcCA9IHNyYyAmJiBzcmMudGltZVN0YW1wIHx8IGpRdWVyeS5ub3coKTsKCgkvLyBNYXJrIGl0IGFzIGZpeGVkCgl0aGlzWyBqUXVlcnkuZXhwYW5kbyBdID0gdHJ1ZTsKfTsKCi8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwovLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKCWlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCglpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCglpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwoKCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CgoJCWlmICggZSAmJiBlLnByZXZlbnREZWZhdWx0ICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJfQoKCQl0aGlzLnN0b3BQcm9wYWdhdGlvbigpOwoJfQp9OwoKLy8gQ3JlYXRlIG1vdXNlZW50ZXIvbGVhdmUgZXZlbnRzIHVzaW5nIG1vdXNlb3Zlci9vdXQgYW5kIGV2ZW50LXRpbWUgY2hlY2tzCi8vIFN1cHBvcnQ6IENocm9tZSAxNSsKalF1ZXJ5LmVhY2goewoJbW91c2VlbnRlcjogIm1vdXNlb3ZlciIsCgltb3VzZWxlYXZlOiAibW91c2VvdXQiLAoJcG9pbnRlcmVudGVyOiAicG9pbnRlcm92ZXIiLAoJcG9pbnRlcmxlYXZlOiAicG9pbnRlcm91dCIKfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBvcmlnIF0gPSB7CgkJZGVsZWdhdGVUeXBlOiBmaXgsCgkJYmluZFR5cGU6IGZpeCwKCgkJaGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciByZXQsCgkJCQl0YXJnZXQgPSB0aGlzLAoJCQkJcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQsCgkJCQloYW5kbGVPYmogPSBldmVudC5oYW5kbGVPYmo7CgoJCQkvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCgkJCS8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CgkJCWlmICggIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhalF1ZXJ5LmNvbnRhaW5zKCB0YXJnZXQsIHJlbGF0ZWQgKSkgKSB7CgkJCQlldmVudC50eXBlID0gaGFuZGxlT2JqLm9yaWdUeXBlOwoJCQkJcmV0ID0gaGFuZGxlT2JqLmhhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJZXZlbnQudHlwZSA9IGZpeDsKCQkJfQoJCQlyZXR1cm4gcmV0OwoJCX0KCX07Cn0pOwoKLy8gQ3JlYXRlICJidWJibGluZyIgZm9jdXMgYW5kIGJsdXIgZXZlbnRzCi8vIFN1cHBvcnQ6IEZpcmVmb3gsIENocm9tZSwgU2FmYXJpCmlmICggIXN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgKSB7CglqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudCB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQKCQl2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICksIHRydWUgKTsKCQkJfTsKCgkJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIGZpeCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgZG9jID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMsCgkJCQkJYXR0YWNoZXMgPSBkYXRhX3ByaXYuYWNjZXNzKCBkb2MsIGZpeCApOwoKCQkJCWlmICggIWF0dGFjaGVzICkgewoJCQkJCWRvYy5hZGRFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCQl9CgkJCQlkYXRhX3ByaXYuYWNjZXNzKCBkb2MsIGZpeCwgKCBhdHRhY2hlcyB8fCAwICkgKyAxICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCXZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywKCQkJCQlhdHRhY2hlcyA9IGRhdGFfcHJpdi5hY2Nlc3MoIGRvYywgZml4ICkgLSAxOwoKCQkJCWlmICggIWF0dGFjaGVzICkgewoJCQkJCWRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCBvcmlnLCBoYW5kbGVyLCB0cnVlICk7CgkJCQkJZGF0YV9wcml2LnJlbW92ZSggZG9jLCBmaXggKTsKCgkJCQl9IGVsc2UgewoJCQkJCWRhdGFfcHJpdi5hY2Nlc3MoIGRvYywgZml4LCBhdHRhY2hlcyApOwoJCQkJfQoJCQl9CgkJfTsKCX0pOwp9CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCglvbjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIC8qSU5URVJOQUwqLyBvbmUgKSB7CgkJdmFyIG9yaWdGbiwgdHlwZTsKCgkJLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoJCQkvLyAoIHR5cGVzLU9iamVjdCwgc2VsZWN0b3IsIGRhdGEgKQoJCQlpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CgkJCQkvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCgkJCQlkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKCQkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCQl9CgkJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCQl0aGlzLm9uKCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIGRhdGEgPT0gbnVsbCAmJiBmbiA9PSBudWxsICkgewoJCQkvLyAoIHR5cGVzLCBmbiApCgkJCWZuID0gc2VsZWN0b3I7CgkJCWRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9IGVsc2UgaWYgKCBmbiA9PSBudWxsICkgewoJCQlpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCQkvLyAoIHR5cGVzLCBzZWxlY3RvciwgZm4gKQoJCQkJZm4gPSBkYXRhOwoJCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQkJfSBlbHNlIHsKCQkJCS8vICggdHlwZXMsIGRhdGEsIGZuICkKCQkJCWZuID0gZGF0YTsKCQkJCWRhdGEgPSBzZWxlY3RvcjsKCQkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCQl9CgkJfQoJCWlmICggZm4gPT09IGZhbHNlICkgewoJCQlmbiA9IHJldHVybkZhbHNlOwoJCX0gZWxzZSBpZiAoICFmbiApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIG9uZSA9PT0gMSApIHsKCQkJb3JpZ0ZuID0gZm47CgkJCWZuID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCgkJCQlqUXVlcnkoKS5vZmYoIGV2ZW50ICk7CgkJCQlyZXR1cm4gb3JpZ0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfTsKCQkJLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KCQkJZm4uZ3VpZCA9IG9yaWdGbi5ndWlkIHx8ICggb3JpZ0ZuLmd1aWQgPSBqUXVlcnkuZ3VpZCsrICk7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQuYWRkKCB0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yICk7CgkJfSk7Cgl9LAoJb25lOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSApOwoJfSwKCW9mZjogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZm4gKSB7CgkJdmFyIGhhbmRsZU9iaiwgdHlwZTsKCQlpZiAoIHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaiApIHsKCQkJLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAoJCQloYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CgkJCWpRdWVyeSggdHlwZXMuZGVsZWdhdGVUYXJnZXQgKS5vZmYoCgkJCQloYW5kbGVPYmoubmFtZXNwYWNlID8gaGFuZGxlT2JqLm9yaWdUeXBlICsgIi4iICsgaGFuZGxlT2JqLm5hbWVzcGFjZSA6IGhhbmRsZU9iai5vcmlnVHlwZSwKCQkJCWhhbmRsZU9iai5zZWxlY3RvciwKCQkJCWhhbmRsZU9iai5oYW5kbGVyCgkJCSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CgkJCS8vICggdHlwZXMtb2JqZWN0IFssIHNlbGVjdG9yXSApCgkJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCQl0aGlzLm9mZiggdHlwZSwgc2VsZWN0b3IsIHR5cGVzWyB0eXBlIF0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCBzZWxlY3RvciA9PT0gZmFsc2UgfHwgdHlwZW9mIHNlbGVjdG9yID09PSAiZnVuY3Rpb24iICkgewoJCQkvLyAoIHR5cGVzIFssIGZuXSApCgkJCWZuID0gc2VsZWN0b3I7CgkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggdGhpcywgdHlwZXMsIGZuLCBzZWxlY3RvciApOwoJCX0pOwoJfSwKCgl0cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOwoJCX0pOwoJfSwKCXRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiggdHlwZSwgZGF0YSApIHsKCQl2YXIgZWxlbSA9IHRoaXNbMF07CgkJaWYgKCBlbGVtICkgewoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIGVsZW0sIHRydWUgKTsKCQl9Cgl9Cn0pOwoKCnZhcgoJcnhodG1sVGFnID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naSwKCXJ0YWdOYW1lID0gLzwoW1x3Ol0rKS8sCglyaHRtbCA9IC88fCYjP1x3KzsvLAoJcm5vSW5uZXJodG1sID0gLzwoPzpzY3JpcHR8c3R5bGV8bGluaykvaSwKCS8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQKCXJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCglyc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKCXJzY3JpcHRUeXBlTWFza2VkID0gL150cnVlXC8oLiopLywKCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZywKCgkvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQoJd3JhcE1hcCA9IHsKCgkJLy8gU3VwcG9ydDogSUUgOQoJCW9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCgoJCXRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAoJCWNvbDogWyAyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKCQl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKCQl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCgkJX2RlZmF1bHQ6IFsgMCwgIiIsICIiIF0KCX07CgovLyBTdXBwb3J0OiBJRSA5CndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKCndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKLy8gU3VwcG9ydDogMS54IGNvbXBhdGliaWxpdHkKLy8gTWFuaXB1bGF0aW5nIHRhYmxlcyByZXF1aXJlcyBhIHRib2R5CmZ1bmN0aW9uIG1hbmlwdWxhdGlvblRhcmdldCggZWxlbSwgY29udGVudCApIHsKCXJldHVybiBqUXVlcnkubm9kZU5hbWUoIGVsZW0sICJ0YWJsZSIgKSAmJgoJCWpRdWVyeS5ub2RlTmFtZSggY29udGVudC5ub2RlVHlwZSAhPT0gMTEgPyBjb250ZW50IDogY29udGVudC5maXJzdENoaWxkLCAidHIiICkgPwoKCQllbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8CgkJCWVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpICkgOgoJCWVsZW07Cn0KCi8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KZnVuY3Rpb24gZGlzYWJsZVNjcmlwdCggZWxlbSApIHsKCWVsZW0udHlwZSA9IChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpICE9PSBudWxsKSArICIvIiArIGVsZW0udHlwZTsKCXJldHVybiBlbGVtOwp9CmZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoIGVsZW0gKSB7Cgl2YXIgbWF0Y2ggPSByc2NyaXB0VHlwZU1hc2tlZC5leGVjKCBlbGVtLnR5cGUgKTsKCglpZiAoIG1hdGNoICkgewoJCWVsZW0udHlwZSA9IG1hdGNoWyAxIF07Cgl9IGVsc2UgewoJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCJ0eXBlIik7Cgl9CgoJcmV0dXJuIGVsZW07Cn0KCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7Cgl2YXIgaSA9IDAsCgkJbCA9IGVsZW1zLmxlbmd0aDsKCglmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJZGF0YV9wcml2LnNldCgKCQkJZWxlbXNbIGkgXSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgZGF0YV9wcml2LmdldCggcmVmRWxlbWVudHNbIGkgXSwgImdsb2JhbEV2YWwiICkKCQkpOwoJfQp9CgpmdW5jdGlvbiBjbG9uZUNvcHlFdmVudCggc3JjLCBkZXN0ICkgewoJdmFyIGksIGwsIHR5cGUsIHBkYXRhT2xkLCBwZGF0YUN1ciwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CgoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCgkvLyAxLiBDb3B5IHByaXZhdGUgZGF0YTogZXZlbnRzLCBoYW5kbGVycywgZXRjLgoJaWYgKCBkYXRhX3ByaXYuaGFzRGF0YSggc3JjICkgKSB7CgkJcGRhdGFPbGQgPSBkYXRhX3ByaXYuYWNjZXNzKCBzcmMgKTsKCQlwZGF0YUN1ciA9IGRhdGFfcHJpdi5zZXQoIGRlc3QsIHBkYXRhT2xkICk7CgkJZXZlbnRzID0gcGRhdGFPbGQuZXZlbnRzOwoKCQlpZiAoIGV2ZW50cyApIHsKCQkJZGVsZXRlIHBkYXRhQ3VyLmhhbmRsZTsKCQkJcGRhdGFDdXIuZXZlbnRzID0ge307CgoJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyAyLiBDb3B5IHVzZXIgZGF0YQoJaWYgKCBkYXRhX3VzZXIuaGFzRGF0YSggc3JjICkgKSB7CgkJdWRhdGFPbGQgPSBkYXRhX3VzZXIuYWNjZXNzKCBzcmMgKTsKCQl1ZGF0YUN1ciA9IGpRdWVyeS5leHRlbmQoIHt9LCB1ZGF0YU9sZCApOwoKCQlkYXRhX3VzZXIuc2V0KCBkZXN0LCB1ZGF0YUN1ciApOwoJfQp9CgpmdW5jdGlvbiBnZXRBbGwoIGNvbnRleHQsIHRhZyApIHsKCXZhciByZXQgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggdGFnIHx8ICIqIiApIDoKCQkJY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsID8gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCB0YWcgfHwgIioiICkgOgoJCQlbXTsKCglyZXR1cm4gdGFnID09PSB1bmRlZmluZWQgfHwgdGFnICYmIGpRdWVyeS5ub2RlTmFtZSggY29udGV4dCwgdGFnICkgPwoJCWpRdWVyeS5tZXJnZSggWyBjb250ZXh0IF0sIHJldCApIDoKCQlyZXQ7Cn0KCi8vIFN1cHBvcnQ6IElFID49IDkKZnVuY3Rpb24gZml4SW5wdXQoIHNyYywgZGVzdCApIHsKCXZhciBub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCgkvLyBGYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94IG9yIHJhZGlvIGJ1dHRvbi4KCWlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgcmNoZWNrYWJsZVR5cGUudGVzdCggc3JjLnR5cGUgKSApIHsKCQlkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsKCgkvLyBGYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZCBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgKSB7CgkJZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwoJfQp9CgpqUXVlcnkuZXh0ZW5kKHsKCWNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJdmFyIGksIGwsIHNyY0VsZW1lbnRzLCBkZXN0RWxlbWVudHMsCgkJCWNsb25lID0gZWxlbS5jbG9uZU5vZGUoIHRydWUgKSwKCQkJaW5QYWdlID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCgkJLy8gU3VwcG9ydDogSUUgPj0gOQoJCS8vIEZpeCBDbG9uaW5nIGlzc3VlcwoJCWlmICggIXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgJiYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGVsZW0ubm9kZVR5cGUgPT09IDExICkgJiYKCQkJCSFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCgkJCS8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cDovL2pzcGVyZi5jb20vZ2V0YWxsLXZzLXNpenpsZS8yCgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCQkJc3JjRWxlbWVudHMgPSBnZXRBbGwoIGVsZW0gKTsKCgkJCWZvciAoIGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJZml4SW5wdXQoIHNyY0VsZW1lbnRzWyBpIF0sIGRlc3RFbGVtZW50c1sgaSBdICk7CgkJCX0KCQl9CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGRhdGFBbmRFdmVudHMgKSB7CgkJCWlmICggZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJCQlzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbCggZWxlbSApOwoJCQkJZGVzdEVsZW1lbnRzID0gZGVzdEVsZW1lbnRzIHx8IGdldEFsbCggY2xvbmUgKTsKCgkJCQlmb3IgKCBpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQljbG9uZUNvcHlFdmVudCggc3JjRWxlbWVudHNbIGkgXSwgZGVzdEVsZW1lbnRzWyBpIF0gKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwoJCQl9CgkJfQoKCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSwgInNjcmlwdCIgKTsKCQlpZiAoIGRlc3RFbGVtZW50cy5sZW5ndGggPiAwICkgewoJCQlzZXRHbG9iYWxFdmFsKCBkZXN0RWxlbWVudHMsICFpblBhZ2UgJiYgZ2V0QWxsKCBlbGVtLCAic2NyaXB0IiApICk7CgkJfQoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uKCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uICkgewoJCXZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgY29udGFpbnMsIGosCgkJCWZyYWdtZW50ID0gY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJCW5vZGVzID0gW10sCgkJCWkgPSAwLAoJCQlsID0gZWxlbXMubGVuZ3RoOwoKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWVsZW0gPSBlbGVtc1sgaSBdOwoKCQkJaWYgKCBlbGVtIHx8IGVsZW0gPT09IDAgKSB7CgoJCQkJLy8gQWRkIG5vZGVzIGRpcmVjdGx5CgkJCQlpZiAoIGpRdWVyeS50eXBlKCBlbGVtICkgPT09ICJvYmplY3QiICkgewoJCQkJCS8vIFN1cHBvcnQ6IFF0V2ViS2l0CgkJCQkJLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwoJCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbIGVsZW0gXSA6IGVsZW0gKTsKCgkJCQkvLyBDb252ZXJ0IG5vbi1odG1sIGludG8gYSB0ZXh0IG5vZGUKCQkJCX0gZWxzZSBpZiAoICFyaHRtbC50ZXN0KCBlbGVtICkgKSB7CgkJCQkJbm9kZXMucHVzaCggY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggZWxlbSApICk7CgoJCQkJLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCgkJCQl9IGVsc2UgewoJCQkJCXRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZCggY29udGV4dC5jcmVhdGVFbGVtZW50KCJkaXYiKSApOwoKCQkJCQkvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCgkJCQkJdGFnID0gKCBydGFnTmFtZS5leGVjKCBlbGVtICkgfHwgWyAiIiwgIiIgXSApWyAxIF0udG9Mb3dlckNhc2UoKTsKCQkJCQl3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCQkJCQl0bXAuaW5uZXJIVE1MID0gd3JhcFsgMSBdICsgZWxlbS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICkgKyB3cmFwWyAyIF07CgoJCQkJCS8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAoJCQkJCWogPSB3cmFwWyAwIF07CgkJCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQkJCXRtcCA9IHRtcC5sYXN0Q2hpbGQ7CgkJCQkJfQoKCQkJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkJCS8vIGpRdWVyeS5tZXJnZSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKCQkJCQlqUXVlcnkubWVyZ2UoIG5vZGVzLCB0bXAuY2hpbGROb2RlcyApOwoKCQkJCQkvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcgoJCQkJCXRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CgoJCQkJCS8vIEZpeGVzICMxMjM0NgoJCQkJCS8vIFN1cHBvcnQ6IFdlYmtpdCwgSUUKCQkJCQl0bXAudGV4dENvbnRlbnQgPSAiIjsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gUmVtb3ZlIHdyYXBwZXIgZnJvbSBmcmFnbWVudAoJCWZyYWdtZW50LnRleHRDb250ZW50ID0gIiI7CgoJCWkgPSAwOwoJCXdoaWxlICggKGVsZW0gPSBub2Rlc1sgaSsrIF0pICkgewoKCQkJLy8gIzQwODcgLSBJZiBvcmlnaW4gYW5kIGRlc3RpbmF0aW9uIGVsZW1lbnRzIGFyZSB0aGUgc2FtZSwgYW5kIHRoaXMgaXMKCQkJLy8gdGhhdCBlbGVtZW50LCBkbyBub3QgZG8gYW55dGhpbmcKCQkJaWYgKCBzZWxlY3Rpb24gJiYgalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHNlbGVjdGlvbiApICE9PSAtMSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQljb250YWlucyA9IGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7CgoJCQkvLyBBcHBlbmQgdG8gZnJhZ21lbnQKCQkJdG1wID0gZ2V0QWxsKCBmcmFnbWVudC5hcHBlbmRDaGlsZCggZWxlbSApLCAic2NyaXB0IiApOwoKCQkJLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQoJCQlpZiAoIGNvbnRhaW5zICkgewoJCQkJc2V0R2xvYmFsRXZhbCggdG1wICk7CgkJCX0KCgkJCS8vIENhcHR1cmUgZXhlY3V0YWJsZXMKCQkJaWYgKCBzY3JpcHRzICkgewoJCQkJaiA9IDA7CgkJCQl3aGlsZSAoIChlbGVtID0gdG1wWyBqKysgXSkgKSB7CgkJCQkJaWYgKCByc2NyaXB0VHlwZS50ZXN0KCBlbGVtLnR5cGUgfHwgIiIgKSApIHsKCQkJCQkJc2NyaXB0cy5wdXNoKCBlbGVtICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gZnJhZ21lbnQ7Cgl9LAoKCWNsZWFuRGF0YTogZnVuY3Rpb24oIGVsZW1zICkgewoJCXZhciBkYXRhLCBlbGVtLCB0eXBlLCBrZXksCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbCwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1sgaSBdKSAhPT0gdW5kZWZpbmVkOyBpKysgKSB7CgkJCWlmICggalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCQkJCWtleSA9IGVsZW1bIGRhdGFfcHJpdi5leHBhbmRvIF07CgoJCQkJaWYgKCBrZXkgJiYgKGRhdGEgPSBkYXRhX3ByaXYuY2FjaGVbIGtleSBdKSApIHsKCQkJCQlpZiAoIGRhdGEuZXZlbnRzICkgewoJCQkJCQlmb3IgKCB0eXBlIGluIGRhdGEuZXZlbnRzICkgewoJCQkJCQkJaWYgKCBzcGVjaWFsWyB0eXBlIF0gKSB7CgkJCQkJCQkJalF1ZXJ5LmV2ZW50LnJlbW92ZSggZWxlbSwgdHlwZSApOwoKCQkJCQkJCS8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmICggZGF0YV9wcml2LmNhY2hlWyBrZXkgXSApIHsKCQkJCQkJLy8gRGlzY2FyZCBhbnkgcmVtYWluaW5nIGBwcml2YXRlYCBkYXRhCgkJCQkJCWRlbGV0ZSBkYXRhX3ByaXYuY2FjaGVbIGtleSBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQkvLyBEaXNjYXJkIGFueSByZW1haW5pbmcgYHVzZXJgIGRhdGEKCQkJZGVsZXRlIGRhdGFfdXNlci5jYWNoZVsgZWxlbVsgZGF0YV91c2VyLmV4cGFuZG8gXSBdOwoJCX0KCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXRleHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KCQkJCWpRdWVyeS50ZXh0KCB0aGlzICkgOgoJCQkJdGhpcy5lbXB0eSgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJCXRoaXMudGV4dENvbnRlbnQgPSB2YWx1ZTsKCQkJCQl9CgkJCQl9KTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsKCQkJCXRhcmdldC5hcHBlbmRDaGlsZCggZWxlbSApOwoJCQl9CgkJfSk7Cgl9LAoKCXByZXBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsKCQkJCXRhcmdldC5pbnNlcnRCZWZvcmUoIGVsZW0sIHRhcmdldC5maXJzdENoaWxkICk7CgkJCX0KCQl9KTsKCX0sCgoJYmVmb3JlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzICk7CgkJCX0KCQl9KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRvbU1hbmlwKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMubmV4dFNpYmxpbmcgKTsKCQkJfQoJCX0pOwoJfSwKCglyZW1vdmU6IGZ1bmN0aW9uKCBzZWxlY3Rvciwga2VlcERhdGEgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7CgkJdmFyIGVsZW0sCgkJCWVsZW1zID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgdGhpcyApIDogdGhpcywKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoICFrZWVwRGF0YSAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtICkgKTsKCQkJfQoKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQlpZiAoIGtlZXBEYXRhICYmIGpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgKSB7CgkJCQkJc2V0R2xvYmFsRXZhbCggZ2V0QWxsKCBlbGVtLCAic2NyaXB0IiApICk7CgkJCQl9CgkJCQllbGVtLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKGVsZW0gPSB0aGlzW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJCQkvLyBQcmV2ZW50IG1lbW9yeSBsZWFrcwoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgoJCQkJLy8gUmVtb3ZlIGFueSByZW1haW5pbmcgbm9kZXMKCQkJCWVsZW0udGV4dENvbnRlbnQgPSAiIjsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbiggZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJZGF0YUFuZEV2ZW50cyA9IGRhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGZhbHNlIDogZGF0YUFuZEV2ZW50czsKCQlkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CgoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGpRdWVyeS5jbG9uZSggdGhpcywgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKTsKCQl9KTsKCX0sCgoJaHRtbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGVsZW0gPSB0aGlzWyAwIF0gfHwge30sCgkJCQlpID0gMCwKCQkJCWwgPSB0aGlzLmxlbmd0aDsKCgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJcmV0dXJuIGVsZW0uaW5uZXJIVE1MOwoJCQl9CgoJCQkvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhcm5vSW5uZXJodG1sLnRlc3QoIHZhbHVlICkgJiYKCQkJCSF3cmFwTWFwWyAoIHJ0YWdOYW1lLmV4ZWMoIHZhbHVlICkgfHwgWyAiIiwgIiIgXSApWyAxIF0udG9Mb3dlckNhc2UoKSBdICkgewoKCQkJCXZhbHVlID0gdmFsdWUucmVwbGFjZSggcnhodG1sVGFnLCAiPCQxPjwvJDI+IiApOwoKCQkJCXRyeSB7CgkJCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJCQllbGVtID0gdGhpc1sgaSBdIHx8IHt9OwoKCQkJCQkJLy8gUmVtb3ZlIGVsZW1lbnQgbm9kZXMgYW5kIHByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSwgZmFsc2UgKSApOwoJCQkJCQkJZWxlbS5pbm5lckhUTUwgPSB2YWx1ZTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJZWxlbSA9IDA7CgoJCQkJLy8gSWYgdXNpbmcgaW5uZXJIVE1MIHRocm93cyBhbiBleGNlcHRpb24sIHVzZSB0aGUgZmFsbGJhY2sgbWV0aG9kCgkJCQl9IGNhdGNoKCBlICkge30KCQkJfQoKCQkJaWYgKCBlbGVtICkgewoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQkJfQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7Cgl9LAoKCXJlcGxhY2VXaXRoOiBmdW5jdGlvbigpIHsKCQl2YXIgYXJnID0gYXJndW1lbnRzWyAwIF07CgoJCS8vIE1ha2UgdGhlIGNoYW5nZXMsIHJlcGxhY2luZyBlYWNoIGNvbnRleHQgZWxlbWVudCB3aXRoIHRoZSBuZXcgY29udGVudAoJCXRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWFyZyA9IHRoaXMucGFyZW50Tm9kZTsKCgkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggdGhpcyApICk7CgoJCQlpZiAoIGFyZyApIHsKCQkJCWFyZy5yZXBsYWNlQ2hpbGQoIGVsZW0sIHRoaXMgKTsKCQkJfQoJCX0pOwoKCQkvLyBGb3JjZSByZW1vdmFsIGlmIHRoZXJlIHdhcyBubyBuZXcgY29udGVudCAoZS5nLiwgZnJvbSBlbXB0eSBhcmd1bWVudHMpCgkJcmV0dXJuIGFyZyAmJiAoYXJnLmxlbmd0aCB8fCBhcmcubm9kZVR5cGUpID8gdGhpcyA6IHRoaXMucmVtb3ZlKCk7Cgl9LAoKCWRldGFjaDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnJlbW92ZSggc2VsZWN0b3IsIHRydWUgKTsKCX0sCgoJZG9tTWFuaXA6IGZ1bmN0aW9uKCBhcmdzLCBjYWxsYmFjayApIHsKCgkJLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwoJCWFyZ3MgPSBjb25jYXQuYXBwbHkoIFtdLCBhcmdzICk7CgoJCXZhciBmcmFnbWVudCwgZmlyc3QsIHNjcmlwdHMsIGhhc1NjcmlwdHMsIG5vZGUsIGRvYywKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aCwKCQkJc2V0ID0gdGhpcywKCQkJaU5vQ2xvbmUgPSBsIC0gMSwKCQkJdmFsdWUgPSBhcmdzWyAwIF0sCgkJCWlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKTsKCgkJLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CgkJaWYgKCBpc0Z1bmN0aW9uIHx8CgkJCQkoIGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYKCQkJCQkhc3VwcG9ydC5jaGVja0Nsb25lICYmIHJjaGVja2VkLnRlc3QoIHZhbHVlICkgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaW5kZXggKSB7CgkJCQl2YXIgc2VsZiA9IHNldC5lcSggaW5kZXggKTsKCQkJCWlmICggaXNGdW5jdGlvbiApIHsKCQkJCQlhcmdzWyAwIF0gPSB2YWx1ZS5jYWxsKCB0aGlzLCBpbmRleCwgc2VsZi5odG1sKCkgKTsKCQkJCX0KCQkJCXNlbGYuZG9tTWFuaXAoIGFyZ3MsIGNhbGxiYWNrICk7CgkJCX0pOwoJCX0KCgkJaWYgKCBsICkgewoJCQlmcmFnbWVudCA9IGpRdWVyeS5idWlsZEZyYWdtZW50KCBhcmdzLCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCwgZmFsc2UsIHRoaXMgKTsKCQkJZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwoKCQkJaWYgKCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSApIHsKCQkJCWZyYWdtZW50ID0gZmlyc3Q7CgkJCX0KCgkJCWlmICggZmlyc3QgKSB7CgkJCQlzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOwoJCQkJaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwoKCQkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCgkJCQkvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgoJCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJCW5vZGUgPSBmcmFnbWVudDsKCgkJCQkJaWYgKCBpICE9PSBpTm9DbG9uZSApIHsKCQkJCQkJbm9kZSA9IGpRdWVyeS5jbG9uZSggbm9kZSwgdHJ1ZSwgdHJ1ZSApOwoKCQkJCQkJLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgoJCQkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQkJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkJCQkJLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwoJCQkJCQkJalF1ZXJ5Lm1lcmdlKCBzY3JpcHRzLCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJY2FsbGJhY2suY2FsbCggdGhpc1sgaSBdLCBub2RlLCBpICk7CgkJCQl9CgoJCQkJaWYgKCBoYXNTY3JpcHRzICkgewoJCQkJCWRvYyA9IHNjcmlwdHNbIHNjcmlwdHMubGVuZ3RoIC0gMSBdLm93bmVyRG9jdW1lbnQ7CgoJCQkJCS8vIFJlZW5hYmxlIHNjcmlwdHMKCQkJCQlqUXVlcnkubWFwKCBzY3JpcHRzLCByZXN0b3JlU2NyaXB0ICk7CgoJCQkJCS8vIEV2YWx1YXRlIGV4ZWN1dGFibGUgc2NyaXB0cyBvbiBmaXJzdCBkb2N1bWVudCBpbnNlcnRpb24KCQkJCQlmb3IgKCBpID0gMDsgaSA8IGhhc1NjcmlwdHM7IGkrKyApIHsKCQkJCQkJbm9kZSA9IHNjcmlwdHNbIGkgXTsKCQkJCQkJaWYgKCByc2NyaXB0VHlwZS50ZXN0KCBub2RlLnR5cGUgfHwgIiIgKSAmJgoJCQkJCQkJIWRhdGFfcHJpdi5hY2Nlc3MoIG5vZGUsICJnbG9iYWxFdmFsIiApICYmIGpRdWVyeS5jb250YWlucyggZG9jLCBub2RlICkgKSB7CgoJCQkJCQkJaWYgKCBub2RlLnNyYyApIHsKCQkJCQkJCQkvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAoJCQkJCQkJCWlmICggalF1ZXJ5Ll9ldmFsVXJsICkgewoJCQkJCQkJCQlqUXVlcnkuX2V2YWxVcmwoIG5vZGUuc3JjICk7CgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkuZ2xvYmFsRXZhbCggbm9kZS50ZXh0Q29udGVudC5yZXBsYWNlKCByY2xlYW5TY3JpcHQsICIiICkgKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKalF1ZXJ5LmVhY2goewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBlbGVtcywKCQkJcmV0ID0gW10sCgkJCWluc2VydCA9IGpRdWVyeSggc2VsZWN0b3IgKSwKCQkJbGFzdCA9IGluc2VydC5sZW5ndGggLSAxLAoJCQlpID0gMDsKCgkJZm9yICggOyBpIDw9IGxhc3Q7IGkrKyApIHsKCQkJZWxlbXMgPSBpID09PSBsYXN0ID8gdGhpcyA6IHRoaXMuY2xvbmUoIHRydWUgKTsKCQkJalF1ZXJ5KCBpbnNlcnRbIGkgXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoKCQkJLy8gU3VwcG9ydDogUXRXZWJLaXQKCQkJLy8gLmdldCgpIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwoJCQlwdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCApOwoJfTsKfSk7CgoKdmFyIGlmcmFtZSwKCWVsZW1kaXNwbGF5ID0ge307CgovKioKICogUmV0cmlldmUgdGhlIGFjdHVhbCBkaXNwbGF5IG9mIGEgZWxlbWVudAogKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBub2RlTmFtZSBvZiB0aGUgZWxlbWVudAogKiBAcGFyYW0ge09iamVjdH0gZG9jIERvY3VtZW50IG9iamVjdAogKi8KLy8gQ2FsbGVkIG9ubHkgZnJvbSB3aXRoaW4gZGVmYXVsdERpc3BsYXkKZnVuY3Rpb24gYWN0dWFsRGlzcGxheSggbmFtZSwgZG9jICkgewoJdmFyIHN0eWxlLAoJCWVsZW0gPSBqUXVlcnkoIGRvYy5jcmVhdGVFbGVtZW50KCBuYW1lICkgKS5hcHBlbmRUbyggZG9jLmJvZHkgKSwKCgkJLy8gZ2V0RGVmYXVsdENvbXB1dGVkU3R5bGUgbWlnaHQgYmUgcmVsaWFibHkgdXNlZCBvbmx5IG9uIGF0dGFjaGVkIGVsZW1lbnQKCQlkaXNwbGF5ID0gd2luZG93LmdldERlZmF1bHRDb21wdXRlZFN0eWxlICYmICggc3R5bGUgPSB3aW5kb3cuZ2V0RGVmYXVsdENvbXB1dGVkU3R5bGUoIGVsZW1bIDAgXSApICkgPwoKCQkJLy8gVXNlIG9mIHRoaXMgbWV0aG9kIGlzIGEgdGVtcG9yYXJ5IGZpeCAobW9yZSBsaWtlIG9wdG1pemF0aW9uKSB1bnRpbCBzb21ldGhpbmcgYmV0dGVyIGNvbWVzIGFsb25nLAoJCQkvLyBzaW5jZSBpdCB3YXMgcmVtb3ZlZCBmcm9tIHNwZWNpZmljYXRpb24gYW5kIHN1cHBvcnRlZCBvbmx5IGluIEZGCgkJCXN0eWxlLmRpc3BsYXkgOiBqUXVlcnkuY3NzKCBlbGVtWyAwIF0sICJkaXNwbGF5IiApOwoKCS8vIFdlIGRvbid0IGhhdmUgYW55IGRhdGEgc3RvcmVkIG9uIHRoZSBlbGVtZW50LAoJLy8gc28gdXNlICJkZXRhY2giIG1ldGhvZCBhcyBmYXN0IHdheSB0byBnZXQgcmlkIG9mIHRoZSBlbGVtZW50CgllbGVtLmRldGFjaCgpOwoKCXJldHVybiBkaXNwbGF5Owp9CgovKioKICogVHJ5IHRvIGRldGVybWluZSB0aGUgZGVmYXVsdCBkaXNwbGF5IHZhbHVlIG9mIGFuIGVsZW1lbnQKICogQHBhcmFtIHtTdHJpbmd9IG5vZGVOYW1lCiAqLwpmdW5jdGlvbiBkZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7Cgl2YXIgZG9jID0gZG9jdW1lbnQsCgkJZGlzcGxheSA9IGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdOwoKCWlmICggIWRpc3BsYXkgKSB7CgkJZGlzcGxheSA9IGFjdHVhbERpc3BsYXkoIG5vZGVOYW1lLCBkb2MgKTsKCgkJLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCgkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgfHwgIWRpc3BsYXkgKSB7CgoJCQkvLyBVc2UgdGhlIGFscmVhZHktY3JlYXRlZCBpZnJhbWUgaWYgcG9zc2libGUKCQkJaWZyYW1lID0gKGlmcmFtZSB8fCBqUXVlcnkoICI8aWZyYW1lIGZyYW1lYm9yZGVyPScwJyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+IiApKS5hcHBlbmRUbyggZG9jLmRvY3VtZW50RWxlbWVudCApOwoKCQkJLy8gQWx3YXlzIHdyaXRlIGEgbmV3IEhUTUwgc2tlbGV0b24gc28gV2Via2l0IGFuZCBGaXJlZm94IGRvbid0IGNob2tlIG9uIHJldXNlCgkJCWRvYyA9IGlmcmFtZVsgMCBdLmNvbnRlbnREb2N1bWVudDsKCgkJCS8vIFN1cHBvcnQ6IElFCgkJCWRvYy53cml0ZSgpOwoJCQlkb2MuY2xvc2UoKTsKCgkJCWRpc3BsYXkgPSBhY3R1YWxEaXNwbGF5KCBub2RlTmFtZSwgZG9jICk7CgkJCWlmcmFtZS5kZXRhY2goKTsKCQl9CgoJCS8vIFN0b3JlIHRoZSBjb3JyZWN0IGRlZmF1bHQgZGlzcGxheQoJCWVsZW1kaXNwbGF5WyBub2RlTmFtZSBdID0gZGlzcGxheTsKCX0KCglyZXR1cm4gZGlzcGxheTsKfQp2YXIgcm1hcmdpbiA9ICgvXm1hcmdpbi8pOwoKdmFyIHJudW1ub25weCA9IG5ldyBSZWdFeHAoICJeKCIgKyBwbnVtICsgIikoPyFweClbYS16JV0rJCIsICJpIiApOwoKdmFyIGdldFN0eWxlcyA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbSwgbnVsbCApOwoJfTsKCgoKZnVuY3Rpb24gY3VyQ1NTKCBlbGVtLCBuYW1lLCBjb21wdXRlZCApIHsKCXZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLCByZXQsCgkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCWNvbXB1dGVkID0gY29tcHV0ZWQgfHwgZ2V0U3R5bGVzKCBlbGVtICk7CgoJLy8gU3VwcG9ydDogSUU5CgkvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG9ubHkgbmVlZGVkIGZvciAuY3NzKCdmaWx0ZXInKSBpbiBJRTksIHNlZSAjMTI1MzcKCWlmICggY29tcHV0ZWQgKSB7CgkJcmV0ID0gY29tcHV0ZWQuZ2V0UHJvcGVydHlWYWx1ZSggbmFtZSApIHx8IGNvbXB1dGVkWyBuYW1lIF07Cgl9CgoJaWYgKCBjb21wdXRlZCApIHsKCgkJaWYgKCByZXQgPT09ICIiICYmICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApICkgewoJCQlyZXQgPSBqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUgKTsKCQl9CgoJCS8vIFN1cHBvcnQ6IGlPUyA8IDYKCQkvLyBBIHRyaWJ1dGUgdG8gdGhlICJhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzIgoJCS8vIGlPUyA8IDYgKGF0IGxlYXN0KSByZXR1cm5zIHBlcmNlbnRhZ2UgZm9yIGEgbGFyZ2VyIHNldCBvZiB2YWx1ZXMsIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMKCQkvLyB0aGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6IGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKCQlpZiAoIHJudW1ub25weC50ZXN0KCByZXQgKSAmJiBybWFyZ2luLnRlc3QoIG5hbWUgKSApIHsKCgkJCS8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKCQkJd2lkdGggPSBzdHlsZS53aWR0aDsKCQkJbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKCQkJbWF4V2lkdGggPSBzdHlsZS5tYXhXaWR0aDsKCgkJCS8vIFB1dCBpbiB0aGUgbmV3IHZhbHVlcyB0byBnZXQgYSBjb21wdXRlZCB2YWx1ZSBvdXQKCQkJc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwoJCQlyZXQgPSBjb21wdXRlZC53aWR0aDsKCgkJCS8vIFJldmVydCB0aGUgY2hhbmdlZCB2YWx1ZXMKCQkJc3R5bGUud2lkdGggPSB3aWR0aDsKCQkJc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsKCQkJc3R5bGUubWF4V2lkdGggPSBtYXhXaWR0aDsKCQl9Cgl9CgoJcmV0dXJuIHJldCAhPT0gdW5kZWZpbmVkID8KCQkvLyBTdXBwb3J0OiBJRQoJCS8vIElFIHJldHVybnMgekluZGV4IHZhbHVlIGFzIGFuIGludGVnZXIuCgkJcmV0ICsgIiIgOgoJCXJldDsKfQoKCmZ1bmN0aW9uIGFkZEdldEhvb2tJZiggY29uZGl0aW9uRm4sIGhvb2tGbiApIHsKCS8vIERlZmluZSB0aGUgaG9vaywgd2UnbGwgY2hlY2sgb24gdGhlIGZpcnN0IHJ1biBpZiBpdCdzIHJlYWxseSBuZWVkZWQuCglyZXR1cm4gewoJCWdldDogZnVuY3Rpb24oKSB7CgkJCWlmICggY29uZGl0aW9uRm4oKSApIHsKCQkJCS8vIEhvb2sgbm90IG5lZWRlZCAob3IgaXQncyBub3QgcG9zc2libGUgdG8gdXNlIGl0IGR1ZSB0byBtaXNzaW5nIGRlcGVuZGVuY3kpLAoJCQkJLy8gcmVtb3ZlIGl0LgoJCQkJLy8gU2luY2UgdGhlcmUgYXJlIG5vIG90aGVyIGhvb2tzIGZvciBtYXJnaW5SaWdodCwgcmVtb3ZlIHRoZSB3aG9sZSBvYmplY3QuCgkJCQlkZWxldGUgdGhpcy5nZXQ7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIEhvb2sgbmVlZGVkOyByZWRlZmluZSBpdCBzbyB0aGF0IHRoZSBzdXBwb3J0IHRlc3QgaXMgbm90IGV4ZWN1dGVkIGFnYWluLgoKCQkJcmV0dXJuICh0aGlzLmdldCA9IGhvb2tGbikuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX0KCX07Cn0KCgooZnVuY3Rpb24oKSB7Cgl2YXIgcGl4ZWxQb3NpdGlvblZhbCwgYm94U2l6aW5nUmVsaWFibGVWYWwsCgkJZG9jRWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQljb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgoJaWYgKCAhZGl2LnN0eWxlICkgewoJCXJldHVybjsKCX0KCglkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiY29udGVudC1ib3giOwoJZGl2LmNsb25lTm9kZSggdHJ1ZSApLnN0eWxlLmJhY2tncm91bmRDbGlwID0gIiI7CglzdXBwb3J0LmNsZWFyQ2xvbmVTdHlsZSA9IGRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9PT0gImNvbnRlbnQtYm94IjsKCgljb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICJib3JkZXI6MDt3aWR0aDowO2hlaWdodDowO3RvcDowO2xlZnQ6LTk5OTlweDttYXJnaW4tdG9wOjFweDsiICsKCQkicG9zaXRpb246YWJzb2x1dGUiOwoJY29udGFpbmVyLmFwcGVuZENoaWxkKCBkaXYgKTsKCgkvLyBFeGVjdXRpbmcgYm90aCBwaXhlbFBvc2l0aW9uICYgYm94U2l6aW5nUmVsaWFibGUgdGVzdHMgcmVxdWlyZSBvbmx5IG9uZSBsYXlvdXQKCS8vIHNvIHRoZXkncmUgZXhlY3V0ZWQgYXQgdGhlIHNhbWUgdGltZSB0byBzYXZlIHRoZSBzZWNvbmQgY29tcHV0YXRpb24uCglmdW5jdGlvbiBjb21wdXRlUGl4ZWxQb3NpdGlvbkFuZEJveFNpemluZ1JlbGlhYmxlKCkgewoJCWRpdi5zdHlsZS5jc3NUZXh0ID0KCQkJLy8gU3VwcG9ydDogRmlyZWZveDwyOSwgQW5kcm9pZCAyLjMKCQkJLy8gVmVuZG9yLXByZWZpeCBib3gtc2l6aW5nCgkJCSItd2Via2l0LWJveC1zaXppbmc6Ym9yZGVyLWJveDstbW96LWJveC1zaXppbmc6Ym9yZGVyLWJveDsiICsKCQkJImJveC1zaXppbmc6Ym9yZGVyLWJveDtkaXNwbGF5OmJsb2NrO21hcmdpbi10b3A6MSU7dG9wOjElOyIgKwoJCQkiYm9yZGVyOjFweDtwYWRkaW5nOjFweDt3aWR0aDo0cHg7cG9zaXRpb246YWJzb2x1dGUiOwoJCWRpdi5pbm5lckhUTUwgPSAiIjsKCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBjb250YWluZXIgKTsKCgkJdmFyIGRpdlN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGRpdiwgbnVsbCApOwoJCXBpeGVsUG9zaXRpb25WYWwgPSBkaXZTdHlsZS50b3AgIT09ICIxJSI7CgkJYm94U2l6aW5nUmVsaWFibGVWYWwgPSBkaXZTdHlsZS53aWR0aCA9PT0gIjRweCI7CgoJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoJfQoKCS8vIFN1cHBvcnQ6IG5vZGUuanMganNkb20KCS8vIERvbid0IGFzc3VtZSB0aGF0IGdldENvbXB1dGVkU3R5bGUgaXMgYSBwcm9wZXJ0eSBvZiB0aGUgZ2xvYmFsIG9iamVjdAoJaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCQlqUXVlcnkuZXh0ZW5kKCBzdXBwb3J0LCB7CgkJCXBpeGVsUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkJLy8gVGhpcyB0ZXN0IGlzIGV4ZWN1dGVkIG9ubHkgb25jZSBidXQgd2Ugc3RpbGwgZG8gbWVtb2l6aW5nCgkJCQkvLyBzaW5jZSB3ZSBjYW4gdXNlIHRoZSBib3hTaXppbmdSZWxpYWJsZSBwcmUtY29tcHV0aW5nLgoJCQkJLy8gTm8gbmVlZCB0byBjaGVjayBpZiB0aGUgdGVzdCB3YXMgYWxyZWFkeSBwZXJmb3JtZWQsIHRob3VnaC4KCQkJCWNvbXB1dGVQaXhlbFBvc2l0aW9uQW5kQm94U2l6aW5nUmVsaWFibGUoKTsKCQkJCXJldHVybiBwaXhlbFBvc2l0aW9uVmFsOwoJCQl9LAoJCQlib3hTaXppbmdSZWxpYWJsZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGJveFNpemluZ1JlbGlhYmxlVmFsID09IG51bGwgKSB7CgkJCQkJY29tcHV0ZVBpeGVsUG9zaXRpb25BbmRCb3hTaXppbmdSZWxpYWJsZSgpOwoJCQkJfQoJCQkJcmV0dXJuIGJveFNpemluZ1JlbGlhYmxlVmFsOwoJCQl9LAoJCQlyZWxpYWJsZU1hcmdpblJpZ2h0OiBmdW5jdGlvbigpIHsKCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zCgkJCQkvLyBDaGVjayBpZiBkaXYgd2l0aCBleHBsaWNpdCB3aWR0aCBhbmQgbm8gbWFyZ2luLXJpZ2h0IGluY29ycmVjdGx5CgkJCQkvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKCQkJCS8vIFdlYktpdCBCdWcgMTMzNDMgLSBnZXRDb21wdXRlZFN0eWxlIHJldHVybnMgd3JvbmcgdmFsdWUgZm9yIG1hcmdpbi1yaWdodAoJCQkJLy8gVGhpcyBzdXBwb3J0IGZ1bmN0aW9uIGlzIG9ubHkgZXhlY3V0ZWQgb25jZSBzbyBubyBtZW1vaXppbmcgaXMgbmVlZGVkLgoJCQkJdmFyIHJldCwKCQkJCQltYXJnaW5EaXYgPSBkaXYuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgKTsKCgkJCQkvLyBSZXNldCBDU1M6IGJveC1zaXppbmc7IGRpc3BsYXk7IG1hcmdpbjsgYm9yZGVyOyBwYWRkaW5nCgkJCQltYXJnaW5EaXYuc3R5bGUuY3NzVGV4dCA9IGRpdi5zdHlsZS5jc3NUZXh0ID0KCQkJCQkvLyBTdXBwb3J0OiBGaXJlZm94PDI5LCBBbmRyb2lkIDIuMwoJCQkJCS8vIFZlbmRvci1wcmVmaXggYm94LXNpemluZwoJCQkJCSItd2Via2l0LWJveC1zaXppbmc6Y29udGVudC1ib3g7LW1vei1ib3gtc2l6aW5nOmNvbnRlbnQtYm94OyIgKwoJCQkJCSJib3gtc2l6aW5nOmNvbnRlbnQtYm94O2Rpc3BsYXk6YmxvY2s7bWFyZ2luOjA7Ym9yZGVyOjA7cGFkZGluZzowIjsKCQkJCW1hcmdpbkRpdi5zdHlsZS5tYXJnaW5SaWdodCA9IG1hcmdpbkRpdi5zdHlsZS53aWR0aCA9ICIwIjsKCQkJCWRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoJCQkJZG9jRWxlbS5hcHBlbmRDaGlsZCggY29udGFpbmVyICk7CgoJCQkJcmV0ID0gIXBhcnNlRmxvYXQoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBtYXJnaW5EaXYsIG51bGwgKS5tYXJnaW5SaWdodCApOwoKCQkJCWRvY0VsZW0ucmVtb3ZlQ2hpbGQoIGNvbnRhaW5lciApOwoKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9KTsKCX0KfSkoKTsKCgovLyBBIG1ldGhvZCBmb3IgcXVpY2tseSBzd2FwcGluZyBpbi9vdXQgQ1NTIHByb3BlcnRpZXMgdG8gZ2V0IGNvcnJlY3QgY2FsY3VsYXRpb25zLgpqUXVlcnkuc3dhcCA9IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBjYWxsYmFjaywgYXJncyApIHsKCXZhciByZXQsIG5hbWUsCgkJb2xkID0ge307CgoJLy8gUmVtZW1iZXIgdGhlIG9sZCB2YWx1ZXMsIGFuZCBpbnNlcnQgdGhlIG5ldyBvbmVzCglmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJb2xkWyBuYW1lIF0gPSBlbGVtLnN0eWxlWyBuYW1lIF07CgkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb3B0aW9uc1sgbmFtZSBdOwoJfQoKCXJldCA9IGNhbGxiYWNrLmFwcGx5KCBlbGVtLCBhcmdzIHx8IFtdICk7CgoJLy8gUmV2ZXJ0IHRoZSBvbGQgdmFsdWVzCglmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJZWxlbS5zdHlsZVsgbmFtZSBdID0gb2xkWyBuYW1lIF07Cgl9CgoJcmV0dXJuIHJldDsKfTsKCgp2YXIKCS8vIHN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUgZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCgkvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKCXJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywKCXJudW1zcGxpdCA9IG5ldyBSZWdFeHAoICJeKCIgKyBwbnVtICsgIikoLiopJCIsICJpIiApLAoJcnJlbE51bSA9IG5ldyBSZWdFeHAoICJeKFsrLV0pPSgiICsgcG51bSArICIpIiwgImkiICksCgoJY3NzU2hvdyA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sCgljc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CgkJbGV0dGVyU3BhY2luZzogIjAiLAoJCWZvbnRXZWlnaHQ6ICI0MDAiCgl9LAoKCWNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIiBdOwoKLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG5hbWUgKSB7CgoJLy8gc2hvcnRjdXQgZm9yIG5hbWVzIHRoYXQgYXJlIG5vdCB2ZW5kb3IgcHJlZml4ZWQKCWlmICggbmFtZSBpbiBzdHlsZSApIHsKCQlyZXR1cm4gbmFtZTsKCX0KCgkvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCgl2YXIgY2FwTmFtZSA9IG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSksCgkJb3JpZ05hbWUgPSBuYW1lLAoJCWkgPSBjc3NQcmVmaXhlcy5sZW5ndGg7CgoJd2hpbGUgKCBpLS0gKSB7CgkJbmFtZSA9IGNzc1ByZWZpeGVzWyBpIF0gKyBjYXBOYW1lOwoJCWlmICggbmFtZSBpbiBzdHlsZSApIHsKCQkJcmV0dXJuIG5hbWU7CgkJfQoJfQoKCXJldHVybiBvcmlnTmFtZTsKfQoKZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCApIHsKCXZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWMoIHZhbHVlICk7CglyZXR1cm4gbWF0Y2hlcyA/CgkJLy8gR3VhcmQgYWdhaW5zdCB1bmRlZmluZWQgInN1YnRyYWN0IiwgZS5nLiwgd2hlbiB1c2VkIGFzIGluIGNzc0hvb2tzCgkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOgoJCXZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMgKSB7Cgl2YXIgaSA9IGV4dHJhID09PSAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSA/CgkJLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCgkJNCA6CgkJLy8gT3RoZXJ3aXNlIGluaXRpYWxpemUgZm9yIGhvcml6b250YWwgb3IgdmVydGljYWwgcHJvcGVydGllcwoJCW5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwKCgkJdmFsID0gMDsKCglmb3IgKCA7IGkgPCA0OyBpICs9IDIgKSB7CgkJLy8gYm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luLCBzbyBhZGQgaXQgaWYgd2Ugd2FudCBpdAoJCWlmICggZXh0cmEgPT09ICJtYXJnaW4iICkgewoJCQl2YWwgKz0galF1ZXJ5LmNzcyggZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJfQoKCQlpZiAoIGlzQm9yZGVyQm94ICkgewoJCQkvLyBib3JkZXItYm94IGluY2x1ZGVzIHBhZGRpbmcsIHNvIHJlbW92ZSBpdCBpZiB3ZSB3YW50IGNvbnRlbnQKCQkJaWYgKCBleHRyYSA9PT0gImNvbnRlbnQiICkgewoJCQkJdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CgkJCQl2YWwgLT0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gInBhZGRpbmciICkgewoJCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gdmFsOwp9CgpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApIHsKCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQoJdmFyIHZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlLAoJCXZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCgkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICksCgkJaXNCb3JkZXJCb3ggPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcyApID09PSAiYm9yZGVyLWJveCI7CgoJLy8gc29tZSBub24taHRtbCBlbGVtZW50cyByZXR1cm4gdW5kZWZpbmVkIGZvciBvZmZzZXRXaWR0aCwgc28gY2hlY2sgZm9yIG51bGwvdW5kZWZpbmVkCgkvLyBzdmcgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02NDkyODUKCS8vIE1hdGhNTCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTQ5MTY2OAoJaWYgKCB2YWwgPD0gMCB8fCB2YWwgPT0gbnVsbCApIHsKCQkvLyBGYWxsIGJhY2sgdG8gY29tcHV0ZWQgdGhlbiB1bmNvbXB1dGVkIGNzcyBpZiBuZWNlc3NhcnkKCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUsIHN0eWxlcyApOwoJCWlmICggdmFsIDwgMCB8fCB2YWwgPT0gbnVsbCApIHsKCQkJdmFsID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCX0KCgkJLy8gQ29tcHV0ZWQgdW5pdCBpcyBub3QgcGl4ZWxzLiBTdG9wIGhlcmUgYW5kIHJldHVybi4KCQlpZiAoIHJudW1ub25weC50ZXN0KHZhbCkgKSB7CgkJCXJldHVybiB2YWw7CgkJfQoKCQkvLyB3ZSBuZWVkIHRoZSBjaGVjayBmb3Igc3R5bGUgaW4gY2FzZSBhIGJyb3dzZXIgd2hpY2ggcmV0dXJucyB1bnJlbGlhYmxlIHZhbHVlcwoJCS8vIGZvciBnZXRDb21wdXRlZFN0eWxlIHNpbGVudGx5IGZhbGxzIGJhY2sgdG8gdGhlIHJlbGlhYmxlIGVsZW0uc3R5bGUKCQl2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3ggJiYKCQkJKCBzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgfHwgdmFsID09PSBlbGVtLnN0eWxlWyBuYW1lIF0gKTsKCgkJLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKCQl2YWwgPSBwYXJzZUZsb2F0KCB2YWwgKSB8fCAwOwoJfQoKCS8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCglyZXR1cm4gKCB2YWwgKwoJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQllbGVtLAoJCQluYW1lLAoJCQlleHRyYSB8fCAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSwKCQkJdmFsdWVJc0JvcmRlckJveCwKCQkJc3R5bGVzCgkJKQoJKSArICJweCI7Cn0KCmZ1bmN0aW9uIHNob3dIaWRlKCBlbGVtZW50cywgc2hvdyApIHsKCXZhciBkaXNwbGF5LCBlbGVtLCBoaWRkZW4sCgkJdmFsdWVzID0gW10sCgkJaW5kZXggPSAwLAoJCWxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCglmb3IgKCA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCWVsZW0gPSBlbGVtZW50c1sgaW5kZXggXTsKCQlpZiAoICFlbGVtLnN0eWxlICkgewoJCQljb250aW51ZTsKCQl9CgoJCXZhbHVlc1sgaW5kZXggXSA9IGRhdGFfcHJpdi5nZXQoIGVsZW0sICJvbGRkaXNwbGF5IiApOwoJCWRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CgkJaWYgKCBzaG93ICkgewoJCQkvLyBSZXNldCB0aGUgaW5saW5lIGRpc3BsYXkgb2YgdGhpcyBlbGVtZW50IHRvIGxlYXJuIGlmIGl0IGlzCgkJCS8vIGJlaW5nIGhpZGRlbiBieSBjYXNjYWRlZCBydWxlcyBvciBub3QKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICYmIGRpc3BsYXkgPT09ICJub25lIiApIHsKCQkJCWVsZW0uc3R5bGUuZGlzcGxheSA9ICIiOwoJCQl9CgoJCQkvLyBTZXQgZWxlbWVudHMgd2hpY2ggaGF2ZSBiZWVuIG92ZXJyaWRkZW4gd2l0aCBkaXNwbGF5OiBub25lCgkJCS8vIGluIGEgc3R5bGVzaGVldCB0byB3aGF0ZXZlciB0aGUgZGVmYXVsdCBicm93c2VyIHN0eWxlIGlzCgkJCS8vIGZvciBzdWNoIGFuIGVsZW1lbnQKCQkJaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuKCBlbGVtICkgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBkYXRhX3ByaXYuYWNjZXNzKCBlbGVtLCAib2xkZGlzcGxheSIsIGRlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpICk7CgkJCX0KCQl9IGVsc2UgewoJCQloaWRkZW4gPSBpc0hpZGRlbiggZWxlbSApOwoKCQkJaWYgKCBkaXNwbGF5ICE9PSAibm9uZSIgfHwgIWhpZGRlbiApIHsKCQkJCWRhdGFfcHJpdi5zZXQoIGVsZW0sICJvbGRkaXNwbGF5IiwgaGlkZGVuID8gZGlzcGxheSA6IGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApICk7CgkJCX0KCQl9Cgl9CgoJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoICFzaG93IHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgKSB7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbIGluZGV4IF0gfHwgIiIgOiAibm9uZSI7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKCS8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQoJY3NzSG9va3M6IHsKCQlvcGFjaXR5OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sICJvcGFjaXR5IiApOwoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKCWNzc051bWJlcjogewoJCSJjb2x1bW5Db3VudCI6IHRydWUsCgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwKCQkiZmxleEdyb3ciOiB0cnVlLAoJCSJmbGV4U2hyaW5rIjogdHJ1ZSwKCQkiZm9udFdlaWdodCI6IHRydWUsCgkJImxpbmVIZWlnaHQiOiB0cnVlLAoJCSJvcGFjaXR5IjogdHJ1ZSwKCQkib3JkZXIiOiB0cnVlLAoJCSJvcnBoYW5zIjogdHJ1ZSwKCQkid2lkb3dzIjogdHJ1ZSwKCQkiekluZGV4IjogdHJ1ZSwKCQkiem9vbSI6IHRydWUKCX0sCgoJLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQoJLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQoJY3NzUHJvcHM6IHsKCQkvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CgkJImZsb2F0IjogImNzc0Zsb2F0IgoJfSwKCgkvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEgKSB7CgkJLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCXZhciByZXQsIHR5cGUsIGhvb2tzLAoJCQlvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBvcmlnTmFtZSApICk7CgoJCS8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KCQkvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07CgoJCS8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCgkJCS8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICYmIChyZXQgPSBycmVsTnVtLmV4ZWMoIHZhbHVlICkpICkgewoJCQkJdmFsdWUgPSAoIHJldFsxXSArIDEgKSAqIHJldFsyXSArIHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKSApOwoJCQkJLy8gRml4ZXMgYnVnICM5MjM3CgkJCQl0eXBlID0gIm51bWJlciI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IG51bGwgYW5kIE5hTiB2YWx1ZXMgYXJlbid0IHNldC4gU2VlOiAjNzExNgoJCQlpZiAoIHZhbHVlID09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhIG51bWJlciB3YXMgcGFzc2VkIGluLCBhZGQgJ3B4JyB0byB0aGUgKGV4Y2VwdCBmb3IgY2VydGFpbiBDU1MgcHJvcGVydGllcykKCQkJaWYgKCB0eXBlID09PSAibnVtYmVyIiAmJiAhalF1ZXJ5LmNzc051bWJlclsgb3JpZ05hbWUgXSApIHsKCQkJCXZhbHVlICs9ICJweCI7CgkJCX0KCgkJCS8vIEZpeGVzICM4OTA4LCBpdCBjYW4gYmUgZG9uZSBtb3JlIGNvcnJlY3RseSBieSBzcGVjaWZ5aW5nIHNldHRlcnMgaW4gY3NzSG9va3MsCgkJCS8vIGJ1dCBpdCB3b3VsZCBtZWFuIHRvIGRlZmluZSBlaWdodCAoZm9yIGV2ZXJ5IHByb2JsZW1hdGljIHByb3BlcnR5KSBpZGVudGljYWwgZnVuY3Rpb25zCgkJCWlmICggIXN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoICJiYWNrZ3JvdW5kIiApID09PSAwICkgewoJCQkJc3R5bGVbIG5hbWUgXSA9ICJpbmhlcml0IjsKCQkJfQoKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCwgdXNlIHRoYXQgdmFsdWUsIG90aGVyd2lzZSBqdXN0IHNldCB0aGUgc3BlY2lmaWVkIHZhbHVlCgkJCWlmICggIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJCX0KCgkJfSBlbHNlIHsKCQkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCgkJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgZmFsc2UsIGV4dHJhICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgoJCQkvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAoJCQlyZXR1cm4gc3R5bGVbIG5hbWUgXTsKCQl9Cgl9LAoKCWNzczogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMgKSB7CgkJdmFyIHZhbCwgbnVtLCBob29rcywKCQkJb3JpZ05hbWUgPSBqUXVlcnkuY2FtZWxDYXNlKCBuYW1lICk7CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCW5hbWUgPSBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gfHwgKCBqUXVlcnkuY3NzUHJvcHNbIG9yaWdOYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggZWxlbS5zdHlsZSwgb3JpZ05hbWUgKSApOwoKCQkvLyBnZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uCgkJLy8gZm9sbG93ZWQgYnkgdGhlIHVucHJlZml4ZWQgdmVyc2lvbgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gfHwgalF1ZXJ5LmNzc0hvb2tzWyBvcmlnTmFtZSBdOwoKCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCWlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgKSB7CgkJCXZhbCA9IGhvb2tzLmdldCggZWxlbSwgdHJ1ZSwgZXh0cmEgKTsKCQl9CgoJCS8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0CgkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lLCBzdHlsZXMgKTsKCQl9CgoJCS8vY29udmVydCAibm9ybWFsIiB0byBjb21wdXRlZCB2YWx1ZQoJCWlmICggdmFsID09PSAibm9ybWFsIiAmJiBuYW1lIGluIGNzc05vcm1hbFRyYW5zZm9ybSApIHsKCQkJdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtWyBuYW1lIF07CgkJfQoKCQkvLyBSZXR1cm4sIGNvbnZlcnRpbmcgdG8gbnVtYmVyIGlmIGZvcmNlZCBvciBhIHF1YWxpZmllciB3YXMgcHJvdmlkZWQgYW5kIHZhbCBsb29rcyBudW1lcmljCgkJaWYgKCBleHRyYSA9PT0gIiIgfHwgZXh0cmEgKSB7CgkJCW51bSA9IHBhcnNlRmxvYXQoIHZhbCApOwoJCQlyZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgalF1ZXJ5LmlzTnVtZXJpYyggbnVtICkgPyBudW0gfHwgMCA6IHZhbDsKCQl9CgkJcmV0dXJuIHZhbDsKCX0KfSk7CgpqUXVlcnkuZWFjaChbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF0gPSB7CgkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQsIGV4dHJhICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJLy8gY2VydGFpbiBlbGVtZW50cyBjYW4gaGF2ZSBkaW1lbnNpb24gaW5mbyBpZiB3ZSBpbnZpc2libHkgc2hvdyB0aGVtCgkJCQkvLyBob3dldmVyLCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0IGZyb20gdGhpcwoJCQkJcmV0dXJuIHJkaXNwbGF5c3dhcC50ZXN0KCBqUXVlcnkuY3NzKCBlbGVtLCAiZGlzcGxheSIgKSApICYmIGVsZW0ub2Zmc2V0V2lkdGggPT09IDAgPwoJCQkJCWpRdWVyeS5zd2FwKCBlbGVtLCBjc3NTaG93LCBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CgkJCQkJfSkgOgoJCQkJCWdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIG5hbWUsIGV4dHJhICk7CgkJCX0KCQl9LAoKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSB7CgkJCXZhciBzdHlsZXMgPSBleHRyYSAmJiBnZXRTdHlsZXMoIGVsZW0gKTsKCQkJcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKCBlbGVtLCB2YWx1ZSwgZXh0cmEgPwoJCQkJYXVnbWVudFdpZHRoT3JIZWlnaHQoCgkJCQkJZWxlbSwKCQkJCQluYW1lLAoJCQkJCWV4dHJhLAoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQkJCQlzdHlsZXMKCQkJCSkgOiAwCgkJCSk7CgkJfQoJfTsKfSk7CgovLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwpqUXVlcnkuY3NzSG9va3MubWFyZ2luUmlnaHQgPSBhZGRHZXRIb29rSWYoIHN1cHBvcnQucmVsaWFibGVNYXJnaW5SaWdodCwKCWZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQlpZiAoIGNvbXB1dGVkICkgewoJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKCQkJLy8gV29yayBhcm91bmQgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyBlbGVtZW50IGRpc3BsYXkgdG8gaW5saW5lLWJsb2NrCgkJCXJldHVybiBqUXVlcnkuc3dhcCggZWxlbSwgeyAiZGlzcGxheSI6ICJpbmxpbmUtYmxvY2siIH0sCgkJCQljdXJDU1MsIFsgZWxlbSwgIm1hcmdpblJpZ2h0IiBdICk7CgkJfQoJfQopOwoKLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwpqUXVlcnkuZWFjaCh7CgltYXJnaW46ICIiLAoJcGFkZGluZzogIiIsCglib3JkZXI6ICJXaWR0aCIKfSwgZnVuY3Rpb24oIHByZWZpeCwgc3VmZml4ICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXSA9IHsKCQlleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGkgPSAwLAoJCQkJZXhwYW5kZWQgPSB7fSwKCgkJCQkvLyBhc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbIHZhbHVlIF07CgoJCQlmb3IgKCA7IGkgPCA0OyBpKysgKSB7CgkJCQlleHBhbmRlZFsgcHJlZml4ICsgY3NzRXhwYW5kWyBpIF0gKyBzdWZmaXggXSA9CgkJCQkJcGFydHNbIGkgXSB8fCBwYXJ0c1sgaSAtIDIgXSB8fCBwYXJ0c1sgMCBdOwoJCQl9CgoJCQlyZXR1cm4gZXhwYW5kZWQ7CgkJfQoJfTsKCglpZiAoICFybWFyZ2luLnRlc3QoIHByZWZpeCApICkgewoJCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0uc2V0ID0gc2V0UG9zaXRpdmVOdW1iZXI7Cgl9Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJCXZhciBzdHlsZXMsIGxlbiwKCQkJCW1hcCA9IHt9LAoJCQkJaSA9IDA7CgoJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCBuYW1lICkgKSB7CgkJCQlzdHlsZXMgPSBnZXRTdHlsZXMoIGVsZW0gKTsKCQkJCWxlbiA9IG5hbWUubGVuZ3RoOwoKCQkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJCW1hcFsgbmFtZVsgaSBdIF0gPSBqUXVlcnkuY3NzKCBlbGVtLCBuYW1lWyBpIF0sIGZhbHNlLCBzdHlsZXMgKTsKCQkJCX0KCgkJCQlyZXR1cm4gbWFwOwoJCQl9CgoJCQlyZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUsIHZhbHVlICkgOgoJCQkJalF1ZXJ5LmNzcyggZWxlbSwgbmFtZSApOwoJCX0sIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCXNob3c6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcywgdHJ1ZSApOwoJfSwKCWhpZGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcyApOwoJfSwKCXRvZ2dsZTogZnVuY3Rpb24oIHN0YXRlICkgewoJCWlmICggdHlwZW9mIHN0YXRlID09PSAiYm9vbGVhbiIgKSB7CgkJCXJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIGlzSGlkZGVuKCB0aGlzICkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5zaG93KCk7CgkJCX0gZWxzZSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5oaWRlKCk7CgkJCX0KCQl9KTsKCX0KfSk7CgoKZnVuY3Rpb24gVHdlZW4oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nICkgewoJcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdCggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKTsKfQpqUXVlcnkuVHdlZW4gPSBUd2VlbjsKClR3ZWVuLnByb3RvdHlwZSA9IHsKCWNvbnN0cnVjdG9yOiBUd2VlbiwKCWluaXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZywgdW5pdCApIHsKCQl0aGlzLmVsZW0gPSBlbGVtOwoJCXRoaXMucHJvcCA9IHByb3A7CgkJdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgInN3aW5nIjsKCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwoJCXRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CgkJdGhpcy5lbmQgPSBlbmQ7CgkJdGhpcy51bml0ID0gdW5pdCB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApOwoJfSwKCWN1cjogZnVuY3Rpb24oKSB7CgkJdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/CgkJCWhvb2tzLmdldCggdGhpcyApIDoKCQkJVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LmdldCggdGhpcyApOwoJfSwKCXJ1bjogZnVuY3Rpb24oIHBlcmNlbnQgKSB7CgkJdmFyIGVhc2VkLAoJCQlob29rcyA9IFR3ZWVuLnByb3BIb29rc1sgdGhpcy5wcm9wIF07CgoJCWlmICggdGhpcy5vcHRpb25zLmR1cmF0aW9uICkgewoJCQl0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1sgdGhpcy5lYXNpbmcgXSgKCQkJCXBlcmNlbnQsIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIHBlcmNlbnQsIDAsIDEsIHRoaXMub3B0aW9ucy5kdXJhdGlvbgoJCQkpOwoJCX0gZWxzZSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBwZXJjZW50OwoJCX0KCQl0aGlzLm5vdyA9ICggdGhpcy5lbmQgLSB0aGlzLnN0YXJ0ICkgKiBlYXNlZCArIHRoaXMuc3RhcnQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnN0ZXAgKSB7CgkJCXRoaXMub3B0aW9ucy5zdGVwLmNhbGwoIHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMgKTsKCQl9CgoJCWlmICggaG9va3MgJiYgaG9va3Muc2V0ICkgewoJCQlob29rcy5zZXQoIHRoaXMgKTsKCQl9IGVsc2UgewoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuc2V0KCB0aGlzICk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQp9OwoKVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwoKVHdlZW4ucHJvcEhvb2tzID0gewoJX2RlZmF1bHQ6IHsKCQlnZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJdmFyIHJlc3VsdDsKCgkJCWlmICggdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdICE9IG51bGwgJiYKCQkJCSghdHdlZW4uZWxlbS5zdHlsZSB8fCB0d2Vlbi5lbGVtLnN0eWxlWyB0d2Vlbi5wcm9wIF0gPT0gbnVsbCkgKSB7CgkJCQlyZXR1cm4gdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdOwoJCQl9CgoJCQkvLyBwYXNzaW5nIGFuIGVtcHR5IHN0cmluZyBhcyBhIDNyZCBwYXJhbWV0ZXIgdG8gLmNzcyB3aWxsIGF1dG9tYXRpY2FsbHkKCQkJLy8gYXR0ZW1wdCBhIHBhcnNlRmxvYXQgYW5kIGZhbGxiYWNrIHRvIGEgc3RyaW5nIGlmIHRoZSBwYXJzZSBmYWlscwoJCQkvLyBzbywgc2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0LgoJCQkvLyBjb21wbGV4IHZhbHVlcyBzdWNoIGFzICJyb3RhdGUoMXJhZCkiIGFyZSByZXR1cm5lZCBhcyBpcy4KCQkJcmVzdWx0ID0galF1ZXJ5LmNzcyggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgIiIgKTsKCQkJLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgoJCQlyZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCQkJLy8gdXNlIHN0ZXAgaG9vayBmb3IgYmFjayBjb21wYXQgLSB1c2UgY3NzSG9vayBpZiBpdHMgdGhlcmUgLSB1c2UgLnN0eWxlIGlmIGl0cwoJCQkvLyBhdmFpbGFibGUgYW5kIHVzZSBwbGFpbiBwcm9wZXJ0aWVzIHdoZXJlIGF2YWlsYWJsZQoJCQlpZiAoIGpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0gKSB7CgkJCQlqUXVlcnkuZnguc3RlcFsgdHdlZW4ucHJvcCBdKCB0d2VlbiApOwoJCQl9IGVsc2UgaWYgKCB0d2Vlbi5lbGVtLnN0eWxlICYmICggdHdlZW4uZWxlbS5zdHlsZVsgalF1ZXJ5LmNzc1Byb3BzWyB0d2Vlbi5wcm9wIF0gXSAhPSBudWxsIHx8IGpRdWVyeS5jc3NIb29rc1sgdHdlZW4ucHJvcCBdICkgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQgKTsKCQkJfSBlbHNlIHsKCQkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQkJfQoJCX0KCX0KfTsKCi8vIFN1cHBvcnQ6IElFOQovLyBQYW5pYyBiYXNlZCBhcHByb2FjaCB0byBzZXR0aW5nIHRoaW5ncyBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCWlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CgkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQl9Cgl9Cn07CgpqUXVlcnkuZWFzaW5nID0gewoJbGluZWFyOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gcDsKCX0sCglzd2luZzogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDAuNSAtIE1hdGguY29zKCBwICogTWF0aC5QSSApIC8gMjsKCX0KfTsKCmpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0OwoKLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKCgoKCnZhcgoJZnhOb3csIHRpbWVySWQsCglyZnh0eXBlcyA9IC9eKD86dG9nZ2xlfHNob3d8aGlkZSkkLywKCXJmeG51bSA9IG5ldyBSZWdFeHAoICJeKD86KFsrLV0pPXwpKCIgKyBwbnVtICsgIikoW2EteiVdKikkIiwgImkiICksCglycnVuID0gL3F1ZXVlSG9va3MkLywKCWFuaW1hdGlvblByZWZpbHRlcnMgPSBbIGRlZmF1bHRQcmVmaWx0ZXIgXSwKCXR3ZWVuZXJzID0gewoJCSIqIjogWyBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJCXZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4oIHByb3AsIHZhbHVlICksCgkJCQl0YXJnZXQgPSB0d2Vlbi5jdXIoKSwKCQkJCXBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCgkJCQl1bml0ID0gcGFydHMgJiYgcGFydHNbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApLAoKCQkJCS8vIFN0YXJ0aW5nIHZhbHVlIGNvbXB1dGF0aW9uIGlzIHJlcXVpcmVkIGZvciBwb3RlbnRpYWwgdW5pdCBtaXNtYXRjaGVzCgkJCQlzdGFydCA9ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdIHx8IHVuaXQgIT09ICJweCIgJiYgK3RhcmdldCApICYmCgkJCQkJcmZ4bnVtLmV4ZWMoIGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AgKSApLAoJCQkJc2NhbGUgPSAxLAoJCQkJbWF4SXRlcmF0aW9ucyA9IDIwOwoKCQkJaWYgKCBzdGFydCAmJiBzdGFydFsgMyBdICE9PSB1bml0ICkgewoJCQkJLy8gVHJ1c3QgdW5pdHMgcmVwb3J0ZWQgYnkgalF1ZXJ5LmNzcwoJCQkJdW5pdCA9IHVuaXQgfHwgc3RhcnRbIDMgXTsKCgkJCQkvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCgkJCQlwYXJ0cyA9IHBhcnRzIHx8IFtdOwoKCQkJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CgkJCQlzdGFydCA9ICt0YXJnZXQgfHwgMTsKCgkJCQlkbyB7CgkJCQkJLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKCQkJCQkvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwoJCQkJCXNjYWxlID0gc2NhbGUgfHwgIi41IjsKCgkJCQkJLy8gQWRqdXN0IGFuZCBhcHBseQoJCQkJCXN0YXJ0ID0gc3RhcnQgLyBzY2FsZTsKCQkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKCQkJCS8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCgkJCQkvLyBBbmQgYnJlYWtpbmcgdGhlIGxvb3AgaWYgc2NhbGUgaXMgdW5jaGFuZ2VkIG9yIHBlcmZlY3QsIG9yIGlmIHdlJ3ZlIGp1c3QgaGFkIGVub3VnaAoJCQkJfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7CgkJCX0KCgkJCS8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzCgkJCWlmICggcGFydHMgKSB7CgkJCQlzdGFydCA9IHR3ZWVuLnN0YXJ0ID0gK3N0YXJ0IHx8ICt0YXJnZXQgfHwgMDsKCQkJCXR3ZWVuLnVuaXQgPSB1bml0OwoJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQl0d2Vlbi5lbmQgPSBwYXJ0c1sgMSBdID8KCQkJCQlzdGFydCArICggcGFydHNbIDEgXSArIDEgKSAqIHBhcnRzWyAyIF0gOgoJCQkJCStwYXJ0c1sgMiBdOwoJCQl9CgoJCQlyZXR1cm4gdHdlZW47CgkJfSBdCgl9OwoKLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQpmdW5jdGlvbiBjcmVhdGVGeE5vdygpIHsKCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJZnhOb3cgPSB1bmRlZmluZWQ7Cgl9KTsKCXJldHVybiAoIGZ4Tm93ID0galF1ZXJ5Lm5vdygpICk7Cn0KCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJaSA9IDAsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9OwoKCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKCWluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aCA/IDEgOiAwOwoJZm9yICggOyBpIDwgNCA7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCApIHsKCQl3aGljaCA9IGNzc0V4cGFuZFsgaSBdOwoJCWF0dHJzWyAibWFyZ2luIiArIHdoaWNoIF0gPSBhdHRyc1sgInBhZGRpbmciICsgd2hpY2ggXSA9IHR5cGU7Cgl9CgoJaWYgKCBpbmNsdWRlV2lkdGggKSB7CgkJYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKCX0KCglyZXR1cm4gYXR0cnM7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVR3ZWVuKCB2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uICkgewoJdmFyIHR3ZWVuLAoJCWNvbGxlY3Rpb24gPSAoIHR3ZWVuZXJzWyBwcm9wIF0gfHwgW10gKS5jb25jYXQoIHR3ZWVuZXJzWyAiKiIgXSApLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJaWYgKCAodHdlZW4gPSBjb2xsZWN0aW9uWyBpbmRleCBdLmNhbGwoIGFuaW1hdGlvbiwgcHJvcCwgdmFsdWUgKSkgKSB7CgoJCQkvLyB3ZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQoJCQlyZXR1cm4gdHdlZW47CgkJfQoJfQp9CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKCS8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KCXZhciBwcm9wLCB2YWx1ZSwgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsIGRpc3BsYXksIGNoZWNrRGlzcGxheSwKCQlhbmltID0gdGhpcywKCQlvcmlnID0ge30sCgkJc3R5bGUgPSBlbGVtLnN0eWxlLAoJCWhpZGRlbiA9IGVsZW0ubm9kZVR5cGUgJiYgaXNIaWRkZW4oIGVsZW0gKSwKCQlkYXRhU2hvdyA9IGRhdGFfcHJpdi5nZXQoIGVsZW0sICJmeHNob3ciICk7CgoJLy8gaGFuZGxlIHF1ZXVlOiBmYWxzZSBwcm9taXNlcwoJaWYgKCAhb3B0cy5xdWV1ZSApIHsKCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgImZ4IiApOwoJCWlmICggaG9va3MudW5xdWV1ZWQgPT0gbnVsbCApIHsKCQkJaG9va3MudW5xdWV1ZWQgPSAwOwoJCQlvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKCQkJaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhaG9va3MudW5xdWV1ZWQgKSB7CgkJCQkJb2xkZmlyZSgpOwoJCQkJfQoJCQl9OwoJCX0KCQlob29rcy51bnF1ZXVlZCsrOwoKCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJLy8gZG9pbmcgdGhpcyBtYWtlcyBzdXJlIHRoYXQgdGhlIGNvbXBsZXRlIGhhbmRsZXIgd2lsbCBiZSBjYWxsZWQKCQkJLy8gYmVmb3JlIHRoaXMgY29tcGxldGVzCgkJCWFuaW0uYWx3YXlzKGZ1bmN0aW9uKCkgewoJCQkJaG9va3MudW5xdWV1ZWQtLTsKCQkJCWlmICggIWpRdWVyeS5xdWV1ZSggZWxlbSwgImZ4IiApLmxlbmd0aCApIHsKCQkJCQlob29rcy5lbXB0eS5maXJlKCk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJfQoKCS8vIGhlaWdodC93aWR0aCBvdmVyZmxvdyBwYXNzCglpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCAiaGVpZ2h0IiBpbiBwcm9wcyB8fCAid2lkdGgiIGluIHByb3BzICkgKSB7CgkJLy8gTWFrZSBzdXJlIHRoYXQgbm90aGluZyBzbmVha3Mgb3V0CgkJLy8gUmVjb3JkIGFsbCAzIG92ZXJmbG93IGF0dHJpYnV0ZXMgYmVjYXVzZSBJRTktMTAgZG8gbm90CgkJLy8gY2hhbmdlIHRoZSBvdmVyZmxvdyBhdHRyaWJ1dGUgd2hlbiBvdmVyZmxvd1ggYW5kCgkJLy8gb3ZlcmZsb3dZIGFyZSBzZXQgdG8gdGhlIHNhbWUgdmFsdWUKCQlvcHRzLm92ZXJmbG93ID0gWyBzdHlsZS5vdmVyZmxvdywgc3R5bGUub3ZlcmZsb3dYLCBzdHlsZS5vdmVyZmxvd1kgXTsKCgkJLy8gU2V0IGRpc3BsYXkgcHJvcGVydHkgdG8gaW5saW5lLWJsb2NrIGZvciBoZWlnaHQvd2lkdGgKCQkvLyBhbmltYXRpb25zIG9uIGlubGluZSBlbGVtZW50cyB0aGF0IGFyZSBoYXZpbmcgd2lkdGgvaGVpZ2h0IGFuaW1hdGVkCgkJZGlzcGxheSA9IGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApOwoKCQkvLyBUZXN0IGRlZmF1bHQgZGlzcGxheSBpZiBkaXNwbGF5IGlzIGN1cnJlbnRseSAibm9uZSIKCQljaGVja0Rpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPwoJCQlkYXRhX3ByaXYuZ2V0KCBlbGVtLCAib2xkZGlzcGxheSIgKSB8fCBkZWZhdWx0RGlzcGxheSggZWxlbS5ub2RlTmFtZSApIDogZGlzcGxheTsKCgkJaWYgKCBjaGVja0Rpc3BsYXkgPT09ICJpbmxpbmUiICYmIGpRdWVyeS5jc3MoIGVsZW0sICJmbG9hdCIgKSA9PT0gIm5vbmUiICkgewoJCQlzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CgkJfQoJfQoKCWlmICggb3B0cy5vdmVyZmxvdyApIHsKCQlzdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwoJCWFuaW0uYWx3YXlzKGZ1bmN0aW9uKCkgewoJCQlzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsKCQkJc3R5bGUub3ZlcmZsb3dYID0gb3B0cy5vdmVyZmxvd1sgMSBdOwoJCQlzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WyAyIF07CgkJfSk7Cgl9CgoJLy8gc2hvdy9oaWRlIHBhc3MKCWZvciAoIHByb3AgaW4gcHJvcHMgKSB7CgkJdmFsdWUgPSBwcm9wc1sgcHJvcCBdOwoJCWlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsKCQkJZGVsZXRlIHByb3BzWyBwcm9wIF07CgkJCXRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7CgoJCQkJLy8gSWYgdGhlcmUgaXMgZGF0YVNob3cgbGVmdCBvdmVyIGZyb20gYSBzdG9wcGVkIGhpZGUgb3Igc2hvdyBhbmQgd2UgYXJlIGdvaW5nIHRvIHByb2NlZWQgd2l0aCBzaG93LCB3ZSBzaG91bGQgcHJldGVuZCB0byBiZSBoaWRkZW4KCQkJCWlmICggdmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1sgcHJvcCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaGlkZGVuID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCX0KCQkJb3JpZ1sgcHJvcCBdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCgkJLy8gQW55IG5vbi1meCB2YWx1ZSBzdG9wcyB1cyBmcm9tIHJlc3RvcmluZyB0aGUgb3JpZ2luYWwgZGlzcGxheSB2YWx1ZQoJCX0gZWxzZSB7CgkJCWRpc3BsYXkgPSB1bmRlZmluZWQ7CgkJfQoJfQoKCWlmICggIWpRdWVyeS5pc0VtcHR5T2JqZWN0KCBvcmlnICkgKSB7CgkJaWYgKCBkYXRhU2hvdyApIHsKCQkJaWYgKCAiaGlkZGVuIiBpbiBkYXRhU2hvdyApIHsKCQkJCWhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsKCQkJfQoJCX0gZWxzZSB7CgkJCWRhdGFTaG93ID0gZGF0YV9wcml2LmFjY2VzcyggZWxlbSwgImZ4c2hvdyIsIHt9ICk7CgkJfQoKCQkvLyBzdG9yZSBzdGF0ZSBpZiBpdHMgdG9nZ2xlIC0gZW5hYmxlcyAuc3RvcCgpLnRvZ2dsZSgpIHRvICJyZXZlcnNlIgoJCWlmICggdG9nZ2xlICkgewoJCQlkYXRhU2hvdy5oaWRkZW4gPSAhaGlkZGVuOwoJCX0KCQlpZiAoIGhpZGRlbiApIHsKCQkJalF1ZXJ5KCBlbGVtICkuc2hvdygpOwoJCX0gZWxzZSB7CgkJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsKCQkJCWpRdWVyeSggZWxlbSApLmhpZGUoKTsKCQkJfSk7CgkJfQoJCWFuaW0uZG9uZShmdW5jdGlvbigpIHsKCQkJdmFyIHByb3A7CgoJCQlkYXRhX3ByaXYucmVtb3ZlKCBlbGVtLCAiZnhzaG93IiApOwoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AsIG9yaWdbIHByb3AgXSApOwoJCQl9CgkJfSk7CgkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQl0d2VlbiA9IGNyZWF0ZVR3ZWVuKCBoaWRkZW4gPyBkYXRhU2hvd1sgcHJvcCBdIDogMCwgcHJvcCwgYW5pbSApOwoKCQkJaWYgKCAhKCBwcm9wIGluIGRhdGFTaG93ICkgKSB7CgkJCQlkYXRhU2hvd1sgcHJvcCBdID0gdHdlZW4uc3RhcnQ7CgkJCQlpZiAoIGhpZGRlbiApIHsKCQkJCQl0d2Vlbi5lbmQgPSB0d2Vlbi5zdGFydDsKCQkJCQl0d2Vlbi5zdGFydCA9IHByb3AgPT09ICJ3aWR0aCIgfHwgcHJvcCA9PT0gImhlaWdodCIgPyAxIDogMDsKCQkJCX0KCQkJfQoJCX0KCgkvLyBJZiB0aGlzIGlzIGEgbm9vcCBsaWtlIC5oaWRlKCkuaGlkZSgpLCByZXN0b3JlIGFuIG92ZXJ3cml0dGVuIGRpc3BsYXkgdmFsdWUKCX0gZWxzZSBpZiAoIChkaXNwbGF5ID09PSAibm9uZSIgPyBkZWZhdWx0RGlzcGxheSggZWxlbS5ub2RlTmFtZSApIDogZGlzcGxheSkgPT09ICJpbmxpbmUiICkgewoJCXN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5OwoJfQp9CgpmdW5jdGlvbiBwcm9wRmlsdGVyKCBwcm9wcywgc3BlY2lhbEVhc2luZyApIHsKCXZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CgoJLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCglmb3IgKCBpbmRleCBpbiBwcm9wcyApIHsKCQluYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggaW5kZXggKTsKCQllYXNpbmcgPSBzcGVjaWFsRWFzaW5nWyBuYW1lIF07CgkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXTsKCQlpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQllYXNpbmcgPSB2YWx1ZVsgMSBdOwoJCQl2YWx1ZSA9IHByb3BzWyBpbmRleCBdID0gdmFsdWVbIDAgXTsKCQl9CgoJCWlmICggaW5kZXggIT09IG5hbWUgKSB7CgkJCXByb3BzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJZGVsZXRlIHByb3BzWyBpbmRleCBdOwoJCX0KCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXTsKCQlpZiAoIGhvb2tzICYmICJleHBhbmQiIGluIGhvb2tzICkgewoJCQl2YWx1ZSA9IGhvb2tzLmV4cGFuZCggdmFsdWUgKTsKCQkJZGVsZXRlIHByb3BzWyBuYW1lIF07CgoJCQkvLyBub3QgcXVpdGUgJC5leHRlbmQsIHRoaXMgd29udCBvdmVyd3JpdGUga2V5cyBhbHJlYWR5IHByZXNlbnQuCgkJCS8vIGFsc28gLSByZXVzaW5nICdpbmRleCcgZnJvbSBhYm92ZSBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCgkJCWZvciAoIGluZGV4IGluIHZhbHVlICkgewoJCQkJaWYgKCAhKCBpbmRleCBpbiBwcm9wcyApICkgewoJCQkJCXByb3BzWyBpbmRleCBdID0gdmFsdWVbIGluZGV4IF07CgkJCQkJc3BlY2lhbEVhc2luZ1sgaW5kZXggXSA9IGVhc2luZzsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCXNwZWNpYWxFYXNpbmdbIG5hbWUgXSA9IGVhc2luZzsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKCXZhciByZXN1bHQsCgkJc3RvcHBlZCwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gYW5pbWF0aW9uUHJlZmlsdGVycy5sZW5ndGgsCgkJZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewoJCQkvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKCQkJZGVsZXRlIHRpY2suZWxlbTsKCQl9KSwKCQl0aWNrID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc3RvcHBlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoJCQkJLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKCQkJCXRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwKCQkJCWluZGV4ID0gMCwKCQkJCWxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwoKCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwoJCQl9CgoJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKCQkJaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtYWluaW5nOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgkJYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CgkJCWVsZW06IGVsZW0sCgkJCXByb3BzOiBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcGVydGllcyApLAoJCQlvcHRzOiBqUXVlcnkuZXh0ZW5kKCB0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMgKSwKCQkJb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCXR3ZWVuczogW10sCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kICkgewoJCQkJdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKCBlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLAoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7CgkJCQlhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CgkJCQlyZXR1cm4gdHdlZW47CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBnb3RvRW5kICkgewoJCQkJdmFyIGluZGV4ID0gMCwKCQkJCQkvLyBpZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKCQkJCQkvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKCQkJCQlsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwoJCQkJaWYgKCBzdG9wcGVkICkgewoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQkJc3RvcHBlZCA9IHRydWU7CgkJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggMSApOwoJCQkJfQoKCQkJCS8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKCQkJCS8vIG90aGVyd2lzZSwgcmVqZWN0CgkJCQlpZiAoIGdvdG9FbmQgKSB7CgkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9KSwKCQlwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKCglwcm9wRmlsdGVyKCBwcm9wcywgYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZyApOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCXJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMgKTsKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CgoJalF1ZXJ5Lm1hcCggcHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24gKTsKCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBhbmltYXRpb24ub3B0cy5zdGFydCApICkgewoJCWFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwoJfQoKCWpRdWVyeS5meC50aW1lcigKCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7CgkJCWVsZW06IGVsZW0sCgkJCWFuaW06IGFuaW1hdGlvbiwKCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCgkJfSkKCSk7CgoJLy8gYXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMKCXJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkKCQkuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKalF1ZXJ5LkFuaW1hdGlvbiA9IGpRdWVyeS5leHRlbmQoIEFuaW1hdGlvbiwgewoKCXR3ZWVuZXI6IGZ1bmN0aW9uKCBwcm9wcywgY2FsbGJhY2sgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcHJvcHMgKSApIHsKCQkJY2FsbGJhY2sgPSBwcm9wczsKCQkJcHJvcHMgPSBbICIqIiBdOwoJCX0gZWxzZSB7CgkJCXByb3BzID0gcHJvcHMuc3BsaXQoIiAiKTsKCQl9CgoJCXZhciBwcm9wLAoJCQlpbmRleCA9IDAsCgkJCWxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCgkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCXByb3AgPSBwcm9wc1sgaW5kZXggXTsKCQkJdHdlZW5lcnNbIHByb3AgXSA9IHR3ZWVuZXJzWyBwcm9wIF0gfHwgW107CgkJCXR3ZWVuZXJzWyBwcm9wIF0udW5zaGlmdCggY2FsbGJhY2sgKTsKCQl9Cgl9LAoKCXByZWZpbHRlcjogZnVuY3Rpb24oIGNhbGxiYWNrLCBwcmVwZW5kICkgewoJCWlmICggcHJlcGVuZCApIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWFuaW1hdGlvblByZWZpbHRlcnMucHVzaCggY2FsbGJhY2sgKTsKCQl9Cgl9Cn0pOwoKalF1ZXJ5LnNwZWVkID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGZuICkgewoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsKCQljb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fAoJCQlqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBzcGVlZCwKCQlkdXJhdGlvbjogc3BlZWQsCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgJiYgZWFzaW5nCgl9OwoKCW9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gIm51bWJlciIgPyBvcHQuZHVyYXRpb24gOgoJCW9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKCS8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKCWlmICggb3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlICkgewoJCW9wdC5xdWV1ZSA9ICJmeCI7Cgl9CgoJLy8gUXVldWVpbmcKCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0Lm9sZCApICkgewoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQl9CgoJCWlmICggb3B0LnF1ZXVlICkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7CgkJfQoJfTsKCglyZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW4gKS5jc3MoICJvcGFjaXR5IiwgMCApLnNob3coKQoKCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCgkJCS5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgfHwgZGF0YV9wcml2LmdldCggdGhpcywgImZpbmlzaCIgKSApIHsKCQkJCQlhbmltLnN0b3AoIHRydWUgKTsKCQkJCX0KCQkJfTsKCQkJZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CgoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBkb0FuaW1hdGlvbiApIDoKCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCB0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsKCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCXN0b3AoIGdvdG9FbmQgKTsKCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7CgkJCWNsZWFyUXVldWUgPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBkZXF1ZXVlID0gdHJ1ZSwKCQkJCWluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJZGF0YSA9IGRhdGFfcHJpdi5nZXQoIHRoaXMgKTsKCgkJCWlmICggaW5kZXggKSB7CgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewoJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaW5kZXggaW4gZGF0YSApIHsKCQkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSkgKSB7CgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggZ290b0VuZCApOwoJCQkJCWRlcXVldWUgPSBmYWxzZTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCgkJCS8vIHRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2ggd2lsbCBkZXF1ZXVlCgkJCS8vIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kCgkJCWlmICggZGVxdWV1ZSB8fCAhZ290b0VuZCApIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCX0KCQl9KTsKCX0sCglmaW5pc2g6IGZ1bmN0aW9uKCB0eXBlICkgewoJCWlmICggdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCWRhdGEgPSBkYXRhX3ByaXYuZ2V0KCB0aGlzICksCgkJCQlxdWV1ZSA9IGRhdGFbIHR5cGUgKyAicXVldWUiIF0sCgkJCQlob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwKCQkJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJCQlsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CgoJCQkvLyBlbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCgkJCWRhdGEuZmluaXNoID0gdHJ1ZTsKCgkJCS8vIGVtcHR5IHRoZSBxdWV1ZSBmaXJzdAoJCQlqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIFtdICk7CgoJCQlpZiAoIGhvb2tzICYmIGhvb2tzLnN0b3AgKSB7CgkJCQlob29rcy5zdG9wLmNhbGwoIHRoaXMsIHRydWUgKTsKCQkJfQoKCQkJLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0KCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsKCQkJCWlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlICkgewoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIHRydWUgKTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBsb29rIGZvciBhbnkgYW5pbWF0aW9ucyBpbiB0aGUgb2xkIHF1ZXVlIGFuZCBmaW5pc2ggdGhlbQoJCQlmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQkJaWYgKCBxdWV1ZVsgaW5kZXggXSAmJiBxdWV1ZVsgaW5kZXggXS5maW5pc2ggKSB7CgkJCQkJcXVldWVbIGluZGV4IF0uZmluaXNoLmNhbGwoIHRoaXMgKTsKCQkJCX0KCQkJfQoKCQkJLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcKCQkJZGVsZXRlIGRhdGEuZmluaXNoOwoJCX0pOwoJfQp9KTsKCmpRdWVyeS5lYWNoKFsgInRvZ2dsZSIsICJzaG93IiwgImhpZGUiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJdmFyIGNzc0ZuID0galF1ZXJ5LmZuWyBuYW1lIF07CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/CgkJCWNzc0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA6CgkJCXRoaXMuYW5pbWF0ZSggZ2VuRngoIG5hbWUsIHRydWUgKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwpqUXVlcnkuZWFjaCh7CglzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCglzbGlkZVVwOiBnZW5GeCgiaGlkZSIpLAoJc2xpZGVUb2dnbGU6IGdlbkZ4KCJ0b2dnbGUiKSwKCWZhZGVJbjogeyBvcGFjaXR5OiAic2hvdyIgfSwKCWZhZGVPdXQ6IHsgb3BhY2l0eTogImhpZGUiIH0sCglmYWRlVG9nZ2xlOiB7IG9wYWNpdHk6ICJ0b2dnbGUiIH0KfSwgZnVuY3Rpb24oIG5hbWUsIHByb3BzICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIHRoaXMuYW5pbWF0ZSggcHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7Cgl9Owp9KTsKCmpRdWVyeS50aW1lcnMgPSBbXTsKalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsKCXZhciB0aW1lciwKCQlpID0gMCwKCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzOwoKCWZ4Tm93ID0galF1ZXJ5Lm5vdygpOwoKCWZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKCQl0aW1lciA9IHRpbWVyc1sgaSBdOwoJCS8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAoJCWlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewoJCQl0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKCQl9Cgl9CgoJaWYgKCAhdGltZXJzLmxlbmd0aCApIHsKCQlqUXVlcnkuZnguc3RvcCgpOwoJfQoJZnhOb3cgPSB1bmRlZmluZWQ7Cn07CgpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7CglqUXVlcnkudGltZXJzLnB1c2goIHRpbWVyICk7CglpZiAoIHRpbWVyKCkgKSB7CgkJalF1ZXJ5LmZ4LnN0YXJ0KCk7Cgl9IGVsc2UgewoJCWpRdWVyeS50aW1lcnMucG9wKCk7Cgl9Cn07CgpqUXVlcnkuZnguaW50ZXJ2YWwgPSAxMzsKCmpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uKCkgewoJaWYgKCAhdGltZXJJZCApIHsKCQl0aW1lcklkID0gc2V0SW50ZXJ2YWwoIGpRdWVyeS5meC50aWNrLCBqUXVlcnkuZnguaW50ZXJ2YWwgKTsKCX0KfTsKCmpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24oKSB7CgljbGVhckludGVydmFsKCB0aW1lcklkICk7Cgl0aW1lcklkID0gbnVsbDsKfTsKCmpRdWVyeS5meC5zcGVlZHMgPSB7CglzbG93OiA2MDAsCglmYXN0OiAyMDAsCgkvLyBEZWZhdWx0IHNwZWVkCglfZGVmYXVsdDogNDAwCn07CgoKLy8gQmFzZWQgb2ZmIG9mIHRoZSBwbHVnaW4gYnkgQ2xpbnQgSGVsZmVycywgd2l0aCBwZXJtaXNzaW9uLgovLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCmpRdWVyeS5mbi5kZWxheSA9IGZ1bmN0aW9uKCB0aW1lLCB0eXBlICkgewoJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUsIGZ1bmN0aW9uKCBuZXh0LCBob29rcyApIHsKCQl2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQlob29rcy5zdG9wID0gZnVuY3Rpb24oKSB7CgkJCWNsZWFyVGltZW91dCggdGltZW91dCApOwoJCX07Cgl9KTsKfTsKCgooZnVuY3Rpb24oKSB7Cgl2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiaW5wdXQiICksCgkJc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNlbGVjdCIgKSwKCQlvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJvcHRpb24iICkgKTsKCglpbnB1dC50eXBlID0gImNoZWNrYm94IjsKCgkvLyBTdXBwb3J0OiBpT1MgNS4xLCBBbmRyb2lkIDQueCwgQW5kcm9pZCAyLjMKCS8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBvbGQgV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKCXN1cHBvcnQuY2hlY2tPbiA9IGlucHV0LnZhbHVlICE9PSAiIjsKCgkvLyBNdXN0IGFjY2VzcyB0aGUgcGFyZW50IHRvIG1ha2UgYW4gb3B0aW9uIHNlbGVjdCBwcm9wZXJseQoJLy8gU3VwcG9ydDogSUU5LCBJRTEwCglzdXBwb3J0Lm9wdFNlbGVjdGVkID0gb3B0LnNlbGVjdGVkOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKCS8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CglzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCgkvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KCS8vIFN1cHBvcnQ6IElFOSwgSUUxMAoJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiaW5wdXQiICk7CglpbnB1dC52YWx1ZSA9ICJ0IjsKCWlucHV0LnR5cGUgPSAicmFkaW8iOwoJc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICJ0IjsKfSkoKTsKCgp2YXIgbm9kZUhvb2ssIGJvb2xIb29rLAoJYXR0ckhhbmRsZSA9IGpRdWVyeS5leHByLmF0dHJIYW5kbGU7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWF0dHI6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVBdHRyKCB0aGlzLCBuYW1lICk7CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09IHN0cnVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lLCB2YWx1ZSApOwoJCX0KCgkJLy8gQWxsIGF0dHJpYnV0ZXMgYXJlIGxvd2VyY2FzZQoJCS8vIEdyYWIgbmVjZXNzYXJ5IGhvb2sgaWYgb25lIGlzIGRlZmluZWQKCQlpZiAoIG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCQkJbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQkJaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lIF0gfHwKCQkJCSggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC50ZXN0KCBuYW1lICkgPyBib29sSG9vayA6IG5vZGVIb29rICk7CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgoJCQlpZiAoIHZhbHVlID09PSBudWxsICkgewoJCQkJalF1ZXJ5LnJlbW92ZUF0dHIoIGVsZW0sIG5hbWUgKTsKCgkJCX0gZWxzZSBpZiAoIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gcmV0OwoKCQkJfSBlbHNlIHsKCQkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCB2YWx1ZSArICIiICk7CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0KCgkJfSBlbHNlIGlmICggaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldCggZWxlbSwgbmFtZSApKSAhPT0gbnVsbCApIHsKCQkJcmV0dXJuIHJldDsKCgkJfSBlbHNlIHsKCQkJcmV0ID0galF1ZXJ5LmZpbmQuYXR0ciggZWxlbSwgbmFtZSApOwoKCQkJLy8gTm9uLWV4aXN0ZW50IGF0dHJpYnV0ZXMgcmV0dXJuIG51bGwsIHdlIG5vcm1hbGl6ZSB0byB1bmRlZmluZWQKCQkJcmV0dXJuIHJldCA9PSBudWxsID8KCQkJCXVuZGVmaW5lZCA6CgkJCQlyZXQ7CgkJfQoJfSwKCglyZW1vdmVBdHRyOiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJdmFyIG5hbWUsIHByb3BOYW1lLAoJCQlpID0gMCwKCQkJYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2goIHJub3R3aGl0ZSApOwoKCQlpZiAoIGF0dHJOYW1lcyAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQl3aGlsZSAoIChuYW1lID0gYXR0ck5hbWVzW2krK10pICkgewoJCQkJcHJvcE5hbWUgPSBqUXVlcnkucHJvcEZpeFsgbmFtZSBdIHx8IG5hbWU7CgoJCQkJLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGdldCBzcGVjaWFsIHRyZWF0bWVudCAoIzEwODcwKQoJCQkJaWYgKCBqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QoIG5hbWUgKSApIHsKCQkJCQkvLyBTZXQgY29ycmVzcG9uZGluZyBwcm9wZXJ0eSB0byBmYWxzZQoJCQkJCWVsZW1bIHByb3BOYW1lIF0gPSBmYWxzZTsKCQkJCX0KCgkJCQllbGVtLnJlbW92ZUF0dHJpYnV0ZSggbmFtZSApOwoJCQl9CgkJfQoJfSwKCglhdHRySG9va3M6IHsKCQl0eXBlOiB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJaWYgKCAhc3VwcG9ydC5yYWRpb1ZhbHVlICYmIHZhbHVlID09PSAicmFkaW8iICYmCgkJCQkJalF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAiaW5wdXQiICkgKSB7CgkJCQkJLy8gU2V0dGluZyB0aGUgdHlwZSBvbiBhIHJhZGlvIGJ1dHRvbiBhZnRlciB0aGUgdmFsdWUgcmVzZXRzIHRoZSB2YWx1ZSBpbiBJRTYtOQoJCQkJCS8vIFJlc2V0IHZhbHVlIHRvIGRlZmF1bHQgaW4gY2FzZSB0eXBlIGlzIHNldCBhZnRlciB2YWx1ZSBkdXJpbmcgY3JlYXRpb24KCQkJCQl2YXIgdmFsID0gZWxlbS52YWx1ZTsKCQkJCQllbGVtLnNldEF0dHJpYnV0ZSggInR5cGUiLCB2YWx1ZSApOwoJCQkJCWlmICggdmFsICkgewoJCQkJCQllbGVtLnZhbHVlID0gdmFsOwoJCQkJCX0KCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKLy8gSG9va3MgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwpib29sSG9vayA9IHsKCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkvLyBSZW1vdmUgYm9vbGVhbiBhdHRyaWJ1dGVzIHdoZW4gc2V0IHRvIGZhbHNlCgkJCWpRdWVyeS5yZW1vdmVBdHRyKCBlbGVtLCBuYW1lICk7CgkJfSBlbHNlIHsKCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIG5hbWUgKTsKCQl9CgkJcmV0dXJuIG5hbWU7Cgl9Cn07CmpRdWVyeS5lYWNoKCBqUXVlcnkuZXhwci5tYXRjaC5ib29sLnNvdXJjZS5tYXRjaCggL1x3Ky9nICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJdmFyIGdldHRlciA9IGF0dHJIYW5kbGVbIG5hbWUgXSB8fCBqUXVlcnkuZmluZC5hdHRyOwoKCWF0dHJIYW5kbGVbIG5hbWUgXSA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQl2YXIgcmV0LCBoYW5kbGU7CgkJaWYgKCAhaXNYTUwgKSB7CgkJCS8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKCQkJaGFuZGxlID0gYXR0ckhhbmRsZVsgbmFtZSBdOwoJCQlhdHRySGFuZGxlWyBuYW1lIF0gPSByZXQ7CgkJCXJldCA9IGdldHRlciggZWxlbSwgbmFtZSwgaXNYTUwgKSAhPSBudWxsID8KCQkJCW5hbWUudG9Mb3dlckNhc2UoKSA6CgkJCQludWxsOwoJCQlhdHRySGFuZGxlWyBuYW1lIF0gPSBoYW5kbGU7CgkJfQoJCXJldHVybiByZXQ7Cgl9Owp9KTsKCgoKCnZhciByZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcHJvcDogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGpRdWVyeS5wcm9wLCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCgoJcmVtb3ZlUHJvcDogZnVuY3Rpb24oIG5hbWUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJZGVsZXRlIHRoaXNbIGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZSBdOwoJCX0pOwoJfQp9KTsKCmpRdWVyeS5leHRlbmQoewoJcHJvcEZpeDogewoJCSJmb3IiOiAiaHRtbEZvciIsCgkJImNsYXNzIjogImNsYXNzTmFtZSIKCX0sCgoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciByZXQsIGhvb2tzLCBub3R4bWwsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vdHhtbCA9IG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKTsKCgkJaWYgKCBub3R4bWwgKSB7CgkJCS8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKCQkJbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzWyBuYW1lIF07CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiBob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApKSAhPT0gdW5kZWZpbmVkID8KCQkJCXJldCA6CgkJCQkoIGVsZW1bIG5hbWUgXSA9IHZhbHVlICk7CgoJCX0gZWxzZSB7CgkJCXJldHVybiBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsID8KCQkJCXJldCA6CgkJCQllbGVtWyBuYW1lIF07CgkJfQoJfSwKCglwcm9wSG9va3M6IHsKCQl0YWJJbmRleDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0uaGFzQXR0cmlidXRlKCAidGFiaW5kZXgiICkgfHwgcmZvY3VzYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgfHwgZWxlbS5ocmVmID8KCQkJCQllbGVtLnRhYkluZGV4IDoKCQkJCQktMTsKCQkJfQoJCX0KCX0KfSk7CgovLyBTdXBwb3J0OiBJRTkrCi8vIFNlbGVjdGVkbmVzcyBmb3IgYW4gb3B0aW9uIGluIGFuIG9wdGdyb3VwIGNhbiBiZSBpbmFjY3VyYXRlCmlmICggIXN1cHBvcnQub3B0U2VsZWN0ZWQgKSB7CglqUXVlcnkucHJvcEhvb2tzLnNlbGVjdGVkID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkJCWlmICggcGFyZW50ICYmIHBhcmVudC5wYXJlbnROb2RlICkgewoJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9Cgl9Owp9CgpqUXVlcnkuZWFjaChbCgkidGFiSW5kZXgiLAoJInJlYWRPbmx5IiwKCSJtYXhMZW5ndGgiLAoJImNlbGxTcGFjaW5nIiwKCSJjZWxsUGFkZGluZyIsCgkicm93U3BhbiIsCgkiY29sU3BhbiIsCgkidXNlTWFwIiwKCSJmcmFtZUJvcmRlciIsCgkiY29udGVudEVkaXRhYmxlIgpdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS5wcm9wRml4WyB0aGlzLnRvTG93ZXJDYXNlKCkgXSA9IHRoaXM7Cn0pOwoKCgoKdmFyIHJjbGFzcyA9IC9bXHRcclxuXGZdL2c7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosIGZpbmFsVmFsdWUsCgkJCXByb2NlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlLAoJCQlpID0gMCwKCQkJbGVuID0gdGhpcy5sZW5ndGg7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5hZGRDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgdGhpcy5jbGFzc05hbWUgKSApOwoJCQl9KTsKCQl9CgoJCWlmICggcHJvY2VlZCApIHsKCQkJLy8gVGhlIGRpc2p1bmN0aW9uIGhlcmUgaXMgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSByZW1vdmVDbGFzcykKCQkJY2xhc3NlcyA9ICggdmFsdWUgfHwgIiIgKS5tYXRjaCggcm5vdHdoaXRlICkgfHwgW107CgoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWVsZW0gPSB0aGlzWyBpIF07CgkJCQljdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPwoJCQkJCSggIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIgKS5yZXBsYWNlKCByY2xhc3MsICIgIiApIDoKCQkJCQkiICIKCQkJCSk7CgoJCQkJaWYgKCBjdXIgKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgewoJCQkJCQlpZiAoIGN1ci5pbmRleE9mKCAiICIgKyBjbGF6eiArICIgIiApIDwgMCApIHsKCQkJCQkJCWN1ciArPSBjbGF6eiArICIgIjsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gb25seSBhc3NpZ24gaWYgZGlmZmVyZW50IHRvIGF2b2lkIHVubmVlZGVkIHJlbmRlcmluZy4KCQkJCQlmaW5hbFZhbHVlID0galF1ZXJ5LnRyaW0oIGN1ciApOwoJCQkJCWlmICggZWxlbS5jbGFzc05hbWUgIT09IGZpbmFsVmFsdWUgKSB7CgkJCQkJCWVsZW0uY2xhc3NOYW1lID0gZmluYWxWYWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVDbGFzczogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjbGFzc2VzLCBlbGVtLCBjdXIsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLAoJCQlwcm9jZWVkID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIHZhbHVlLAoJCQlpID0gMCwKCQkJbGVuID0gdGhpcy5sZW5ndGg7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5yZW1vdmVDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgdGhpcy5jbGFzc05hbWUgKSApOwoJCQl9KTsKCQl9CgkJaWYgKCBwcm9jZWVkICkgewoJCQljbGFzc2VzID0gKCB2YWx1ZSB8fCAiIiApLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXTsKCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJZWxlbSA9IHRoaXNbIGkgXTsKCQkJCS8vIFRoaXMgZXhwcmVzc2lvbiBpcyBoZXJlIGZvciBiZXR0ZXIgY29tcHJlc3NpYmlsaXR5IChzZWUgYWRkQ2xhc3MpCgkJCQljdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggZWxlbS5jbGFzc05hbWUgPwoJCQkJCSggIiAiICsgZWxlbS5jbGFzc05hbWUgKyAiICIgKS5yZXBsYWNlKCByY2xhc3MsICIgIiApIDoKCQkJCQkiIgoJCQkJKTsKCgkJCQlpZiAoIGN1ciApIHsKCQkJCQlqID0gMDsKCQkJCQl3aGlsZSAoIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgKSB7CgkJCQkJCS8vIFJlbW92ZSAqYWxsKiBpbnN0YW5jZXMKCQkJCQkJd2hpbGUgKCBjdXIuaW5kZXhPZiggIiAiICsgY2xhenogKyAiICIgKSA+PSAwICkgewoJCQkJCQkJY3VyID0gY3VyLnJlcGxhY2UoICIgIiArIGNsYXp6ICsgIiAiLCAiICIgKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJLy8gb25seSBhc3NpZ24gaWYgZGlmZmVyZW50IHRvIGF2b2lkIHVubmVlZGVkIHJlbmRlcmluZy4KCQkJCQlmaW5hbFZhbHVlID0gdmFsdWUgPyBqUXVlcnkudHJpbSggY3VyICkgOiAiIjsKCQkJCQlpZiAoIGVsZW0uY2xhc3NOYW1lICE9PSBmaW5hbFZhbHVlICkgewoJCQkJCQllbGVtLmNsYXNzTmFtZSA9IGZpbmFsVmFsdWU7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCWlmICggdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBzdGF0ZVZhbCA/IHRoaXMuYWRkQ2xhc3MoIHZhbHVlICkgOiB0aGlzLnJlbW92ZUNsYXNzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnRvZ2dsZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHRoaXMuY2xhc3NOYW1lLCBzdGF0ZVZhbCksIHN0YXRlVmFsICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiApIHsKCQkJCS8vIHRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzCgkJCQl2YXIgY2xhc3NOYW1lLAoJCQkJCWkgPSAwLAoJCQkJCXNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKCQkJCQljbGFzc05hbWVzID0gdmFsdWUubWF0Y2goIHJub3R3aGl0ZSApIHx8IFtdOwoKCQkJCXdoaWxlICggKGNsYXNzTmFtZSA9IGNsYXNzTmFtZXNbIGkrKyBdKSApIHsKCQkJCQkvLyBjaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKCQkJCQlpZiAoIHNlbGYuaGFzQ2xhc3MoIGNsYXNzTmFtZSApICkgewoJCQkJCQlzZWxmLnJlbW92ZUNsYXNzKCBjbGFzc05hbWUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZWxmLmFkZENsYXNzKCBjbGFzc05hbWUgKTsKCQkJCQl9CgkJCQl9CgoJCQkvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQoJCQl9IGVsc2UgaWYgKCB0eXBlID09PSBzdHJ1bmRlZmluZWQgfHwgdHlwZSA9PT0gImJvb2xlYW4iICkgewoJCQkJaWYgKCB0aGlzLmNsYXNzTmFtZSApIHsKCQkJCQkvLyBzdG9yZSBjbGFzc05hbWUgaWYgc2V0CgkJCQkJZGF0YV9wcml2LnNldCggdGhpcywgIl9fY2xhc3NOYW1lX18iLCB0aGlzLmNsYXNzTmFtZSApOwoJCQkJfQoKCQkJCS8vIElmIHRoZSBlbGVtZW50IGhhcyBhIGNsYXNzIG5hbWUgb3IgaWYgd2UncmUgcGFzc2VkICJmYWxzZSIsCgkJCQkvLyB0aGVuIHJlbW92ZSB0aGUgd2hvbGUgY2xhc3NuYW1lIChpZiB0aGVyZSB3YXMgb25lLCB0aGUgYWJvdmUgc2F2ZWQgaXQpLgoJCQkJLy8gT3RoZXJ3aXNlIGJyaW5nIGJhY2sgd2hhdGV2ZXIgd2FzIHByZXZpb3VzbHkgc2F2ZWQgKGlmIGFueXRoaW5nKSwKCQkJCS8vIGZhbGxpbmcgYmFjayB0byB0aGUgZW1wdHkgc3RyaW5nIGlmIG5vdGhpbmcgd2FzIHN0b3JlZC4KCQkJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUgfHwgdmFsdWUgPT09IGZhbHNlID8gIiIgOiBkYXRhX3ByaXYuZ2V0KCB0aGlzLCAiX19jbGFzc05hbWVfXyIgKSB8fCAiIjsKCQkJfQoJCX0pOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIiwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aDsKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWlmICggdGhpc1tpXS5ub2RlVHlwZSA9PT0gMSAmJiAoIiAiICsgdGhpc1tpXS5jbGFzc05hbWUgKyAiICIpLnJlcGxhY2UocmNsYXNzLCAiICIpLmluZGV4T2YoIGNsYXNzTmFtZSApID49IDAgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfQp9KTsKCgoKCnZhciBycmV0dXJuID0gL1xyL2c7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXZhbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBob29rcywgcmV0LCBpc0Z1bmN0aW9uLAoJCQllbGVtID0gdGhpc1swXTsKCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJaWYgKCBlbGVtICkgewoJCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIGVsZW0udHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCAidmFsdWUiICkpICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHJldDsKCQkJCX0KCgkJCQlyZXQgPSBlbGVtLnZhbHVlOwoKCQkJCXJldHVybiB0eXBlb2YgcmV0ID09PSAic3RyaW5nIiA/CgkJCQkJLy8gaGFuZGxlIG1vc3QgY29tbW9uIHN0cmluZyBjYXNlcwoJCQkJCXJldC5yZXBsYWNlKHJyZXR1cm4sICIiKSA6CgkJCQkJLy8gaGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyCgkJCQkJcmV0ID09IG51bGwgPyAiIiA6IHJldDsKCQkJfQoKCQkJcmV0dXJuOwoJCX0KCgkJaXNGdW5jdGlvbiA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQl2YXIgdmFsOwoKCQkJaWYgKCB0aGlzLm5vZGVUeXBlICE9PSAxICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGlzRnVuY3Rpb24gKSB7CgkJCQl2YWwgPSB2YWx1ZS5jYWxsKCB0aGlzLCBpLCBqUXVlcnkoIHRoaXMgKS52YWwoKSApOwoJCQl9IGVsc2UgewoJCQkJdmFsID0gdmFsdWU7CgkJCX0KCgkJCS8vIFRyZWF0IG51bGwvdW5kZWZpbmVkIGFzICIiOyBjb252ZXJ0IG51bWJlcnMgdG8gc3RyaW5nCgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSAiIjsKCgkJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICkgewoJCQkJdmFsICs9ICIiOwoKCQkJfSBlbHNlIGlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbCApICkgewoJCQkJdmFsID0galF1ZXJ5Lm1hcCggdmFsLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCQkJcmV0dXJuIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICsgIiI7CgkJCQl9KTsKCQkJfQoKCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQoIHRoaXMsIHZhbCwgInZhbHVlIiApID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLnZhbHVlID0gdmFsOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7Cgl2YWxIb29rczogewoJCW9wdGlvbjogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ2YWx1ZSIgKTsKCQkJCXJldHVybiB2YWwgIT0gbnVsbCA/CgkJCQkJdmFsIDoKCQkJCQkvLyBTdXBwb3J0OiBJRTEwLTExKwoJCQkJCS8vIG9wdGlvbi50ZXh0IHRocm93cyBleGNlcHRpb25zICgjMTQ2ODYsICMxNDg1OCkKCQkJCQlqUXVlcnkudHJpbSggalF1ZXJ5LnRleHQoIGVsZW0gKSApOwoJCQl9CgkJfSwKCQlzZWxlY3Q6IHsKCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXZhciB2YWx1ZSwgb3B0aW9uLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCgkJCQkJb25lID0gZWxlbS50eXBlID09PSAic2VsZWN0LW9uZSIgfHwgaW5kZXggPCAwLAoJCQkJCXZhbHVlcyA9IG9uZSA/IG51bGwgOiBbXSwKCQkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aCwKCQkJCQlpID0gaW5kZXggPCAwID8KCQkJCQkJbWF4IDoKCQkJCQkJb25lID8gaW5kZXggOiAwOwoKCQkJCS8vIExvb3AgdGhyb3VnaCBhbGwgdGhlIHNlbGVjdGVkIG9wdGlvbnMKCQkJCWZvciAoIDsgaSA8IG1heDsgaSsrICkgewoJCQkJCW9wdGlvbiA9IG9wdGlvbnNbIGkgXTsKCgkJCQkJLy8gSUU2LTkgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCgkJCQkJaWYgKCAoIG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCApICYmCgkJCQkJCQkvLyBEb24ndCByZXR1cm4gb3B0aW9ucyB0aGF0IGFyZSBkaXNhYmxlZCBvciBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCgkJCQkJCQkoIHN1cHBvcnQub3B0RGlzYWJsZWQgPyAhb3B0aW9uLmRpc2FibGVkIDogb3B0aW9uLmdldEF0dHJpYnV0ZSggImRpc2FibGVkIiApID09PSBudWxsICkgJiYKCQkJCQkJCSggIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFqUXVlcnkubm9kZU5hbWUoIG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiICkgKSApIHsKCgkJCQkJCS8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KCQkJCQkJdmFsdWUgPSBqUXVlcnkoIG9wdGlvbiApLnZhbCgpOwoKCQkJCQkJLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKCQkJCQkJaWYgKCBvbmUgKSB7CgkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCX0KCgkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CgkJCQkJCXZhbHVlcy5wdXNoKCB2YWx1ZSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9LAoKCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgb3B0aW9uU2V0LCBvcHRpb24sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQl2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KCB2YWx1ZSApLAoJCQkJCWkgPSBvcHRpb25zLmxlbmd0aDsKCgkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQlvcHRpb24gPSBvcHRpb25zWyBpIF07CgkJCQkJaWYgKCAob3B0aW9uLnNlbGVjdGVkID0galF1ZXJ5LmluQXJyYXkoIG9wdGlvbi52YWx1ZSwgdmFsdWVzICkgPj0gMCkgKSB7CgkJCQkJCW9wdGlvblNldCA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIGZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CgkJCQlpZiAoICFvcHRpb25TZXQgKSB7CgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CgkJCQl9CgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9CgkJfQoJfQp9KTsKCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCmpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gewoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQkJcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUgKSA+PSAwICk7CgkJCX0KCQl9Cgl9OwoJaWYgKCAhc3VwcG9ydC5jaGVja09uICkgewoJCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdLmdldCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBTdXBwb3J0OiBXZWJraXQKCQkJLy8gIiIgaXMgcmV0dXJuZWQgaW5zdGVhZCBvZiAib24iIGlmIGEgdmFsdWUgaXNuJ3Qgc3BlY2lmaWVkCgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOwoJCX07Cgl9Cn0pOwoKCgoKLy8gUmV0dXJuIGpRdWVyeSBmb3IgYXR0cmlidXRlcy1vbmx5IGluY2x1c2lvbgoKCmpRdWVyeS5lYWNoKCAoImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCBsb2FkIHJlc2l6ZSBzY3JvbGwgdW5sb2FkIGNsaWNrIGRibGNsaWNrICIgKwoJIm1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlICIgKwoJImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3IgY29udGV4dG1lbnUiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7CgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8KCQkJdGhpcy5vbiggbmFtZSwgbnVsbCwgZGF0YSwgZm4gKSA6CgkJCXRoaXMudHJpZ2dlciggbmFtZSApOwoJfTsKfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWhvdmVyOiBmdW5jdGlvbiggZm5PdmVyLCBmbk91dCApIHsKCQlyZXR1cm4gdGhpcy5tb3VzZWVudGVyKCBmbk92ZXIgKS5tb3VzZWxlYXZlKCBmbk91dCB8fCBmbk92ZXIgKTsKCX0sCgoJYmluZDogZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7Cgl9LAoJdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7Cgl9LAoKCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwoJfSwKCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgewoJCS8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHRoaXMub2ZmKCBzZWxlY3RvciwgIioqIiApIDogdGhpcy5vZmYoIHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbiApOwoJfQp9KTsKCgp2YXIgbm9uY2UgPSBqUXVlcnkubm93KCk7Cgp2YXIgcnF1ZXJ5ID0gKC9cPy8pOwoKCgovLyBTdXBwb3J0OiBBbmRyb2lkIDIuMwovLyBXb3JrYXJvdW5kIGZhaWx1cmUgdG8gc3RyaW5nLWNhc3QgbnVsbCBpbnB1dApqUXVlcnkucGFyc2VKU09OID0gZnVuY3Rpb24oIGRhdGEgKSB7CglyZXR1cm4gSlNPTi5wYXJzZSggZGF0YSArICIiICk7Cn07CgoKLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwpqUXVlcnkucGFyc2VYTUwgPSBmdW5jdGlvbiggZGF0YSApIHsKCXZhciB4bWwsIHRtcDsKCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIFN1cHBvcnQ6IElFOQoJdHJ5IHsKCQl0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJeG1sID0gdG1wLnBhcnNlRnJvbVN0cmluZyggZGF0YSwgInRleHQveG1sIiApOwoJfSBjYXRjaCAoIGUgKSB7CgkJeG1sID0gdW5kZWZpbmVkOwoJfQoKCWlmICggIXhtbCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CgkJalF1ZXJ5LmVycm9yKCAiSW52YWxpZCBYTUw6ICIgKyBkYXRhICk7Cgl9CglyZXR1cm4geG1sOwp9OwoKCnZhcgoJLy8gRG9jdW1lbnQgbG9jYXRpb24KCWFqYXhMb2NQYXJ0cywKCWFqYXhMb2NhdGlvbiwKCglyaGFzaCA9IC8jLiokLywKCXJ0cyA9IC8oWz8mXSlfPVteJl0qLywKCXJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopJC9tZywKCS8vICM3NjUzLCAjODEyNSwgIzgxNTI6IGxvY2FsIHByb3RvY29sIGRldGVjdGlvbgoJcmxvY2FsUHJvdG9jb2wgPSAvXig/OmFib3V0fGFwcHxhcHAtc3RvcmFnZXwuKy1leHRlbnNpb258ZmlsZXxyZXN8d2lkZ2V0KTokLywKCXJub0NvbnRlbnQgPSAvXig/OkdFVHxIRUFEKSQvLAoJcnByb3RvY29sID0gL15cL1wvLywKCXJ1cmwgPSAvXihbXHcuKy1dKzopKD86XC9cLyg/OlteXC8/I10qQHwpKFteXC8/IzpdKikoPzo6KFxkKyl8KXwpLywKCgkvKiBQcmVmaWx0ZXJzCgkgKiAxKSBUaGV5IGFyZSB1c2VmdWwgdG8gaW50cm9kdWNlIGN1c3RvbSBkYXRhVHlwZXMgKHNlZSBhamF4L2pzb25wLmpzIGZvciBhbiBleGFtcGxlKQoJICogMikgVGhlc2UgYXJlIGNhbGxlZDoKCSAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKCSAqICAgIC0gQUZURVIgcGFyYW0gc2VyaWFsaXphdGlvbiAocy5kYXRhIGlzIGEgc3RyaW5nIGlmIHMucHJvY2Vzc0RhdGEgaXMgdHJ1ZSkKCSAqIDMpIGtleSBpcyB0aGUgZGF0YVR5cGUKCSAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCgkgKiA1KSBleGVjdXRpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBjb250aW51ZSBkb3duIHRvICIqIiBpZiBuZWVkZWQKCSAqLwoJcHJlZmlsdGVycyA9IHt9LAoKCS8qIFRyYW5zcG9ydHMgYmluZGluZ3MKCSAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKCSAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCgkgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXRyYW5zcG9ydHMgPSB7fSwKCgkvLyBBdm9pZCBjb21tZW50LXByb2xvZyBjaGFyIHNlcXVlbmNlICgjMTAwOTgpOyBtdXN0IGFwcGVhc2UgbGludCBhbmQgZXZhZGUgY29tcHJlc3Npb24KCWFsbFR5cGVzID0gIiovIi5jb25jYXQoIioiKTsKCi8vICM4MTM4LCBJRSBtYXkgdGhyb3cgYW4gZXhjZXB0aW9uIHdoZW4gYWNjZXNzaW5nCi8vIGEgZmllbGQgZnJvbSB3aW5kb3cubG9jYXRpb24gaWYgZG9jdW1lbnQuZG9tYWluIGhhcyBiZWVuIHNldAp0cnkgewoJYWpheExvY2F0aW9uID0gbG9jYXRpb24uaHJlZjsKfSBjYXRjaCggZSApIHsKCS8vIFVzZSB0aGUgaHJlZiBhdHRyaWJ1dGUgb2YgYW4gQSBlbGVtZW50CgkvLyBzaW5jZSBJRSB3aWxsIG1vZGlmeSBpdCBnaXZlbiBkb2N1bWVudC5sb2NhdGlvbgoJYWpheExvY2F0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CglhamF4TG9jYXRpb24uaHJlZiA9ICIiOwoJYWpheExvY2F0aW9uID0gYWpheExvY2F0aW9uLmhyZWY7Cn0KCi8vIFNlZ21lbnQgbG9jYXRpb24gaW50byBwYXJ0cwphamF4TG9jUGFydHMgPSBydXJsLmV4ZWMoIGFqYXhMb2NhdGlvbi50b0xvd2VyQ2FzZSgpICkgfHwgW107CgovLyBCYXNlICJjb25zdHJ1Y3RvciIgZm9yIGpRdWVyeS5hamF4UHJlZmlsdGVyIGFuZCBqUXVlcnkuYWpheFRyYW5zcG9ydApmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSApIHsKCgkvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgoJcmV0dXJuIGZ1bmN0aW9uKCBkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMgKSB7CgoJCWlmICggdHlwZW9mIGRhdGFUeXBlRXhwcmVzc2lvbiAhPT0gInN0cmluZyIgKSB7CgkJCWZ1bmMgPSBkYXRhVHlwZUV4cHJlc3Npb247CgkJCWRhdGFUeXBlRXhwcmVzc2lvbiA9ICIqIjsKCQl9CgoJCXZhciBkYXRhVHlwZSwKCQkJaSA9IDAsCgkJCWRhdGFUeXBlcyA9IGRhdGFUeXBlRXhwcmVzc2lvbi50b0xvd2VyQ2FzZSgpLm1hdGNoKCBybm90d2hpdGUgKSB8fCBbXTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggZnVuYyApICkgewoJCQkvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uCgkJCXdoaWxlICggKGRhdGFUeXBlID0gZGF0YVR5cGVzW2krK10pICkgewoJCQkJLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQKCQkJCWlmICggZGF0YVR5cGVbMF0gPT09ICIrIiApIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKCAxICkgfHwgIioiOwoJCQkJCShzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnVuc2hpZnQoIGZ1bmMgKTsKCgkJCQkvLyBPdGhlcndpc2UgYXBwZW5kCgkJCQl9IGVsc2UgewoJCQkJCShzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10pLnB1c2goIGZ1bmMgKTsKCQkJCX0KCQkJfQoJCX0KCX07Cn0KCi8vIEJhc2UgaW5zcGVjdGlvbiBmdW5jdGlvbiBmb3IgcHJlZmlsdGVycyBhbmQgdHJhbnNwb3J0cwpmdW5jdGlvbiBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSICkgewoKCXZhciBpbnNwZWN0ZWQgPSB7fSwKCQlzZWVraW5nVHJhbnNwb3J0ID0gKCBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHMgKTsKCglmdW5jdGlvbiBpbnNwZWN0KCBkYXRhVHlwZSApIHsKCQl2YXIgc2VsZWN0ZWQ7CgkJaW5zcGVjdGVkWyBkYXRhVHlwZSBdID0gdHJ1ZTsKCQlqUXVlcnkuZWFjaCggc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdLCBmdW5jdGlvbiggXywgcHJlZmlsdGVyT3JGYWN0b3J5ICkgewoJCQl2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeSggb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApOwoJCQlpZiAoIHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAic3RyaW5nIiAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkWyBkYXRhVHlwZU9yVHJhbnNwb3J0IF0gKSB7CgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7CgkJCQlyZXR1cm4gISggc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gc2VsZWN0ZWQ7Cgl9CgoJcmV0dXJuIGluc3BlY3QoIG9wdGlvbnMuZGF0YVR5cGVzWyAwIF0gKSB8fCAhaW5zcGVjdGVkWyAiKiIgXSAmJiBpbnNwZWN0KCAiKiIgKTsKfQoKLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQovLyBGaXhlcyAjOTg4NwpmdW5jdGlvbiBhamF4RXh0ZW5kKCB0YXJnZXQsIHNyYyApIHsKCXZhciBrZXksIGRlZXAsCgkJZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwoKCWZvciAoIGtleSBpbiBzcmMgKSB7CgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCSggZmxhdE9wdGlvbnNbIGtleSBdID8gdGFyZ2V0IDogKCBkZWVwIHx8IChkZWVwID0ge30pICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwoJCX0KCX0KCWlmICggZGVlcCApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0cnVlLCB0YXJnZXQsIGRlZXAgKTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgovKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogKi8KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsKCgl2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLAoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzOwoKCS8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzCgl3aGlsZSAoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwoJCX0KCX0KCgkvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKCWlmICggY3QgKSB7CgkJZm9yICggdHlwZSBpbiBjb250ZW50cyApIHsKCQkJaWYgKCBjb250ZW50c1sgdHlwZSBdICYmIGNvbnRlbnRzWyB0eXBlIF0udGVzdCggY3QgKSApIHsKCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0eXBlICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCgkvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUKCWlmICggZGF0YVR5cGVzWyAwIF0gaW4gcmVzcG9uc2VzICkgewoJCWZpbmFsRGF0YVR5cGUgPSBkYXRhVHlwZXNbIDAgXTsKCX0gZWxzZSB7CgkJLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsKCQkJCWZpbmFsRGF0YVR5cGUgPSB0eXBlOwoJCQkJYnJlYWs7CgkJCX0KCQkJaWYgKCAhZmlyc3REYXRhVHlwZSApIHsKCQkJCWZpcnN0RGF0YVR5cGUgPSB0eXBlOwoJCQl9CgkJfQoJCS8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7Cgl9CgoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKCS8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKCWlmICggZmluYWxEYXRhVHlwZSApIHsKCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgewoJCQlkYXRhVHlwZXMudW5zaGlmdCggZmluYWxEYXRhVHlwZSApOwoJCX0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07Cgl9Cn0KCi8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAqLwpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKSB7Cgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwKCQljb252ZXJ0ZXJzID0ge30sCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCk7CgoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgewoJCWZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwoJCX0KCX0KCgljdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgoJLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUKCXdoaWxlICggY3VycmVudCApIHsKCgkJaWYgKCBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gKSB7CgkJCWpxWEhSWyBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gXSA9IHJlc3BvbnNlOwoJCX0KCgkJLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKCQlpZiAoICFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIgKSB7CgkJCXJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOwoJCX0KCgkJcHJldiA9IGN1cnJlbnQ7CgkJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKCQlpZiAoIGN1cnJlbnQgKSB7CgoJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8KCQkJaWYgKCBjdXJyZW50ID09PSAiKiIgKSB7CgoJCQkJY3VycmVudCA9IHByZXY7CgoJCQkvLyBDb252ZXJ0IHJlc3BvbnNlIGlmIHByZXYgZGF0YVR5cGUgaXMgbm9uLWF1dG8gYW5kIGRpZmZlcnMgZnJvbSBjdXJyZW50CgkJCX0gZWxzZSBpZiAoIHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50ICkgewoKCQkJCS8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCgkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKCQkJCS8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCgkJCQlpZiAoICFjb252ICkgewoJCQkJCWZvciAoIGNvbnYyIGluIGNvbnZlcnRlcnMgKSB7CgoJCQkJCQkvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKCQkJCQkJdG1wID0gY29udjIuc3BsaXQoICIgIiApOwoJCQkJCQlpZiAoIHRtcFsgMSBdID09PSBjdXJyZW50ICkgewoKCQkJCQkJCS8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAoJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyB0bXBbIDAgXSBdIHx8CgkJCQkJCQkJY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07CgkJCQkJCQlpZiAoIGNvbnYgKSB7CgkJCQkJCQkJLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwoJCQkJCQkJCWlmICggY29udiA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07CgoJCQkJCQkJCS8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewoJCQkJCQkJCQljdXJyZW50ID0gdG1wWyAwIF07CgkJCQkJCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0bXBbIDEgXSApOwoJCQkJCQkJCX0KCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzWyAidGhyb3dzIiBdICkgewoJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJlc3BvbnNlID0gY29udiggcmVzcG9uc2UgKTsKCQkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCQlyZXR1cm4geyBzdGF0ZTogInBhcnNlcmVycm9yIiwgZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQgfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9CgpqUXVlcnkuZXh0ZW5kKHsKCgkvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKCWFjdGl2ZTogMCwKCgkvLyBMYXN0LU1vZGlmaWVkIGhlYWRlciBjYWNoZSBmb3IgbmV4dCByZXF1ZXN0CglsYXN0TW9kaWZpZWQ6IHt9LAoJZXRhZzoge30sCgoJYWpheFNldHRpbmdzOiB7CgkJdXJsOiBhamF4TG9jYXRpb24sCgkJdHlwZTogIkdFVCIsCgkJaXNMb2NhbDogcmxvY2FsUHJvdG9jb2wudGVzdCggYWpheExvY1BhcnRzWyAxIF0gKSwKCQlnbG9iYWw6IHRydWUsCgkJcHJvY2Vzc0RhdGE6IHRydWUsCgkJYXN5bmM6IHRydWUsCgkJY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLAoJCS8qCgkJdGltZW91dDogMCwKCQlkYXRhOiBudWxsLAoJCWRhdGFUeXBlOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWNhY2hlOiBudWxsLAoJCXRocm93czogZmFsc2UsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCWhlYWRlcnM6IHt9LAoJCSovCgoJCWFjY2VwdHM6IHsKCQkJIioiOiBhbGxUeXBlcywKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlodG1sOiAidGV4dC9odG1sIiwKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiCgkJfSwKCgkJY29udGVudHM6IHsKCQkJeG1sOiAveG1sLywKCQkJaHRtbDogL2h0bWwvLAoJCQlqc29uOiAvanNvbi8KCQl9LAoKCQlyZXNwb25zZUZpZWxkczogewoJCQl4bWw6ICJyZXNwb25zZVhNTCIsCgkJCXRleHQ6ICJyZXNwb25zZVRleHQiLAoJCQlqc29uOiAicmVzcG9uc2VKU09OIgoJCX0sCgoJCS8vIERhdGEgY29udmVydGVycwoJCS8vIEtleXMgc2VwYXJhdGUgc291cmNlIChvciBjYXRjaGFsbCAiKiIpIGFuZCBkZXN0aW5hdGlvbiB0eXBlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCgkJY29udmVydGVyczogewoKCQkJLy8gQ29udmVydCBhbnl0aGluZyB0byB0ZXh0CgkJCSIqIHRleHQiOiBTdHJpbmcsCgoJCQkvLyBUZXh0IHRvIGh0bWwgKHRydWUgPSBubyB0cmFuc2Zvcm1hdGlvbikKCQkJInRleHQgaHRtbCI6IHRydWUsCgoJCQkvLyBFdmFsdWF0ZSB0ZXh0IGFzIGEganNvbiBleHByZXNzaW9uCgkJCSJ0ZXh0IGpzb24iOiBqUXVlcnkucGFyc2VKU09OLAoKCQkJLy8gUGFyc2UgdGV4dCBhcyB4bWwKCQkJInRleHQgeG1sIjogalF1ZXJ5LnBhcnNlWE1MCgkJfSwKCgkJLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKCQkvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCgkJLy8gYW5kIHdoZW4geW91IGNyZWF0ZSBvbmUgdGhhdCBzaG91bGRuJ3QgYmUKCQkvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKCQlmbGF0T3B0aW9uczogewoJCQl1cmw6IHRydWUsCgkJCWNvbnRleHQ6IHRydWUKCQl9Cgl9LAoKCS8vIENyZWF0ZXMgYSBmdWxsIGZsZWRnZWQgc2V0dGluZ3Mgb2JqZWN0IGludG8gdGFyZ2V0CgkvLyB3aXRoIGJvdGggYWpheFNldHRpbmdzIGFuZCBzZXR0aW5ncyBmaWVsZHMuCgkvLyBJZiB0YXJnZXQgaXMgb21pdHRlZCwgd3JpdGVzIGludG8gYWpheFNldHRpbmdzLgoJYWpheFNldHVwOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsKCQlyZXR1cm4gc2V0dGluZ3MgPwoKCQkJLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKCQkJYWpheEV4dGVuZCggYWpheEV4dGVuZCggdGFyZ2V0LCBqUXVlcnkuYWpheFNldHRpbmdzICksIHNldHRpbmdzICkgOgoKCQkJLy8gRXh0ZW5kaW5nIGFqYXhTZXR0aW5ncwoJCQlhamF4RXh0ZW5kKCBqUXVlcnkuYWpheFNldHRpbmdzLCB0YXJnZXQgKTsKCX0sCgoJYWpheFByZWZpbHRlcjogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzICksCglhamF4VHJhbnNwb3J0OiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHRyYW5zcG9ydHMgKSwKCgkvLyBNYWluIG1ldGhvZAoJYWpheDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCgkJLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKCQlpZiAoIHR5cGVvZiB1cmwgPT09ICJvYmplY3QiICkgewoJCQlvcHRpb25zID0gdXJsOwoJCQl1cmwgPSB1bmRlZmluZWQ7CgkJfQoKCQkvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCQl2YXIgdHJhbnNwb3J0LAoJCQkvLyBVUkwgd2l0aG91dCBhbnRpLWNhY2hlIHBhcmFtCgkJCWNhY2hlVVJMLAoJCQkvLyBSZXNwb25zZSBoZWFkZXJzCgkJCXJlc3BvbnNlSGVhZGVyc1N0cmluZywKCQkJcmVzcG9uc2VIZWFkZXJzLAoJCQkvLyB0aW1lb3V0IGhhbmRsZQoJCQl0aW1lb3V0VGltZXIsCgkJCS8vIENyb3NzLWRvbWFpbiBkZXRlY3Rpb24gdmFycwoJCQlwYXJ0cywKCQkJLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCgkJCWZpcmVHbG9iYWxzLAoJCQkvLyBMb29wIHZhcmlhYmxlCgkJCWksCgkJCS8vIENyZWF0ZSB0aGUgZmluYWwgb3B0aW9ucyBvYmplY3QKCQkJcyA9IGpRdWVyeS5hamF4U2V0dXAoIHt9LCBvcHRpb25zICksCgkJCS8vIENhbGxiYWNrcyBjb250ZXh0CgkJCWNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAoJCQkvLyBDb250ZXh0IGZvciBnbG9iYWwgZXZlbnRzIGlzIGNhbGxiYWNrQ29udGV4dCBpZiBpdCBpcyBhIERPTSBub2RlIG9yIGpRdWVyeSBjb2xsZWN0aW9uCgkJCWdsb2JhbEV2ZW50Q29udGV4dCA9IHMuY29udGV4dCAmJiAoIGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQuanF1ZXJ5ICkgPwoJCQkJalF1ZXJ5KCBjYWxsYmFja0NvbnRleHQgKSA6CgkJCQlqUXVlcnkuZXZlbnQsCgkJCS8vIERlZmVycmVkcwoJCQlkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQljb21wbGV0ZURlZmVycmVkID0galF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJc3RhdHVzQ29kZSA9IHMuc3RhdHVzQ29kZSB8fCB7fSwKCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKCQkJcmVxdWVzdEhlYWRlcnMgPSB7fSwKCQkJcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAoJCQkvLyBUaGUganFYSFIgc3RhdGUKCQkJc3RhdGUgPSAwLAoJCQkvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKCQkJc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAoJCQkvLyBGYWtlIHhocgoJCQlqcVhIUiA9IHsKCQkJCXJlYWR5U3RhdGU6IDAsCgoJCQkJLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAoJCQkJZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uKCBrZXkgKSB7CgkJCQkJdmFyIG1hdGNoOwoJCQkJCWlmICggc3RhdGUgPT09IDIgKSB7CgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsKCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHt9OwoJCQkJCQkJd2hpbGUgKCAobWF0Y2ggPSByaGVhZGVycy5leGVjKCByZXNwb25zZUhlYWRlcnNTdHJpbmcgKSkgKSB7CgkJCQkJCQkJcmVzcG9uc2VIZWFkZXJzWyBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpIF0gPSBtYXRjaFsgMiBdOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCW1hdGNoID0gcmVzcG9uc2VIZWFkZXJzWyBrZXkudG9Mb3dlckNhc2UoKSBdOwoJCQkJCX0KCQkJCQlyZXR1cm4gbWF0Y2ggPT0gbnVsbCA/IG51bGwgOiBtYXRjaDsKCQkJCX0sCgoJCQkJLy8gUmF3IHN0cmluZwoJCQkJZ2V0QWxsUmVzcG9uc2VIZWFkZXJzOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gc3RhdGUgPT09IDIgPyByZXNwb25zZUhlYWRlcnNTdHJpbmcgOiBudWxsOwoJCQkJfSwKCgkJCQkvLyBDYWNoZXMgdGhlIGhlYWRlcgoJCQkJc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCQkJCXZhciBsbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQkJCQlpZiAoICFzdGF0ZSApIHsKCQkJCQkJbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gPSByZXF1ZXN0SGVhZGVyc05hbWVzWyBsbmFtZSBdIHx8IG5hbWU7CgkJCQkJCXJlcXVlc3RIZWFkZXJzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCgkJCQlvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlpZiAoICFzdGF0ZSApIHsKCQkJCQkJcy5taW1lVHlwZSA9IHR5cGU7CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQkJc3RhdHVzQ29kZTogZnVuY3Rpb24oIG1hcCApIHsKCQkJCQl2YXIgY29kZTsKCQkJCQlpZiAoIG1hcCApIHsKCQkJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJCQlmb3IgKCBjb2RlIGluIG1hcCApIHsKCQkJCQkJCQkvLyBMYXp5LWFkZCB0aGUgbmV3IGNhbGxiYWNrIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCgkJCQkJCQkJc3RhdHVzQ29kZVsgY29kZSBdID0gWyBzdGF0dXNDb2RlWyBjb2RlIF0sIG1hcFsgY29kZSBdIF07CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBFeGVjdXRlIHRoZSBhcHByb3ByaWF0ZSBjYWxsYmFja3MKCQkJCQkJCWpxWEhSLmFsd2F5cyggbWFwWyBqcVhIUi5zdGF0dXMgXSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCgkJCQkvLyBDYW5jZWwgdGhlIHJlcXVlc3QKCQkJCWFib3J0OiBmdW5jdGlvbiggc3RhdHVzVGV4dCApIHsKCQkJCQl2YXIgZmluYWxUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKCQkJCQlpZiAoIHRyYW5zcG9ydCApIHsKCQkJCQkJdHJhbnNwb3J0LmFib3J0KCBmaW5hbFRleHQgKTsKCQkJCQl9CgkJCQkJZG9uZSggMCwgZmluYWxUZXh0ICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgkJCX07CgoJCS8vIEF0dGFjaCBkZWZlcnJlZHMKCQlkZWZlcnJlZC5wcm9taXNlKCBqcVhIUiApLmNvbXBsZXRlID0gY29tcGxldGVEZWZlcnJlZC5hZGQ7CgkJanFYSFIuc3VjY2VzcyA9IGpxWEhSLmRvbmU7CgkJanFYSFIuZXJyb3IgPSBqcVhIUi5mYWlsOwoKCQkvLyBSZW1vdmUgaGFzaCBjaGFyYWN0ZXIgKCM3NTMxOiBhbmQgc3RyaW5nIHByb21vdGlvbikKCQkvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkIChwcmVmaWx0ZXJzIG1pZ2h0IGV4cGVjdCBpdCkKCQkvLyBIYW5kbGUgZmFsc3kgdXJsIGluIHRoZSBzZXR0aW5ncyBvYmplY3QgKCMxMDA5MzogY29uc2lzdGVuY3kgd2l0aCBvbGQgc2lnbmF0dXJlKQoJCS8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQoJCXMudXJsID0gKCAoIHVybCB8fCBzLnVybCB8fCBhamF4TG9jYXRpb24gKSArICIiICkucmVwbGFjZSggcmhhc2gsICIiICkKCQkJLnJlcGxhY2UoIHJwcm90b2NvbCwgYWpheExvY1BhcnRzWyAxIF0gKyAiLy8iICk7CgoJCS8vIEFsaWFzIG1ldGhvZCBvcHRpb24gdG8gdHlwZSBhcyBwZXIgdGlja2V0ICMxMjAwNAoJCXMudHlwZSA9IG9wdGlvbnMubWV0aG9kIHx8IG9wdGlvbnMudHlwZSB8fCBzLm1ldGhvZCB8fCBzLnR5cGU7CgoJCS8vIEV4dHJhY3QgZGF0YVR5cGVzIGxpc3QKCQlzLmRhdGFUeXBlcyA9IGpRdWVyeS50cmltKCBzLmRhdGFUeXBlIHx8ICIqIiApLnRvTG93ZXJDYXNlKCkubWF0Y2goIHJub3R3aGl0ZSApIHx8IFsgIiIgXTsKCgkJLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHdlIGhhdmUgYSBwcm90b2NvbDpob3N0OnBvcnQgbWlzbWF0Y2gKCQlpZiAoIHMuY3Jvc3NEb21haW4gPT0gbnVsbCApIHsKCQkJcGFydHMgPSBydXJsLmV4ZWMoIHMudXJsLnRvTG93ZXJDYXNlKCkgKTsKCQkJcy5jcm9zc0RvbWFpbiA9ICEhKCBwYXJ0cyAmJgoJCQkJKCBwYXJ0c1sgMSBdICE9PSBhamF4TG9jUGFydHNbIDEgXSB8fCBwYXJ0c1sgMiBdICE9PSBhamF4TG9jUGFydHNbIDIgXSB8fAoJCQkJCSggcGFydHNbIDMgXSB8fCAoIHBhcnRzWyAxIF0gPT09ICJodHRwOiIgPyAiODAiIDogIjQ0MyIgKSApICE9PQoJCQkJCQkoIGFqYXhMb2NQYXJ0c1sgMyBdIHx8ICggYWpheExvY1BhcnRzWyAxIF0gPT09ICJodHRwOiIgPyAiODAiIDogIjQ0MyIgKSApICkKCQkJKTsKCQl9CgoJCS8vIENvbnZlcnQgZGF0YSBpZiBub3QgYWxyZWFkeSBhIHN0cmluZwoJCWlmICggcy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgdHlwZW9mIHMuZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJCXMuZGF0YSA9IGpRdWVyeS5wYXJhbSggcy5kYXRhLCBzLnRyYWRpdGlvbmFsICk7CgkJfQoKCQkvLyBBcHBseSBwcmVmaWx0ZXJzCgkJaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSICk7CgoJCS8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCgkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJcmV0dXJuIGpxWEhSOwoJCX0KCgkJLy8gV2UgY2FuIGZpcmUgZ2xvYmFsIGV2ZW50cyBhcyBvZiBub3cgaWYgYXNrZWQgdG8KCQlmaXJlR2xvYmFscyA9IHMuZ2xvYmFsOwoKCQkvLyBXYXRjaCBmb3IgYSBuZXcgc2V0IG9mIHJlcXVlc3RzCgkJaWYgKCBmaXJlR2xvYmFscyAmJiBqUXVlcnkuYWN0aXZlKysgPT09IDAgKSB7CgkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RhcnQiKTsKCQl9CgoJCS8vIFVwcGVyY2FzZSB0aGUgdHlwZQoJCXMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKCQkvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAoJCXMuaGFzQ29udGVudCA9ICFybm9Db250ZW50LnRlc3QoIHMudHlwZSApOwoKCQkvLyBTYXZlIHRoZSBVUkwgaW4gY2FzZSB3ZSdyZSB0b3lpbmcgd2l0aCB0aGUgSWYtTW9kaWZpZWQtU2luY2UKCQkvLyBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIgbGF0ZXIgb24KCQljYWNoZVVSTCA9IHMudXJsOwoKCQkvLyBNb3JlIG9wdGlvbnMgaGFuZGxpbmcgZm9yIHJlcXVlc3RzIHdpdGggbm8gY29udGVudAoJCWlmICggIXMuaGFzQ29udGVudCApIHsKCgkJCS8vIElmIGRhdGEgaXMgYXZhaWxhYmxlLCBhcHBlbmQgZGF0YSB0byB1cmwKCQkJaWYgKCBzLmRhdGEgKSB7CgkJCQljYWNoZVVSTCA9ICggcy51cmwgKz0gKCBycXVlcnkudGVzdCggY2FjaGVVUkwgKSA/ICImIiA6ICI/IiApICsgcy5kYXRhICk7CgkJCQkvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CgkJCQlkZWxldGUgcy5kYXRhOwoJCQl9CgoJCQkvLyBBZGQgYW50aS1jYWNoZSBpbiB1cmwgaWYgbmVlZGVkCgkJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7CgkJCQlzLnVybCA9IHJ0cy50ZXN0KCBjYWNoZVVSTCApID8KCgkJCQkJLy8gSWYgdGhlcmUgaXMgYWxyZWFkeSBhICdfJyBwYXJhbWV0ZXIsIHNldCBpdHMgdmFsdWUKCQkJCQljYWNoZVVSTC5yZXBsYWNlKCBydHMsICIkMV89IiArIG5vbmNlKysgKSA6CgoJCQkJCS8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKCQkJCQljYWNoZVVSTCArICggcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArICJfPSIgKyBub25jZSsrOwoJCQl9CgkJfQoKCQkvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgoJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQlpZiAoIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICk7CgkJCX0KCQkJaWYgKCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApIHsKCQkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJJZi1Ob25lLU1hdGNoIiwgalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CgkJaWYgKCBzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlICk7CgkJfQoKCQkvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCgkJanFYSFIuc2V0UmVxdWVzdEhlYWRlcigKCQkJIkFjY2VwdCIsCgkJCXMuZGF0YVR5cGVzWyAwIF0gJiYgcy5hY2NlcHRzWyBzLmRhdGFUeXBlc1swXSBdID8KCQkJCXMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSArICggcy5kYXRhVHlwZXNbIDAgXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiICkgOgoJCQkJcy5hY2NlcHRzWyAiKiIgXQoJCSk7CgoJCS8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgoJCWZvciAoIGkgaW4gcy5oZWFkZXJzICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCBpLCBzLmhlYWRlcnNbIGkgXSApOwoJCX0KCgkJLy8gQWxsb3cgY3VzdG9tIGhlYWRlcnMvbWltZXR5cGVzIGFuZCBlYXJseSBhYm9ydAoJCWlmICggcy5iZWZvcmVTZW5kICYmICggcy5iZWZvcmVTZW5kLmNhbGwoIGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMgKSA9PT0gZmFsc2UgfHwgc3RhdGUgPT09IDIgKSApIHsKCQkJLy8gQWJvcnQgaWYgbm90IGRvbmUgYWxyZWFkeSBhbmQgcmV0dXJuCgkJCXJldHVybiBqcVhIUi5hYm9ydCgpOwoJCX0KCgkJLy8gYWJvcnRpbmcgaXMgbm8gbG9uZ2VyIGEgY2FuY2VsbGF0aW9uCgkJc3RyQWJvcnQgPSAiYWJvcnQiOwoKCQkvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKCQlmb3IgKCBpIGluIHsgc3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxIH0gKSB7CgkJCWpxWEhSWyBpIF0oIHNbIGkgXSApOwoJCX0KCgkJLy8gR2V0IHRyYW5zcG9ydAoJCXRyYW5zcG9ydCA9IGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUiApOwoKCQkvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKCQlpZiAoICF0cmFuc3BvcnQgKSB7CgkJCWRvbmUoIC0xLCAiTm8gVHJhbnNwb3J0IiApOwoJCX0gZWxzZSB7CgkJCWpxWEhSLnJlYWR5U3RhdGUgPSAxOwoKCQkJLy8gU2VuZCBnbG9iYWwgZXZlbnQKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheFNlbmQiLCBbIGpxWEhSLCBzIF0gKTsKCQkJfQoJCQkvLyBUaW1lb3V0CgkJCWlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgewoJCQkJdGltZW91dFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQlqcVhIUi5hYm9ydCgidGltZW91dCIpOwoJCQkJfSwgcy50aW1lb3V0ICk7CgkJCX0KCgkJCXRyeSB7CgkJCQlzdGF0ZSA9IDE7CgkJCQl0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkvLyBQcm9wYWdhdGUgZXhjZXB0aW9uIGFzIGVycm9yIGlmIG5vdCBkb25lCgkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQlkb25lKCAtMSwgZSApOwoJCQkJLy8gU2ltcGx5IHJldGhyb3cgb3RoZXJ3aXNlCgkJCQl9IGVsc2UgewoJCQkJCXRocm93IGU7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQoJCWZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgewoJCQl2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLAoJCQkJc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CgoJCQkvLyBDYWxsZWQgb25jZQoJCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTdGF0ZSBpcyAiZG9uZSIgbm93CgkJCXN0YXRlID0gMjsKCgkJCS8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCgkJCWlmICggdGltZW91dFRpbWVyICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0VGltZXIgKTsKCQkJfQoKCQkJLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KCQkJLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKCQkJdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKCQkJLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKCQkJLy8gU2V0IHJlYWR5U3RhdGUKCQkJanFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCgkJCS8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsCgkJCWlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwoKCQkJLy8gR2V0IHJlc3BvbnNlIGRhdGEKCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQlyZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKTsKCQkJfQoKCQkJLy8gQ29udmVydCBubyBtYXR0ZXIgd2hhdCAodGhhdCB3YXkgcmVzcG9uc2VYWFggZmllbGRzIGFyZSBhbHdheXMgc2V0KQoJCQlyZXNwb25zZSA9IGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcyApOwoKCQkJLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7CgoJCQkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQkJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkxhc3QtTW9kaWZpZWQiKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdID0gbW9kaWZpZWQ7CgkJCQkJfQoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoImV0YWciKTsKCQkJCQlpZiAoIG1vZGlmaWVkICkgewoJCQkJCQlqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBpZiBubyBjb250ZW50CgkJCQlpZiAoIHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gIkhFQUQiICkgewoJCQkJCXN0YXR1c1RleHQgPSAibm9jb250ZW50IjsKCgkJCQkvLyBpZiBub3QgbW9kaWZpZWQKCQkJCX0gZWxzZSBpZiAoIHN0YXR1cyA9PT0gMzA0ICkgewoJCQkJCXN0YXR1c1RleHQgPSAibm90bW9kaWZpZWQiOwoKCQkJCS8vIElmIHdlIGhhdmUgZGF0YSwgbGV0J3MgY29udmVydCBpdAoJCQkJfSBlbHNlIHsKCQkJCQlzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7CgkJCQkJc3VjY2VzcyA9IHJlc3BvbnNlLmRhdGE7CgkJCQkJZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKCQkJCQlpc1N1Y2Nlc3MgPSAhZXJyb3I7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQkvLyBXZSBleHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dAoJCQkJLy8gdGhlbiBub3JtYWxpemUgc3RhdHVzVGV4dCBhbmQgc3RhdHVzIGZvciBub24tYWJvcnRzCgkJCQllcnJvciA9IHN0YXR1c1RleHQ7CgkJCQlpZiAoIHN0YXR1cyB8fCAhc3RhdHVzVGV4dCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gImVycm9yIjsKCQkJCQlpZiAoIHN0YXR1cyA8IDAgKSB7CgkJCQkJCXN0YXR1cyA9IDA7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBTZXQgZGF0YSBmb3IgdGhlIGZha2UgeGhyIG9iamVjdAoJCQlqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CgkJCWpxWEhSLnN0YXR1c1RleHQgPSAoIG5hdGl2ZVN0YXR1c1RleHQgfHwgc3RhdHVzVGV4dCApICsgIiI7CgoJCQkvLyBTdWNjZXNzL0Vycm9yCgkJCWlmICggaXNTdWNjZXNzICkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUiBdICk7CgkJCX0gZWxzZSB7CgkJCQlkZWZlcnJlZC5yZWplY3RXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQsIGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKCQkJanFYSFIuc3RhdHVzQ29kZSggc3RhdHVzQ29kZSApOwoJCQlzdGF0dXNDb2RlID0gdW5kZWZpbmVkOwoKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCBpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsCgkJCQkJWyBqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yIF0gKTsKCQkJfQoKCQkJLy8gQ29tcGxldGUKCQkJY29tcGxldGVEZWZlcnJlZC5maXJlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0IF0gKTsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhDb21wbGV0ZSIsIFsganFYSFIsIHMgXSApOwoJCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCQlpZiAoICEoIC0talF1ZXJ5LmFjdGl2ZSApICkgewoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RvcCIpOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4ganFYSFI7Cgl9LAoKCWdldEpTT046IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIgKTsKCX0sCgoJZ2V0U2NyaXB0OiBmdW5jdGlvbiggdXJsLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAic2NyaXB0IiApOwoJfQp9KTsKCmpRdWVyeS5lYWNoKCBbICJnZXQiLCAicG9zdCIgXSwgZnVuY3Rpb24oIGksIG1ldGhvZCApIHsKCWpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCQkvLyBzaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZAoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGRhdGEgKSApIHsKCQkJdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWpheCh7CgkJCXVybDogdXJsLAoJCQl0eXBlOiBtZXRob2QsCgkJCWRhdGFUeXBlOiB0eXBlLAoJCQlkYXRhOiBkYXRhLAoJCQlzdWNjZXNzOiBjYWxsYmFjawoJCX0pOwoJfTsKfSk7CgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggWyAiYWpheFN0YXJ0IiwgImFqYXhTdG9wIiwgImFqYXhDb21wbGV0ZSIsICJhamF4RXJyb3IiLCAiYWpheFN1Y2Nlc3MiLCAiYWpheFNlbmQiIF0sIGZ1bmN0aW9uKCBpLCB0eXBlICkgewoJalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGUsIGZuICk7Cgl9Owp9KTsKCgpqUXVlcnkuX2V2YWxVcmwgPSBmdW5jdGlvbiggdXJsICkgewoJcmV0dXJuIGpRdWVyeS5hamF4KHsKCQl1cmw6IHVybCwKCQl0eXBlOiAiR0VUIiwKCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJYXN5bmM6IGZhbHNlLAoJCWdsb2JhbDogZmFsc2UsCgkJInRocm93cyI6IHRydWUKCX0pOwp9OwoKCmpRdWVyeS5mbi5leHRlbmQoewoJd3JhcEFsbDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJdmFyIHdyYXA7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeSggdGhpcyApLndyYXBBbGwoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCWlmICggdGhpc1sgMCBdICkgewoKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJd3JhcCA9IGpRdWVyeSggaHRtbCwgdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgKS5lcSggMCApLmNsb25lKCB0cnVlICk7CgoJCQlpZiAoIHRoaXNbIDAgXS5wYXJlbnROb2RlICkgewoJCQkJd3JhcC5pbnNlcnRCZWZvcmUoIHRoaXNbIDAgXSApOwoJCQl9CgoJCQl3cmFwLm1hcChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gdGhpczsKCgkJCQl3aGlsZSAoIGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQgKSB7CgkJCQkJZWxlbSA9IGVsZW0uZmlyc3RFbGVtZW50Q2hpbGQ7CgkJCQl9CgoJCQkJcmV0dXJuIGVsZW07CgkJCX0pLmFwcGVuZCggdGhpcyApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXdyYXBJbm5lcjogZnVuY3Rpb24oIGh0bWwgKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5KCB0aGlzICkud3JhcElubmVyKCBodG1sLmNhbGwodGhpcywgaSkgKTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CgoJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCApIHsKCQkJCWNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCgkJCX0gZWxzZSB7CgkJCQlzZWxmLmFwcGVuZCggaHRtbCApOwoJCQl9CgkJfSk7Cgl9LAoKCXdyYXA6IGZ1bmN0aW9uKCBodG1sICkgewoJCXZhciBpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIGh0bWwgKTsKCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJalF1ZXJ5KCB0aGlzICkud3JhcEFsbCggaXNGdW5jdGlvbiA/IGh0bWwuY2FsbCh0aGlzLCBpKSA6IGh0bWwgKTsKCQl9KTsKCX0sCgoJdW53cmFwOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJib2R5IiApICkgewoJCQkJalF1ZXJ5KCB0aGlzICkucmVwbGFjZVdpdGgoIHRoaXMuY2hpbGROb2RlcyApOwoJCQl9CgkJfSkuZW5kKCk7Cgl9Cn0pOwoKCmpRdWVyeS5leHByLmZpbHRlcnMuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkvLyBTdXBwb3J0OiBPcGVyYSA8PSAxMi4xMgoJLy8gT3BlcmEgcmVwb3J0cyBvZmZzZXRXaWR0aHMgYW5kIG9mZnNldEhlaWdodHMgbGVzcyB0aGFuIHplcm8gb24gc29tZSBlbGVtZW50cwoJcmV0dXJuIGVsZW0ub2Zmc2V0V2lkdGggPD0gMCAmJiBlbGVtLm9mZnNldEhlaWdodCA8PSAwOwp9OwpqUXVlcnkuZXhwci5maWx0ZXJzLnZpc2libGUgPSBmdW5jdGlvbiggZWxlbSApIHsKCXJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oIGVsZW0gKTsKfTsKCgoKCnZhciByMjAgPSAvJTIwL2csCglyYnJhY2tldCA9IC9cW1xdJC8sCglyQ1JMRiA9IC9ccj9cbi9nLAoJcnN1Ym1pdHRlclR5cGVzID0gL14oPzpzdWJtaXR8YnV0dG9ufGltYWdlfHJlc2V0fGZpbGUpJC9pLAoJcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwoKZnVuY3Rpb24gYnVpbGRQYXJhbXMoIHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkICkgewoJdmFyIG5hbWU7CgoJaWYgKCBqUXVlcnkuaXNBcnJheSggb2JqICkgKSB7CgkJLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCgkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCWlmICggdHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdCggcHJlZml4ICkgKSB7CgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQlhZGQoIHByZWZpeCwgdiApOwoKCQkJfSBlbHNlIHsKCQkJCS8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4LgoJCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQkJfQoJCX0pOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQoKLy8gU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy8ga2V5L3ZhbHVlcyBpbnRvIGEgcXVlcnkgc3RyaW5nCmpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uKCBhLCB0cmFkaXRpb25hbCApIHsKCXZhciBwcmVmaXgsCgkJcyA9IFtdLAoJCWFkZCA9IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHJldHVybiBpdHMgdmFsdWUKCQkJdmFsdWUgPSBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSA/IHZhbHVlKCkgOiAoIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICk7CgkJCXNbIHMubGVuZ3RoIF0gPSBlbmNvZGVVUklDb21wb25lbnQoIGtleSApICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KCB2YWx1ZSApOwoJCX07CgoJLy8gU2V0IHRyYWRpdGlvbmFsIHRvIHRydWUgZm9yIGpRdWVyeSA8PSAxLjMuMiBiZWhhdmlvci4KCWlmICggdHJhZGl0aW9uYWwgPT09IHVuZGVmaW5lZCApIHsKCQl0cmFkaXRpb25hbCA9IGpRdWVyeS5hamF4U2V0dGluZ3MgJiYgalF1ZXJ5LmFqYXhTZXR0aW5ncy50cmFkaXRpb25hbDsKCX0KCgkvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgoJaWYgKCBqUXVlcnkuaXNBcnJheSggYSApIHx8ICggYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KCBhICkgKSApIHsKCQkvLyBTZXJpYWxpemUgdGhlIGZvcm0gZWxlbWVudHMKCQlqUXVlcnkuZWFjaCggYSwgZnVuY3Rpb24oKSB7CgkJCWFkZCggdGhpcy5uYW1lLCB0aGlzLnZhbHVlICk7CgkJfSk7CgoJfSBlbHNlIHsKCQkvLyBJZiB0cmFkaXRpb25hbCwgZW5jb2RlIHRoZSAib2xkIiB3YXkgKHRoZSB3YXkgMS4zLjIgb3Igb2xkZXIKCQkvLyBkaWQgaXQpLCBvdGhlcndpc2UgZW5jb2RlIHBhcmFtcyByZWN1cnNpdmVseS4KCQlmb3IgKCBwcmVmaXggaW4gYSApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCwgYVsgcHJlZml4IF0sIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQl9Cgl9CgoJLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgoJcmV0dXJuIHMuam9pbiggIiYiICkucmVwbGFjZSggcjIwLCAiKyIgKTsKfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsKCX0sCglzZXJpYWxpemVBcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQkvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwoJCQl2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOwoJCQlyZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsKCQl9KQoJCS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXZhciB0eXBlID0gdGhpcy50eXBlOwoKCQkJLy8gVXNlIC5pcyggIjpkaXNhYmxlZCIgKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwoJCQlyZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkoIHRoaXMgKS5pcyggIjpkaXNhYmxlZCIgKSAmJgoJCQkJcnN1Ym1pdHRhYmxlLnRlc3QoIHRoaXMubm9kZU5hbWUgKSAmJiAhcnN1Ym1pdHRlclR5cGVzLnRlc3QoIHR5cGUgKSAmJgoJCQkJKCB0aGlzLmNoZWNrZWQgfHwgIXJjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOwoJCX0pCgkJLm1hcChmdW5jdGlvbiggaSwgZWxlbSApIHsKCQkJdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKCQkJcmV0dXJuIHZhbCA9PSBudWxsID8KCQkJCW51bGwgOgoJCQkJalF1ZXJ5LmlzQXJyYXkoIHZhbCApID8KCQkJCQlqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWwgKSB7CgkJCQkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQkJCQl9KSA6CgkJCQkJeyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJfSkuZ2V0KCk7Cgl9Cn0pOwoKCmpRdWVyeS5hamF4U2V0dGluZ3MueGhyID0gZnVuY3Rpb24oKSB7Cgl0cnkgewoJCXJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCX0gY2F0Y2goIGUgKSB7fQp9OwoKdmFyIHhocklkID0gMCwKCXhockNhbGxiYWNrcyA9IHt9LAoJeGhyU3VjY2Vzc1N0YXR1cyA9IHsKCQkvLyBmaWxlIHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIGNvZGUgMCwgYXNzdW1lIDIwMAoJCTA6IDIwMCwKCQkvLyBTdXBwb3J0OiBJRTkKCQkvLyAjMTQ1MDogc29tZXRpbWVzIElFIHJldHVybnMgMTIyMyB3aGVuIGl0IHNob3VsZCBiZSAyMDQKCQkxMjIzOiAyMDQKCX0sCgl4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpOwoKLy8gU3VwcG9ydDogSUU5Ci8vIE9wZW4gcmVxdWVzdHMgbXVzdCBiZSBtYW51YWxseSBhYm9ydGVkIG9uIHVubG9hZCAoIzUyODApCmlmICggd2luZG93LkFjdGl2ZVhPYmplY3QgKSB7CglqUXVlcnkoIHdpbmRvdyApLm9uKCAidW5sb2FkIiwgZnVuY3Rpb24oKSB7CgkJZm9yICggdmFyIGtleSBpbiB4aHJDYWxsYmFja3MgKSB7CgkJCXhockNhbGxiYWNrc1sga2V5IF0oKTsKCQl9Cgl9KTsKfQoKc3VwcG9ydC5jb3JzID0gISF4aHJTdXBwb3J0ZWQgJiYgKCAid2l0aENyZWRlbnRpYWxzIiBpbiB4aHJTdXBwb3J0ZWQgKTsKc3VwcG9ydC5hamF4ID0geGhyU3VwcG9ydGVkID0gISF4aHJTdXBwb3J0ZWQ7CgpqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiggb3B0aW9ucyApIHsKCXZhciBjYWxsYmFjazsKCgkvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CglpZiAoIHN1cHBvcnQuY29ycyB8fCB4aHJTdXBwb3J0ZWQgJiYgIW9wdGlvbnMuY3Jvc3NEb21haW4gKSB7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIGhlYWRlcnMsIGNvbXBsZXRlICkgewoJCQkJdmFyIGksCgkJCQkJeGhyID0gb3B0aW9ucy54aHIoKSwKCQkJCQlpZCA9ICsreGhySWQ7CgoJCQkJeGhyLm9wZW4oIG9wdGlvbnMudHlwZSwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMucGFzc3dvcmQgKTsKCgkJCQkvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkCgkJCQlpZiAoIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCWZvciAoIGkgaW4gb3B0aW9ucy54aHJGaWVsZHMgKSB7CgkJCQkJCXhoclsgaSBdID0gb3B0aW9ucy54aHJGaWVsZHNbIGkgXTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gT3ZlcnJpZGUgbWltZSB0eXBlIGlmIG5lZWRlZAoJCQkJaWYgKCBvcHRpb25zLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlICkgewoJCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCBvcHRpb25zLm1pbWVUeXBlICk7CgkJCQl9CgoJCQkJLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKCQkJCS8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKCQkJCS8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCgkJCQkvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKCQkJCS8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgoJCQkJaWYgKCAhb3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdICkgewoJCQkJCWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCI7CgkJCQl9CgoJCQkJLy8gU2V0IGhlYWRlcnMKCQkJCWZvciAoIGkgaW4gaGVhZGVycyApIHsKCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlciggaSwgaGVhZGVyc1sgaSBdICk7CgkJCQl9CgoJCQkJLy8gQ2FsbGJhY2sKCQkJCWNhbGxiYWNrID0gZnVuY3Rpb24oIHR5cGUgKSB7CgkJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCQkJZGVsZXRlIHhockNhbGxiYWNrc1sgaWQgXTsKCQkJCQkJCWNhbGxiYWNrID0geGhyLm9ubG9hZCA9IHhoci5vbmVycm9yID0gbnVsbDsKCgkJCQkJCQlpZiAoIHR5cGUgPT09ICJhYm9ydCIgKSB7CgkJCQkJCQkJeGhyLmFib3J0KCk7CgkJCQkJCQl9IGVsc2UgaWYgKCB0eXBlID09PSAiZXJyb3IiICkgewoJCQkJCQkJCWNvbXBsZXRlKAoJCQkJCQkJCQkvLyBmaWxlOiBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwOyBzZWUgIzg2MDUsICMxNDIwNwoJCQkJCQkJCQl4aHIuc3RhdHVzLAoJCQkJCQkJCQl4aHIuc3RhdHVzVGV4dAoJCQkJCQkJCSk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvbXBsZXRlKAoJCQkJCQkJCQl4aHJTdWNjZXNzU3RhdHVzWyB4aHIuc3RhdHVzIF0gfHwgeGhyLnN0YXR1cywKCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQsCgkJCQkJCQkJCS8vIFN1cHBvcnQ6IElFOQoJCQkJCQkJCQkvLyBBY2Nlc3NpbmcgYmluYXJ5LWRhdGEgcmVzcG9uc2VUZXh0IHRocm93cyBhbiBleGNlcHRpb24KCQkJCQkJCQkJLy8gKCMxMTQyNikKCQkJCQkJCQkJdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICJzdHJpbmciID8gewoJCQkJCQkJCQkJdGV4dDogeGhyLnJlc3BvbnNlVGV4dAoJCQkJCQkJCQl9IDogdW5kZWZpbmVkLAoJCQkJCQkJCQl4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKCQkJCQkJCQkpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfTsKCQkJCX07CgoJCQkJLy8gTGlzdGVuIHRvIGV2ZW50cwoJCQkJeGhyLm9ubG9hZCA9IGNhbGxiYWNrKCk7CgkJCQl4aHIub25lcnJvciA9IGNhbGxiYWNrKCJlcnJvciIpOwoKCQkJCS8vIENyZWF0ZSB0aGUgYWJvcnQgY2FsbGJhY2sKCQkJCWNhbGxiYWNrID0geGhyQ2FsbGJhY2tzWyBpZCBdID0gY2FsbGJhY2soImFib3J0Iik7CgoJCQkJdHJ5IHsKCQkJCQkvLyBEbyBzZW5kIHRoZSByZXF1ZXN0ICh0aGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24pCgkJCQkJeGhyLnNlbmQoIG9wdGlvbnMuaGFzQ29udGVudCAmJiBvcHRpb25zLmRhdGEgfHwgbnVsbCApOwoJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJLy8gIzE0NjgzOiBPbmx5IHJldGhyb3cgaWYgdGhpcyBoYXNuJ3QgYmVlbiBub3RpZmllZCBhcyBhbiBlcnJvciB5ZXQKCQkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCQl0aHJvdyBlOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2soKTsKCQkJCX0KCQkJfQoJCX07Cgl9Cn0pOwoKCgoKLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKalF1ZXJ5LmFqYXhTZXR1cCh7CglhY2NlcHRzOiB7CgkJc2NyaXB0OiAidGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCgl9LAoJY29udGVudHM6IHsKCQlzY3JpcHQ6IC8oPzpqYXZhfGVjbWEpc2NyaXB0LwoJfSwKCWNvbnZlcnRlcnM6IHsKCQkidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiggdGV4dCApIHsKCQkJalF1ZXJ5Lmdsb2JhbEV2YWwoIHRleHQgKTsKCQkJcmV0dXJuIHRleHQ7CgkJfQoJfQp9KTsKCi8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgY3Jvc3NEb21haW4KalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoICJzY3JpcHQiLCBmdW5jdGlvbiggcyApIHsKCWlmICggcy5jYWNoZSA9PT0gdW5kZWZpbmVkICkgewoJCXMuY2FjaGUgPSBmYWxzZTsKCX0KCWlmICggcy5jcm9zc0RvbWFpbiApIHsKCQlzLnR5cGUgPSAiR0VUIjsKCX0KfSk7CgovLyBCaW5kIHNjcmlwdCB0YWcgaGFjayB0cmFuc3BvcnQKalF1ZXJ5LmFqYXhUcmFuc3BvcnQoICJzY3JpcHQiLCBmdW5jdGlvbiggcyApIHsKCS8vIFRoaXMgdHJhbnNwb3J0IG9ubHkgZGVhbHMgd2l0aCBjcm9zcyBkb21haW4gcmVxdWVzdHMKCWlmICggcy5jcm9zc0RvbWFpbiApIHsKCQl2YXIgc2NyaXB0LCBjYWxsYmFjazsKCQlyZXR1cm4gewoJCQlzZW5kOiBmdW5jdGlvbiggXywgY29tcGxldGUgKSB7CgkJCQlzY3JpcHQgPSBqUXVlcnkoIjxzY3JpcHQ+IikucHJvcCh7CgkJCQkJYXN5bmM6IHRydWUsCgkJCQkJY2hhcnNldDogcy5zY3JpcHRDaGFyc2V0LAoJCQkJCXNyYzogcy51cmwKCQkJCX0pLm9uKAoJCQkJCSJsb2FkIGVycm9yIiwKCQkJCQljYWxsYmFjayA9IGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCXNjcmlwdC5yZW1vdmUoKTsKCQkJCQkJY2FsbGJhY2sgPSBudWxsOwoJCQkJCQlpZiAoIGV2dCApIHsKCQkJCQkJCWNvbXBsZXRlKCBldnQudHlwZSA9PT0gImVycm9yIiA/IDQwNCA6IDIwMCwgZXZ0LnR5cGUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCSk7CgkJCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKCBzY3JpcHRbIDAgXSApOwoJCQl9LAoJCQlhYm9ydDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrKCk7CgkJCQl9CgkJCX0KCQl9OwoJfQp9KTsKCgoKCnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewoJanNvbnA6ICJjYWxsYmFjayIsCglqc29ucENhbGxiYWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggbm9uY2UrKyApICk7CgkJdGhpc1sgY2FsbGJhY2sgXSA9IHRydWU7CgkJcmV0dXJuIGNhbGxiYWNrOwoJfQp9KTsKCi8vIERldGVjdCwgbm9ybWFsaXplIG9wdGlvbnMgYW5kIGluc3RhbGwgY2FsbGJhY2tzIGZvciBqc29ucCByZXF1ZXN0cwpqUXVlcnkuYWpheFByZWZpbHRlciggImpzb24ganNvbnAiLCBmdW5jdGlvbiggcywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIgKSB7CgoJdmFyIGNhbGxiYWNrTmFtZSwgb3ZlcndyaXR0ZW4sIHJlc3BvbnNlQ29udGFpbmVyLAoJCWpzb25Qcm9wID0gcy5qc29ucCAhPT0gZmFsc2UgJiYgKCByanNvbnAudGVzdCggcy51cmwgKSA/CgkJCSJ1cmwiIDoKCQkJdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIgJiYgISggcy5jb250ZW50VHlwZSB8fCAiIiApLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpICYmIHJqc29ucC50ZXN0KCBzLmRhdGEgKSAmJiAiZGF0YSIKCQkpOwoKCS8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CglpZiAoIGpzb25Qcm9wIHx8IHMuZGF0YVR5cGVzWyAwIF0gPT09ICJqc29ucCIgKSB7CgoJCS8vIEdldCBjYWxsYmFjayBuYW1lLCByZW1lbWJlcmluZyBwcmVleGlzdGluZyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggaXQKCQljYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBqUXVlcnkuaXNGdW5jdGlvbiggcy5qc29ucENhbGxiYWNrICkgPwoJCQlzLmpzb25wQ2FsbGJhY2soKSA6CgkJCXMuanNvbnBDYWxsYmFjazsKCgkJLy8gSW5zZXJ0IGNhbGxiYWNrIGludG8gdXJsIG9yIGZvcm0gZGF0YQoJCWlmICgganNvblByb3AgKSB7CgkJCXNbIGpzb25Qcm9wIF0gPSBzWyBqc29uUHJvcCBdLnJlcGxhY2UoIHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSApOwoJCX0gZWxzZSBpZiAoIHMuanNvbnAgIT09IGZhbHNlICkgewoJCQlzLnVybCArPSAoIHJxdWVyeS50ZXN0KCBzLnVybCApID8gIiYiIDogIj8iICkgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwoJCX0KCgkJLy8gVXNlIGRhdGEgY29udmVydGVyIHRvIHJldHJpZXZlIGpzb24gYWZ0ZXIgc2NyaXB0IGV4ZWN1dGlvbgoJCXMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKCQkJCWpRdWVyeS5lcnJvciggY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIgKTsKCQkJfQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsKCQl9OwoKCQkvLyBmb3JjZSBqc29uIGRhdGFUeXBlCgkJcy5kYXRhVHlwZXNbIDAgXSA9ICJqc29uIjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFjawoJCW92ZXJ3cml0dGVuID0gd2luZG93WyBjYWxsYmFja05hbWUgXTsKCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gZnVuY3Rpb24oKSB7CgkJCXJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwoJCX07CgoJCS8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQoJCWpxWEhSLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJLy8gUmVzdG9yZSBwcmVleGlzdGluZyB2YWx1ZQoJCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gb3ZlcndyaXR0ZW47CgoJCQkvLyBTYXZlIGJhY2sgYXMgZnJlZQoJCQlpZiAoIHNbIGNhbGxiYWNrTmFtZSBdICkgewoJCQkJLy8gbWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCgkJCQlzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgoJCQkJLy8gc2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQoJCQkJb2xkQ2FsbGJhY2tzLnB1c2goIGNhbGxiYWNrTmFtZSApOwoJCQl9CgoJCQkvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKCQkJaWYgKCByZXNwb25zZUNvbnRhaW5lciAmJiBqUXVlcnkuaXNGdW5jdGlvbiggb3ZlcndyaXR0ZW4gKSApIHsKCQkJCW92ZXJ3cml0dGVuKCByZXNwb25zZUNvbnRhaW5lclsgMCBdICk7CgkJCX0KCgkJCXJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CgkJfSk7CgoJCS8vIERlbGVnYXRlIHRvIHNjcmlwdAoJCXJldHVybiAic2NyaXB0IjsKCX0KfSk7CgoKCgovLyBkYXRhOiBzdHJpbmcgb2YgaHRtbAovLyBjb250ZXh0IChvcHRpb25hbCk6IElmIHNwZWNpZmllZCwgdGhlIGZyYWdtZW50IHdpbGwgYmUgY3JlYXRlZCBpbiB0aGlzIGNvbnRleHQsIGRlZmF1bHRzIHRvIGRvY3VtZW50Ci8vIGtlZXBTY3JpcHRzIChvcHRpb25hbCk6IElmIHRydWUsIHdpbGwgaW5jbHVkZSBzY3JpcHRzIHBhc3NlZCBpbiB0aGUgaHRtbCBzdHJpbmcKalF1ZXJ5LnBhcnNlSFRNTCA9IGZ1bmN0aW9uKCBkYXRhLCBjb250ZXh0LCBrZWVwU2NyaXB0cyApIHsKCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCXJldHVybiBudWxsOwoJfQoJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCWtlZXBTY3JpcHRzID0gY29udGV4dDsKCQljb250ZXh0ID0gZmFsc2U7Cgl9Cgljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCgl2YXIgcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKCBkYXRhICksCgkJc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCgkvLyBTaW5nbGUgdGFnCglpZiAoIHBhcnNlZCApIHsKCQlyZXR1cm4gWyBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoIHBhcnNlZFsxXSApIF07Cgl9CgoJcGFyc2VkID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIFsgZGF0YSBdLCBjb250ZXh0LCBzY3JpcHRzICk7CgoJaWYgKCBzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoICkgewoJCWpRdWVyeSggc2NyaXB0cyApLnJlbW92ZSgpOwoJfQoKCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwp9OwoKCi8vIEtlZXAgYSBjb3B5IG9mIHRoZSBvbGQgbG9hZCBtZXRob2QKdmFyIF9sb2FkID0galF1ZXJ5LmZuLmxvYWQ7CgovKioKICogTG9hZCBhIHVybCBpbnRvIGEgcGFnZQogKi8KalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiggdXJsLCBwYXJhbXMsIGNhbGxiYWNrICkgewoJaWYgKCB0eXBlb2YgdXJsICE9PSAic3RyaW5nIiAmJiBfbG9hZCApIHsKCQlyZXR1cm4gX2xvYWQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfQoKCXZhciBzZWxlY3RvciwgdHlwZSwgcmVzcG9uc2UsCgkJc2VsZiA9IHRoaXMsCgkJb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKCglpZiAoIG9mZiA+PSAwICkgewoJCXNlbGVjdG9yID0galF1ZXJ5LnRyaW0oIHVybC5zbGljZSggb2ZmICkgKTsKCQl1cmwgPSB1cmwuc2xpY2UoIDAsIG9mZiApOwoJfQoKCS8vIElmIGl0J3MgYSBmdW5jdGlvbgoJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggcGFyYW1zICkgKSB7CgoJCS8vIFdlIGFzc3VtZSB0aGF0IGl0J3MgdGhlIGNhbGxiYWNrCgkJY2FsbGJhY2sgPSBwYXJhbXM7CgkJcGFyYW1zID0gdW5kZWZpbmVkOwoKCS8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKCX0gZWxzZSBpZiAoIHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApIHsKCQl0eXBlID0gIlBPU1QiOwoJfQoKCS8vIElmIHdlIGhhdmUgZWxlbWVudHMgdG8gbW9kaWZ5LCBtYWtlIHRoZSByZXF1ZXN0CglpZiAoIHNlbGYubGVuZ3RoID4gMCApIHsKCQlqUXVlcnkuYWpheCh7CgkJCXVybDogdXJsLAoKCQkJLy8gaWYgInR5cGUiIHZhcmlhYmxlIGlzIHVuZGVmaW5lZCwgdGhlbiAiR0VUIiBtZXRob2Qgd2lsbCBiZSB1c2VkCgkJCXR5cGU6IHR5cGUsCgkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCWRhdGE6IHBhcmFtcwoJCX0pLmRvbmUoZnVuY3Rpb24oIHJlc3BvbnNlVGV4dCApIHsKCgkJCS8vIFNhdmUgcmVzcG9uc2UgZm9yIHVzZSBpbiBjb21wbGV0ZSBjYWxsYmFjawoJCQlyZXNwb25zZSA9IGFyZ3VtZW50czsKCgkJCXNlbGYuaHRtbCggc2VsZWN0b3IgPwoKCQkJCS8vIElmIGEgc2VsZWN0b3Igd2FzIHNwZWNpZmllZCwgbG9jYXRlIHRoZSByaWdodCBlbGVtZW50cyBpbiBhIGR1bW15IGRpdgoJCQkJLy8gRXhjbHVkZSBzY3JpcHRzIHRvIGF2b2lkIElFICdQZXJtaXNzaW9uIERlbmllZCcgZXJyb3JzCgkJCQlqUXVlcnkoIjxkaXY+IikuYXBwZW5kKCBqUXVlcnkucGFyc2VIVE1MKCByZXNwb25zZVRleHQgKSApLmZpbmQoIHNlbGVjdG9yICkgOgoKCQkJCS8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CgkJCQlyZXNwb25zZVRleHQgKTsKCgkJfSkuY29tcGxldGUoIGNhbGxiYWNrICYmIGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQlzZWxmLmVhY2goIGNhbGxiYWNrLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7CgkJfSk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgoKCgpqUXVlcnkuZXhwci5maWx0ZXJzLmFuaW1hdGVkID0gZnVuY3Rpb24oIGVsZW0gKSB7CglyZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycywgZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBlbGVtID09PSBmbi5lbGVtOwoJfSkubGVuZ3RoOwp9OwoKCgoKdmFyIGRvY0VsZW0gPSB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKLyoqCiAqIEdldHMgYSB3aW5kb3cgZnJvbSBhbiBlbGVtZW50CiAqLwpmdW5jdGlvbiBnZXRXaW5kb3coIGVsZW0gKSB7CglyZXR1cm4galF1ZXJ5LmlzV2luZG93KCBlbGVtICkgPyBlbGVtIDogZWxlbS5ub2RlVHlwZSA9PT0gOSAmJiBlbGVtLmRlZmF1bHRWaWV3Owp9CgpqUXVlcnkub2Zmc2V0ID0gewoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQl2YXIgY3VyUG9zaXRpb24sIGN1ckxlZnQsIGN1ckNTU1RvcCwgY3VyVG9wLCBjdXJPZmZzZXQsIGN1ckNTU0xlZnQsIGNhbGN1bGF0ZVBvc2l0aW9uLAoJCQlwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSwKCQkJY3VyRWxlbSA9IGpRdWVyeSggZWxlbSApLAoJCQlwcm9wcyA9IHt9OwoKCQkvLyBTZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgKSB7CgkJCWVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCgkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKTsKCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApOwoJCWN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKCBlbGVtLCAibGVmdCIgKTsKCQljYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJgoJCQkoIGN1ckNTU1RvcCArIGN1ckNTU0xlZnQgKS5pbmRleE9mKCJhdXRvIikgPiAtMTsKCgkJLy8gTmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIgdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCgkJaWYgKCBjYWxjdWxhdGVQb3NpdGlvbiApIHsKCQkJY3VyUG9zaXRpb24gPSBjdXJFbGVtLnBvc2l0aW9uKCk7CgkJCWN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKCQkJY3VyTGVmdCA9IGN1clBvc2l0aW9uLmxlZnQ7CgoJCX0gZWxzZSB7CgkJCWN1clRvcCA9IHBhcnNlRmxvYXQoIGN1ckNTU1RvcCApIHx8IDA7CgkJCWN1ckxlZnQgPSBwYXJzZUZsb2F0KCBjdXJDU1NMZWZ0ICkgfHwgMDsKCQl9CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIG9wdGlvbnMgKSApIHsKCQkJb3B0aW9ucyA9IG9wdGlvbnMuY2FsbCggZWxlbSwgaSwgY3VyT2Zmc2V0ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudG9wICE9IG51bGwgKSB7CgkJCXByb3BzLnRvcCA9ICggb3B0aW9ucy50b3AgLSBjdXJPZmZzZXQudG9wICkgKyBjdXJUb3A7CgkJfQoJCWlmICggb3B0aW9ucy5sZWZ0ICE9IG51bGwgKSB7CgkJCXByb3BzLmxlZnQgPSAoIG9wdGlvbnMubGVmdCAtIGN1ck9mZnNldC5sZWZ0ICkgKyBjdXJMZWZ0OwoJCX0KCgkJaWYgKCAidXNpbmciIGluIG9wdGlvbnMgKSB7CgkJCW9wdGlvbnMudXNpbmcuY2FsbCggZWxlbSwgcHJvcHMgKTsKCgkJfSBlbHNlIHsKCQkJY3VyRWxlbS5jc3MoIHByb3BzICk7CgkJfQoJfQp9OwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglvZmZzZXQ6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/CgkJCQl0aGlzIDoKCQkJCXRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCQlqUXVlcnkub2Zmc2V0LnNldE9mZnNldCggdGhpcywgb3B0aW9ucywgaSApOwoJCQkJfSk7CgkJfQoKCQl2YXIgZG9jRWxlbSwgd2luLAoJCQllbGVtID0gdGhpc1sgMCBdLAoJCQlib3ggPSB7IHRvcDogMCwgbGVmdDogMCB9LAoJCQlkb2MgPSBlbGVtICYmIGVsZW0ub3duZXJEb2N1bWVudDsKCgkJaWYgKCAhZG9jICkgewoJCQlyZXR1cm47CgkJfQoKCQlkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKCgkJLy8gTWFrZSBzdXJlIGl0J3Mgbm90IGEgZGlzY29ubmVjdGVkIERPTSBub2RlCgkJaWYgKCAhalF1ZXJ5LmNvbnRhaW5zKCBkb2NFbGVtLCBlbGVtICkgKSB7CgkJCXJldHVybiBib3g7CgkJfQoKCQkvLyBJZiB3ZSBkb24ndCBoYXZlIGdCQ1IsIGp1c3QgdXNlIDAsMCByYXRoZXIgdGhhbiBlcnJvcgoJCS8vIEJsYWNrQmVycnkgNSwgaU9TIDMgKG9yaWdpbmFsIGlQaG9uZSkKCQlpZiAoIHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gc3RydW5kZWZpbmVkICkgewoJCQlib3ggPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCX0KCQl3aW4gPSBnZXRXaW5kb3coIGRvYyApOwoJCXJldHVybiB7CgkJCXRvcDogYm94LnRvcCArIHdpbi5wYWdlWU9mZnNldCAtIGRvY0VsZW0uY2xpZW50VG9wLAoJCQlsZWZ0OiBib3gubGVmdCArIHdpbi5wYWdlWE9mZnNldCAtIGRvY0VsZW0uY2xpZW50TGVmdAoJCX07Cgl9LAoKCXBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzWyAwIF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBvZmZzZXRQYXJlbnQsIG9mZnNldCwKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJcGFyZW50T2Zmc2V0ID0geyB0b3A6IDAsIGxlZnQ6IDAgfTsKCgkJLy8gRml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHdpbmRvdyAocGFyZW50T2Zmc2V0ID0ge3RvcDowLCBsZWZ0OiAwfSwgYmVjYXVzZSBpdCBpcyBpdHMgb25seSBvZmZzZXQgcGFyZW50CgkJaWYgKCBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICkgPT09ICJmaXhlZCIgKSB7CgkJCS8vIFdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAoJCQlvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKCQl9IGVsc2UgewoJCQkvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAoJCQlvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwoKCQkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCQlvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsKCQkJCXBhcmVudE9mZnNldCA9IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCQkJfQoKCQkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJCXBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsKCQkJcGFyZW50T2Zmc2V0LmxlZnQgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlICk7CgkJfQoKCQkvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCgkJcmV0dXJuIHsKCQkJdG9wOiBvZmZzZXQudG9wIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoIGVsZW0sICJtYXJnaW5Ub3AiLCB0cnVlICksCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUgKQoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKCgkJCXdoaWxlICggb2Zmc2V0UGFyZW50ICYmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50LCAiaHRtbCIgKSAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIgKSA9PT0gInN0YXRpYyIgKSApIHsKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CgkJCX0KCgkJCXJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKCQl9KTsKCX0KfSk7CgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgc2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0Iiwgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7Cgl2YXIgdG9wID0gInBhZ2VZT2Zmc2V0IiA9PT0gcHJvcDsKCglqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24oIHZhbCApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbWV0aG9kLCB2YWwgKSB7CgkJCXZhciB3aW4gPSBnZXRXaW5kb3coIGVsZW0gKTsKCgkJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gd2luID8gd2luWyBwcm9wIF0gOiBlbGVtWyBtZXRob2QgXTsKCQkJfQoKCQkJaWYgKCB3aW4gKSB7CgkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJIXRvcCA/IHZhbCA6IHdpbmRvdy5wYWdlWE9mZnNldCwKCQkJCQl0b3AgPyB2YWwgOiB3aW5kb3cucGFnZVlPZmZzZXQKCQkJCSk7CgoJCQl9IGVsc2UgewoJCQkJZWxlbVsgbWV0aG9kIF0gPSB2YWw7CgkJCX0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCwgbnVsbCApOwoJfTsKfSk7CgovLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgovLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodAovLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwgd2UganVzdCBjaGVjayBmb3IgaXQgaGVyZQpqUXVlcnkuZWFjaCggWyAidG9wIiwgImxlZnQiIF0sIGZ1bmN0aW9uKCBpLCBwcm9wICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBwcm9wIF0gPSBhZGRHZXRIb29rSWYoIHN1cHBvcnQucGl4ZWxQb3NpdGlvbiwKCQlmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQljb21wdXRlZCA9IGN1ckNTUyggZWxlbSwgcHJvcCApOwoJCQkJLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CgkJCQlyZXR1cm4gcm51bW5vbnB4LnRlc3QoIGNvbXB1dGVkICkgPwoJCQkJCWpRdWVyeSggZWxlbSApLnBvc2l0aW9uKClbIHByb3AgXSArICJweCIgOgoJCQkJCWNvbXB1dGVkOwoJCQl9CgkJfQoJKTsKfSk7CgoKLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKCQkvLyBtYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKCQkJCXZhciBkb2M7CgoJCQkJaWYgKCBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCQkJCQkvLyBBcyBvZiA1LzgvMjAxMiB0aGlzIHdpbGwgeWllbGQgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIE1vYmlsZSBTYWZhcmksIGJ1dCB0aGVyZQoJCQkJCS8vIGlzbid0IGEgd2hvbGUgbG90IHdlIGNhbiBkby4gU2VlIHB1bGwgcmVxdWVzdCBhdCB0aGlzIFVSTCBmb3IgZGlzY3Vzc2lvbjoKCQkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzc2NAoJCQkJCXJldHVybiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsgImNsaWVudCIgKyBuYW1lIF07CgkJCQl9CgoJCQkJLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSA5ICkgewoJCQkJCWRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwoKCQkJCQkvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sCgkJCQkJLy8gd2hpY2hldmVyIGlzIGdyZWF0ZXN0CgkJCQkJcmV0dXJuIE1hdGgubWF4KAoJCQkJCQllbGVtLmJvZHlbICJzY3JvbGwiICsgbmFtZSBdLCBkb2NbICJzY3JvbGwiICsgbmFtZSBdLAoJCQkJCQllbGVtLmJvZHlbICJvZmZzZXQiICsgbmFtZSBdLCBkb2NbICJvZmZzZXQiICsgbmFtZSBdLAoJCQkJCQlkb2NbICJjbGllbnQiICsgbmFtZSBdCgkJCQkJKTsKCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/CgkJCQkJLy8gR2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudCwgcmVxdWVzdGluZyBidXQgbm90IGZvcmNpbmcgcGFyc2VGbG9hdAoJCQkJCWpRdWVyeS5jc3MoIGVsZW0sIHR5cGUsIGV4dHJhICkgOgoKCQkJCQkvLyBTZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CgkJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEgKTsKCQkJfSwgdHlwZSwgY2hhaW5hYmxlID8gbWFyZ2luIDogdW5kZWZpbmVkLCBjaGFpbmFibGUsIG51bGwgKTsKCQl9OwoJfSk7Cn0pOwoKCi8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CmpRdWVyeS5mbi5zaXplID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gdGhpcy5sZW5ndGg7Cn07CgpqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwoKCgoKLy8gUmVnaXN0ZXIgYXMgYSBuYW1lZCBBTUQgbW9kdWxlLCBzaW5jZSBqUXVlcnkgY2FuIGJlIGNvbmNhdGVuYXRlZCB3aXRoIG90aGVyCi8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKLy8gdW5kZXJzdGFuZHMgYW5vbnltb3VzIEFNRCBtb2R1bGVzLiBBIG5hbWVkIEFNRCBpcyBzYWZlc3QgYW5kIG1vc3Qgcm9idXN0Ci8vIHdheSB0byByZWdpc3Rlci4gTG93ZXJjYXNlIGpxdWVyeSBpcyB1c2VkIGJlY2F1c2UgQU1EIG1vZHVsZSBuYW1lcyBhcmUKLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCi8vIGZpbGUgbmFtZS4gRG8gdGhpcyBhZnRlciBjcmVhdGluZyB0aGUgZ2xvYmFsIHNvIHRoYXQgaWYgYW4gQU1EIG1vZHVsZSB3YW50cwovLyB0byBjYWxsIG5vQ29uZmxpY3QgdG8gaGlkZSB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5LCBpdCB3aWxsIHdvcmsuCgovLyBOb3RlIHRoYXQgZm9yIG1heGltdW0gcG9ydGFiaWxpdHksIGxpYnJhcmllcyB0aGF0IGFyZSBub3QgalF1ZXJ5IHNob3VsZAovLyBkZWNsYXJlIHRoZW1zZWx2ZXMgYXMgYW5vbnltb3VzIG1vZHVsZXMsIGFuZCBhdm9pZCBzZXR0aW5nIGEgZ2xvYmFsIGlmIGFuCi8vIEFNRCBsb2FkZXIgaXMgcHJlc2VudC4galF1ZXJ5IGlzIGEgc3BlY2lhbCBjYXNlLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcmJ1cmtlL3JlcXVpcmVqcy93aWtpL1VwZGF0aW5nLWV4aXN0aW5nLWxpYnJhcmllcyN3aWtpLWFub24KCmlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJZGVmaW5lKCAianF1ZXJ5IiwgW10sIGZ1bmN0aW9uKCkgewoJCXJldHVybiBqUXVlcnk7Cgl9KTsKfQoKCgoKdmFyCgkvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKCS8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCglfJCA9IHdpbmRvdy4kOwoKalF1ZXJ5Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiggZGVlcCApIHsKCWlmICggd2luZG93LiQgPT09IGpRdWVyeSApIHsKCQl3aW5kb3cuJCA9IF8kOwoJfQoKCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7CgkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7Cgl9CgoJcmV0dXJuIGpRdWVyeTsKfTsKCi8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4KLy8gQU1EICgjNzEwMiNjb21tZW50OjEwLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzU1NykKLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQppZiAoIHR5cGVvZiBub0dsb2JhbCA9PT0gc3RydW5kZWZpbmVkICkgewoJd2luZG93LmpRdWVyeSA9IHdpbmRvdy4kID0galF1ZXJ5Owp9CgoKCgpyZXR1cm4galF1ZXJ5OwoKfSkpOwoKfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciAkLCBhZGRUb2dnbGUsIHRvYzsKCiQgPSByZXF1aXJlKCdqcXVlcnknKTsKCnRvYyA9IHJlcXVpcmUoJy4vdG9jJyk7CgphZGRUb2dnbGUgPSBmdW5jdGlvbihjbGFzc05hbWUsIG5hbWUsIGFkZGl0aW9uYWxDbGFzc2VzKSB7CiAgdmFyIHRvZ2dsZU1haW5hOwogIHRvZ2dsZU1haW5hID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZXh0cmFDbGFzc2VzLCB0aGVUb2dnbGluZywgdG9nZ2xlYWJsZTsKICAgIHRvZ2dsZWFibGUgPSAkKHRoaXMpOwogICAgZXh0cmFDbGFzc2VzID0gYWRkaXRpb25hbENsYXNzZXMgIT0gbnVsbCA/IGFkZGl0aW9uYWxDbGFzc2VzIDogewogICAgICBhZGRpdGlvbmFsQ2xhc3NlczogJycKICAgIH07CiAgICB0aGVUb2dnbGluZyA9IGZ1bmN0aW9uKGV2dCkgewogICAgICB0b2dnbGVhYmxlLnRvZ2dsZSgpOwogICAgICByZXR1cm4gZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICB9OwogICAgdG9nZ2xlYWJsZS5hZGRDbGFzcygicGFuZWwtYm9keSIpLndyYXAoJzxkaXYgY2xhc3M9InBhbmVsIHBhbmVsLWRlZmF1bHQgI3tleHRyYUNsYXNzZXN9Ij48L2Rpdj4nKS5oaWRlKCk7CiAgICByZXR1cm4gJCgiPGEgaHJlZj1cImphdmFzY3JpcHQ6dm9pZCAwXCI+PGRpdiBjbGFzcz1cInBhbmVsLWhlYWRpbmdcIj48aDU+ICIgKyBuYW1lICsgIiAoY2xpY2sgdG8gcmV2ZWFsKTwvaDU+PC9kaXY+PC9hPiIpLmluc2VydEJlZm9yZSh0b2dnbGVhYmxlKS5jbGljayh0aGVUb2dnbGluZyk7CiAgfTsKICByZXR1cm4gJCgiLiIgKyBjbGFzc05hbWUpLmVhY2godG9nZ2xlTWFpbmEpOwp9OwoKJChmdW5jdGlvbigpIHsKICB0b2MuaW5pdCgnLnRvYy10b2dnbGUnLCAnLmNvdmVyLW5vdGVzLC50b2MtY29udGVudHMnKTsKICBhZGRUb2dnbGUoJ3NvbHV0aW9uJywgJ1NvbHV0aW9uJyk7Cn0pOwoKCgp9LHsiLi90b2MiOjMsImpxdWVyeSI6MX1dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgJCwgaW5pdDsKCiQgPSByZXF1aXJlKCdqcXVlcnknKTsKCmluaXQgPSBmdW5jdGlvbih0b2dnbGUsIHRvYykgewogIHRvZ2dsZSA9ICQodG9nZ2xlKTsKICB0b2MgPSAkKHRvYyk7CiAgdG9nZ2xlLm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2dCkgewogICAgdG9jLnNsaWRlRG93bigpOwogICAgdG9nZ2xlLnJlbW92ZSgpOwogIH0pOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaW5pdDogaW5pdAp9OwoKCgp9LHsianF1ZXJ5IjoxfV19LHt9LFsyXSk7Cg=="></script>
</head>
<body>
<header class="hero">
<div class="hero-left-overlay-white"></div>
<div class="hero-right-overlay-white"></div>
<div class="hero-arrow-overlay-white"></div>
<div class="container">
<div class="hero-text">
<h1 class="title">
Scala with Cats
</h1>
<h3 class="author">Noel Welsh and Dave Gurnell</h3>
<p class="date">November 2017</p>
<img class="brand-logo" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4xLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB3aWR0aD0iMjcycHgiIGhlaWdodD0iMTIwcHgiIHZpZXdCb3g9IjAgMCAyNzIgMTIwIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNzIgMTIwIiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJCRyI+DQo8L2c+DQo8ZyBpZD0iTG9nb18xXyI+DQoJPGcgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAgICAiPg0KCQk8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMTguMzA5LDg5LjE0NHYxNi4xNjRjMCwxLjU1NCwwLjM1OSwyLjc1NiwxLjA3OSwzLjYwNmMwLjcxOSwwLjg1MiwxLjc5NywxLjI3NywzLjIzNSwxLjI3Nw0KCQkJYzEuMDU4LDAsMi4wNDktMC4yMzUsMi45NzUtMC43MDdjMC45MjUtMC40NzEsMS44MDEtMS4xMTksMi42MjctMS45NDVWODkuMTQ0aDYuMTI0djI1LjQzNmgtMy43NDQNCgkJCWMtMC43OTMsMC0xLjMxMy0wLjM3Mi0xLjU2Mi0xLjExNWwtMC40MjEtMi4wMzNjLTAuNTI5LDAuNTI5LTEuMDc1LDEuMDEzLTEuNjM2LDEuNDVjLTAuNTYyLDAuNDM4LTEuMTYxLDAuODEtMS43OTcsMS4xMTUNCgkJCWMtMC42MzYsMC4zMDctMS4zMjIsMC41NDYtMi4wNTgsMC43MmMtMC43MzUsMC4xNzMtMS41MjQsMC4yNi0yLjM2OCwwLjI2Yy0xLjM4OCwwLTIuNjE1LTAuMjM1LTMuNjgxLTAuNzA2DQoJCQljLTEuMDY2LTAuNDcyLTEuOTYzLTEuMTM3LTIuNjktMS45OTZjLTAuNzI4LTAuODU5LTEuMjc2LTEuODgtMS42NDgtMy4wNjJzLTAuNTU4LTIuNDgyLTAuNTU4LTMuOTA0Vjg5LjE0NEgxOC4zMDl6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik00MC44OTMsMTE0LjU3OVY4OS4xNDRoMy43NDNjMC43OTMsMCwxLjMxNCwwLjM3MiwxLjU2MiwxLjExNmwwLjQyMSwyLjAwOA0KCQkJYzAuNTEyLTAuNTI4LDEuMDU0LTEuMDA4LDEuNjI0LTEuNDM4YzAuNTctMC40MywxLjE3My0wLjgwMiwxLjgxLTEuMTE2YzAuNjM2LTAuMzEzLDEuMzE3LTAuNTUzLDIuMDQ1LTAuNzE5DQoJCQljMC43MjctMC4xNjUsMS41MjEtMC4yNDgsMi4zOC0wLjI0OGMxLjM4OCwwLDIuNjIsMC4yMzUsMy42OTQsMC43MDdjMS4wNzQsMC40NzEsMS45NzEsMS4xMzIsMi42OSwxLjk4Mw0KCQkJYzAuNzE5LDAuODUxLDEuMjY0LDEuODY3LDEuNjM2LDMuMDQ5YzAuMzcyLDEuMTgyLDAuNTU4LDIuNDgzLDAuNTU4LDMuOTA0djE2LjE4OGgtNi4xMjNWOTguMzkxYzAtMS41NTMtMC4zNi0yLjc1Ni0xLjA3OS0zLjYwNg0KCQkJYy0wLjcxOS0wLjg1Mi0xLjc5Ny0xLjI3Ny0zLjIzNS0xLjI3N2MtMS4wNTgsMC0yLjA0OSwwLjI0LTIuOTc1LDAuNzE5Yy0wLjkyNiwwLjQ4LTEuODAyLDEuMTMzLTIuNjI4LDEuOTU5djE4LjM5NUg0MC44OTN6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik04Ni45NzgsMTE0LjU3OWMtMC43OTMsMC0xLjMxMy0wLjM3Mi0xLjU2Mi0xLjExNWwtMC40OTYtMi40NTVjLTAuNTI5LDAuNTk2LTEuMDgzLDEuMTMzLTEuNjYxLDEuNjEyDQoJCQljLTAuNTc5LDAuNDc5LTEuMjAzLDAuODkyLTEuODcyLDEuMjM5Yy0wLjY2OSwwLjM0Ny0xLjM4OSwwLjYxNS0yLjE1NywwLjgwNmMtMC43NjksMC4xODktMS41OTksMC4yODUtMi40OTIsMC4yODUNCgkJCWMtMS4zODgsMC0yLjY2MS0wLjI5LTMuODE4LTAuODY4cy0yLjE1My0xLjQxNy0yLjk4Ny0yLjUxNmMtMC44MzQtMS4xLTEuNDc5LTIuNDU4LTEuOTM0LTQuMDc4cy0wLjY4Mi0zLjQ3MS0wLjY4Mi01LjU1NA0KCQkJYzAtMS44ODQsMC4yNTYtMy42MzYsMC43NjktNS4yNTVjMC41MTItMS42MiwxLjI0OC0zLjAyNCwyLjIwNy00LjIxNWMwLjk1OC0xLjE4OSwyLjEwNy0yLjExOSwzLjQ0Ni0yLjc4OQ0KCQkJYzEuMzM4LTAuNjY5LDIuODQyLTEuMDA0LDQuNTEyLTEuMDA0YzEuNDIxLDAsMi42MzYsMC4yMjgsMy42NDQsMC42ODJjMS4wMDgsMC40NTUsMS45MDksMS4wNjIsMi43MDIsMS44MjJWNzcuNzRoNi4xMjR2MzYuODM5DQoJCQlIODYuOTc4eiBNNzguODIyLDExMC4wOTJjMS4yNzIsMCwyLjM1NS0wLjI2NCwzLjI0OC0wLjc5M3MxLjczNS0xLjI4LDIuNTI4LTIuMjU2Vjk1LjYzOWMtMC42OTQtMC44NDMtMS40NS0xLjQzOC0yLjI2OC0xLjc4NA0KCQkJYy0wLjgxOC0wLjM0OC0xLjY5OC0wLjUyMS0yLjY0LTAuNTIxYy0wLjkyNiwwLTEuNzY1LDAuMTczLTIuNTE2LDAuNTIxYy0wLjc1MiwwLjM0Ny0xLjM4OSwwLjg3Mi0xLjkwOSwxLjU3NA0KCQkJcy0wLjkyMSwxLjU5NS0xLjIwMiwyLjY3N2MtMC4yODEsMS4wODMtMC40MjEsMi4zNTktMC40MjEsMy44M2MwLDEuNDg4LDAuMTIsMi43NDgsMC4zNTksMy43ODENCgkJCWMwLjIzOSwxLjAzMywwLjU4MywxLjg3NiwxLjAyOSwyLjUyOGMwLjQ0NiwwLjY1MywwLjk5MiwxLjEyNCwxLjYzNiwxLjQxM1M3OC4wMjksMTEwLjA5Miw3OC44MjIsMTEwLjA5MnoiLz4NCgkJPHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0iTTEwNy44NTIsODguNzQ3YzEuNjAzLDAsMy4wNzgsMC4yNTcsNC40MjUsMC43NjljMS4zNDcsMC41MTMsMi41MDgsMS4yNjEsMy40ODMsMi4yNDQNCgkJCWMwLjk3NSwwLjk4MywxLjczNSwyLjE4OSwyLjI4MSwzLjYxOXMwLjgxOCwzLjA2MiwwLjgxOCw0Ljg5NmMwLDAuNDYzLTAuMDIxLDAuODQ3LTAuMDYyLDEuMTUyDQoJCQljLTAuMDQyLDAuMzA2LTAuMTE2LDAuNTQ1LTAuMjIzLDAuNzE5cy0wLjI1MiwwLjI5OC0wLjQzNCwwLjM3MmMtMC4xODIsMC4wNzQtMC40MTQsMC4xMTEtMC42OTQsMC4xMTFoLTE1LjcxNw0KCQkJYzAuMTgyLDIuNjExLDAuODg0LDQuNTI4LDIuMTA3LDUuNzUyYzEuMjIzLDEuMjIzLDIuODQyLDEuODM0LDQuODU5LDEuODM0YzAuOTkyLDAsMS44NDctMC4xMTUsMi41NjYtMC4zNDcNCgkJCWMwLjcxOS0wLjIzMSwxLjM0Ny0wLjQ4NywxLjg4NC0wLjc2OXMxLjAwOC0wLjUzNywxLjQxMy0wLjc2OWMwLjQwNS0wLjIzMSwwLjc5Ny0wLjM0OCwxLjE3OC0wLjM0OA0KCQkJYzAuMjQ4LDAsMC40NjIsMC4wNSwwLjY0NSwwLjE0OWMwLjE4MiwwLjA5OSwwLjMzOCwwLjIzOSwwLjQ3MSwwLjQyMWwxLjc4NSwyLjIzMWMtMC42NzgsMC43OTMtMS40MzgsMS40NTktMi4yODEsMS45OTYNCgkJCXMtMS43MjMsMC45NjctMi42NCwxLjI4OWMtMC45MTcsMC4zMjItMS44NTEsMC41NDktMi44MDEsMC42ODJjLTAuOTUxLDAuMTMyLTEuODcyLDAuMTk4LTIuNzY0LDAuMTk4DQoJCQljLTEuNzY5LDAtMy40MTMtMC4yOTQtNC45MzMtMC44OGMtMS41MjEtMC41ODctMi44NDMtMS40NTQtMy45NjctMi42MDRjLTEuMTI0LTEuMTQ4LTIuMDA4LTIuNTY5LTIuNjUyLTQuMjY0DQoJCQlzLTAuOTY3LTMuNjU3LTAuOTY3LTUuODg4YzAtMS43MzUsMC4yODEtMy4zNjcsMC44NDMtNC44OTZjMC41NjItMS41MjgsMS4zNjctMi44NTksMi40MTctMy45OTENCgkJCWMxLjA0OS0xLjEzMiwyLjMzLTIuMDI4LDMuODQyLTIuNjg5QzEwNC4yNDUsODkuMDc4LDEwNS45NTEsODguNzQ3LDEwNy44NTIsODguNzQ3eiBNMTA3Ljk3Niw5My4xMzYNCgkJCWMtMS43ODUsMC0zLjE4MiwwLjUwNC00LjE5LDEuNTEyYy0xLjAwOCwxLjAwOS0xLjY1MywyLjQzOC0xLjkzNCw0LjI4OWgxMS41MDNjMC0wLjc5NC0wLjEwOC0xLjU0MS0wLjMyMi0yLjI0NA0KCQkJYy0wLjIxNS0wLjcwMi0wLjU0NS0xLjMxNy0wLjk5Mi0xLjg0N2MtMC40NDYtMC41MjgtMS4wMDgtMC45NDUtMS42ODYtMS4yNTJDMTA5LjY3Nyw5My4yODgsMTA4Ljg4NCw5My4xMzYsMTA3Ljk3Niw5My4xMzZ6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0xMjMuODQxLDExNC41NzlWODkuMTQ0aDMuNTk1YzAuNjI4LDAsMS4wNjYsMC4xMTYsMS4zMTMsMC4zNDhjMC4yNDgsMC4yMzEsMC40MTMsMC42MjgsMC40OTYsMS4xODkNCgkJCWwwLjM3MiwzLjA3NGMwLjkwOS0xLjU2OSwxLjk3NS0yLjgxLDMuMTk4LTMuNzE5YzEuMjIzLTAuOTA4LDIuNTk0LTEuMzYzLDQuMTE1LTEuMzYzYzEuMjU2LDAsMi4yOTcsMC4yODksMy4xMjQsMC44NjgNCgkJCWwtMC43OTQsNC41ODZjLTAuMDQ5LDAuMjk4LTAuMTU2LDAuNTA4LTAuMzIyLDAuNjMyYy0wLjE2NCwwLjEyNC0wLjM4OCwwLjE4Ny0wLjY2OCwwLjE4N2MtMC4yNDgsMC0wLjU4OC0wLjA1OC0xLjAxOC0wLjE3NA0KCQkJYy0wLjQzLTAuMTE1LTEtMC4xNzQtMS43MS0wLjE3NGMtMS4yNzMsMC0yLjM2NCwwLjM1Mi0zLjI3MiwxLjA1NGMtMC45MDksMC43MDMtMS42NzgsMS43MzEtMi4zMDYsMy4wODd2MTUuODQxSDEyMy44NDF6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0xNTkuMTkxLDk0LjEwM2MtMC4xNjUsMC4yNjQtMC4zMzksMC40NS0wLjUyMSwwLjU1OGMtMC4xODMsMC4xMDctMC40MTMsMC4xNjEtMC42OTQsMC4xNjENCgkJCWMtMC4yOTcsMC0wLjYxNS0wLjA4My0wLjk1NC0wLjI0OHMtMC43MzEtMC4zNTEtMS4xNzgtMC41NThzLTAuOTU0LTAuMzkzLTEuNTI0LTAuNTU4cy0xLjI0NC0wLjI0OC0yLjAyMS0wLjI0OA0KCQkJYy0xLjIwNiwwLTIuMTU3LDAuMjU2LTIuODUxLDAuNzY5Yy0wLjY5NCwwLjUxMi0xLjA0MSwxLjE4Mi0xLjA0MSwyLjAwOGMwLDAuNTQ1LDAuMTc3LDEuMDA0LDAuNTMzLDEuMzc2DQoJCQljMC4zNTQsMC4zNzIsMC44MjYsMC42OTgsMS40MTIsMC45NzljMC41ODcsMC4yODEsMS4yNTIsMC41MzMsMS45OTYsMC43NTdjMC43NDQsMC4yMjMsMS41MDQsMC40NjcsMi4yOCwwLjczMQ0KCQkJczEuNTM3LDAuNTY2LDIuMjgsMC45MDRjMC43NDQsMC4zMzksMS40MSwwLjc2OSwxLjk5NiwxLjI4OWMwLjU4NywwLjUyMSwxLjA1OCwxLjE0NSwxLjQxMywxLjg3MnMwLjUzMywxLjYwNCwwLjUzMywyLjYyOA0KCQkJYzAsMS4yMjMtMC4yMjQsMi4zNTEtMC42NjksMy4zODRjLTAuNDQ3LDEuMDMzLTEuMSwxLjkyNi0xLjk1OSwyLjY3N2MtMC44NTksMC43NTMtMS45MjEsMS4zMzktMy4xODYsMS43NjENCgkJCWMtMS4yNjQsMC40MjEtMi43MTUsMC42MzItNC4zNTEsMC42MzJjLTAuODc2LDAtMS43MzEtMC4wNzgtMi41NjUtMC4yMzVjLTAuODM1LTAuMTU3LTEuNjM3LTAuMzc2LTIuNDA1LTAuNjU3DQoJCQljLTAuNzY5LTAuMjgtMS40NzktMC42MTEtMi4xMzItMC45OTFjLTAuNjUzLTAuMzgtMS4yMjctMC43OTMtMS43MjMtMS4yMzlsMS40MTItMi4zMzFjMC4xODItMC4yOCwwLjM5Ny0wLjQ5NSwwLjY0NS0wLjY0NQ0KCQkJYzAuMjQ4LTAuMTQ4LDAuNTYyLTAuMjIzLDAuOTQzLTAuMjIzYzAuMzc5LDAsMC43MzgsMC4xMDcsMS4wNzgsMC4zMjJjMC4zMzgsMC4yMTUsMC43MywwLjQ0NiwxLjE3OCwwLjY5NA0KCQkJYzAuNDQ1LDAuMjQ4LDAuOTcxLDAuNDc5LDEuNTc0LDAuNjkzYzAuNjAzLDAuMjE2LDEuMzY3LDAuMzIyLDIuMjkzLDAuMzIyYzAuNzI3LDAsMS4zNTEtMC4wODYsMS44NzEtMC4yNg0KCQkJYzAuNTIxLTAuMTc0LDAuOTUtMC40LDEuMjg5LTAuNjgyczAuNTg2LTAuNjA3LDAuNzQ0LTAuOTc5YzAuMTU2LTAuMzcyLDAuMjM1LTAuNzU2LDAuMjM1LTEuMTUyYzAtMC41OTYtMC4xNzgtMS4wODMtMC41MzMtMS40NjMNCgkJCXMtMC44MjctMC43MTEtMS40MTMtMC45OTFjLTAuNTg2LTAuMjgxLTEuMjU2LTAuNTMzLTIuMDA4LTAuNzU3Yy0wLjc1Mi0wLjIyMy0xLjUyMS0wLjQ2Ny0yLjMwNi0wLjczMQ0KCQkJYy0wLjc4NS0wLjI2NC0xLjU1NC0wLjU3My0yLjMwNi0wLjkzYy0wLjc1Mi0wLjM1NC0xLjQyMi0wLjgwNi0yLjAwOC0xLjM1MWMtMC41ODctMC41NDYtMS4wNTgtMS4yMTUtMS40MTMtMi4wMDgNCgkJCWMtMC4zNTUtMC43OTQtMC41MzItMS43NTItMC41MzItMi44NzZjMC0xLjA0MSwwLjIwNS0yLjAzMywwLjYxOS0yLjk3NWMwLjQxMi0wLjk0MiwxLjAyLTEuNzY1LDEuODIyLTIuNDY3DQoJCQljMC44MDEtMC43MDIsMS44MDEtMS4yNjUsMy0xLjY4NmMxLjE5Ny0wLjQyMiwyLjU4Mi0wLjYzMyw0LjE1Mi0wLjYzM2MxLjc1MSwwLDMuMzQ2LDAuMjksNC43ODQsMC44NjgNCgkJCWMxLjQzOCwwLjU3OCwyLjYzNiwxLjMzOSwzLjU5NSwyLjI4TDE1OS4xOTEsOTQuMTAzeiIvPg0KCQk8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMTgzLjYzNSw5NC41MjNjLTAuMTgyLDAuMjMxLTAuMzU5LDAuNDEzLTAuNTMzLDAuNTQ2Yy0wLjE3NCwwLjEzMi0wLjQyNiwwLjE5OC0wLjc1NiwwLjE5OA0KCQkJYy0wLjMxNCwwLTAuNjItMC4wOTYtMC45MTgtMC4yODVjLTAuMjk3LTAuMTktMC42NTItMC40MDUtMS4wNjUtMC42NDVzLTAuOTA1LTAuNDU1LTEuNDc2LTAuNjQ1DQoJCQljLTAuNTctMC4xOS0xLjI3Ni0wLjI4NS0yLjExOS0wLjI4NWMtMS4wNzQsMC0yLjAxNywwLjE5NC0yLjgyNiwwLjU4MmMtMC44MTEsMC4zODktMS40ODMsMC45NDYtMi4wMjEsMS42NzQNCgkJCXMtMC45MzgsMS42MDctMS4yMDIsMi42NGMtMC4yNjUsMS4wMzMtMC4zOTYsMi4yMDMtMC4zOTYsMy41MDhjMCwxLjM1NSwwLjE0NSwyLjU2MiwwLjQzNCwzLjYyczAuNzA3LDEuOTQ2LDEuMjUyLDIuNjY1DQoJCQlzMS4yMDYsMS4yNjQsMS45ODMsMS42MzZjMC43NzYsMC4zNzIsMS42NTIsMC41NTgsMi42MjgsMC41NThjMC45NzUsMCwxLjc2NC0wLjExOSwyLjM2Ny0wLjM1OQ0KCQkJYzAuNjA0LTAuMjM5LDEuMTExLTAuNTA0LDEuNTI1LTAuNzkzYzAuNDEyLTAuMjg5LDAuNzcxLTAuNTU0LDEuMDc4LTAuNzkzYzAuMzA1LTAuMjQsMC42NDgtMC4zNiwxLjAyOC0wLjM2DQoJCQljMC40OTYsMCwwLjg2OCwwLjE5LDEuMTE2LDAuNTdsMS43NiwyLjIzMWMtMC42NzgsMC43OTMtMS40MTMsMS40NTktMi4yMDcsMS45OTZjLTAuNzkzLDAuNTM3LTEuNjE1LDAuOTY3LTIuNDY3LDEuMjg5DQoJCQljLTAuODUxLDAuMzIyLTEuNzMsMC41NDktMi42NCwwLjY4MmMtMC45MDksMC4xMzItMS44MSwwLjE5OC0yLjcwMiwwLjE5OGMtMS41NywwLTMuMDQ5LTAuMjk0LTQuNDM4LTAuODgNCgkJCWMtMS4zODktMC41ODctMi42LTEuNDQyLTMuNjMyLTIuNTY2Yy0xLjAzMy0xLjEyMy0xLjg1MS0yLjQ5OS0yLjQ1NC00LjEyN3MtMC45MDQtMy40ODMtMC45MDQtNS41NjYNCgkJCWMwLTEuODY3LDAuMjY4LTMuNTk4LDAuODA1LTUuMTkzYzAuNTM3LTEuNTk1LDEuMzI2LTIuOTc1LDIuMzY3LTQuMTRjMS4wNDItMS4xNjUsMi4zMzEtMi4wNzgsMy44NjgtMi43MzkNCgkJCWMxLjUzNi0wLjY2MSwzLjMwNi0wLjk5Miw1LjMwNi0wLjk5MmMxLjg5OSwwLDMuNTY0LDAuMzA3LDQuOTk0LDAuOTE4czIuNzE1LDEuNDg3LDMuODU1LDIuNjI3TDE4My42MzUsOTQuNTIzeiIvPg0KCQk8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMjAwLjI2OSw4OC43NDdjMS45LDAsMy42MjQsMC4zMDcsNS4xNjksMC45MThzMi44NjMsMS40NzksMy45NTQsMi42MDNzMS45MzQsMi40OTYsMi41MjgsNC4xMTUNCgkJCWMwLjU5NiwxLjYyLDAuODkzLDMuNDMsMC44OTMsNS40MjljMCwyLjAxNy0wLjI5NywzLjgzNS0wLjg5Myw1LjQ1NGMtMC41OTUsMS42Mi0xLjQzOCwzLTIuNTI4LDQuMTQxDQoJCQljLTEuMDkxLDEuMTQtMi40MDksMi4wMTctMy45NTQsMi42MjhjLTEuNTQ1LDAuNjEtMy4yNjksMC45MTctNS4xNjksMC45MTdzLTMuNjI4LTAuMzA3LTUuMTgxLTAuOTE3DQoJCQljLTEuNTU1LTAuNjExLTIuODgxLTEuNDg4LTMuOTc5LTIuNjI4Yy0xLjEtMS4xNDEtMS45NTEtMi41MjEtMi41NTUtNC4xNDFjLTAuNjA0LTEuNjE5LTAuOTA0LTMuNDM4LTAuOTA0LTUuNDU0DQoJCQljMC0xLjk5OSwwLjMwMS0zLjgwOSwwLjkwNC01LjQyOWMwLjYwNC0xLjYxOSwxLjQ1NS0yLjk5MSwyLjU1NS00LjExNWMxLjA5OC0xLjEyNCwyLjQyNC0xLjk5MSwzLjk3OS0yLjYwMw0KCQkJQzE5Ni42NDEsODkuMDU0LDE5OC4zNjgsODguNzQ3LDIwMC4yNjksODguNzQ3eiBNMjAwLjI2OSwxMTAuMjQxYzIuMTE2LDAsMy42ODItMC43MTEsNC42OTgtMi4xMzMNCgkJCWMxLjAxNi0xLjQyMSwxLjUyNC0zLjUwMywxLjUyNC02LjI0N2MwLTIuNzQzLTAuNTA5LTQuODM0LTEuNTI0LTYuMjcxYy0xLjAxNy0xLjQzOC0yLjU4Mi0yLjE1Ny00LjY5OC0yLjE1Nw0KCQkJYy0yLjE0OCwwLTMuNzM1LDAuNzI0LTQuNzYsMi4xNjljLTEuMDI0LDEuNDQ2LTEuNTM2LDMuNTMzLTEuNTM2LDYuMjZjMCwyLjcyOCwwLjUxMiw0LjgwNiwxLjUzNiw2LjIzNQ0KCQkJUzE5OC4xMiwxMTAuMjQxLDIwMC4yNjksMTEwLjI0MXoiLz4NCgkJPHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0iTTIxNy41OTgsMTE0LjU3OVY4OS4xNDRoMy41OTRjMC42MjksMCwxLjA2NiwwLjExNiwxLjMxNCwwLjM0OHMwLjQxMiwwLjYyOCwwLjQ5NiwxLjE4OWwwLjM3MSwzLjA3NA0KCQkJYzAuOTA5LTEuNTY5LDEuOTc1LTIuODEsMy4xOTgtMy43MTljMS4yMjMtMC45MDgsMi41OTUtMS4zNjMsNC4xMTQtMS4zNjNjMS4yNTYsMCwyLjI5OSwwLjI4OSwzLjEyNSwwLjg2OGwtMC43OTMsNC41ODYNCgkJCWMtMC4wNTEsMC4yOTgtMC4xNTgsMC41MDgtMC4zMjIsMC42MzJjLTAuMTY2LDAuMTI0LTAuMzg5LDAuMTg3LTAuNjcsMC4xODdjLTAuMjQ4LDAtMC41ODgtMC4wNTgtMS4wMTgtMC4xNzQNCgkJCWMtMC40My0wLjExNS0wLjk5OS0wLjE3NC0xLjcwOS0wLjE3NGMtMS4yNzMsMC0yLjM2NCwwLjM1Mi0zLjI3MywxLjA1NGMtMC45MDgsMC43MDMtMS42NzgsMS43MzEtMi4zMDUsMy4wODd2MTUuODQxSDIxNy41OTh6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0yNDguMzYxLDg4Ljc0N2MxLjYwNCwwLDMuMDc4LDAuMjU3LDQuNDI2LDAuNzY5YzEuMzQ3LDAuNTEzLDIuNTA4LDEuMjYxLDMuNDgyLDIuMjQ0DQoJCQljMC45NzYsMC45ODMsMS43MzUsMi4xODksMi4yODEsMy42MTljMC41NDUsMS40MywwLjgxOCwzLjA2MiwwLjgxOCw0Ljg5NmMwLDAuNDYzLTAuMDIxLDAuODQ3LTAuMDYyLDEuMTUyDQoJCQlzLTAuMTE2LDAuNTQ1LTAuMjIzLDAuNzE5Yy0wLjEwOCwwLjE3NC0wLjI1MywwLjI5OC0wLjQzNSwwLjM3MnMtMC40MTMsMC4xMTEtMC42OTMsMC4xMTFoLTE1LjcxOA0KCQkJYzAuMTgyLDIuNjExLDAuODg0LDQuNTI4LDIuMTA3LDUuNzUyYzEuMjIzLDEuMjIzLDIuODQzLDEuODM0LDQuODU4LDEuODM0YzAuOTkyLDAsMS44NDgtMC4xMTUsMi41NjYtMC4zNDcNCgkJCXMxLjM0Ny0wLjQ4NywxLjg4NC0wLjc2OXMxLjAwOC0wLjUzNywxLjQxMy0wLjc2OXMwLjc5Ny0wLjM0OCwxLjE3OC0wLjM0OGMwLjI0OCwwLDAuNDYzLDAuMDUsMC42NDUsMC4xNDkNCgkJCWMwLjE4MiwwLjA5OSwwLjMzOSwwLjIzOSwwLjQ3MSwwLjQyMWwxLjc4NSwyLjIzMWMtMC42NzgsMC43OTMtMS40MzgsMS40NTktMi4yOCwxLjk5NmMtMC44NDQsMC41MzctMS43MjQsMC45NjctMi42NDEsMS4yODkNCgkJCXMtMS44NTIsMC41NDktMi44MDIsMC42ODJjLTAuOTUsMC4xMzItMS44NzEsMC4xOTgtMi43NjQsMC4xOThjLTEuNzY5LDAtMy40MTMtMC4yOTQtNC45MzQtMC44OA0KCQkJYy0xLjUyMS0wLjU4Ny0yLjg0My0xLjQ1NC0zLjk2Ni0yLjYwNGMtMS4xMjUtMS4xNDgtMi4wMDktMi41NjktMi42NTMtNC4yNjRzLTAuOTY3LTMuNjU3LTAuOTY3LTUuODg4DQoJCQljMC0xLjczNSwwLjI4MS0zLjM2NywwLjg0My00Ljg5NmMwLjU2Mi0xLjUyOCwxLjM2OC0yLjg1OSwyLjQxNy0zLjk5MWMxLjA1LTEuMTMyLDIuMzMxLTIuMDI4LDMuODQzLTIuNjg5DQoJCQlDMjQ0Ljc1NSw4OS4wNzgsMjQ2LjQ2MSw4OC43NDcsMjQ4LjM2MSw4OC43NDd6IE0yNDguNDg1LDkzLjEzNmMtMS43ODQsMC0zLjE4MiwwLjUwNC00LjE4OSwxLjUxMg0KCQkJYy0xLjAwOCwxLjAwOS0xLjY1MiwyLjQzOC0xLjkzNCw0LjI4OWgxMS41MDNjMC0wLjc5NC0wLjEwNy0xLjU0MS0wLjMyMi0yLjI0NGMtMC4yMTUtMC43MDItMC41NDYtMS4zMTctMC45OTEtMS44NDcNCgkJCWMtMC40NDYtMC41MjgtMS4wMDktMC45NDUtMS42ODctMS4yNTJDMjUwLjE4OCw5My4yODgsMjQ5LjM5NSw5My4xMzYsMjQ4LjQ4NSw5My4xMzZ6Ii8+DQoJPC9nPg0KCTxwYXRoIGlkPSJJY29uIiBmaWxsPSIjRkZGRkZGIiBkPSJNMTcxLjkyNiwxOS43MDdjLTAuNTAyLTYuNjM5LTYuOTQzLTEyLjYxOC0xNC4wMjktMTMuMDZjLTE1LjA5Mi0wLjg1OS0zMC4xODQtMC44NTktNDUuMjc0LDANCgkJYy03LjA4NywwLjQ0Mi0xMy41MjksNi40MjEtMTQuMDMyLDEzLjA2MWMtMC45MDksMTMuMTI0LTAuOTA5LDI2LjI0OCwwLDM5LjM3MmMwLjUwMyw2LjY0MSw2Ljk0NSwxMi42MTgsMTQuMDMyLDEzLjA2MQ0KCQljMTUuMDkyLDAuODU4LDMwLjE4MywwLjg1OCw0NS4yNzQsMGM3LjA4Ni0wLjQ0MSwxMy41MjctNi40MiwxNC4wMjktMTMuMDYxQzE3Mi44MzUsNDUuOTU0LDE3Mi44MzUsMzIuODMsMTcxLjkyNiwxOS43MDd6DQoJCSBNMTM4Ljg0OCw1Ni43MDNoLTI0Ljc3MXYtNC42OTloMjQuNzcxVjU2LjcwM3ogTTE1NS42MzUsNTYuMTg2Yy0wLjM2NywwLjM2Ny0wLjc5NCwwLjY1NC0xLjI3OSwwLjg1OQ0KCQljLTAuNDg4LDAuMjA0LTEuMDAyLDAuMzA4LTEuNTQxLDAuMzA4Yy0wLjU0MSwwLTEuMDQ5LTAuMTA0LTEuNTIzLTAuMzA4Yy0wLjQ3Ny0wLjIwNS0wLjg5Ni0wLjQ5Mi0xLjI2NC0wLjg1OQ0KCQljLTAuMzY5LTAuMzY3LTAuNjUzLTAuNzg5LTAuODU4LTEuMjYyYy0wLjIwNi0wLjQ3OC0wLjMxLTAuOTg2LTAuMzEtMS41MjdjMC0wLjUzOSwwLjEwNC0xLjA1MywwLjMxLTEuNTM5DQoJCWMwLjIwNS0wLjQ4NiwwLjQ4OS0wLjkxMywwLjg1OC0xLjI4YzAuNzU2LTAuNzU4LDEuNjg3LTEuMTM1LDIuNzg3LTEuMTM1YzAuNTM5LDAsMS4wNTMsMC4wOTgsMS41NDEsMC4yOTMNCgkJYzAuNDg1LDAuMTk0LDAuOTEyLDAuNDc1LDEuMjc5LDAuODQyYzAuNzU2LDAuNzU3LDEuMTM1LDEuNjk2LDEuMTM1LDIuODE5QzE1Ni43Nyw1NC41LDE1Ni4zOTEsNTUuNDMxLDE1NS42MzUsNTYuMTg2eiIvPg0KPC9nPg0KPC9zdmc+DQo=" alt="Underscore">
</div>
</div>
</div>
</header>

<div class="container">

<nav class="toc">
<div class="toc-contents">
<p class="text-center">Scala with Cats</p>

<p class="text-center">Copyright 2014-17 Noel Welsh and Dave Gurnell.</p>

<p class="text-center">Published by <a href="http://underscore.io">Underscore Consulting LLP</a>, Brighton, UK.</p>

<hr>


<h1>Contents</h1>
<ul>
<li><a href="#preface">Preface</a><ul>
<li><a href="#versions">Versions</a><ul>
<li><a href="#template-projects">Template Projects</a></li>
</ul></li>
<li><a href="#conventions-used-in-this-book">Conventions Used in This Book</a><ul>
<li><a href="#typographical-conventions">Typographical Conventions</a></li>
<li><a href="#source-code">Source Code</a></li>
<li><a href="#callout-boxes">Callout Boxes</a></li>
</ul></li>
<li><a href="#acknowledgements">Acknowledgements</a><ul>
<li><a href="#backers">Backers</a></li>
</ul></li>
</ul></li>
<li><a href="#sec:type-classes"><span class="toc-section-number">1</span> Introduction</a><ul>
<li><a href="#anatomy-of-a-type-class"><span class="toc-section-number">1.1</span> Anatomy of a Type Class</a><ul>
<li><a href="#the-type-class"><span class="toc-section-number">1.1.1</span> The Type Class</a></li>
<li><a href="#type-class-instances"><span class="toc-section-number">1.1.2</span> Type Class Instances</a></li>
<li><a href="#type-class-interfaces"><span class="toc-section-number">1.1.3</span> Type Class Interfaces</a></li>
</ul></li>
<li><a href="#working-with-implicits"><span class="toc-section-number">1.2</span> Working with Implicits</a><ul>
<li><a href="#packaging-implicits"><span class="toc-section-number">1.2.1</span> Packaging Implicits</a></li>
<li><a href="#implicit-scope"><span class="toc-section-number">1.2.2</span> Implicit Scope</a></li>
<li><a href="#sec:type-classes:recursive-implicits"><span class="toc-section-number">1.2.3</span> Recursive Implicit Resolution</a></li>
</ul></li>
<li><a href="#exercise-printable-library"><span class="toc-section-number">1.3</span> Exercise: Printable Library</a></li>
<li><a href="#meet-cats"><span class="toc-section-number">1.4</span> Meet Cats</a><ul>
<li><a href="#importing-type-classes"><span class="toc-section-number">1.4.1</span> Importing Type Classes</a></li>
<li><a href="#importing-default-instances"><span class="toc-section-number">1.4.2</span> Importing Default Instances</a></li>
<li><a href="#importing-interface-syntax"><span class="toc-section-number">1.4.3</span> Importing Interface Syntax</a></li>
<li><a href="#importing-all-the-things"><span class="toc-section-number">1.4.4</span> Importing All The Things!</a></li>
<li><a href="#defining-custom-instances"><span class="toc-section-number">1.4.5</span> Defining Custom Instances</a></li>
<li><a href="#exercise-cat-show"><span class="toc-section-number">1.4.6</span> Exercise: Cat Show</a></li>
</ul></li>
<li><a href="#example-eq"><span class="toc-section-number">1.5</span> Example: Eq</a><ul>
<li><a href="#equality-liberty-and-fraternity"><span class="toc-section-number">1.5.1</span> Equality, Liberty, and Fraternity</a></li>
<li><a href="#comparing-ints"><span class="toc-section-number">1.5.2</span> Comparing Ints</a></li>
<li><a href="#sec:type-classes:comparing-options"><span class="toc-section-number">1.5.3</span> Comparing Options</a></li>
<li><a href="#comparing-custom-types"><span class="toc-section-number">1.5.4</span> Comparing Custom Types</a></li>
<li><a href="#exercise-equality-liberty-and-felinity"><span class="toc-section-number">1.5.5</span> Exercise: Equality, Liberty, and Felinity</a></li>
</ul></li>
<li><a href="#controlling-instance-selection"><span class="toc-section-number">1.6</span> Controlling Instance Selection</a><ul>
<li><a href="#sec:variance"><span class="toc-section-number">1.6.1</span> Variance</a></li>
</ul></li>
<li><a href="#summary"><span class="toc-section-number">1.7</span> Summary</a></li>
</ul></li>
<li><a href="#sec:monoids"><span class="toc-section-number">2</span> Monoids and Semigroups</a><ul>
<li><a href="#definition-of-a-monoid"><span class="toc-section-number">2.1</span> Definition of a Monoid</a></li>
<li><a href="#definition-of-a-semigroup"><span class="toc-section-number">2.2</span> Definition of a Semigroup</a></li>
<li><a href="#exercise-the-truth-about-monoids"><span class="toc-section-number">2.3</span> Exercise: The Truth About Monoids</a></li>
<li><a href="#exercise-all-set-for-monoids"><span class="toc-section-number">2.4</span> Exercise: All Set for Monoids</a></li>
<li><a href="#monoids-in-cats"><span class="toc-section-number">2.5</span> Monoids in Cats</a><ul>
<li><a href="#the-monoid-type-class"><span class="toc-section-number">2.5.1</span> The Monoid Type Class</a></li>
<li><a href="#sec:monoid-instances"><span class="toc-section-number">2.5.2</span> Monoid Instances</a></li>
<li><a href="#sec:monoid-syntax"><span class="toc-section-number">2.5.3</span> Monoid Syntax</a></li>
<li><a href="#exercise-adding-all-the-things"><span class="toc-section-number">2.5.4</span> Exercise: Adding All The Things</a></li>
</ul></li>
<li><a href="#applications-of-monoids"><span class="toc-section-number">2.6</span> Applications of Monoids</a><ul>
<li><a href="#big-data"><span class="toc-section-number">2.6.1</span> Big Data</a></li>
<li><a href="#distributed-systems"><span class="toc-section-number">2.6.2</span> Distributed Systems</a></li>
<li><a href="#monoids-in-the-small"><span class="toc-section-number">2.6.3</span> Monoids in the Small</a></li>
</ul></li>
<li><a href="#summary-1"><span class="toc-section-number">2.7</span> Summary</a></li>
</ul></li>
<li><a href="#functors"><span class="toc-section-number">3</span> Functors</a><ul>
<li><a href="#sec:functors:examples"><span class="toc-section-number">3.1</span> Examples of Functors</a></li>
<li><a href="#sec:functors:more-examples"><span class="toc-section-number">3.2</span> More Examples of Functors</a></li>
<li><a href="#definition-of-a-functor"><span class="toc-section-number">3.3</span> Definition of a Functor</a></li>
<li><a href="#aside-higher-kinds-and-type-constructors"><span class="toc-section-number">3.4</span> Aside: Higher Kinds and Type Constructors</a></li>
<li><a href="#functors-in-cats"><span class="toc-section-number">3.5</span> Functors in Cats</a><ul>
<li><a href="#the-functor-type-class"><span class="toc-section-number">3.5.1</span> The Functor Type Class</a></li>
<li><a href="#functor-syntax"><span class="toc-section-number">3.5.2</span> Functor Syntax</a></li>
<li><a href="#instances-for-custom-types"><span class="toc-section-number">3.5.3</span> Instances for Custom Types</a></li>
<li><a href="#exercise-branching-out-with-functors"><span class="toc-section-number">3.5.4</span> Exercise: Branching out with Functors</a></li>
</ul></li>
<li><a href="#contravariant-invariant"><span class="toc-section-number">3.6</span> <em>Contravariant</em> and Invariant Functors</a><ul>
<li><a href="#contravariant"><span class="toc-section-number">3.6.1</span> Contravariant Functors and the <em>contramap</em> Method</a></li>
<li><a href="#sec:functors:invariant"><span class="toc-section-number">3.6.2</span> Invariant functors and the <em>imap</em> method</a></li>
</ul></li>
<li><a href="#contravariant-and-invariant-in-cats"><span class="toc-section-number">3.7</span> <em>Contravariant</em> and Invariant in Cats</a><ul>
<li><a href="#contravariant-in-cats"><span class="toc-section-number">3.7.1</span> Contravariant in Cats</a></li>
<li><a href="#invariant-in-cats"><span class="toc-section-number">3.7.2</span> Invariant in Cats</a></li>
</ul></li>
<li><a href="#sec:functors:partial-unification"><span class="toc-section-number">3.8</span> Aside: Partial Unification</a><ul>
<li><a href="#unifying-type-constructors"><span class="toc-section-number">3.8.1</span> Unifying Type Constructors</a></li>
<li><a href="#left-to-right-elimination"><span class="toc-section-number">3.8.2</span> Left-to-Right Elimination</a></li>
</ul></li>
<li><a href="#summary-2"><span class="toc-section-number">3.9</span> Summary</a></li>
</ul></li>
<li><a href="#sec:monads"><span class="toc-section-number">4</span> Monads</a><ul>
<li><a href="#what-is-a-monad"><span class="toc-section-number">4.1</span> What is a Monad?</a><ul>
<li><a href="#definition-of-a-monad"><span class="toc-section-number">4.1.1</span> Definition of a Monad</a></li>
<li><a href="#exercise-getting-func-y"><span class="toc-section-number">4.1.2</span> Exercise: Getting Func-y</a></li>
</ul></li>
<li><a href="#monads-in-cats"><span class="toc-section-number">4.2</span> Monads in Cats</a><ul>
<li><a href="#monad-type-class"><span class="toc-section-number">4.2.1</span> The Monad Type Class</a></li>
<li><a href="#default-instances"><span class="toc-section-number">4.2.2</span> Default Instances</a></li>
<li><a href="#monad-syntax"><span class="toc-section-number">4.2.3</span> Monad Syntax</a></li>
</ul></li>
<li><a href="#sec:monads:identity"><span class="toc-section-number">4.3</span> The Identity Monad</a><ul>
<li><a href="#exercise-monadic-secret-identities"><span class="toc-section-number">4.3.1</span> Exercise: Monadic Secret Identities</a></li>
</ul></li>
<li><a href="#either"><span class="toc-section-number">4.4</span> Either</a><ul>
<li><a href="#left-and-right-bias"><span class="toc-section-number">4.4.1</span> Left and Right Bias</a></li>
<li><a href="#creating-instances"><span class="toc-section-number">4.4.2</span> Creating Instances</a></li>
<li><a href="#transforming-eithers"><span class="toc-section-number">4.4.3</span> Transforming Eithers</a></li>
<li><a href="#error-handling"><span class="toc-section-number">4.4.4</span> Error Handling</a></li>
<li><a href="#exercise-what-is-best"><span class="toc-section-number">4.4.5</span> Exercise: What is Best?</a></li>
</ul></li>
<li><a href="#aside-error-handling-and-monaderror"><span class="toc-section-number">4.5</span> Aside: Error Handling and MonadError</a><ul>
<li><a href="#the-monaderror-type-class"><span class="toc-section-number">4.5.1</span> The MonadError Type Class</a></li>
<li><a href="#raising-and-handling-errors"><span class="toc-section-number">4.5.2</span> Raising and Handling Errors</a></li>
<li><a href="#instances-of-monaderror"><span class="toc-section-number">4.5.3</span> Instances of MonadError</a></li>
<li><a href="#exercise-abstracting"><span class="toc-section-number">4.5.4</span> Exercise: Abstracting</a></li>
</ul></li>
<li><a href="#sec:monads:eval"><span class="toc-section-number">4.6</span> The Eval Monad</a><ul>
<li><a href="#eager-lazy-memoized-oh-my"><span class="toc-section-number">4.6.1</span> Eager, Lazy, Memoized, Oh My!</a></li>
<li><a href="#evals-models-of-evaluation"><span class="toc-section-number">4.6.2</span> Eval’s Models of Evaluation</a></li>
<li><a href="#eval-as-a-monad"><span class="toc-section-number">4.6.3</span> Eval as a Monad</a></li>
<li><a href="#trampolining-and-eval.defer"><span class="toc-section-number">4.6.4</span> Trampolining and <em>Eval.defer</em></a></li>
<li><a href="#exercise-safer-folding-using-eval"><span class="toc-section-number">4.6.5</span> Exercise: Safer Folding using Eval</a></li>
</ul></li>
<li><a href="#writer-monad"><span class="toc-section-number">4.7</span> The Writer Monad</a><ul>
<li><a href="#creating-and-unpacking-writers"><span class="toc-section-number">4.7.1</span> Creating and Unpacking Writers</a></li>
<li><a href="#composing-and-transforming-writers"><span class="toc-section-number">4.7.2</span> Composing and Transforming Writers</a></li>
<li><a href="#exercise-show-your-working"><span class="toc-section-number">4.7.3</span> Exercise: Show Your Working</a></li>
</ul></li>
<li><a href="#sec:monads:reader"><span class="toc-section-number">4.8</span> The Reader Monad</a><ul>
<li><a href="#creating-and-unpacking-readers"><span class="toc-section-number">4.8.1</span> Creating and Unpacking Readers</a></li>
<li><a href="#composing-readers"><span class="toc-section-number">4.8.2</span> Composing Readers</a></li>
<li><a href="#exercise-hacking-on-readers"><span class="toc-section-number">4.8.3</span> Exercise: Hacking on Readers</a></li>
<li><a href="#when-to-use-readers"><span class="toc-section-number">4.8.4</span> When to Use Readers?</a></li>
</ul></li>
<li><a href="#the-state-monad"><span class="toc-section-number">4.9</span> The State Monad</a><ul>
<li><a href="#creating-and-unpacking-state"><span class="toc-section-number">4.9.1</span> Creating and Unpacking State</a></li>
<li><a href="#composing-and-transforming-state"><span class="toc-section-number">4.9.2</span> Composing and Transforming State</a></li>
<li><a href="#exercise-post-order-calculator"><span class="toc-section-number">4.9.3</span> Exercise: Post-Order Calculator</a></li>
</ul></li>
<li><a href="#defining-custom-monads"><span class="toc-section-number">4.10</span> Defining Custom Monads</a><ul>
<li><a href="#exercise-branching-out-further-with-monads"><span class="toc-section-number">4.10.1</span> Exercise: Branching out Further with Monads</a></li>
</ul></li>
<li><a href="#summary-3"><span class="toc-section-number">4.11</span> Summary</a></li>
</ul></li>
<li><a href="#sec:monad-transformers"><span class="toc-section-number">5</span> Monad Transformers</a><ul>
<li><a href="#exercise-composing-monads"><span class="toc-section-number">5.1</span> Exercise: Composing Monads</a></li>
<li><a href="#a-transformative-example"><span class="toc-section-number">5.2</span> A Transformative Example</a></li>
<li><a href="#monad-transformers-in-cats"><span class="toc-section-number">5.3</span> Monad Transformers in Cats</a><ul>
<li><a href="#the-monad-transformer-classes"><span class="toc-section-number">5.3.1</span> The Monad Transformer Classes</a></li>
<li><a href="#building-monad-stacks"><span class="toc-section-number">5.3.2</span> Building Monad Stacks</a></li>
<li><a href="#constructing-and-unpacking-instances"><span class="toc-section-number">5.3.3</span> Constructing and Unpacking Instances</a></li>
<li><a href="#default-instances-1"><span class="toc-section-number">5.3.4</span> Default Instances</a></li>
<li><a href="#usage-patterns"><span class="toc-section-number">5.3.5</span> Usage Patterns</a></li>
</ul></li>
<li><a href="#exercise-monads-transform-and-roll-out"><span class="toc-section-number">5.4</span> Exercise: Monads: Transform and Roll Out</a></li>
<li><a href="#summary-4"><span class="toc-section-number">5.5</span> Summary</a></li>
</ul></li>
<li><a href="#sec:applicatives"><span class="toc-section-number">6</span> Semigroupal and Applicative</a><ul>
<li><a href="#semigroupal"><span class="toc-section-number">6.1</span> Semigroupal</a><ul>
<li><a href="#joining-two-contexts"><span class="toc-section-number">6.1.1</span> Joining Two Contexts</a></li>
<li><a href="#joining-three-or-more-contexts"><span class="toc-section-number">6.1.2</span> Joining Three or More Contexts</a></li>
</ul></li>
<li><a href="#apply-syntax"><span class="toc-section-number">6.2</span> Apply Syntax</a><ul>
<li><a href="#fancy-functors-and-apply-syntax"><span class="toc-section-number">6.2.1</span> Fancy Functors and Apply Syntax</a></li>
</ul></li>
<li><a href="#semigroupal-applied-to-different-types"><span class="toc-section-number">6.3</span> Semigroupal Applied to Different Types</a><ul>
<li><a href="#semigroupal-applied-to-monads"><span class="toc-section-number">6.3.1</span> Semigroupal Applied to Monads</a></li>
</ul></li>
<li><a href="#validated"><span class="toc-section-number">6.4</span> Validated</a><ul>
<li><a href="#creating-instances-of-validated"><span class="toc-section-number">6.4.1</span> Creating Instances of Validated</a></li>
<li><a href="#combining-instances-of-validated"><span class="toc-section-number">6.4.2</span> Combining Instances of Validated</a></li>
<li><a href="#methods-of-validated"><span class="toc-section-number">6.4.3</span> Methods of Validated</a></li>
<li><a href="#exercise-form-validation"><span class="toc-section-number">6.4.4</span> Exercise: Form Validation</a></li>
</ul></li>
<li><a href="#apply-and-applicative"><span class="toc-section-number">6.5</span> Apply and Applicative</a><ul>
<li><a href="#the-hierarchy-of-sequencing-type-classes"><span class="toc-section-number">6.5.1</span> The Hierarchy of Sequencing Type Classes</a></li>
</ul></li>
<li><a href="#summary-5"><span class="toc-section-number">6.6</span> Summary</a></li>
</ul></li>
<li><a href="#sec:foldable-traverse"><span class="toc-section-number">7</span> Foldable and Traverse</a><ul>
<li><a href="#sec:foldable"><span class="toc-section-number">7.1</span> Foldable</a><ul>
<li><a href="#folds-and-folding"><span class="toc-section-number">7.1.1</span> Folds and Folding</a></li>
<li><a href="#exercise-reflecting-on-folds"><span class="toc-section-number">7.1.2</span> Exercise: Reflecting on Folds</a></li>
<li><a href="#exercise-scaf-fold-ing-other-methods"><span class="toc-section-number">7.1.3</span> Exercise: Scaf-fold-ing Other Methods</a></li>
<li><a href="#foldable-in-cats"><span class="toc-section-number">7.1.4</span> Foldable in Cats</a></li>
</ul></li>
<li><a href="#sec:traverse"><span class="toc-section-number">7.2</span> Traverse</a><ul>
<li><a href="#traversing-with-futures"><span class="toc-section-number">7.2.1</span> Traversing with Futures</a></li>
<li><a href="#traversing-with-applicatives"><span class="toc-section-number">7.2.2</span> Traversing with Applicatives</a></li>
<li><a href="#traverse-in-cats"><span class="toc-section-number">7.2.3</span> Traverse in Cats</a></li>
</ul></li>
<li><a href="#summary-6"><span class="toc-section-number">7.3</span> Summary</a></li>
</ul></li>
<li><a href="#sec:case-studies:testing"><span class="toc-section-number">8</span> Case Study: Testing Asynchronous Code</a><ul>
<li><a href="#abstracting-over-type-constructors"><span class="toc-section-number">8.1</span> Abstracting over Type Constructors</a></li>
<li><a href="#abstracting-over-monads"><span class="toc-section-number">8.2</span> Abstracting over Monads</a></li>
<li><a href="#summary-7"><span class="toc-section-number">8.3</span> Summary</a></li>
</ul></li>
<li><a href="#map-reduce"><span class="toc-section-number">9</span> Case Study: Map-Reduce</a><ul>
<li><a href="#parallelizing-map-and-fold"><span class="toc-section-number">9.1</span> Parallelizing <em>map</em> and <em>fold</em></a></li>
<li><a href="#implementing-foldmap"><span class="toc-section-number">9.2</span> Implementing <em>foldMap</em></a></li>
<li><a href="#parallelising-foldmap"><span class="toc-section-number">9.3</span> Parallelising <em>foldMap</em></a><ul>
<li><a href="#futures-thread-pools-and-executioncontexts"><span class="toc-section-number">9.3.1</span> <em>Futures</em>, Thread Pools, and ExecutionContexts</a></li>
<li><a href="#dividing-work"><span class="toc-section-number">9.3.2</span> Dividing Work</a></li>
<li><a href="#implementing-parallelfoldmap"><span class="toc-section-number">9.3.3</span> Implementing <em>parallelFoldMap</em></a></li>
<li><a href="#parallelfoldmap-with-more-cats"><span class="toc-section-number">9.3.4</span> <em>parallelFoldMap</em> with more Cats</a></li>
</ul></li>
<li><a href="#summary-8"><span class="toc-section-number">9.4</span> Summary</a></li>
</ul></li>
<li><a href="#case-study-data-validation"><span class="toc-section-number">10</span> Case Study: Data Validation</a><ul>
<li><a href="#sketching-the-library-structure"><span class="toc-section-number">10.1</span> Sketching the Library Structure</a></li>
<li><a href="#the-check-datatype"><span class="toc-section-number">10.2</span> The Check Datatype</a></li>
<li><a href="#basic-combinators"><span class="toc-section-number">10.3</span> Basic Combinators</a></li>
<li><a href="#transforming-data"><span class="toc-section-number">10.4</span> Transforming Data</a><ul>
<li><a href="#predicates"><span class="toc-section-number">10.4.1</span> Predicates</a></li>
<li><a href="#checks"><span class="toc-section-number">10.4.2</span> Checks</a></li>
<li><a href="#recap"><span class="toc-section-number">10.4.3</span> Recap</a></li>
</ul></li>
<li><a href="#kleislis"><span class="toc-section-number">10.5</span> Kleislis</a></li>
<li><a href="#summary-9"><span class="toc-section-number">10.6</span> Summary</a></li>
</ul></li>
<li><a href="#case-study-crdts"><span class="toc-section-number">11</span> Case Study: CRDTs</a><ul>
<li><a href="#eventual-consistency"><span class="toc-section-number">11.1</span> Eventual Consistency</a></li>
<li><a href="#the-gcounter"><span class="toc-section-number">11.2</span> The GCounter</a><ul>
<li><a href="#simple-counters"><span class="toc-section-number">11.2.1</span> Simple Counters</a></li>
<li><a href="#gcounters"><span class="toc-section-number">11.2.2</span> GCounters</a></li>
<li><a href="#exercise-gcounter-implementation"><span class="toc-section-number">11.2.3</span> Exercise: GCounter Implementation</a></li>
</ul></li>
<li><a href="#generalisation"><span class="toc-section-number">11.3</span> Generalisation</a><ul>
<li><a href="#implementation"><span class="toc-section-number">11.3.1</span> Implementation</a></li>
<li><a href="#exercise-boundedsemilattice-instances"><span class="toc-section-number">11.3.2</span> Exercise: BoundedSemiLattice Instances</a></li>
<li><a href="#exercise-generic-gcounter"><span class="toc-section-number">11.3.3</span> Exercise: Generic GCounter</a></li>
</ul></li>
<li><a href="#abstracting-gcounter-to-a-type-class"><span class="toc-section-number">11.4</span> Abstracting GCounter to a Type Class</a></li>
<li><a href="#abstracting-a-key-value-store"><span class="toc-section-number">11.5</span> Abstracting a Key Value Store</a></li>
<li><a href="#summary-10"><span class="toc-section-number">11.6</span> Summary</a></li>
</ul></li>
</ul>
</div>
<p class="toc-toggle">
  <a href="javascript:void 0" class="btn btn-default btn-block">Show cover notes and table of contents</a>
</p>
</nav>

<article>
<h1 id="preface" class="unnumbered">Preface</h1>
<p>The aims of this book are two-fold: to introduce monads, functors, and other functional programming patterns as a way to structure program design, and to explain how these concepts are implemented in <a href="http://typelevel.org/cats">Cats</a>.</p>
<p>Monads, and related concepts, are the functional programming equivalent of object-oriented design patterns—architectural building blocks that turn up over and over again in code. They differ from object-oriented patterns in two main ways:</p>
<ul>
<li>they are formally, and thus precisely, defined; and</li>
<li>they are extremely (extremely) general.</li>
</ul>
<p>This generality means they can be difficult to understand. <em>Everyone</em> finds abstraction difficult. However, it is generality that allows concepts like monads to be applied in such a wide variety of situations.</p>
<p>In this book we aim to show the concepts in a number of different ways, to help you build a mental model of how they work and where they are appropriate. We have extended case studies, a simple graphical notation, many smaller examples, and of course the mathematical definitions. Between them we hope you’ll find something that works for you.</p>
<p>Ok, let’s get started!</p>
<h2 id="versions" class="unnumbered">Versions</h2>
<p>This book is written for Scala 2.12.3 and Cats 1.0.0. Here is a minimal <code>build.sbt</code> containing the relevant dependencies and settings<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scalaVersion := <span class="st">&quot;2.12.3&quot;</span>

libraryDependencies +=
  <span class="st">&quot;org.typelevel&quot;</span> %% <span class="st">&quot;cats-core&quot;</span> % <span class="st">&quot;1.0.0&quot;</span>

scalacOptions ++= Seq(
  <span class="st">&quot;-Xfatal-warnings&quot;</span>,
  <span class="st">&quot;-Ypartial-unification&quot;</span>
)</code></pre></div>
<h3 id="template-projects" class="unnumbered">Template Projects</h3>
<p>For convenience, we have created a Giter8 template to get you started. To clone the template type the following:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">sbt</span> new underscoreio/cats-seed.g8</code></pre></div>
<p>This will generate a sandbox project with Cats as a dependency. See the generated <code>README.md</code> for instructions on how to run the sample code and/or start an interactive Scala console.</p>
<p>The <code>cats-seed</code> template is as minimal as it gets. If you’d prefer a more batteries-included starting point, check out Typelevel’s <code>sbt-catalysts</code> template:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">sbt</span> new typelevel/sbt-catalysts.g8</code></pre></div>
<p>This will generate a project with a suite of library dependencies and compiler plugins, together with templates for unit tests and <a href="https://github.com/tpolecat/tut">tut-enabled</a> documentation. See the project pages for <a href="https://github.com/typelevel/catalysts">catalysts</a> and <a href="https://github.com/typelevel/sbt-catalysts">sbt-catalysts</a> for more information.</p>
<h2 id="conventions-used-in-this-book" class="unnumbered">Conventions Used in This Book</h2>
<p>This book contains a lot of technical information and program code. We use the following typographical conventions to reduce ambiguity and highlight important concepts:</p>
<h3 id="typographical-conventions" class="unnumbered">Typographical Conventions</h3>
<p>New terms and phrases are introduced in <em>italics</em>. After their initial introduction they are written in normal roman font.</p>
<p>Terms from program code, filenames, and file contents, are written in <code>monospace font</code>. Note that we do not distinguish between singular and plural forms. For example, we might write <code>String</code> or <code>Strings</code> to refer to <code>java.lang.String</code>.</p>
<p>References to external resources are written as <a href="https://underscore.io">hyperlinks</a>. References to API documentation are written using a combination of hyperlinks and monospace font, for example: <a href="http://www.scala-lang.org/api/current/scala/Option.html"><code>scala.Option</code></a>.</p>
<h3 id="source-code" class="unnumbered">Source Code</h3>
<p>Source code blocks are written as follows. Syntax is highlighted appropriately where applicable:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> MyApp <span class="kw">extends</span> App {
  <span class="fu">println</span>(<span class="st">&quot;Hello world!&quot;</span>) <span class="co">// Print a fine message to the user!</span>
}</code></pre></div>
<p>Most code passes through <a href="https://github.com/tpolecat/tut">tut</a> to ensure it compiles. tut uses the Scala console behind the scenes, so we sometimes show console-style output as comments:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;Hello Cats!&quot;</span>.<span class="fu">toUpperCase</span>
<span class="co">// res0: String = HELLO CATS!</span></code></pre></div>
<h3 id="callout-boxes" class="unnumbered">Callout Boxes</h3>
<p>We use three types of <em>callout box</em> to highlight particular content:</p>
<div class="callout callout-info">
<p>Tip callouts indicate handy summaries, recipes, or best practices.</p>
</div>
<div class="callout callout-warning">
<p>Advanced callouts provide additional information on corner cases or underlying mechanisms. Feel free to skip these on your first read-through—come back to them later for extra information.</p>
</div>
<h2 id="acknowledgements" class="unnumbered">Acknowledgements</h2>
<p>We’d like to thank our colleagues at Underscore, our friends at Typelevel, and everyone who helped contribute to this book. Special thanks to Jenny Clements for her fantastic artwork and Richard Dallaway for his proof reading expertise. Here is an alphabetical list of contributors:</p>
<p>Alessandro Marrella, Cody Koeninger, Connie Chen, Conor Fennell, Dani Rey, Daniela Sfregola, Danielle Ashley, David Castillo, David Piggott, Dennis Hunziker, Deokhwan Kim, Edd Steel, Evgeny Veretennikov, Francis Devereux, Ghislain Vaillant, Gregor Ihmor, Henk-Jan Meijer, Janne Pelkonen, Jason Scott, Javier Arrieta, Jenny Clements, Jérémie Jost, Joachim Hofer, Jonathon Ferguson, Lance Paine, ltbs, Marc Prud’hommeaux, Martin Carolan, Mr-SD, Narayan Iyer, Niccolo’ Paravanti, niqdev, Noor Nashid, Pablo Francisco Pérez Hidalgo, Pawel Jurczenko, Phil Derome, Philip Schwarz, Riccardo Sirigu, Richard Dallaway, Rodrigo B. de Oliveira, Seoh Char, Sergio Magnacco, Toby Weston, Victor Osolovskiy, and Yinka Erinle.</p>
<p>If you spot an error or potential improvement, please raise an issue or submit a PR on the book’s <a href="https://github.com/underscoreio/advanced-scala">Github page</a>.</p>
<h3 id="backers" class="unnumbered">Backers</h3>
<p>We’d also like to extend very special thanks to our backers—fine people who helped fund the development of the book by buying a copy before we released it as open source. This book wouldn’t exist without you:</p>
<p>A battle-hardened technologist, Aaron Pritzlaff, Abhishek Srivastava, Aleksey “Daron” Terekhin, Algolia, Allen George (@allenageorge), Andrew Johnson, Andrew Kerr, Andy Dwelly, Anler, anthony@dribble.ai, Aravindh Sridaran, Araxis Ltd, ArtemK, Arthur Kushka (@arhelmus), Artur Zhurat, Arturas Smorgun, Attila Mravik, Axel Gschaider, Bamboo Le, bamine, Barry Kern, Ben Darfler (@bdarfler), Ben Letton, Benjamin Neil, Benoit Hericher, Bernt Andreas Langøien, Bill Leck, Blaze K, Boniface Kabaso, Brian Wongchaowart, Bryan Dragon, @cannedprimates, Ceschiatti (@6qat), Chris Gojlo, Chris Phelps, @CliffRedmond, Cody Koeninger, Constantin Gonciulea, Dadepo Aderemi, Damir Vandic, Damon Rolfs, Dan Todor, Daniel Arndt, Daniela Sfregola, David Greco, David Poltorak, Dennis Hunziker, Dennis Vriend, Derek Morr, Dimitrios Liapis, Don McNamara, Doug Clinton, Doug Lindholm (dlindhol), Edgar Mueller, Edward J Renauer Jr, Emiliano Martinez, esthom, Etienne Peiniau, Fede Silva, Filipe Azevedo, Franck Rasolo, Gary Coady, George Ball, Gerald Loeffler, Integrational, Giles Taylor, Guilherme Dantas (@gamsd), Harish Hurchurn, Hisham Ismail, Iurii Susuk, Ivan (SkyWriter) Kasatenko, Ivano Pagano, Jacob Baumbach, James Morris, Jan Vincent Liwanag, Javier Gonzalez, Jeff Gentry, Joel Chovanec, Jon Bates, Jorge Aliss (@jaliss), Juan Macias (@1macias1), Juan Ortega, Juan Pablo Romero Méndez, Jungsun Kim, Kaushik Chakraborty (@kaychaks), Keith Mannock, Ken Hoffman, Kevin Esler, Kevin Kyyro, kgillies, Klaus Rehm, Kostas Skourtis, Lance Linder, Liang, Guang Hua, Loïc Girault, Luke Tebbs, Makis A, Malcolm Robbins, Mansur Ashraf (@mansur_ashraf), Marcel Lüthi, Marek Prochera @hicolour, Marianudo (Mariano Navas), Mark Eibes, Mark van Rensburg, Martijn Blankestijn, Martin Studer, Matthew Edwards, Matthew Pflueger, mauropalsgraaf, mbarak, Mehitabel, Michael Pigg, Mikael Moghadam, Mike Gehard (@mikegehard), MonadicBind, arjun.mukherjee@gmail.com, Stephen Arbogast, Narayan Iyer, @natewave, Netanel Rabinowitz, Nick Peterson, Nicolas Sitbon, Oier Blasco Linares, Oliver Daff, Oliver Schrenk, Olly Shaw, P Villela, pandaforme, Patrick Garrity, Pawel Wlodarski from JUG Lodz, @peel, Peter Perhac, Phil Glover, Philipp Leser-Wolf, Rachel Bowyer, Radu Gancea (@radusw), Rajit Singh, Ramin Alidousti, Raymond Tay, Riccardo Sirigu, Richard (Yin-Wu) Chuo, Rob Vermazeren, Robert “Kemichal” Andersson, Robin Taylor (@badgermind), Rongcui Dong, Rui Morais, Rupert Bates, Rustem Suniev, Sanjiv Sahayam, Shane Delmore, Stefan Plantikow, Sundy Wiliam Yaputra, Tal Pressman, Tamas Neltz, theLXK, Tim Pigden, Tobias Lutz, Tom Duhourq, @tomzalt, Utz Westermann, Vadym Shalts, Val Akkapeddi, Vasanth Loka, Vladimir Bacvanski, Vladimir Bystrov aka udav_pit, William Benton, Wojciech Langiewicz, Yann Ollivier (@ya2o), Yoshiro Naito, zero323, and zeronone.</p>
<p> </p>
<h1 id="sec:type-classes"><span class="header-section-number">1</span> Introduction</h1>
<p>Cats contains a wide variety of functional programming tools and allows developers to pick and choose the ones we want to use. The majority of these tools are delivered in the form of <em>type classes</em> that we can apply to existing Scala types.</p>
<p>Type classes are a programming pattern originating in Haskell<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>. They allow us to extend existing libraries with new functionality, without using traditional inheritance, and without altering the original library source code.</p>
<!--
Type classes work well with another programming pattern: *algebraic data types*.
These are closed systems of types that we use to represent data or concepts.
Because the systems are closed (and therefore cannot be extended by other users),
we can process them using pattern matching
and the compiler will check the exhaustiveness of our case clauses.

There are two other patterns we need to cover in this chapter.
*Value classes* provide a way to wrap up
generic data types like `Strings` and `Ints`
and give them specific meanings in a given context.
The extra type information is useful when type classes.
*Type aliases* are another pattern that
provide aliases for large, complex types.
-->
<p>In this chapter we will refresh our memory of type classes from Underscore’s <a href="http://underscore.io/books/essential-scala">Essential Scala</a> book, and take a first look at the Cats codebase. We will look at two example type classes—<code>Show</code> and <code>Eq</code>—using them to identify patterns that lay the foundations for the rest of the book.</p>
<p>We’ll finish by tying type classes back into algebraic data types, pattern matching, value classes, and type aliases, presenting a structured approach to functional programming in Scala.</p>
<h2 id="anatomy-of-a-type-class"><span class="header-section-number">1.1</span> Anatomy of a Type Class</h2>
<p>There are three important components to the type class pattern: the <em>type class</em> itself, <em>instances</em> for particular types, and the <em>interface</em> methods that we expose to users.</p>
<h3 id="the-type-class"><span class="header-section-number">1.1.1</span> The Type Class</h3>
<p>A <em>type class</em> is an interface or API that represents some functionality we want to implement. In Cats a type class is represented by a trait with at least one type parameter. For example, we can represent generic “serialize to JSON” behaviour as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Define a very simple JSON AST</span>
<span class="kw">sealed</span> <span class="kw">trait</span> Json
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JsObject</span>(get: Map[String, Json]) <span class="kw">extends</span> Json
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JsString</span>(get: String) <span class="kw">extends</span> Json
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JsNumber</span>(get: Double) <span class="kw">extends</span> Json
<span class="kw">case</span> <span class="kw">object</span> JsNull <span class="kw">extends</span> Json

<span class="co">// The &quot;serialize to JSON&quot; behaviour is encoded in this trait</span>
<span class="kw">trait</span> JsonWriter[A] {
  <span class="kw">def</span> <span class="fu">write</span>(value: A): Json
}</code></pre></div>
<p><code>JsonWriter</code> is our type class in this example, with <code>Json</code> and its subtypes providing supporting code.</p>
<h3 id="type-class-instances"><span class="header-section-number">1.1.2</span> Type Class Instances</h3>
<p>The <em>instances</em> of a type class provide implementations for the types we care about, including types from the Scala standard library and types from our domain model.</p>
<p>In Scala we define instances by creating concrete implementations of the type class and tagging them with the <code>implicit</code> keyword:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Person</span>(name: String, email: String)

<span class="kw">object</span> JsonWriterInstances {
  <span class="kw">implicit</span> <span class="kw">val</span> stringWriter: JsonWriter[String] =
    <span class="kw">new</span> JsonWriter[String] {
      <span class="kw">def</span> <span class="fu">write</span>(value: String): Json =
        <span class="fu">JsString</span>(value)
    }

  <span class="kw">implicit</span> <span class="kw">val</span> personWriter: JsonWriter[Person] =
    <span class="kw">new</span> JsonWriter[Person] {
      <span class="kw">def</span> <span class="fu">write</span>(value: Person): Json =
        <span class="fu">JsObject</span>(Map(
          <span class="st">&quot;name&quot;</span> -&gt; <span class="fu">JsString</span>(value.<span class="fu">name</span>),
          <span class="st">&quot;email&quot;</span> -&gt; <span class="fu">JsString</span>(value.<span class="fu">email</span>)
        ))
    }

  <span class="co">// etc...</span>
}</code></pre></div>
<h3 id="type-class-interfaces"><span class="header-section-number">1.1.3</span> Type Class Interfaces</h3>
<p>A type class <em>interface</em> is any functionality we expose to users. Interfaces are generic methods that accept instances of the type class as implicit parameters.</p>
<p>There are two common ways of specifying an interface: <em>Interface Objects</em> and <em>Interface Syntax</em>.</p>
<p><strong>Interface Objects</strong></p>
<p>The simplest way of creating an interface is to place methods in a singleton object:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Json {
  <span class="kw">def</span> toJson[A](value: A)(<span class="kw">implicit</span> w: JsonWriter[A]): Json =
    w.<span class="fu">write</span>(value)
}</code></pre></div>
<p>To use this object, we import any type class instances we care about and call the relevant method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> JsonWriterInstances._

Json.<span class="fu">toJson</span>(<span class="fu">Person</span>(<span class="st">&quot;Dave&quot;</span>, <span class="st">&quot;dave@example.com&quot;</span>))
<span class="co">// res4: Json = JsObject(Map(name -&gt; JsString(Dave), email -&gt; JsString(dave@example.com)))</span></code></pre></div>
<p>The compiler spots that we’ve called the <code>toJson</code> method without providing the implicit parameters. It tries to fix this by searching for type class instances of the relevant types and inserting them at the call site:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Json.<span class="fu">toJson</span>(<span class="fu">Person</span>(<span class="st">&quot;Dave&quot;</span>, <span class="st">&quot;dave@example.com&quot;</span>))(personWriter)</code></pre></div>
<p><strong>Interface Syntax</strong></p>
<p>We can alternatively use <em>extension methods</em> to extend existing types with interface methods<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>. Cats refers to this as <em>“syntax”</em> for the type class:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> JsonSyntax {
  <span class="kw">implicit</span> <span class="kw">class</span> JsonWriterOps[A](value: A) {
    <span class="kw">def</span> <span class="fu">toJson</span>(<span class="kw">implicit</span> w: JsonWriter[A]): Json =
      w.<span class="fu">write</span>(value)
  }
}</code></pre></div>
<p>We use interface syntax by importing it alongside the instances for the types we need:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> JsonWriterInstances._
<span class="kw">import</span> JsonSyntax._

<span class="fu">Person</span>(<span class="st">&quot;Dave&quot;</span>, <span class="st">&quot;dave@example.com&quot;</span>).<span class="fu">toJson</span>
<span class="co">// res6: Json = JsObject(Map(name -&gt; JsString(Dave), email -&gt; JsString(dave@example.com)))</span></code></pre></div>
<p>Again, the compiler searches for candidates for the implicit parameters and fills them in for us:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">Person</span>(<span class="st">&quot;Dave&quot;</span>, <span class="st">&quot;dave@example.com&quot;</span>).<span class="fu">toJson</span>(personWriter)</code></pre></div>
<p><strong>The <em>implicitly</em> Method</strong></p>
<p>The Scala standard library provides a generic type class interface called <code>implicitly</code>. Its definition is very simple:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> implicitly[A](<span class="kw">implicit</span> value: A): A =
  value</code></pre></div>
<p>We can use <code>implicitly</code> to summon any value from implicit scope. We provide the type we want and <code>implicitly</code> does the rest:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> JsonWriterInstances._
<span class="co">// import JsonWriterInstances._</span>

implicitly[JsonWriter[String]]
<span class="co">// res8: JsonWriter[String] = JsonWriterInstances$$anon$1@7503327f</span></code></pre></div>
<p>Most type classes in Cats provide other means to summon instances. However, <code>implicitly</code> is a good fallback for debugging purposes. We can insert a call to <code>implicitly</code> within the general flow of our code to ensure the compiler can find an instance of a type class and ensure that there are no ambiguous implicit errors.</p>
<h2 id="working-with-implicits"><span class="header-section-number">1.2</span> Working with Implicits</h2>
<p>Working with type classes in Scala means working with implicit values and implicit parameters. There are a few rules we need to know to do this effectively.</p>
<h3 id="packaging-implicits"><span class="header-section-number">1.2.1</span> Packaging Implicits</h3>
<p>In a curious quirk of the language, any definitions marked <code>implicit</code> in Scala must be placed inside an object or trait rather than at the top level. In the example above we packaged our type class instances in an object called <code>JsonWriterInstances</code>. We could equally have placed them in a companion object to <code>JsonWriter</code>. Placing instances in a companion object to the type class has special significance in Scala because it plays into something called <em>implicit scope</em>.</p>
<h3 id="implicit-scope"><span class="header-section-number">1.2.2</span> Implicit Scope</h3>
<p>As we saw above, the compiler searches for candidate type class instances by type. For example, in the following expression it will look for an instance of type <code>JsonWriter[String]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Json.<span class="fu">toJson</span>(<span class="st">&quot;A string!&quot;</span>)</code></pre></div>
<p>The compiler searches for candidate instances in the <em>implicit scope</em> at the call site, which roughly consists of:</p>
<ul>
<li><p>local or inherited definitions;</p></li>
<li><p>imported definitions;</p></li>
<li><p>definitions in the companion object of the type class or the parameter type (in this case <code>JsonWriter</code> or <code>String</code>).</p></li>
</ul>
<p>Definitions are only included in implicit scope if they are tagged with the <code>implicit</code> keyword. Furthermore, if the compiler sees multiple candidate definitions, it fails with an <em>ambiguous implicit values</em> error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> writer1: JsonWriter[String] =
  JsonWriterInstances.<span class="fu">stringWriter</span>

<span class="kw">implicit</span> <span class="kw">val</span> writer2: JsonWriter[String] =
  JsonWriterInstances.<span class="fu">stringWriter</span>

Json.<span class="fu">toJson</span>(<span class="st">&quot;A string&quot;</span>)
<span class="co">// &lt;console&gt;:23: error: ambiguous implicit values:</span>
<span class="co">//  both value stringWriter in object JsonWriterInstances of type =&gt; JsonWriter[String]</span>
<span class="co">//  and value writer1 of type =&gt; JsonWriter[String]</span>
<span class="co">//  match expected type JsonWriter[String]</span>
<span class="co">//          Json.toJson(&quot;A string&quot;)</span>
<span class="co">//                     ^</span></code></pre></div>
<p>The precise rules of implicit resolution are more complex than this, but the complexity is largely irrelevant for this book<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a>. For our purposes, we can package type class instances in roughly four ways:</p>
<ol style="list-style-type: decimal">
<li>by placing them in an object such as <code>JsonWriterInstances</code>;</li>
<li>by placing them in a trait;</li>
<li>by placing them in the companion object of the type class;</li>
<li>by placing them in the companion object of the parameter type.</li>
</ol>
<p>With option 1 we bring instances into scope by <code>importing</code> them. With option 2 we bring them into scope with inheritance. With options 3 and 4, instances are <em>always</em> in implicit scope, regardless of where we try to use them.</p>
<h3 id="sec:type-classes:recursive-implicits"><span class="header-section-number">1.2.3</span> Recursive Implicit Resolution</h3>
<p>The power of type classes and implicits lies in the compiler’s ability to <em>combine</em> implicit definitions when searching for candidate instances.</p>
<p>Earlier we insinuated that all type class instances are <code>implicit vals</code>. This was a simplification. We can actually define instances in two ways:</p>
<ol style="list-style-type: decimal">
<li><p>by defining concrete instances as <code>implicit vals</code> of the required type<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a>;</p></li>
<li><p>by defining <code>implicit</code> methods to construct instances from other type class instances.</p></li>
</ol>
<p>Why would we construct instances from other instances? As a motivational example, consider defining a <code>JsonWriter</code> for <code>Options</code>. We would need a <code>JsonWriter[Option[A]]</code> for every <code>A</code> we care about in our application. We could try to brute force the problem by creating a library of <code>implicit vals</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> optionIntWriter: JsonWriter[Option[Int]] =
  ???

<span class="kw">implicit</span> <span class="kw">val</span> optionPersonWriter: JsonWriter[Option[Person]] =
  ???

<span class="co">// and so on...</span></code></pre></div>
<p>However, this approach clearly doesn’t scale. We end up requiring two <code>implicit vals</code> for every type <code>A</code> in our application: one for <code>A</code> and one for <code>Option[A]</code>.</p>
<p>Fortunately, we can abstract the code for handling <code>Option[A]</code> into a common constructor based on the instance for <code>A</code>:</p>
<ul>
<li><p>if the option is <code>Some(aValue)</code>, write <code>aValue</code> using the writer for <code>A</code>;</p></li>
<li><p>if the option is <code>None</code>, return <code>JsNull</code>.</p></li>
</ul>
<p>Here is the same code written out as an <code>implicit def</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> optionWriter[A]
    (<span class="kw">implicit</span> writer: JsonWriter[A]): JsonWriter[Option[A]] =
  <span class="kw">new</span> JsonWriter[Option[A]] {
    <span class="kw">def</span> <span class="fu">write</span>(option: Option[A]): Json =
      option <span class="kw">match</span> {
        <span class="kw">case</span> Some(aValue) =&gt; writer.<span class="fu">write</span>(aValue)
        <span class="kw">case</span> None         =&gt; JsNull
      }
  }</code></pre></div>
<p>This method <em>constructs</em> a <code>JsonWriter</code> for <code>Option[A]</code> by relying on an implicit parameter to fill in the <code>A</code>-specific functionality. When the compiler sees an expression like this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Json.<span class="fu">toJson</span>(Option(<span class="st">&quot;A string&quot;</span>))</code></pre></div>
<p>it searches for an implicit <code>JsonWriter[Option[String]]</code>. It finds the implicit method for <code>JsonWriter[Option[A]]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Json.<span class="fu">toJson</span>(Option(<span class="st">&quot;A string&quot;</span>))(optionWriter[String])</code></pre></div>
<p>and recursively searches for a <code>JsonWriter[String]</code> to use as the parameter to <code>optionWriter</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Json.<span class="fu">toJson</span>(Option(<span class="st">&quot;A string&quot;</span>))(<span class="fu">optionWriter</span>(stringWriter))</code></pre></div>
<p>In this way, implicit resolution becomes a search through the space of possible combinations of implicit definitions, to find a combination that summons a type class instance of the correct overall type.</p>
<div class="callout callout-warning">
<p><em>Implicit Conversions</em></p>
<p>When you create a type class instance constructor using an <code>implicit def</code>, be sure to mark the parameters to the method as <code>implicit</code> parameters. Without this keyword, the compiler won’t be able to fill in the parameters during implicit resolution.</p>
<p><code>implicit</code> methods with non-<code>implicit</code> parameters form a different Scala pattern called an <em>implicit conversion</em>. This is also different from the previous section on <code>Interface Syntax</code>, because in that case the <code>JsonWriter</code> is an implicit class with <code>extension methods</code>. Implicit conversion is an older programming pattern that is frowned upon in modern Scala code. Fortunately, the compiler will warn you when you do this. You have to manually enable implicit conversions by importing <code>scala.language.implicitConversions</code> in your file:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> optionWriter[A]
    (writer: JsonWriter[A]): JsonWriter[Option[A]] =
  ???
<span class="co">// &lt;console&gt;:18: warning: implicit conversion method optionWriter should be enabled</span>
<span class="co">// by making the implicit value scala.language.implicitConversions visible.</span>
<span class="co">// This can be achieved by adding the import clause 'import scala.language.implicitConversions'</span>
<span class="co">// or by setting the compiler option -language:implicitConversions.</span>
<span class="co">// See the Scaladoc for value scala.language.implicitConversions for a discussion</span>
<span class="co">// why the feature should be explicitly enabled.</span>
<span class="co">//        implicit def optionWriter[A]</span>
<span class="co">//                     ^</span>
<span class="co">// error: No warnings can be incurred under -Xfatal-warnings.</span></code></pre></div>
</div>
<h2 id="exercise-printable-library"><span class="header-section-number">1.3</span> Exercise: Printable Library</h2>
<p>Scala provides a <code>toString</code> method to let us convert any value to a <code>String</code>. However, this method comes with a few disadvantages: it is implemented for <em>every</em> type in the language, many implementations are of limited use, and we can’t opt-in to specific implementations for specific types.</p>
<p>Let’s define a <code>Printable</code> type class to work around these problems:</p>
<ol style="list-style-type: decimal">
<li><p>Define a type class <code>Printable[A]</code> containing a single method <code>format</code>. <code>format</code> should accept a value of type <code>A</code> and return a <code>String</code>.</p></li>
<li><p>Create an object <code>PrintableInstances</code> containing instances of <code>Printable</code> for <code>String</code> and <code>Int</code>.</p></li>
<li><p>Define an object <code>Printable</code> with two generic interface methods:</p>
<p><code>format</code> accepts a value of type <code>A</code> and a <code>Printable</code> of the corresponding type. It uses the relevant <code>Printable</code> to convert the <code>A</code> to a <code>String</code>.</p>
<p><code>print</code> accepts the same parameters as <code>format</code> and returns <code>Unit</code>. It prints the <code>A</code> value to the console using <code>println</code>.</p></li>
</ol>
<div class="solution">
<p>These steps define the three main components of our type class. First we define <code>Printable</code>—the <em>type class</em> itself:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Printable[A] {
  <span class="kw">def</span> <span class="fu">format</span>(value: A): String
}</code></pre></div>
<p>Then we define some default <em>instances</em> of <code>Printable</code> and package them in <code>PrintableInstances</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> PrintableInstances {
  <span class="kw">implicit</span> <span class="kw">val</span> stringPrintable = <span class="kw">new</span> Printable[String] {
    <span class="kw">def</span> <span class="fu">format</span>(input: String) = input
  }

  <span class="kw">implicit</span> <span class="kw">val</span> intPrintable = <span class="kw">new</span> Printable[Int] {
    <span class="kw">def</span> <span class="fu">format</span>(input: Int) = input.<span class="fu">toString</span>
  }
}</code></pre></div>
<p>Finally we define an <em>interface</em> object, <code>Printable</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Printable {
  <span class="kw">def</span> format[A](input: A)(<span class="kw">implicit</span> p: Printable[A]): String =
    p<span class="fu">.format</span>(input)

  <span class="kw">def</span> print[A](input: A)(<span class="kw">implicit</span> p: Printable[A]): Unit =
    <span class="fu">println</span>(<span class="fu">format</span>(input))
}</code></pre></div>
</div>
<p><strong>Using the Library</strong></p>
<p>The code above forms a general purpose printing library that we can use in multiple applications. Let’s define an “application” now that uses the library.</p>
<p>First we’ll define a data type to represent a well-known type of furry animal:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, age: Int, color: String)</code></pre></div>
<p>Next we’ll create an implementation of <code>Printable</code> for <code>Cat</code> that returns content in the following format:</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="dt">NAME</span> is a <span class="dt">AGE</span> year-old <span class="dt">COLOR</span> cat.</code></pre></div>
<p>Finally, use the type class on the console or in a short demo app: create a <code>Cat</code> and print it to the console:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Define a cat:</span>
<span class="kw">val</span> cat = <span class="fu">Cat</span>(<span class="co">/* ... */</span>)

<span class="co">// Print the cat!</span></code></pre></div>
<div class="solution">
<p>This is a standard use of the type class pattern. First we define a set of custom data types for our application:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, age: Int, color: String)</code></pre></div>
<p>Then we define type class instances for the types we care about. These either go into the companion object of <code>Cat</code> or a separate object to act as a namespace:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> PrintableInstances._

<span class="kw">implicit</span> <span class="kw">val</span> catPrintable = <span class="kw">new</span> Printable[Cat] {
  <span class="kw">def</span> <span class="fu">format</span>(cat: Cat) = {
    <span class="kw">val</span> name  = Printable<span class="fu">.format</span>(cat.name)
    <span class="kw">val</span> age   = Printable<span class="fu">.format</span>(cat.age)
    <span class="kw">val</span> color = Printable<span class="fu">.format</span>(cat.color)
    s<span class="st">&quot;$name is a $age year-old $color cat.&quot;</span>
  }
}</code></pre></div>
<p>Finally, we use the type class by bringing the relevant instances into scope and using interface object/syntax. If we defined the instances in companion objects Scala brings them into scope for us automatically. Otherwise we use an <code>import</code> to access them:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> cat = <span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>, <span class="dv">38</span>, <span class="st">&quot;ginger and black&quot;</span>)
<span class="co">// cat: Cat = Cat(Garfield,38,ginger and black)</span>

Printable.<span class="fu">print</span>(cat)
<span class="co">// Garfield is a 38 year-old ginger and black cat.</span></code></pre></div>
</div>
<p><strong>Better Syntax</strong></p>
<p>Let’s make our printing library easier to use by defining some extension methods to provide better syntax:</p>
<ol style="list-style-type: decimal">
<li><p>Create an object called <code>PrintableSyntax</code>.</p></li>
<li><p>Inside <code>PrintableSyntax</code> define an <code>implicit class PrintableOps[A]</code> to wrap up a value of type <code>A</code>.</p></li>
<li><p>In <code>PrintableOps</code> define the following methods:</p>
<ul>
<li><p><code>format</code> accepts an implicit <code>Printable[A]</code> and returns a <code>String</code> representation of the wrapped <code>A</code>;</p></li>
<li><p><code>print</code> accepts an implicit <code>Printable[A]</code> and returns <code>Unit</code>. It prints the wrapped <code>A</code> to the console.</p></li>
</ul></li>
<li><p>Use the extension methods to print the example <code>Cat</code> you created in the previous exercise.</p></li>
</ol>
<div class="solution">
<p>First we define an <code>implicit class</code> containing our extension methods:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> PrintableSyntax {
  <span class="kw">implicit</span> <span class="kw">class</span> PrintableOps[A](value: A) {
    <span class="kw">def</span> <span class="fu">format</span>(<span class="kw">implicit</span> p: Printable[A]): String =
      Printable<span class="fu">.format</span>(value)

    <span class="kw">def</span> <span class="fu">print</span>(<span class="kw">implicit</span> p: Printable[A]): Unit =
      Printable.<span class="fu">print</span>(value)
  }
}</code></pre></div>
<p>With <code>PrintableOps</code> in scope, we can call the imaginary <code>print</code> and <code>format</code> methods on any value for which Scala can locate an implicit instance of <code>Printable</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> PrintableSyntax._

<span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>, <span class="dv">38</span>, <span class="st">&quot;ginger and black&quot;</span>).<span class="fu">print</span>
<span class="co">// Garfield is a 38 year-old ginger and black cat.</span></code></pre></div>
<p>We get a compile error if we haven’t defined an instance of <code>Printable</code> for the relevant type:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> java.<span class="fu">util</span>.<span class="fu">Date</span>

<span class="kw">new</span> Date().<span class="fu">print</span>
<span class="co">// &lt;console&gt;:23: error: could not find implicit value for parameter p: Printable[java.util.Date]</span>
<span class="co">//        new Date().print</span>
<span class="co">//                   ^</span></code></pre></div>
</div>
<h2 id="meet-cats"><span class="header-section-number">1.4</span> Meet Cats</h2>
<p>In the previous section we saw how to implement type classes in Scala. In this section we will look at how type classes are implemented in Cats.</p>
<p>Cats is written using a modular structure that allows us to choose which type classes, instances, and interface methods we want to use. Let’s take a first look using <a href="http://typelevel.org/cats/api/cats/Show.html"><code>cats.Show</code></a> as an example.</p>
<p><code>Show</code> is Cats’ equivalent of the <code>Printable</code> type class we defined in the last section. It provides a mechanism for producing developer-friendly console output without using <code>toString</code>. Here’s an abbreviated definition:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">trait</span> Show[A] {
  <span class="kw">def</span> <span class="fu">show</span>(value: A): String
}</code></pre></div>
<h3 id="importing-type-classes"><span class="header-section-number">1.4.1</span> Importing Type Classes</h3>
<p>The type classes in Cats are defined in the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a> package. We can import <code>Show</code> directly from this package:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Show</span></code></pre></div>
<p>The companion object of every Cats type class has an <code>apply</code> method that locates an instance for any type we specify:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> showInt = Show.<span class="fu">apply</span>[Int]
<span class="co">// &lt;console&gt;:13: error: could not find implicit value for parameter instance: cats.Show[Int]</span>
<span class="co">//        val showInt = Show.apply[Int]</span>
<span class="co">//                                ^</span></code></pre></div>
<p>Oops—that didn’t work! The <code>apply</code> method uses <em>implicits</em> to look up individual instances, so we’ll have to bring some instances into scope.</p>
<h3 id="importing-default-instances"><span class="header-section-number">1.4.2</span> Importing Default Instances</h3>
<p>The <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a> package provides default instances for a wide variety of types. We can import these as shown in the table below. Each import provides instances of all Cats’ type classes for a specific parameter type:</p>
<ul>
<li><a href="http://typelevel.org/cats/api/cats/instances/package$$int$"><code>cats.instances.int</code></a> provides instances for <code>Int</code></li>
<li><a href="http://typelevel.org/cats/api/cats/instances/package$$string$"><code>cats.instances.string</code></a> provides instances for <code>String</code></li>
<li><a href="http://typelevel.org/cats/api/cats/instances/package$$list$"><code>cats.instances.list</code></a> provides instances for <code>List</code></li>
<li><a href="http://typelevel.org/cats/api/cats/instances/package$$option$"><code>cats.instances.option</code></a> provides instances for <code>Option</code></li>
<li><a href="http://typelevel.org/cats/api/cats/instances/package$$all$"><code>cats.instances.all</code></a> provides all instances that are shipped out of the box with Cats</li>
</ul>
<p>See the <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a> package for a complete list of available imports.</p>
<p>Let’s import the instances of <code>Show</code> for <code>Int</code> and <code>String</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Show</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Show</span>

<span class="kw">val</span> showInt:    Show[Int]    = Show.<span class="fu">apply</span>[Int]
<span class="kw">val</span> showString: Show[String] = Show.<span class="fu">apply</span>[String]</code></pre></div>
<p>That’s better! We now have access to two instances of <code>Show</code>, and can use them to print <code>Ints</code> and <code>Strings</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> intAsString: String =
  showInt.<span class="fu">show</span>(<span class="dv">123</span>)
<span class="co">// intAsString: String = 123</span>

<span class="kw">val</span> stringAsString: String =
  showString.<span class="fu">show</span>(<span class="st">&quot;abc&quot;</span>)
<span class="co">// stringAsString: String = abc</span></code></pre></div>
<h3 id="importing-interface-syntax"><span class="header-section-number">1.4.3</span> Importing Interface Syntax</h3>
<p>We can make <code>Show</code> easier to use by importing the <em>interface syntax</em> from <a href="http://typelevel.org/cats/api/cats/syntax/package$$show$"><code>cats.syntax.show</code></a>. This adds an extension method called <code>show</code> to any type for which we have an instance of <code>Show</code> in scope:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">show</span>._ <span class="co">// for show</span>

<span class="kw">val</span> shownInt = <span class="fl">123.</span>show
<span class="co">// shownInt: String = 123</span>

<span class="kw">val</span> shownString = <span class="st">&quot;abc&quot;</span>.<span class="fu">show</span>
<span class="co">// shownString: String = abc</span></code></pre></div>
<p>Cats provides separate syntax imports for each type class. We will introduce these as we encounter them in later sections and chapters.</p>
<h3 id="importing-all-the-things"><span class="header-section-number">1.4.4</span> Importing All The Things!</h3>
<p>In this book we will use specific imports to show you exactly which instances and syntax you need in each example. However, this can be time consuming for many use cases. You should feel free to take one of the following shortcuts to simplify your imports:</p>
<ul>
<li><p><code>import cats._</code> imports all of Cats’ type classes in one go;</p></li>
<li><p><code>import cats.instances.all._</code> imports all of the type class instances for the standard library in one go;</p></li>
<li><p><code>import cats.syntax.all._</code> imports all of the syntax in one go;</p></li>
<li><p><code>import cats.implicits._</code> imports all of the standard type class instances <em>and</em> all of the syntax in one go.</p></li>
</ul>
<p>Most people start their files with the following imports, reverting to more specific imports only if they encounter naming conflicts or problems ambiguous implicits:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats._
<span class="kw">import</span> cats.<span class="fu">implicits</span>._</code></pre></div>
<h3 id="defining-custom-instances"><span class="header-section-number">1.4.5</span> Defining Custom Instances</h3>
<p>We can define an instance of <code>Show</code> simply by implementing the trait for a given type:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> java.<span class="fu">util</span>.<span class="fu">Date</span>

<span class="kw">implicit</span> <span class="kw">val</span> dateShow: Show[Date] =
  <span class="kw">new</span> Show[Date] {
    <span class="kw">def</span> <span class="fu">show</span>(date: Date): String =
      s<span class="st">&quot;${date.getTime}ms since the epoch.&quot;</span>
  }</code></pre></div>
<p>However, Cats also provides a couple of convenient methods to simplify the process. There are two construction methods on the companion object of <code>Show</code> that we can use to define instances for our own types:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Show {
  <span class="co">// Convert a function to a `Show` instance:</span>
  <span class="kw">def</span> show[A](f: A =&gt; String): Show[A] =
    ???

  <span class="co">// Create a `Show` instance from a `toString` method:</span>
  <span class="kw">def</span> fromToString[A]: Show[A] =
    ???
}</code></pre></div>
<p>These allows us to quickly construct instances with less ceremony than defining them from scratch:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> dateShow: Show[Date] =
  Show.<span class="fu">show</span>(date =&gt; s<span class="st">&quot;${date.getTime}ms since the epoch.&quot;</span>)</code></pre></div>
<p>As you can see, the code using construction methods is much terser than the code without. Many type classes in Cats provide helper methods like these for constructing instances, either from scratch or by transforming existing instances for other types.</p>
<h3 id="exercise-cat-show"><span class="header-section-number">1.4.6</span> Exercise: Cat Show</h3>
<p>Re-implement the <code>Cat</code> application from the previous section using <code>Show</code> instead of <code>Printable</code>.</p>
<div class="solution">
<p>First let’s import everything we need from Cats: the <code>Show</code> type class, the instances for <code>Int</code> and <code>String</code>, and the interface syntax:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Show</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Show</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Show</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">show</span>._      <span class="co">// for show</span></code></pre></div>
<p>Our definition of <code>Cat</code> remains the same:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, age: Int, color: String)</code></pre></div>
<p>In the companion object we replace our <code>Printable</code> with an instance of <code>Show</code> using one of the definition helpers discussed above:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> catShow = Show.<span class="fu">show</span>[Cat] { cat =&gt;
  <span class="kw">val</span> name  = cat.<span class="fu">name</span>.<span class="fu">show</span>
  <span class="kw">val</span> age   = cat.<span class="fu">age</span>.<span class="fu">show</span>
  <span class="kw">val</span> color = cat.<span class="fu">color</span>.<span class="fu">show</span>
  s<span class="st">&quot;$name is a $age year-old $color cat.&quot;</span>
}</code></pre></div>
<p>Finally, we use the <code>Show</code> interface syntax to print our instance of <code>Cat</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">println</span>(<span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>, <span class="dv">38</span>, <span class="st">&quot;ginger and black&quot;</span>).<span class="fu">show</span>)
<span class="co">// Garfield is a 38 year-old ginger and black cat.</span></code></pre></div>
</div>
<h2 id="example-eq"><span class="header-section-number">1.5</span> Example: Eq</h2>
<p>We will finish off this chapter by looking at another useful type class: <a href="http://typelevel.org/cats/api/cats/kernel/Eq.html"><code>cats.Eq</code></a>. <code>Eq</code> is designed to support <em>type-safe equality</em> and address annoyances using Scala’s built-in <code>==</code> operator.</p>
<p>Almost every Scala developer has written code like this before:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">map</span>(Option(_)).<span class="fu">filter</span>(item =&gt; item == <span class="dv">1</span>)
<span class="co">// res0: List[Option[Int]] = List()</span></code></pre></div>
<p>Ok, many of you won’t have made such a simple mistake as this, but the principle is sound. The predicate in the <code>filter</code> clause always returns <code>false</code> because it is comparing an <code>Int</code> to an <code>Option[Int]</code>.</p>
<p>This is programmer error—we should have compared <code>item</code> to <code>Some(1)</code> instead of <code>1</code>. However, it’s not technically a type error because <code>==</code> works for any pair of objects, no matter what types we compare. <code>Eq</code> is designed to add some type safety to equality checks and work around this problem.</p>
<h3 id="equality-liberty-and-fraternity"><span class="header-section-number">1.5.1</span> Equality, Liberty, and Fraternity</h3>
<p>We can use <code>Eq</code> to define type-safe equality between instances of any given type:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">trait</span> Eq[A] {
  <span class="kw">def</span> <span class="fu">eqv</span>(a: A, b: A): Boolean
  <span class="co">// other concrete methods based on eqv...</span>
}</code></pre></div>
<p>The interface syntax, defined in <a href="http://typelevel.org/cats/api/cats/syntax/package$$eq$"><code>cats.syntax.eq</code></a>, provides two methods for performing equality checks provided there is an instance <code>Eq[A]</code> in scope:</p>
<ul>
<li><code>===</code> compares two objects for equality;</li>
<li><code>=!=</code> compares two objects for inequality.</li>
</ul>
<h3 id="comparing-ints"><span class="header-section-number">1.5.2</span> Comparing Ints</h3>
<p>Let’s look at a few examples. First we import the type class:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Eq</span></code></pre></div>
<p>Now let’s grab an instance for <code>Int</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Eq</span>

<span class="kw">val</span> eqInt = Eq[Int]</code></pre></div>
<p>We can use <code>eqInt</code> directly to test for equality:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">eqInt.<span class="fu">eqv</span>(<span class="dv">123</span>, <span class="dv">123</span>)
<span class="co">// res2: Boolean = true</span>

eqInt.<span class="fu">eqv</span>(<span class="dv">123</span>, <span class="dv">234</span>)
<span class="co">// res3: Boolean = false</span></code></pre></div>
<p>Unlike Scala’s <code>==</code> method, if we try to compare objects of different types using <code>eqv</code> we get a compile error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">eqInt.<span class="fu">eqv</span>(<span class="dv">123</span>, <span class="st">&quot;234&quot;</span>)
<span class="co">// &lt;console&gt;:18: error: type mismatch;</span>
<span class="co">//  found   : String(&quot;234&quot;)</span>
<span class="co">//  required: Int</span>
<span class="co">//        eqInt.eqv(123, &quot;234&quot;)</span>
<span class="co">//                       ^</span></code></pre></div>
<p>We can also import the interface syntax in <a href="http://typelevel.org/cats/api/cats/syntax/package$$eq$"><code>cats.syntax.eq</code></a> to use the <code>===</code> and <code>=!=</code> methods:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">eq</span>._ <span class="co">// for === and =!=</span>

<span class="dv">123</span> === <span class="dv">123</span>
<span class="co">// res5: Boolean = true</span>

<span class="dv">123</span> =!= <span class="dv">234</span>
<span class="co">// res6: Boolean = true</span></code></pre></div>
<p>Again, comparing values of different types causes a compiler error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">123</span> === <span class="st">&quot;123&quot;</span>
<span class="co">// &lt;console&gt;:20: error: type mismatch;</span>
<span class="co">//  found   : String(&quot;123&quot;)</span>
<span class="co">//  required: Int</span>
<span class="co">//        123 === &quot;123&quot;</span>
<span class="co">//                ^</span></code></pre></div>
<h3 id="sec:type-classes:comparing-options"><span class="header-section-number">1.5.3</span> Comparing Options</h3>
<p>Now for a more interesting example—<code>Option[Int]</code>. To compare values of type <code>Option[Int]</code> we need to import instances of <code>Eq</code> for <code>Option</code> as well as <code>Int</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Eq</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Eq</span></code></pre></div>
<p>Now we can try some comparisons:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Some(<span class="dv">1</span>) === None
<span class="co">// &lt;console&gt;:26: error: value === is not a member of Some[Int]</span>
<span class="co">//        Some(1) === None</span>
<span class="co">//                ^</span></code></pre></div>
<p>We have received an error here because the types don’t quite match up. We have <code>Eq</code> instances in scope for <code>Int</code> and <code>Option[Int]</code> but the values we are comparing are of type <code>Some[Int]</code>. To fix the issue we have to re-type the arguments as <code>Option[Int]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(Some(<span class="dv">1</span>) : Option[Int]) === (None : Option[Int])
<span class="co">// res9: Boolean = false</span></code></pre></div>
<p>We can do this in a friendlier fashion using the <code>Option.apply</code> and <code>Option.empty</code> methods from the standard library:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Option(<span class="dv">1</span>) === Option.<span class="fu">empty</span>[Int]
<span class="co">// res10: Boolean = false</span></code></pre></div>
<p>or using special syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$option$"><code>cats.syntax.option</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">option</span>._ <span class="co">// for some and none</span>

<span class="fl">1.</span>some === none[Int]
<span class="co">// res11: Boolean = false</span>

<span class="fl">1.</span>some =!= none[Int]
<span class="co">// res12: Boolean = true</span></code></pre></div>
<h3 id="comparing-custom-types"><span class="header-section-number">1.5.4</span> Comparing Custom Types</h3>
<p>We can define our own instances of <code>Eq</code> using the <code>Eq.instance</code> method, which accepts a function of type <code>(A, A) =&gt; Boolean</code> and returns an <code>Eq[A]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> java.<span class="fu">util</span>.<span class="fu">Date</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">long</span>._ <span class="co">// for Eq</span>

<span class="kw">implicit</span> <span class="kw">val</span> dateEq: Eq[Date] =
  Eq.<span class="fu">instance</span>[Date] { (date1, date2) =&gt;
    date1.<span class="fu">getTime</span> === date2.<span class="fu">getTime</span>
  }

<span class="kw">val</span> x = <span class="kw">new</span> Date() <span class="co">// now</span>
<span class="kw">val</span> y = <span class="kw">new</span> Date() <span class="co">// a bit later than now</span>

x === x
<span class="co">// res13: Boolean = true</span>

x === y
<span class="co">// res14: Boolean = false</span></code></pre></div>
<h3 id="exercise-equality-liberty-and-felinity"><span class="header-section-number">1.5.5</span> Exercise: Equality, Liberty, and Felinity</h3>
<p>Implement an instance of <code>Eq</code> for our running <code>Cat</code> example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, age: Int, color: String)</code></pre></div>
<p>Use this to compare the following pairs of objects for equality and inequality:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> cat1 = <span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>,   <span class="dv">38</span>, <span class="st">&quot;orange and black&quot;</span>)
<span class="kw">val</span> cat2 = <span class="fu">Cat</span>(<span class="st">&quot;Heathcliff&quot;</span>, <span class="dv">33</span>, <span class="st">&quot;orange and black&quot;</span>)

<span class="kw">val</span> optionCat1 = Option(cat1)
<span class="kw">val</span> optionCat2 = Option.<span class="fu">empty</span>[Cat]</code></pre></div>
<div class="solution">
<p>First we need our Cats imports. In this exercise we’ll be using the <code>Eq</code> type class and the <code>Eq</code> interface syntax. We’ll bring instances of <code>Eq</code> into scope as we need them below:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Eq</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">eq</span>._ <span class="co">// for ===</span></code></pre></div>
<p>Our <code>Cat</code> class is the same as ever:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, age: Int, color: String)</code></pre></div>
<p>We bring the <code>Eq</code> instances for <code>Int</code> and <code>String</code> into scope for the implementation of <code>Eq[Cat]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Eq</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Eq</span>

<span class="kw">implicit</span> <span class="kw">val</span> catEqual: Eq[Cat] =
  Eq.<span class="fu">instance</span>[Cat] { (cat1, cat2) =&gt;
    (cat1.<span class="fu">name</span>  === cat2.<span class="fu">name</span> ) &amp;&amp;
    (cat1.<span class="fu">age</span>   === cat2.<span class="fu">age</span>  ) &amp;&amp;
    (cat1.<span class="fu">color</span> === cat2.<span class="fu">color</span>)
  }</code></pre></div>
<p>Finally, we test things out in a sample application:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> cat1 = <span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>,   <span class="dv">38</span>, <span class="st">&quot;orange and black&quot;</span>)
<span class="co">// cat1: Cat = Cat(Garfield,38,orange and black)</span>

<span class="kw">val</span> cat2 = <span class="fu">Cat</span>(<span class="st">&quot;Heathcliff&quot;</span>, <span class="dv">32</span>, <span class="st">&quot;orange and black&quot;</span>)
<span class="co">// cat2: Cat = Cat(Heathcliff,32,orange and black)</span>

cat1 === cat2
<span class="co">// res17: Boolean = false</span>

cat1 =!= cat2
<span class="co">// res18: Boolean = true</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Eq</span>

<span class="kw">val</span> optionCat1 = Option(cat1)
<span class="co">// optionCat1: Option[Cat] = Some(Cat(Garfield,38,orange and black))</span>

<span class="kw">val</span> optionCat2 = Option.<span class="fu">empty</span>[Cat]
<span class="co">// optionCat2: Option[Cat] = None</span>

optionCat1 === optionCat2
<span class="co">// res19: Boolean = false</span>

optionCat1 =!= optionCat2
<span class="co">// res20: Boolean = true</span></code></pre></div>
</div>
<h2 id="controlling-instance-selection"><span class="header-section-number">1.6</span> Controlling Instance Selection</h2>
<p>When working with type classes we must consider two issues that control instance selection:</p>
<ul>
<li><p>What is the relationship between an instance defined on a type and its subtypes?</p>
<p>For example, if we define a <code>JsonWriter[Option[Int]]</code>, will the expression <code>Json.toJson(Some(1))</code> select this instance? (Remember that <code>Some</code> is a subtype of <code>Option</code>).</p></li>
<li><p>How do we choose between type class instances when there are many available?</p>
<p>What if we define two <code>JsonWriters</code> for <code>Person</code>? When we write <code>Json.toJson(aPerson)</code>, which instance is selected?</p></li>
</ul>
<h3 id="sec:variance"><span class="header-section-number">1.6.1</span> Variance</h3>
<p>When we define type classes we can add variance annotations to the type parameter to affect the variance of the type class and the compiler’s ability to select instances during implicit resolution.</p>
<p>To recap Essential Scala, variance relates to subtypes. We say that <code>B</code> is a subtype of <code>A</code> if we can use a value of type <code>B</code> anywhere we expect a value of type <code>A</code>.</p>
<p>Co- and contravariance annotations arise when working with type constructors. For example, we denote covariance with a <code>+</code> symbol:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> F[+A] <span class="co">// the &quot;+&quot; means &quot;covariant&quot;</span></code></pre></div>
<p><strong>Covariance</strong></p>
<p>Covariance means that the type <code>F[B]</code> is a subtype of the type <code>F[A]</code> if <code>B</code> is a subtype of <code>A</code>. This is useful for modelling many types, including collections like <code>List</code> and <code>Option</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> List[+A]
<span class="kw">trait</span> Option[+A]</code></pre></div>
<p>The covariance of Scala collections allows us to substitute collections of one type for another in our code. For example, we can use a <code>List[Circle]</code> anywhere we expect a <code>List[Shape]</code> because <code>Circle</code> is a subtype of <code>Shape</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Shape
<span class="kw">case</span> <span class="kw">class</span> <span class="fu">Circle</span>(radius: Double) <span class="kw">extends</span> Shape

<span class="kw">val</span> circles: List[Circle] = ???
<span class="kw">val</span> shapes: List[Shape] = circles</code></pre></div>
<p>What about contravariance? We write contravariant type constructors with a <code>-</code> symbol like this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> F[-A]</code></pre></div>
<p><strong>Contravariance</strong></p>
<p>Confusingly, contravariance means that the type <code>F[B]</code> is a subtype of <code>F[A]</code> if <code>A</code> is a subtype of <code>B</code>. This is useful for modelling types that represent processes, like our <code>JsonWriter</code> type class above:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> JsonWriter[-A] {
  <span class="kw">def</span> <span class="fu">write</span>(value: A): Json
}
<span class="co">// defined trait JsonWriter</span></code></pre></div>
<p>Let’s unpack this a bit further. Remember that variance is all about the ability to substitute one value for another. Consider a scenario where we have two values, one of type <code>Shape</code> and one of type <code>Circle</code>, and two <code>JsonWriters</code>, one for <code>Shape</code> and one for <code>Circle</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> shape: Shape = ???
<span class="kw">val</span> circle: Circle = ???

<span class="kw">val</span> shapeWriter: JsonWriter[Shape] = ???
<span class="kw">val</span> circleWriter: JsonWriter[Circle] = ???

<span class="kw">def</span> format[A](value: A, writer: JsonWriter[A]): Json =
  writer.<span class="fu">write</span>(value)</code></pre></div>
<p>Now ask yourself the question: “Which of combinations of value and writer can I pass to <code>format</code>?” We can combine <code>circle</code> with either writer because all <code>Circles</code> are <code>Shapes</code>. Conversely, we can’t combine <code>shape</code> with <code>circleWriter</code> because not all <code>Shapes</code> are <code>Circles</code>.</p>
<p>This relationship is what we formally model using contravariance. <code>JsonWriter[Shape]</code> is a subtype of <code>JsonWriter[Circle]</code> because <code>Circle</code> is a subtype of <code>Shape</code>. This means we can use <code>shapeWriter</code> anywhere we expect to see a <code>JsonWriter[Circle]</code>.</p>
<p><strong>Invariance</strong></p>
<p>Invariance is actually the easiest situation to describe. It’s what we get when we don’t write a <code>+</code> or <code>-</code> in a type constructor:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> F[A]</code></pre></div>
<p>This means the types <code>F[A]</code> and <code>F[B]</code> are never subtypes of one another, no matter what the relationship between <code>A</code> and <code>B</code>. This is the default semantics for Scala type constructors.</p>
<p>When the compiler searches for an implicit it looks for one matching the type <em>or subtype</em>. Thus we can use variance annotations to control type class instance selection to some extent.</p>
<p>There are two issues that tend to arise. Let’s imagine we have an algebraic data type like:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> A
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">object</span> B <span class="kw">extends</span> A
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">object</span> C <span class="kw">extends</span> A</code></pre></div>
<p>The issues are:</p>
<ol style="list-style-type: decimal">
<li><p>Will an instance defined on a supertype be selected if one is available? For example, can we define an instance for <code>A</code> and have it work for values of type <code>B</code> and <code>C</code>?</p></li>
<li><p>Will an instance for a subtype be selected in preference to that of a supertype. For instance, if we define an instance for <code>A</code> and <code>B</code>, and we have a value of type <code>B</code>, will the instance for <code>B</code> be selected in preference to <code>A</code>?</p></li>
</ol>
<p>It turns out we can’t have both at once. The three choices give us behaviour as follows:</p>
<div class="table-responsive">
<table style="width:99%;">
<colgroup>
<col width="44%"></col>
<col width="16%"></col>
<col width="16%"></col>
<col width="20%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="left">Type Class Variance</th>
<th align="left">Invariant</th>
<th align="left">Covariant</th>
<th align="left">Contravariant</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Supertype instance used?</td>
<td align="left">No</td>
<td align="left">No</td>
<td align="left">Yes</td>
</tr>
<tr class="even">
<td align="left">More specific type preferred?</td>
<td align="left">No</td>
<td align="left">Yes</td>
<td align="left">No</td>
</tr>
</tbody>
</table>
</div>
<p>It’s clear there is no perfect system. Cats generally prefers to use invariant type classes. This allows us to specify more specific instances for subtypes if we want. It does mean that if we have, for example, a value of type <code>Some[Int]</code>, our type class instance for <code>Option</code> will not be used. We can solve this problem with a type annotation like <code>Some(1) : Option[Int]</code> or by using “smart constructors” like the <code>Option.apply</code>, <code>Option.empty</code>, <code>some</code>, and <code>none</code> methods we saw in Section 1.5.3.</p>
<h2 id="summary"><span class="header-section-number">1.7</span> Summary</h2>
<p>In this chapter we took a first look at type classes. We implemented our own <code>Printable</code> type class using plain Scala before looking at two examples from Cats—<code>Show</code> and <code>Eq</code>.</p>
<p>We have now seen the general patterns in Cats type classes:</p>
<ul>
<li><p>The type classes themselves are generic traits in the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a> package.</p></li>
<li><p>Each type class has a companion object with, an <code>apply</code> method for materializing instances, one or more <em>construction</em> methods for creating instances, and a collection of other relevant helper methods.</p></li>
<li><p>Default instances are provided via objects in the <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a> package, and are organized by parameter type rather than by type class.</p></li>
<li><p>Many type classes have <em>syntax</em> provided via the <a href="http://typelevel.org/cats/api/cats/syntax/"><code>cats.syntax</code></a> package.</p></li>
</ul>
<p>In the remaining chapters of Part I we will look at several broad and powerful type classes—<code>Semigroup</code>, <code>Monoid</code>, <code>Functor</code>, <code>Monad</code>, <code>Semigroupal</code>, <code>Applicative</code>, <code>Traverse</code>, and more. In each case we will learn what functionality the type class provides, the formal rules it follows, and how it is implemented in Cats. Many of these type classes are more abstract than <code>Show</code> or <code>Eq</code>. While this makes them harder to learn, it makes them far more useful for solving general problems in our code.</p>
<h1 id="sec:monoids"><span class="header-section-number">2</span> Monoids and Semigroups</h1>
<p>In this section we explore our first type classes, <strong>monoid</strong> and <strong>semigroup</strong>. These allow us to add or combine values. There are instances for <code>Ints</code>, <code>Strings</code>, <code>Lists</code>, <code>Options</code>, and many more. Let’s start by looking at a few simple types and operations to see what common principles we can extract.</p>
<p><strong>Integer addition</strong></p>
<p>Addition of <code>Ints</code> is a binary operation that is <em>closed</em>, meaning that adding two <code>Ints</code> always produces another <code>Int</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">2</span> + <span class="dv">1</span>
<span class="co">// res0: Int = 3</span></code></pre></div>
<p>There is also the <em>identity</em> element <code>0</code> with the property that <code>a + 0 == 0 + a == a</code> for any <code>Int</code> <code>a</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">2</span> + <span class="dv">0</span>
<span class="co">// res1: Int = 2</span>

<span class="dv">0</span> + <span class="dv">2</span>
<span class="co">// res2: Int = 2</span></code></pre></div>
<p>There are also other properties of addition. For instance, it doesn’t matter in what order we add elements because we always get the same result. This is a property known as <em>associativity</em>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="dv">1</span> + <span class="dv">2</span>) + <span class="dv">3</span>
<span class="co">// res3: Int = 6</span>

<span class="dv">1</span> + (<span class="dv">2</span> + <span class="dv">3</span>)
<span class="co">// res4: Int = 6</span></code></pre></div>
<p><strong>Integer multiplication</strong></p>
<p>The same properties for addition also apply for multiplication, provided we use <code>1</code> as the identity instead of <code>0</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">1</span> * <span class="dv">3</span>
<span class="co">// res5: Int = 3</span>

<span class="dv">3</span> * <span class="dv">1</span>
<span class="co">// res6: Int = 3</span></code></pre></div>
<p>Multiplication, like addition, is associative:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="dv">1</span> * <span class="dv">2</span>) * <span class="dv">3</span>
<span class="co">// res7: Int = 6</span>

<span class="dv">1</span> * (<span class="dv">2</span> * <span class="dv">3</span>)
<span class="co">// res8: Int = 6</span></code></pre></div>
<p><strong>String and sequence concatenation</strong></p>
<p>We can also add <code>Strings</code>, using string concatenation as our binary operator:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;One&quot;</span> ++ <span class="st">&quot;two&quot;</span>
<span class="co">// res9: String = Onetwo</span></code></pre></div>
<p>and the empty string as the identity:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;&quot;</span> ++ <span class="st">&quot;Hello&quot;</span>
<span class="co">// res10: String = Hello</span>

<span class="st">&quot;Hello&quot;</span> ++ <span class="st">&quot;&quot;</span>
<span class="co">// res11: String = Hello</span></code></pre></div>
<p>Once again, concatenation is associative:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="st">&quot;One&quot;</span> ++ <span class="st">&quot;Two&quot;</span>) ++ <span class="st">&quot;Three&quot;</span>
<span class="co">// res12: String = OneTwoThree</span>

<span class="st">&quot;One&quot;</span> ++ (<span class="st">&quot;Two&quot;</span> ++ <span class="st">&quot;Three&quot;</span>)
<span class="co">// res13: String = OneTwoThree</span></code></pre></div>
<p>Note that we used <code>++</code> above instead of the more usual <code>+</code> to suggest a parallel with sequences. We can do the same with other types of sequence, using concatenation as the binary operator and the empty sequence as our identity.</p>
<h2 id="definition-of-a-monoid"><span class="header-section-number">2.1</span> Definition of a Monoid</h2>
<p>We’ve seen a number of “addition” scenarios above each with an associative binary addition and an identity element. It will be no surprise to learn that this is a monoid. Formally, a monoid for a type <code>A</code> is:</p>
<ul>
<li>an operation <code>combine</code> with type <code>(A, A) =&gt; A</code></li>
<li>an element <code>empty</code> of type <code>A</code></li>
</ul>
<p>This definition translates nicely into Scala code. Here is a simplified version of the definition from Cats:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Monoid[A] {
  <span class="kw">def</span> <span class="fu">combine</span>(x: A, y: A): A
  <span class="kw">def</span> empty: A
}</code></pre></div>
<p>In addition to providing the <code>combine</code> and <code>empty</code> operations, monoids must formally obey several <em>laws</em>. For all values <code>x</code>, <code>y</code>, and <code>z</code>, in <code>A</code>, <code>combine</code> must be associative and <code>empty</code> must be an identity element:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> associativeLaw[A](x: A, y: A, z: A)
      (<span class="kw">implicit</span> m: Monoid[A]): Boolean = {
  m.<span class="fu">combine</span>(x, m.<span class="fu">combine</span>(y, z)) ==
    m.<span class="fu">combine</span>(m.<span class="fu">combine</span>(x, y), z)
}

<span class="kw">def</span> identityLaw[A](x: A)
      (<span class="kw">implicit</span> m: Monoid[A]): Boolean = {
  (m.<span class="fu">combine</span>(x, m.<span class="fu">empty</span>) == x) &amp;&amp;
    (m.<span class="fu">combine</span>(m.<span class="fu">empty</span>, x) == x)
}</code></pre></div>
<p>Integer subtraction, for example, is not a monoid because subtraction is not associative:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="dv">1</span> - <span class="dv">2</span>) - <span class="dv">3</span>
<span class="co">// res15: Int = -4</span>

<span class="dv">1</span> - (<span class="dv">2</span> - <span class="dv">3</span>)
<span class="co">// res16: Int = 2</span></code></pre></div>
<p>In practice we only need to think about laws when we are writing our own <code>Monoid</code> instances. Unlawful instances are dangerous because they can yield unpredictable results when used with the rest of Cats’ machinery. Most of the time we can rely on the instances provided by Cats and assume the library authors know what they’re doing.</p>
<h2 id="definition-of-a-semigroup"><span class="header-section-number">2.2</span> Definition of a Semigroup</h2>
<p>A semigroup is just the <code>combine</code> part of a monoid. While many semigroups are also monoids, there are some data types for which we cannot define an <code>empty</code> element. For example, we have just seen that sequence concatenation and integer addition are monoids. However, if we restrict ourselves to non-empty sequences and positive integers, we are no longer able to define a sensible <code>empty</code> element. Cats has a <a href="http://typelevel.org/cats/api/cats/data/NonEmptyList.html"><code>NonEmptyList</code></a> data type that has an implementation of <code>Semigroup</code> but no implementation of <code>Monoid</code>.</p>
<p>A more accurate (though still simplified) definition of Cats’ <a href="http://typelevel.org/cats/api/cats/kernel/Monoid.html"><code>Monoid</code></a> is:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Semigroup[A] {
  <span class="kw">def</span> <span class="fu">combine</span>(x: A, y: A): A
}

<span class="kw">trait</span> Monoid[A] <span class="kw">extends</span> Semigroup[A] {
  <span class="kw">def</span> empty: A
}</code></pre></div>
<p>We’ll see this kind of inheritance often when discussing type classes. It provides modularity and allows us to re-use behaviour. If we define a <code>Monoid</code> for a type <code>A</code>, we get a <code>Semigroup</code> for free. Similarly, if a method requires a parameter of type <code>Semigroup[B]</code>, we can pass a <code>Monoid[B]</code> instead.</p>
<h2 id="exercise-the-truth-about-monoids"><span class="header-section-number">2.3</span> Exercise: The Truth About Monoids</h2>
<p>We’ve seen a few examples of monoids but there are plenty more to be found. Consider <code>Boolean</code>. How many monoids can you define for this type? For each monoid, define the <code>combine</code> and <code>empty</code> operations and convince yourself that the monoid laws hold. Use the following definitions as a starting point:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Semigroup[A] {
  <span class="kw">def</span> <span class="fu">combine</span>(x: A, y: A): A
}

<span class="kw">trait</span> Monoid[A] <span class="kw">extends</span> Semigroup[A] {
  <span class="kw">def</span> empty: A
}

<span class="kw">object</span> Monoid {
  <span class="kw">def</span> apply[A](<span class="kw">implicit</span> monoid: Monoid[A]) =
    monoid
}</code></pre></div>
<div class="solution">
<p>There are four monoids for <code>Boolean</code>! First, we have <em>and</em> with operator <code>&amp;&amp;</code> and identity <code>true</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> booleanAndMonoid: Monoid[Boolean] =
  <span class="kw">new</span> Monoid[Boolean] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Boolean, b: Boolean) = a &amp;&amp; b
    <span class="kw">def</span> empty = <span class="kw">true</span>
  }</code></pre></div>
<p>Second, we have <em>or</em> with operator <code>||</code> and identity <code>false</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> booleanOrMonoid: Monoid[Boolean] =
  <span class="kw">new</span> Monoid[Boolean] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Boolean, b: Boolean) = a || b
    <span class="kw">def</span> empty = <span class="kw">false</span>
  }</code></pre></div>
<p>Third, we have <em>exclusive or</em> with identity <code>false</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> booleanEitherMonoid: Monoid[Boolean] =
  <span class="kw">new</span> Monoid[Boolean] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Boolean, b: Boolean) =
      (a &amp;&amp; !b) || (!a &amp;&amp; b)

    <span class="kw">def</span> empty = <span class="kw">false</span>
  }</code></pre></div>
<p>Finally, we have <em>exclusive nor</em> (the negation of exclusive or) with identity <code>true</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> booleanXnorMonoid: Monoid[Boolean] =
  <span class="kw">new</span> Monoid[Boolean] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Boolean, b: Boolean) =
      (!a || b) &amp;&amp; (a || !b)

    <span class="kw">def</span> empty = <span class="kw">true</span>
  }</code></pre></div>
<p>Showing that the identity law holds in each case is straightforward. Similarly associativity of the <code>combine</code> operation can be shown by enumerating the cases.</p>
</div>
<h2 id="exercise-all-set-for-monoids"><span class="header-section-number">2.4</span> Exercise: All Set for Monoids</h2>
<p>What monoids and semigroups are there for sets?</p>
<div class="solution">
<p><em>Set union</em> forms a monoid along with the empty set:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> setUnionMonoid[A]: Monoid[Set[A]] =
  <span class="kw">new</span> Monoid[Set[A]] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Set[A], b: Set[A]) = a union b
    <span class="kw">def</span> empty = Set.<span class="fu">empty</span>[A]
  }</code></pre></div>
<p>We need to define <code>setUnionMonoid</code> as a method rather than a value so we can accept the type parameter <code>A</code>. The type parameter allows us to use the same definition to summon <code>Monoids</code> for <code>Sets</code> of any type of data:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> intSetMonoid = Monoid[Set[Int]]
<span class="kw">val</span> strSetMonoid = Monoid[Set[String]]

intSetMonoid.<span class="fu">combine</span>(Set(<span class="dv">1</span>, <span class="dv">2</span>), Set(<span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res2: Set[Int] = Set(1, 2, 3)</span>

strSetMonoid.<span class="fu">combine</span>(Set(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), Set(<span class="st">&quot;B&quot;</span>, <span class="st">&quot;C&quot;</span>))
<span class="co">// res3: Set[String] = Set(A, B, C)</span></code></pre></div>
<p>Set intersection forms a semigroup, but doesn’t form a monoid because it has no identity element:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> setIntersectionSemigroup[A]: Semigroup[Set[A]] =
  <span class="kw">new</span> Semigroup[Set[A]] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Set[A], b: Set[A]) =
      a intersect b
  }</code></pre></div>
<p>Set complement and set difference are not associative, so they cannot be considered for either monoids or semigroups. However, symmetric difference (the union less the intersection) does also form a monoid with the empty set:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> symDiffMonoid[A]: Monoid[Set[A]] =
  <span class="kw">new</span> Monoid[Set[A]] {
    <span class="kw">def</span> <span class="fu">combine</span>(a: Set[A], b: Set[A]): Set[A] =
      (a diff b) <span class="fu">union</span> (b diff a)
    <span class="kw">def</span> empty: Set[A] = Set.<span class="fu">empty</span>
  }</code></pre></div>
</div>
<h2 id="monoids-in-cats"><span class="header-section-number">2.5</span> Monoids in Cats</h2>
<p>Now we’ve seen what monoids are, let’s look at their implementation in Cats. Once again we’ll look at the three main aspects of the implementation: the <em>type class</em>, the <em>instances</em>, and the <em>interface</em>.</p>
<h3 id="the-monoid-type-class"><span class="header-section-number">2.5.1</span> The Monoid Type Class</h3>
<p>The monoid type class is <code>cats.kernel.Monoid</code>, which is aliased as <a href="http://typelevel.org/cats/api/cats/kernel/Monoid.html"><code>cats.Monoid</code></a>. <code>Monoid</code> extends <code>cats.kernel.Semigroup</code>, which is aliased as <a href="http://typelevel.org/cats/api/cats/kernel/Semigroup.html"><code>cats.Semigroup</code></a>. When using Cats we normally import type classes from the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a> package:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">Semigroup</span></code></pre></div>
<div class="callout callout-info">
<p><em>Cats Kernel?</em></p>
<p>Cats Kernel is a subproject of Cats providing a small set of typeclasses for libraries that don’t require the full Cats toolbox. While these core type classes are technically defined in the <a href="http://typelevel.org/cats/api/cats/kernel/"><code>cats.kernel</code></a> package, they are all aliased to the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a> package so we rarely need to be aware of the distinction.</p>
<p>The Cats Kernel type classes covered in this book are <a href="http://typelevel.org/cats/api/cats/kernel/Eq.html"><code>Eq</code></a>, <a href="http://typelevel.org/cats/api/cats/kernel/Semigroup.html"><code>Semigroup</code></a>, and <a href="http://typelevel.org/cats/api/cats/kernel/Monoid.html"><code>Monoid</code></a>. All the other type classes we cover are part of the main Cats project and are defined directly in the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a> package.</p>
</div>
<h3 id="sec:monoid-instances"><span class="header-section-number">2.5.2</span> Monoid Instances</h3>
<p><code>Monoid</code> follows the standard Cats pattern for the user interface: the companion object has an <code>apply</code> method that returns the type class instance for a particular type. For example, if we want the monoid instance for <code>String</code>, and we have the correct implicits in scope, we can write the following:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>

Monoid[String].<span class="fu">combine</span>(<span class="st">&quot;Hi &quot;</span>, <span class="st">&quot;there&quot;</span>)
<span class="co">// res0: String = Hi there</span>

Monoid[String].<span class="fu">empty</span>
<span class="co">// res1: String = &quot;&quot;</span></code></pre></div>
<p>which is equivalent to:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Monoid.<span class="fu">apply</span>[String].<span class="fu">combine</span>(<span class="st">&quot;Hi &quot;</span>, <span class="st">&quot;there&quot;</span>)
<span class="co">// res2: String = Hi there</span>

Monoid.<span class="fu">apply</span>[String].<span class="fu">empty</span>
<span class="co">// res3: String = &quot;&quot;</span></code></pre></div>
<p>As we know, <code>Monoid</code> extends <code>Semigroup</code>. If we don’t need <code>empty</code> we can equivalently write:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>

Semigroup[String].<span class="fu">combine</span>(<span class="st">&quot;Hi &quot;</span>, <span class="st">&quot;there&quot;</span>)
<span class="co">// res4: String = Hi there</span></code></pre></div>
<p>The type class instances for <code>Monoid</code> are organised under <code>cats.instances</code> in the standard way described in <a href="#importing-default-instances">Chapter 1</a>. For example, if we want to pull in instances for <code>Int</code> we import from <a href="http://typelevel.org/cats/api/cats/instances/package$$int$"><code>cats.instances.int</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

Monoid[Int].<span class="fu">combine</span>(<span class="dv">32</span>, <span class="dv">10</span>)
<span class="co">// res5: Int = 42</span></code></pre></div>
<p>Similarly, we can assemble a <code>Monoid[Option[Int]]</code> using instances from <a href="http://typelevel.org/cats/api/cats/instances/package$$int$"><code>cats.instances.int</code></a> and <a href="http://typelevel.org/cats/api/cats/instances/package$$option$"><code>cats.instances.option</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monoid</span>

<span class="kw">val</span> a = Option(<span class="dv">22</span>)
<span class="co">// a: Option[Int] = Some(22)</span>

<span class="kw">val</span> b = Option(<span class="dv">20</span>)
<span class="co">// b: Option[Int] = Some(20)</span>

Monoid[Option[Int]].<span class="fu">combine</span>(a, b)
<span class="co">// res6: Option[Int] = Some(42)</span></code></pre></div>
<p>Refer back to <a href="#importing-default-instances">Chapter 1</a> for a more comprehensive list of imports.</p>
<h3 id="sec:monoid-syntax"><span class="header-section-number">2.5.3</span> Monoid Syntax</h3>
<p>Cats provides syntax for the <code>combine</code> method in the form of the <code>|+|</code> operator. Because <code>combine</code> technically comes from <code>Semigroup</code>, we access the syntax by importing from <a href="http://typelevel.org/cats/api/cats/syntax/package$$semigroup$"><code>cats.syntax.semigroup</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">val</span> stringResult = <span class="st">&quot;Hi &quot;</span> |+| <span class="st">&quot;there&quot;</span> |+| Monoid[String].<span class="fu">empty</span>
<span class="co">// stringResult: String = Hi there</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

<span class="kw">val</span> intResult = <span class="dv">1</span> |+| <span class="dv">2</span> |+| Monoid[Int].<span class="fu">empty</span>
<span class="co">// intResult: Int = 3</span></code></pre></div>
<h3 id="exercise-adding-all-the-things"><span class="header-section-number">2.5.4</span> Exercise: Adding All The Things</h3>
<p>The cutting edge <em>SuperAdder v3.5a-32</em> is the world’s first choice for adding together numbers. The main function in the program has signature <code>def add(items: List[Int]): Int</code>. In a tragic accident this code is deleted! Rewrite the method and save the day!</p>
<div class="solution">
<p>We can write the addition as a simple <code>foldLeft</code> using <code>0</code> and the <code>+</code> operator:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">add</span>(items: List[Int]): Int =
  items.<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ + _)</code></pre></div>
<p>We can alternatively write the fold using <code>Monoids</code>, although there’s not a compelling use case for this yet:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">def</span> <span class="fu">add</span>(items: List[Int]): Int =
  items.<span class="fu">foldLeft</span>(Monoid[Int].<span class="fu">empty</span>)(_ |+| _)</code></pre></div>
</div>
<p>Well done! SuperAdder’s market share continues to grow, and now there is demand for additional functionality. People now want to add <code>List[Option[Int]]</code>. Change <code>add</code> so this is possible. The SuperAdder code base is of the highest quality, so make sure there is no code duplication!</p>
<div class="solution">
<p>Now there is a use case for <code>Monoids</code>. We need a single method that adds <code>Ints</code> and instances of <code>Option[Int]</code>. We can write this as a generic method that accepts an implicit <code>Monoid</code> as a parameter:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">def</span> add[A](items: List[A])(<span class="kw">implicit</span> monoid: Monoid[A]): A =
  items.<span class="fu">foldLeft</span>(monoid.<span class="fu">empty</span>)(_ |+| _)</code></pre></div>
<p>We can optionally use Scala’s <em>context bound</em> syntax to write the same code in a friendlier way:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> add[A: Monoid](items: List[A]): A =
  items.<span class="fu">foldLeft</span>(Monoid[A].<span class="fu">empty</span>)(_ |+| _)</code></pre></div>
<p>We can use this code to add values of type <code>Int</code> and <code>Option[Int]</code> as requested:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

<span class="fu">add</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res9: Int = 6</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monoid</span>

<span class="fu">add</span>(List(Some(<span class="dv">1</span>), None, Some(<span class="dv">2</span>), None, Some(<span class="dv">3</span>)))
<span class="co">// res10: Option[Int] = Some(6)</span></code></pre></div>
<p>Note that if we try to add a list consisting entirely of <code>Some</code> values, we get a compile error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">add</span>(List(Some(<span class="dv">1</span>), Some(<span class="dv">2</span>), Some(<span class="dv">3</span>)))
<span class="co">// &lt;console&gt;:61: error: could not find implicit value for evidence parameter of type cats.Monoid[Some[Int]]</span>
<span class="co">//        add(List(Some(1), Some(2), Some(3)))</span>
<span class="co">//           ^</span></code></pre></div>
<p>This happens because the inferred type of the list is <code>List[Some[Int]]</code>, while Cats will only generate a <code>Monoid</code> for <code>Option[Int]</code>. We’ll see how to get around this in a moment.</p>
</div>
<p>SuperAdder is entering the POS (point-of-sale, not the other POS) market. Now we want to add up <code>Orders</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">Order</span>(totalCost: Double, quantity: Double)</code></pre></div>
<p>We need to release this code really soon so we can’t make any modifications to <code>add</code>. Make it so!</p>
<div class="solution">
<p>Easy—we simply define a monoid instance for <code>Order</code>!</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> monoid: Monoid[Order] = <span class="kw">new</span> Monoid[Order] {
  <span class="kw">def</span> <span class="fu">combine</span>(o1: Order, o2: Order) =
    <span class="fu">Order</span>(
      o1.<span class="fu">totalCost</span> + o2.<span class="fu">totalCost</span>,
      o1.<span class="fu">quantity</span> + o2.<span class="fu">quantity</span>
    )

  <span class="kw">def</span> empty = <span class="fu">Order</span>(<span class="dv">0</span>, <span class="dv">0</span>)
}</code></pre></div>
</div>
<h2 id="applications-of-monoids"><span class="header-section-number">2.6</span> Applications of Monoids</h2>
<p>We now know what a monoid is—an abstraction of the concept of adding or combining—but where is it useful? Here are a few big ideas where monoids play a major role. These are explored in more detail in case studies later in the book.</p>
<h3 id="big-data"><span class="header-section-number">2.6.1</span> Big Data</h3>
<p>In big data applications like Spark and Hadoop we distribute data analysis over many machines, giving fault tolerance and scalability. This means each machine will return results over a portion of the data, and we must then combine these results to get our final result. In the vast majority of cases this can be viewed as a monoid.</p>
<p>If we want to calculate how many total visitors a web site has received, that means calculating an <code>Int</code> on each portion of the data. We know the monoid instance of <code>Int</code> is addition, which is the right way to combine partial results.</p>
<p>If we want to find out how many unique visitors a website has received, that’s equivalent to building a <code>Set[User]</code> on each portion of the data. We know the monoid instance for <code>Set</code> is the set union, which is the right way to combine partial results.</p>
<p>If we want to calculate 99% and 95% response times from our server logs, we can use a data structure called a <code>QTree</code> for which there is a monoid.</p>
<p>Hopefully you get the idea. Almost every analysis that we might want to do over a large data set is a monoid, and therefore we can build an expressive and powerful analytics system around this idea. This is exactly what Twitter’s Algebird and Summingbird projects have done. We explore this idea further in the <a href="#map-reduce">map-reduce</a> case study.</p>
<h3 id="distributed-systems"><span class="header-section-number">2.6.2</span> Distributed Systems</h3>
<p>In a distributed system, different machines may end up with different views of data. For example, one machine may receive an update that other machines did not receive. We would like to reconcile these different views, so every machine has the same data if no more updates arrive. This is called <em>eventual consistency</em>.</p>
<p>A particular class of data types support this reconciliation. These data types are called commutative replicated data types (CRDTs). The key operation is the ability to merge two data instances, with a result that captures all the information in both instances. This operation relies on having a monoid instance. We explore this idea further in the CRDT case study.</p>
<h3 id="monoids-in-the-small"><span class="header-section-number">2.6.3</span> Monoids in the Small</h3>
<p>The two examples above are cases where monoids inform the entire system architecture. There are also many cases where having a monoid around makes it easier to write a small code fragment. We’ll see lots of examples in the case studies in this book.</p>
<h2 id="summary-1"><span class="header-section-number">2.7</span> Summary</h2>
<p>We hit a big milestone in this chapter—we covered our first type classes with fancy functional programming names:</p>
<ul>
<li>a <code>Semigroup</code> represents an addition or combination operation;</li>
<li>a <code>Monoid</code> extends a <code>Semigroup</code> by adding an identity or “zero” element.</li>
</ul>
<p>We can use <code>Semigroups</code> and <code>Monoids</code> by importing three things: the type classes themselves, the instances for the types we care about, and the semigroup syntax to give us the <code>|+|</code> operator:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="st">&quot;Scala&quot;</span> |+| <span class="st">&quot; with &quot;</span> |+| <span class="st">&quot;Cats&quot;</span>
<span class="co">// res0: String = Scala with Cats</span></code></pre></div>
<p>With the correct instances in scope, we can set about adding anything we want:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monoid</span>

Option(<span class="dv">1</span>) |+| Option(<span class="dv">2</span>)
<span class="co">// res1: Option[Int] = Some(3)</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">map</span>._ <span class="co">// for Monoid</span>

<span class="kw">val</span> map1 = Map(<span class="st">&quot;a&quot;</span> -&gt; <span class="dv">1</span>, <span class="st">&quot;b&quot;</span> -&gt; <span class="dv">2</span>)
<span class="kw">val</span> map2 = Map(<span class="st">&quot;b&quot;</span> -&gt; <span class="dv">3</span>, <span class="st">&quot;d&quot;</span> -&gt; <span class="dv">4</span>)

map1 |+| map2
<span class="co">// res3: Map[String,Int] = Map(b -&gt; 5, d -&gt; 4, a -&gt; 1)</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">tuple</span>._  <span class="co">// for Monoid</span>


<span class="kw">val</span> tuple1 = (<span class="st">&quot;hello&quot;</span>, <span class="dv">123</span>)
<span class="kw">val</span> tuple2 = (<span class="st">&quot;world&quot;</span>, <span class="dv">321</span>)

tuple1 |+| tuple2
<span class="co">// res6: (String, Int) = (helloworld,444)</span></code></pre></div>
<p>We can also write generic code that works with any type for which we have an instance of <code>Monoid</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> addAll[A](values: List[A])
      (<span class="kw">implicit</span> monoid: Monoid[A]): A =
  values.<span class="fu">foldRight</span>(monoid.<span class="fu">empty</span>)(_ |+| _)

<span class="fu">addAll</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res7: Int = 6</span>

<span class="fu">addAll</span>(List(None, Some(<span class="dv">1</span>), Some(<span class="dv">2</span>)))
<span class="co">// res8: Option[Int] = Some(3)</span></code></pre></div>
<p><code>Monoids</code> are a great gateway to Cats. They’re easy to understand and simple to use. However, they’re just the tip of the iceberg in terms of the abstractions Cats enables us to make. In the next chapter we’ll look at <em>functors</em>, the type class personification of the beloved <code>map</code> method. That’s where the fun really begins!</p>
<h1 id="functors"><span class="header-section-number">3</span> Functors</h1>
<p>In this chapter we will investigate <strong>functors</strong>, an abstraction that allows us to represent sequences of operations within a context such as a <code>List</code>, an <code>Option</code>, or any one of a thousand other possibilities. Functors on their own aren’t so useful, but special cases of functors such as <strong>monads</strong> and <strong>applicative functors</strong> are some of the most commonly used abstractions in Cats.</p>
<h2 id="sec:functors:examples"><span class="header-section-number">3.1</span> Examples of Functors</h2>
<p>Informally, a functor is anything with a <code>map</code> method. You probably know lots of types that have this: <code>Option</code>, <code>List</code>, and <code>Either</code>, to name a few.</p>
<p>We typically first encounter <code>map</code> when iterating over <code>Lists</code>. However, to understand functors we need to think of the method in another way. Rather than traversing the list, we should think of it as transforming all of the values inside in one go. We specify the function to apply, and <code>map</code> ensures it is applied to every item. The values change but the structure of the list remains the same:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">map</span>(n =&gt; n + <span class="dv">1</span>)
<span class="co">// res0: List[Int] = List(2, 3, 4)</span></code></pre></div>
<p>Similarly, when we <code>map</code> over an <code>Option</code>, we transform the contents but leave the <code>Some</code> or <code>None</code> context unchanged. The same principle applies to <code>Either</code> with its <code>Left</code> and <code>Right</code> contexts. This general notion of transformation, along with the common pattern of type signatures shown in Figure 1, is what connects the behaviour of <code>map</code> across different data types.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjExNjBweCIgdmlld0JveD0iMCAwIDE3NjEgMTE2MCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggNDMuMiAoMzkwNjkpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPgogICAgPHRpdGxlPmxpc3Qtb3B0aW9uLWVpdGhlci1tYXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8Y2lyY2xlIGlkPSJwYXRoLTEiIGN4PSI3MjkiIGN5PSIxNDAiIHI9IjgwIj48L2NpcmNsZT4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0yIiBwb2ludHM9IjEwMzkuNTk1MDkgMTk0IDk4Ni42OTQ0MTQgMjIxLjgxMTUyOSA5OTYuNzk3NTQzIDE2Mi45MDU3NjUgOTU0IDEyMS4xODg0NzEgMTAxMy4xNDQ3NSAxMTIuNTk0MjM1IDEwMzkuNTk1MDkgNTkgMTA2Ni4wNDU0MiAxMTIuNTk0MjM1IDExMjUuMTkwMTcgMTIxLjE4ODQ3MSAxMDgyLjM5MjYzIDE2Mi45MDU3NjUgMTA5Mi40OTU3NiAyMjEuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMyIgcG9pbnRzPSI4NTEgMTIwIDg5MSAxMjAgODkxIDEwMCA5MzEgMTM5LjQ5Nzc2NyA4OTEgMTgwIDg5MSAxNjAgODUxIDE2MCI+PC9wb2x5Z29uPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTQiIGN4PSI2My41NjE0MzM0IiBjeT0iNjMuNjQyNDA1MSIgcng9IjYzLjU2MTQzMzQiIHJ5PSI2My42NDI0MDUxIj48L2VsbGlwc2U+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNSIgcG9pbnRzPSIyNDkuMzU0MzggMTI2LjY0MTU5IDIwNS42MDY5NDEgMTQ5LjY0OTE0MyAyMTMuOTYxOTU4IDEwMC45MTgzNjUgMTc4LjU2OTUzNiA2Ni40MDcwMzYgMjI3LjQ4MDY2IDU5LjI5NzMxMTMgMjQ5LjM1NDM4IDE0Ljk2MDU4NDggMjcxLjIyODEgNTkuMjk3MzExMyAzMjAuMTM5MjI0IDY2LjQwNzAzNiAyODQuNzQ2ODAyIDEwMC45MTgzNjUgMjkzLjEwMTgxOSAxNDkuNjQ5MTQzIj48L3BvbHlnb24+CiAgICAgICAgPHBhdGggZD0iTTIwLjA1ODgwOCwxNTUuNzY4NzUzIEMzNC42ODE4MjE0LDE3MS44OTMxMTkgNTUuNjc1MTg4LDE4MiA3OSwxODIgQzEyMy4xODI3OCwxODIgMTU5LDE0NS43MzUwNjUgMTU5LDEwMSBDMTU5LDc3Ljc0NTQ4MDIgMTQ5LjMyMTQ0Niw1Ni43Nzk3NjQ2IDEzMy44MjA0MjIsNDIuMDA3MTM4OSBMMjAuMDU4ODA4LDE1NS43Njg3NTMgWiIgaWQ9InBhdGgtNiI+PC9wYXRoPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTciIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTM4Ljk0MTE5MiIgaGVpZ2h0PSIxMzkuOTkyODYxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNiI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwYXRoIGQ9Ik0yMy45MjYwMTE1LDE1OC4wNTg4MzcgQzkuMTU4NTA1MjMsMTQzLjU0NDY0NCAtMS40MjEwODU0N2UtMTQsMTIzLjM0MTg2NCAtMS40MjEwODU0N2UtMTQsMTAxIEMtMS40MjEwODU0N2UtMTQsNTYuODE3MjIgMzUuODE3MjIsMjEgODAsMjEgQzEwMi4zNDE4NjQsMjEgMTIyLjU0NDY0NCwzMC4xNTg1MDUyIDEzNy4wNTg4MzcsNDQuOTI2MDExNSBMMjMuOTI2MDExNSwxNTguMDU4ODM3IFoiIGlkPSJwYXRoLTgiPjwvcGF0aD4KICAgICAgICA8cGF0aCBkPSJNMTA5My41NTgwNiwxNDMuMTk0MTQ2IEwxMDg3LDE4MS40MzA1OTMgTDExMzkuOTAwNjcsMTUzLjYxOTA2NCBMMTE5Mi44MDEzNSwxODEuNDMwNTkzIEwxMTgyLjY5ODIyLDEyMi41MjQ4MjggTDEyMjUuNDk1NzYsODAuODA3NTM0IEwxMTY2LjM1MTAxLDcyLjIxMzI5ODggTDExNjUuNzUyMjEsNzEgTDEwOTMuNTU4MDYsMTQzLjE5NDE0NiBaIiBpZD0icGF0aC05Ij48L3BhdGg+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTM4LjQ5NTc1OSIgaGVpZ2h0PSIxMTAuNDMwNTkzIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwYXRoIGQ9Ik0xMDkxLjk3NzgsMTUxLjAwNzA1MyBMMTA5Ni43OTc1NCwxMjIuOTA1NzY1IEwxMDU0LDgxLjE4ODQ3MDUgTDExMTMuMTQ0NzUsNzIuNTk0MjM1MyBMMTEzOS41OTUwOSwxOSBMMTE2Ni4wNDU0Miw3Mi41OTQyMzUzIEwxMTY5LjgzOTMzLDczLjE0NTUyMTcgTDEwOTEuOTc3OCwxNTEuMDA3MDUzIFoiIGlkPSJwYXRoLTExIj48L3BhdGg+CiAgICAgICAgPGNpcmNsZSBpZD0icGF0aC0xMiIgY3g9IjcyOSIgY3k9IjE0MCIgcj0iODAiPjwvY2lyY2xlPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTEzIiBwb2ludHM9IjEwMzkuNTk1MDkgMTk0IDk4Ni42OTQ0MTQgMjIxLjgxMTUyOSA5OTYuNzk3NTQzIDE2Mi45MDU3NjUgOTU0IDEyMS4xODg0NzEgMTAxMy4xNDQ3NSAxMTIuNTk0MjM1IDEwMzkuNTk1MDkgNTkgMTA2Ni4wNDU0MiAxMTIuNTk0MjM1IDExMjUuMTkwMTcgMTIxLjE4ODQ3MSAxMDgyLjM5MjYzIDE2Mi45MDU3NjUgMTA5Mi40OTU3NiAyMjEuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMTQiIHBvaW50cz0iODUxIDEyMCA4OTEgMTIwIDg5MSAxMDAgOTMxIDEzOS40OTc3NjcgODkxIDE4MCA4OTEgMTYwIDg1MSAxNjAiPjwvcG9seWdvbj4KICAgICAgICA8Y2lyY2xlIGlkPSJwYXRoLTE1IiBjeD0iODAiIGN5PSI4MCIgcj0iODAiPjwvY2lyY2xlPgogICAgICAgIDxjaXJjbGUgaWQ9InBhdGgtMTYiIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjgwIj48L2NpcmNsZT4KICAgICAgICA8Y2lyY2xlIGlkPSJwYXRoLTE3IiBjeD0iMTIwIiBjeT0iMTIwIiByPSI4MCI+PC9jaXJjbGU+CiAgICAgICAgPGNpcmNsZSBpZD0icGF0aC0xOCIgY3g9IjcyNyIgY3k9IjE0MyIgcj0iODAiPjwvY2lyY2xlPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTE5IiBwb2ludHM9IjEwMzcuNTk1MDkgMTk3IDk4NC42OTQ0MTQgMjI0LjgxMTUyOSA5OTQuNzk3NTQzIDE2NS45MDU3NjUgOTUyIDEyNC4xODg0NzEgMTAxMS4xNDQ3NSAxMTUuNTk0MjM1IDEwMzcuNTk1MDkgNjIgMTA2NC4wNDU0MiAxMTUuNTk0MjM1IDExMjMuMTkwMTcgMTI0LjE4ODQ3MSAxMDgwLjM5MjYzIDE2NS45MDU3NjUgMTA5MC40OTU3NiAyMjQuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMjAiIHBvaW50cz0iODUuNTk1MDg2NSAxMzUgMzIuNjk0NDEzOCAxNjIuODExNTI5IDQyLjc5NzU0MzIgMTAzLjkwNTc2NSAtMS4xNzIzOTU1MWUtMTMgNjIuMTg4NDcwNSA1OS4xNDQ3NTAxIDUzLjU5NDIzNTMgODUuNTk1MDg2NSAwIDExMi4wNDU0MjMgNTMuNTk0MjM1MyAxNzEuMTkwMTczIDYyLjE4ODQ3MDUgMTI4LjM5MjYzIDEwMy45MDU3NjUgMTM4LjQ5NTc1OSAxNjIuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMjEiIHBvaW50cz0iMTAxLjU5NTA4NiAxNTUgNDguNjk0NDEzOCAxODIuODExNTI5IDU4Ljc5NzU0MzIgMTIzLjkwNTc2NSAxNiA4Mi4xODg0NzA1IDc1LjE0NDc1MDEgNzMuNTk0MjM1MyAxMDEuNTk1MDg2IDIwIDEyOC4wNDU0MjMgNzMuNTk0MjM1MyAxODcuMTkwMTczIDgyLjE4ODQ3MDUgMTQ0LjM5MjYzIDEyMy45MDU3NjUgMTU0LjQ5NTc1OSAxODIuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMjIiIHBvaW50cz0iMTE5LjU5NTA4NiAxNzggNjYuNjk0NDEzOCAyMDUuODExNTI5IDc2Ljc5NzU0MzIgMTQ2LjkwNTc2NSAzNCAxMDUuMTg4NDcxIDkzLjE0NDc1MDEgOTYuNTk0MjM1MyAxMTkuNTk1MDg2IDQzIDE0Ni4wNDU0MjMgOTYuNTk0MjM1MyAyMDUuMTkwMTczIDEwNS4xODg0NzEgMTYyLjM5MjYzIDE0Ni45MDU3NjUgMTcyLjQ5NTc1OSAyMDUuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMjMiIHBvaW50cz0iODQ5IDEyMyA4ODkgMTIzIDg4OSAxMDMgOTI5IDE0Mi40OTc3NjcgODg5IDE4MyA4ODkgMTYzIDg0OSAxNjMiPjwvcG9seWdvbj4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJsaXN0LW9wdGlvbi1laXRoZXItbWFwIj4KICAgICAgICAgICAgPGcgaWQ9ImVpdGhlci1tYXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuMDAwMDAwLCA4MDAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjAiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xLUNvcHktMiI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxjaXJjbGUgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI3MjkiIGN5PSIxNDAiIHI9Ijc4Ij48L2NpcmNsZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEtQ29weS0yIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMiI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik05ODkuMzUwNjc2LDIxOC4xNTU0OTggTDk5OC43Njg3NiwxNjMuMjQzODU1IEw5OTguOTQ2NTA0LDE2Mi4yMDc1MjUgTDk5OC4xOTM1NjcsMTYxLjQ3MzU5MiBMOTU4LjI5NzkyMiwxMjIuNTg0OTUgTDEwMTMuNDMyMzUsMTE0LjU3MzQ0OSBMMTAxNC40NzI4OCwxMTQuNDIyMjUxIEwxMDE0LjkzODIyLDExMy40NzkzNjcgTDEwMzkuNTk1MDksNjMuNTE5MTAyOSBMMTA2NC4yNTE5NSwxMTMuNDc5MzY3IEwxMDY0LjcxNzI5LDExNC40MjIyNTEgTDEwNjUuNzU3ODMsMTE0LjU3MzQ0OSBMMTEyMC44OTIyNSwxMjIuNTg0OTUgTDEwODAuOTk2NjEsMTYxLjQ3MzU5MiBMMTA4MC4yNDM2NywxNjIuMjA3NTI1IEwxMDgwLjQyMTQxLDE2My4yNDM4NTUgTDEwODkuODM5NSwyMTguMTU1NDk4IEwxMDQwLjUyNTc3LDE5Mi4yMjk3MzcgTDEwMzkuNTk1MDksMTkxLjc0MDQ0OSBMMTAzOC42NjQ0LDE5Mi4yMjk3MzcgTDk4OS4zNTA2NzYsMjE4LjE1NTQ5OCBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUGF0aC0xLUNvcHktMyI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNODUzLDEyMiBMODkxLDEyMiBMODkzLDEyMiBMODkzLDEyMCBMODkzLDEwNC43ODU2MTUgTDkyOC4xNzE1MTcsMTM5LjUxNTUyNSBMODkzLDE3NS4xMjg2NDkgTDg5MywxNjAgTDg5MywxNTggTDg5MSwxNTggTDg1MywxNTggTDg1MywxMjIgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTQiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iMTE4MSAxMjAgMTIyMSAxMjAgMTIyMSAxMDAgMTI2MSAxMzkuNDk3NzY3IDEyMjEgMTgwIDEyMjEgMTYwIDExODEgMTYwIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iRWl0aGVyW0UsLUFdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTczLjgiIHk9IjMxNCI+RWl0aGVyW0UsIEFdPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJtYXAtY29weS0yIiBmb250LWZhbWlseT0iRmlyYU1vbm8tQm9sZCwgRmlyYSBNb25vIiBmb250LXNpemU9IjY0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI0Y2QTYyMyI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQ5OC40IiB5PSIxNTYiPm1hcDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iRWl0aGVyW0UsLUJdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTMwNS44IiB5PSIzMTQiPkVpdGhlcltFLCBCXTwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1CLUNvcHktMiIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjgyNS40IiB5PSIzMTQiPkEgPSZndDsgQjwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2MC4wMDAwMDAsIDU1LjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxODUuODc3MTMzLCAyMC4zMjI3ODUpIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNCI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZWxsaXBzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjYzLjU2MTQzMzQiIGN5PSI2My42NDI0MDUxIiByeD0iNjEuNTYxNDMzNCIgcnk9IjYxLjY0MjQwNTEiPjwvZWxsaXBzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbi0yIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgcG9pbnRzPSI2Mi42MjkyMzkxIDIwLjMyMjc4NDggMTI0Ljk4NjM0OCA2NS42ODU1OTExIDEwMS4xNjgwNTIgMTM5LjA4NDE1MyAyNC4wOTA0MjY0IDEzOS4wODQxNTMgMC4yNzIxMzAxNzYgNjUuNjg1NTkxMSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik0xODEuMDY5OTY2LDAuNTM0ODEwMTI3IEwxMjIuMzE1NywxNjguNDY1MTkiIGlkPSJMaW5lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSI+PC9wYXRoPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzAwLjAwMDAwMCwgNTkuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlN0YXItMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik0yMDguMjYzMDYyLDE0NS45OTI1MTcgTDIxNS45MzMxOTUsMTAxLjI1NjMzOCBMMjE2LjExMDgyNywxMDAuMjIwMjk1IEwyMTUuMzU4MjM2LDk5LjQ4NjQzOTYgTDE4Mi44NjYzNzgsNjcuODAzNDY1OSBMMjI3Ljc2ODM1Nyw2MS4yNzY1MTA5IEwyMjguODA4OTk4LDYxLjEyNTI0MzIgTDIyOS4yNzQyNTcsNjAuMTgyMTkwMiBMMjQ5LjM1NDM4LDE5LjQ4MDk3NzUgTDI2OS40MzQ1MDMsNjAuMTgyMTkwMiBMMjY5Ljg5OTc2Miw2MS4xMjUyNDMyIEwyNzAuOTQwNDAzLDYxLjI3NjUxMDkgTDMxNS44NDIzODIsNjcuODAzNDY1OSBMMjgzLjM1MDUyNCw5OS40ODY0Mzk2IEwyODIuNTk3OTMzLDEwMC4yMjAyOTUgTDI4Mi43NzU1NjUsMTAxLjI1NjMzOCBMMjkwLjQ0NTY5OCwxNDUuOTkyNTE3IEwyNTAuMjg1MzIxLDEyNC44NzE0NjQgTDI0OS4zNTQzOCwxMjQuMzgxODY1IEwyNDguNDIzNDM5LDEyNC44NzE0NjQgTDIwOC4yNjMwNjIsMTQ1Ljk5MjUxNyBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQb2x5Z29uLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBwb2ludHM9IjYyLjA0NTA3OTMgMjAuMjAyNTMxNiAxMjQuMDkwMTU5IDY1LjI5NjkxODkgMTAwLjM5MTA0NyAxMzguMjYxMTcgMjMuNjk5MTExNSAxMzguMjYxMTcgOS40NTkxMDAxN2UtMTQgNjUuMjk2OTE4OSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik0xNzkuMTAwOTkzLDAuNTMxNjQ1NTcgTDEyMC42NDA3MjgsMTY3LjQ2ODM1NCIgaWQ9IkxpbmUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Im9wdGlvbi1tYXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuMDAwMDAwLCA0MDMuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjAiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjc5LjAwMDAwMCwgMzguMDAwMDAwKSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBpZD0iQ29tYmluZWQtU2hhcGUiIHN0cm9rZT0iIzlCOUI5QiIgbWFzaz0idXJsKCNtYXNrLTcpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHN0cm9rZS1kYXNoYXJyYXk9IjEwLDUiIHhsaW5rOmhyZWY9IiNwYXRoLTYiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJDb21iaW5lZC1TaGFwZSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC04Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik0yMy45MzE0MjQ4LDE1NS4yMjQ5OTYgQzkuOTY4NTY3MTYsMTQwLjc5NDc4NyAyLDEyMS41MzI0MDQgMiwxMDEgQzIsNTcuOTIxNzg5NSAzNi45MjE3ODk1LDIzIDgwLDIzIEMxMDAuNTMyNDA0LDIzIDExOS43OTQ3ODcsMzAuOTY4NTY3MiAxMzQuMjI0OTk2LDQ0LjkzMTQyNDggTDIzLjkzMTQyNDgsMTU1LjIyNDk5NiBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjEwMjIiIHk9IjIiIHdpZHRoPSIxOTYiIGhlaWdodD0iMTk2IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1OS4wMDAwMDAsIDM4LjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgaWQ9IkNvbWJpbmVkLVNoYXBlIiBzdHJva2U9IiM5QjlCOUIiIG1hc2s9InVybCgjbWFzay0xMCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgc3Ryb2tlLWRhc2hhcnJheT0iMTAsNSIgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IkNvbWJpbmVkLVNoYXBlIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTExIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik0xMDk1LjAxMjYzLDE0NS4xNDM3OTUgTDEwOTguNzY4NzYsMTIzLjI0Mzg1NSBMMTA5OC45NDY1LDEyMi4yMDc1MjUgTDEwOTguMTkzNTcsMTIxLjQ3MzU5MiBMMTA1OC4yOTc5Miw4Mi41ODQ5NTAxIEwxMTEzLjQzMjM1LDc0LjU3MzQ0OTMgTDExMTQuNDcyODgsNzQuNDIyMjUwOCBMMTExNC45MzgyMiw3My40NzkzNjY3IEwxMTM5LjU5NTA5LDIzLjUxOTEwMjkgTDExNjQuMjUxOTUsNzMuNDc5MzY2NyBMMTE2NC43MTcyOSw3NC40MjIyNTA4IEwxMTY1LjYwNTE2LDc0LjU1MTI2NSBMMTA5NS4wMTI2MywxNDUuMTQzNzk1IFoiPjwvcGF0aD4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iMiIgeT0iMiIgd2lkdGg9IjE5NiIgaGVpZ2h0PSIxOTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTIiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxjaXJjbGUgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI3MjkiIGN5PSIxNDAiIHI9Ijc4Ij48L2NpcmNsZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik05ODkuMzUwNjc2LDIxOC4xNTU0OTggTDk5OC43Njg3NiwxNjMuMjQzODU1IEw5OTguOTQ2NTA0LDE2Mi4yMDc1MjUgTDk5OC4xOTM1NjcsMTYxLjQ3MzU5MiBMOTU4LjI5NzkyMiwxMjIuNTg0OTUgTDEwMTMuNDMyMzUsMTE0LjU3MzQ0OSBMMTAxNC40NzI4OCwxMTQuNDIyMjUxIEwxMDE0LjkzODIyLDExMy40NzkzNjcgTDEwMzkuNTk1MDksNjMuNTE5MTAyOSBMMTA2NC4yNTE5NSwxMTMuNDc5MzY3IEwxMDY0LjcxNzI5LDExNC40MjIyNTEgTDEwNjUuNzU3ODMsMTE0LjU3MzQ0OSBMMTEyMC44OTIyNSwxMjIuNTg0OTUgTDEwODAuOTk2NjEsMTYxLjQ3MzU5MiBMMTA4MC4yNDM2NywxNjIuMjA3NTI1IEwxMDgwLjQyMTQxLDE2My4yNDM4NTUgTDEwODkuODM5NSwyMTguMTU1NDk4IEwxMDQwLjUyNTc3LDE5Mi4yMjk3MzcgTDEwMzkuNTk1MDksMTkxLjc0MDQ0OSBMMTAzOC42NjQ0LDE5Mi4yMjk3MzcgTDk4OS4zNTA2NzYsMjE4LjE1NTQ5OCBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUGF0aC0xIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTQiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNODUzLDEyMiBMODkxLDEyMiBMODkzLDEyMiBMODkzLDEyMCBMODkzLDEwNC43ODU2MTUgTDkyOC4xNzE1MTcsMTM5LjUxNTUyNSBMODkzLDE3NS4xMjg2NDkgTDg5MywxNjAgTDg5MywxNTggTDg5MSwxNTggTDg1MywxNTggTDg1MywxMjIgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIxMTgxIDEyMCAxMjIxIDEyMCAxMjIxIDEwMCAxMjYxIDEzOS40OTc3NjcgMTIyMSAxODAgMTIyMSAxNjAgMTE4MSAxNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJPcHRpb25bQV0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIyNTUuNiIgeT0iMzE0Ij5PcHRpb25bQV08L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9Im1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI0OTguNCIgeT0iMTU2Ij5tYXA8L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9Ik9wdGlvbltCXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEyNzkuNiIgeT0iMzE0Ij5PcHRpb25bQl08L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstQiIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjgyNS40IiB5PSIzMTQiPkEgPSZndDsgQjwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Imxpc3QtbWFwIj4KICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJCYWNrZ3JvdW5kIiBmaWxsPSIjRkZGRkZGIiB4PSIwIiB5PSIwIiB3aWR0aD0iMTc2MSIgaGVpZ2h0PSIzNjAiPjwvcmVjdD4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yLUNvcHkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1OS4wMDAwMDAsIDQwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8Y2lyY2xlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iODAiIGN5PSI4MCIgcj0iNzgiPjwvY2lyY2xlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTE2Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGNpcmNsZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNzgiPjwvY2lyY2xlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTE3Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGNpcmNsZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjEyMCIgY3k9IjEyMCIgcj0iNzgiPjwvY2lyY2xlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEtQ29weSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTE4Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8Y2lyY2xlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNzI3IiBjeT0iMTQzIiByPSI3OCI+PC9jaXJjbGU+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iU3Rhci0xLUNvcHkiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik05ODcuMzUwNjc2LDIyMS4xNTU0OTggTDk5Ni43Njg3NiwxNjYuMjQzODU1IEw5OTYuOTQ2NTA0LDE2NS4yMDc1MjUgTDk5Ni4xOTM1NjcsMTY0LjQ3MzU5MiBMOTU2LjI5NzkyMiwxMjUuNTg0OTUgTDEwMTEuNDMyMzUsMTE3LjU3MzQ0OSBMMTAxMi40NzI4OCwxMTcuNDIyMjUxIEwxMDEyLjkzODIyLDExNi40NzkzNjcgTDEwMzcuNTk1MDksNjYuNTE5MTAyOSBMMTA2Mi4yNTE5NSwxMTYuNDc5MzY3IEwxMDYyLjcxNzI5LDExNy40MjIyNTEgTDEwNjMuNzU3ODMsMTE3LjU3MzQ0OSBMMTExOC44OTIyNSwxMjUuNTg0OTUgTDEwNzguOTk2NjEsMTY0LjQ3MzU5MiBMMTA3OC4yNDM2NywxNjUuMjA3NTI1IEwxMDc4LjQyMTQxLDE2Ni4yNDM4NTUgTDEwODcuODM5NSwyMjEuMTU1NDk4IEwxMDM4LjUyNTc3LDE5NS4yMjk3MzcgTDEwMzcuNTk1MDksMTk0Ljc0MDQ0OSBMMTAzNi42NjQ0LDE5NS4yMjk3MzcgTDk4Ny4zNTA2NzYsMjIxLjE1NTQ5OCBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtQ29weSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTI5OS4wMDAwMDAsIDQwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMjAiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTM1LjM1MDY3NTgsMTU5LjE1NTQ5OCBMNDQuNzY4NzU5OSwxMDQuMjQzODU1IEw0NC45NDY1MDQ0LDEwMy4yMDc1MjUgTDQ0LjE5MzU2NjYsMTAyLjQ3MzU5MiBMNC4yOTc5MjIyOCw2My41ODQ5NTAxIEw1OS40MzIzNDY3LDU1LjU3MzQ0OTMgTDYwLjQ3Mjg4MTEsNTUuNDIyMjUwOCBMNjAuOTM4MjIyMyw1NC40NzkzNjY3IEw4NS41OTUwODY1LDQuNTE5MTAyOTIgTDExMC4yNTE5NTEsNTQuNDc5MzY2NyBMMTEwLjcxNzI5Miw1NS40MjIyNTA4IEwxMTEuNzU3ODI2LDU1LjU3MzQ0OTMgTDE2Ni44OTIyNTEsNjMuNTg0OTUwMSBMMTI2Ljk5NjYwNiwxMDIuNDczNTkyIEwxMjYuMjQzNjY5LDEwMy4yMDc1MjUgTDEyNi40MjE0MTMsMTA0LjI0Mzg1NSBMMTM1LjgzOTQ5NywxNTkuMTU1NDk4IEw4Ni41MjU3Njg3LDEzMy4yMjk3MzcgTDg1LjU5NTA4NjUsMTMyLjc0MDQ0OSBMODQuNjY0NDA0MiwxMzMuMjI5NzM3IEwzNS4zNTA2NzU4LDE1OS4xNTU0OTggWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iU3Rhci0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik01MS4zNTA2NzU4LDE3OS4xNTU0OTggTDYwLjc2ODc1OTksMTI0LjI0Mzg1NSBMNjAuOTQ2NTA0NCwxMjMuMjA3NTI1IEw2MC4xOTM1NjY2LDEyMi40NzM1OTIgTDIwLjI5NzkyMjMsODMuNTg0OTUwMSBMNzUuNDMyMzQ2Nyw3NS41NzM0NDkzIEw3Ni40NzI4ODExLDc1LjQyMjI1MDggTDc2LjkzODIyMjMsNzQuNDc5MzY2NyBMMTAxLjU5NTA4NiwyNC41MTkxMDI5IEwxMjYuMjUxOTUxLDc0LjQ3OTM2NjcgTDEyNi43MTcyOTIsNzUuNDIyMjUwOCBMMTI3Ljc1NzgyNiw3NS41NzM0NDkzIEwxODIuODkyMjUxLDgzLjU4NDk1MDEgTDE0Mi45OTY2MDYsMTIyLjQ3MzU5MiBMMTQyLjI0MzY2OSwxMjMuMjA3NTI1IEwxNDIuNDIxNDEzLDEyNC4yNDM4NTUgTDE1MS44Mzk0OTcsMTc5LjE1NTQ5OCBMMTAyLjUyNTc2OSwxNTMuMjI5NzM3IEwxMDEuNTk1MDg2LDE1Mi43NDA0NDkgTDEwMC42NjQ0MDQsMTUzLjIyOTczNyBMNTEuMzUwNjc1OCwxNzkuMTU1NDk4IFoiPjwvcGF0aD4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlN0YXItMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0yMiI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNNjkuMzUwNjc1OCwyMDIuMTU1NDk4IEw3OC43Njg3NTk5LDE0Ny4yNDM4NTUgTDc4Ljk0NjUwNDQsMTQ2LjIwNzUyNSBMNzguMTkzNTY2NiwxNDUuNDczNTkyIEwzOC4yOTc5MjIzLDEwNi41ODQ5NSBMOTMuNDMyMzQ2Nyw5OC41NzM0NDkzIEw5NC40NzI4ODExLDk4LjQyMjI1MDggTDk0LjkzODIyMjMsOTcuNDc5MzY2NyBMMTE5LjU5NTA4Niw0Ny41MTkxMDI5IEwxNDQuMjUxOTUxLDk3LjQ3OTM2NjcgTDE0NC43MTcyOTIsOTguNDIyMjUwOCBMMTQ1Ljc1NzgyNiw5OC41NzM0NDkzIEwyMDAuODkyMjUxLDEwNi41ODQ5NSBMMTYwLjk5NjYwNiwxNDUuNDczNTkyIEwxNjAuMjQzNjY5LDE0Ni4yMDc1MjUgTDE2MC40MjE0MTMsMTQ3LjI0Mzg1NSBMMTY5LjgzOTQ5NywyMDIuMTU1NDk4IEwxMjAuNTI1NzY5LDE3Ni4yMjk3MzcgTDExOS41OTUwODYsMTc1Ljc0MDQ0OSBMMTE4LjY2NDQwNCwxNzYuMjI5NzM3IEw2OS4zNTA2NzU4LDIwMi4xNTU0OTggWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJQYXRoLTEtQ29weSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIzIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTg1MSwxMjUgTDg4OSwxMjUgTDg5MSwxMjUgTDg5MSwxMjMgTDg5MSwxMDcuNzg1NjE1IEw5MjYuMTcxNTE3LDE0Mi41MTU1MjUgTDg5MSwxNzguMTI4NjQ5IEw4OTEsMTYzIEw4OTEsMTYxIEw4ODksMTYxIEw4NTEsMTYxIEw4NTEsMTI1IFoiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjExNzkgMTIzIDEyMTkgMTIzIDEyMTkgMTAzIDEyNTkgMTQyLjQ5Nzc2NyAxMjE5IDE4MyAxMjE5IDE2MyAxMTc5IDE2MyI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHRleHQgaWQ9Ikxpc3RbQV0tQ29weSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjI3MC44IiB5PSIzMTciPkxpc3RbQV08L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9Im1hcC1jb3B5IiBmb250LWZhbWlseT0iRmlyYU1vbm8tQm9sZCwgRmlyYSBNb25vIiBmb250LXNpemU9IjY0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI0Y2QTYyMyI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQ5Ni40IiB5PSIxNTkiPm1hcDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iTGlzdFtCXS1Db3B5IiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTMxNC44IiB5PSIzMTciPkxpc3RbQl08L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstQi1Db3B5IiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iODIzLjQiIHk9IjMxNyI+QSA9Jmd0OyBCPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 1: Type chart: mapping over List, Option, and Either" id="fig:functors:list-option-either-type-chart" />
<p class="caption">Figure 1: Type chart: mapping over List, Option, and Either</p>
</div>
<p>Because <code>map</code> leaves the structure of the context unchanged, we can call it repeatedly to sequence multiple computations on the contents of an initial data structure:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).
  <span class="fu">map</span>(n =&gt; n + <span class="dv">1</span>).
  <span class="fu">map</span>(n =&gt; n * <span class="dv">2</span>).
  <span class="fu">map</span>(n =&gt; n + <span class="st">&quot;!&quot;</span>)
<span class="co">// res1: List[String] = List(4!, 6!, 8!)</span></code></pre></div>
<p>We should think of <code>map</code> not as an iteration pattern, but as a way of sequencing computations on values ignoring some complication dictated by the relevant data type:</p>
<ul>
<li><code>Option</code>—the value may or may not be present;</li>
<li><code>Either</code>—there may be a value or an error;</li>
<li><code>List</code>—there may be zero or more values.</li>
</ul>
<h2 id="sec:functors:more-examples"><span class="header-section-number">3.2</span> More Examples of Functors</h2>
<p>The <code>map</code> methods of <code>List</code>, <code>Option</code>, and <code>Either</code> apply functions eagerly. However, the idea of sequencing computations is more general than this. Let’s investigate the behaviour of some other functors that apply the pattern in different ways.</p>
<p><strong>Futures</strong></p>
<p><code>Future</code> is a functor that sequences asynchronous computations by queueing them and applying them as their predecessors complete. The type signature of its <code>map</code> method, shown in Figure 2, has the same shape as the signatures above. However, the behaviour is very different.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE1NjVweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE1NjUgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MCAoMzM3NjIpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPgogICAgPHRpdGxlPmZ1dHVyZS1tYXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xIiBjeD0iODAiIGN5PSI4MCIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMyIgY3g9IjYzOCIgY3k9IjE0MyIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay00IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNSIgcG9pbnRzPSI5NDIuNTk1MDg2IDE5NyA4ODkuNjk0NDE0IDIyNC44MTE1MjkgODk5Ljc5NzU0MyAxNjUuOTA1NzY1IDg1NyAxMjQuMTg4NDcxIDkxNi4xNDQ3NSAxMTUuNTk0MjM1IDk0Mi41OTUwODYgNjIgOTY5LjA0NTQyMyAxMTUuNTk0MjM1IDEwMjguMTkwMTcgMTI0LjE4ODQ3MSA5ODUuMzkyNjMgMTY1LjkwNTc2NSA5OTUuNDk1NzU5IDIyNC44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay02IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC03IiBwb2ludHM9Ijg1LjU5NTA4NjUgMTM1IDMyLjY5NDQxMzggMTYyLjgxMTUyOSA0Mi43OTc1NDMyIDEwMy45MDU3NjUgNS4zMjkwNzA1MmUtMTQgNjIuMTg4NDcwNSA1OS4xNDQ3NTAxIDUzLjU5NDIzNTMgODUuNTk1MDg2NSAwIDExMi4wNDU0MjMgNTMuNTk0MjM1MyAxNzEuMTkwMTczIDYyLjE4ODQ3MDUgMTI4LjM5MjYzIDEwMy45MDU3NjUgMTM4LjQ5NTc1OSAxNjIuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stOCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzEuMTkwMTczIiBoZWlnaHQ9IjE2Mi44MTE1MjkiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC03Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtOSIgcG9pbnRzPSI3NTYgMTIzIDc5NiAxMjMgNzk2IDEwMyA4MzYgMTQyLjQ5Nzc2NyA3OTYgMTgzIDc5NiAxNjMgNzU2IDE2MyI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEwIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgPC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImZ1dHVyZS1tYXAiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE1NjUiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxODYuMDAwMDAwLCA2MC4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEiIG1hc2s9InVybCgjbWFzay0yKSIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay00KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay02KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjIyLjAwMDAwMCwgNjAuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiMwMDAwMDAiIHhsaW5rOmhyZWY9IiNwYXRoLTkiPjwvdXNlPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjEwNjAgMTIzIDExMDAgMTIzIDExMDAgMTAzIDExNDAgMTQyLjQ5Nzc2NyAxMTAwIDE4MyAxMTAwIDE2MyAxMDYwIDE2MyI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iRnV0dXJlW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxNTIuNiIgeT0iMzE3Ij5GdXR1cmVbQV08L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJGdXR1cmVbQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjExOTYuNiIgeT0iMzE3Ij5GdXR1cmVbQl08L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBLT0mZ3Q7LUIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjczMC40IiB5PSIzMTciPkEgPSZndDsgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHBhdGggZD0iTTM2My4zMTUzNjEsMjEwLjQ2NzcyMSBDMzg1LjAwNjE2OSwxOTkuOTkyNDcxIDM5NiwxODMuOTYxMjE0IDM5NiwxNjEuOCBDMzk2LDEzNS43NTAyMzIgMzgwLjgwOTU4MywxMTguMTcwMzU5IDM1MC45MTA4ODksMTA4LjEyODE5IEMzNTQuOTA3Mjg4LDEwMS4wNzgxMDQgMzU3LjEzMjkyNCw5My4yNDcyNTE1IDM1Ny4xMzI5MjQsODUgQzM1Ny4xMzI5MjQsNTQuMDcyMDU0IDMyNS44MzM0LDI5IDI4Ny4yMjM0ODIsMjkgQzI2OC4xNzQyMzMsMjkgMjUwLjkwNDQ4OCwzNS4xMDMwNjI4IDIzOC4yOTUyOTksNDUuMDAxMzYgQzIzMy44ODc4NzIsNDMuOTU0ODc1NiAyMjkuMjgxNzcxLDQzLjQgMjI0LjU0MjE2OSw0My40IEMxOTIuNjgyNjU4LDQzLjQgMTY2Ljg1NTQyMiw2OC40NzIwNTQgMTY2Ljg1NTQyMiw5OS40IEMxNjYuODU1NDIyLDEwMy45MDkyIDE2Ny40MDQ0MjUsMTA4LjI5MzkyMyAxNjguNDQxMDgzLDExMi40OTQ2MTUgQzE0My42ODAwMDksMTIyLjk1MjM3MyAxMzAsMTM5LjE4NDE2NyAxMzAsMTYxLjggQzEzMCwxOTcuMjQ4NjI2IDE2My42MDkzNDUsMjE3LjAxMjgwOCAyMjAuODE5ODAyLDIyMy40NDE1OTQgQzIzMy43ODc2NzgsMjQxLjAzNTY5NiAyNTkuMjk0MDYxLDI1MyAyODguNjM4NTU0LDI1MyBDMzI0Ljc0MDkzNiwyNTMgMzU1LjAzMzg1NywyMzQuODkwNTIxIDM2My4zMTUzNiwyMTAuNDY3NzI1IFoiIGlkPSJDb21iaW5lZC1TaGFwZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTE0MDkuMzE1MzYsMjE5LjQ2NzcyMSBDMTQzMS4wMDYxNywyMDguOTkyNDcxIDE0NDIsMTkyLjk2MTIxNCAxNDQyLDE3MC44IEMxNDQyLDE0NC43NTAyMzIgMTQyNi44MDk1OCwxMjcuMTcwMzU5IDEzOTYuOTEwODksMTE3LjEyODE5IEMxNDAwLjkwNzI5LDExMC4wNzgxMDQgMTQwMy4xMzI5MiwxMDIuMjQ3MjUxIDE0MDMuMTMyOTIsOTQgQzE0MDMuMTMyOTIsNjMuMDcyMDU0IDEzNzEuODMzNCwzOCAxMzMzLjIyMzQ4LDM4IEMxMzE0LjE3NDIzLDM4IDEyOTYuOTA0NDksNDQuMTAzMDYyOCAxMjg0LjI5NTMsNTQuMDAxMzYgQzEyNzkuODg3ODcsNTIuOTU0ODc1NiAxMjc1LjI4MTc3LDUyLjQgMTI3MC41NDIxNyw1Mi40IEMxMjM4LjY4MjY2LDUyLjQgMTIxMi44NTU0Miw3Ny40NzIwNTQgMTIxMi44NTU0MiwxMDguNCBDMTIxMi44NTU0MiwxMTIuOTA5MiAxMjEzLjQwNDQyLDExNy4yOTM5MjMgMTIxNC40NDEwOCwxMjEuNDk0NjE1IEMxMTg5LjY4MDAxLDEzMS45NTIzNzMgMTE3NiwxNDguMTg0MTY3IDExNzYsMTcwLjggQzExNzYsMjA2LjI0ODYyNiAxMjA5LjYwOTM0LDIyNi4wMTI4MDggMTI2Ni44MTk4LDIzMi40NDE1OTQgQzEyNzkuNzg3NjgsMjUwLjAzNTY5NiAxMzA1LjI5NDA2LDI2MiAxMzM0LjYzODU1LDI2MiBDMTM3MC43NDA5NCwyNjIgMTQwMS4wMzM4NiwyNDMuODkwNTIxIDE0MDkuMzE1MzYsMjE5LjQ2NzcyNSBaIiBpZD0iQ29tYmluZWQtU2hhcGUiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0Ij48L3BhdGg+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJtYXAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1Cb2xkLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRjZBNjIzIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI0MjIuNCIgeT0iMTU4Ij5tYXA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 2: Type chart: mapping over a Future" id="fig:functors:future-type-chart" />
<p class="caption">Figure 2: Type chart: mapping over a Future</p>
</div>
<p>When we work with a <code>Future</code> we have no guarantees about its internal state. The wrapped computation may be ongoing, complete, or rejected. If the <code>Future</code> is complete, our mapping function can be called immediately. If not, some underlying thread pool queues the function call and comes back to it later. We don’t know <em>when</em> our functions will be called, but we do know <em>what order</em> they will be called in. In this way, <code>Future</code> provides the same sequencing behaviour seen in <code>List</code>, <code>Option</code>, and <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.{Future, Await}
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

<span class="kw">val</span> future: Future[String] =
  Future(<span class="dv">123</span>).
    <span class="fu">map</span>(n =&gt; n + <span class="dv">1</span>).
    <span class="fu">map</span>(n =&gt; n * <span class="dv">2</span>).
    <span class="fu">map</span>(n =&gt; n + <span class="st">&quot;!&quot;</span>)

Await.<span class="fu">result</span>(future, <span class="fl">1.</span>second)
<span class="co">// res3: String = 248!</span></code></pre></div>
<div class="callout callout-info">
<p><em>Futures and Referential Transparency</em></p>
<p>Note that Scala’s <code>Futures</code> aren’t a great example of pure functional programming because they aren’t <em>referentially transparent</em>. <code>Future</code> always computes and caches a result and there’s no way for us to tweak this behaviour. This means we can get unpredictable results when we use <code>Future</code> to wrap side-effecting computations. For example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">util</span>.<span class="fu">Random</span>

<span class="kw">val</span> future1 = {
  <span class="co">// Initialize Random with a fixed seed:</span>
  <span class="kw">val</span> r = <span class="kw">new</span> Random(0L)

  <span class="co">// nextInt has the side-effect of moving to</span>
  <span class="co">// the next random number in the sequence:</span>
  <span class="kw">val</span> x = Future(r.<span class="fu">nextInt</span>)

  <span class="kw">for</span> {
    a &lt;- x
    b &lt;- x
  } <span class="kw">yield</span> (a, b)
}

<span class="kw">val</span> future2 = {
  <span class="kw">val</span> r = <span class="kw">new</span> Random(0L)

  <span class="kw">for</span> {
    a &lt;- Future(r.<span class="fu">nextInt</span>)
    b &lt;- Future(r.<span class="fu">nextInt</span>)
  } <span class="kw">yield</span> (a, b)
}

<span class="kw">val</span> result1 = Await.<span class="fu">result</span>(future1, <span class="fl">1.</span>second)
<span class="co">// result1: (Int, Int) = (-1155484576,-1155484576)</span>

<span class="kw">val</span> result2 = Await.<span class="fu">result</span>(future2, <span class="fl">1.</span>second)
<span class="co">// result2: (Int, Int) = (-1155484576,-723955400)</span></code></pre></div>
<p>Ideally we would like <code>result1</code> and <code>result2</code> to contain the same value. However, the computation for <code>future1</code> calls <code>nextInt</code> once and the computation for <code>future2</code> calls it twice. Because <code>nextInt</code> returns a different result every time we get a different result in each case.</p>
<p>This kind of discrepancy makes it hard to reason about programs involving <code>Futures</code> and side-effects. There also are other problematic aspects of <code>Future's</code> behaviour, such as the way it always starts computations immediately rather than allowing the user to dictate when the program should run. For more information see <a href="https://www.reddit.com/r/scala/comments/3zofjl/why_is_future_totally_unusable/">this excellent Reddit answer</a> by Rob Norris.</p>
</div>
<p>If <code>Future</code> isn’t referentially transparent, perhaps we should look at another similar data-type that is. You should recognise this one…</p>
<p><strong>Functions (?!)</strong></p>
<p>It turns out that single argument functions are also functors. To see this we have to tweak the types a little. A function <code>A =&gt; B</code> has two type parameters: the parameter type <code>A</code> and the result type <code>B</code>. To coerce them to the correct shape we can fix the parameter type and let the result type vary:</p>
<ul>
<li>start with <code>X =&gt; A</code>;</li>
<li>supply a function <code>A =&gt; B</code>;</li>
<li>get back <code>X =&gt; B</code>.</li>
</ul>
<p>If we alias <code>X =&gt; A</code> as <code>MyFunc[A]</code>, we see the same pattern of types we saw with the other examples in this chapter. We also see this in Figure 3:</p>
<ul>
<li>start with <code>MyFunc[A]</code>;</li>
<li>supply a function <code>A =&gt; B</code>;</li>
<li>get back <code>MyFunc[B]</code>.</li>
</ul>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE1NThweCIgaGVpZ2h0PSIzMjVweCIgdmlld0JveD0iMCAwIDE1NTggMzI1IiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MCAoMzM3NjIpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPgogICAgPHRpdGxlPmZ1bmN0aW9uLW1hcDwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTEiIGN4PSIyNDguNDAzNjUzIiBjeT0iNTYuNTMzNzQyMyIgcng9IjUxLjQwMzY1MyIgcnk9IjUxLjUzMzc0MjMiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMi44MDczMDYiIGhlaWdodD0iMTAzLjA2NzQ4NSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0zIiBwb2ludHM9IjEyNC4zNzIzMDYgNDEuMjk0NDc4NSAxNTAuMDc0MTMyIDQxLjI5NDQ3ODUgMTUwLjA3NDEzMiAyOC40MTEwNDI5IDE3NS43NzU5NTkgNTMuODU0Mzg5OSAxNTAuMDc0MTMyIDc5Ljk0NDc4NTMgMTUwLjA3NDEzMiA2Ny4wNjEzNDk3IDEyNC4zNzIzMDYgNjcuMDYxMzQ5NyI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNTEuNDAzNjUzIiBoZWlnaHQ9IjUxLjUzMzc0MjMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtNSIgY3g9IjUxLjQwMzY1MyIgY3k9IjUyLjE3NzkxNDEiIHJ4PSI1MS40MDM2NTMiIHJ5PSI1MS41MzM3NDIzIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxMDIuODA3MzA2IiBoZWlnaHQ9IjEwMy4wNjc0ODUiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNyIgcG9pbnRzPSIyNDUuNDgwODk4IDg2Ljk2MzE5MDIgMjExLjQ4OTggMTA0Ljg3ODU5MyAyMTcuOTgxNTIyIDY2LjkzMzE2MTMgMTkwLjQ4MjE0NiA0MC4wNjAwNTc3IDIyOC40ODUzNDkgMzQuNTIzODkzOSAyNDUuNDgwODk4IDAgMjYyLjQ3NjQ0NyAzNC41MjM4OTM5IDMwMC40Nzk2NDkgNDAuMDYwMDU3NyAyNzIuOTgwMjczIDY2LjkzMzE2MTMgMjc5LjQ3MTk5NSAxMDQuODc4NTkzIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stOCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxMDkuOTk3NTAzIiBoZWlnaHQ9IjEwNC44Nzg1OTMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC03Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtOSIgcG9pbnRzPSIxMjIuMzcyMzA2IDM5LjI5NDQ3ODUgMTQ4LjA3NDEzMiAzOS4yOTQ0Nzg1IDE0OC4wNzQxMzIgMjYuNDExMDQyOSAxNzMuNzc1OTU5IDUxLjg1NDM4OTkgMTQ4LjA3NDEzMiA3Ny45NDQ3ODUzIDE0OC4wNzQxMzIgNjUuMDYxMzQ5NyAxMjIuMzcyMzA2IDY1LjA2MTM0OTciPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI1MS40MDM2NTMiIGhlaWdodD0iNTEuNTMzNzQyMyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTkiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0xMSIgcG9pbnRzPSIyNTQuNDgwODk4IDg3Ljk2MzE5MDIgMjIwLjQ4OTggMTA1Ljg3ODU5MyAyMjYuOTgxNTIyIDY3LjkzMzE2MTMgMTk5LjQ4MjE0NiA0MS4wNjAwNTc3IDIzNy40ODUzNDkgMzUuNTIzODkzOSAyNTQuNDgwODk4IDEgMjcxLjQ3NjQ0NyAzNS41MjM4OTM5IDMwOS40Nzk2NDkgNDEuMDYwMDU3NyAyODEuOTgwMjczIDY3LjkzMzE2MTMgMjg4LjQ3MTk5NSAxMDUuODc4NTkzIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTIiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTA5Ljk5NzUwMyIgaGVpZ2h0PSIxMDQuODc4NTkzIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0xMyIgcG9pbnRzPSIxMzEuMzcyMzA2IDQwLjI5NDQ3ODUgMTU3LjA3NDEzMiA0MC4yOTQ0Nzg1IDE1Ny4wNzQxMzIgMjcuNDExMDQyOSAxODIuNzc1OTU5IDUyLjg1NDM4OTkgMTU3LjA3NDEzMiA3OC45NDQ3ODUzIDE1Ny4wNzQxMzIgNjYuMDYxMzQ5NyAxMzEuMzcyMzA2IDY2LjA2MTM0OTciPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI1MS40MDM2NTMiIGhlaWdodD0iNTEuNTMzNzQyMyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZnVuY3Rpb24tbWFwIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNTU4IiBoZWlnaHQ9IjMyNSI+PC9yZWN0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU2LjAwMDAwMCwgNTEuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTIpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUGF0aC0xIiBtYXNrPSJ1cmwoI21hc2stNCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iIzAwMDAwMCIgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbiIgc3Ryb2tlLXdpZHRoPSI0IiBwb2ludHM9IjUzIDAuMDY1ODYxNzQyNCAxMDUuMzM5MjYzIDM4LjA5MjU2MjIgODUuMzQ3NDQzNSA5OS42MjEwNTYgMjAuNjUyNTU2NSA5OS42MjEwNTYgMC42NjA3MzcwMyAzOC4wOTI1NjIyIj48L3BvbHlnb24+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDY0Ny4wMDAwMDAsIDUzLjAwMDAwMCkiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4Ij4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTYpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMSIgbWFzaz0idXJsKCNtYXNrLTgpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC03Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgbWFzaz0idXJsKCNtYXNrLTEwKSIgZmlsbD0iIzAwMDAwMCIgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwODguMDAwMDAwLCA1Mi4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stMTIpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTExIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgbWFzaz0idXJsKCNtYXNrLTE0KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjMDAwMDAwIiB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbiIgc3Ryb2tlLXdpZHRoPSI0IiBwb2ludHM9IjUyLjY3ODUyNTkgMC44NTMxNjk1NDkgMTA1LjM1NzA1MiAzOS4xMjYzNTkgODUuMjM1NjQ1NCAxMDEuMDUzNjggMjAuMTIxNDA2NCAxMDEuMDUzNjggLTYuMzk0ODg0NjJlLTE0IDM5LjEyNjM1OSI+PC9wb2x5Z29uPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iOTg0IDg1IDEwMjQgODUgMTAyNCA2NSAxMDY0IDEwNC40OTc3NjcgMTAyNCAxNDUgMTAyNCAxMjUgOTg0IDEyNSI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iWC09Jmd0Oy1BIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIyMjUuNCIgeT0iMjgyIj5YID0mZ3Q7IEE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJYLT0mZ3Q7LUIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjExNzMuNCIgeT0iMjgyIj5YID0mZ3Q7IEI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBLT0mZ3Q7LUIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjcyMC40IiB5PSIyODIiPkEgPSZndDsgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Im1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQ5NS40IiB5PSIxMjMiPm1hcDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 3: Type chart: mapping over a Function1" id="fig:functors:function-type-chart" />
<p class="caption">Figure 3: Type chart: mapping over a Function1</p>
</div>
<p>In other words, “mapping” over a <code>Function1</code> is function composition:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">function</span>._ <span class="co">// for Functor</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._     <span class="co">// for map</span>

<span class="kw">val</span> func1: Int =&gt; Double =
  (x: Int) =&gt; x.<span class="fu">toDouble</span>

<span class="kw">val</span> func2: Double =&gt; Double =
  (y: Double) =&gt; y * <span class="dv">2</span>

(func1 map func2)(<span class="dv">1</span>)     <span class="co">// composition using map</span>
<span class="co">// res7: Double = 2.0</span>

(func1 andThen func2)(<span class="dv">1</span>) <span class="co">// composition using andThen</span>
<span class="co">// res8: Double = 2.0</span>

<span class="fu">func2</span>(<span class="fu">func1</span>(<span class="dv">1</span>))          <span class="co">// composition written out by hand</span>
<span class="co">// res9: Double = 2.0</span></code></pre></div>
<p>How does this relate to our general pattern of sequencing operations? If we think about it, function composition <em>is</em> sequencing. We start with a function that performs a single operation and every time we use <code>map</code> we append another operation to the chain. Calling <code>map</code> doesn’t actually <em>run</em> any of the operations, but if we can pass an argument to the final function all of the operations are run in sequence. We can think of this as lazily queueing up operations similar to <code>Future</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> func =
  ((x: Int) =&gt; x.<span class="fu">toDouble</span>).
    <span class="fu">map</span>(x =&gt; x + <span class="dv">1</span>).
    <span class="fu">map</span>(x =&gt; x * <span class="dv">2</span>).
    <span class="fu">map</span>(x =&gt; x + <span class="st">&quot;!&quot;</span>)

<span class="fu">func</span>(<span class="dv">123</span>)
<span class="co">// res10: String = 248.0!</span></code></pre></div>
<div class="callout callout-warning">
<p><em>Partial Unification</em></p>
<p>For the above examples to work we need to add the following compiler option to <code>build.sbt</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scalacOptions += <span class="st">&quot;-Ypartial-unification&quot;</span></code></pre></div>
<p>otherwise we’ll get a compiler error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">func1.<span class="fu">map</span>(func2)
<span class="co">// &lt;console&gt;: error: value map is not a member of Int =&gt; Double</span>
<span class="co">//        func1.map(func2)</span>
                ^</code></pre></div>
<p>We’ll look at why this happens in detail in Section 3.8.</p>
</div>
<h2 id="definition-of-a-functor"><span class="header-section-number">3.3</span> Definition of a Functor</h2>
<p>Every example we’ve looked at so far is a functor: a class that encapsulates sequencing computations. Formally, a functor is a type <code>F[A]</code> with an operation <code>map</code> with type <code>(A =&gt; B) =&gt; F[B]</code>. The general type chart is shown in Figure 4.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE1NjdweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE1NjcgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MCAoMzM3NjIpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPgogICAgPHRpdGxlPmdlbmVyaWMtbWFwPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMSIgY3g9IjgwIiBjeT0iODAiIHJ4PSI4MCIgcnk9IjgwIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTMiIGN4PSI2MzIiIGN5PSIxNDAiIHJ4PSI4MCIgcnk9IjgwIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTUiIHBvaW50cz0iOTQ1LjU5NTA4NiAxOTQgODkyLjY5NDQxNCAyMjEuODExNTI5IDkwMi43OTc1NDMgMTYyLjkwNTc2NSA4NjAgMTIxLjE4ODQ3MSA5MTkuMTQ0NzUgMTEyLjU5NDIzNSA5NDUuNTk1MDg2IDU5IDk3Mi4wNDU0MjMgMTEyLjU5NDIzNSAxMDMxLjE5MDE3IDEyMS4xODg0NzEgOTg4LjM5MjYzIDE2Mi45MDU3NjUgOTk4LjQ5NTc1OSAyMjEuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzEuMTkwMTczIiBoZWlnaHQ9IjE2Mi44MTE1MjkiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNyIgcG9pbnRzPSI4NS41OTUwODY1IDEzNSAzMi42OTQ0MTM4IDE2Mi44MTE1MjkgNDIuNzk3NTQzMiAxMDMuOTA1NzY1IC0xLjE3MjM5NTUxZS0xMyA2Mi4xODg0NzA1IDU5LjE0NDc1MDEgNTMuNTk0MjM1MyA4NS41OTUwODY1IDAgMTEyLjA0NTQyMyA1My41OTQyMzUzIDE3MS4xOTAxNzMgNjIuMTg4NDcwNSAxMjguMzkyNjMgMTAzLjkwNTc2NSAxMzguNDk1NzU5IDE2Mi44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay04IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC05IiBwb2ludHM9Ijc1NCAxMjAgNzk0IDEyMCA3OTQgMTAwIDgzNCAxMzkuNDk3NzY3IDc5NCAxODAgNzk0IDE2MCA3NTQgMTYwIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTEiIHg9IjE2NCIgeT0iMzciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiByeD0iOCI+PC9yZWN0PgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEzIiB4PSIxMjA0IiB5PSIzNyIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZ2VuZXJpYy1tYXAiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE1NjciIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxODQuMDAwMDAwLCA1Ny4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEiIG1hc2s9InVybCgjbWFzay0yKSIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay00KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay02KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjIwLjAwMDAwMCwgNTcuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiMwMDAwMDAiIHhsaW5rOmhyZWY9IiNwYXRoLTkiPjwvdXNlPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjEwODQgMTIwIDExMjQgMTIwIDExMjQgMTAwIDExNjQgMTM5LjQ5Nzc2NyAxMTI0IDE4MCAxMTI0IDE2MCAxMDg0IDE2MCI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iRltBXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjEzLjYiIHk9IjMxNCI+RltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkZbQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEyNTcuNiIgeT0iMzE0Ij5GW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1CIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI3MjguNCIgeT0iMzE0Ij5BID0mZ3Q7IEI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx1c2UgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMikiIHN0cm9rZS13aWR0aD0iOCIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTQpIiBzdHJva2Utd2lkdGg9IjgiIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICAgICAgPHRleHQgaWQ9Im1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQwNC40IiB5PSIxNTUiPm1hcDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 4: Type chart: generalised functor map" id="fig:functors:functor-type-chart" />
<p class="caption">Figure 4: Type chart: generalised functor map</p>
</div>
<p>Cats encodes <code>Functor</code> as a type class, <a href="http://typelevel.org/cats/api/cats/Functor.html"><code>cats.Functor</code></a>, so the method looks a little different. It accepts the initial <code>F[A]</code> as a parameter alongside the transformation function. Here’s a simplified version of the definition:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">trait</span> Functor[F[_]] {
  <span class="kw">def</span> map[A, B](fa: F[A])(f: A =&gt; B): F[B]
}</code></pre></div>
<p>If you haven’t seen syntax like <code>F[_]</code> before, it’s time to take a brief detour to discuss <em>type constructors</em> and <em>higher kinded types</em>. We’ll explain that <code>scala.language</code> import as well.</p>
<div class="callout callout-warning">
<p><em>Functor Laws</em></p>
<p>Functors guarantee the same semantics whether we sequence many small operations one by one, or combine them into a larger function before <code>mapping</code>. To ensure this is the case the following laws must hold:</p>
<p><em>Identity</em>: calling <code>map</code> with the identity function is the same as doing nothing:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">fa.<span class="fu">map</span>(a =&gt; a) == fa</code></pre></div>
<p><em>Composition</em>: <code>mapping</code> with two functions <code>f</code> and <code>g</code> is the same as <code>mapping</code> with <code>f</code> and then <code>mapping</code> with <code>g</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">fa.<span class="fu">map</span>(<span class="fu">g</span>(<span class="fu">f</span>(_))) == fa.<span class="fu">map</span>(f).<span class="fu">map</span>(g)</code></pre></div>
</div>
<h2 id="aside-higher-kinds-and-type-constructors"><span class="header-section-number">3.4</span> Aside: Higher Kinds and Type Constructors</h2>
<p>Kinds are like types for types. They describe the number of “holes” in a type. We distinguish between regular types that have no holes and “type constructors” that have holes we can fill to produce types.</p>
<p>For example, <code>List</code> is a type constructor with one hole. We fill that hole by specifying a parameter to produce a regular type like <code>List[Int]</code> or <code>List[A]</code>. The trick is not to confuse type constructors with generic types. <code>List</code> is a type constructor, <code>List[A]</code> is a type:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List    <span class="co">// type constructor, takes one parameter</span>
List[A] <span class="co">// type, produced using a type parameter</span></code></pre></div>
<p>There’s a close analogy here with functions and values. Functions are “value constructors”—they produce values when we supply parameters:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">math.<span class="fu">abs</span>    <span class="co">// function, takes one parameter</span>
math.<span class="fu">abs</span>(x) <span class="co">// value, produced using a value parameter</span></code></pre></div>
<p>In Scala we declare type constructors using underscores. Once we’ve declared them, however, we refer to them as simple identifiers:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Declare F using underscores:</span>
<span class="kw">def</span> myMethod[F[_]] = {

  <span class="co">// Reference F without underscores:</span>
  <span class="kw">val</span> functor = Functor.<span class="fu">apply</span>[F]

  <span class="co">// ...</span>
}</code></pre></div>
<p>This is analogous to specifying a function’s parameters in its definition and omitting them when referring to it:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Declare f specifying parameters:</span>
<span class="kw">val</span> f = (x: Int) =&gt; x * <span class="dv">2</span>

<span class="co">// Reference f without parameters:</span>
<span class="kw">val</span> f2 = f andThen f</code></pre></div>
<p>Armed with this knowledge of type constructors, we can see that the Cats definition of <code>Functor</code> allows us to create instances for any single-parameter type constructor, such as <code>List</code>, <code>Option</code>, <code>Future</code>, or a type alias such as <code>MyFunc</code>.</p>
<div class="callout callout-info">
<p><em>Language Feature Imports</em></p>
<p>Higher kinded types are considered an advanced language feature in Scala. Whenever we declare a type constructor with <code>A[_]</code> syntax, we need to “enable” the higher kinded type language feature to suppress warnings from the compiler. We can either do this with a “language import” as above:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span></code></pre></div>
<p>or by adding the following to <code>scalacOptions</code> in <code>build.sbt</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scalacOptions += <span class="st">&quot;-language:higherKinds&quot;</span></code></pre></div>
<p>We’ll use the language import in this book to ensure we are as explicit as possible. In practice, however, we find the <code>scalacOptions</code> flag to be simpler and less verbose.</p>
</div>
<h2 id="functors-in-cats"><span class="header-section-number">3.5</span> Functors in Cats</h2>
<p>Let’s look at the implementation of functors in Cats. We’ll examine the aspects we did for monoids: the <em>type class</em>, the <em>instances</em>, and the <em>syntax</em>.</p>
<h3 id="the-functor-type-class"><span class="header-section-number">3.5.1</span> The Functor Type Class</h3>
<p>The functor type class is <a href="http://typelevel.org/cats/api/cats/Functor.html"><code>cats.Functor</code></a>. We obtain instances using the standard <code>Functor.apply</code> method on the companion object. As usual, default instances are arranged by type in the <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a> package:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>
<span class="kw">import</span> cats.<span class="fu">Functor</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Functor</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Functor</span>

<span class="kw">val</span> list1 = List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)
<span class="co">// list1: List[Int] = List(1, 2, 3)</span>

<span class="kw">val</span> list2 = Functor[List].<span class="fu">map</span>(list1)(_ * <span class="dv">2</span>)
<span class="co">// list2: List[Int] = List(2, 4, 6)</span>

<span class="kw">val</span> option1 = Option(<span class="dv">123</span>)
<span class="co">// option1: Option[Int] = Some(123)</span>

<span class="kw">val</span> option2 = Functor[Option].<span class="fu">map</span>(option1)(_.<span class="fu">toString</span>)
<span class="co">// option2: Option[String] = Some(123)</span></code></pre></div>
<p><code>Functor</code> also provides the <code>lift</code> method, which converts a function of type <code>A =&gt; B</code> to one that operates over a functor and has type <code>F[A] =&gt; F[B]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> func = (x: Int) =&gt; x + <span class="dv">1</span>
<span class="co">// func: Int =&gt; Int = &lt;function1&gt;</span>

<span class="kw">val</span> liftedFunc = Functor[Option].<span class="fu">lift</span>(func)
<span class="co">// liftedFunc: Option[Int] =&gt; Option[Int] = cats.Functor$$Lambda$11698/1285559151@d19d48f</span>

<span class="fu">liftedFunc</span>(Option(<span class="dv">1</span>))
<span class="co">// res0: Option[Int] = Some(2)</span></code></pre></div>
<h3 id="functor-syntax"><span class="header-section-number">3.5.2</span> Functor Syntax</h3>
<p>The main method provided by the syntax for <code>Functor</code> is <code>map</code>. It’s difficult to demonstrate this with <code>Options</code> and <code>Lists</code> as they have their own built-in <code>map</code> methods and the Scala compiler will always prefer a built-in method over an extension method. We’ll work around this with two examples.</p>
<p>First let’s look at mapping over functions. Scala’s <code>Function1</code> type doesn’t have a <code>map</code> method (it’s called <code>andThen</code> instead) so there are no naming conflicts:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">function</span>._ <span class="co">// for Functor</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._     <span class="co">// for map</span>

<span class="kw">val</span> func1 = (a: Int) =&gt; a + <span class="dv">1</span>
<span class="kw">val</span> func2 = (a: Int) =&gt; a * <span class="dv">2</span>
<span class="kw">val</span> func3 = (a: Int) =&gt; a + <span class="st">&quot;!&quot;</span>
<span class="kw">val</span> func4 = func1.<span class="fu">map</span>(func2).<span class="fu">map</span>(func3)

<span class="fu">func4</span>(<span class="dv">123</span>)
<span class="co">// res1: String = 248!</span></code></pre></div>
<p>Let’s look at another example. This time we’ll abstract over functors so we’re not working with any particular concrete type. We can write a method that applies an equation to a number no matter what functor context it’s in:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> doMath[F[_]](start: F[Int])
    (<span class="kw">implicit</span> functor: Functor[F]): F[Int] =
  start.<span class="fu">map</span>(n =&gt; n + <span class="dv">1</span> * <span class="dv">2</span>)

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Functor</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Functor</span>

<span class="fu">doMath</span>(Option(<span class="dv">20</span>))
<span class="co">// res3: Option[Int] = Some(22)</span>

<span class="fu">doMath</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res4: List[Int] = List(3, 4, 5)</span></code></pre></div>
<p>To illustrate how this works, let’s take a look at the definition of the <code>map</code> method in <code>cats.syntax.functor</code>. Here’s a simplified version of the code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">class</span> FunctorOps[F[_], A](src: F[A]) {
  <span class="kw">def</span> map[B](func: A =&gt; B)
      (<span class="kw">implicit</span> functor: Functor[F]): F[B] =
    functor.<span class="fu">map</span>(src)(func)
}</code></pre></div>
<p>The compiler can use this extension method to insert a <code>map</code> method wherever no built-in <code>map</code> is available:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">foo.<span class="fu">map</span>(value =&gt; value + <span class="dv">1</span>)</code></pre></div>
<p>Assuming <code>foo</code> has no built-in <code>map</code> method, the compiler detects the potential error and wraps the expression in a <code>FunctorOps</code> to fix the code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">new</span> <span class="fu">FunctorOps</span>(foo).<span class="fu">map</span>(value =&gt; value + <span class="dv">1</span>)</code></pre></div>
<p>The <code>map</code> method of <code>FunctorOps</code> requires an implicit <code>Functor</code> as a parameter. This means this code will only compile if we have a <code>Functor</code> for <code>expr1</code> in scope. If we don’t, we get a compiler error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Box[A](value: A)

<span class="kw">val</span> box = Box[Int](<span class="dv">123</span>)

box.<span class="fu">map</span>(value =&gt; value + <span class="dv">1</span>)
<span class="co">// &lt;console&gt;:34: error: value map is not a member of Box[Int]</span>
<span class="co">//        box.map(value =&gt; value + 1)</span>
<span class="co">//            ^</span></code></pre></div>
<h3 id="instances-for-custom-types"><span class="header-section-number">3.5.3</span> Instances for Custom Types</h3>
<p>We can define a functor simply by defining its map method. Here’s an example of a <code>Functor</code> for <code>Option</code>, even though such a thing already exists in <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a>. The implementation is trivial—we simply call <code>Option's</code> <code>map</code> method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> optionFunctor: Functor[Option] =
  <span class="kw">new</span> Functor[Option] {
    <span class="kw">def</span> map[A, B](value: Option[A])(func: A =&gt; B): Option[B] =
      value.<span class="fu">map</span>(func)
  }</code></pre></div>
<p>Sometimes we need to inject dependencies into our instances. For example, if we had to define a custom <code>Functor</code> for <code>Future</code> (another hypothetical example—Cats provides one in <code>cats.instances.future</code>) we would need to account for the implicit <code>ExecutionContext</code> parameter on <code>future.map</code>. We can’t add extra parameters to <code>functor.map</code> so we have to account for the dependency when we create the instance:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.{Future, ExecutionContext}

<span class="kw">implicit</span> <span class="kw">def</span> futureFunctor
    (<span class="kw">implicit</span> ec: ExecutionContext): Functor[Future] =
  <span class="kw">new</span> Functor[Future] {
    <span class="kw">def</span> map[A, B](value: Future[A])(func: A =&gt; B): Future[B] =
      value.<span class="fu">map</span>(func)
  }</code></pre></div>
<p>Whenever we summon a <code>Functor</code> for <code>Future</code>, either directly using <code>Functor.apply</code> or indirectly via the <code>map</code> extension method, the compiler will locate <code>futureFunctor</code> by implicit resolution and recursively search for an <code>ExecutionContext</code> at the call site. This is what the expansion might look like:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// We write this:</span>
Functor[Future]

<span class="co">// The compiler expands to this first:</span>
Functor[Future](futureFunctor)

<span class="co">// And then to this:</span>
Functor[Future](<span class="fu">futureFunctor</span>(executionContext))</code></pre></div>
<h3 id="exercise-branching-out-with-functors"><span class="header-section-number">3.5.4</span> Exercise: Branching out with Functors</h3>
<p>Write a <code>Functor</code> for the following binary tree data type. Verify that the code works as expected on instances of <code>Branch</code> and <code>Leaf</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Tree[+A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Branch[A](left: Tree[A], right: Tree[A])
  <span class="kw">extends</span> Tree[A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Leaf[A](value: A) <span class="kw">extends</span> Tree[A]</code></pre></div>
<div class="solution">
<p>The semantics are similar to writing a <code>Functor</code> for <code>List</code>. We recurse over the data structure, applying the function to every <code>Leaf</code> we find. The functor laws intuitively require us to retain the same structure with the same pattern of <code>Branch</code> and <code>Leaf</code> nodes:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Functor</span>

<span class="kw">implicit</span> <span class="kw">val</span> treeFunctor: Functor[Tree] =
  <span class="kw">new</span> Functor[Tree] {
    <span class="kw">def</span> map[A, B](tree: Tree[A])(func: A =&gt; B): Tree[B] =
      tree <span class="kw">match</span> {
        <span class="kw">case</span> <span class="fu">Branch</span>(left, right) =&gt;
          <span class="fu">Branch</span>(<span class="fu">map</span>(left)(func), <span class="fu">map</span>(right)(func))
        <span class="kw">case</span> <span class="fu">Leaf</span>(value) =&gt;
          <span class="fu">Leaf</span>(<span class="fu">func</span>(value))
      }
  }</code></pre></div>
<p>Let’s use our <code>Functor</code> to transform some <code>Trees</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">Branch</span>(<span class="fu">Leaf</span>(<span class="dv">10</span>), <span class="fu">Leaf</span>(<span class="dv">20</span>)).<span class="fu">map</span>(_ * <span class="dv">2</span>)
<span class="co">// &lt;console&gt;:42: error: value map is not a member of wrapper.Branch[Int]</span>
<span class="co">//        Branch(Leaf(10), Leaf(20)).map(_ * 2)</span>
<span class="co">//                                   ^</span></code></pre></div>
<p>Oops! This falls foul of the same invariance problem we discussed in Section 1.6.1. The compiler can find a <code>Functor</code> instance for <code>Tree</code> but not for <code>Branch</code> or <code>Leaf</code>. Let’s add some smart constructors to compensate:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Tree {
  <span class="kw">def</span> branch[A](left: Tree[A], right: Tree[A]): Tree[A] =
    <span class="fu">Branch</span>(left, right)

  <span class="kw">def</span> leaf[A](value: A): Tree[A] =
    <span class="fu">Leaf</span>(value)
}</code></pre></div>
<p>Now we can use our <code>Functor</code> properly:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Tree.<span class="fu">leaf</span>(<span class="dv">100</span>).<span class="fu">map</span>(_ * <span class="dv">2</span>)
<span class="co">// res10: wrapper.Tree[Int] = Leaf(200)</span>

Tree.<span class="fu">branch</span>(Tree.<span class="fu">leaf</span>(<span class="dv">10</span>), Tree.<span class="fu">leaf</span>(<span class="dv">20</span>)).<span class="fu">map</span>(_ * <span class="dv">2</span>)
<span class="co">// res11: wrapper.Tree[Int] = Branch(Leaf(20),Leaf(40))</span></code></pre></div>
</div>
<h2 id="contravariant-invariant"><span class="header-section-number">3.6</span> <em>Contravariant</em> and Invariant Functors</h2>
<p>As we have seen, we can think of <code>Functor's</code> <code>map</code> method as “appending” a transformation to a chain. We’re now going to look at two other type classes, one representing <em>prepending</em> operations to a chain, and one representing building a <em>bidirectional</em> chain of operations. These are called <em>contravariant</em> and <em>invariant functors</em> respectively.</p>
<div class="callout callout-info">
<p><em>This Section is Optional!</em></p>
<p>You don’t need to know about contravariant and invariant functors to understand monads, which are the most important pattern in this book and the focus of the next chapter. However, contravariant and invariant do come in handy in our discussion of <code>Semigroupal</code> and <code>Applicative</code> in Chapter 6.</p>
<p>If you want to move on to monads now, feel free to skip straight to Chapter 4. Come back here before you read Chapter 6.</p>
</div>
<h3 id="contravariant"><span class="header-section-number">3.6.1</span> Contravariant Functors and the <em>contramap</em> Method</h3>
<p>The first of our type classes, the <em>contravariant functor</em>, provides an operation called <code>contramap</code> that represents “prepending” an operation to a chain. The general type signature is shown in Figure 5.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE3NjJweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE3NjIgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MC4zICgzMzgzOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+CiAgICA8dGl0bGU+Z2VuZXJpYy1jb250cmFtYXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xIiBjeD0iNjQiIGN5PSI2My45MDI0MzkiIHJ4PSI2NCIgcnk9IjYzLjkwMjQzOSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTIiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyNy44MDQ4NzgiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMyIgcG9pbnRzPSIzMTQuODc2MDY5IDEwOC42MzQxNDYgMjcyLjU1NTUzMSAxMzAuODQ5NDUzIDI4MC42MzgwMzUgODMuNzk2Njc3OSAyNDYuNCA1MC40NzM3MTczIDI5My43MTU4IDQzLjYwODgwOTkgMzE0Ljg3NjA2OSAwLjc5ODc4MDQ4OCAzMzYuMDM2MzM4IDQzLjYwODgwOTkgMzgzLjM1MjEzOCA1MC40NzM3MTczIDM0OS4xMTQxMDQgODMuNzk2Njc3OSAzNTcuMTk2NjA3IDEzMC44NDk0NTMiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay00IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjEzNi45NTIxMzgiIGhlaWdodD0iMTMwLjA1MDY3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC01IiBwb2ludHM9IjE2MS42IDQ3LjkyNjgyOTMgMTkzLjYgNDcuOTI2ODI5MyAxOTMuNiAzMS45NTEyMTk1IDIyNS42IDYzLjUwMTI2NTIgMTkzLjYgOTUuODUzNjU4NSAxOTMuNiA3OS44NzgwNDg4IDE2MS42IDc5Ljg3ODA0ODgiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay02IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjYzLjkwMjQzOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC03IiBwb2ludHM9IjY4LjQ3NjA2OTIgMTA4IDI2LjE1NTUzMSAxMzAuMjQ5MjI0IDM0LjIzODAzNDYgODMuMTI0NjExOCAtOS40MTQ2OTEyNWUtMTQgNDkuNzUwNzc2NCA0Ny4zMTU4MDAxIDQyLjg3NTM4ODIgNjguNDc2MDY5MiAwIDg5LjYzNjMzODMgNDIuODc1Mzg4MiAxMzYuOTUyMTM4IDQ5Ljc1MDc3NjQgMTAyLjcxNDEwNCA4My4xMjQ2MTE4IDExMC43OTY2MDcgMTMwLjI0OTIyNCI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTgiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTM2Ljk1MjEzOCIgaGVpZ2h0PSIxMzAuMjQ5MjI0IiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTkiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiByeD0iNi40Ij48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTkiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xMSIgY3g9IjY0IiBjeT0iNjQiIHJ4PSI2NCIgcnk9IjY0Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTIiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTExIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTMiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiByeD0iNi40Ij48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZ2VuZXJpYy1jb250cmFtYXAiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjIiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC03IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3ODcuMDAwMDAwLCA3NS4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNi40Ij4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTIpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMSIgbWFzaz0idXJsKCNtYXNrLTQpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgbWFzaz0idXJsKCNtYXNrLTYpIiBmaWxsPSIjMDAwMDAwIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjEyMTMgMTIzIDEyNDUgMTIzIDEyNDUgMTA3IDEyNzcgMTM4LjU5ODIxNCAxMjQ1IDE3MSAxMjQ1IDE1NSAxMjEzIDE1NSI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iRltCXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzEyLjYiIHk9IjMxNCI+RltCXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkZbQV0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEzNTYuNiIgeT0iMzE0Ij5GW0FdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1CIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI5MDAuNCIgeT0iMzE0Ij5BID0mZ3Q7IEI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC05IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyODAuMDAwMDAwLCA1Ny4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNi40Ij4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEuMjAwMDAwLCAxNS4yMDAwMDApIiBmaWxsPSIjRkZGRkZGIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEiIG1hc2s9InVybCgjbWFzay04KSIgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJSZWN0YW5nbGUtMSIgbWFzaz0idXJsKCNtYXNrLTEwKSIgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTgiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzMjAuMDAwMDAwLCA1Ny4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNi40Ij4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNi4wMDAwMDAsIDE5LjIwMDAwMCkiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTEyKSIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUmVjdGFuZ2xlLTEiIG1hc2s9InVybCgjbWFzay0xNCkiIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iY29udHJhbWFwIiBmb250LWZhbWlseT0iRmlyYU1vbm8tQm9sZCwgRmlyYSBNb25vIiBmb250LXNpemU9IjUxLjIiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRjZBNjIzIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI0NzQuMjYiIHk9IjE1MSI+Y29udHJhbWFwPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 5: Type chart: the contramap method" id="fig:functors:contramap-type-chart" />
<p class="caption">Figure 5: Type chart: the contramap method</p>
</div>
<p>The <code>contramap</code> method only makes sense for data types that represent <em>transformations</em>. For example, we can’t define <code>contramap</code> for an <code>Option</code> because there is no way of feeding a value in an <code>Option[B]</code> backwards through a function <code>A =&gt; B</code>. However, we can define <code>contramap</code> for the <code>Printable</code> type class we discussed in Chapter 1:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Printable[A] {
  <span class="kw">def</span> <span class="fu">format</span>(value: A): String
}</code></pre></div>
<p>A <code>Printable[A]</code> represents a transformation from <code>A</code> to <code>String</code>. Its <code>contramap</code> method accepts a function <code>func</code> of type <code>B =&gt; A</code> and creates a new <code>Printable[B]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Printable[A] {
  <span class="kw">def</span> <span class="fu">format</span>(value: A): String

  <span class="kw">def</span> contramap[B](func: B =&gt; A): Printable[B] =
    ???
}

<span class="kw">def</span> format[A](value: A)(<span class="kw">implicit</span> p: Printable[A]): String =
  p<span class="fu">.format</span>(value)</code></pre></div>
<h4 id="exercise-showing-off-with-contramap"><span class="header-section-number">3.6.1.1</span> Exercise: Showing off with Contramap</h4>
<p>Implement the <code>contramap</code> method for <code>Printable</code> above. Start with the following code template and replace the <code>???</code> with a working method body:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Printable[A] {
  <span class="kw">def</span> <span class="fu">format</span>(value: A): String

  <span class="kw">def</span> contramap[B](func: B =&gt; A): Printable[B] =
    <span class="kw">new</span> Printable[B] {
      <span class="kw">def</span> <span class="fu">format</span>(value: B): String =
        ???
    }
}</code></pre></div>
<p>If you get stuck, think about the types. You need to turn <code>value</code>, which is of type <code>B</code>, into a <code>String</code>. What functions and methods do you have available and in what order do they need to be combined?</p>
<div class="solution">
<p>Here’s a working implementation. We call <code>func</code> to turn the <code>B</code> into an <code>A</code> and then use our original <code>Printable</code> to turn the <code>A</code> into a <code>String</code>. In a small show of sleight of hand we use a <code>self</code> alias to distinguish the outer and inner <code>Printables</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Printable[A] {
  self =&gt;

  <span class="kw">def</span> <span class="fu">format</span>(value: A): String

  <span class="kw">def</span> contramap[B](func: B =&gt; A): Printable[B] =
    <span class="kw">new</span> Printable[B] {
      <span class="kw">def</span> <span class="fu">format</span>(value: B): String =
        self<span class="fu">.format</span>(func(value))
    }
}

<span class="kw">def</span> format[A](value: A)(<span class="kw">implicit</span> p: Printable[A]): String =
  p<span class="fu">.format</span>(value)</code></pre></div>
</div>
<p>For testing purposes, let’s define some instances of <code>Printable</code> for <code>String</code> and <code>Boolean</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> stringPrintable: Printable[String] =
  <span class="kw">new</span> Printable[String] {
    <span class="kw">def</span> <span class="fu">format</span>(value: String): String =
      <span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">&quot;</span> + value + <span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">&quot;</span>
  }

<span class="kw">implicit</span> <span class="kw">val</span> booleanPrintable: Printable[Boolean] =
  <span class="kw">new</span> Printable[Boolean] {
    <span class="kw">def</span> <span class="fu">format</span>(value: Boolean): String =
      <span class="kw">if</span>(value) <span class="st">&quot;yes&quot;</span> <span class="kw">else</span> <span class="st">&quot;no&quot;</span>
  }

<span class="fu">format</span>(<span class="st">&quot;hello&quot;</span>)
<span class="co">// res3: String = &quot;hello&quot;</span>

<span class="fu">format</span>(<span class="kw">true</span>)
<span class="co">// res4: String = yes</span></code></pre></div>
<p>Now define an instance of <code>Printable</code> for the following <code>Box</code> case class. You’ll need to write this as an <code>implicit def</code> as described in Section 1.2.3:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Box[A](value: A)</code></pre></div>
<p>Rather than writing out the complete definition from scratch (<code>new Printable[Box]</code> etc…), create your instance from an existing instance using <code>contramap</code>.</p>
<div class="solution">
<p>To make the instance generic across all types of <code>Box</code>, we base it on the <code>Printable</code> for the type inside the <code>Box</code>. We can either write out the complete definition by hand:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> boxPrintable[A](<span class="kw">implicit</span> p: Printable[A]) =
  <span class="kw">new</span> Printable[Box[A]] {
    <span class="kw">def</span> <span class="fu">format</span>(box: Box[A]): String =
      p<span class="fu">.format</span>(box.value)
  }</code></pre></div>
<p>or use <code>contramap</code> to base the new instance on the implicit parameter:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> boxPrintable[A](<span class="kw">implicit</span> p: Printable[A]) =
  p.<span class="fu">contramap</span>[Box[A]](_.<span class="fu">value</span>)</code></pre></div>
<p>Using <code>contramap</code> is much simpler, and conveys the functional programming approach of building solutions by combining simple building blocks using pure functional combinators.</p>
</div>
<p>Your instance should work as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">format</span>(Box(<span class="st">&quot;hello world&quot;</span>))
<span class="co">// res5: String = &quot;hello world&quot;</span>

<span class="fu">format</span>(Box(<span class="kw">true</span>))
<span class="co">// res6: String = yes</span></code></pre></div>
<p>If we don’t have a <code>Printable</code> for the type inside the <code>Box</code>, calls to <code>format</code> should fail to compile:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">format</span>(Box(<span class="dv">123</span>))
<span class="co">// &lt;console&gt;:21: error: could not find implicit value for parameter p: Printable[Box[Int]]</span>
<span class="co">//        format(Box(123))</span>
<span class="co">//              ^</span></code></pre></div>
<h3 id="sec:functors:invariant"><span class="header-section-number">3.6.2</span> Invariant functors and the <em>imap</em> method</h3>
<p><em>Invariant functors</em> implement a method called <code>imap</code> that is informally equivalent to a combination of <code>map</code> and <code>contramap</code>. If <code>map</code> generates new type class instances by appending a function to a chain, and <code>contramap</code> generates them by prepending an operation to a chain, <code>imap</code> generates them via a pair of bidirectional transformations.</p>
<p>The most intuitive examples of this are a type class that represents encoding and decoding as some data type, such as Play JSON’s <a href="https://www.playframework.com/documentation/2.6.x/ScalaJsonCombinators#Format"><code>Format</code></a> and scodec’s <a href="http://scodec.org/guide/Core+Algebra.html#Codec"><code>Codec</code></a>. We can build our own <code>Codec</code> by enhancing <code>Printable</code> to support encoding and decoding to/from a <code>String</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Codec[A] {
  <span class="kw">def</span> <span class="fu">encode</span>(value: A): String
  <span class="kw">def</span> <span class="fu">decode</span>(value: String): A
  <span class="kw">def</span> imap[B](dec: A =&gt; B, enc: B =&gt; A): Codec[B] = ???
}

<span class="kw">def</span> encode[A](value: A)(<span class="kw">implicit</span> c: Codec[A]): String =
  c.<span class="fu">encode</span>(value)

<span class="kw">def</span> decode[A](value: String)(<span class="kw">implicit</span> c: Codec[A]): A =
  c.<span class="fu">decode</span>(value)</code></pre></div>
<p>The type chart for <code>imap</code> is shown in Figure 6. If we have a <code>Codec[A]</code> and a pair of functions <code>A =&gt; B</code> and <code>B =&gt; A</code>, the <code>imap</code> method creates a <code>Codec[B]</code>:</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE3NjNweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE3NjMgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MC4zICgzMzgzOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+CiAgICA8dGl0bGU+Z2VuZXJpYy1pbWFwPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMSIgY3g9IjQzLjc5MjQ3MzEiIGN5PSI0NC40MTQ2MzQxIiByeD0iNDMuNzkyNDczMSIgcnk9IjQzLjQxNDYzNDEiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg3LjU4NDk0NjIiIGhlaWdodD0iODYuODI5MjY4MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0zIiBwb2ludHM9IjIxNS40NTYyNzggNzMuODA0ODc4IDE4Ni40OTgxMzcgODguODk3NzIwMyAxOTIuMDI4NjUgNTYuOTMwNTY3NSAxNjguNjAxMDIyIDM0LjI5MTMwNDEgMjAwLjk3NzIwNyAyOS42MjczNTk0IDIxNS40NTYyNzggMC41NDI2ODI5MjcgMjI5LjkzNTM0OSAyOS42MjczNTk0IDI2Mi4zMTE1MzUgMzQuMjkxMzA0MSAyMzguODgzOTA2IDU2LjkzMDU2NzUgMjQ0LjQxNDQxOSA4OC44OTc3MjAzIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI5My43MTA1MTMxIiBoZWlnaHQ9Ijg4LjM1NTAzNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNSIgcG9pbnRzPSIxMTAuNTc1OTk1IDMzLjU2MDk3NTYgMTMyLjQ3MjIzMSAzMy41NjA5NzU2IDEzMi40NzIyMzEgMjIuNzA3MzE3MSAxNTQuMzY4NDY4IDQ0LjE0MjA4MDkgMTMyLjQ3MjIzMSA2Ni4xMjE5NTEyIDEzMi40NzIyMzEgNTUuMjY4MjkyNyAxMTAuNTc1OTk1IDU1LjI2ODI5MjciPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay02IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjQzLjc5MjQ3MzEiIGhlaWdodD0iNDMuNDE0NjM0MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC03IiBjeD0iMjE0Ljc5MjQ3MyIgY3k9IjQ3LjQxNDYzNDEiIHJ4PSI0My43OTI0NzMxIiByeT0iNDMuNDE0NjM0MSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTgiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODcuNTg0OTQ2MiIgaGVpZ2h0PSI4Ni44MjkyNjgzIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTkiIHBvaW50cz0iNDcuMDg5MjA1OCA3My4yNjIxOTUxIDE4LjEzMTA2NDcgODguMzU1MDM3MyAyMy42NjE1Nzc2IDU2LjM4Nzg4NDUgMC4yMzM5NDkyODcgMzMuNzQ4NjIxMiAzMi42MTAxMzUzIDI5LjA4NDY3NjQgNDcuMDg5MjA1OCA2LjMyMzgzMDM1ZS0xNSA2MS41NjgyNzY0IDI5LjA4NDY3NjQgOTMuOTQ0NDYyNCAzMy43NDg2MjEyIDcwLjUxNjgzNDEgNTYuMzg3ODg0NSA3Ni4wNDczNDY5IDg4LjM1NTAzNzMiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI5My43MTA1MTMxIiBoZWlnaHQ9Ijg4LjM1NTAzNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMTEiIHBvaW50cz0iMTEwLjU3NTk5NSAzMi41NjA5NzU2IDEzMi40NzIyMzEgMzIuNTYwOTc1NiAxMzIuNDcyMjMxIDIxLjcwNzMxNzEgMTU0LjM2ODQ2OCA0My4xNDIwODA5IDEzMi40NzIyMzEgNjUuMTIxOTUxMiAxMzIuNDcyMjMxIDU0LjI2ODI5MjcgMTEwLjU3NTk5NSA1NC4yNjgyOTI3Ij48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTIiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNDMuNzkyNDczMSIgaGVpZ2h0PSI0My40MTQ2MzQxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0xMyIgcG9pbnRzPSI0NC41MDk0NDUgNzAuMiAxNy4wMDEwOTUyIDg0LjY2MTk5NTMgMjIuMjU0NzIyNSA1NC4wMzA5OTc3IC0xLjE1MDE5MTA1ZS0xMyAzMi4zMzgwMDQ3IDMwLjc1NTI3MDEgMjcuODY5MDAyMyA0NC41MDk0NDUgMCA1OC4yNjM2MTk5IDI3Ljg2OTAwMjMgODkuMDE4ODg5OSAzMi4zMzgwMDQ3IDY2Ljc2NDE2NzQgNTQuMDMwOTk3NyA3Mi4wMTc3OTQ4IDg0LjY2MTk5NTMiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4OS4wMTg4ODk5IiBoZWlnaHQ9Ijg0LjY2MTk5NTMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTE1IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTA0IiBoZWlnaHQ9IjEwNCIgcng9IjYuNCI+PC9yZWN0PgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE2IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwNCIgaGVpZ2h0PSIxMDQiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTE3IiBjeD0iNDEuNiIgY3k9IjQxLjYiIHJ4PSI0MS42IiByeT0iNDEuNiI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE4IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjgzLjIiIGhlaWdodD0iODMuMiIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTE3Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTkiIHg9IjAiIHk9IjAiIHdpZHRoPSIxMDQiIGhlaWdodD0iMTA0IiByeD0iNi40Ij48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMjAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTA0IiBoZWlnaHQ9IjEwNCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTE5Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZ2VuZXJpYy1pbWFwIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzYzIiBoZWlnaHQ9IjM2MCI+PC9yZWN0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNjA2LjAwMDAwMCwgOTIuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjYuNCI+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEiIG1hc2s9InVybCgjbWFzay0yKSIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEiIG1hc2s9InVybCgjbWFzay00KSIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJQYXRoLTEiIG1hc2s9InVybCgjbWFzay02KSIgZmlsbD0iIzAwMDAwMCIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTciIHRyYW5zZm9ybT0idHJhbnNsYXRlKDkzOC4wMDAwMDAsIDkzLjAwMDAwMCkiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI2LjQiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBtYXNrPSJ1cmwoI21hc2stOCkiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stMTApIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgbWFzaz0idXJsKCNtYXNrLTEyKSIgZmlsbD0iIzAwMDAwMCIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iMTI0MSAxMjEgMTI3MyAxMjEgMTI3MyAxMDUgMTMwNSAxMzYuNTk4MjE0IDEyNzMgMTY5IDEyNzMgMTUzIDEyNDEgMTUzIj48L3BvbHlnb24+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJGW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIzMTIuNiIgeT0iMzE0Ij5GW0FdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iRltCXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTM1Ni42IiB5PSIzMTQiPkZbQl08L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBLT0mZ3Q7LUIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjY4My40IiB5PSIzMTQiPkEgPSZndDsgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IiwiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijg4Ni40IiB5PSIxODUiPiw8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJCLT0mZ3Q7LUEiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijk4My40IiB5PSIzMTQiPkIgPSZndDsgQTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzNDcuMDAwMDAwLCA4NS4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNi40Ij4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNy4xNTAwMDAsIDkuNzUwMDAwKSIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stMTQpIiB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJSZWN0YW5nbGUtMSIgbWFzaz0idXJsKCNtYXNrLTE2KSIgeGxpbms6aHJlZj0iI3BhdGgtMTUiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC04IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMDcuMDAwMDAwLCA4NS4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNi40Ij4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMC40MDAwMDAsIDEyLjQ4MDAwMCkiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTE4KSIgeGxpbms6aHJlZj0iI3BhdGgtMTciPjwvdXNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUmVjdGFuZ2xlLTEiIG1hc2s9InVybCgjbWFzay0yMCkiIHhsaW5rOmhyZWY9IiNwYXRoLTE5Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iaW1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI1MS4yIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI0Y2QTYyMyI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNDQ3LjA2IiB5PSIxNDgiPmltYXA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 6: Type chart: the imap method" id="fig:functors:imap-type-chart" />
<p class="caption">Figure 6: Type chart: the imap method</p>
</div>
<p>As an example use case, imagine we have a basic <code>Codec[String]</code>, whose <code>encode</code> and <code>decode</code> methods are both a no-op:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> stringCodec: Codec[String] =
  <span class="kw">new</span> Codec[String] {
    <span class="kw">def</span> <span class="fu">encode</span>(value: String): String = value
    <span class="kw">def</span> <span class="fu">decode</span>(value: String): String = value
  }</code></pre></div>
<p>We can construct many useful <code>Codecs</code> for other types by building off of <code>stringCodec</code> using <code>imap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> intCodec: Codec[Int] =
  stringCodec.<span class="fu">imap</span>(_.<span class="fu">toInt</span>, _.<span class="fu">toString</span>)

<span class="kw">implicit</span> <span class="kw">val</span> booleanCodec: Codec[Boolean] =
  stringCodec.<span class="fu">imap</span>(_.<span class="fu">toBoolean</span>, _.<span class="fu">toString</span>)</code></pre></div>
<div class="callout callout-info">
<p><em>Coping with Failure</em></p>
<p>Note that the <code>decode</code> method of our <code>Codec</code> type class doesn’t account for failures. If we want to model more sophisticated relationships we can move beyond functors to look at <em>lenses</em> and <em>optics</em>.</p>
<p>Optics are beyond the scope of this book. However, Julien Truffaut’s library <a href="http://julien-truffaut.github.io/Monocle/">Monocle</a> provides a great starting point for further investigation.</p>
</div>
<h4 id="transformative-thinking-with-imap"><span class="header-section-number">3.6.2.1</span> Transformative Thinking with <em>imap</em></h4>
<p>Implement the <code>imap</code> method for <code>Codec</code> above.</p>
<div class="solution">
<p>Here’s a working implementation:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Codec[A] {
  <span class="kw">def</span> <span class="fu">encode</span>(value: A): String
  <span class="kw">def</span> <span class="fu">decode</span>(value: String): A

  <span class="kw">def</span> imap[B](dec: A =&gt; B, enc: B =&gt; A): Codec[B] = {
    <span class="kw">val</span> self = <span class="kw">this</span>
    <span class="kw">new</span> Codec[B] {
      <span class="kw">def</span> <span class="fu">encode</span>(value: B): String =
        self.<span class="fu">encode</span>(<span class="fu">enc</span>(value))

      <span class="kw">def</span> <span class="fu">decode</span>(value: String): B =
        <span class="fu">dec</span>(self.<span class="fu">decode</span>(value))
    }
  }
}</code></pre></div>
</div>
<p>Demonstrate your <code>imap</code> method works by creating a <code>Codec</code> for <code>Double</code>.</p>
<div class="solution">
<p>We can implement this using the <code>imap</code> method of <code>stringCodec</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> doubleCodec: Codec[Double] =
  stringCodec.<span class="fu">imap</span>[Double](_.<span class="fu">toDouble</span>, _.<span class="fu">toString</span>)</code></pre></div>
</div>
<p>Finally, implement a <code>Codec</code> for the following <code>Box</code> type:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">case</span> <span class="kw">class</span> Box[A](value: A)</code></pre></div>
<div class="solution">
<p>We need a generic <code>Codec</code> for <code>Box[A]</code> for any given <code>A</code>. We create this by calling <code>imap</code> on a <code>Codec[A]</code>, which we bring into scope using an implicit parameter:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> boxCodec[A](<span class="kw">implicit</span> c: Codec[A]): Codec[Box[A]] =
  c.<span class="fu">imap</span>[Box[A]](Box(_), _.<span class="fu">value</span>)</code></pre></div>
</div>
<p>Your instances should work as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">encode</span>(<span class="fl">123.4</span>)
<span class="co">// res0: String = 123.4</span>

decode[Double](<span class="st">&quot;123.4&quot;</span>)
<span class="co">// res1: Double = 123.4</span>

<span class="fu">encode</span>(Box(<span class="fl">123.4</span>))
<span class="co">// res2: String = 123.4</span>

decode[Box[Double]](<span class="st">&quot;123.4&quot;</span>)
<span class="co">// res3: Box[Double] = Box(123.4)</span></code></pre></div>
<div class="callout callout-warning">
<p><em>What’s With the Names?</em></p>
<p>What’s the relationship between the terms “contravariance”, “invariance”, and “covariance” and these different kinds of functor?</p>
<p>If you recall from Section 1.6.1, variance affects subtyping, which is essentially our ability to use a value of one type in place of a value of another type without breaking the code.</p>
<p>Subtyping can be viewed as a conversion. If <code>B</code> is a subtype of <code>A</code>, we can always convert a <code>B</code> to an <code>A</code>.</p>
<p>Equivalently we could say that <code>B</code> is a subtype of <code>A</code> if there exists a function <code>A =&gt; B</code>. A standard covariant functor captures exactly this. If <code>F</code> is a covariant functor, wherever we have an <code>F[A]</code> and a conversion <code>A =&gt; B</code> we can always convert to an <code>F[B]</code>.</p>
<p>A contravariant functor captures the opposite case. If <code>F</code> is a contravariant functor, whenever we have a <code>F[A]</code> and a conversion <code>B =&gt; A</code> we can convert to an <code>F[B]</code>.</p>
<p>Finally, invariant functors capture the case where we can convert from <code>F[A]</code> to <code>F[B]</code> via a function <code>A =&gt; B</code> and vice versa via a function <code>B =&gt; A</code>.</p>
</div>
<h2 id="contravariant-and-invariant-in-cats"><span class="header-section-number">3.7</span> <em>Contravariant</em> and Invariant in Cats</h2>
<p>Let’s look at the implementation of contravariant and invariant functors in Cats, provided by the <a href="http://typelevel.org/cats/api/cats/Contravariant.html"><code>cats.Contravariant</code></a> and <a href="http://typelevel.org/cats/api/cats/Invariant.html"><code>cats.Invariant</code></a> type classes. Here’s a simplified version of the code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Contravariant[F[_]] {
  <span class="kw">def</span> contramap[A, B](fa: F[A])(f: B =&gt; A): F[B]
}

<span class="kw">trait</span> Invariant[F[_]] {
  <span class="kw">def</span> imap[A, B](fa: F[A])(f: A =&gt; B)(g: B =&gt; A): F[B]
}</code></pre></div>
<h3 id="contravariant-in-cats"><span class="header-section-number">3.7.1</span> Contravariant in Cats</h3>
<p>We can summon instances of <code>Contravariant</code> using the <code>Contravariant.apply</code> method. Cats provides instances for data types that consume parameters, including <code>Eq</code>, <code>Show</code>, and <code>Function1</code>. Here’s an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Contravariant</span>
<span class="kw">import</span> cats.<span class="fu">Show</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._

<span class="kw">val</span> showString = Show[String]

<span class="kw">val</span> showSymbol = Contravariant[Show].
  <span class="fu">contramap</span>(showString)((sym: Symbol) =&gt; s<span class="st">&quot;'${sym.name}&quot;</span>)

showSymbol.<span class="fu">show</span>('dave)
<span class="co">// res2: String = 'dave</span></code></pre></div>
<p>More conveniently, we can use <a href="http://typelevel.org/cats/api/cats/syntax/package$$contravariant$"><code>cats.syntax.contravariant</code></a>, which provides a <code>contramap</code> extension method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">contravariant</span>._ <span class="co">// for contramap</span>

showString.<span class="fu">contramap</span>[Symbol](_.<span class="fu">name</span>).<span class="fu">show</span>('dave)
<span class="co">// res3: String = dave</span></code></pre></div>
<h3 id="invariant-in-cats"><span class="header-section-number">3.7.2</span> Invariant in Cats</h3>
<p>Among other types, Cats provides an instance of <code>Invariant</code> for <code>Monoid</code>. This is a little different from the <code>Codec</code> example we introduced in Section 3.6.2. If you recall, this is what <code>Monoid</code> looks like:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">trait</span> Monoid[A] {
  <span class="kw">def</span> empty: A
  <span class="kw">def</span> <span class="fu">combine</span>(x: A, y: A): A
}</code></pre></div>
<p>Imagine we want to produce a <code>Monoid</code> for Scala’s <a href="http://www.scala-lang.org/api/2.12.1/scala/Symbol.html"><code>Symbol</code></a> type. Cats doesn’t provide a <code>Monoid</code> for <code>Symbol</code> but it does provide a <code>Monoid</code> for a similar type: <code>String</code>. We can write our new semigroup with an <code>empty</code> method that relies on the empty <code>String</code>, and a <code>combine</code> method that works as follows:</p>
<ol style="list-style-type: decimal">
<li>accept two <code>Symbols</code> as parameters;</li>
<li>convert the <code>Symbols</code> to <code>Strings</code>;</li>
<li>combine the <code>Strings</code> using <code>Monoid[String]</code>;</li>
<li>convert the result back to a <code>Symbol</code>.</li>
</ol>
<p>We can implement <code>combine</code> using <code>imap</code>, passing functions of type <code>String =&gt; Symbol</code> and <code>Symbol =&gt; String</code> as parameters. Here’ the code, written out using the <code>imap</code> extension method provided by <code>cats.syntax.invariant</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">invariant</span>._ <span class="co">// for imap</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">implicit</span> <span class="kw">val</span> symbolMonoid: Monoid[Symbol] =
  Monoid[String].<span class="fu">imap</span>(Symbol.<span class="fu">apply</span>)(_.<span class="fu">name</span>)

Monoid[Symbol].<span class="fu">empty</span>
<span class="co">// res5: Symbol = '</span>

'a |+| 'few |+| 'words
<span class="co">// res6: Symbol = 'afewwords</span></code></pre></div>
<h2 id="sec:functors:partial-unification"><span class="header-section-number">3.8</span> Aside: Partial Unification</h2>
<p>In Section 3.2 we saw a curious compiler error. The following code compiled perfectly if we had the <code>-Ypartial-unification</code> compiler flag enabled:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Functor</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">function</span>._ <span class="co">// for Functor</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._     <span class="co">// for map</span>

<span class="kw">val</span> func1 = (x: Int)    =&gt; x.<span class="fu">toDouble</span>
<span class="kw">val</span> func2 = (y: Double) =&gt; y * <span class="dv">2</span>

<span class="kw">val</span> func3 = func1.<span class="fu">map</span>(func2)
<span class="co">// func3: Int =&gt; Double = scala.runtime.AbstractFunction1$$Lambda$7404/676389686@12d3ba5a</span></code></pre></div>
<p>but failed if the flag was missing:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> func3 = func1.<span class="fu">map</span>(func2)
<span class="co">// &lt;console&gt;: error: value map is not a member of Int =&gt; Double</span>
<span class="co">//        val func3 = func1.map(func2)</span>
                            ^</code></pre></div>
<p>Obviously “partial unification” is some kind of optional compiler behaviour, without which our code will not compile. We should take a moment to describe this behaviour and discuss some gotchas and workarounds.</p>
<h3 id="unifying-type-constructors"><span class="header-section-number">3.8.1</span> Unifying Type Constructors</h3>
<p>In order to compile an expression like <code>func1.map(func2)</code> above, the compiler has to search for a <code>Functor</code> for <code>Function1</code>. However, <code>Functor</code> accepts a type constructor with one parameter:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Functor[F[_]] {
  <span class="kw">def</span> map[A, B](fa: F[A])(func: A =&gt; B): F[B]
}</code></pre></div>
<p>and <code>Function1</code> has two type parameters (the function argument and the result type):</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Function1[-A, +B] {
  <span class="kw">def</span> <span class="fu">apply</span>(arg: A): B
}</code></pre></div>
<p>The compiler has to fix one of the two parameters of <code>Function1</code> to create a type constructor of the correct kind to pass to <code>Functor</code>. It has two options to choose from:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> F[A] = Int =&gt; A
<span class="kw">type</span> F[A] = A =&gt; Double</code></pre></div>
<p><em>We</em> know that the former of these is the correct choice. However, earlier versions of the Scala compiler were not able to make this inference. This infamous limitation, known as <a href="https://issues.scala-lang.org/browse/SI-2712">SI-2712</a>, prevented the compiler from “unifying” type constructors of different arities. This compiler limitation is now fixed, although we have to enable the fix via a compiler flag in <code>build.sbt</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scalacOptions += <span class="st">&quot;-Ypartial-unification&quot;</span></code></pre></div>
<h3 id="left-to-right-elimination"><span class="header-section-number">3.8.2</span> Left-to-Right Elimination</h3>
<p>The partial unification in the Scala compiler works by fixing type parameters from left to right. In the above example, the compiler fixes the <code>Int</code> in <code>Int =&gt; Double</code> and looks for a <code>Functor</code> for functions of type <code>Int =&gt; ?</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> F[A] = Int =&gt; A

<span class="kw">val</span> functor = Functor[F]</code></pre></div>
<p>This left-to-right elimination works for a wide variety of common scenarios, including <code>Functors</code> for types such as <code>Function1</code> and <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">either</span>._ <span class="co">// for Functor</span>

<span class="kw">val</span> either: Either[String, Int] = <span class="fu">Right</span>(<span class="dv">123</span>)
<span class="co">// either: Either[String,Int] = Right(123)</span>

either.<span class="fu">map</span>(_ + <span class="dv">1</span>)
<span class="co">// res2: scala.util.Either[String,Int] = Right(124)</span></code></pre></div>
<p>However, there are situations where left-to-right elimination is not the correct choice. One example is the <code>Or</code> type in <a href="http://scalactic.org">Scalactic</a>, which is a conventionally left-biased equivalent of <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> PossibleResult = ActualResult Or Error</code></pre></div>
<p>Another example is the <code>Contravariant</code> functor for <code>Function1</code>.</p>
<p>While the covariant <code>Functor</code> for <code>Function1</code> implements <code>andThen</code>-style left-to-right function composition, the <code>Contravariant</code> functor implements <code>compose</code>-style right-to-left composition. In other words, the following expressions are all equivalent:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> func3a: Int =&gt; Double =
  a =&gt; <span class="fu">func2</span>(<span class="fu">func1</span>(a))

<span class="kw">val</span> func3b: Int =&gt; Double =
  func2.<span class="fu">compose</span>(func1)

<span class="co">// Hypothetical example. This won't actually compile:</span>
<span class="kw">val</span> func3c: Int =&gt; Double =
  func2.<span class="fu">contramap</span>(func1)</code></pre></div>
<p>If we try this for real, however, our code won’t compile:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">contravariant</span>._ <span class="co">// for contramap</span>

<span class="kw">val</span> func3c = func2.<span class="fu">contramap</span>(func1)
<span class="co">// &lt;console&gt;:27: error: value contramap is not a member of Double =&gt; Double</span>
<span class="co">//        val func3c = func2.contramap(func1)</span>
<span class="co">//                           ^</span></code></pre></div>
<p>The problem here is that the <code>Contravariant</code> for <code>Function1</code> fixes the return type and leaves the parameter type varying, requiring the compiler to eliminate type parameters from right to left, as shown below and in Figure 7:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> F[A] = A =&gt; Double</code></pre></div>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjMyNXB4IiB2aWV3Qm94PSIwIDAgMTc2MSAzMjUiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5mdW5jdGlvbi1jb250cmFtYXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xIiBjeD0iMjQ4LjQwMzY1MyIgY3k9IjU2LjUzMzc0MjMiIHJ4PSI1MS40MDM2NTMiIHJ5PSI1MS41MzM3NDIzIj48L2VsbGlwc2U+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMiIgcG9pbnRzPSIxMjQuMzcyMzA2IDQxLjI5NDQ3ODUgMTUwLjA3NDEzMiA0MS4yOTQ0Nzg1IDE1MC4wNzQxMzIgMjguNDExMDQyOSAxNzUuNzc1OTU5IDUzLjg1NDM4OTkgMTUwLjA3NDEzMiA3OS45NDQ3ODUzIDE1MC4wNzQxMzIgNjcuMDYxMzQ5NyAxMjQuMzcyMzA2IDY3LjA2MTM0OTciPjwvcG9seWdvbj4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0zIiBjeD0iNTEuNDAzNjUzIiBjeT0iNTIuMTc3OTE0MSIgcng9IjUxLjQwMzY1MyIgcnk9IjUxLjUzMzc0MjMiPjwvZWxsaXBzZT4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC00IiBwb2ludHM9IjI0NS40ODA4OTggODYuOTYzMTkwMiAyMTEuNDg5OCAxMDQuODc4NTkzIDIxNy45ODE1MjIgNjYuOTMzMTYxMyAxOTAuNDgyMTQ2IDQwLjA2MDA1NzcgMjI4LjQ4NTM0OSAzNC41MjM4OTM5IDI0NS40ODA4OTggMCAyNjIuNDc2NDQ3IDM0LjUyMzg5MzkgMzAwLjQ3OTY0OSA0MC4wNjAwNTc3IDI3Mi45ODAyNzMgNjYuOTMzMTYxMyAyNzkuNDcxOTk1IDEwNC44Nzg1OTMiPjwvcG9seWdvbj4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC01IiBwb2ludHM9IjEyMi4zNzIzMDYgMzkuMjk0NDc4NSAxNDguMDc0MTMyIDM5LjI5NDQ3ODUgMTQ4LjA3NDEzMiAyNi40MTEwNDI5IDE3My43NzU5NTkgNTEuODU0Mzg5OSAxNDguMDc0MTMyIDc3Ljk0NDc4NTMgMTQ4LjA3NDEzMiA2NS4wNjEzNDk3IDEyMi4zNzIzMDYgNjUuMDYxMzQ5NyI+PC9wb2x5Z29uPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTYiIHBvaW50cz0iMjU0LjQ4MDg5OCA4Ny45NjMxOTAyIDIyMC40ODk4IDEwNS44Nzg1OTMgMjI2Ljk4MTUyMiA2Ny45MzMxNjEzIDE5OS40ODIxNDYgNDEuMDYwMDU3NyAyMzcuNDg1MzQ5IDM1LjUyMzg5MzkgMjU0LjQ4MDg5OCAxIDI3MS40NzY0NDcgMzUuNTIzODkzOSAzMDkuNDc5NjQ5IDQxLjA2MDA1NzcgMjgxLjk4MDI3MyA2Ny45MzMxNjEzIDI4OC40NzE5OTUgMTA1Ljg3ODU5MyI+PC9wb2x5Z29uPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTciIHBvaW50cz0iMTMxLjM3MjMwNiA0MC4yOTQ0Nzg1IDE1Ny4wNzQxMzIgNDAuMjk0NDc4NSAxNTcuMDc0MTMyIDI3LjQxMTA0MjkgMTgyLjc3NTk1OSA1Mi44NTQzODk5IDE1Ny4wNzQxMzIgNzguOTQ0Nzg1MyAxNTcuMDc0MTMyIDY2LjA2MTM0OTcgMTMxLjM3MjMwNiA2Ni4wNjEzNDk3Ij48L3BvbHlnb24+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZnVuY3Rpb24tY29udHJhbWFwIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzYxIiBoZWlnaHQ9IjMyNSI+PC9yZWN0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAzLjAwMDAwMCwgNTEuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSIyNDguNDAzNjUzIiBjeT0iNTYuNTMzNzQyMyIgcng9IjQ5LjQwMzY1MyIgcnk9IjQ5LjUzMzc0MjMiPjwvZWxsaXBzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJQYXRoLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0yIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTEyNi4zNzIzMDYsNDMuMjk0NDc4NSBMMTUwLjA3NDEzMiw0My4yOTQ0Nzg1IEwxNTIuMDc0MTMyLDQzLjI5NDQ3ODUgTDE1Mi4wNzQxMzIsNDEuMjk0NDc4NSBMMTUyLjA3NDEzMiwzMy4yMDUxNjk4IEwxNzIuOTUxMDQ0LDUzLjg3MjEyNTEgTDE1Mi4wNzQxMzIsNzUuMDY0NjYwNyBMMTUyLjA3NDEzMiw2Ny4wNjEzNDk3IEwxNTIuMDc0MTMyLDY1LjA2MTM0OTcgTDE1MC4wNzQxMzIsNjUuMDYxMzQ5NyBMMTI2LjM3MjMwNiw2NS4wNjEzNDk3IEwxMjYuMzcyMzA2LDQzLjI5NDQ3ODUgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24iIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBwb2ludHM9IjUzIDAuMDY1ODYxNzQyNCAxMDUuMzM5MjYzIDM4LjA5MjU2MjIgODUuMzQ3NDQzNSA5OS42MjEwNTYgMjAuNjUyNTU2NSA5OS42MjEwNTYgMC42NjA3MzcwMyAzOC4wOTI1NjIyIj48L3BvbHlnb24+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgxNy4wMDAwMDAsIDUzLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNTEuNDAzNjUzIiBjeT0iNTIuMTc3OTE0MSIgcng9IjQ5LjQwMzY1MyIgcnk9IjQ5LjUzMzc0MjMiPjwvZWxsaXBzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC00Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTIxNC4xNDUwNTksMTAxLjIxODMxNyBMMjE5Ljk1Mjg4MSw2Ny4yNzA0MjIzIEwyMjAuMTI5ODI3LDY2LjIzNjEzNTUgTDIxOS4zNzkzNTQsNjUuNTAyNzUzNSBMMTk0Ljc3MjM4Miw0MS40NTYxODI0IEwyMjguNzczNjU4LDM2LjUwMzAwNDIgTDIyOS44MTQ5NDksMzYuMzUxMzEyOCBMMjMwLjI3OTcwNywzNS40MDcyMjcyIEwyNDUuNDgwODk4LDQuNTI4MzAxODQgTDI2MC42ODIwODgsMzUuNDA3MjI3MiBMMjYxLjE0Njg0NiwzNi4zNTEzMTI4IEwyNjIuMTg4MTM3LDM2LjUwMzAwNDIgTDI5Ni4xODk0MTMsNDEuNDU2MTgyNCBMMjcxLjU4MjQ0Miw2NS41MDI3NTM1IEwyNzAuODMxOTY4LDY2LjIzNjEzNTUgTDI3MS4wMDg5MTUsNjcuMjcwNDIyMyBMMjc2LjgxNjczNiwxMDEuMjE4MzE3IEwyNDYuNDEzNDI0LDg1LjE5Mzg5NzkgTDI0NS40ODA4OTgsODQuNzAyMzk5MiBMMjQ0LjU0ODM3Miw4NS4xOTM4OTc5IEwyMTQuMTQ1MDU5LDEwMS4yMTgzMTcgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9IlBhdGgtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNMTI0LjM3MjMwNiw0MS4yOTQ0Nzg1IEwxNDguMDc0MTMyLDQxLjI5NDQ3ODUgTDE1MC4wNzQxMzIsNDEuMjk0NDc4NSBMMTUwLjA3NDEzMiwzOS4yOTQ0Nzg1IEwxNTAuMDc0MTMyLDMxLjIwNTE2OTggTDE3MC45NTEwNDQsNTEuODcyMTI1MSBMMTUwLjA3NDEzMiw3My4wNjQ2NjA3IEwxNTAuMDc0MTMyLDY1LjA2MTM0OTcgTDE1MC4wNzQxMzIsNjMuMDYxMzQ5NyBMMTQ4LjA3NDEzMiw2My4wNjEzNDk3IEwxMjQuMzcyMzA2LDYzLjA2MTM0OTcgTDEyNC4zNzIzMDYsNDEuMjk0NDc4NSBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEyNTguMDAwMDAwLCA1Mi4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC02Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTIyMy4xNDUwNTksMTAyLjIxODMxNyBMMjI4Ljk1Mjg4MSw2OC4yNzA0MjIzIEwyMjkuMTI5ODI3LDY3LjIzNjEzNTUgTDIyOC4zNzkzNTQsNjYuNTAyNzUzNSBMMjAzLjc3MjM4Miw0Mi40NTYxODI0IEwyMzcuNzczNjU4LDM3LjUwMzAwNDIgTDIzOC44MTQ5NDksMzcuMzUxMzEyOCBMMjM5LjI3OTcwNywzNi40MDcyMjcyIEwyNTQuNDgwODk4LDUuNTI4MzAxODQgTDI2OS42ODIwODgsMzYuNDA3MjI3MiBMMjcwLjE0Njg0NiwzNy4zNTEzMTI4IEwyNzEuMTg4MTM3LDM3LjUwMzAwNDIgTDMwNS4xODk0MTMsNDIuNDU2MTgyNCBMMjgwLjU4MjQ0Miw2Ni41MDI3NTM1IEwyNzkuODMxOTY4LDY3LjIzNjEzNTUgTDI4MC4wMDg5MTUsNjguMjcwNDIyMyBMMjg1LjgxNjczNiwxMDIuMjE4MzE3IEwyNTUuNDEzNDI0LDg2LjE5Mzg5NzkgTDI1NC40ODA4OTgsODUuNzAyMzk5MiBMMjUzLjU0ODM3Miw4Ni4xOTM4OTc5IEwyMjMuMTQ1MDU5LDEwMi4yMTgzMTcgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9IlBhdGgtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNMTMzLjM3MjMwNiw0Mi4yOTQ0Nzg1IEwxNTcuMDc0MTMyLDQyLjI5NDQ3ODUgTDE1OS4wNzQxMzIsNDIuMjk0NDc4NSBMMTU5LjA3NDEzMiw0MC4yOTQ0Nzg1IEwxNTkuMDc0MTMyLDMyLjIwNTE2OTggTDE3OS45NTEwNDQsNTIuODcyMTI1MSBMMTU5LjA3NDEzMiw3NC4wNjQ2NjA3IEwxNTkuMDc0MTMyLDY2LjA2MTM0OTcgTDE1OS4wNzQxMzIsNjQuMDYxMzQ5NyBMMTU3LjA3NDEzMiw2NC4wNjEzNDk3IEwxMzMuMzcyMzA2LDY0LjA2MTM0OTcgTDEzMy4zNzIzMDYsNDIuMjk0NDc4NSBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHBvaW50cz0iNTIuNjc4NTI1OSAwLjg1MzE2OTU0OSAxMDUuMzU3MDUyIDM5LjEyNjM1OSA4NS4yMzU2NDU0IDEwMS4wNTM2OCAyMC4xMjE0MDY0IDEwMS4wNTM2OCAtNi4zOTQ4ODQ2MmUtMTQgMzkuMTI2MzU5Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIxMTU0IDg1IDExOTQgODUgMTE5NCA2NSAxMjM0IDEwNC40OTc3NjcgMTE5NCAxNDUgMTE5NCAxMjUgMTE1NCAxMjUiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstWCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjcyLjQiIHk9IjI4MiI+QSA9Jmd0OyBYPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQi09Jmd0Oy1YIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMzQzLjQiIHk9IjI4MiI+QiA9Jmd0OyBYPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQi09Jmd0Oy1BIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI4OTAuNCIgeT0iMjgyIj5CID0mZ3Q7IEE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJjb250cmFtYXAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1Cb2xkLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTEuMjAwMDAwOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjUxNy43NTk5OTgiIHk9IjEyMyI+Y29udHJhbWFwPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 7: Type chart: contramapping over a Function1" id="fig:functors:function-contramap-type-chart" />
<p class="caption">Figure 7: Type chart: contramapping over a Function1</p>
</div>
<p>The compiler fails simply because of its left-to-right bias. We can prove this by creating a type alias that flips the parameters on Function1:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> &lt;=[B, A] = A =&gt; B

<span class="kw">type</span> F[A] = Double &lt;= A</code></pre></div>
<p>If we re-type <code>func2</code> as an instance of <code>&lt;=</code>, we reset the required order of elimination and we can call <code>contramap</code> as desired:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> func2b: Double &lt;= Double = func2

<span class="kw">val</span> func3c = func2b.<span class="fu">contramap</span>(func1)
<span class="co">// func3c: Double &lt;= Int = scala.runtime.AbstractFunction1$$Lambda$7404/676389686@79516fbd</span></code></pre></div>
<p>The difference between <code>func2</code> and <code>func2b</code> is purely syntactic—both refer to the same value and the type aliases are otherwise completely compatible. Incredibly, however, this simple rephrasing is enough to give the compiler the hint it needs to solve the problem.</p>
<p>It is rare that we have to do this kind of right-to-left elimination. Most multi-parameter type constructors are designed to be right-biased, requiring the left-to-right elimination that is supported by the compiler out of the box. However, it is useful to know about <code>-Ypartial-unification</code> and this quirk of elimination order in case you ever come across an odd scenario like the one above.</p>
<h2 id="summary-2"><span class="header-section-number">3.9</span> Summary</h2>
<p>Functors represent sequencing behaviours. We covered three types of functor in this chapter:</p>
<ul>
<li><p>Regular covariant <code>Functors</code>, with their <code>map</code> method, represent the ability to apply functions to a value in some context. Successive calls to <code>map</code> apply these functions in <em>sequence</em>, each accepting the result of its predecessor as a parameter.</p></li>
<li><p><code>Contravariant</code> functors, with their <code>contramap</code> method, represent the ability to “prepend” functions to a function-like context. Successive calls to <code>contramap</code> sequence these functions in the opposite order to <code>map</code>.</p></li>
<li><p><code>Invariant</code> functors, with their <code>imap</code> method, represent bidirectional transformations.</p></li>
</ul>
<p>Regular <code>Functors</code> are by far the most common of these type classes, but even then it is rare to use them on their own. Functors form a foundational building block of several more interesting abstractions that we use all the time. In the following chapters we will look at two of these abstractions: <em>monads</em> and <em>applicative functors</em>.</p>
<p>Functors for collections are extremely important, as they transform each element independently of the rest. This allows us to parallelise or distribute transformations on large collections, a technique leveraged heavily in “map-reduce” frameworks like <a href="http://hadoop.apache.org">Hadoop</a>. We will investigate this approach in more detail in the <a href="#map-reduce">Map-reduce</a> case study later in the book.</p>
<p>The <code>Contravariant</code> and <code>Invariant</code> type classes are less widely applicable but are still useful for building data types that represent transformations. We will revisit them to discuss the <a href="#semigroupal"><code>Semigroupal</code></a> type class later in Chapter 6.</p>
<h1 id="sec:monads"><span class="header-section-number">4</span> Monads</h1>
<p><em>Monads</em> are one of the most common abstractions in Scala. Many Scala programmers quickly become intuitively familiar with monads, even if we don’t know them by name.</p>
<p>Informally, a monad is anything with a constructor and a <code>flatMap</code> method. All of the functors we saw in the last chapter are also monads, including <code>Option</code>, <code>List</code>, and <code>Future</code>. We even have special syntax to support monads: for comprehensions. However, despite the ubiquity of the concept, the Scala standard library lacks a concrete type to encompass “things that can be <code>flatMapped</code>”. This type class is one of the benefits brought to us by Cats.</p>
<p>In this chapter we will take a deep dive into monads. We will start by motivating them with a few examples. We’ll proceed to their formal definition and their implementation in Cats. Finally, we’ll tour some interesting monads that you may not have seen, providing introductions and examples of their use.</p>
<h2 id="what-is-a-monad"><span class="header-section-number">4.1</span> What is a Monad?</h2>
<p>This is the question that has been posed in a thousand blog posts, with explanations and analogies involving concepts as diverse as cats, Mexican food, space suits full of toxic waste, and monoids in the category of endofunctors (whatever that means). We’re going to solve the problem of explaining monads once and for all by stating very simply:</p>
<blockquote>
<p>A monad is a mechanism for <em>sequencing computations</em>.</p>
</blockquote>
<p>That was easy! Problem solved, right? But then again, last chapter we said functors were a control mechanism for exactly the same thing. Ok, maybe we need some more discussion…</p>
<p>In Section 3.1 we said that functors allow us to sequence computations ignoring some complication. However, functors are limited in that they only allow this complication to occur once at the beginning of the sequence. They don’t account further complications at each step in the sequence.</p>
<p>This is where monads come in. A monad’s <code>flatMap</code> method allows us to specify what happens next, taking into account an intermediate complication. The <code>flatMap</code> method of <code>Option</code> takes intermediate <code>Options</code> into account. The <code>flatMap</code> method of <code>List</code> handles intermediate <code>Lists</code>. And so on. In each case, the function passed to <code>flatMap</code> specifies the application-specific part of the computation, and <code>flatMap</code> itself takes care of the complication allowing us to <code>flatMap</code> again. Let’s ground things by looking at some examples.</p>
<p><strong>Options</strong></p>
<p><code>Option</code> allows us to sequence computations that may or may not return values. Here are some examples:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">parseInt</span>(str: String): Option[Int] =
  scala.<span class="fu">util</span>.<span class="fu">Try</span>(str.<span class="fu">toInt</span>).<span class="fu">toOption</span>

<span class="kw">def</span> <span class="fu">divide</span>(a: Int, b: Int): Option[Int] =
  <span class="kw">if</span>(b == <span class="dv">0</span>) None <span class="kw">else</span> Some(a / b)</code></pre></div>
<p>Each of these methods may “fail” by returning <code>None</code>. The <code>flatMap</code> method allows us to ignore this when we sequence operations:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">stringDivideBy</span>(aStr: String, bStr: String): Option[Int] =
  <span class="fu">parseInt</span>(aStr).<span class="fu">flatMap</span> { aNum =&gt;
    <span class="fu">parseInt</span>(bStr).<span class="fu">flatMap</span> { bNum =&gt;
      <span class="fu">divide</span>(aNum, bNum)
    }
  }</code></pre></div>
<p>We know the semantics well:</p>
<ul>
<li>the first call to <code>parseInt</code> returns a <code>None</code> or a <code>Some</code>;</li>
<li>if it returns a <code>Some</code>, the <code>flatMap</code> method calls our function and passes us the integer <code>aNum</code>;</li>
<li>the second call to <code>parseInt</code> returns a <code>None</code> or a <code>Some</code>;</li>
<li>if it returns a <code>Some</code>, the <code>flatMap</code> method calls our function and passes us <code>bNum</code>;</li>
<li>the call to <code>divide</code> returns a <code>None</code> or a <code>Some</code>, which is our result.</li>
</ul>
<p>At each step, <code>flatMap</code> chooses whether to call our function, and our function generates the next computation in the sequence. This is shown in Figure 8.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE5MTlweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE5MTkgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MC4zICgzMzgzOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+CiAgICA8dGl0bGU+b3B0aW9uLWZsYXRtYXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xIiB4PSIwIiB5PSIwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgcng9IjgiPjwvcmVjdD4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBhdGggZD0iTTUzLjU1ODA2MzksMTQzLjE5NDE0NiBMNDcsMTgxLjQzMDU5MyBMOTkuOTAwNjcyNywxNTMuNjE5MDY0IEwxNTIuODAxMzQ1LDE4MS40MzA1OTMgTDE0Mi42OTgyMTYsMTIyLjUyNDgyOCBMMTg1LjQ5NTc1OSw4MC44MDc1MzQgTDEyNi4zNTEwMDksNzIuMjEzMjk4OCBMMTI1Ljc1MjIxLDcxIEw1My41NTgwNjM5LDE0My4xOTQxNDYgWiIgaWQ9InBhdGgtMyI+PC9wYXRoPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTM4LjQ5NTc1OSIgaGVpZ2h0PSIxMTAuNDMwNTkzIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwYXRoIGQ9Ik01MS45Nzc3OTUsMTUxLjAwNzA1MyBMNTYuNzk3NTQzMiwxMjIuOTA1NzY1IEwxNCw4MS4xODg0NzA1IEw3My4xNDQ3NTAxLDcyLjU5NDIzNTMgTDk5LjU5NTA4NjUsMTkgTDEyNi4wNDU0MjMsNzIuNTk0MjM1MyBMMTI5LjgzOTMyNiw3My4xNDU1MjE3IEw1MS45Nzc3OTUsMTUxLjAwNzA1MyBaIiBpZD0icGF0aC01Ij48L3BhdGg+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxMTUuODM5MzI2IiBoZWlnaHQ9IjEzMi4wMDcwNTMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtNyIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stOCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwYXRoIGQ9Ik01My41NTgwNjM5LDE0My4xOTQxNDYgTDQ3LDE4MS40MzA1OTMgTDk5LjkwMDY3MjcsMTUzLjYxOTA2NCBMMTUyLjgwMTM0NSwxODEuNDMwNTkzIEwxNDIuNjk4MjE2LDEyMi41MjQ4MjggTDE4NS40OTU3NTksODAuODA3NTM0IEwxMjYuMzUxMDA5LDcyLjIxMzI5ODggTDEyNS43NTIyMSw3MSBMNTMuNTU4MDYzOSwxNDMuMTk0MTQ2IFoiIGlkPSJwYXRoLTkiPjwvcGF0aD4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxMzguNDk1NzU5IiBoZWlnaHQ9IjExMC40MzA1OTMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBhdGggZD0iTTUxLjk3Nzc5NSwxNTEuMDA3MDUzIEw1Ni43OTc1NDMyLDEyMi45MDU3NjUgTDE0LDgxLjE4ODQ3MDUgTDczLjE0NDc1MDEsNzIuNTk0MjM1MyBMOTkuNTk1MDg2NSwxOSBMMTI2LjA0NTQyMyw3Mi41OTQyMzUzIEwxMjkuODM5MzI2LDczLjE0NTUyMTcgTDUxLjk3Nzc5NSwxNTEuMDA3MDUzIFoiIGlkPSJwYXRoLTExIj48L3BhdGg+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTIiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTE1LjgzOTMyNiIgaGVpZ2h0PSIxMzIuMDA3MDUzIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cGF0aCBkPSJNMTUzLjgyMDQyMiw0Mi4wMDcxMzg5IEMxNjkuMzIxNDQ2LDU2Ljc3OTc2NDYgMTc5LDc3Ljc0NTQ4MDIgMTc5LDEwMSBDMTc5LDE0NS43MzUwNjUgMTQzLjE4Mjc4LDE4MiA5OSwxODIgQzc1LjY3NTE4OCwxODIgNTQuNjgxODIxNCwxNzEuODkzMTE5IDQwLjA1ODgwOCwxNTUuNzY4NzUzIEwxNTMuODIwNDIyLDQyLjAwNzEzODkgWiIgaWQ9InBhdGgtMTMiPjwvcGF0aD4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxMzguOTQxMTkyIiBoZWlnaHQ9IjEzOS45OTI4NjEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwYXRoIGQ9Ik0xNTcuMDU4ODM3LDQ0LjkyNjAxMTUgQzE0Mi41NDQ2NDQsMzAuMTU4NTA1MiAxMjIuMzQxODY0LDIxIDEwMCwyMSBDNTUuODE3MjIsMjEgMjAsNTYuODE3MjIgMjAsMTAxIEMyMCwxMjMuMzQxODY0IDI5LjE1ODUwNTIsMTQzLjU0NDY0NCA0My45MjYwMTE1LDE1OC4wNTg4MzcgTDE1Ny4wNTg4MzcsNDQuOTI2MDExNSBaIiBpZD0icGF0aC0xNSI+PC9wYXRoPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE2IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjEzNy4wNTg4MzciIGhlaWdodD0iMTM3LjA1ODgzNyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTE1Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTciIHg9IjAiIHk9IjAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiByeD0iOCI+PC9yZWN0PgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE4IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTE5IiBjeD0iODkwIiBjeT0iMTQwIiByeD0iODAiIHJ5PSI4MCI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTIwIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTIxIiBwb2ludHM9Ijk5NCAxMjAgMTAzNCAxMjAgMTAzNCAxMDAgMTA3NCAxMzkuNDk3NzY3IDEwMzQgMTgwIDEwMzQgMTYwIDk5NCAxNjAiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0yMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTIxIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0ib3B0aW9uLWZsYXRtYXAiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE5MTkiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0zIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNDYwLjAwMDAwMCwgMzguMDAwMDAwKSIgc3Ryb2tlLXdpZHRoPSI4Ij4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0yKSIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJDb21iaW5lZC1TaGFwZSIgc3Ryb2tlPSIjOUI5QjlCIiBtYXNrPSJ1cmwoI21hc2stNCkiIHN0cm9rZS1kYXNoYXJyYXk9IjEwLDUiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iQ29tYmluZWQtU2hhcGUiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTYpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwMC4wMDAwMDAsIDM5LjAwMDAwMCkiIHN0cm9rZS13aWR0aD0iOCI+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iQ29tYmluZWQtU2hhcGUiIHN0cm9rZT0iIzlCOUI5QiIgbWFzaz0idXJsKCNtYXNrLTEwKSIgc3Ryb2tlLWRhc2hhcnJheT0iMTAsNSIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJDb21iaW5lZC1TaGFwZSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTIpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xMSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1Ny4wMDAwMDAsIDM4LjAwMDAwMCkiIHN0cm9rZS13aWR0aD0iOCI+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJDb21iaW5lZC1TaGFwZSIgc3Ryb2tlPSIjOUI5QjlCIiBtYXNrPSJ1cmwoI21hc2stMTQpIiBzdHJva2UtZGFzaGFycmF5PSIxMCw1IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJDb21iaW5lZC1TaGFwZSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTYpIiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xNSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTgpIiB4bGluazpocmVmPSIjcGF0aC0xNyI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0yMCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTkiPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJQYXRoLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTIyKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjMDAwMDAwIiB4bGluazpocmVmPSIjcGF0aC0yMSI+PC91c2U+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iMTM0MiAxMjAgMTM4MiAxMjAgMTM4MiAxMDAgMTQyMiAxMzkuNDk3NzY3IDEzODIgMTgwIDEzODIgMTYwIDEzNDIgMTYwIj48L3BvbHlnb24+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJPcHRpb25bQV0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjI0Ny4xIiB5PSIzMTQiPk9wdGlvbltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9ImZsYXRNYXAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1Cb2xkLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRjZBNjIzIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI0OTQuMiIgeT0iMTU2Ij5mbGF0TWFwPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iT3B0aW9uW0JdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxNDQ4LjYiIHk9IjMxNCI+T3B0aW9uW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1PcHRpb25bQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijg4NS42IiB5PSIzMTQiPkEgPSZndDsgT3B0aW9uW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 8: Type chart: flatMap for Option" id="fig:monads:option-type-chart" />
<p class="caption">Figure 8: Type chart: flatMap for Option</p>
</div>
<p>The result of the computation is an <code>Option</code>, allowing us to call <code>flatMap</code> again and so the sequence continues. This results in the fail-fast error handling behaviour that we know and love, where a <code>None</code> at any step results in a <code>None</code> overall:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">stringDivideBy</span>(<span class="st">&quot;6&quot;</span>, <span class="st">&quot;2&quot;</span>)
<span class="co">// res1: Option[Int] = Some(3)</span>

<span class="fu">stringDivideBy</span>(<span class="st">&quot;6&quot;</span>, <span class="st">&quot;0&quot;</span>)
<span class="co">// res2: Option[Int] = None</span>

<span class="fu">stringDivideBy</span>(<span class="st">&quot;6&quot;</span>, <span class="st">&quot;foo&quot;</span>)
<span class="co">// res3: Option[Int] = None</span>

<span class="fu">stringDivideBy</span>(<span class="st">&quot;bar&quot;</span>, <span class="st">&quot;2&quot;</span>)
<span class="co">// res4: Option[Int] = None</span></code></pre></div>
<p>Every monad is also a functor (see below for proof), so we can rely on both <code>flatMap</code> and <code>map</code> to sequence computations that do and don’t introduce a new monad. Plus, if we have both <code>flatMap</code> and <code>map</code> we can use for comprehensions to clarify the sequencing behaviour:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">stringDivideBy</span>(aStr: String, bStr: String): Option[Int] =
  <span class="kw">for</span> {
    aNum &lt;- <span class="fu">parseInt</span>(aStr)
    bNum &lt;- <span class="fu">parseInt</span>(bStr)
    ans  &lt;- <span class="fu">divide</span>(aNum, bNum)
  } <span class="kw">yield</span> ans</code></pre></div>
<p><strong>Lists</strong></p>
<p>When we first encounter <code>flatMap</code> as budding Scala developers, we tend to think of it as a pattern for iterating over <code>Lists</code>. This is reinforced by the syntax of for comprehensions, which look very much like imperative for loops:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">for</span> {
  x &lt;- (<span class="dv">1</span> to <span class="dv">3</span>).<span class="fu">toList</span>
  y &lt;- (<span class="dv">4</span> to <span class="dv">5</span>).<span class="fu">toList</span>
} <span class="kw">yield</span> (x, y)
<span class="co">// res5: List[(Int, Int)] = List((1,4), (1,5), (2,4), (2,5), (3,4), (3,5))</span></code></pre></div>
<p>However, there is another mental model we can apply that highlights the monadic behaviour of <code>List</code>. If we think of <code>Lists</code> as sets of intermediate results, <code>flatMap</code> becomes a construct that calculates permutations and combinations.</p>
<p>For example, in the for comprehension above there are three possible values of <code>x</code> and two possible values of <code>y</code>. This means there are six possible values of <code>(x, y)</code>. <code>flatMap</code> is generating these combinations from our code, which states the sequence of operations:</p>
<ul>
<li>get <code>x</code></li>
<li>get <code>y</code></li>
<li>create a tuple <code>(x, y)</code></li>
</ul>
<!--
The type chart in Figure [@fig:monads:list-type-chart]
illustrates this behaviour[^list-lengths].

![Type chart: flatMap for List](src/pages/monads/list-flatmap.pdf+svg){#fig:monads:list-type-chart}

[^list-lengths]: Although the result of `flatMap` (`List[B]`)
is the same type as the result of the user-supplied function,
the end result is actually a larger list
created from combinations of intermediate `As` and `Bs`.
-->
<p><strong>Futures</strong></p>
<p><code>Future</code> is a monad that sequences computations without worrying that they are asynchronous:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Future</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

<span class="kw">def</span> doSomethingLongRunning: Future[Int] = ???
<span class="kw">def</span> doSomethingElseLongRunning: Future[Int] = ???

<span class="kw">def</span> doSomethingVeryLongRunning: Future[Int] =
  <span class="kw">for</span> {
    result1 &lt;- doSomethingLongRunning
    result2 &lt;- doSomethingElseLongRunning
  } <span class="kw">yield</span> result1 + result2</code></pre></div>
<p>Again, we specify the code to run at each step, and <code>flatMap</code> takes care of all the horrifying underlying complexities of thread pools and schedulers.</p>
<p>If you’ve made extensive use of <code>Future</code>, you’ll know that the code above is running each operation <em>in sequence</em>. This becomes clearer if we expand out the for comprehension to show the nested calls to <code>flatMap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> doSomethingVeryLongRunning: Future[Int] =
  doSomethingLongRunning.<span class="fu">flatMap</span> { result1 =&gt;
    doSomethingElseLongRunning.<span class="fu">map</span> { result2 =&gt;
      result1 + result2
    }
  }</code></pre></div>
<p>Each <code>Future</code> in our sequence is created by a function that receives the result from a previous <code>Future</code>. In other words, each step in our computation can only start once the previous step is finished. This is born out by the type chart for <code>flatMap</code> in Figure 9, which shows the function parameter of type <code>A =&gt; Future[B]</code>.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE5MjJweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE5MjIgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MC4zICgzMzgzOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+CiAgICA8dGl0bGU+ZnV0dXJlLWZsYXRtYXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xIiBjeD0iODAiIGN5PSI4MCIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMyIgY3g9Ijg0MCIgY3k9IjE0MyIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay00IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNSIgcG9pbnRzPSIxMzUuNTk1MDg2IDE1NyA4Mi42OTQ0MTM4IDE4NC44MTE1MjkgOTIuNzk3NTQzMiAxMjUuOTA1NzY1IDUwIDg0LjE4ODQ3MDUgMTA5LjE0NDc1IDc1LjU5NDIzNTMgMTM1LjU5NTA4NiAyMiAxNjIuMDQ1NDIzIDc1LjU5NDIzNTMgMjIxLjE5MDE3MyA4NC4xODg0NzA1IDE3OC4zOTI2MyAxMjUuOTA1NzY1IDE4OC40OTU3NTkgMTg0LjgxMTUyOSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTcxLjE5MDE3MyIgaGVpZ2h0PSIxNjIuODExNTI5IiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTciIHBvaW50cz0iODUuNTk1MDg2NSAxMzUgMzIuNjk0NDEzOCAxNjIuODExNTI5IDQyLjc5NzU0MzIgMTAzLjkwNTc2NSA1LjMyOTA3MDUyZS0xNCA2Mi4xODg0NzA1IDU5LjE0NDc1MDEgNTMuNTk0MjM1MyA4NS41OTUwODY1IDAgMTEyLjA0NTQyMyA1My41OTQyMzUzIDE3MS4xOTAxNzMgNjIuMTg4NDcwNSAxMjguMzkyNjMgMTAzLjkwNTc2NSAxMzguNDk1NzU5IDE2Mi44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay04IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC05IiBwb2ludHM9Ijk1OCAxMjMgOTk4IDEyMyA5OTggMTAzIDEwMzggMTQyLjQ5Nzc2NyA5OTggMTgzIDk5OCAxNjMgOTU4IDE2MyI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEwIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgPC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImZ1dHVyZS1mbGF0bWFwIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTIyIiBoZWlnaHQ9IjM2MCI+PC9yZWN0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1Ny4wMDAwMDAsIDI5LjAwMDAwMCkiIHN0cm9rZT0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMjMzLjMxNTM2MSwxODEuNDY3NzIxIEMyNTUuMDA2MTY5LDE3MC45OTI0NzEgMjY2LDE1NC45NjEyMTQgMjY2LDEzMi44IEMyNjYsMTA2Ljc1MDIzMiAyNTAuODA5NTgzLDg5LjE3MDM1OSAyMjAuOTEwODg5LDc5LjEyODE4OTYgQzIyNC45MDcyODgsNzIuMDc4MTA0MyAyMjcuMTMyOTI0LDY0LjI0NzI1MTUgMjI3LjEzMjkyNCw1NiBDMjI3LjEzMjkyNCwyNS4wNzIwNTQgMTk1LjgzMzQsMCAxNTcuMjIzNDgyLDAgQzEzOC4xNzQyMzMsMCAxMjAuOTA0NDg4LDYuMTAzMDYyODUgMTA4LjI5NTI5OSwxNi4wMDEzNiBDMTAzLjg4Nzg3MiwxNC45NTQ4NzU2IDk5LjI4MTc3MTQsMTQuNCA5NC41NDIxNjg3LDE0LjQgQzYyLjY4MjY1OCwxNC40IDM2Ljg1NTQyMTcsMzkuNDcyMDU0IDM2Ljg1NTQyMTcsNzAuNCBDMzYuODU1NDIxNyw3NC45MDkyMDAyIDM3LjQwNDQyNDgsNzkuMjkzOTIzMSAzOC40NDEwODMxLDgzLjQ5NDYxNDcgQzEzLjY4MDAwOSw5My45NTIzNzMyIDAsMTEwLjE4NDE2NyAwLDEzMi44IEMwLDE2OC4yNDg2MjYgMzMuNjA5MzQ0OSwxODguMDEyODA4IDkwLjgxOTgwMjIsMTk0LjQ0MTU5NCBDMTAzLjc4NzY3OCwyMTIuMDM1Njk2IDEyOS4yOTQwNjEsMjI0IDE1OC42Mzg1NTQsMjI0IEMxOTQuNzQwOTM2LDIyNCAyMjUuMDMzODU3LDIwNS44OTA1MjEgMjMzLjMxNTM2LDE4MS40Njc3MjUgWiIgaWQ9IkNvbWJpbmVkLVNoYXBlIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1Ny4wMDAwMDAsIDMxLjAwMDAwMCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBtYXNrPSJ1cmwoI21hc2stMikiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stNCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0xMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTA3OS4wMDAwMDAsIDQwLjAwMDAwMCkiIHN0cm9rZT0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMjMzLjMxNTM2MSwxODEuNDY3NzIxIEMyNTUuMDA2MTY5LDE3MC45OTI0NzEgMjY2LDE1NC45NjEyMTQgMjY2LDEzMi44IEMyNjYsMTA2Ljc1MDIzMiAyNTAuODA5NTgzLDg5LjE3MDM1OSAyMjAuOTEwODg5LDc5LjEyODE4OTYgQzIyNC45MDcyODgsNzIuMDc4MTA0MyAyMjcuMTMyOTI0LDY0LjI0NzI1MTUgMjI3LjEzMjkyNCw1NiBDMjI3LjEzMjkyNCwyNS4wNzIwNTQgMTk1LjgzMzQsMCAxNTcuMjIzNDgyLDAgQzEzOC4xNzQyMzMsMCAxMjAuOTA0NDg4LDYuMTAzMDYyODUgMTA4LjI5NTI5OSwxNi4wMDEzNiBDMTAzLjg4Nzg3MiwxNC45NTQ4NzU2IDk5LjI4MTc3MTQsMTQuNCA5NC41NDIxNjg3LDE0LjQgQzYyLjY4MjY1OCwxNC40IDM2Ljg1NTQyMTcsMzkuNDcyMDU0IDM2Ljg1NTQyMTcsNzAuNCBDMzYuODU1NDIxNyw3NC45MDkyMDAyIDM3LjQwNDQyNDgsNzkuMjkzOTIzMSAzOC40NDEwODMxLDgzLjQ5NDYxNDcgQzEzLjY4MDAwOSw5My45NTIzNzMyIDAsMTEwLjE4NDE2NyAwLDEzMi44IEMwLDE2OC4yNDg2MjYgMzMuNjA5MzQ0OSwxODguMDEyODA4IDkwLjgxOTgwMjIsMTk0LjQ0MTU5NCBDMTAzLjc4NzY3OCwyMTIuMDM1Njk2IDEyOS4yOTQwNjEsMjI0IDE1OC42Mzg1NTQsMjI0IEMxOTQuNzQwOTM2LDIyNCAyMjUuMDMzODU3LDIwNS44OTA1MjEgMjMzLjMxNTM2LDE4MS40Njc3MjUgWiIgaWQ9IkNvbWJpbmVkLVNoYXBlIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMSIgbWFzaz0idXJsKCNtYXNrLTYpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0xNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTUwMi4wMDAwMDAsIDM4LjAwMDAwMCkiIHN0cm9rZT0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMjMzLjMxNTM2MSwxODEuNDY3NzIxIEMyNTUuMDA2MTY5LDE3MC45OTI0NzEgMjY2LDE1NC45NjEyMTQgMjY2LDEzMi44IEMyNjYsMTA2Ljc1MDIzMiAyNTAuODA5NTgzLDg5LjE3MDM1OSAyMjAuOTEwODg5LDc5LjEyODE4OTYgQzIyNC45MDcyODgsNzIuMDc4MTA0MyAyMjcuMTMyOTI0LDY0LjI0NzI1MTUgMjI3LjEzMjkyNCw1NiBDMjI3LjEzMjkyNCwyNS4wNzIwNTQgMTk1LjgzMzQsMCAxNTcuMjIzNDgyLDAgQzEzOC4xNzQyMzMsMCAxMjAuOTA0NDg4LDYuMTAzMDYyODUgMTA4LjI5NTI5OSwxNi4wMDEzNiBDMTAzLjg4Nzg3MiwxNC45NTQ4NzU2IDk5LjI4MTc3MTQsMTQuNCA5NC41NDIxNjg3LDE0LjQgQzYyLjY4MjY1OCwxNC40IDM2Ljg1NTQyMTcsMzkuNDcyMDU0IDM2Ljg1NTQyMTcsNzAuNCBDMzYuODU1NDIxNyw3NC45MDkyMDAyIDM3LjQwNDQyNDgsNzkuMjkzOTIzMSAzOC40NDEwODMxLDgzLjQ5NDYxNDcgQzEzLjY4MDAwOSw5My45NTIzNzMyIDAsMTEwLjE4NDE2NyAwLDEzMi44IEMwLDE2OC4yNDg2MjYgMzMuNjA5MzQ0OSwxODguMDEyODA4IDkwLjgxOTgwMjIsMTk0LjQ0MTU5NCBDMTAzLjc4NzY3OCwyMTIuMDM1Njk2IDEyOS4yOTQwNjEsMjI0IDE1OC42Mzg1NTQsMjI0IEMxOTQuNzQwOTM2LDIyNCAyMjUuMDMzODU3LDIwNS44OTA1MjEgMjMzLjMxNTM2LDE4MS40Njc3MjUgWiIgaWQ9IkNvbWJpbmVkLVNoYXBlIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDguMDAwMDAwLCAyMi4wMDAwMDApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMSIgbWFzaz0idXJsKCNtYXNrLTgpIiB4bGluazpocmVmPSIjcGF0aC03Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dXNlIGlkPSJQYXRoLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTEwKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjMDAwMDAwIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIxMzg4IDEyMyAxNDI4IDEyMyAxNDI4IDEwMyAxNDY4IDE0Mi40OTc3NjcgMTQyOCAxODMgMTQyOCAxNjMgMTM4OCAxNjMiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkZ1dHVyZVtBXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTg3LjYiIHk9IjMxNyI+RnV0dXJlW0FdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iRnV0dXJlW0JdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxNTExLjYiIHk9IjMxNyI+RnV0dXJlW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GdXR1cmVbQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijg3NS42IiB5PSIzMTciPkEgPSZndDsgRnV0dXJlW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iZmxhdE1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQ1My4yIiB5PSIxNTgiPmZsYXRNYXA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 9: Type chart: flatMap for Future" id="fig:monads:future-type-chart" />
<p class="caption">Figure 9: Type chart: flatMap for Future</p>
</div>
<p>We <em>can</em> run futures in parallel, of course, but that is another story and shall be told another time. Monads are all about sequencing.</p>
<h3 id="definition-of-a-monad"><span class="header-section-number">4.1.1</span> Definition of a Monad</h3>
<p>While we have only talked about <code>flatMap</code> above, monadic behaviour is formally captured in two operations:</p>
<ul>
<li><code>pure</code>, of type <code>A =&gt; F[A]</code>;</li>
<li><code>flatMap</code><a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a>, of type <code>(F[A], A =&gt; F[B]) =&gt; F[B]</code>.</li>
</ul>
<p><code>pure</code> abstracts over constructors, providing a way to create a new monadic context from a plain value. <code>flatMap</code> provides the sequencing step we have already discussed, extracting the value from a context and generating the next context in the sequence. Here is a simplified version of the <code>Monad</code> type class in Cats:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">trait</span> Monad[F[_]] {
  <span class="kw">def</span> pure[A](value: A): F[A]

  <span class="kw">def</span> flatMap[A, B](value: F[A])(func: A =&gt; F[B]): F[B]
}</code></pre></div>
<div class="callout callout-warning">
<p><em>Monad Laws</em></p>
<p><code>pure</code> and <code>flatMap</code> must obey a set of laws that allow us to sequence operations freely without unintended glitches and side-effects:</p>
<p><em>Left identity</em>: calling <code>pure</code> and transforming the result with <code>func</code> is the same as calling <code>func</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">pure</span>(a).<span class="fu">flatMap</span>(func) == <span class="fu">func</span>(a)</code></pre></div>
<p><em>Right identity</em>: passing <code>pure</code> to <code>flatMap</code> is the same as doing nothing:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">m.<span class="fu">flatMap</span>(pure) == m</code></pre></div>
<p><em>Associativity</em>: <code>flatMapping</code> over two functions <code>f</code> and <code>g</code> is the same as <code>flatMapping</code> over <code>f</code> and then <code>flatMapping</code> over <code>g</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">m.<span class="fu">flatMap</span>(f).<span class="fu">flatMap</span>(g) == m.<span class="fu">flatMap</span>(x =&gt; <span class="fu">f</span>(x).<span class="fu">flatMap</span>(g))</code></pre></div>
</div>
<h3 id="exercise-getting-func-y"><span class="header-section-number">4.1.2</span> Exercise: Getting Func-y</h3>
<p>Every monad is also a functor. We can define <code>map</code> in the same way for every monad using the existing methods, <code>flatMap</code> and <code>pure</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">trait</span> Monad[F[_]] {
  <span class="kw">def</span> pure[A](a: A): F[A]

  <span class="kw">def</span> flatMap[A, B](value: F[A])(func: A =&gt; F[B]): F[B]

  <span class="kw">def</span> map[A, B](value: F[A])(func: A =&gt; B): F[B] =
    ???
}</code></pre></div>
<p>Try defining <code>map</code> yourself now.</p>
<div class="solution">
<p>At first glance this seems tricky, but if we follow the types we’ll see there’s only one solution. We are passed a <code>value</code> of type <code>F[A]</code>. Given the tools available there’s only one thing we can do: call <code>flatMap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Monad[F[_]] {
  <span class="kw">def</span> pure[A](value: A): F[A]

  <span class="kw">def</span> flatMap[A, B](value: F[A])(func: A =&gt; F[B]): F[B]

  <span class="kw">def</span> map[A, B](value: F[A])(func: A =&gt; B): F[B] =
    <span class="fu">flatMap</span>(value)(a =&gt; ???)
}</code></pre></div>
<p>We need a function of type <code>A =&gt; F[B]</code> as the second parameter. We have two function building blocks available: the <code>func</code> parameter of type <code>A =&gt; B</code> and the <code>pure</code> function of type <code>A =&gt; F[A]</code>. Combining these gives us our result:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Monad[F[_]] {
  <span class="kw">def</span> pure[A](value: A): F[A]

  <span class="kw">def</span> flatMap[A, B](value: F[A])(func: A =&gt; F[B]): F[B]

  <span class="kw">def</span> map[A, B](value: F[A])(func: A =&gt; B): F[B] =
    <span class="fu">flatMap</span>(value)(a =&gt; <span class="fu">pure</span>(<span class="fu">func</span>(a)))
}</code></pre></div>
</div>
<h2 id="monads-in-cats"><span class="header-section-number">4.2</span> Monads in Cats</h2>
<p>It’s time to give monads our standard Cats treatment. As usual we’ll look at the type class, instances, and syntax.</p>
<h3 id="monad-type-class"><span class="header-section-number">4.2.1</span> The Monad Type Class</h3>
<p>The monad type class is <a href="http://typelevel.org/cats/api/cats/Monad.html"><code>cats.Monad</code></a>. <code>Monad</code> extends two other type classes: <code>FlatMap</code>, which provides the <code>flatMap</code> method, and <code>Applicative</code>, which provides <code>pure</code>. <code>Applicative</code> also extends <code>Functor</code>, which gives every <code>Monad</code> a <code>map</code> method as we saw in the exercise above. We’ll discuss <code>Applicatives</code> in Chapter 6.</p>
<p>Here are some examples using <code>pure</code> and <code>flatMap</code>, and <code>map</code> directly:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monad</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Monad</span>

<span class="kw">val</span> opt1 = Monad[Option].<span class="fu">pure</span>(<span class="dv">3</span>)
<span class="co">// opt1: Option[Int] = Some(3)</span>

<span class="kw">val</span> opt2 = Monad[Option].<span class="fu">flatMap</span>(opt1)(a =&gt; Some(a + <span class="dv">2</span>))
<span class="co">// opt2: Option[Int] = Some(5)</span>

<span class="kw">val</span> opt3 = Monad[Option].<span class="fu">map</span>(opt2)(a =&gt; <span class="dv">100</span> * a)
<span class="co">// opt3: Option[Int] = Some(500)</span>

<span class="kw">val</span> list1 = Monad[List].<span class="fu">pure</span>(<span class="dv">3</span>)
<span class="co">// list1: List[Int] = List(3)</span>

<span class="kw">val</span> list2 = Monad[List].
  <span class="fu">flatMap</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(a =&gt; List(a, a*<span class="dv">10</span>))
<span class="co">// list2: List[Int] = List(1, 10, 2, 20, 3, 30)</span>

<span class="kw">val</span> list3 = Monad[List].<span class="fu">map</span>(list2)(a =&gt; a + <span class="dv">123</span>)
<span class="co">// list3: List[Int] = List(124, 133, 125, 143, 126, 153)</span></code></pre></div>
<p><code>Monad</code> provides many other methods, including all of the methods from <code>Functor</code>. See the <a href="http://typelevel.org/cats/api/cats/Monad.html">scaladoc</a> for more information.</p>
<h3 id="default-instances"><span class="header-section-number">4.2.2</span> Default Instances</h3>
<p>Cats provides instances for all the monads in the standard library (<code>Option</code>, <code>List</code>, <code>Vector</code> and so on) via <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monad</span>

Monad[Option].<span class="fu">flatMap</span>(Option(<span class="dv">1</span>))(a =&gt; Option(a*<span class="dv">2</span>))
<span class="co">// res0: Option[Int] = Some(2)</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Monad</span>

Monad[List].<span class="fu">flatMap</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(a =&gt; List(a, a*<span class="dv">10</span>))
<span class="co">// res1: List[Int] = List(1, 10, 2, 20, 3, 30)</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Monad</span>

Monad[Vector].<span class="fu">flatMap</span>(Vector(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(a =&gt; Vector(a, a*<span class="dv">10</span>))
<span class="co">// res2: Vector[Int] = Vector(1, 10, 2, 20, 3, 30)</span></code></pre></div>
<p>Cats also provides a <code>Monad</code> for <code>Future</code>. Unlike the methods on the <code>Future</code> class itself, the <code>pure</code> and <code>flatMap</code> methods on the monad can’t accept implicit <code>ExecutionContext</code> parameters (because the parameters aren’t part of the definitions in the <code>Monad</code> trait). To work around this, Cats requires us to have an <code>ExecutionContext</code> in scope when we summon a <code>Monad</code> for <code>Future</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Monad</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

<span class="kw">val</span> fm = Monad[Future]
<span class="co">// &lt;console&gt;:37: error: could not find implicit value for parameter instance: cats.Monad[scala.concurrent.Future]</span>
<span class="co">//        val fm = Monad[Future]</span>
<span class="co">//                      ^</span></code></pre></div>
<p>Bringing the <code>ExecutionContext</code> into scope fixes the implicit resolution required to summon the instance:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>

<span class="kw">val</span> fm = Monad[Future]
<span class="co">// fm: cats.Monad[scala.concurrent.Future] = cats.instances.FutureInstances$$anon$1@2376b6d6</span></code></pre></div>
<p>The <code>Monad</code> instance uses the captured <code>ExecutionContext</code> for subsequent calls to <code>pure</code> and <code>flatMap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> future = fm.<span class="fu">flatMap</span>(fm.<span class="fu">pure</span>(<span class="dv">1</span>))(x =&gt; fm.<span class="fu">pure</span>(x + <span class="dv">2</span>))

Await.<span class="fu">result</span>(future, <span class="fl">1.</span>second)
<span class="co">// res3: Int = 3</span></code></pre></div>
<p>In addition to the above, Cats provides a host of new monads that we don’t have in the standard library. We’ll familiarise ourselves with some of these in a moment.</p>
<h3 id="monad-syntax"><span class="header-section-number">4.2.3</span> Monad Syntax</h3>
<p>The syntax for monads comes from three places:</p>
<ul>
<li><a href="http://typelevel.org/cats/api/cats/syntax/package$$flatMap$"><code>cats.syntax.flatMap</code></a> provides syntax for <code>flatMap</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/syntax/package$$functor$"><code>cats.syntax.functor</code></a> provides syntax for <code>map</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/syntax/package$$applicative$"><code>cats.syntax.applicative</code></a> provides syntax for <code>pure</code>.</li>
</ul>
<p>In practice it’s often easier to import everything in one go from <a href="http://typelevel.org/cats/api/cats/implicits$.html"><code>cats.implicits</code></a>. However, we’ll use the individual imports here for clarity.</p>
<p>We can use <code>pure</code> to construct instances of a monad. We’ll often need to specify the type parameter to disambiguate the particular instance we want.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._   <span class="co">// for Monad</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._     <span class="co">// for Monad</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

<span class="fl">1.</span>pure[Option]
<span class="co">// res4: Option[Int] = Some(1)</span>

<span class="fl">1.</span>pure[List]
<span class="co">// res5: List[Int] = List(1)</span></code></pre></div>
<p>It’s difficult to demonstrate the <code>flatMap</code> and <code>map</code> methods directly on Scala monads like <code>Option</code> and <code>List</code>, because they define their own explicit versions of those methods. Instead we’ll write a generic function that performs a calculation on parameters that come wrapped in a monad of the user’s choice:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._ <span class="co">// for map</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._ <span class="co">// for flatMap</span>
<span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">def</span> sumSquare[F[_]: Monad](a: F[Int], b: F[Int]): F[Int] =
  a.<span class="fu">flatMap</span>(x =&gt; b.<span class="fu">map</span>(y =&gt; x*x + y*y))

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monad</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Monad</span>

<span class="fu">sumSquare</span>(Option(<span class="dv">3</span>), Option(<span class="dv">4</span>))
<span class="co">// res8: Option[Int] = Some(25)</span>

<span class="fu">sumSquare</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), List(<span class="dv">4</span>, <span class="dv">5</span>))
<span class="co">// res9: List[Int] = List(17, 26, 20, 29, 25, 34)</span></code></pre></div>
<p>We can rewrite this code using for comprehensions. The compiler will “do the right thing” by rewriting our comprehension in terms of <code>flatMap</code> and <code>map</code> and inserting the correct implicit conversions to use our <code>Monad</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> sumSquare[F[_]: Monad](a: F[Int], b: F[Int]): F[Int] =
  <span class="kw">for</span> {
    x &lt;- a
    y &lt;- b
  } <span class="kw">yield</span> x*x + y*y

<span class="fu">sumSquare</span>(Option(<span class="dv">3</span>), Option(<span class="dv">4</span>))
<span class="co">// res10: Option[Int] = Some(25)</span>

<span class="fu">sumSquare</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), List(<span class="dv">4</span>, <span class="dv">5</span>))
<span class="co">// res11: List[Int] = List(17, 26, 20, 29, 25, 34)</span></code></pre></div>
<p>That’s more or less everything we need to know about the generalities of monads in Cats. Now let’s take a look at some useful monad instances that we haven’t seen in the Scala standard library.</p>
<h2 id="sec:monads:identity"><span class="header-section-number">4.3</span> The Identity Monad</h2>
<p>In the previous section we demonstrated Cats’ <code>flatMap</code> and <code>map</code> syntax by writing a method that abstracted over different monads:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>
<span class="kw">import</span> cats.<span class="fu">Monad</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._ <span class="co">// for map</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._ <span class="co">// for flatMap</span>

<span class="kw">def</span> sumSquare[F[_]: Monad](a: F[Int], b: F[Int]): F[Int] =
  <span class="kw">for</span> {
    x &lt;- a
    y &lt;- b
  } <span class="kw">yield</span> x*x + y*y</code></pre></div>
<p>This method works well on <code>Options</code> and <code>Lists</code> but we can’t call it passing in plain values:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">sumSquare</span>(<span class="dv">3</span>, <span class="dv">4</span>)
<span class="co">// &lt;console&gt;:22: error: no type parameters for method sumSquare: (a: F[Int], b: F[Int])(implicit evidence$1: cats.Monad[F])F[Int] exist so that it can be applied to arguments (Int, Int)</span>
<span class="co">//  --- because ---</span>
<span class="co">// argument expression's type is not compatible with formal parameter type;</span>
<span class="co">//  found   : Int</span>
<span class="co">//  required: ?F[Int]</span>
<span class="co">//        sumSquare(3, 4)</span>
<span class="co">//        ^</span>
<span class="co">// &lt;console&gt;:22: error: type mismatch;</span>
<span class="co">//  found   : Int(3)</span>
<span class="co">//  required: F[Int]</span>
<span class="co">//        sumSquare(3, 4)</span>
<span class="co">//                  ^</span>
<span class="co">// &lt;console&gt;:22: error: type mismatch;</span>
<span class="co">//  found   : Int(4)</span>
<span class="co">//  required: F[Int]</span>
<span class="co">//        sumSquare(3, 4)</span>
<span class="co">//                     ^</span></code></pre></div>
<p>It would be incredibly useful if we could use <code>sumSquare</code> with parameters that were either in a monad or not in a monad at all. This would allow us to abstract over monadic and non-monadic code. Fortunately, Cats provides the <code>Id</code> type to bridge the gap:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Id</span>

<span class="fu">sumSquare</span>(<span class="dv">3</span> : Id[Int], <span class="dv">4</span> : Id[Int])
<span class="co">// res2: cats.Id[Int] = 25</span></code></pre></div>
<p><code>Id</code> allows us to call our monadic method using plain values. However, the exact semantics are difficult to understand. We cast the parameters to <code>sumSquare</code> as <code>Id[Int]</code> and received an <code>Id[Int]</code> back as a result!</p>
<p>What’s going on? Here is the definition of <code>Id</code> to explain:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">type</span> Id[A] = A</code></pre></div>
<p><code>Id</code> is actually a type alias that turns an atomic type into a single-parameter type constructor. We can cast any value of any type to a corresponding <code>Id</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;Dave&quot;</span> : Id[String]
<span class="co">// res3: cats.Id[String] = Dave</span>

<span class="dv">123</span> : Id[Int]
<span class="co">// res4: cats.Id[Int] = 123</span>

List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>) : Id[List[Int]]
<span class="co">// res5: cats.Id[List[Int]] = List(1, 2, 3)</span></code></pre></div>
<p>Cats provides instances of various type classes for <code>Id</code>, including <code>Functor</code> and <code>Monad</code>. These let us call <code>map</code>, <code>flatMap</code>, and <code>pure</code> passing in plain values:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> a = Monad[Id].<span class="fu">pure</span>(<span class="dv">3</span>)
<span class="co">// a: cats.Id[Int] = 3</span>

<span class="kw">val</span> b = Monad[Id].<span class="fu">flatMap</span>(a)(_ + <span class="dv">1</span>)
<span class="co">// b: cats.Id[Int] = 4</span>

<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._ <span class="co">// for map</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._ <span class="co">// for flatMap</span>

<span class="kw">for</span> {
  x &lt;- a
  y &lt;- b
} <span class="kw">yield</span> x + y
<span class="co">// res6: cats.Id[Int] = 7</span></code></pre></div>
<p>The ability to abstract over monadic and non-monadic code is extremely powerful. For example, we can run code asynchronously in production using <code>Future</code> and synchronously in test using <code>Id</code>. We’ll see this in our first case study in Chapter 8.</p>
<h3 id="exercise-monadic-secret-identities"><span class="header-section-number">4.3.1</span> Exercise: Monadic Secret Identities</h3>
<p>Implement <code>pure</code>, <code>map</code>, and <code>flatMap</code> for <code>Id</code>! What interesting discoveries do you uncover about the implementation?</p>
<div class="solution">
<p>Let’s start by defining the method signatures:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Id</span>

<span class="kw">def</span> pure[A](value: A): Id[A] =
  ???

<span class="kw">def</span> map[A, B](initial: Id[A])(func: A =&gt; B): Id[B] =
  ???

<span class="kw">def</span> flatMap[A, B](initial: Id[A])(func: A =&gt; Id[B]): Id[B] =
  ???</code></pre></div>
<p>Now let’s look at each method in turn. The <code>pure</code> operation creates an <code>Id[A]</code> from an <code>A</code>. But <code>A</code> and <code>Id[A]</code> are the same type! All we have to do is return the initial value:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> pure[A](value: A): Id[A] =
  value

<span class="fu">pure</span>(<span class="dv">123</span>)
<span class="co">// res10: cats.Id[Int] = 123</span></code></pre></div>
<p>The <code>map</code> method takes a parameter of type <code>Id[A]</code>, applies a function of type <code>A =&gt; B</code>, and returns an <code>Id[B]</code>. But <code>Id[A]</code> is simply <code>A</code> and <code>Id[B]</code> is simply <code>B</code>! All we have to do is call the function—no packing or unpacking required:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> map[A, B](initial: Id[A])(func: A =&gt; B): Id[B] =
  <span class="fu">func</span>(initial)

<span class="fu">map</span>(<span class="dv">123</span>)(_ * <span class="dv">2</span>)
<span class="co">// res11: cats.Id[Int] = 246</span></code></pre></div>
<p>The final punch line is that, once we strip away the <code>Id</code> type constructors, <code>flatMap</code> and <code>map</code> are actually identical:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> flatMap[A, B](initial: Id[A])(func: A =&gt; Id[B]): Id[B] =
  <span class="fu">func</span>(initial)
<span class="co">// flatMap: [A, B](initial: cats.Id[A])(func: A =&gt; cats.Id[B])cats.Id[B]</span>

<span class="fu">flatMap</span>(<span class="dv">123</span>)(_ * <span class="dv">2</span>)
<span class="co">// res12: cats.Id[Int] = 246</span></code></pre></div>
<p>This ties in with our understanding of functors and monads as sequencing type classes. Each type class allows us to sequence operations ignoring some kind of complication. In the case of <code>Id</code> there is no complication, making <code>map</code> and <code>flatMap</code> the same thing.</p>
<p>Notice that we haven’t had to write type annotations in the method bodies above. The compiler is able to interpret values of type <code>A</code> as <code>Id[A]</code> and vice versa by the context in which they are used.</p>
<p>The only restriction we’ve seen to this is that Scala cannot unify types and type constructors when searching for implicits. Hence our need to re-type <code>Int</code> as <code>Id[Int]</code> in the call to <code>sumSquare</code> at the opening of this section:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">sumSquare</span>(<span class="dv">3</span> : Id[Int], <span class="dv">4</span> : Id[Int])</code></pre></div>
</div>
<h2 id="either"><span class="header-section-number">4.4</span> Either</h2>
<p>Let’s look at another useful monad: the <code>Either</code> type from the Scala standard library. In Scala 2.11 and earlier, many people didn’t consider <code>Either</code> a monad because it didn’t have <code>map</code> and <code>flatMap</code> methods. In Scala 2.12, however, <code>Either</code> became <em>right biased</em>.</p>
<h3 id="left-and-right-bias"><span class="header-section-number">4.4.1</span> Left and Right Bias</h3>
<p>In Scala 2.11, <code>Either</code> had no default <code>map</code> or <code>flatMap</code> method. This made the Scala 2.11 version of <code>Either</code> inconvenient to use in for comprehensions. We had to insert calls to <code>.right</code> in every generator clause:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> either1: Either[String, Int] = <span class="fu">Right</span>(<span class="dv">10</span>)
<span class="kw">val</span> either2: Either[String, Int] = <span class="fu">Right</span>(<span class="dv">32</span>)

<span class="kw">for</span> {
  a &lt;- either1.<span class="fu">right</span>
  b &lt;- either2.<span class="fu">right</span>
} <span class="kw">yield</span> a + b
<span class="co">// res0: scala.util.Either[String,Int] = Right(42)</span></code></pre></div>
<p>In Scala 2.12, <code>Either</code> was redesigned. The modern <code>Either</code> makes the decision that the right side represents the success case and thus supports <code>map</code> and <code>flatMap</code> directly. This makes for comprehensions much more pleasant:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">for</span> {
  a &lt;- either1
  b &lt;- either2
} <span class="kw">yield</span> a + b
<span class="co">// res1: scala.util.Either[String,Int] = Right(42)</span></code></pre></div>
<p>Cats back-ports this behaviour to Scala 2.11 via the <code>cats.syntax.either</code> import, allowing us to use right-biased <code>Either</code> in all supported versions of Scala. In Scala 2.12+ we can either omit this import or leave it in place without breaking anything:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._ <span class="co">// for map and flatMap</span>

<span class="kw">for</span> {
  a &lt;- either1
  b &lt;- either2
} <span class="kw">yield</span> a + b</code></pre></div>
<h3 id="creating-instances"><span class="header-section-number">4.4.2</span> Creating Instances</h3>
<p>In addition to creating instances of <code>Left</code> and <code>Right</code> directly, we can also import the <code>asLeft</code> and <code>asRight</code> extension methods from <a href="http://typelevel.org/cats/api/cats/syntax/package$$either$"><code>cats.syntax.either</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._ <span class="co">// for asRight</span>

<span class="kw">val</span> a = <span class="fl">3.</span>asRight[String]
<span class="co">// a: Either[String,Int] = Right(3)</span>

<span class="kw">val</span> b = <span class="fl">4.</span>asRight[String]
<span class="co">// b: Either[String,Int] = Right(4)</span>

<span class="kw">for</span> {
  x &lt;- a
  y &lt;- b
} <span class="kw">yield</span> x*x + y*y
<span class="co">// res4: scala.util.Either[String,Int] = Right(25)</span></code></pre></div>
<p>These “smart constructors” have advantages over <code>Left.apply</code> and <code>Right.apply</code> because they return results of type <code>Either</code> instead of <code>Left</code> and <code>Right</code>. This helps avoid type inference bugs caused by over-narrowing, like the bug in the example below:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">countPositive</span>(nums: List[Int]) =
  nums.<span class="fu">foldLeft</span>(<span class="fu">Right</span>(<span class="dv">0</span>)) { (accumulator, num) =&gt;
    <span class="kw">if</span>(num &gt; <span class="dv">0</span>) {
      accumulator.<span class="fu">map</span>(_ + <span class="dv">1</span>)
    } <span class="kw">else</span> {
      <span class="fu">Left</span>(<span class="st">&quot;Negative. Stopping!&quot;</span>)
    }
  }
<span class="co">// &lt;console&gt;:21: error: type mismatch;</span>
<span class="co">//  found   : scala.util.Either[Nothing,Int]</span>
<span class="co">//  required: scala.util.Right[Nothing,Int]</span>
<span class="co">//              accumulator.map(_ + 1)</span>
<span class="co">//                             ^</span>
<span class="co">// &lt;console&gt;:23: error: type mismatch;</span>
<span class="co">//  found   : scala.util.Left[String,Nothing]</span>
<span class="co">//  required: scala.util.Right[Nothing,Int]</span>
<span class="co">//              Left(&quot;Negative. Stopping!&quot;)</span>
<span class="co">//                  ^</span></code></pre></div>
<p>This code fails to compile for two reasons:</p>
<ol style="list-style-type: decimal">
<li>the compiler infers the type of the accumulator as <code>Right</code> instead of <code>Either</code>;</li>
<li>we didn’t specify type parameters for <code>Right.apply</code> so the compiler infers the left parameter as <code>Nothing</code>.</li>
</ol>
<p>Switching to <code>asRight</code> avoids both of these problems. <code>asRight</code> has a return type of <code>Either</code>, and allows us to completely specify the type with only one type parameter:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">countPositive</span>(nums: List[Int]) =
  nums.<span class="fu">foldLeft</span>(<span class="fl">0.</span>asRight[String]) { (accumulator, num) =&gt;
    <span class="kw">if</span>(num &gt; <span class="dv">0</span>) {
      accumulator.<span class="fu">map</span>(_ + <span class="dv">1</span>)
    } <span class="kw">else</span> {
      <span class="fu">Left</span>(<span class="st">&quot;Negative. Stopping!&quot;</span>)
    }
  }

<span class="fu">countPositive</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res5: Either[String,Int] = Right(3)</span>

<span class="fu">countPositive</span>(List(<span class="dv">1</span>, -<span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res6: Either[String,Int] = Left(Negative. Stopping!)</span></code></pre></div>
<p><code>cats.syntax.either</code> adds some useful extension methods to the <code>Either</code> companion object. The <code>catchOnly</code> and <code>catchNonFatal</code> methods are great for capturing <code>Exceptions</code> as instances of <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Either.<span class="fu">catchOnly</span>[NumberFormatException](<span class="st">&quot;foo&quot;</span>.<span class="fu">toInt</span>)
<span class="co">// res7: Either[NumberFormatException,Int] = Left(java.lang.NumberFormatException: For input string: &quot;foo&quot;)</span>

Either.<span class="fu">catchNonFatal</span>(sys.<span class="fu">error</span>(<span class="st">&quot;Badness&quot;</span>))
<span class="co">// res8: Either[Throwable,Nothing] = Left(java.lang.RuntimeException: Badness)</span></code></pre></div>
<p>There are also methods for creating an <code>Either</code> from other data types:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Either.<span class="fu">fromTry</span>(scala.<span class="fu">util</span>.<span class="fu">Try</span>(<span class="st">&quot;foo&quot;</span>.<span class="fu">toInt</span>))
<span class="co">// res9: Either[Throwable,Int] = Left(java.lang.NumberFormatException: For input string: &quot;foo&quot;)</span>

Either.<span class="fu">fromOption</span>[String, Int](None, <span class="st">&quot;Badness&quot;</span>)
<span class="co">// res10: Either[String,Int] = Left(Badness)</span></code></pre></div>
<h3 id="transforming-eithers"><span class="header-section-number">4.4.3</span> Transforming Eithers</h3>
<p><code>cats.syntax.either</code> also adds some useful methods for instances of <code>Either</code>. We can use <code>orElse</code> and <code>getOrElse</code> to extract values from the right side or return a default:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._

<span class="st">&quot;Error&quot;</span>.<span class="fu">asLeft</span>[Int].<span class="fu">getOrElse</span>(<span class="dv">0</span>)
<span class="co">// res11: Int = 0</span>

<span class="st">&quot;Error&quot;</span>.<span class="fu">asLeft</span>[Int].<span class="fu">orElse</span>(<span class="fl">2.</span>asRight[String])
<span class="co">// res12: Either[String,Int] = Right(2)</span></code></pre></div>
<p>The <code>ensure</code> method allows us to check whether the right-hand value satisfies a predicate:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">-<span class="fl">1.</span>asRight[String].<span class="fu">ensure</span>(<span class="st">&quot;Must be non-negative!&quot;</span>)(_ &gt; <span class="dv">0</span>)
<span class="co">// res13: Either[String,Int] = Left(Must be non-negative!)</span></code></pre></div>
<p>The <code>recover</code> and <code>recoverWith</code> methods provide similar error handling to their namesakes on <code>Future</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;error&quot;</span>.<span class="fu">asLeft</span>[Int].<span class="fu">recover</span> {
  <span class="kw">case</span> str: String =&gt; -<span class="dv">1</span>
}
<span class="co">// res14: Either[String,Int] = Right(-1)</span>

<span class="st">&quot;error&quot;</span>.<span class="fu">asLeft</span>[Int].<span class="fu">recoverWith</span> {
  <span class="kw">case</span> str: String =&gt; <span class="fu">Right</span>(-<span class="dv">1</span>)
}
<span class="co">// res15: Either[String,Int] = Right(-1)</span></code></pre></div>
<p>There are <code>leftMap</code> and <code>bimap</code> methods to complement <code>map</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;foo&quot;</span>.<span class="fu">asLeft</span>[Int].<span class="fu">leftMap</span>(_.<span class="fu">reverse</span>)
<span class="co">// res16: Either[String,Int] = Left(oof)</span>

<span class="fl">6.</span>asRight[String].<span class="fu">bimap</span>(_.<span class="fu">reverse</span>, _ * <span class="dv">7</span>)
<span class="co">// res17: Either[String,Int] = Right(42)</span>

<span class="st">&quot;bar&quot;</span>.<span class="fu">asLeft</span>[Int].<span class="fu">bimap</span>(_.<span class="fu">reverse</span>, _ * <span class="dv">7</span>)
<span class="co">// res18: Either[String,Int] = Left(rab)</span></code></pre></div>
<p>The <code>swap</code> method lets us exchange left for right:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fl">123.</span>asRight[String]
<span class="co">// res19: Either[String,Int] = Right(123)</span>

<span class="fl">123.</span>asRight[String].<span class="fu">swap</span>
<span class="co">// res20: scala.util.Either[Int,String] = Left(123)</span></code></pre></div>
<p>Finally, Cats adds a host of conversion methods: <code>toOption</code>, <code>toList</code>, <code>toTry</code>, <code>toValidated</code>, and so on.</p>
<h3 id="error-handling"><span class="header-section-number">4.4.4</span> Error Handling</h3>
<p><code>Either</code> is typically used to implement fail-fast error handling. We sequence computations using <code>flatMap</code> as usual. If one computation fails, the remaining computations are not run:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">for</span> {
  a &lt;- <span class="fl">1.</span>asRight[String]
  b &lt;- <span class="fl">0.</span>asRight[String]
  c &lt;- <span class="kw">if</span>(b == <span class="dv">0</span>) <span class="st">&quot;DIV0&quot;</span>.<span class="fu">asLeft</span>[Int]
       <span class="kw">else</span> (a / b).<span class="fu">asRight</span>[String]
} <span class="kw">yield</span> c * <span class="dv">100</span>
<span class="co">// res21: scala.util.Either[String,Int] = Left(DIV0)</span></code></pre></div>
<p>When using <code>Either</code> for error handling, we need to determine what type we want to use to represent errors. We could use <code>Throwable</code> for this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Result[A] = Either[Throwable, A]</code></pre></div>
<p>This gives us similar semantics to <code>scala.util.Try</code>. The problem, however, is that <code>Throwable</code> is an extremely broad type. We have (almost) no idea about what type of error occurred.</p>
<p>Another approach is to define an algebraic data type to represent errors that may occur in our program:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> LoginError <span class="kw">extends</span> Product <span class="kw">with</span> Serializable

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">UserNotFound</span>(username: String)
  <span class="kw">extends</span> LoginError

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">PasswordIncorrect</span>(username: String)
  <span class="kw">extends</span> LoginError

<span class="kw">case</span> <span class="kw">object</span> UnexpectedError <span class="kw">extends</span> LoginError

<span class="kw">case</span> <span class="kw">class</span> <span class="fu">User</span>(username: String, password: String)

<span class="kw">type</span> LoginResult = Either[LoginError, User]</code></pre></div>
<p>This approach solves the problems we saw with <code>Throwable</code>. It gives us a fixed set of expected error types and a catch-all for anything else that we didn’t expect. We also get the safety of exhaustivity checking on any pattern matching we do:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Choose error-handling behaviour based on type:</span>
<span class="kw">def</span> <span class="fu">handleError</span>(error: LoginError): Unit =
  error <span class="kw">match</span> {
    <span class="kw">case</span> <span class="fu">UserNotFound</span>(u) =&gt;
      <span class="fu">println</span>(s<span class="st">&quot;User not found: $u&quot;</span>)

    <span class="kw">case</span> <span class="fu">PasswordIncorrect</span>(u) =&gt;
      <span class="fu">println</span>(s<span class="st">&quot;Password incorrect: $u&quot;</span>)

    <span class="kw">case</span> UnexpectedError =&gt;
      <span class="fu">println</span>(s<span class="st">&quot;Unexpected error&quot;</span>)
  }

<span class="kw">val</span> result1: LoginResult = <span class="fu">User</span>(<span class="st">&quot;dave&quot;</span>, <span class="st">&quot;passw0rd&quot;</span>).<span class="fu">asRight</span>
<span class="co">// result1: LoginResult = Right(User(dave,passw0rd))</span>

<span class="kw">val</span> result2: LoginResult = <span class="fu">UserNotFound</span>(<span class="st">&quot;dave&quot;</span>).<span class="fu">asLeft</span>
<span class="co">// result2: LoginResult = Left(UserNotFound(dave))</span>

result1.<span class="fu">fold</span>(handleError, println)
<span class="co">// User(dave,passw0rd)</span>

result2.<span class="fu">fold</span>(handleError, println)
<span class="co">// User not found: dave</span></code></pre></div>
<h3 id="exercise-what-is-best"><span class="header-section-number">4.4.5</span> Exercise: What is Best?</h3>
<p>Is the error handling strategy in the previous examples well suited for all purposes? What other features might we want from error handling?</p>
<div class="solution">
<p>This is an open question. It’s also kind of a trick question—the answer depends on the semantics we’re looking for. Some points to ponder:</p>
<ul>
<li><p>Error recovery is important when processing large jobs. We don’t want to run a job for a day and then find it failed on the last element.</p></li>
<li><p>Error reporting is equally important. We need to know what went wrong, not just that something went wrong.</p></li>
<li>In a number of cases, we want to collect all the errors, not just the first one we encountered. A typical example is validating a web form. It’s a far better experience to report all errors to the user when they submit a form than to report them one at a time.</li>
</ul>
</div>
<h2 id="aside-error-handling-and-monaderror"><span class="header-section-number">4.5</span> Aside: Error Handling and MonadError</h2>
<p>Cats provides an additional type class called <code>MonadError</code> that abstracts over <code>Either</code>-like data types that are used for error handling. <code>MonadError</code> provides extra operations for raising and handling errors.</p>
<div class="callout callout-info">
<p><em>This Section is Optional!</em></p>
<p>You won’t need to use <code>MonadError</code> unless you need to abstract over error handling monads. For example, you can use <code>MonadError</code> to abstract over <code>Future</code> and <code>Try</code>, or over <code>Either</code> and <code>EitherT</code> (which we will meet in Chapter 5).</p>
<p>If you don’t need this kind of abstraction right now, feel free to skip onwards to Section 4.6.</p>
</div>
<h3 id="the-monaderror-type-class"><span class="header-section-number">4.5.1</span> The MonadError Type Class</h3>
<p>Here is a simplified version of the definition of <code>MonadError</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">trait</span> MonadError[F[_], E] <span class="kw">extends</span> Monad[F] {
  <span class="co">// Lift an error into the `F` context:</span>
  <span class="kw">def</span> raiseError[A](e: E): F[A]

  <span class="co">// Handle an error, potentially recovering from it:</span>
  <span class="kw">def</span> handleError[A](fa: F[A])(f: E =&gt; A): F[A]

  <span class="co">// Test an instance of `F`,</span>
  <span class="co">// failing if the predicate is not satisfied:</span>
  <span class="kw">def</span> ensure[A](fa: F[A])(e: E)(f: A =&gt; Boolean): F[A]
}</code></pre></div>
<p><code>MonadError</code> is defined in terms of two type parameters:</p>
<ul>
<li><code>F</code> is the type of the monad;</li>
<li><code>E</code> is the type of error contained within <code>F</code>.</li>
</ul>
<p>To demonstrate how these parameters fit together, here’s an example where we instantiate the type class for <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">MonadError</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">either</span>._ <span class="co">// for MonadError</span>

<span class="kw">type</span> ErrorOr[A] = Either[String, A]

<span class="kw">val</span> monadError = MonadError[ErrorOr, String]</code></pre></div>
<div class="callout callout-warning">
<p><em>ApplicativeError</em></p>
<p>In reality, <code>MonadError</code> extends another type class called <code>ApplicativeError</code>. However, we won’t encounter <code>Applicatives</code> until Chapter 6. The semantics are the same for each type class so we can ignore this detail for now.</p>
</div>
<h3 id="raising-and-handling-errors"><span class="header-section-number">4.5.2</span> Raising and Handling Errors</h3>
<p>The two most important methods of <code>MonadError</code> are <code>raiseError</code> and <code>handleError</code>. <code>raiseError</code> is like the <code>pure</code> method for <code>Monad</code> except that it creates an instance representing a failure:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> success = monadError.<span class="fu">pure</span>(<span class="dv">42</span>)
<span class="co">// success: ErrorOr[Int] = Right(42)</span>

<span class="kw">val</span> failure = monadError.<span class="fu">raiseError</span>(<span class="st">&quot;Badness&quot;</span>)
<span class="co">// failure: ErrorOr[Nothing] = Left(Badness)</span></code></pre></div>
<p><code>handleError</code> is the complement of <code>raiseError</code>. It allows us to consume an error and (possibly) turn it into a success, similar to the <code>recover</code> method of <code>Future</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">monadError.<span class="fu">handleError</span>(failure) {
  <span class="kw">case</span> <span class="st">&quot;Badness&quot;</span> =&gt;
    monadError.<span class="fu">pure</span>(<span class="st">&quot;It's ok&quot;</span>)

  <span class="kw">case</span> other =&gt;
    monadError.<span class="fu">raiseError</span>(<span class="st">&quot;It's not ok&quot;</span>)
}
<span class="co">// res2: ErrorOr[ErrorOr[String]] = Right(Right(It's ok))</span></code></pre></div>
<p>There is also a third useful method called <code>ensure</code> that implements <code>filter</code>-like behaviour. We test the value of a successful monad with a predicate and specify an error to raise if the predicate returns <code>false</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._ <span class="co">// for asRight</span>

monadError.<span class="fu">ensure</span>(success)(<span class="st">&quot;Number too low!&quot;</span>)(_ &gt; <span class="dv">1000</span>)
<span class="co">// res3: ErrorOr[Int] = Left(Number too low!)</span></code></pre></div>
<p>Cats provides syntax for <code>raiseError</code> and <code>handleError</code> via <a href="http://typelevel.org/cats/api/cats/syntax/package$$applicativeError$"><code>cats.syntax.applicativeError</code></a> and <code>ensure</code> via <a href="http://typelevel.org/cats/api/cats/syntax/package$$monadError$"><code>cats.syntax.monadError</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._      <span class="co">// for pure</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicativeError</span>._ <span class="co">// for raiseError etc</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">monadError</span>._       <span class="co">// for ensure</span>

<span class="kw">val</span> success = <span class="fl">42.</span>pure[ErrorOr]
<span class="co">// success: ErrorOr[Int] = Right(42)</span>

<span class="kw">val</span> failure = <span class="st">&quot;Badness&quot;</span>.<span class="fu">raiseError</span>[ErrorOr, Int]
<span class="co">// failure: ErrorOr[Int] = Left(Badness)</span>

success.<span class="fu">ensure</span>(<span class="st">&quot;Number to low!&quot;</span>)(_ &gt; <span class="dv">1000</span>)
<span class="co">// res4: Either[String,Int] = Left(Number to low!)</span></code></pre></div>
<p>There are other useful variants of these methods. See the source of <a href="http://typelevel.org/cats/api/cats/MonadError.html"><code>cats.MonadError</code></a> and <a href="http://typelevel.org/cats/api/cats/ApplicativeError.html"><code>cats.ApplicativeError</code></a> for more information.</p>
<h3 id="instances-of-monaderror"><span class="header-section-number">4.5.3</span> Instances of MonadError</h3>
<p>Cats provides instances of <code>MonadError</code> for numerous data types including <code>Either</code>, <code>Future</code>, and <code>Try</code>. The instance for <code>Either</code> is customisable to any error type, whereas the instances for <code>Future</code> and <code>Try</code> always represent errors as <code>Throwables</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">util</span>.<span class="fu">Try</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">try_</span>._ <span class="co">// for MonadError</span>

<span class="kw">val</span> exn: Throwable =
  <span class="kw">new</span> RuntimeException(<span class="st">&quot;It's all gone wrong&quot;</span>)

exn.<span class="fu">raiseError</span>[Try, Int]
<span class="co">// res6: scala.util.Try[Int] = Failure(java.lang.RuntimeException: It's all gone wrong)</span></code></pre></div>
<h3 id="exercise-abstracting"><span class="header-section-number">4.5.4</span> Exercise: Abstracting</h3>
<h2 id="sec:monads:eval"><span class="header-section-number">4.6</span> The Eval Monad</h2>
<p><a href="http://typelevel.org/cats/api/cats/Eval.html"><code>cats.Eval</code></a> is a monad that allows us to abstract over different <em>models of evaluation</em>. We typically hear of two such models: <em>eager</em> and <em>lazy</em>. <code>Eval</code> throws in a further distinction of whether or not a result is <em>memoized</em>.</p>
<h3 id="eager-lazy-memoized-oh-my"><span class="header-section-number">4.6.1</span> Eager, Lazy, Memoized, Oh My!</h3>
<p>What do these terms mean?</p>
<p><em>Eager</em> computations happen immediately whereas <em>lazy</em> computations happen on access. <em>Memoized</em> computations are run once on first access, after which the results are cached.</p>
<p>For example, Scala <code>vals</code> are eager and memoized. We can see this using a computation with a visible side-effect. In the following example, the code to compute the value of <code>x</code> happens at the definition site rather than on access (eager). Accessing <code>x</code> recalls the stored value without re-running the code (memoized).</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> x = {
  <span class="fu">println</span>(<span class="st">&quot;Computing X&quot;</span>)
  math.<span class="fu">random</span>
}
<span class="co">// Computing X</span>
<span class="co">// x: Double = 0.4345572816087647</span>

x <span class="co">// first access</span>
<span class="co">// res0: Double = 0.4345572816087647</span>

x <span class="co">// second access</span>
<span class="co">// res1: Double = 0.4345572816087647</span></code></pre></div>
<p>By contrast, <code>defs</code> are lazy and not memoized. The code to compute <code>y</code> below is not run until we access it (lazy), and is re-run on every access (not memoized):</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> y = {
  <span class="fu">println</span>(<span class="st">&quot;Computing Y&quot;</span>)
  math.<span class="fu">random</span>
}
<span class="co">// y: Double</span>

y <span class="co">// first access</span>
<span class="co">// Computing Y</span>
<span class="co">// res2: Double = 0.3502991320725217</span>

y <span class="co">// second access</span>
<span class="co">// Computing Y</span>
<span class="co">// res3: Double = 0.5442621440649401</span></code></pre></div>
<p>Last but not least, <code>lazy vals</code> are lazy and memoized. The code to compute <code>z</code> below is not run until we access it for the first time (lazy). The result is then cached and re-used on subsequent accesses (memoized):</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">lazy</span> <span class="kw">val</span> z = {
  <span class="fu">println</span>(<span class="st">&quot;Computing Z&quot;</span>)
  math.<span class="fu">random</span>
}
<span class="co">// z: Double = &lt;lazy&gt;</span>

z <span class="co">// first access</span>
<span class="co">// Computing Z</span>
<span class="co">// res4: Double = 0.6066664277409128</span>

z <span class="co">// second access</span>
<span class="co">// res5: Double = 0.6066664277409128</span></code></pre></div>
<h3 id="evals-models-of-evaluation"><span class="header-section-number">4.6.2</span> Eval’s Models of Evaluation</h3>
<p><code>Eval</code> has three subtypes: <code>Now</code>, <code>Later</code>, and <code>Always</code>. We construct these with three constructor methods, which create instances of the three classes and return them typed as <code>Eval</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Eval</span>

<span class="kw">val</span> now = Eval.<span class="fu">now</span>(math.<span class="fu">random</span> + <span class="dv">1000</span>)
<span class="co">// now: cats.Eval[Double] = Now(1000.3579280134779)</span>

<span class="kw">val</span> later = Eval.<span class="fu">later</span>(math.<span class="fu">random</span> + <span class="dv">2000</span>)
<span class="co">// later: cats.Eval[Double] = cats.Later@359ba169</span>

<span class="kw">val</span> always = Eval.<span class="fu">always</span>(math.<span class="fu">random</span> + <span class="dv">3000</span>)
<span class="co">// always: cats.Eval[Double] = cats.Always@6765a7a7</span></code></pre></div>
<p>We can extract the result of an <code>Eval</code> using its <code>value</code> method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">now.<span class="fu">value</span>
<span class="co">// res6: Double = 1000.3579280134779</span>

later.<span class="fu">value</span>
<span class="co">// res7: Double = 2000.8071652362269</span>

always.<span class="fu">value</span>
<span class="co">// res8: Double = 3000.041050152967</span></code></pre></div>
<p>Each type of <code>Eval</code> calculates its result using one of the evaluation models defined above. <code>Eval.now</code> captures a value <em>right now</em>. Its semantics are similar to a <code>val</code>—eager and memoized:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> x = Eval.<span class="fu">now</span> {
  <span class="fu">println</span>(<span class="st">&quot;Computing X&quot;</span>)
  math.<span class="fu">random</span>
}
<span class="co">// Computing X</span>
<span class="co">// x: cats.Eval[Double] = Now(0.6716231739812782)</span>

x.<span class="fu">value</span> <span class="co">// first access</span>
<span class="co">// res9: Double = 0.6716231739812782</span>

x.<span class="fu">value</span> <span class="co">// second access</span>
<span class="co">// res10: Double = 0.6716231739812782</span></code></pre></div>
<p><code>Eval.always</code> captures a lazy computation, similar to a <code>def</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> y = Eval.<span class="fu">always</span> {
  <span class="fu">println</span>(<span class="st">&quot;Computing Y&quot;</span>)
  math.<span class="fu">random</span>
}
<span class="co">// y: cats.Eval[Double] = cats.Always@15b27c78</span>

y.<span class="fu">value</span> <span class="co">// first access</span>
<span class="co">// Computing Y</span>
<span class="co">// res11: Double = 0.5122955601138698</span>

y.<span class="fu">value</span> <span class="co">// second access</span>
<span class="co">// Computing Y</span>
<span class="co">// res12: Double = 0.21169070376150056</span></code></pre></div>
<p>Finally, <code>Eval.later</code> captures a lazy, memoized computation, similar to a <code>lazy val</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> z = Eval.<span class="fu">later</span> {
  <span class="fu">println</span>(<span class="st">&quot;Computing Z&quot;</span>)
  math.<span class="fu">random</span>
}
<span class="co">// z: cats.Eval[Double] = cats.Later@3d06f508</span>

z.<span class="fu">value</span> <span class="co">// first access</span>
<span class="co">// Computing Z</span>
<span class="co">// res13: Double = 0.2053172559011206</span>

z.<span class="fu">value</span> <span class="co">// second access</span>
<span class="co">// res14: Double = 0.2053172559011206</span></code></pre></div>
<p>The three behaviours are summarized below:</p>
<div class="table-responsive">
<table style="width:99%;">
<colgroup>
<col width="26%"></col>
<col width="36%"></col>
<col width="36%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="left">Scala</th>
<th align="left">Cats</th>
<th align="left">Properties</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>val</code></td>
<td align="left"><code>Now</code></td>
<td align="left">eager, memoized</td>
</tr>
<tr class="even">
<td align="left"><code>lazy val</code></td>
<td align="left"><code>Later</code></td>
<td align="left">lazy, memoized</td>
</tr>
<tr class="odd">
<td align="left"><code>def</code></td>
<td align="left"><code>Always</code></td>
<td align="left">lazy, not memoized</td>
</tr>
</tbody>
</table>
</div>
<h3 id="eval-as-a-monad"><span class="header-section-number">4.6.3</span> Eval as a Monad</h3>
<p>Like all monads, <code>Eval's</code> <code>map</code> and <code>flatMap</code> methods add computations to a chain. In this case, however, the chain is stored explicitly as a list of functions. The functions aren’t run until we call <code>Eval's</code> <code>value</code> method to request a result:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> greeting = Eval.
  always { <span class="fu">println</span>(<span class="st">&quot;Step 1&quot;</span>); <span class="st">&quot;Hello&quot;</span> }.
  map { str =&gt; <span class="fu">println</span>(<span class="st">&quot;Step 2&quot;</span>); s<span class="st">&quot;$str world&quot;</span> }
<span class="co">// greeting: cats.Eval[String] = cats.Eval$$anon$8@104a64db</span>

greeting.<span class="fu">value</span>
<span class="co">// Step 1</span>
<span class="co">// Step 2</span>
<span class="co">// res15: String = Hello world</span></code></pre></div>
<p>Note that, while the semantics of the originating <code>Eval</code> instances are maintained, mapping functions are always called lazily on demand (<code>def</code> semantics):</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> ans = <span class="kw">for</span> {
  a &lt;- Eval.<span class="fu">now</span> { <span class="fu">println</span>(<span class="st">&quot;Calculating A&quot;</span>); <span class="dv">40</span> }
  b &lt;- Eval.<span class="fu">always</span> { <span class="fu">println</span>(<span class="st">&quot;Calculating B&quot;</span>); <span class="dv">2</span> }
} <span class="kw">yield</span> {
  <span class="fu">println</span>(<span class="st">&quot;Adding A and B&quot;</span>)
  a + b
}
<span class="co">// Calculating A</span>
<span class="co">// ans: cats.Eval[Int] = cats.Eval$$anon$8@12af4029</span>

ans.<span class="fu">value</span> <span class="co">// first access</span>
<span class="co">// Calculating B</span>
<span class="co">// Adding A and B</span>
<span class="co">// res16: Int = 42</span>

ans.<span class="fu">value</span> <span class="co">// second access</span>
<span class="co">// Calculating B</span>
<span class="co">// Adding A and B</span>
<span class="co">// res17: Int = 42</span></code></pre></div>
<p><code>Eval</code> has a <code>memoize</code> method that allows us to memoize a chain of computations. The result of the chain up to the call to <code>memoize</code> is cached, whereas calculations after the call retain their original semantics:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> saying = Eval.
  always { <span class="fu">println</span>(<span class="st">&quot;Step 1&quot;</span>); <span class="st">&quot;The cat&quot;</span> }.
  map { str =&gt; <span class="fu">println</span>(<span class="st">&quot;Step 2&quot;</span>); s<span class="st">&quot;$str sat on&quot;</span> }.
  memoize.
  map { str =&gt; <span class="fu">println</span>(<span class="st">&quot;Step 3&quot;</span>); s<span class="st">&quot;$str the mat&quot;</span> }
<span class="co">// saying: cats.Eval[String] = cats.Eval$$anon$8@24dcb11b</span>

saying.<span class="fu">value</span> <span class="co">// first access</span>
<span class="co">// Step 1</span>
<span class="co">// Step 2</span>
<span class="co">// Step 3</span>
<span class="co">// res18: String = The cat sat on the mat</span>

saying.<span class="fu">value</span> <span class="co">// second access</span>
<span class="co">// Step 3</span>
<span class="co">// res19: String = The cat sat on the mat</span></code></pre></div>
<h3 id="trampolining-and-eval.defer"><span class="header-section-number">4.6.4</span> Trampolining and <em>Eval.defer</em></h3>
<p>One useful property of <code>Eval</code> is that its <code>map</code> and <code>flatMap</code> methods are <em>trampolined</em>. This means we can nest calls to <code>map</code> and <code>flatMap</code> arbitrarily without consuming stack frames. We call this property <em>“stack safety”</em>.</p>
<p>For example, consider this function for calculating factorials:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">factorial</span>(n: BigInt): BigInt =
  <span class="kw">if</span>(n == <span class="dv">1</span>) n <span class="kw">else</span> n * <span class="fu">factorial</span>(n - <span class="dv">1</span>)</code></pre></div>
<p>It is relatively easy to make this method stack overflow:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">factorial</span>(<span class="dv">50000</span>)
<span class="co">// java.lang.StackOverflowError</span>
<span class="co">//   ...</span></code></pre></div>
<p>We can rewrite the method using <code>Eval</code> to make it stack safe:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">factorial</span>(n: BigInt): Eval[BigInt] =
  <span class="kw">if</span>(n == <span class="dv">1</span>) {
    Eval.<span class="fu">now</span>(n)
  } <span class="kw">else</span> {
    <span class="fu">factorial</span>(n - <span class="dv">1</span>).<span class="fu">map</span>(_ * n)
  }

<span class="fu">factorial</span>(<span class="dv">50000</span>).<span class="fu">value</span>
<span class="co">// java.lang.StackOverflowError</span>
<span class="co">//   ...</span></code></pre></div>
<p>Oops! That didn’t work—our stack still blew up! This is because we’re still making all the recursive calls to <code>factorial</code> before we start working with <code>Eval's</code> <code>map</code> method. We can work around this using <code>Eval.defer</code>, which takes an existing instance of <code>Eval</code> and defers its evaluation. The <code>defer</code> method is trampolined like <code>map</code> and <code>flatMap</code>, so we can use it as a quick way to make an existing operation stack safe:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">factorial</span>(n: BigInt): Eval[BigInt] =
  <span class="kw">if</span>(n == <span class="dv">1</span>) {
    Eval.<span class="fu">now</span>(n)
  } <span class="kw">else</span> {
    Eval.<span class="fu">defer</span>(<span class="fu">factorial</span>(n - <span class="dv">1</span>).<span class="fu">map</span>(_ * n))
  }

<span class="fu">factorial</span>(<span class="dv">50000</span>).<span class="fu">value</span>
<span class="co">// res20: BigInt = 3347320509597144836915476094071486477912773223810454807730100321990168022144365641697381231071916930879848043819020829989361638474306669374263057284536378403832575628212335998726824407823597235604085385444137338375356856553637116832740516607615516592140615607546129420179056747966549862924222002254155351071815980161547645181061667497021799653747497254113933819163882350063030764425687485727139465108190987490964348626858922980787003103100896286115455397991161294065232739697149721103126114286073379350968783735581183060955172890660383359253285163596173088527981195739949529945030635444247849264102899006955963488352990055767655092917547592078804480762256241516513045904631806851740676636001232955645406572422517547342818312102919571559378742364111719451383859303800641313297631250...</span></code></pre></div>
<p><code>Eval</code> is a useful tool to enforce stack safety when working on very large computations and data structures. However, we must bear in mind that trampolining is not free. It avoids consuming stack by creating a chain of function objects on the heap. There are still limits on how deeply we can nest computations, but they are bounded by the size of the heap rather than the stack.</p>
<h3 id="exercise-safer-folding-using-eval"><span class="header-section-number">4.6.5</span> Exercise: Safer Folding using Eval</h3>
<p>The naive implementation of <code>foldRight</code> below is not stack safe. Make it so using <code>Eval</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> foldRight[A, B](as: List[A], acc: B)(fn: (A, B) =&gt; B): B =
  as <span class="kw">match</span> {
    <span class="kw">case</span> head :: tail =&gt;
      <span class="fu">fn</span>(head, <span class="fu">foldRight</span>(tail, acc)(fn))
    <span class="kw">case</span> Nil =&gt;
      acc
  }</code></pre></div>
<div class="solution">
<p>The easiest way to fix this is to introduce a helper method called <code>foldRightEval</code>. This is essentially our original method with every occurrence of <code>B</code> replaced with <code>Eval[B]</code>, and a call to <code>Eval.defer</code> to protect the recursive call:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Eval</span>

<span class="kw">def</span> foldRightEval[A, B](as: List[A], acc: Eval[B])
    (fn: (A, Eval[B]) =&gt; Eval[B]): Eval[B] =
  as <span class="kw">match</span> {
    <span class="kw">case</span> head :: tail =&gt;
      Eval.<span class="fu">defer</span>(<span class="fu">fn</span>(head, <span class="fu">foldRightEval</span>(tail, acc)(fn)))
    <span class="kw">case</span> Nil =&gt;
      acc
  }</code></pre></div>
<p>We can redefine <code>foldRight</code> simply in terms of <code>foldRightEval</code> and the resulting method is stack safe:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> foldRight[A, B](as: List[A], acc: B)(fn: (A, B) =&gt; B): B =
  <span class="fu">foldRightEval</span>(as, Eval.<span class="fu">now</span>(acc)) { (a, b) =&gt;
    b.<span class="fu">map</span>(<span class="fu">fn</span>(a, _))
  }.<span class="fu">value</span>

<span class="fu">foldRight</span>((<span class="dv">1</span> to <span class="dv">100000</span>).<span class="fu">toList</span>, 0L)(_ + _)
<span class="co">// res22: Long = 5000050000</span></code></pre></div>
</div>
<h2 id="writer-monad"><span class="header-section-number">4.7</span> The Writer Monad</h2>
<p><a href="http://typelevel.org/cats/api/cats/data/#Writer%5BS,A%5D=cats.data.WriterT%5Bcats.Eval,S,A%5D"><code>cats.data.Writer</code></a> is a monad that lets us carry a log along with a computation. We can use it to record messages, errors, or additional data about a computation, and extract the log alongside the final result.</p>
<p>One common use for <code>Writers</code> is recording sequences of steps in multi-threaded computations where standard imperative logging techniques can result in interleaved messages from different contexts. With <code>Writer</code> the log for the computation is tied to the result, so we can run concurrent computations without mixing logs.</p>
<div class="callout callout-info">
<p><em>Cats Data Types</em></p>
<p><code>Writer</code> is the first data type we’ve seen from the <a href="http://typelevel.org/cats/api/cats/data/"><code>cats.data</code></a> package. This package provides instances of various type classes that produce useful semantics. Other examples from <code>cats.data</code> include the monad transformers that we will see in the next chapter, and the <a href="http://typelevel.org/cats/api/cats/data/Validated.html"><code>Validated</code></a> type we will encounter in Chapter 6.</p>
</div>
<h3 id="creating-and-unpacking-writers"><span class="header-section-number">4.7.1</span> Creating and Unpacking Writers</h3>
<p>A <code>Writer[W, A]</code> carries two values: a <em>log</em> of type <code>W</code> and a <em>result</em> of type <code>A</code>. We can create a <code>Writer</code> from values of each type as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Writer</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Monoid</span>

Writer(Vector(
  <span class="st">&quot;It was the best of times&quot;</span>,
  <span class="st">&quot;it was the worst of times&quot;</span>
), <span class="dv">1859</span>)
<span class="co">// res0: cats.data.WriterT[cats.Id,scala.collection.immutable.Vector[String],Int] = WriterT((Vector(It was the best of times, it was the worst of times),1859))</span></code></pre></div>
<p>Notice that the type reported on the console is actually <code>WriterT[Id, Vector[String], Int]</code> instead of <code>Writer[Vector[String], Int]</code> as we might expect. In the spirit of code reuse, Cats implements <code>Writer</code> in terms of another type, <code>WriterT</code>. <code>WriterT</code> is an example of a new concept called a <em>monad transformer</em>, which we will cover in the next chapter.</p>
<p>Let’s try to ignore this detail for now. <code>Writer</code> is a type alias for <code>WriterT</code>, so we can read types like <code>WriterT[Id, W, A]</code> as <code>Writer[W, A]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Writer[W, A] = WriterT[Id, W, A]</code></pre></div>
<p>For convenience, Cats provides a way of creating <code>Writers</code> specifying only the log or the result. If we only have a result we can use the standard <code>pure</code> syntax. To do this we must have a <code>Monoid[W]</code> in scope so Cats knows how to produce an empty log:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._   <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

<span class="kw">type</span> Logged[A] = Writer[Vector[String], A]

<span class="fl">123.</span>pure[Logged]
<span class="co">// res2: Logged[Int] = WriterT((Vector(),123))</span></code></pre></div>
<p>If we have a log and no result we can create a <code>Writer[Unit]</code> using the <code>tell</code> syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$writer$"><code>cats.syntax.writer</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">writer</span>._ <span class="co">// for tell</span>

Vector(<span class="st">&quot;msg1&quot;</span>, <span class="st">&quot;msg2&quot;</span>, <span class="st">&quot;msg3&quot;</span>).<span class="fu">tell</span>
<span class="co">// res3: cats.data.Writer[scala.collection.immutable.Vector[String],Unit] = WriterT((Vector(msg1, msg2, msg3),()))</span></code></pre></div>
<p>If we have both a result and a log, we can either use <code>Writer.apply</code> or we can use the <code>writer</code> syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$writer$"><code>cats.syntax.writer</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">writer</span>._ <span class="co">// for writer</span>

<span class="kw">val</span> a = Writer(Vector(<span class="st">&quot;msg1&quot;</span>, <span class="st">&quot;msg2&quot;</span>, <span class="st">&quot;msg3&quot;</span>), <span class="dv">123</span>)
<span class="co">// a: cats.data.WriterT[cats.Id,scala.collection.immutable.Vector[String],Int] = WriterT((Vector(msg1, msg2, msg3),123))</span>

<span class="kw">val</span> b = <span class="fl">123.</span><span class="fu">writer</span>(Vector(<span class="st">&quot;msg1&quot;</span>, <span class="st">&quot;msg2&quot;</span>, <span class="st">&quot;msg3&quot;</span>))
<span class="co">// b: cats.data.Writer[scala.collection.immutable.Vector[String],Int] = WriterT((Vector(msg1, msg2, msg3),123))</span></code></pre></div>
<p>We can extract the result and log from a <code>Writer</code> using the <code>value</code> and <code>written</code> methods respectively:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> aResult: Int =
  a.<span class="fu">value</span>
<span class="co">// aResult: Int = 123</span>

<span class="kw">val</span> aLog: Vector[String] =
  a.<span class="fu">written</span>
<span class="co">// aLog: Vector[String] = Vector(msg1, msg2, msg3)</span></code></pre></div>
<p>We can extract both values at the same time using the <code>run</code> method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> (log, result) = b.<span class="fu">run</span>
<span class="co">// log: scala.collection.immutable.Vector[String] = Vector(msg1, msg2, msg3)</span>
<span class="co">// result: Int = 123</span></code></pre></div>
<h3 id="composing-and-transforming-writers"><span class="header-section-number">4.7.2</span> Composing and Transforming Writers</h3>
<p>The log in a <code>Writer</code> is preserved when we <code>map</code> or <code>flatMap</code> over it. <code>flatMap</code> appends the logs from the source <code>Writer</code> and the result of the user’s sequencing function. For this reason it’s good practice to use a log type that has an efficient append and concatenate operations, such as a <code>Vector</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> writer1 = <span class="kw">for</span> {
  a &lt;- <span class="fl">10.</span>pure[Logged]
  _ &lt;- Vector(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>).<span class="fu">tell</span>
  b &lt;- <span class="fl">32.</span><span class="fu">writer</span>(Vector(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;z&quot;</span>))
} <span class="kw">yield</span> a + b
<span class="co">// writer1: cats.data.WriterT[cats.Id,Vector[String],Int] = WriterT((Vector(a, b, c, x, y, z),42))</span>

writer1.<span class="fu">run</span>
<span class="co">// res4: cats.Id[(Vector[String], Int)] = (Vector(a, b, c, x, y, z),42)</span></code></pre></div>
<p>In addition to transforming the result with <code>map</code> and <code>flatMap</code>, we can transform the log in a <code>Writer</code> with the <code>mapWritten</code> method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> writer2 = writer1.<span class="fu">mapWritten</span>(_.<span class="fu">map</span>(_.<span class="fu">toUpperCase</span>))
<span class="co">// writer2: cats.data.WriterT[cats.Id,scala.collection.immutable.Vector[String],Int] = WriterT((Vector(A, B, C, X, Y, Z),42))</span>

writer2.<span class="fu">run</span>
<span class="co">// res5: cats.Id[(scala.collection.immutable.Vector[String], Int)] = (Vector(A, B, C, X, Y, Z),42)</span></code></pre></div>
<p>We can transform both log and result simultaneously using <code>bimap</code> or <code>mapBoth</code>. <code>bimap</code> takes two function parameters, one for the log and one for the result. <code>mapBoth</code> takes a single function that accepts two parameters:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> writer3 = writer1.<span class="fu">bimap</span>(
  log =&gt; log.<span class="fu">map</span>(_.<span class="fu">toUpperCase</span>),
  res =&gt; res * <span class="dv">100</span>
)
<span class="co">// writer3: cats.data.WriterT[cats.Id,scala.collection.immutable.Vector[String],Int] = WriterT((Vector(A, B, C, X, Y, Z),4200))</span>

writer3.<span class="fu">run</span>
<span class="co">// res6: cats.Id[(scala.collection.immutable.Vector[String], Int)] = (Vector(A, B, C, X, Y, Z),4200)</span>

<span class="kw">val</span> writer4 = writer1.<span class="fu">mapBoth</span> { (log, res) =&gt;
  <span class="kw">val</span> log2 = log.<span class="fu">map</span>(_ + <span class="st">&quot;!&quot;</span>)
  <span class="kw">val</span> res2 = res * <span class="dv">1000</span>
  (log2, res2)
}
<span class="co">// writer4: cats.data.WriterT[cats.Id,scala.collection.immutable.Vector[String],Int] = WriterT((Vector(a!, b!, c!, x!, y!, z!),42000))</span>

writer4.<span class="fu">run</span>
<span class="co">// res7: cats.Id[(scala.collection.immutable.Vector[String], Int)] = (Vector(a!, b!, c!, x!, y!, z!),42000)</span></code></pre></div>
<p>Finally, we can clear the log with the <code>reset</code> method and swap log and result with the <code>swap</code> method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> writer5 = writer1.<span class="fu">reset</span>
<span class="co">// writer5: cats.data.WriterT[cats.Id,Vector[String],Int] = WriterT((Vector(),42))</span>

writer5.<span class="fu">run</span>
<span class="co">// res8: cats.Id[(Vector[String], Int)] = (Vector(),42)</span>

<span class="kw">val</span> writer6 = writer1.<span class="fu">swap</span>
<span class="co">// writer6: cats.data.WriterT[cats.Id,Int,Vector[String]] = WriterT((42,Vector(a, b, c, x, y, z)))</span>

writer6.<span class="fu">run</span>
<span class="co">// res9: cats.Id[(Int, Vector[String])] = (42,Vector(a, b, c, x, y, z))</span></code></pre></div>
<h3 id="exercise-show-your-working"><span class="header-section-number">4.7.3</span> Exercise: Show Your Working</h3>
<p><code>Writers</code> are useful for logging operations in multi-threaded environments. Let’s confirm this by computing (and logging) some factorials.</p>
<p>The <code>factorial</code> function below computes a factorial and prints out the intermediate steps as it runs. The <code>slowly</code> helper function ensures this takes a while to run, even on the very small examples below:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> slowly[A](body: =&gt; A) =
  <span class="kw">try</span> body <span class="kw">finally</span> Thread.<span class="fu">sleep</span>(<span class="dv">100</span>)

<span class="kw">def</span> <span class="fu">factorial</span>(n: Int): Int = {
  <span class="kw">val</span> ans = <span class="fu">slowly</span>(<span class="kw">if</span>(n == <span class="dv">0</span>) <span class="dv">1</span> <span class="kw">else</span> n * <span class="fu">factorial</span>(n - <span class="dv">1</span>))
  <span class="fu">println</span>(s<span class="st">&quot;fact $n $ans&quot;</span>)
  ans
}</code></pre></div>
<p>Here’s the output—a sequence of monotonically increasing values:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">factorial</span>(<span class="dv">5</span>)
<span class="co">// fact 0 1</span>
<span class="co">// fact 1 1</span>
<span class="co">// fact 2 2</span>
<span class="co">// fact 3 6</span>
<span class="co">// fact 4 24</span>
<span class="co">// fact 5 120</span>
<span class="co">// res11: Int = 120</span></code></pre></div>
<p>If we start several factorials in parallel, the log messages can become interleaved on standard out. This makes it difficult to see which messages come from which computation:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

Await.<span class="fu">result</span>(Future.<span class="fu">sequence</span>(Vector(
  Future(<span class="fu">factorial</span>(<span class="dv">3</span>)),
  Future(<span class="fu">factorial</span>(<span class="dv">3</span>))
)), <span class="fl">5.</span>seconds)
<span class="co">// fact 0 1</span>
<span class="co">// fact 0 1</span>
<span class="co">// fact 1 1</span>
<span class="co">// fact 1 1</span>
<span class="co">// fact 2 2</span>
<span class="co">// fact 2 2</span>
<span class="co">// fact 3 6</span>
<span class="co">// fact 3 6</span>
<span class="co">// res14: scala.collection.immutable.Vector[Int] =</span>
<span class="co">//   Vector(120, 120)</span></code></pre></div>
<!--
HACK: tut isn't capturing stdout from the threads above,
so i gone done hacked it.
-->
<p>Rewrite <code>factorial</code> so it captures the log messages in a <code>Writer</code>. Demonstrate that this allows us to reliably separate the logs for concurrent computations.</p>
<div class="solution">
<p>We’ll start by defining a type alias for <code>Writer</code> so we can use it with <code>pure</code> syntax:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Writer</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

<span class="kw">type</span> Logged[A] = Writer[Vector[String], A]

<span class="fl">42.</span>pure[Logged]
<span class="co">// res13: Logged[Int] = WriterT((Vector(),42))</span></code></pre></div>
<p>We’ll import the <code>tell</code> syntax as well:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">writer</span>._ <span class="co">// for tell</span>

Vector(<span class="st">&quot;Message&quot;</span>).<span class="fu">tell</span>
<span class="co">// res14: cats.data.Writer[scala.collection.immutable.Vector[String],Unit] = WriterT((Vector(Message),()))</span></code></pre></div>
<p>Finally, we’ll import the <code>Semigroup</code> instance for <code>Vector</code>. We need this to <code>map</code> and <code>flatMap</code> over <code>Logged</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Monoid</span>

<span class="fl">41.</span>pure[Logged].<span class="fu">map</span>(_ + <span class="dv">1</span>)
<span class="co">// res15: cats.data.WriterT[cats.Id,Vector[String],Int] = WriterT((Vector(),42))</span></code></pre></div>
<p>With these in scope, the definition of <code>factorial</code> becomes:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">factorial</span>(n: Int): Logged[Int] =
  <span class="kw">for</span> {
    ans &lt;- <span class="kw">if</span>(n == <span class="dv">0</span>) {
             <span class="fl">1.</span>pure[Logged]
           } <span class="kw">else</span> {
             <span class="fu">slowly</span>(<span class="fu">factorial</span>(n - <span class="dv">1</span>).<span class="fu">map</span>(_ * n))
           }
    _   &lt;- Vector(s<span class="st">&quot;fact $n $ans&quot;</span>).<span class="fu">tell</span>
  } <span class="kw">yield</span> ans</code></pre></div>
<p>When we call <code>factorial</code>, we now have to <code>run</code> the return value to extract the log and our factorial:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> (log, res) = <span class="fu">factorial</span>(<span class="dv">5</span>).<span class="fu">run</span>
<span class="co">// log: Vector[String] = Vector(fact 0 1, fact 1 1, fact 2 2, fact 3 6, fact 4 24, fact 5 120)</span>
<span class="co">// res: Int = 120</span></code></pre></div>
<p>We can run several <code>factorials</code> in parallel as follows, capturing their logs independently without fear of interleaving:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> Vector((logA, ansA), (logB, ansB)) =
  Await.<span class="fu">result</span>(Future.<span class="fu">sequence</span>(Vector(
    Future(<span class="fu">factorial</span>(<span class="dv">3</span>).<span class="fu">run</span>),
    Future(<span class="fu">factorial</span>(<span class="dv">5</span>).<span class="fu">run</span>)
  )), <span class="fl">5.</span>seconds)
<span class="co">// logA: Vector[String] = Vector(fact 0 1, fact 1 1, fact 2 2, fact 3 6)</span>
<span class="co">// ansA: Int = 6</span>
<span class="co">// logB: Vector[String] = Vector(fact 0 1, fact 1 1, fact 2 2, fact 3 6, fact 4 24, fact 5 120)</span>
<span class="co">// ansB: Int = 120</span></code></pre></div>
</div>
<h2 id="sec:monads:reader"><span class="header-section-number">4.8</span> The Reader Monad</h2>
<p><a href="http://typelevel.org/cats/api/cats/data/?search=reader#Reader%5BA,B%5D=cats.data.package.ReaderT%5Bcats.Id,A,B%5D"><code>cats.data.Reader</code></a> is a monad that allows us to sequence operations that depend on some input. Instances of <code>Reader</code> wrap up functions of one argument, providing us with useful methods for composing them.</p>
<p>One common use for <code>Readers</code> is dependency injection. If we have a number of operations that all depend on some external configuration, we can chain them together using a <code>Reader</code> to produce one large operation that accepts the configuration as a parameter and runs our program in the order specified.</p>
<h3 id="creating-and-unpacking-readers"><span class="header-section-number">4.8.1</span> Creating and Unpacking Readers</h3>
<p>We can create a <code>Reader[A, B]</code> from a function <code>A =&gt; B</code> using the <code>Reader.apply</code> constructor:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Reader</span>

<span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, favoriteFood: String)
<span class="co">// defined class Cat</span>

<span class="kw">val</span> catName: Reader[Cat, String] =
  Reader(cat =&gt; cat.<span class="fu">name</span>)
<span class="co">// catName: cats.data.Reader[Cat,String] = Kleisli(&lt;function1&gt;)</span></code></pre></div>
<p>We can extract the function again using the <code>Reader's</code> <code>run</code> method and call it using <code>apply</code> as usual:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">catName.<span class="fu">run</span>(<span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>, <span class="st">&quot;lasagne&quot;</span>))
<span class="co">// res0: cats.Id[String] = Garfield</span></code></pre></div>
<p>So far so simple, but what advantage do <code>Readers</code> give us over the raw functions?</p>
<h3 id="composing-readers"><span class="header-section-number">4.8.2</span> Composing Readers</h3>
<p>The power of <code>Readers</code> comes from their <code>map</code> and <code>flatMap</code> methods, which represent different kinds of function composition. We typically create a set of <code>Readers</code> that accept the same type of configuration, combine them with <code>map</code> and <code>flatMap</code>, and then call <code>run</code> to inject the config at the end.</p>
<p>The <code>map</code> method simply extends the computation in the <code>Reader</code> by passing its result through a function:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> greetKitty: Reader[Cat, String] =
  catName.<span class="fu">map</span>(name =&gt; s<span class="st">&quot;Hello ${name}&quot;</span>)

greetKitty.<span class="fu">run</span>(<span class="fu">Cat</span>(<span class="st">&quot;Heathcliff&quot;</span>, <span class="st">&quot;junk food&quot;</span>))
<span class="co">// res1: cats.Id[String] = Hello Heathcliff</span></code></pre></div>
<p>The <code>flatMap</code> method is more interesting. It allows us to combine readers that depend on the same input type. To illustrate this, let’s extend our greeting example to also feed the cat:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> feedKitty: Reader[Cat, String] =
  Reader(cat =&gt; s<span class="st">&quot;Have a nice bowl of ${cat.favoriteFood}&quot;</span>)

<span class="kw">val</span> greetAndFeed: Reader[Cat, String] =
  <span class="kw">for</span> {
    greet &lt;- greetKitty
    feed  &lt;- feedKitty
  } <span class="kw">yield</span> s<span class="st">&quot;$greet. $feed.&quot;</span>

<span class="fu">greetAndFeed</span>(<span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>, <span class="st">&quot;lasagne&quot;</span>))
<span class="co">// res3: cats.Id[String] = Hello Garfield. Have a nice bowl of lasagne.</span>

<span class="fu">greetAndFeed</span>(<span class="fu">Cat</span>(<span class="st">&quot;Heathcliff&quot;</span>, <span class="st">&quot;junk food&quot;</span>))
<span class="co">// res4: cats.Id[String] = Hello Heathcliff. Have a nice bowl of junk food.</span></code></pre></div>
<h3 id="exercise-hacking-on-readers"><span class="header-section-number">4.8.3</span> Exercise: Hacking on Readers</h3>
<p>The classic use of <code>Readers</code> is to build programs that accept a configuration as a parameter. Let’s ground this with a complete example of a simple login system. Our configuration will consist of two databases: a list of valid users and a list of their passwords:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">Db</span>(
  usernames: Map[Int, String],
  passwords: Map[String, String]
)</code></pre></div>
<p>Start by creating a type alias <code>DbReader</code> for a <code>Reader</code> that consumes a <code>Db</code> as input. This will make the rest of our code shorter.</p>
<div class="solution">
<p>Our type alias fixes the <code>Db</code> type but leaves the result type flexible:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> DbReader[A] = Reader[Db, A]</code></pre></div>
</div>
<p>Now create methods that generate <code>DbReaders</code> to look up the username for an <code>Int</code> user ID, and look up the password for a <code>String</code> username. The type signatures should be as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">findUsername</span>(userId: Int): DbReader[Option[String]] =
  ???

<span class="kw">def</span> <span class="fu">checkPassword</span>(
      username: String,
      password: String): DbReader[Boolean] =
  ???</code></pre></div>
<div class="solution">
<p>Remember: the idea is to leave injecting the configuration until last. This means setting up functions that accept the config as a parameter and check it against the concrete user info we have been given:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">findUsername</span>(userId: Int): DbReader[Option[String]] =
  Reader(db =&gt; db.<span class="fu">usernames</span>.<span class="fu">get</span>(userId))

<span class="kw">def</span> <span class="fu">checkPassword</span>(
      username: String,
      password: String): DbReader[Boolean] =
  Reader(db =&gt; db.<span class="fu">passwords</span>.<span class="fu">get</span>(username).<span class="fu">contains</span>(password))</code></pre></div>
</div>
<p>Finally create a <code>checkLogin</code> method to check the password for a given user ID. The type signature should be as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">checkLogin</span>(
      userId: Int,
      password: String): DbReader[Boolean] =
  ???</code></pre></div>
<div class="solution">
<p>As you might expect, here we use <code>flatMap</code> to chain <code>findUsername</code> and <code>checkPassword</code>. We use <code>pure</code> to lift a <code>Boolean</code> to a <code>DbReader[Boolean]</code> when the username is not found:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

<span class="kw">def</span> <span class="fu">checkLogin</span>(
      userId: Int,
      password: String): DbReader[Boolean] =
  <span class="kw">for</span> {
    username   &lt;- <span class="fu">findUsername</span>(userId)
    passwordOk &lt;- username.<span class="fu">map</span> { username =&gt;
                    <span class="fu">checkPassword</span>(username, password)
                  }.<span class="fu">getOrElse</span> {
                    <span class="kw">false</span>.<span class="fu">pure</span>[DbReader]
                  }
  } <span class="kw">yield</span> passwordOk</code></pre></div>
</div>
<p>You should be able to use <code>checkLogin</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> users = Map(
  <span class="dv">1</span> -&gt; <span class="st">&quot;dade&quot;</span>,
  <span class="dv">2</span> -&gt; <span class="st">&quot;kate&quot;</span>,
  <span class="dv">3</span> -&gt; <span class="st">&quot;margo&quot;</span>
)

<span class="kw">val</span> passwords = Map(
  <span class="st">&quot;dade&quot;</span>  -&gt; <span class="st">&quot;zerocool&quot;</span>,
  <span class="st">&quot;kate&quot;</span>  -&gt; <span class="st">&quot;acidburn&quot;</span>,
  <span class="st">&quot;margo&quot;</span> -&gt; <span class="st">&quot;secret&quot;</span>
)

<span class="kw">val</span> db = <span class="fu">Db</span>(users, passwords)

<span class="fu">checkLogin</span>(<span class="dv">1</span>, <span class="st">&quot;zerocool&quot;</span>).<span class="fu">run</span>(db)
<span class="co">// res10: cats.Id[Boolean] = true</span>

<span class="fu">checkLogin</span>(<span class="dv">4</span>, <span class="st">&quot;davinci&quot;</span>).<span class="fu">run</span>(db)
<span class="co">// res11: cats.Id[Boolean] = false</span></code></pre></div>
<h3 id="when-to-use-readers"><span class="header-section-number">4.8.4</span> When to Use Readers?</h3>
<p><code>Readers</code> provide a tool for doing dependency injection. We write steps of our program as instances of <code>Reader</code>, chain them together with <code>map</code> and <code>flatMap</code>, and build a function that accepts the dependency as input.</p>
<p>There are many ways of implementing dependency injection in Scala, from simple techniques like methods with multiple parameter lists, through implicit parameters and type classes, to complex techniques like the cake pattern and DI frameworks.</p>
<p><code>Readers</code> are most useful in situations where:</p>
<ul>
<li><p>we are constructing a batch program that can easily be represented by a function;</p></li>
<li><p>we need to defer injection of a known parameter or set of parameters;</p></li>
<li><p>we want to be able to test parts of the program in isolation.</p></li>
</ul>
<p>By representing the steps of our program as <code>Readers</code> we can test them as easily as pure functions, plus we gain access to the <code>map</code> and <code>flatMap</code> combinators.</p>
<p>For more advanced problems where we have lots of dependencies, or where a program isn’t easily represented as a pure function, other dependency injection techniques tend to be more appropriate.</p>
<div class="callout callout-warning">
<p><em>Kleisli Arrows</em></p>
<p>You may have noticed from console output that <code>Reader</code> is implemented in terms of another type called <code>Kleisli</code>. <em>Kleisli arrows</em> provide a more general form of <code>Reader</code> that generalise over the type constructor of the result type. We will encounter Kleislis again in Chapter 5.</p>
</div>
<h2 id="the-state-monad"><span class="header-section-number">4.9</span> The State Monad</h2>
<p><a href="http://typelevel.org/cats/api/cats/data/#State%5BS,A%5D=cats.data.StateT%5Bcats.Eval,S,A%5D"><code>cats.data.State</code></a> allows us to pass additional state around as part of a computation. We define <code>State</code> instances representing atomic state operations and thread them together using <code>map</code> and <code>flatMap</code>. In this way we can model mutable state in a purely functional way, without using mutation.</p>
<h3 id="creating-and-unpacking-state"><span class="header-section-number">4.9.1</span> Creating and Unpacking State</h3>
<p>Boiled down to their simplest form, instances of <code>State[S, A]</code> represent functions of type <code>S =&gt; (S, A)</code>. <code>S</code> is the type of the state and <code>A</code> is the type of the result.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">State</span>

<span class="kw">val</span> a = State[Int, String] { state =&gt;
  (state, s<span class="st">&quot;The state is $state&quot;</span>)
}
<span class="co">// a: cats.data.State[Int,String] = cats.data.IndexedStateT@7896f9ef</span></code></pre></div>
<p>In other words, an instance of <code>State</code> is a function that does two things:</p>
<ul>
<li>transforms an input state to an output state;</li>
<li>computes a result.</li>
</ul>
<p>We can “run” our monad by supplying an initial state. <code>State</code> provides three methods—<code>run</code>, <code>runS</code>, and <code>runA</code>—that return different combinations of state and result. Each method returns an instance of <code>Eval</code>, which <code>State</code> uses to maintain stack safety. We call the <code>value</code> method as usual to extract the actual result:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Get the state and the result:</span>
<span class="kw">val</span> (state, result) = a.<span class="fu">run</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// state: Int = 10</span>
<span class="co">// result: String = The state is 10</span>

<span class="co">// Get the state, ignore the result:</span>
<span class="kw">val</span> state = a.<span class="fu">runS</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// state: Int = 10</span>

<span class="co">// Get the result, ignore the state:</span>
<span class="kw">val</span> result = a.<span class="fu">runA</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// result: String = The state is 10</span></code></pre></div>
<h3 id="composing-and-transforming-state"><span class="header-section-number">4.9.2</span> Composing and Transforming State</h3>
<p>As we’ve seen with <code>Reader</code> and <code>Writer</code>, the power of the <code>State</code> monad comes from combining instances. The <code>map</code> and <code>flatMap</code> methods thread the state from one instance to another. Each individual instance represents an atomic state transformation, and their combination represents a complete sequence of changes:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> step1 = State[Int, String] { num =&gt;
  <span class="kw">val</span> ans = num + <span class="dv">1</span>
  (ans, s<span class="st">&quot;Result of step1: $ans&quot;</span>)
}
<span class="co">// step1: cats.data.State[Int,String] = cats.data.IndexedStateT@7d7814e4</span>

<span class="kw">val</span> step2 = State[Int, String] { num =&gt;
  <span class="kw">val</span> ans = num * <span class="dv">2</span>
  (ans, s<span class="st">&quot;Result of step2: $ans&quot;</span>)
}
<span class="co">// step2: cats.data.State[Int,String] = cats.data.IndexedStateT@5d0e768f</span>

<span class="kw">val</span> both = <span class="kw">for</span> {
  a &lt;- step1
  b &lt;- step2
} <span class="kw">yield</span> (a, b)
<span class="co">// both: cats.data.IndexedStateT[cats.Eval,Int,Int,(String, String)] = cats.data.IndexedStateT@7c65090d</span>

<span class="kw">val</span> (state, result) = both.<span class="fu">run</span>(<span class="dv">20</span>).<span class="fu">value</span>
<span class="co">// state: Int = 42</span>
<span class="co">// result: (String, String) = (Result of step1: 21,Result of step2: 42)</span></code></pre></div>
<p>As you can see, in this example the final state is the result of applying both transformations in sequence. State is threaded from step to step even though we don’t interact with it in the for comprehension.</p>
<p>The general model for using the <code>State</code> monad is to represent each step of a computation as an instance and compose the steps using the standard monad operators. Cats provides several convenience constructors for creating primitive steps:</p>
<ul>
<li><code>get</code> extracts the state as the result;</li>
<li><code>set</code> updates the state and returns unit as the result;</li>
<li><code>pure</code> ignores the state and returns a supplied result;</li>
<li><code>inspect</code> extracts the state via a transformation function;</li>
<li><code>modify</code> updates the state using an update function.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> getDemo = State.<span class="fu">get</span>[Int]
<span class="co">// getDemo: cats.data.State[Int,Int] = cats.data.IndexedStateT@690815af</span>

getDemo.<span class="fu">run</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// res3: (Int, Int) = (10,10)</span>

<span class="kw">val</span> setDemo = State.<span class="fu">set</span>[Int](<span class="dv">30</span>)
<span class="co">// setDemo: cats.data.State[Int,Unit] = cats.data.IndexedStateT@378b9168</span>

setDemo.<span class="fu">run</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// res4: (Int, Unit) = (30,())</span>

<span class="kw">val</span> pureDemo = State.<span class="fu">pure</span>[Int, String](<span class="st">&quot;Result&quot;</span>)
<span class="co">// pureDemo: cats.data.State[Int,String] = cats.data.IndexedStateT@1efc17d</span>

pureDemo.<span class="fu">run</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// res5: (Int, String) = (10,Result)</span>

<span class="kw">val</span> inspectDemo = State.<span class="fu">inspect</span>[Int, String](_ + <span class="st">&quot;!&quot;</span>)
<span class="co">// inspectDemo: cats.data.State[Int,String] = cats.data.IndexedStateT@656471f8</span>

inspectDemo.<span class="fu">run</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// res6: (Int, String) = (10,10!)</span>

<span class="kw">val</span> modifyDemo = State.<span class="fu">modify</span>[Int](_ + <span class="dv">1</span>)
<span class="co">// modifyDemo: cats.data.State[Int,Unit] = cats.data.IndexedStateT@1fea3bf9</span>

modifyDemo.<span class="fu">run</span>(<span class="dv">10</span>).<span class="fu">value</span>
<span class="co">// res7: (Int, Unit) = (11,())</span></code></pre></div>
<p>We can assemble these building blocks using a for comprehension. We typically ignore the result of intermediate stages that only represent transformations on the state:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> State._

<span class="kw">val</span> program: State[Int, (Int, Int, Int)] = <span class="kw">for</span> {
  a &lt;- get[Int]
  _ &lt;- set[Int](a + <span class="dv">1</span>)
  b &lt;- get[Int]
  _ &lt;- modify[Int](_ + <span class="dv">1</span>)
  c &lt;- inspect[Int, Int](_ * <span class="dv">1000</span>)
} <span class="kw">yield</span> (a, b, c)
<span class="co">// program: cats.data.State[Int,(Int, Int, Int)] = cats.data.IndexedStateT@a56267d</span>

<span class="kw">val</span> (state, result) = program.<span class="fu">run</span>(<span class="dv">1</span>).<span class="fu">value</span>
<span class="co">// state: Int = 3</span>
<span class="co">// result: (Int, Int, Int) = (1,2,3000)</span></code></pre></div>
<h3 id="exercise-post-order-calculator"><span class="header-section-number">4.9.3</span> Exercise: Post-Order Calculator</h3>
<p>The <code>State</code> monad allows us to implement simple interpreters for complex expressions, passing the values of mutable registers along with the result. We can see a simple example of this by implementing a calculator for post-order integer arithmetic expressions.</p>
<p>In case you haven’t heard of post-order expressions before (don’t worry if you haven’t), they are a mathematical notation where we write the operator <em>after</em> its operands. So, for example, instead of writing <code>1 + 2</code> we would write:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">1</span> <span class="dv">2</span> +</code></pre></div>
<p>Although post-order expressions are difficult for humans to read, they are easy to evaluate in code. All we need to do is traverse the symbols from left to right, carrying a <em>stack</em> of operands with us as we go:</p>
<ul>
<li><p>when we see a number, we push it onto the stack;</p></li>
<li><p>when we see an operator, we pop two operands off the stack, operate on them, and push the result in their place.</p></li>
</ul>
<p>This allows us to evaluate complex expressions without using parentheses. For example, we can evaluate <code>(1 + 2) * 3)</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">1</span> <span class="dv">2</span> + <span class="dv">3</span> * <span class="co">// see 1, push onto stack</span>
<span class="dv">2</span> + <span class="dv">3</span> *   <span class="co">// see 2, push onto stack</span>
+ <span class="dv">3</span> *     <span class="co">// see +, pop 1 and 2 off of stack,</span>
          <span class="co">//        push (1 + 2) = 3 in their place</span>
<span class="dv">3</span> <span class="dv">3</span> *     <span class="co">// see 3, push onto stack</span>
<span class="dv">3</span> *       <span class="co">// see 3, push onto stack</span>
*         <span class="co">// see *, pop 3 and 3 off of stack,</span>
          <span class="co">//        push (3 * 3) = 9 in their place</span></code></pre></div>
<p>Let’s write an interpreter for these expressions. We can parse each symbol into a <code>State</code> instance representing a transformation on the stack and an intermediate result. The <code>State</code> instances can be threaded together using <code>flatMap</code> to produce an interpreter for any sequence of symbols.</p>
<p>Start by writing a function <code>evalOne</code> that parses a single symbol into an instance of <code>State</code>. Use the code below as a template. Don’t worry about error handling for now—if the stack is in the wrong configuration, it’s OK to throw an exception.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">State</span>

<span class="kw">type</span> CalcState[A] = State[List[Int], A]

<span class="kw">def</span> <span class="fu">evalOne</span>(sym: String): CalcState[Int] = ???</code></pre></div>
<p>If this seems difficult, think about the basic form of the <code>State</code> instances you’re returning. Each instance represents a functional transformation from a stack to a pair of a stack and a result. You can ignore any wider context and focus on just that one step:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">State[List[Int], Int] { oldStack =&gt;
  <span class="kw">val</span> newStack = <span class="fu">someTransformation</span>(oldStack)
  <span class="kw">val</span> result   = someCalculation
  (newStack, result)
}</code></pre></div>
<p>Feel free to write your <code>Stack</code> instances in this form or as sequences of the convenience constructors we saw above.</p>
<div class="solution">
<p>The stack operation required is different for operators and operands. For clarity we’ll implement <code>evalOne</code> in terms of two helper functions, one for each case:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">evalOne</span>(sym: String): CalcState[Int] =
  sym <span class="kw">match</span> {
    <span class="kw">case</span> <span class="st">&quot;+&quot;</span> =&gt; <span class="fu">operator</span>(_ + _)
    <span class="kw">case</span> <span class="st">&quot;-&quot;</span> =&gt; <span class="fu">operator</span>(_ - _)
    <span class="kw">case</span> <span class="st">&quot;*&quot;</span> =&gt; <span class="fu">operator</span>(_ * _)
    <span class="kw">case</span> <span class="st">&quot;/&quot;</span> =&gt; <span class="fu">operator</span>(_ / _)
    <span class="kw">case</span> num =&gt; <span class="fu">operand</span>(num.<span class="fu">toInt</span>)
  }</code></pre></div>
<p>Let’s look at <code>operand</code> first. All we have to do is push a number onto the stack. We also return the operand as an intermediate result:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">operand</span>(num: Int): CalcState[Int] =
  State[List[Int], Int] { stack =&gt;
    (num :: stack, num)
  }</code></pre></div>
<p>The <code>operator</code> function is a little more complex. We have to pop two operands off the stack (having the second operand at the top of the stack) and push the result in their place. The code can fail if the stack doesn’t have enough operands on it, but the exercise description allows us to throw an exception in this case:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">operator</span>(func: (Int, Int) =&gt; Int): CalcState[Int] =
  State[List[Int], Int] {
    <span class="kw">case</span> b :: a :: tail =&gt;
      <span class="kw">val</span> ans = <span class="fu">func</span>(a, b)
      (ans :: tail, ans)

    <span class="kw">case</span> _ =&gt;
      sys.<span class="fu">error</span>(<span class="st">&quot;Fail!&quot;</span>)
  }</code></pre></div>
</div>
<p><code>evalOne</code> allows us to evaluate single-symbol expressions as follows. We call <code>runA</code> supplying <code>Nil</code> as an initial stack, and call <code>value</code> to unpack the resulting <code>Eval</code> instance:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">evalOne</span>(<span class="st">&quot;42&quot;</span>).<span class="fu">runA</span>(Nil).<span class="fu">value</span>
<span class="co">// res3: Int = 42</span></code></pre></div>
<p>We can represent more complex programs using <code>evalOne</code>, <code>map</code>, and <code>flatMap</code>. Note that most of the work is happening on the stack, so we ignore the results of the intermediate steps for <code>evalOne(&quot;1&quot;)</code> and <code>evalOne(&quot;2&quot;)</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> program = <span class="kw">for</span> {
  _   &lt;- <span class="fu">evalOne</span>(<span class="st">&quot;1&quot;</span>)
  _   &lt;- <span class="fu">evalOne</span>(<span class="st">&quot;2&quot;</span>)
  ans &lt;- <span class="fu">evalOne</span>(<span class="st">&quot;+&quot;</span>)
} <span class="kw">yield</span> ans
<span class="co">// program: cats.data.IndexedStateT[cats.Eval,List[Int],List[Int],Int] = cats.data.IndexedStateT@d542b0a</span>

program.<span class="fu">runA</span>(Nil).<span class="fu">value</span>
<span class="co">// res4: Int = 3</span></code></pre></div>
<p>Generalise this example by writing an <code>evalAll</code> method that computes the result of a <code>List[String]</code>. Use <code>evalOne</code> to process each symbol, and thread the resulting <code>State</code> monads together using <code>flatMap</code>. Your function should have the following signature:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">evalAll</span>(input: List[String]): CalcState[Int] =
  ???</code></pre></div>
<div class="solution">
<p>We implement <code>evalAll</code> by folding over the input. We start with a pure <code>CalcState</code> that returns <code>0</code> if the list is empty. We <code>flatMap</code> at each stage, ignoring the intermediate results as we saw in the example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

<span class="kw">def</span> <span class="fu">evalAll</span>(input: List[String]): CalcState[Int] =
  input.<span class="fu">foldLeft</span>(<span class="fl">0.</span>pure[CalcState]) { (a, b) =&gt;
    a.<span class="fu">flatMap</span>(_ =&gt; <span class="fu">evalOne</span>(b))
  }</code></pre></div>
</div>
<p>We can use <code>evalAll</code> to conveniently evaluate multi-stage expressions:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> program = <span class="fu">evalAll</span>(List(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;+&quot;</span>, <span class="st">&quot;3&quot;</span>, <span class="st">&quot;*&quot;</span>))
<span class="co">// program: CalcState[Int] = cats.data.IndexedStateT@10efea1e</span>

program.<span class="fu">runA</span>(Nil).<span class="fu">value</span>
<span class="co">// res6: Int = 9</span></code></pre></div>
<p>Because <code>evalOne</code> and <code>evalAll</code> both return instances of <code>State</code>, we can thread these results together using <code>flatMap</code>. <code>evalOne</code> produces a simple stack transformation and <code>evalAll</code> produces a complex one, but they’re both pure functions and we can use them in any order as many times as we like:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> program = <span class="kw">for</span> {
  _   &lt;- <span class="fu">evalAll</span>(List(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;+&quot;</span>))
  _   &lt;- <span class="fu">evalAll</span>(List(<span class="st">&quot;3&quot;</span>, <span class="st">&quot;4&quot;</span>, <span class="st">&quot;+&quot;</span>))
  ans &lt;- <span class="fu">evalOne</span>(<span class="st">&quot;*&quot;</span>)
} <span class="kw">yield</span> ans
<span class="co">// program: cats.data.IndexedStateT[cats.Eval,List[Int],List[Int],Int] = cats.data.IndexedStateT@3fd7e1d9</span>

program.<span class="fu">runA</span>(Nil).<span class="fu">value</span>
<span class="co">// res7: Int = 21</span></code></pre></div>
<p>Complete the exercise by implementing an <code>evalInput</code> function that splits an input <code>String</code> into symbols, calls <code>evalAll</code>, and runs the result with an initial stack.</p>
<div class="solution">
<p>We’ve done all the hard work now. All we need to do is split the input into terms and call <code>runA</code> and <code>value</code> to unpack the result:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">evalInput</span>(input: String): Int =
  <span class="fu">evalAll</span>(input.<span class="fu">split</span>(<span class="st">&quot; &quot;</span>).<span class="fu">toList</span>).<span class="fu">runA</span>(Nil).<span class="fu">value</span>

<span class="fu">evalInput</span>(<span class="st">&quot;1 2 + 3 4 + *&quot;</span>)
<span class="co">// res8: Int = 21</span></code></pre></div>
</div>
<h2 id="defining-custom-monads"><span class="header-section-number">4.10</span> Defining Custom Monads</h2>
<p>We can define a <code>Monad</code> for a custom type by providing implementations of three methods: <code>flatMap</code>, <code>pure</code>, and a method we haven’t seen yet called <code>tailRecM</code>. Here is an implementation of <code>Monad</code> for <code>Option</code> as an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>
<span class="kw">import</span> scala.<span class="fu">annotation</span>.<span class="fu">tailrec</span>

<span class="kw">val</span> optionMonad = <span class="kw">new</span> Monad[Option] {
  <span class="kw">def</span> flatMap[A, B](opt: Option[A])
      (fn: A =&gt; Option[B]): Option[B] =
    opt flatMap fn

  <span class="kw">def</span> pure[A](opt: A): Option[A] =
    Some(opt)

  @tailrec
  <span class="kw">def</span> tailRecM[A, B](a: A)
      (fn: A =&gt; Option[Either[A, B]]): Option[B] =
    <span class="fu">fn</span>(a) <span class="kw">match</span> {
      <span class="kw">case</span> None           =&gt; None
      <span class="kw">case</span> Some(<span class="fu">Left</span>(a1)) =&gt; <span class="fu">tailRecM</span>(a1)(fn)
      <span class="kw">case</span> Some(<span class="fu">Right</span>(b)) =&gt; Some(b)
    }
}</code></pre></div>
<p>The <code>tailRecM</code> method is an optimisation used in Cats to limit the amount of stack space consumed by nested calls to <code>flatMap</code>. The technique comes from a <a href="http://functorial.com/stack-safety-for-free/index.pdf">2015 paper</a> by PureScript creator Phil Freeman. The method should recursively call itself until the result of <code>fn</code> returns a <code>Right</code>.</p>
<p>If we can make <code>tailRecM</code> tail-recursive, Cats is able to guarantee stack safety in recursive situations such as folding over large lists (see Section 7.1). If we can’t make <code>tailRecM</code> tail-recursive, Cats cannot make these guarantees and extreme use cases may result in <code>StackOverflowErrors</code>. All of the built-in monads in Cats have tail-recursive implementations of <code>tailRecM</code>, although writing one for custom monads can be a challenge… as we shall see.</p>
<h3 id="exercise-branching-out-further-with-monads"><span class="header-section-number">4.10.1</span> Exercise: Branching out Further with Monads</h3>
<p>Let’s write a <code>Monad</code> for our <code>Tree</code> data type from last chapter. Here’s the type again:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Tree[+A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Branch[A](left: Tree[A], right: Tree[A])
  <span class="kw">extends</span> Tree[A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Leaf[A](value: A) <span class="kw">extends</span> Tree[A]

<span class="kw">def</span> branch[A](left: Tree[A], right: Tree[A]): Tree[A] =
  <span class="fu">Branch</span>(left, right)

<span class="kw">def</span> leaf[A](value: A): Tree[A] =
  <span class="fu">Leaf</span>(value)</code></pre></div>
<p>Verify that the code works on instances of <code>Branch</code> and <code>Leaf</code>, and that the <code>Monad</code> provides <code>Functor</code>-like behaviour for free.</p>
<p>Also verify that having a <code>Monad</code> in scope allows us to use for comprehensions, despite the fact that we haven’t directly implemented <code>flatMap</code> or <code>map</code> on <code>Tree</code>.</p>
<p>Don’t feel you have to make <code>tailRecM</code> tail-recursive. Doing so is quite difficult. We’ve included both tail-recursive and non-tail-recursive implementations in the solutions so you can check your work.</p>
<div class="solution">
<p>The code for <code>flatMap</code> is similar to the code for <code>map</code>. Again, we recurse down the structure and use the results from <code>func</code> to build a new <code>Tree</code>.</p>
<p>The code for <code>tailRecM</code> is fairly complex regardless of whether we make it tail-recursive or not.</p>
<p>If we follow the types, the non-tail-recursive solution falls out:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>

<span class="kw">implicit</span> <span class="kw">val</span> treeMonad = <span class="kw">new</span> Monad[Tree] {
  <span class="kw">def</span> pure[A](value: A): Tree[A] =
    <span class="fu">Leaf</span>(value)

  <span class="kw">def</span> flatMap[A, B](tree: Tree[A])
      (func: A =&gt; Tree[B]): Tree[B] =
    tree <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Branch</span>(l, r) =&gt;
        <span class="fu">Branch</span>(<span class="fu">flatMap</span>(l)(func), <span class="fu">flatMap</span>(r)(func))
      <span class="kw">case</span> <span class="fu">Leaf</span>(value)  =&gt;
        <span class="fu">func</span>(value)
    }

 <span class="kw">def</span> tailRecM[A, B](a: A)
     (func: A =&gt; Tree[Either[A, B]]): Tree[B] =
   <span class="fu">flatMap</span>(<span class="fu">func</span>(a)) {
     <span class="kw">case</span> <span class="fu">Left</span>(value) =&gt;
       <span class="fu">tailRecM</span>(value)(func)
     <span class="kw">case</span> <span class="fu">Right</span>(value) =&gt;
       <span class="fu">Leaf</span>(value)
   }
}</code></pre></div>
<p>The solution above is perfectly fine for this exercise. Its only downside is that Cats cannot make guarantees about stack safety.</p>
<p>The tail-recursive solution is much harder to write. We adapted this solution from <a href="https://stackoverflow.com/questions/44504790/cats-non-tail-recursive-tailrecm-method-for-monads">this Stack Overflow post</a> by Nazarii Bardiuk. It involves an explicit depth first traversal of the tree, maintaining an <code>open</code> list of nodes to visit and a <code>closed</code> list of nodes to use to reconstruct the tree:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>

<span class="kw">implicit</span> <span class="kw">val</span> treeMonad = <span class="kw">new</span> Monad[Tree] {
  <span class="kw">def</span> pure[A](value: A): Tree[A] =
    <span class="fu">Leaf</span>(value)

  <span class="kw">def</span> flatMap[A, B](tree: Tree[A])
      (func: A =&gt; Tree[B]): Tree[B] =
    tree <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Branch</span>(l, r) =&gt;
        <span class="fu">Branch</span>(<span class="fu">flatMap</span>(l)(func), <span class="fu">flatMap</span>(r)(func))
      <span class="kw">case</span> <span class="fu">Leaf</span>(value)  =&gt;
        <span class="fu">func</span>(value)
    }

  <span class="kw">def</span> tailRecM[A, B](arg: A)
      (func: A =&gt; Tree[Either[A, B]]): Tree[B] = {
    @tailrec
    <span class="kw">def</span> <span class="fu">loop</span>(
          open: List[Tree[Either[A, B]]],
          closed: List[Option[Tree[B]]]): List[Tree[B]] =
      open <span class="kw">match</span> {
        <span class="kw">case</span> <span class="fu">Branch</span>(l, r) :: next =&gt;
          <span class="fu">loop</span>(l :: r :: next, None :: closed)

        <span class="kw">case</span> <span class="fu">Leaf</span>(<span class="fu">Left</span>(value)) :: next =&gt;
          <span class="fu">loop</span>(<span class="fu">func</span>(value) :: next, closed)

        <span class="kw">case</span> <span class="fu">Leaf</span>(<span class="fu">Right</span>(value)) :: next =&gt;
          <span class="fu">loop</span>(next, Some(<span class="fu">pure</span>(value)) :: closed)

        <span class="kw">case</span> Nil =&gt;
          closed.<span class="fu">foldLeft</span>(Nil: List[Tree[B]]) { (acc, maybeTree) =&gt;
            maybeTree.<span class="fu">map</span>(_ :: acc).<span class="fu">getOrElse</span> {
              <span class="kw">val</span> left :: right :: tail = acc
              <span class="fu">branch</span>(left, right) :: tail
            }
          }
      }

    <span class="fu">loop</span>(List(<span class="fu">func</span>(arg)), Nil).<span class="fu">head</span>
  }
}</code></pre></div>
<p>Regardless of which version of <code>tailRecM</code> we define, we can use our <code>Monad</code> to <code>flatMap</code> and <code>map</code> on <code>Trees</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._ <span class="co">// for map</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._ <span class="co">// for flatMap</span>

<span class="fu">branch</span>(<span class="fu">leaf</span>(<span class="dv">100</span>), <span class="fu">leaf</span>(<span class="dv">200</span>)).
  <span class="fu">flatMap</span>(x =&gt; <span class="fu">branch</span>(<span class="fu">leaf</span>(x - <span class="dv">1</span>), <span class="fu">leaf</span>(x + <span class="dv">1</span>)))
<span class="co">// res3: wrapper.Tree[Int] = Branch(Branch(Leaf(99),Leaf(101)),Branch(Leaf(199),Leaf(201)))</span></code></pre></div>
<p>We can also transform <code>Trees</code> using for comprehensions:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">for</span> {
  a &lt;- <span class="fu">branch</span>(<span class="fu">leaf</span>(<span class="dv">100</span>), <span class="fu">leaf</span>(<span class="dv">200</span>))
  b &lt;- <span class="fu">branch</span>(<span class="fu">leaf</span>(a - <span class="dv">10</span>), <span class="fu">leaf</span>(a + <span class="dv">10</span>))
  c &lt;- <span class="fu">branch</span>(<span class="fu">leaf</span>(b - <span class="dv">1</span>), <span class="fu">leaf</span>(b + <span class="dv">1</span>))
} <span class="kw">yield</span> c
<span class="co">// res4: wrapper.Tree[Int] = Branch(Branch(Branch(Leaf(89),Leaf(91)),Branch(Leaf(109),Leaf(111))),Branch(Branch(Leaf(189),Leaf(191)),Branch(Leaf(209),Leaf(211))))</span></code></pre></div>
<p>The monad for <code>Option</code> provides fail-fast semantics. The monad for <code>List</code> provides concatenation semantics. What are the semantics of <code>flatMap</code> for a binary tree? Every node in the tree has the potential to be replaced with a whole subtree, producing a kind of “growing” or “feathering” behaviour, reminiscent of list concatenation along two axes.</p>
</div>
<h2 id="summary-3"><span class="header-section-number">4.11</span> Summary</h2>
<p>In this chapter we’ve seen monads up-close. We saw that <code>flatMap</code> can be viewed as an operator for sequencing computations, dictating the order in which operations must happen. From this viewpoint, <code>Option</code> represents a computation that can fail without an error message, <code>Either</code> represents computations that can fail with a message, <code>List</code> represents multiple possible results, and <code>Future</code> represents a computation that may produce a value at some point in the future.</p>
<p>We’ve also seen some of the custom types and data structures that Cats provides, including <code>Id</code>, <code>Reader</code>, <code>Writer</code>, and <code>State</code>. These cover a wide range of use cases.</p>
<p>Finally, in the unlikely event that we have to implement a custom monad, we’ve learned about defining our own instance using <code>tailRecM</code>. <code>tailRecM</code> is an odd wrinkle that is a concession to building a functional programming library that is stack-safe by default. We don’t need to understand <code>tailRecM</code> to understand monads, but having it around gives us benefits of which we can be grateful when writing monadic code.</p>
<h1 id="sec:monad-transformers"><span class="header-section-number">5</span> Monad Transformers</h1>
<p>Monads are <a href="http://blog.plover.com/prog/burritos.html">like burritos</a>, which means that once you acquire a taste, you’ll find yourself returning to them again and again. This is not without issues. As burritos can bloat the waist, monads can bloat the code base through nested for-comprehensions.</p>
<p>Imagine we are interacting with a database. We want to look up a user record. The user may or may not be present, so we return an <code>Option[User]</code>. Our communication with the database could fail for many reasons (network issues, authentication problems, and so on), so this result is wrapped up in an <code>Either</code>, giving us a final result of <code>Either[Error, Option[User]]</code>.</p>
<p>To use this value we must nest <code>flatMap</code> calls (or equivalently, for-comprehensions):</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">lookupUserName</span>(id: Long): Either[Error, Option[String]] =
  <span class="kw">for</span> {
    optUser &lt;- <span class="fu">lookupUser</span>(id)
  } <span class="kw">yield</span> {
    <span class="kw">for</span> { user &lt;- optUser } <span class="kw">yield</span> user.<span class="fu">name</span>
  }</code></pre></div>
<p>This quickly becomes very tedious.</p>
<h2 id="exercise-composing-monads"><span class="header-section-number">5.1</span> Exercise: Composing Monads</h2>
<p>A question arises. Given two arbitrary monads, can we combine them in some way to make a single monad? That is, do monads <em>compose</em>? We can try to write the code but we soon hit problems:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._     <span class="co">// for flatMap</span>
<span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="co">// Hypothetical example. This won't actually compile:</span>
<span class="kw">def</span> compose[M1[_]: Monad, M2[_]: Monad] = {
  <span class="kw">type</span> Composed[A] = M1[M2[A]]

  <span class="kw">new</span> Monad[Composed] {
    <span class="kw">def</span> pure[A](a: A): Composed[A] =
      a.<span class="fu">pure</span>[M2].<span class="fu">pure</span>[M1]

    <span class="kw">def</span> flatMap[A, B](fa: Composed[A])
        (f: A =&gt; Composed[B]): Composed[B] =
      <span class="co">// Problem! How do we write flatMap?</span>
      ???
  }
}</code></pre></div>
<p>It is impossible to write a general definition of <code>flatMap</code> without knowing something about <code>M1</code> or <code>M2</code>. However, if we <em>do</em> know something about one or other monad, we can typically complete this code. For example, if we fix <code>M2</code> above to be <code>Option</code>, a definition of <code>flatMap</code> comes to light:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> flatMap[A, B](fa: Composed[A])
    (f: A =&gt; Composed[B]): Composed[B] =
  fa.<span class="fu">flatMap</span>(_.<span class="fu">fold</span>(None.<span class="fu">pure</span>[M1])(f))</code></pre></div>
<p>Notice that the definition above makes use of <code>None</code>—an <code>Option</code>-specific concept that doesn’t appear in the general <code>Monad</code> interface. We need this extra detail to combine <code>Option</code> with other monads. Similarly, there are things about other monads that help us write composed <code>flatMap</code> methods for them. This is the idea behind monad transformers: Cats defines transformers for a variety of monads, each providing the extra knowledge we need to compose that monad with others. Let’s look at some examples.</p>
<h2 id="a-transformative-example"><span class="header-section-number">5.2</span> A Transformative Example</h2>
<p>Cats provides transformers for many monads, each named with a <code>T</code> suffix: <code>EitherT</code> composes <code>Either</code> with other monads, <code>OptionT</code> composes <code>Option</code>, and so on.</p>
<p>Here’s an example that uses <code>OptionT</code> to compose <code>List</code> and <code>Option</code>. We can use <code>OptionT[List, A]</code>, aliased to <code>ListOption[A]</code> for convenience, to transform a <code>List[Option[A]]</code> into a single monad:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">OptionT</span>

<span class="kw">type</span> ListOption[A] = OptionT[List, A]</code></pre></div>
<p>Note how we build <code>ListOption</code> from the inside out: we pass <code>List</code>, the type of the outer monad, as a parameter to <code>OptionT</code>, the transformer for the inner monad.</p>
<p>We can create instances of <code>ListOption</code> using the <code>OptionT</code> constructor, or more conveniently using <code>pure</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._     <span class="co">// for Monad</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

<span class="kw">val</span> result1: ListOption[Int] = <span class="fu">OptionT</span>(List(Option(<span class="dv">10</span>)))
<span class="co">// result1: ListOption[Int] = OptionT(List(Some(10)))</span>

<span class="kw">val</span> result2: ListOption[Int] = <span class="fl">32.</span>pure[ListOption]
<span class="co">// result2: ListOption[Int] = OptionT(List(Some(32)))</span></code></pre></div>
<p>The <code>map</code> and <code>flatMap</code> methods combine the corresponding methods of <code>List</code> and <code>Option</code> into single operations:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">result1.<span class="fu">flatMap</span> { (x: Int) =&gt;
  result2.<span class="fu">map</span> { (y: Int) =&gt;
    x + y
  }
}
<span class="co">// res1: cats.data.OptionT[List,Int] = OptionT(List(Some(42)))</span></code></pre></div>
<p>This is the basis of all monad transformers. The combined <code>map</code> and <code>flatMap</code> methods allow us to use both component monads without having to recursively unpack and repack values at each stage in the computation. Now let’s look at the API in more depth.</p>
<div class="callout callout-warning">
<p><em>Complexity of Imports</em></p>
<p>The imports in the code samples above hint at how everything bolts together.</p>
<p>We import <a href="http://typelevel.org/cats/api/cats/syntax/package$$applicative$"><code>cats.syntax.applicative</code></a> to get the <code>pure</code> syntax. <code>pure</code> requires an implicit parameter of type <code>Applicative[ListOption]</code>. We haven’t met <code>Applicatives</code> yet, but all <code>Monads</code> are also <code>Applicatives</code> so we can ignore that difference for now.</p>
<p>In order to generate our <code>Applicative[ListOption]</code> we need instances of <code>Applicative</code> for <code>List</code> and <code>OptionT</code>. <code>OptionT</code> is a Cats data type so its instance is provided by its companion object. The instance for <code>List</code> comes from <a href="http://typelevel.org/cats/api/cats/instances/package$$list$"><code>cats.instances.list</code></a>.</p>
<p>Notice we’re not importing <a href="http://typelevel.org/cats/api/cats/syntax/package$$functor$"><code>cats.syntax.functor</code></a> or <a href="http://typelevel.org/cats/api/cats/syntax/package$$flatMap$"><code>cats.syntax.flatMap</code></a>. This is because <code>OptionT</code> is a concrete data type with its own explicit <code>map</code> and <code>flatMap</code> methods. It wouldn’t cause problems if we imported the syntax—the compiler would ignore it in favour of the explicit methods.</p>
<p>Remember that we’re subjecting ourselves to these shenanigans because we’re stubbornly refusing to use the universal Cats import, <a href="http://typelevel.org/cats/api/cats/implicits$.html"><code>cats.implicits</code></a>. If we did use that import, all of the instances and syntax we needed would be in scope and everything would just work.</p>
</div>
<h2 id="monad-transformers-in-cats"><span class="header-section-number">5.3</span> Monad Transformers in Cats</h2>
<p>Each monad transformer is a data type, defined in <a href="http://typelevel.org/cats/api/cats/data/"><code>cats.data</code></a>, that allows us to <em>wrap</em> stacks of monads to produce new monads. We use the monads we’ve built via the <code>Monad</code> type class. The main concepts we have to cover to understand monad transformers are:</p>
<ul>
<li>the available transformer classes;</li>
<li>how to build stacks of monads using transformers;</li>
<li>how to construct instances of a monad stack; and</li>
<li>how to pull apart a stack to access the wrapped monads.</li>
</ul>
<h3 id="the-monad-transformer-classes"><span class="header-section-number">5.3.1</span> The Monad Transformer Classes</h3>
<p>By convention, in Cats a monad <code>Foo</code> will have a transformer class called <code>FooT</code>. In fact, many monads in Cats are defined by combining a monad transformer with the <code>Id</code> monad. Concretely, some of the available instances are:</p>
<ul>
<li><a href="http://typelevel.org/cats/api/cats/data/OptionT.html"><code>cats.data.OptionT</code></a> for <code>Option</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/data/EitherT.html"><code>cats.data.EitherT</code></a> for <code>Either</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/data/?search=reader#ReaderT%5BF%5B_%5D,A,B%5D=cats.data.Kleisli%5BF,A,B%5D"><code>cats.data.ReaderT</code></a> for <code>Reader</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/data/WriterT.html"><code>cats.data.WriterT</code></a> for <code>Writer</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/data/StateT.html"><code>cats.data.StateT</code></a> for <code>State</code>;</li>
<li><a href="http://typelevel.org/cats/api/cats/data/IdT.html"><code>cats.data.IdT</code></a> for the <a href="http://typelevel.org/cats/api/cats/Id.html"><code>Id</code></a> monad.</li>
</ul>
<div class="callout callout-info">
<p><em>Kleisli Arrows</em></p>
<p>In Section 4.8 we mentioned that the <code>Reader</code> monad was a specialisation of a more general concept called a “kleisli arrow”, represented in Cats as <a href="http://typelevel.org/cats/api/cats/data/Kleisli.html"><code>cats.data.Kleisli</code></a>.</p>
<p>We can now reveal that <code>Kleisli</code> and <code>ReaderT</code> are, in fact, the same thing! <code>ReaderT</code> is actually a type alias for <code>Kleisli</code>. Hence, we were creating <code>Readers</code> last chapter and seeing <code>Kleislis</code> on the console.</p>
</div>
<h3 id="building-monad-stacks"><span class="header-section-number">5.3.2</span> Building Monad Stacks</h3>
<p>All of these monad transformers follow the same convention. The transformer itself represents the <em>inner</em> monad in a stack, while the first type parameter specifies the outer monad. The remaining type parameters are the types we’ve used to form the corresponding monads.</p>
<p>For example, our <code>ListOption</code> type above is an alias for <code>OptionT[List, A]</code> but the result is effectively a <code>List[Option[A]]</code>. In other words, we build monad stacks from the inside out:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> ListOption[A] = OptionT[List, A]</code></pre></div>
<p>Many monads and all transformers have at least two type parameters, so we often have to define type aliases for intermediate stages.</p>
<p>For example, suppose we want to wrap <code>Either</code> around <code>Option</code>. <code>Option</code> is the innermost type so we want to use the <code>OptionT</code> monad transformer. We need to use <code>Either</code> as the first type parameter. However, <code>Either</code> itself has two type parameters and monads only have one. We need a type alias to convert the type constructor to the correct shape:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Alias Either to a type constructor with one parameter:</span>
<span class="kw">type</span> ErrorOr[A] = Either[String, A]

<span class="co">// Build our final monad stack using OptionT:</span>
<span class="kw">type</span> ErrorOrOption[A] = OptionT[ErrorOr, A]</code></pre></div>
<p><code>ErrorOrOption</code> is a monad, just like <code>ListOption</code>. We can use <code>pure</code>, <code>map</code>, and <code>flatMap</code> as usual to create and transform instances:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">either</span>._ <span class="co">// for Monad</span>

<span class="kw">val</span> a = <span class="fl">10.</span>pure[ErrorOrOption]
<span class="co">// a: ErrorOrOption[Int] = OptionT(Right(Some(10)))</span>

<span class="kw">val</span> b = <span class="fl">32.</span>pure[ErrorOrOption]
<span class="co">// b: ErrorOrOption[Int] = OptionT(Right(Some(32)))</span>

<span class="kw">val</span> c = a.<span class="fu">flatMap</span>(x =&gt; b.<span class="fu">map</span>(y =&gt; x + y))
<span class="co">// c: cats.data.OptionT[ErrorOr,Int] = OptionT(Right(Some(42)))</span></code></pre></div>
<p>Things become even more confusing when we want to stack three or more monads.</p>
<p>For example, let’s create a <code>Future</code> of an <code>Either</code> of <code>Option</code>. Once again we build this from the inside out with an <code>OptionT</code> of an <code>EitherT</code> of <code>Future</code>. However, we can’t define this in one line because <code>EitherT</code> has three type parameters:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">case</span> <span class="kw">class</span> EitherT[F[_], E, A](stack: F[Either[E, A]]) {
  <span class="co">// etc...</span>
}</code></pre></div>
<p>The three type parameters are as follows:</p>
<ul>
<li><code>F[_]</code> is the outer monad in the stack (<code>Either</code> is the inner);</li>
<li><code>E</code> is the error type for the <code>Either</code>;</li>
<li><code>A</code> is the result type for the <code>Either</code>.</li>
</ul>
<p>This time we create an alias for <code>EitherT</code> that fixes <code>Future</code> and <code>Error</code> and allows <code>A</code> to vary:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Future</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.{EitherT, OptionT}

<span class="kw">type</span> FutureEither[A] = EitherT[Future, String, A]

<span class="kw">type</span> FutureEitherOption[A] = OptionT[FutureEither, A]</code></pre></div>
<p>Our mammoth stack now composes three monads and our <code>map</code> and <code>flatMap</code> methods cut through three layers of abstraction:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Monad</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Await</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

<span class="kw">val</span> futureEitherOr: FutureEitherOption[Int] =
  <span class="kw">for</span> {
    a &lt;- <span class="fl">10.</span>pure[FutureEitherOption]
    b &lt;- <span class="fl">32.</span>pure[FutureEitherOption]
  } <span class="kw">yield</span> a + b</code></pre></div>
<div class="callout callout-warning">
<p><em>Kind Projector</em></p>
<p>If you frequently find yourself defining multiple type aliases when building monad stacks, you may want to try the <a href="https://github.com/non/kind-projector">Kind Projector</a> compiler plugin. Kind Projector enhances Scala’s type syntax to make it easier to define partially applied type constructors. For example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Monad</span>
<span class="co">// import cats.instances.option._</span>

<span class="fl">123.</span>pure[EitherT[Option, String, ?]]
<span class="co">// res7: cats.data.EitherT[Option,String,Int] = EitherT(Some(Right(123)))</span></code></pre></div>
<p>Kind Projector can’t simplify all type declarations down to a single line, but it can reduce the number of intermediate type definitions needed to keep our code readable.</p>
</div>
<h3 id="constructing-and-unpacking-instances"><span class="header-section-number">5.3.3</span> Constructing and Unpacking Instances</h3>
<p>As we saw above, we can create transformed monad stacks using the relevant monad transformer’s <code>apply</code> method or the usual <code>pure</code> syntax<a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Create using apply:</span>
<span class="kw">val</span> errorStack1 = OptionT[ErrorOr, Int](<span class="fu">Right</span>(Some(<span class="dv">10</span>)))
<span class="co">// errorStack1: cats.data.OptionT[ErrorOr,Int] = OptionT(Right(Some(10)))</span>

<span class="co">// Create using pure:</span>
<span class="kw">val</span> errorStack2 = <span class="fl">32.</span>pure[ErrorOrOption]
<span class="co">// errorStack2: ErrorOrOption[Int] = OptionT(Right(Some(32)))</span></code></pre></div>
<p>Once we’ve finished with a monad transformer stack, we can unpack it using its <code>value</code> method. This returns the untransformed stack. We can then manipulate the individual monads in the usual way:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// Extracting the untransformed monad stack:</span>
errorStack1.<span class="fu">value</span>
<span class="co">// res11: ErrorOr[Option[Int]] = Right(Some(10))</span>

<span class="co">// Mapping over the Either in the stack:</span>
errorStack2.<span class="fu">value</span>.<span class="fu">map</span>(_.<span class="fu">getOrElse</span>(-<span class="dv">1</span>))
<span class="co">// res13: scala.util.Either[String,Int] = Right(32)</span></code></pre></div>
<p>Each call to <code>value</code> unpacks a single monad transformer. We may need more than one call to completely unpack a large stack. For example, to <code>Await</code> the <code>FutureEitherOption</code> stack above, we need to call <code>value</code> twice:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">futureEitherOr
<span class="co">// res14: FutureEitherOption[Int] = OptionT(EitherT(Future(Success(Right(Some(42))))))</span>

<span class="kw">val</span> intermediate = futureEitherOr.<span class="fu">value</span>
<span class="co">// intermediate: FutureEither[Option[Int]] = EitherT(Future(Success(Right(Some(42)))))</span>

<span class="kw">val</span> stack = intermediate.<span class="fu">value</span>
<span class="co">// stack: scala.concurrent.Future[Either[String,Option[Int]]] = Future(Success(Right(Some(42))))</span>

Await.<span class="fu">result</span>(stack, <span class="fl">1.</span>second)
<span class="co">// res15: Either[String,Option[Int]] = Right(Some(42))</span></code></pre></div>
<h3 id="default-instances-1"><span class="header-section-number">5.3.4</span> Default Instances</h3>
<p>Many monads in Cats are defined using the corresponding transformer and the <code>Id</code> monad. This is reassuring as it confirms that the APIs for monads and transformers are identical. <code>Reader</code>, <code>Writer</code>, and <code>State</code> are all defined in this way:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Reader[E, A] = ReaderT[Id, E, A] <span class="co">// = Kleisli[Id, E, A]</span>
<span class="kw">type</span> Writer[W, A] = WriterT[Id, W, A]
<span class="kw">type</span> State[S, A]  = StateT[Id, S, A]</code></pre></div>
<p>In other cases monad transformers are defined separately to their corresponding monads. In these cases, the methods of the transformer tend to mirror the methods on the monad. For example, <code>OptionT</code> defines <code>getOrElse</code>, and <code>EitherT</code> defines <code>fold</code>, <code>bimap</code>, <code>swap</code>, and other useful methods.</p>
<h3 id="usage-patterns"><span class="header-section-number">5.3.5</span> Usage Patterns</h3>
<p>Widespread use of monad transformers is sometimes difficult because they fuse monads together in predefined ways. Without careful thought, we can end up having to unpack and repack monads in different configurations to operate on them in different contexts.</p>
<p>We can cope with this in multiple ways. One approach involves creating a single “super stack” and sticking to it throughout our code base. This works if the code is simple and largely uniform in nature. For example, in a web application, we could decide that all request handlers are asynchronous and all can fail with the same set of HTTP error codes. We could design a custom ADT representing the errors and use a fusion <code>Future</code> and <code>Either</code> everywhere in our code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> HttpError
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> NotFound(item: String) <span class="kw">extends</span> HttpError
<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">BadRequest</span>(msg: String) <span class="kw">extends</span> HttpError
<span class="co">// etc...</span>

<span class="kw">type</span> FutureEither[A] = EitherT[Future, HttpError, A]</code></pre></div>
<p>The “super stack” approach starts to fail in larger, more heterogeneous code bases where different stacks make sense in different contexts. Another design pattern that makes more sense in these contexts uses monad transformers as local “glue code”. We expose untransformed stacks at module boundaries, transform them to operate on them locally, and untransform them before passing them on. This allows each module of code to make its own decisions about which transformers to use:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Writer</span>

<span class="kw">type</span> Logged[A] = Writer[List[String], A]

<span class="co">// Methods generally return untransformed stacks:</span>
<span class="kw">def</span> <span class="fu">parseNumber</span>(str: String): Logged[Option[Int]] =
  util.<span class="fu">Try</span>(str.<span class="fu">toInt</span>).<span class="fu">toOption</span> <span class="kw">match</span> {
    <span class="kw">case</span> Some(num) =&gt; Writer(List(s<span class="st">&quot;Read $str&quot;</span>), Some(num))
    <span class="kw">case</span> None      =&gt; Writer(List(s<span class="st">&quot;Failed on $str&quot;</span>), None)
  }

<span class="co">// Consumers use monad transformers locally to simplify composition:</span>
<span class="kw">def</span> <span class="fu">addAll</span>(a: String, b: String, c: String): Logged[Option[Int]] = {
  <span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">OptionT</span>

  <span class="kw">val</span> result = <span class="kw">for</span> {
    a &lt;- <span class="fu">OptionT</span>(<span class="fu">parseNumber</span>(a))
    b &lt;- <span class="fu">OptionT</span>(<span class="fu">parseNumber</span>(b))
    c &lt;- <span class="fu">OptionT</span>(<span class="fu">parseNumber</span>(c))
  } <span class="kw">yield</span> a + b + c

  result.<span class="fu">value</span>
}

<span class="co">// This approach doesn't force OptionT on other users' code:</span>
<span class="kw">val</span> result1 = <span class="fu">addAll</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>)
<span class="co">// result1: Logged[Option[Int]] = WriterT((List(Read 1, Read 2, Read 3),Some(6)))</span>

<span class="kw">val</span> result2 = <span class="fu">addAll</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;3&quot;</span>)
<span class="co">// result2: Logged[Option[Int]] = WriterT((List(Read 1, Failed on a),None))</span></code></pre></div>
<p>Unfortunately, there aren’t one-size-fits-all approaches to working with monad transformers. The best approach for you may depend on a lot of factors: the size and experience of your team, the complexity of your code base, and so on. You may need to experiment and gather feedback from colleagues to determine whether monad transformers are a good fit.</p>
<h2 id="exercise-monads-transform-and-roll-out"><span class="header-section-number">5.4</span> Exercise: Monads: Transform and Roll Out</h2>
<p>The Autobots, well-known robots in disguise, frequently send messages during battle requesting the power levels of their team mates. This helps them coordinate strategies and launch devastating attacks. The message sending method looks like this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">getPowerLevel</span>(autobot: String): Response[Int] =
  ???</code></pre></div>
<p>Transmissions take time in Earth’s viscous atmosphere, and messages are occasionally lost due to satellite malfunction or sabotage by pesky Decepticons<a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a>. <code>Responses</code> are therefore represented as a stack of monads:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Response[A] = Future[Either[String, A]]
<span class="co">// defined type alias Response</span></code></pre></div>
<p>Optimus Prime is getting tired of the nested for comprehensions in his neural matrix. Help him by rewriting <code>Response</code> using a monad transformer.</p>
<div class="solution">
<p>This is a relatively simple combination. We want <code>Future</code> on the outside and <code>Either</code> on the inside, so we build from the inside out using an <code>EitherT</code> of <code>Future</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">EitherT</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Future</span>

<span class="kw">type</span> Response[A] = EitherT[Future, String, A]</code></pre></div>
</div>
<p>Now test the code by implementing <code>getPowerLevel</code> to retrieve data from a set of imaginary allies. Here’s the data we’ll use:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> powerLevels = Map(
  <span class="st">&quot;Jazz&quot;</span>      -&gt; <span class="dv">6</span>,
  <span class="st">&quot;Bumblebee&quot;</span> -&gt; <span class="dv">8</span>,
  <span class="st">&quot;Hot Rod&quot;</span>   -&gt; <span class="dv">10</span>
)</code></pre></div>
<p>If an Autobot isn’t in the <code>powerLevels</code> map, return an error message reporting that they were unreachable. Include the <code>name</code> in the message for good effect.</p>
<div class="solution">
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Monad</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._   <span class="co">// for flatMap</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>

<span class="kw">type</span> Response[A] = EitherT[Future, String, A]

<span class="kw">def</span> <span class="fu">getPowerLevel</span>(ally: String): Response[Int] = {
  powerLevels.<span class="fu">get</span>(ally) <span class="kw">match</span> {
    <span class="kw">case</span> Some(avg) =&gt; EitherT.<span class="fu">right</span>(Future(avg))
    <span class="kw">case</span> None      =&gt; EitherT.<span class="fu">left</span>(Future(s<span class="st">&quot;$ally unreachable&quot;</span>))
  }
}</code></pre></div>
</div>
<p>Two autobots can perform a special move if their combined power level is greater than 15. Write a second method, <code>canSpecialMove</code>, that accepts the names of two allies and checks whether a special move is possible. If either ally is unavailable, fail with an appropriate error message:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">canSpecialMove</span>(ally1: String, ally2: String): Response[Boolean] =
  ???</code></pre></div>
<div class="solution">
<p>We request the power level from each ally and use <code>map</code> and <code>flatMap</code> to combine the results:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">canSpecialMove</span>(ally1: String, ally2: String): Response[Boolean] =
  <span class="kw">for</span> {
    power1 &lt;- <span class="fu">getPowerLevel</span>(ally1)
    power2 &lt;- <span class="fu">getPowerLevel</span>(ally2)
  } <span class="kw">yield</span> (power1 + power2) &gt; <span class="dv">15</span></code></pre></div>
</div>
<p>Finally, write a method <code>tacticalReport</code> that takes two ally names and prints a message saying whether they can perform a special move:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">tacticalReport</span>(ally1: String, ally2: String): String =
  ???</code></pre></div>
<div class="solution">
<p>We use the <code>value</code> method to unpack the monad stack and <code>Await</code> and <code>fold</code> to unpack the <code>Future</code> and <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Await</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

<span class="kw">def</span> <span class="fu">tacticalReport</span>(ally1: String, ally2: String): String = {
  <span class="kw">val</span> stack = <span class="fu">canSpecialMove</span>(ally1, ally2).<span class="fu">value</span>

  Await.<span class="fu">result</span>(stack, <span class="fl">1.</span>second) <span class="kw">match</span> {
    <span class="kw">case</span> <span class="fu">Left</span>(msg) =&gt;
      s<span class="st">&quot;Comms error: $msg&quot;</span>
    <span class="kw">case</span> <span class="fu">Right</span>(<span class="kw">true</span>)  =&gt;
      s<span class="st">&quot;$ally1 and $ally2 are ready to roll out!&quot;</span>
    <span class="kw">case</span> <span class="fu">Right</span>(<span class="kw">false</span>) =&gt;
      s<span class="st">&quot;$ally1 and $ally2 need a recharge.&quot;</span>
  }
}</code></pre></div>
</div>
<p>You should be able to use <code>report</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">tacticalReport</span>(<span class="st">&quot;Jazz&quot;</span>, <span class="st">&quot;Bumblebee&quot;</span>)
<span class="co">// res28: String = Jazz and Bumblebee need a recharge.</span>

<span class="fu">tacticalReport</span>(<span class="st">&quot;Bumblebee&quot;</span>, <span class="st">&quot;Hot Rod&quot;</span>)
<span class="co">// res29: String = Bumblebee and Hot Rod are ready to roll out!</span>

<span class="fu">tacticalReport</span>(<span class="st">&quot;Jazz&quot;</span>, <span class="st">&quot;Ironhide&quot;</span>)
<span class="co">// res30: String = Comms error: Ironhide unreachable</span></code></pre></div>
<h2 id="summary-4"><span class="header-section-number">5.5</span> Summary</h2>
<p>In this chapter we introduced monad transformers, which eliminate the need for nested for comprehensions and pattern matching when working with “stacks” of nested monads.</p>
<p>Each monad transformer, such as <code>FutureT</code>, <code>OptionT</code> or <code>EitherT</code>, provides the code needed to merge its related monad with other monads. The transformer is a data structure that wraps a monad stack, equipping it with <code>map</code> and <code>flatMap</code> methods that unpack and repack the whole stack.</p>
<p>The type signatures of monad transformers are written from the inside out, so an <code>EitherT[Option, String, A]</code> is a wrapper for an <code>Option[Either[String, A]]</code>. It is often useful to use type aliases when writing transformer types for deeply nested monads.</p>
<p>With this look at monad transformers, we have now covered everything we need to know about monads and the sequencing of computations using <code>flatMap</code>. In the next chapter we will switch tack and discuss two new type classes, <code>Semigroupal</code> and <code>Applicative</code>, that support new kinds of operation such as <code>zipping</code> independent values within a context.</p>
<h1 id="sec:applicatives"><span class="header-section-number">6</span> Semigroupal and Applicative</h1>
<p>In previous chapters we saw how functors and monads let us sequence operations using <code>map</code> and <code>flatMap</code>. While functors and monads are both immensely useful abstractions, there are certain types of program flow that they cannot represent.</p>
<p>One such example is form validation. When we validate a form we want to return <em>all</em> the errors to the user, not stop on the first error we encounter. If we model this with a monad like <code>Either</code>, we fail fast and lose errors. For example, the code below fails on the first call to <code>parseInt</code> and doesn’t go any further:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._ <span class="co">// for catchOnly</span>

<span class="kw">def</span> <span class="fu">parseInt</span>(str: String): Either[String, Int] =
  Either.<span class="fu">catchOnly</span>[NumberFormatException](str.<span class="fu">toInt</span>).
    <span class="fu">leftMap</span>(_ =&gt; s<span class="st">&quot;Couldn't read $str&quot;</span>)

<span class="kw">for</span> {
  a &lt;- <span class="fu">parseInt</span>(<span class="st">&quot;a&quot;</span>)
  b &lt;- <span class="fu">parseInt</span>(<span class="st">&quot;b&quot;</span>)
  c &lt;- <span class="fu">parseInt</span>(<span class="st">&quot;c&quot;</span>)
} <span class="kw">yield</span> (a + b + c)
<span class="co">// res1: scala.util.Either[String,Int] = Left(Couldn't read a)</span></code></pre></div>
<p>Another example is the concurrent evaluation of <code>Futures</code>. If we have several long-running independent tasks, it makes sense to execute them concurrently. However, monadic comprehension only allows us to run them in sequence. <code>map</code> and <code>flatMap</code> aren’t quite capable of capturing what we want because they make the assumption that each computation is <em>dependent</em> on the previous one:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// context2 is dependent on value1:</span>
context1.<span class="fu">flatMap</span>(value1 =&gt; context2)</code></pre></div>
<p>The calls to <code>parseInt</code> and <code>Future.apply</code> above are <em>independent</em> of one another, but <code>map</code> and <code>flatMap</code> can’t exploit this. We need a weaker construct—one that doesn’t guarantee sequencing—to achieve the result we want. In this chapter we will look at two type classes that support this pattern:</p>
<ul>
<li><p><code>Semigroupal</code> encompasses the notion of composing pairs of contexts. Cats provides a <a href="http://typelevel.org/cats/api/cats/syntax/package$$semigroupal$"><code>cats.syntax.apply</code></a> module that makes use of <code>Semigroupal</code> and <code>Functor</code> to allow users to sequence functions with multiple arguments.</p></li>
<li><p><code>Applicative</code> extends <code>Semigroupal</code> and <code>Functor</code>. It provides a way of applying functions to parameters within a context. <code>Applicative</code> is the source of the <code>pure</code> method we introduced in Chapter 4.</p></li>
</ul>
<p>Applicatives are often formulated in terms of function application, instead of the semigroupal formulation that is emphasised in Cats. This alternative formulation provides a link to other libraries and languages such as Scalaz and Haskell. We’ll take a look at different formulations of Applicative, as well as the relationships between <code>Semigroupal</code>, <code>Functor</code>, <code>Applicative</code>, and <code>Monad</code>, towards the end of the chapter.</p>
<h2 id="semigroupal"><span class="header-section-number">6.1</span> Semigroupal</h2>
<p><a href="http://typelevel.org/cats/api/cats/kernel/Semigroupal.html"><code>cats.Semigroupal</code></a> is a type class that allows us to combine contexts<a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a>. If we have two objects of type <code>F[A]</code> and <code>F[B]</code>, a <code>Semigroupal[F]</code> allows us to combine them to form an <code>F[(A, B)]</code>. Its definition in Cats is:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Semigroupal[F[_]] {
  <span class="kw">def</span> product[A, B](fa: F[A], fb: F[B]): F[(A, B)]
}</code></pre></div>
<p>As we discussed at the beginning of this chapter, the parameters <code>fa</code> and <code>fb</code> are independent of one another: we can compute them in either order before passing them to <code>product</code>. This is in contrast to <code>flatMap</code>, which imposes a strict order on its parameters. This gives us more freedom when defining instances of <code>Semigroupal</code> than we get when defining <code>Monads</code>.</p>
<h3 id="joining-two-contexts"><span class="header-section-number">6.1.1</span> Joining Two Contexts</h3>
<p>While <code>Semigroup</code> allows us to join values, <code>Semigroupal</code> allows us to join contexts. Let’s join some <code>Options</code> as an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Semigroupal</span>

Semigroupal[Option].<span class="fu">product</span>(Some(<span class="dv">123</span>), Some(<span class="st">&quot;abc&quot;</span>))
<span class="co">// res0: Option[(Int, String)] = Some((123,abc))</span></code></pre></div>
<p>If both parameters are instances of <code>Some</code>, we end up with a tuple of the values within. If either parameter evaluates to <code>None</code>, the entire result is <code>None</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Semigroupal[Option].<span class="fu">product</span>(None, Some(<span class="st">&quot;abc&quot;</span>))
<span class="co">// res1: Option[(Nothing, String)] = None</span>

Semigroupal[Option].<span class="fu">product</span>(Some(<span class="dv">123</span>), None)
<span class="co">// res2: Option[(Int, Nothing)] = None</span></code></pre></div>
<h3 id="joining-three-or-more-contexts"><span class="header-section-number">6.1.2</span> Joining Three or More Contexts</h3>
<p>The companion object for <code>Semigroupal</code> defines a set of methods on top of <code>product</code>. For example, the methods <code>tuple2</code> through <code>tuple22</code> generalise <code>product</code> to different arities:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Semigroupal</span>

Semigroupal.<span class="fu">tuple3</span>(Option(<span class="dv">1</span>), Option(<span class="dv">2</span>), Option(<span class="dv">3</span>))
<span class="co">// res3: Option[(Int, Int, Int)] = Some((1,2,3))</span>

Semigroupal.<span class="fu">tuple3</span>(Option(<span class="dv">1</span>), Option(<span class="dv">2</span>), Option.<span class="fu">empty</span>[Int])
<span class="co">// res4: Option[(Int, Int, Int)] = None</span></code></pre></div>
<p>The methods <code>map2</code> through <code>map22</code> apply a user-specified function to the values inside 2 to 22 contexts:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Semigroupal.<span class="fu">map3</span>(Option(<span class="dv">1</span>), Option(<span class="dv">2</span>), Option(<span class="dv">3</span>))(_ + _ + _)
<span class="co">// res5: Option[Int] = Some(6)</span>

Semigroupal.<span class="fu">map2</span>(Option(<span class="dv">1</span>), Option.<span class="fu">empty</span>[Int])(_ + _)
<span class="co">// res6: Option[Int] = None</span></code></pre></div>
<p>There are also methods <code>contramap2</code> through <code>contramap22</code> and <code>imap2</code> through <code>imap22</code>, that require instances of <code>Contravariant</code> and <code>Invariant</code> respectively.</p>
<!--
### Semigroupal Laws

There is only one law for `Semigroupal`:
the `product` method must be associative:

```scala
product(a, product(b, c)) == product(product(a, b), c)
```
-->
<h2 id="apply-syntax"><span class="header-section-number">6.2</span> Apply Syntax</h2>
<p>Cats provides a convenient <em>apply syntax</em> that provides a shorthand for the methods described above. We import the syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$semigroupal$"><code>cats.syntax.apply</code></a>. Here’s an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._     <span class="co">// for tupled and mapN</span></code></pre></div>
<p>The <code>tupled</code> method is implicitly added to the tuple of <code>Options</code>. It uses the <code>Semigroupal</code> for <code>Option</code> to zip the values inside the <code>Options</code>, creating a single <code>Option</code> of a tuple:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(Option(<span class="dv">123</span>), Option(<span class="st">&quot;abc&quot;</span>)).<span class="fu">tupled</span>
<span class="co">// res7: Option[(Int, String)] = Some((123,abc))</span></code></pre></div>
<p>We can use the same trick on tuples of up to 22 values. Cats defines a separate <code>tupled</code> method for each arity:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(Option(<span class="dv">123</span>), Option(<span class="st">&quot;abc&quot;</span>), Option(<span class="kw">true</span>)).<span class="fu">tupled</span>
<span class="co">// res8: Option[(Int, String, Boolean)] = Some((123,abc,true))</span></code></pre></div>
<p>In addition to <code>tupled</code>, Cats’ apply syntax provides a method called <code>mapN</code> that accepts an implicit <code>Functor</code> and a function of the correct arity to combine the values:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(name: String, born: Int, color: String)

(
  Option(<span class="st">&quot;Garfield&quot;</span>),
  Option(<span class="dv">1978</span>),
  Option(<span class="st">&quot;Orange &amp; black&quot;</span>)
).<span class="fu">mapN</span>(Cat.<span class="fu">apply</span>)
<span class="co">// res9: Option[Cat] = Some(Cat(Garfield,1978,Orange &amp; black))</span></code></pre></div>
<p>Internally <code>mapN</code> uses the <code>Semigroupal</code> to extract the values from the <code>Option</code> and the <code>Functor</code> to apply the values to the function.</p>
<p>It’s nice to see that this syntax is type checked. If we supply a function that accepts the wrong number or types of parameters, we get a compile error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> add: (Int, Int) =&gt; Int = (a, b) =&gt; a + b
<span class="co">// add: (Int, Int) =&gt; Int = &lt;function2&gt;</span>

(Option(<span class="dv">1</span>), Option(<span class="dv">2</span>), Option(<span class="dv">3</span>)).<span class="fu">mapN</span>(add)
<span class="co">// &lt;console&gt;:27: error: type mismatch;</span>
<span class="co">//  found   : (Int, Int) =&gt; Int</span>
<span class="co">//  required: (Int, Int, Int) =&gt; ?</span>
<span class="co">//        (Option(1), Option(2), Option(3)).mapN(add)</span>
<span class="co">//                                               ^</span>

(Option(<span class="st">&quot;cats&quot;</span>), Option(<span class="kw">true</span>)).<span class="fu">mapN</span>(add)
<span class="co">// &lt;console&gt;:27: error: type mismatch;</span>
<span class="co">//  found   : (Int, Int) =&gt; Int</span>
<span class="co">//  required: (String, Boolean) =&gt; ?</span>
<span class="co">//        (Option(&quot;cats&quot;), Option(true)).mapN(add)</span>
<span class="co">//                                            ^</span></code></pre></div>
<h3 id="fancy-functors-and-apply-syntax"><span class="header-section-number">6.2.1</span> Fancy Functors and Apply Syntax</h3>
<p>Apply syntax also has <code>contramapN</code> and <code>imapN</code> methods that accept <a href="#contravariant">Contravariant</a> and <a href="#invariant">Invariant</a> functors. For example, we can combine <code>Monoids</code> using <code>Invariant</code>. Here’s an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._        <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">invariant</span>._  <span class="co">// for Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._       <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._     <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._         <span class="co">// for imapN</span>

<span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(
  name: String,
  yearOfBirth: Int,
  favoriteFoods: List[String]
)

<span class="kw">val</span> tupleToCat: (String, Int, List[String]) =&gt; Cat =
  Cat.<span class="fu">apply</span> _

<span class="kw">val</span> catToTuple: Cat =&gt; (String, Int, List[String]) =
  cat =&gt; (cat.<span class="fu">name</span>, cat.<span class="fu">yearOfBirth</span>, cat.<span class="fu">favoriteFoods</span>)

<span class="kw">implicit</span> <span class="kw">val</span> catMonoid: Monoid[Cat] = (
  Monoid[String],
  Monoid[Int],
  Monoid[List[String]]
).<span class="fu">imapN</span>(tupleToCat)(catToTuple)</code></pre></div>
<p>Our <code>Monoid</code> allows us to create “empty” <code>Cats</code>, and add <code>Cats</code> together using the syntax from Chapter 2:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">val</span> garfield   = <span class="fu">Cat</span>(<span class="st">&quot;Garfield&quot;</span>, <span class="dv">1978</span>, List(<span class="st">&quot;Lasagne&quot;</span>))
<span class="kw">val</span> heathcliff = <span class="fu">Cat</span>(<span class="st">&quot;Heathcliff&quot;</span>, <span class="dv">1988</span>, List(<span class="st">&quot;Junk Food&quot;</span>))

garfield |+| heathcliff
<span class="co">// res17: Cat = Cat(GarfieldHeathcliff,3966,List(Lasagne, Junk Food))</span></code></pre></div>
<h2 id="semigroupal-applied-to-different-types"><span class="header-section-number">6.3</span> Semigroupal Applied to Different Types</h2>
<p><code>Semigroupal</code> doesn’t always provide the behaviour we expect, particularly for types that also have instances of <code>Monad</code>. We have seen the behaviour of the <code>Semigroupal</code> for <code>Option</code>. Let’s look at some examples for other types.</p>
<p><strong>Future</strong></p>
<p>The semantics for <code>Future</code> provide parallel as opposed to sequential execution:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Semigroupal</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>
<span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">val</span> futurePair = Semigroupal[Future].
  <span class="fu">product</span>(Future(<span class="st">&quot;Hello&quot;</span>), Future(<span class="dv">123</span>))

Await.<span class="fu">result</span>(futurePair, <span class="fl">1.</span>second)
<span class="co">// res1: (String, Int) = (Hello,123)</span></code></pre></div>
<p>The two <code>Futures</code> start executing the moment we create them, so they are already calculating results by the time we call <code>product</code>. We can use apply syntax to zip fixed numbers of <code>Futures</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._ <span class="co">// for mapN</span>

<span class="kw">case</span> <span class="kw">class</span> <span class="fu">Cat</span>(
  name: String,
  yearOfBirth: Int,
  favoriteFoods: List[String]
)

<span class="kw">val</span> futureCat = (
  Future(<span class="st">&quot;Garfield&quot;</span>),
  Future(<span class="dv">1978</span>),
  Future(List(<span class="st">&quot;Lasagne&quot;</span>))
).<span class="fu">mapN</span>(Cat.<span class="fu">apply</span>)

Await.<span class="fu">result</span>(futureCat, <span class="fl">1.</span>second)
<span class="co">// res4: Cat = Cat(Garfield,1978,List(Lasagne))</span></code></pre></div>
<p><strong>List</strong></p>
<p>Combining <code>Lists</code> with <code>Semigroupal</code> produces some potentially unexpected results. We might expect code like the following to <em>zip</em> the lists, but we actually get the cartesian product of their elements:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Semigroupal</span>

Semigroupal[List].<span class="fu">product</span>(List(<span class="dv">1</span>, <span class="dv">2</span>), List(<span class="dv">3</span>, <span class="dv">4</span>))
<span class="co">// res5: List[(Int, Int)] = List((1,3), (1,4), (2,3), (2,4))</span></code></pre></div>
<p>This is perhaps surprising. Zipping lists tends to be a more common operation. We’ll see why we get this behaviour in a moment.</p>
<p><strong>Either</strong></p>
<p>We opened this chapter with a discussion of fail-fast versus accumulating error-handling. We might expect <code>product</code> applied to <code>Either</code> to accumulate errors instead of fail fast. Again, perhaps surprisingly, we find that <code>product</code> implements the same fail-fast behaviour as <code>flatMap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">either</span>._ <span class="co">// for Semigroupal</span>

<span class="kw">type</span> ErrorOr[A] = Either[Vector[String], A]

Semigroupal[ErrorOr].<span class="fu">product</span>(
  <span class="fu">Left</span>(Vector(<span class="st">&quot;Error 1&quot;</span>)),
  <span class="fu">Left</span>(Vector(<span class="st">&quot;Error 2&quot;</span>))
)
<span class="co">// res7: ErrorOr[(Nothing, Nothing)] = Left(Vector(Error 1))</span></code></pre></div>
<p>In this example <code>product</code> sees the first failure and stops, even though it is possible to examine the second parameter and see that it is also a failure.</p>
<h3 id="semigroupal-applied-to-monads"><span class="header-section-number">6.3.1</span> Semigroupal Applied to Monads</h3>
<p>The reason for the surprising results for <code>List</code> and <code>Either</code> is that they are both monads. To ensure consistent semantics, Cats’ <code>Monad</code> (which extends <code>Semigroupal</code>) provides a standard definition of <code>product</code> in terms of <code>map</code> and <code>flatMap</code>. This gives what we might think of as unexpected and less useful behaviour for a number of data types. The consistency of semantics is important for higher level abstractions, but we don’t know about those yet.</p>
<p>Even our results for <code>Future</code> are a trick of the light. <code>flatMap</code> provides sequential ordering, so <code>product</code> provides the same. The parallel execution we observe occurs because our constituent <code>Futures</code> start running before we call <code>product</code>. This is equivalent to the classic create-then-flatMap pattern:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> a = Future(<span class="st">&quot;Future 1&quot;</span>)
<span class="kw">val</span> b = Future(<span class="st">&quot;Future 2&quot;</span>)

<span class="kw">for</span> {
  x &lt;- a
  y &lt;- b
} <span class="kw">yield</span> (x, y)</code></pre></div>
<p>So why bother with <code>Semigroupal</code> at all? The answer is that we can create useful data types that have instances of <code>Semigroupal</code> (and <code>Applicative</code>) but not <code>Monad</code>. This frees us to implement <code>product</code> in different ways. We’ll examine this further in a moment when we look at an alternative data type for error handling.</p>
<h4 id="exercise-the-product-of-monads"><span class="header-section-number">6.3.1.1</span> Exercise: The Product of Monads</h4>
<p>Implement <code>product</code> in terms of <code>flatMap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monad</span>

<span class="kw">def</span> product[M[_]: Monad, A, B](x: M[A], y: M[B]): M[(A, B)] =
  ???</code></pre></div>
<div class="solution">
<p>We can implement <code>product</code> in terms of <code>map</code> and <code>flatMap</code> like so:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">flatMap</span>._ <span class="co">// for flatMap</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._ <span class="co">// for map</span>

<span class="kw">def</span> product[M[_]: Monad, A, B](x: M[A], y: M[B]): M[(A, B)] =
  x.<span class="fu">flatMap</span>(a =&gt; y.<span class="fu">map</span>(b =&gt; (a, b)))</code></pre></div>
<p>Unsurprisingly, this code is equivalent to a for comprehension:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> product[M[_]: Monad, A, B](x: M[A], y: M[B]): M[(A, B)] =
  <span class="kw">for</span> {
    a &lt;- x
    b &lt;- y
  } <span class="kw">yield</span> (a, b)</code></pre></div>
<p>The semantics of <code>flatMap</code> are what give rise to the behaviour for <code>List</code> and <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Semigroupal</span>

<span class="fu">product</span>(List(<span class="dv">1</span>, <span class="dv">2</span>), List(<span class="dv">3</span>, <span class="dv">4</span>))
<span class="co">// res12: List[(Int, Int)] = List((1,3), (1,4), (2,3), (2,4))</span>

<span class="kw">type</span> ErrorOr[A] = Either[Vector[String], A]

product[ErrorOr, Int, Int](
  <span class="fu">Left</span>(Vector(<span class="st">&quot;Error 1&quot;</span>)),
  <span class="fu">Left</span>(Vector(<span class="st">&quot;Error 2&quot;</span>))
)
<span class="co">// res13: ErrorOr[(Int, Int)] = Left(Vector(Error 1))</span></code></pre></div>
</div>
<h2 id="validated"><span class="header-section-number">6.4</span> Validated</h2>
<p>By now we are familiar with the fail-fast error handling behaviour of <code>Either</code>. Furthermore, because <code>Either</code> is a monad, we know that the semantics of <code>product</code> are the same as those for <code>flatMap</code>. In fact, it is impossible for us to design a monadic data type that implements error accumulating semantics without breaking the consistency of these two methods.</p>
<p>Fortunately, Cats provides a data type called <code>Validated</code> that has an instance of <code>Semigroupal</code> but <em>no</em> instance of <code>Monad</code>. The implementation of <code>product</code> is therefore free to accumulate errors:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Monoid</span>

<span class="kw">type</span> AllErrorsOr[A] = Validated[List[String], A]

Semigroupal[AllErrorsOr].<span class="fu">product</span>(
  Validated.<span class="fu">invalid</span>(List(<span class="st">&quot;Error 1&quot;</span>)),
  Validated.<span class="fu">invalid</span>(List(<span class="st">&quot;Error 2&quot;</span>))
)
<span class="co">// res1: AllErrorsOr[(Nothing, Nothing)] = Invalid(List(Error 1, Error 2))</span></code></pre></div>
<p><code>Validated</code> complements <code>Either</code> nicely. Between the two we have support for both of the common types of error handling: fail-fast and accumulating.</p>
<h3 id="creating-instances-of-validated"><span class="header-section-number">6.4.1</span> Creating Instances of Validated</h3>
<p><code>Validated</code> has two subtypes, <code>Validated.Valid</code> and <code>Validated.Invalid</code>, that correspond loosely to <code>Right</code> and <code>Left</code>. There are a lot of ways to create instances of these types. We can create them directly using their <code>apply</code> methods:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> v = Validated.<span class="fu">Valid</span>(<span class="dv">123</span>)
<span class="co">// v: cats.data.Validated.Valid[Int] = Valid(123)</span>

<span class="kw">val</span> i = Validated.<span class="fu">Invalid</span>(List(<span class="st">&quot;Badness&quot;</span>))
<span class="co">// i: cats.data.Validated.Invalid[List[String]] = Invalid(List(Badness))</span></code></pre></div>
<p>However, it is often easier to use the <code>valid</code> and <code>invalid</code> smart constructors, which widen the return type to <code>Validated</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> v = Validated.<span class="fu">valid</span>[List[String], Int](<span class="dv">123</span>)
<span class="co">// v: cats.data.Validated[List[String],Int] = Valid(123)</span>

<span class="kw">val</span> i = Validated.<span class="fu">invalid</span>[List[String], Int](List(<span class="st">&quot;Badness&quot;</span>))
<span class="co">// i: cats.data.Validated[List[String],Int] = Invalid(List(Badness))</span></code></pre></div>
<p>As a third option we can import the <code>valid</code> and <code>invalid</code> extension methods from <code>cats.syntax.validated</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">validated</span>._ <span class="co">// for valid and invalid</span>

<span class="fl">123.</span>valid[List[String]]
<span class="co">// res2: cats.data.Validated[List[String],Int] = Valid(123)</span>

List(<span class="st">&quot;Badness&quot;</span>).<span class="fu">invalid</span>[Int]
<span class="co">// res3: cats.data.Validated[List[String],Int] = Invalid(List(Badness))</span></code></pre></div>
<p>As a fourth option we can use <code>pure</code> and <code>raiseError</code> from <a href="http://typelevel.org/cats/api/cats/syntax/package$$applicative$"><code>cats.syntax.applicative</code></a> and <a href="http://typelevel.org/cats/api/cats/syntax/package$$applicativeError$"><code>cats.syntax.applicativeError</code></a> respectively:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._      <span class="co">// for pure</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicativeError</span>._ <span class="co">// for raiseError</span>

<span class="kw">type</span> ErrorsOr[A] = Validated[List[String], A]

<span class="fl">123.</span>pure[ErrorsOr]
<span class="co">// res5: ErrorsOr[Int] = Valid(123)</span>

List(<span class="st">&quot;Badness&quot;</span>).<span class="fu">raiseError</span>[ErrorsOr, Int]
<span class="co">// res6: ErrorsOr[Int] = Invalid(List(Badness))</span></code></pre></div>
<p>Finally, there are helper methods to create instances of <code>Validated</code> from different sources. We can create them from <code>Exceptions</code>, as well as instances of <code>Try</code>, <code>Either</code>, and <code>Option</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Validated.<span class="fu">catchOnly</span>[NumberFormatException](<span class="st">&quot;foo&quot;</span>.<span class="fu">toInt</span>)
<span class="co">// res7: cats.data.Validated[NumberFormatException,Int] = Invalid(java.lang.NumberFormatException: For input string: &quot;foo&quot;)</span>

Validated.<span class="fu">catchNonFatal</span>(sys.<span class="fu">error</span>(<span class="st">&quot;Badness&quot;</span>))
<span class="co">// res8: cats.data.Validated[Throwable,Nothing] = Invalid(java.lang.RuntimeException: Badness)</span>

Validated.<span class="fu">fromTry</span>(scala.<span class="fu">util</span>.<span class="fu">Try</span>(<span class="st">&quot;foo&quot;</span>.<span class="fu">toInt</span>))
<span class="co">// res9: cats.data.Validated[Throwable,Int] = Invalid(java.lang.NumberFormatException: For input string: &quot;foo&quot;)</span>

Validated.<span class="fu">fromEither</span>[String, Int](<span class="fu">Left</span>(<span class="st">&quot;Badness&quot;</span>))
<span class="co">// res10: cats.data.Validated[String,Int] = Invalid(Badness)</span>

Validated.<span class="fu">fromOption</span>[String, Int](None, <span class="st">&quot;Badness&quot;</span>)
<span class="co">// res11: cats.data.Validated[String,Int] = Invalid(Badness)</span></code></pre></div>
<h3 id="combining-instances-of-validated"><span class="header-section-number">6.4.2</span> Combining Instances of Validated</h3>
<p>We can combine instances of <code>Validated</code> using any of the methods or syntax described for <code>Semigroupal</code> above.</p>
<p>All of these techniques require an instance of <code>Semigroupal</code> to be in scope. As with <code>Either</code>, we need to fix the error type to create a type constructor with the correct number of parameters for <code>Semigroupal</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> AllErrorsOr[A] = Validated[String, A]</code></pre></div>
<p><code>Validated</code> accumulates errors using a <code>Semigroup</code>, so we need one of those in scope to summon the <code>Semigroupal</code>. If no <code>Semigroup</code> is visible at the call site, we get an annoyingly unhelpful compilation error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Semigroupal[AllErrorsOr]
<span class="co">// &lt;console&gt;:28: error: could not find implicit value for parameter instance: cats.Semigroupal[AllErrorsOr]</span>
<span class="co">//        Semigroupal[AllErrorsOr]</span>
<span class="co">//                   ^</span></code></pre></div>
<p>Once we import a <code>Semigroup</code> for the error type, everything works as expected:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Semigroup</span>

Semigroupal[AllErrorsOr]
<span class="co">// res13: cats.Semigroupal[AllErrorsOr] = cats.data.ValidatedInstances$$anon$1@57700a2c</span></code></pre></div>
<p>As long as the compiler has all the implicits in scope to summon a <code>Semigroupal</code> of the correct type, we can use apply syntax or any of the other <code>Semigroupal</code> methods to accumulate errors as we like:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._ <span class="co">// for tupled</span>

(
  <span class="st">&quot;Error 1&quot;</span>.<span class="fu">invalid</span>[Int],
  <span class="st">&quot;Error 2&quot;</span>.<span class="fu">invalid</span>[Int]
).<span class="fu">tupled</span>
<span class="co">// res14: cats.data.Validated[String,(Int, Int)] = Invalid(Error 1Error 2)</span></code></pre></div>
<p>As you can see, <code>String</code> isn’t an ideal type for accumulating errors. We commonly use <code>Lists</code> or <code>Vectors</code> instead:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Semigroupal</span>

(
  Vector(<span class="dv">404</span>).<span class="fu">invalid</span>[Int],
  Vector(<span class="dv">500</span>).<span class="fu">invalid</span>[Int]
).<span class="fu">tupled</span>
<span class="co">// res15: cats.data.Validated[scala.collection.immutable.Vector[Int],(Int, Int)] = Invalid(Vector(404, 500))</span></code></pre></div>
<p>The <code>cats.data</code> package also provides the <a href="http://typelevel.org/cats/api/cats/data/NonEmptyList.html"><code>NonEmptyList</code></a> and <a href="http://typelevel.org/cats/api/cats/data/NonEmptyVector.html"><code>NonEmptyVector</code></a> types that prevent us failing without at least one error:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">NonEmptyVector</span>

(
  NonEmptyVector.<span class="fu">of</span>(<span class="st">&quot;Error 1&quot;</span>).<span class="fu">invalid</span>[Int],
  NonEmptyVector.<span class="fu">of</span>(<span class="st">&quot;Error 2&quot;</span>).<span class="fu">invalid</span>[Int]
).<span class="fu">tupled</span>
<span class="co">// res16: cats.data.Validated[cats.data.NonEmptyVector[String],(Int, Int)] = Invalid(NonEmptyVector(Error 1, Error 2))</span></code></pre></div>
<h3 id="methods-of-validated"><span class="header-section-number">6.4.3</span> Methods of Validated</h3>
<p><code>Validated</code> comes with a suite of methods that closely resemble those available for <code>Either</code>, including the methods from <a href="http://typelevel.org/cats/api/cats/syntax/package$$either$"><code>cats.syntax.either</code></a>. We can use <code>map</code>, <code>leftMap</code>, and <code>bimap</code> to transform the values inside the valid and invalid sides:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fl">123.</span>valid.<span class="fu">map</span>(_ * <span class="dv">100</span>)
<span class="co">// res17: cats.data.Validated[Nothing,Int] = Valid(12300)</span>

<span class="st">&quot;?&quot;</span>.<span class="fu">invalid</span>.<span class="fu">leftMap</span>(_.<span class="fu">toString</span>)
<span class="co">// res18: cats.data.Validated[String,Nothing] = Invalid(?)</span>

<span class="fl">123.</span>valid[String].<span class="fu">bimap</span>(_ + <span class="st">&quot;!&quot;</span>, _ * <span class="dv">100</span>)
<span class="co">// res19: cats.data.Validated[String,Int] = Valid(12300)</span>

<span class="st">&quot;?&quot;</span>.<span class="fu">invalid</span>[Int].<span class="fu">bimap</span>(_ + <span class="st">&quot;!&quot;</span>, _ * <span class="dv">100</span>)
<span class="co">// res20: cats.data.Validated[String,Int] = Invalid(?!)</span></code></pre></div>
<p>We can’t <code>flatMap</code> because <code>Validated</code> isn’t a monad. However, Cats does provide a stand-in for <code>flatMap</code> called <code>andThen</code>. The type signature of <code>andThen</code> is identical to that of <code>flatMap</code>, but it has a different name because it is not a lawful implementation with respect to the monad laws:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fl">32.</span>valid.<span class="fu">andThen</span> { a =&gt;
  <span class="fl">10.</span>valid.<span class="fu">map</span> { b =&gt;
    a + b
  }
}
<span class="co">// res21: cats.data.Validated[Nothing,Int] = Valid(42)</span></code></pre></div>
<p>If we want to do more than just <code>flatMap</code>, we can convert back and forth between <code>Validated</code> and <code>Either</code> using the <code>toEither</code> and <code>toValidated</code> methods. Note that <code>toValidated</code> comes from [<code>cats.syntax.either</code>]:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._ <span class="co">// for toValidated</span>
<span class="co">// import cats.syntax.either._</span>

<span class="st">&quot;Badness&quot;</span>.<span class="fu">invalid</span>[Int]
<span class="co">// res22: cats.data.Validated[String,Int] = Invalid(Badness)</span>

<span class="st">&quot;Badness&quot;</span>.<span class="fu">invalid</span>[Int].<span class="fu">toEither</span>
<span class="co">// res23: Either[String,Int] = Left(Badness)</span>

<span class="st">&quot;Badness&quot;</span>.<span class="fu">invalid</span>[Int].<span class="fu">toEither</span>.<span class="fu">toValidated</span>
<span class="co">// res24: cats.data.Validated[String,Int] = Invalid(Badness)</span></code></pre></div>
<p>As with <code>Either</code>, we can use the <code>ensure</code> method to fail with a specified error if a predicate does not hold:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// 123.valid[String].ensure(&quot;Negative!&quot;)(_ &gt; 0)</span></code></pre></div>
<p>Finally, we can call <code>getOrElse</code> or <code>fold</code> to extract values from the <code>Valid</code> and <code>Invalid</code> cases:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="st">&quot;fail&quot;</span>.<span class="fu">invalid</span>[Int].<span class="fu">getOrElse</span>(<span class="dv">0</span>)
<span class="co">// res26: Int = 0</span>

<span class="st">&quot;fail&quot;</span>.<span class="fu">invalid</span>[Int].<span class="fu">fold</span>(_ + <span class="st">&quot;!!!&quot;</span>, _.<span class="fu">toString</span>)
<span class="co">// res27: String = fail!!!</span></code></pre></div>
<h3 id="exercise-form-validation"><span class="header-section-number">6.4.4</span> Exercise: Form Validation</h3>
<p>Let’s get used to <code>Validated</code> by implementing a simple HTML registration form. We receive request data from the client in a <code>Map[String, String]</code> and we want to parse it to create a <code>User</code> object:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">User</span>(name: String, age: Int)</code></pre></div>
<p>Our goal is to implement code that parses the incoming data enforcing the following rules:</p>
<ul>
<li>the name and age must be specified;</li>
<li>the name must not be blank;</li>
<li>the age must be a valid non-negative integer.</li>
</ul>
<p>If all the rules pass our parser we should return a <code>User</code>. If any rules fail we should return a <code>List</code> of the error messages.</p>
<p>To implement this example we’ll need to combine rules in sequence and in parallel. We’ll use <code>Either</code> to combine computations in sequence using fail-fast semantics, and <code>Validated</code> to combine them in parallel using accumulating semantics.</p>
<p>Let’s start with some sequential combination. We’ll define two methods to read the <code>&quot;name&quot;</code> and <code>&quot;age&quot;</code> fields:</p>
<ul>
<li><p><code>readName</code> will take a <code>Map[String, String]</code> parameter, extract the <code>&quot;name&quot;</code> field, check the relevant validation rules, and return an <code>Either[List[String], String]</code>.</p></li>
<li><p><code>readAge</code> will take a <code>Map[String, String]</code> parameter, extract the <code>&quot;age&quot;</code> field, check the relevant validation rules, and return an <code>Either[List[String], Int]</code>.</p></li>
</ul>
<p>We’ll build these methods up from smaller building blocks. Start by defining a method <code>getValue</code> that reads a <code>String</code> from the <code>Map</code> given a field name.</p>
<div class="solution">
<p>We’ll be using <code>Either</code> and <code>Validated</code> so we’ll start with some imports:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>

<span class="kw">type</span> FormData = Map[String, String]
<span class="kw">type</span> FailFast[A] = Either[List[String], A]
<span class="kw">type</span> FailSlow[A] = Validated[List[String], A]</code></pre></div>
<p>The <code>getValue</code> rule extracts a <code>String</code> from the form data. We’ll be using it in sequence with rules for parsing <code>Ints</code> and checking values, so we’ll define it to return an <code>Either</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">getValue</span>(name: String)(data: FormData): FailFast[String] =
  data.<span class="fu">get</span>(name).
    <span class="fu">toRight</span>(List(s<span class="st">&quot;$name field not specified&quot;</span>))</code></pre></div>
<p>We can create and use an instance of <code>getValue</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> getName = <span class="fu">getValue</span>(<span class="st">&quot;name&quot;</span>) _
<span class="co">// getName: FormData =&gt; FailFast[String] = &lt;function1&gt;</span>

<span class="fu">getName</span>(Map(<span class="st">&quot;name&quot;</span> -&gt; <span class="st">&quot;Dade Murphy&quot;</span>))
<span class="co">// res29: FailFast[String] = Right(Dade Murphy)</span></code></pre></div>
<p>In the event of a missing field, our instance returns an error message containing an appropriate field name:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">getName</span>(Map())
<span class="co">// res30: FailFast[String] = Left(List(name field not specified))</span></code></pre></div>
</div>
<p>Next define a method <code>parseInt</code> that consumes a <code>String</code> and parses it as an <code>Int</code>.</p>
<div class="solution">
<p>We’ll use <code>Either</code> again here. We use <code>Either.catchOnly</code> to consume the <code>NumberFormatException</code> from <code>toInt</code>, and we use <code>leftMap</code> to turn it into an error message:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._ <span class="co">// for catchOnly</span>

<span class="kw">type</span> NumFmtExn = NumberFormatException

<span class="kw">def</span> <span class="fu">parseInt</span>(name: String)(data: String): FailFast[Int] =
  Either.<span class="fu">catchOnly</span>[NumFmtExn](data.<span class="fu">toInt</span>).
    <span class="fu">leftMap</span>(_ =&gt; List(s<span class="st">&quot;$name must be an integer&quot;</span>))</code></pre></div>
<p>Note that our solution accepts an extra parameter to name the field we’re parsing. This is useful for creating better error messages, but it’s fine if you leave it out in your code.</p>
<p>If we provide valid input, <code>parseInt</code> converts it to an <code>Int</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">parseInt</span>(<span class="st">&quot;age&quot;</span>)(<span class="st">&quot;11&quot;</span>)
<span class="co">// res33: FailFast[Int] = Right(11)</span></code></pre></div>
<p>If we provide erroneous input, we get a useful error message:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">parseInt</span>(<span class="st">&quot;age&quot;</span>)(<span class="st">&quot;foo&quot;</span>)
<span class="co">// res34: FailFast[Int] = Left(List(age must be an integer))</span></code></pre></div>
</div>
<p>Next implement the validation checks: <code>nonBlank</code> to check <code>Strings</code>, and <code>nonNegative</code> to check <code>Ints</code>.</p>
<div class="solution">
<p>These definitions use the same patterns as above:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">nonBlank</span>(name: String)(data: String): FailFast[String] =
  <span class="fu">Right</span>(data).
    <span class="fu">ensure</span>(List(s<span class="st">&quot;$name cannot be blank&quot;</span>))(_.<span class="fu">nonEmpty</span>)

<span class="kw">def</span> <span class="fu">nonNegative</span>(name: String)(data: Int): FailFast[Int] =
  <span class="fu">Right</span>(data).
    <span class="fu">ensure</span>(List(s<span class="st">&quot;$name must be non-negative&quot;</span>))(_ &gt;= <span class="dv">0</span>)</code></pre></div>
<p>Here are some examples of use:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">nonBlank</span>(<span class="st">&quot;name&quot;</span>)(<span class="st">&quot;Dade Murphy&quot;</span>)
<span class="co">// res36: FailFast[String] = Right(Dade Murphy)</span>

<span class="fu">nonBlank</span>(<span class="st">&quot;name&quot;</span>)(<span class="st">&quot;&quot;</span>)
<span class="co">// res37: FailFast[String] = Left(List(name cannot be blank))</span>

<span class="fu">nonNegative</span>(<span class="st">&quot;age&quot;</span>)(<span class="dv">11</span>)
<span class="co">// res38: FailFast[Int] = Right(11)</span>

<span class="fu">nonNegative</span>(<span class="st">&quot;age&quot;</span>)(-<span class="dv">1</span>)
<span class="co">// res39: FailFast[Int] = Left(List(age must be non-negative))</span></code></pre></div>
</div>
<p>Now combine <code>getValue</code>, <code>parseInt</code>, <code>nonBlank</code> and <code>nonNegative</code> to create <code>readName</code> and <code>readAge</code>:</p>
<div class="solution">
<p>We use <code>flatMap</code> to combine the rules sequentially:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">readName</span>(data: FormData): FailFast[String] =
  <span class="fu">getValue</span>(<span class="st">&quot;name&quot;</span>)(data).
    <span class="fu">flatMap</span>(<span class="fu">nonBlank</span>(<span class="st">&quot;name&quot;</span>))

<span class="kw">def</span> <span class="fu">readAge</span>(data: FormData): FailFast[Int] =
  <span class="fu">getValue</span>(<span class="st">&quot;age&quot;</span>)(data).
    <span class="fu">flatMap</span>(<span class="fu">nonBlank</span>(<span class="st">&quot;age&quot;</span>)).
    <span class="fu">flatMap</span>(<span class="fu">parseInt</span>(<span class="st">&quot;age&quot;</span>)).
    <span class="fu">flatMap</span>(<span class="fu">nonNegative</span>(<span class="st">&quot;age&quot;</span>))</code></pre></div>
<p>The rules pick up all the error cases we’ve seen so far:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">readName</span>(Map(<span class="st">&quot;name&quot;</span> -&gt; <span class="st">&quot;Dade Murphy&quot;</span>))
<span class="co">// res41: FailFast[String] = Right(Dade Murphy)</span>

<span class="fu">readName</span>(Map(<span class="st">&quot;name&quot;</span> -&gt; <span class="st">&quot;&quot;</span>))
<span class="co">// res42: FailFast[String] = Left(List(name cannot be blank))</span>

<span class="fu">readName</span>(Map())
<span class="co">// res43: FailFast[String] = Left(List(name field not specified))</span>

<span class="fu">readAge</span>(Map(<span class="st">&quot;age&quot;</span> -&gt; <span class="st">&quot;11&quot;</span>))
<span class="co">// res44: FailFast[Int] = Right(11)</span>

<span class="fu">readAge</span>(Map(<span class="st">&quot;age&quot;</span> -&gt; <span class="st">&quot;-1&quot;</span>))
<span class="co">// res45: FailFast[Int] = Left(List(age must be non-negative))</span>

<span class="fu">readAge</span>(Map())
<span class="co">// res46: FailFast[Int] = Left(List(age field not specified))</span></code></pre></div>
</div>
<p>Finally, use a <code>Semigroupal</code> to combine the results of <code>readName</code> and <code>readAge</code> to produce a <code>User</code>. Make sure you switch from <code>Either</code> to <code>Validated</code> to accumulate errors.</p>
<div class="solution">
<p>We can do this by switching from <code>Either</code> to <code>Validated</code> and using apply syntax:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._   <span class="co">// for mapN</span>

<span class="kw">def</span> <span class="fu">readUser</span>(data: FormData): FailSlow[User] =
  (
    <span class="fu">readName</span>(data).<span class="fu">toValidated</span>,
    <span class="fu">readAge</span>(data).<span class="fu">toValidated</span>
  ).<span class="fu">mapN</span>(User.<span class="fu">apply</span>)

<span class="fu">readUser</span>(Map(<span class="st">&quot;name&quot;</span> -&gt; <span class="st">&quot;Dave&quot;</span>, <span class="st">&quot;age&quot;</span> -&gt; <span class="st">&quot;37&quot;</span>))
<span class="co">// res48: FailSlow[User] = Valid(User(Dave,37))</span>

<span class="fu">readUser</span>(Map(<span class="st">&quot;age&quot;</span> -&gt; <span class="st">&quot;-1&quot;</span>))
<span class="co">// res49: FailSlow[User] = Invalid(List(name field not specified, age must be non-negative))</span></code></pre></div>
<p>The need to switch back and forth between <code>Either</code> and <code>Validated</code> is annoying. The choice of whether to use <code>Either</code> or <code>Validated</code> as a default is determined by context. In application code, we typically find areas that favour accumulating semantics and areas that favour fail-fast semantics. We pick the data type that best suits our need and switch to the other as necessary in specific situations.</p>
</div>
<h2 id="apply-and-applicative"><span class="header-section-number">6.5</span> Apply and Applicative</h2>
<p>Semigroupals aren’t mentioned frequently in the wider functional programming literature. They provide a subset of the functionality of a related type class called an <em>applicative functor</em> (“applicative” for short).</p>
<p><code>Semigroupal</code> and <code>Applicative</code> effectively provide alternative encodings of the same notion of joining contexts. Both encodings are introduced in the <a href="http://www.staff.city.ac.uk/~ross/papers/Applicative.html">same 2008 paper</a> by Conor McBride and Ross Paterson<a href="#fn10" class="footnoteRef" id="fnref10"><sup>10</sup></a>.</p>
<p>Cats models applicatives using two type classes. The first, <a href="http://typelevel.org/cats/api/cats/Apply.html"><code>cats.Apply</code></a>, extends <code>Semigroupal</code> and <code>Functor</code> and adds an <code>ap</code> method that applies a parameter to a function within a context. The second, <a href="http://typelevel.org/cats/api/cats/Applicative.html"><code>cats.Applicative</code></a>, extends <code>Apply</code>, adds the <code>pure</code> method introduced in Chapter 4. Here’s a simplified definition in code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Apply[F[_]] <span class="kw">extends</span> Semigroupal[F] <span class="kw">with</span> Functor[F] {
  <span class="kw">def</span> ap[A, B](ff: F[A =&gt; B])(fa: F[A]): F[B]

  <span class="kw">def</span> product[A, B](fa: F[A], fb: F[B]): F[(A, B)] =
    <span class="fu">ap</span>(<span class="fu">map</span>(fa)(a =&gt; (b: B) =&gt; (a, b)))(fb)
}

<span class="kw">trait</span> Applicative[F[_]] <span class="kw">extends</span> Apply[F] {
  <span class="kw">def</span> pure[A](a: A): F[A]
}</code></pre></div>
<p>Breaking this down, the <code>ap</code> method applies a parameter <code>fa</code> to a function <code>ff</code> within a context <code>F[_]</code>. The <code>product</code> method from <code>Semigroupal</code> is defined in terms of <code>ap</code> and <code>map</code>.</p>
<p>Don’t worry too much about the implementation of <code>product</code>—it’s difficult to read and the details aren’t particuarly important. The main point is that there is a tight relationship between <code>product</code>, <code>ap</code>, and <code>map</code> that allows any one of them to be defined in terms of the other two.</p>
<p><code>Applicative</code> also introduces the <code>pure</code> method. This is the same <code>pure</code> we saw in <code>Monad</code>. It constructs a new applicative instance from an unwrapped value. In this sense, <code>Applicative</code> is related to <code>Apply</code> as <code>Monoid</code> is related to <code>Semigroup</code>.</p>
<h3 id="the-hierarchy-of-sequencing-type-classes"><span class="header-section-number">6.5.1</span> The Hierarchy of Sequencing Type Classes</h3>
<p>With the introduction of <code>Apply</code> and <code>Applicative</code>, we can zoom out and see a whole family of type classes that concern themselves with sequencing computations in different ways. Figure 10 shows the relationship between the type classes covered in this book<a href="#fn11" class="footnoteRef" id="fnref11"><sup>11</sup></a>.</p>
<div class="figure">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApQAAAEYCAYAAADiVWYCAAAAAXNSR0IArs4c6QAAM7xJREFUeAHt3Qm8TeX6wPHncMxRmUr8DSFDuIYGIZIGaaKQoaKUoiSly9VIJQ3oflLSpG5RKnNdQ+WiOYrmUWQmucaO+f2v573tbe9z9nGmPazhtz6fY6+9hnf4PqvTs9+13n3ShAUBBJIpYJJZGXXlKJCW4xF5O4D45s0r0UfHO76Jbi/lI+BZgXTPtpyGI+BRAWPIOdwQurS0xOQaxNcN0RVJVHzd0TtagYD7BAq5r0m0CAEEEEAAAQQQQMBLAiSUXooWbUUAAQQQQAABBFwoQELpwqDQJAQQQAABBBBAwEsCJJReihZtRQABBBBAAAEEXChAQunCoNAkBBBAAAEEEEDASwIklF6KFm1FAAEEEEAAAQRcKEBC6cKg0CQEEEAAAQQQQMBLAiSUXooWbUUAAQQQQAABBFwoQELpwqDQJAQQQAABBBBAwEsCJJReihZtRQABBBBAAAEEXChAQunCoNAkBAoisH37djl06FBBioj7uZs2bZJ9+/bFvVwKRAABBBBwhwAJpTviQCsQKJDAli1b5JprrpHKlSvLMcccI2XKlJF27drJl19+WaByZ86cWaDz9eSMjAw58cQTZeDAgQUuiwIOC4wZM8b+vWr9m9WRP+eee+7hgxKwtnz5cvntt98SUDJFIoCAlwXSvdx42o4AAiJr1qyRZs2ayXHHHSfPPvusNGrUSHbu3CkTJ06UwYMHyzvvvJMvJh3l7NKli+zdu9cmLPkqxDmpRIkScuedd0rr1q3zWwTnZSNQrly5LB8aihcvns3R8dn88MMPS8eOHaVatWrxKZBSEEDAFwIklL4II50IssCQIUPsqOSnn34qJUuWDFM88sgj4fX8rGzYsEH279+fn1OznDNs2LAs29hQcIFChQrZUemCl5T7EhidzL0VRyIQJAFueQcp2vTVdwJ//PGHvPrqqzJixIioZDJzRw8cOCCjRo2SOnXqSKlSpaRNmzayatUqe9i8efPksssuk7feekvq1q0rNWrUkI8++ki6du1q9+ux+qMjlbpMmzZNmjRpIieccIKceuqpsmjRIrtd/9F26MiV/lx66aWiSakubdu2lZdfftmu59QWHRV94YUXpEGDBjZR7tOnj+g5LLkXeOKJJ6RTp05RJ5xzzjny4osv2m0DBgyQp556Sm688UapVKmSVK1aVV555ZXw8Rpr/aCi10LFihXlwgsvlJ9++smOTOot7+HDh9trQq8dXX799Vcbbz22SpUq0q9fP9mxY4fdF+v6sjv4BwEEEEAAAQTyLWDiuSxYsMA4LTHOqNERi9X9t99+u3FujxvneUtz/vnnm8svv9yeM2PGDOM8d2kuuugi49weN59//rlxEgrz5ptvhstevXq1cW6Bm//85z/GuYVttF59/9lnnxkniTAbN260+8qXL2+cCTi23MWLF5vdu3fb9Xr16pnx48fb9ZzaUrhwYTNy5Eizbds2s2TJEuMkwMZJhOy58fxH3fIdxexPjGcTj1jW6NGjzdFHH23mzp0b9XPw4EHz4IMPmpYtW0ad37BhQzNu3Di7rUePHsZ53tY4yZ6N0UMPPWScW+XG+YBi9998883G+dBgnA8dNs5z5syx19i6detMhQoVzJNPPmn0mtD4/vnnn6Z69epm6NChxnle1l4TrVq1Ms5tcVtWrOsrqmEJepOg+GYfefYggAACCCCQRIG4/u9z1qxZNunbvHlznsp1nq+0SYCepP/DL1asmMlchiaEjotNKEKFO6OWpn379uaTTz4J/zjPb5rXXnvNLFy40CYlzoipTUhD5+hrZEIZuV3XM7dFk9vIpUOHDsaZ0BO5KS7r2rcExD0ubctNIZpQpqenG2eUOOpHPwzkJqHs27dvuBrnmVvjTOwxH3zwgXFGg+31MHv27PD+yJXjjz/exju0TT94HHvsscZ5PCK0yYSuy/Xr12d7fYUPTtBKguKbgEuGIhHwhwDPUPojjvQioAInn3yy7flXX31lZ3UficEZVZRJkybJypUrxRlRjPoaH50444w8Hel0u2/t2rXiJJ8yffr08LF6K7VWrVp2YtDYsWPlvvvukxtuuMHOOn/00UelSJEi4WNDK0dqS+iY0KvOWOcrh0Ia0a9OIifOKHH0xny8O+qoo+zEK3XWa0NveevM/Nwsej3pbW4nuQ0fftppp9n10GMVub2+wgWwggACnhM4/BvAc02nwQggoM+4nX766fbZxbPPPjvLbGxn8Mdu02cSH3vsMfsMnT73OHXq1Hx9jU/NmjXts5r6PGasRZ/J0x/ntrlcfPHF4txmFX0GMnKJV1siy2Q9WkCTeOd2dPTGXL7TbwsoWrSo/Wqg+vXr53iWPn+pz8o6t9rFeVzBHv/FF1/YV93njHznWAYHIICA9wWYlOP9GNKDAAvo9w8+/fTTsmzZMtGRQue2s/0f+HfffWcTxtB3Ejq3r6VFixaiI0c6wWX+/Pk5qoVGLHVWr45a6XL99dfbyTWhiTi7du0S53k60clBzvN1snTpUnucfnVR2bJl7fdh2g0R/+SnLRGns5oLAR251lFr5xlU+yX3b7zxhqxYsSIXZ4odaXSesZT7779f/vvf/9pzdGKNfkjQRa8L5/lJO+nGeX5SLrjgApuA6rcK6AcYnbyj35F53nnnJX0Gum0g/yCAQEoESChTwk6lCMRPoHHjxva7CHX2ts7s1REmHa3Uv04zefJkW5HegtYvKW/atKn9PshTTjklPJqUXUt0xrfO1Haef7QzevW7Lc8880yZMGGC9OzZ0yaM+kXqmrToiJZ+H2bv3r1FR7X0dqkmsM7EnyzF56ctWQphwxEFNMnTpLB58+Z2Nv7HH39sZ2of8aSInfrowv/93//ZH53Nr8mifkDQxZmwY5NNZyKO6IeD0qVLizNpx15fegter0fdFprVH1Esqwgg4GOBNB/3ja4h4EYBnYKQ0HY5s6Pt1+1krkRHJnWffhm2jmzmdtFRSH3GLvOif+JRk9jIZ+f0GE089cu1Yz07GSojv20JnR+P178Mcg+Ru0oTHt/cNeN/R+ltb33mNXOMcltG6NlV/cAQuezZs8eWmblc/atIGvfM2yPPTdZ6guKbrOZTDwKeE4j3L1PPAdBgBJIs4KqEI8l9d1V1CUo4iK9Lopyg+LqkdzQDAfcJcMvbfTGhRQgggAACCCCAgKcESCg9FS4aiwACCCCAAAIIuE+AhNJ9MaFFCCCAAAIIIICApwRIKD0VLhqLAAIIIIAAAgi4T4CE0n0xoUUIIIAAAggggICnBEgoPRUuGosAAggggAACCLhPgITSfTGhRQgggAACCCCAgKcESCg9FS4aiwACCCCAAAIIuE+AhNJ9MaFFCCCAAAIIIICApwRIKD0VLhqLAAIIIIAAAgi4T4CE0n0xoUUIeEJgxYoV9m+De6KxNBIBBBBAIKECJJQJ5aVwBPwrMHToUFm8eHGeO/j111/LN998k+fzOAEBBBBAwL0CJJTujQ0tQ8CXAjNmzBBNKlkQQAABBPwjQELpn1jSEwSOKHDmmWfK448/Lk2aNJGTTz5Zvv32W3t87969ZcqUKVK7dm3p37+/7NmzR66//nqpX7++nHTSSfLGG2+Ey73vvvukcuXK0rZtW/n555/t9rfeesueFzpIz503b559u2DBAmnatKmt8+qrr7b1PP300zJ8+HBp37596BRekySgifyVV14pXbp0kZo1a8rbb78t3bp1szHt0aOHGGNk7969MnDgQGnYsKFUq1ZNFi1aZFs3YcIEGTVqlHTo0MFuHzx4cJJaTTUIIIAAAgggkFnA+X92apbSpUub6dOn28rHjx9vLrroIrt+8cUXm3PPPdesWrXK7Nq1y4wYMcL07dvX7nNuTZuKFSvafU5yaOrUqWPWrVtnnKTDnHrqqWbmzJnGSThN9+7dw53q3Lmz3b59+3ZTqVIl88MPP9h9P/30k33t1auXmTx5cvj4VK04gTGZgxOH96nqTq7q/fzzz43zgcBs3rzZ/Pjjj6Z48eJmzpw5xvkQYerWrWvef/99k5GREb5ONL4tWrSwZY8ePdq0bNnSXiN6nTgJqVm6dGmu6k3FQQmKbxwuEYpAwJ8CjFD6M670CoGYAqFRwUsvvVScZCB8zIABA+yoU6lSpezooo5a6qIjmaeffrosXLhQ3n33XTs6dcIJJ0jRokXt8fagbP7R8vV8Jwm1R+gIKEvqBapUqSIVKlSwo88lS5aU5s2bS7FixcT5gCBr1qwRJ8mUjh07yoYNG6RIkSKyevXqcKNbtWoleo3oT7t27aKuofBBrCCAQCAF0gPZazqNQMAFnNHDKAFNHELLvn37bMIYeq/Jg25zRq5Ek5HcLnpOZLm5PY/jkidQqFAhSUtLsxUWLlzY3vLesmWL6AcKjXX16tXl0KFDMRuU+RqKeRAbEUAgMAKMUAYm1HQUAZGtW7dahtmzZ4tzKzMmiXNbU+bOnWv3adLg3Aa1o1g62vjRRx/Z7Zpc/vLLL3ZdR7u+++47u65JZGhES5/VXLZsWbjOjRs32mM0ydTnNFncKeA8jmCfedVnXbt27RrVyND1s2PHDjvD/4wzzojazxsEEAiuACOUwY09PQ+gwK233iorV66U/fv3y9SpU2MK3H333XLVVVfZiTeaNN5+++12goZO4pg0aZK9NVqjRo3wrWy9DVq+fHl7TK1atURviety3HHHyciRI0X360jX0UcfLS+++KK9nTpo0CBb/6xZs0RHyVjcI6Dx0gk6a9eutbfGNbahZcmSJfaxh+XLl0u/fv2kUaNGoV28IoBAwAX+d68j4Ah0H4EkCuj8hCRWd7iqMmXKiDMZw97i1Gfmclp0tq8+Kxm6JRo6PvMt8dB2HbUsUaJE6G34VfurCayWFVpCt8Mzlx3an4zXv+qO9+/AlMU3nmYaL/3RZyxDy5gxY+z1ox8S9DZ4erq7xyMSFN8QB68IIJBJwN2/ETI1lrcIIJB/AX0mTv8nm5tkUmvJ7rjIxDCyNbGSSd2vdWY+J/P7yHJYT72APpaQ+flX51sC7LO0OqLMqHLqY0QLEHCbQLw/nbutf7QHAbcJ+GIEy22o+WlPgkawiG9+gpGAcxIU3wS0lCIR8IcADy/5I470AgEEEEAAAQQQSJkACWXK6KkYAQQQQAABBBDwhwAJpT/iSC8QQAABBBBAAIGUCZBQpoyeihFAAAEEEEAAAX8IkFD6I470AgEEEEAAAQQQSJkACWXK6KkYAQQQQAABBBDwhwAJpT/iSC8QQAABBBBAAIGUCZBQpoyeihFAAAEEEEAAAX8IkFD6I470AgEEEEAAAQQQSJkACWXK6KkYAQQQQAABBBDwhwAJpT/iSC8QQAABBBBAAIGUCZBQpoyeihFAAAEEEEAAAX8IpPmjG/QCAc8IGM+0NBgNjffvQOLrrusm3vF1V+9oDQIIIIAAAgj8TyBjSu3WuyfX2pLxaq2zMMmfQMbrtdpYQ+c1fyVwFgIIIIAAAggg4HEBksr8B5BkMv92nIkAAggggAACPhMgqcx7QEkm827GGQgggAACCCDgcwGSytwHmGQy91YciQACCCCAAAIBEyCpzDngJJM5G3EEAggggAACCARcwCaVr9b6QxOngFNk6T7JZBYSNiCAAAIIIIAAArEFSJyyumCS1YQtCCCAAAIIIIDAEQVIoA7zYHHYgjUEEEAAAQQQQCBPAiRSIhjk6ZLhYAQQQAABBBBAIKtAkBOqIPc965XAFgQQQAABBBBAoAACQUysgtjnAlwinIoAAggggAACCOQsEKQEK0h9zTnyHIEAAggggAACCMRRIAiJVhD6GMdLgqIQQAABBBBAAIG8C/g54fJz3/Ieac5AAAEEEEAAAQQSKODHxMuPfUrgJUDRCCCAAAIIIIBAwQX8lID5qS8FjywlIIAAAggggAACSRTwQyLmhz4kMeRUhQACCCCAAAIIxF/AywmZl9se/0hSIgIIIIAAAgggkEIBLyZmXmxzCkNM1QgggAACCCCAQOIFvJSgeamtiY8cNSCAgNcF0rzeAdqPAAKuFjCubl3wGsfv/ODFnB4jkBSB9KTUQiUIIBBYAWPIKd0Q/LQ0ckk3xIE2IOBXgUJ+7Rj9QgABBBBAAAEEEEiOAAllcpypBQEEEEAAAQQQ8K0ACaVvQ0vHEEAAAQQQQACB5AiQUCbHmVoQQAABBBBAAAHfCpBQ+ja0dAwBBBBAAAEEEEiOAAllcpypBQEEEEAAAQQQ8K0ACaVvQ0vHEEAAAQQQQACB5AiQUCbHmVoQQAABBBBAAAHfCpBQ+ja0dAwBBBBAAAEEEEiOAAllcpypBQEEEEAAAQQQ8K0ACaVvQ0vHEEAgWQIffPCBrFmzJlnVUQ8CCCDgOgESSteFhAYhgEAiBFauXCmFChWSK664Iu7F9+3bV95+++24l0uBCCCAgFcESCi9EinaiQACBRJ47rnnpGbNmjJjxgzZvHlzgcriZAQQQACBaAESymgP3iGAgA8FDhw4IC+88IIMHjxYqlatKi+++KIPe0mXEEAAgdQJkFCmzp6aEUAgSQKzZs2SHTt2SPfu3eXaa6+VZ599Vowx4doHDBhgt91yyy1SqVIlqVy5sowfPz7X+0MHbt++XWrXri3vvvtuaJN9veaaa2TUqFFR23iDAAIIIIAAAgggkDsBJ29L/XLeeeeZ3r1724asX7/epKenGyfpCzesR48e5vjjjzdz5841+/btM9OmTTNpaWlm+fLl9pic9terV884Cag99rrrrjPnnHNOuOwVK1aYIkWKmFWrVoW3pWLFCdfhDDp3seMoBBBAAAEEEEDAFQKpyJ2i6vz1119tcujMxA5vv+SSS0yXLl3C7zVhdCbWhN/rSpMmTcwDDzxgt+W0PzKh/O6774wz+cd8/fXX9tzbbrvNdO7c2a6n8h/naiChdMV/EjQCAX8KpPuzW/QKAQQQ+J+A3t7W2d1PPfVU+Da2M0opX375pZ2cU7FixZhU5cuXl02bNsXcpxuz2+8kl3LBBRfI448/Lv/85z/ts5vMAM+WkR0IIOATARJKnwSSbiCAQFaB/fv324TupptuEuc2dNQB/fv3l4kTJ8qQIUOitusbncTz6aefyvnnn59lX2726+QfTSpr1Khhn6ls0aJFzHLYiAACCCCAAAIIIJCzQCrv8po333zTFCtWzGzZsiVLO+655x7jfI2QOXTokNFb2o0bNza///672bVrlxk+fLgpXry4cb6s3J6X0/7IW96hipo1a2afnZw8eXJoU0pfnVBxyzvn65UjEEAgnwLM8s4nHKchgID7BSZMmGBndpcrVy5LY/v06SN66/u9996z+0qVKiVnnXWWOJNz5Pnnn5fp06dLlSpVwufltD984F8rvXr1kuOOO06cZzUz7+I9Aggg4DuBNN/1iA4hgICbBHRUzk3tidmWnj17ylFHHSWagO7evVs0eYxcctofeWxo3ZlZLmeffbYMHTo0tCmlr86sda2f3/kpjQKVI+BfAZ6h9G9s6RkCCORDIHMymbmInPbr8cuWLZOPPvpIXnvttcyn8x4BBBDwpQAJpS/DSqcQQCAvAnr72/muyGxPyWl/5hMPHjxo/8Rj2bJlM+/iPQIIIOBLAW5/+DKsdAoB1wh44pa3a7QS2BBueScQl6IRQECYlMNFgAACCCCAAAIIIFAgARLKAvFxMgIIIIAAAggggAAJJdcAAggggAACCCCAQIEESCgLxMfJCCCAAAIIIIAAAiSUXAMIIIAAAggggAACBRIgoSwQHycjgAACCCCAAAIIkFByDSCAAAIIIIAAAggUSICEskB8nIwAAggggAACCCBAQsk1gAACCCCAAAIIIFAgARLKAvFxMgIIIIAAAggggAAJJdcAAggggAACCCCAQIEESCgLxMfJCCDgJ4G9e/fKwIEDpWHDhlKtWjVZtGiR7d6ECRNk1KhR0qFDB7t98ODBfuo2fUEAAQQQQAABBFwtYLy0ZGRkmOnTp9smz5w507Ro0cKujx492rRs2dLs2rXL/tSsWdMsXbrUS10zzlWiPywIIIBAQgQYoUwIK4UigIAXBYoXLy4dO3aUDRs2SJEiRWT16tXhbrRq1UpKlSplf9q1aydOQhnexwoCCCAQdIH0oAPQfwQQQCAksGXLFundu7dUqVJFqlevLocOHQrtinrdvn171HveIIAAAkEXYIQy6FcA/UcAgbDA5MmTpUmTJvL0009L165dw9t1ZevWrfb9jh07ZPHixXLGGWdE7ecNAgggEGQBRiiDHH36jgACUQJ6W7tHjx6ydu1aqVChgpQvXz68f8mSJXZSzvLly6Vfv37SqFGj8D5WEEAAgaALpAUdgP4jgEBCBXTiSkIriHfh+/fvF/0pWbJkuOgxY8bI5s2bZeTIkfY2eHq69z6Lp6XZX/f8zg9HlRUEEIingPd+K8az95SFAAIIZBLQyTj6E7mULl1a9u3bJ4UKFbI/kftYRwABBBAQ4dMqVwECCCRSwHMjlInESGXZjFCmUp+6EfC/AJNy/B9jeogAAggggAACCCRUgIQyobwUjgACCCCAAAII+F+AhNL/MaaHCCCAAAIIIIBAQgVIKBPKS+EIIIAAAggggID/BUgo/R9jeogAAggggAACCCRUgIQyobwUjgACCCCAAAII+F+AhNL/MaaHCCCAAAIIIIBAQgVIKBPKS+EIIIAAAggggID/BUgo/R9jeogAAggggAACCCRUgIQyobwUjgACCCCAAAII+F+AhNL/MaaHCCCAAAIIIIBAQgVIKBPKS+EIIIAAAggggID/BdL830V6iAACKRQwKaybqrMK8Ds/qwlbEEAAAQQQQACBwwIZU+tV+3Ny7b8f3uLONW1jxqt1q7uzdbQKAQQQyLsAt7zzbsYZCCDgQoGM12u1ObR3/+dp6eZTFzYvqklpheWTQ+bA0oxXa50VtYM3CCCAAAIIIIAAAqkR0GRy9+RaW/Q1NS3Ie60ZU2q3tm0mqcw7HmcggAACCCCAAALxFPBiMhnqP0llSIJXBBBAAAEEEEAgRQJeTiZDZCSVIQleEUAAAQQQQACBJAv4IZkMkZFUhiR4RQABBBBAAAEEkiTgp2QyRGaTyldr/aF9C23jFQEEEEAAAQQQQCABAn5MJkNMfu5bqI+8IoAAAggggAACKRUIQsIVhD6m9CKicgQQQAABBBAIrkCQEq0g9TW4VzQ9RwABBBBAAIGkCgQxwQpin5N6UVEZAggggAACCARHIMiJVZD7HpwrnJ4igAACCCCAQEIFSKhEMEjoJUbhCCCAAAIIIOBnARKpw9HF4rAFawgggAACCCCAQK4ESKCyMmGS1YQtCCCAAAIIIIBATAESp5gsdiM22duwBwEEEEAAAQQQsAIkTDlfCBjlbMQRCCCAAAIIIBBQARKl3Aceq9xbcSQCCCCAAAIIBESABCnvgcYs72acgQACCCCAAAI+FSAxyn9gscu/HWcigEB8BdLiWxylIYBADgImh/3sTq5AvH8HEt/kxi+n2uId35zqYz8CgRVID2zP6TgCKRIwhpwjRfRR1aalJSbXIL5RzCl7k6j4pqxDVIyAywUKubx9NA8BBBBAAAEEEEDA5QIklC4PEM1DAAEEEEAAAQTcLkBC6fYI0T4EEEAAAQQQQMDlAiSULg8QzUMAAQQQQAABBNwuQELp9gjRPgQQQAABBBBAwOUCJJQuDxDNQwABBBBAAAEE3C5AQun2CNE+BBBAAAEEEEDA5QIklC4PEM1DAAEEEEAAAQTcLkBC6fYI0T4EEEAAAQQQQMDlAiSULg8QzUMAAQQQQAABBNwuQELp9gjRPgSSLPDBBx/ImjVrbK0ZGRmyZcuWhLRg06ZNsm/fvoSUHfRCI2MYdAv6jwACyREgoUyOM7UgEFeBlStXSqFCheSKK66Ia7laWN++feXtt9+25fbu3Vvq1atX4DqWL18uv/32W7gcTVRPPPFEGThwYHgbK7kXaN68uejfqs7888wzz9hCImOYU6mZY6PHa/lNmjSRgwcPxjx9586dUrlyZenevXvM/WxEAIHgCZBQBi/m9NgHAs8995zUrFlTZsyYIZs3b05Yj6699lq56667Clz+ww8/LJ988km4nBIlSsidd94pPXv2DG9jJW8CvXr1krVr10b9XHnllXkrxDk6c2xCBWii+cILL4TeRr0++uijsn79+qhtvEEAgWALkFAGO/703oMCBw4csP+jHzx4sFStWlVefPHFhPXi/PPPj8soYuToZKixw4YNk1atWoXe8ppHgVKlStlRQh0pDP2ULFkyj6VI1Mhx5MktWrSQe+65R3bt2hW5WTZs2CBjxoyxo5hRO3iDAAKBFiChDHT46bwXBWbNmiU7duywtxt1BPHZZ58VY0y4KwMGDLDbbrnlFqlUqZJNNsaPHx/eX6dOHXn//ffl3HPPlTJlykizZs3kyy+/DO+PXBk9enTUbfVff/1VLr74YqlYsaJUr15dNKndu3evaJI7atQo0bI10WnTpo2sWrXK3jLt2LGj6GjX8OHD7fZ58+bZKtq2bSsvv/yyHWXVNuzfvz9c9datW+Wkk06S77//3pY/ZMgQqVGjhk2gu3btmtBR2XAjfLKSn9ho13X0WK+fRx55JErivvvuE42dxji0ZFdHaH9errnQObwigIC3BEgovRUvWouATJgwQTSp0mRQn3HUxG3BggVhGU3GdGTpwgsvlNWrV8u4cePkpptuCieN+vzliBEjbDl6u7xRo0Y2OT106FC4jNCKJq6hSTl79uyRdu3aSe3ate2o1rfffitNmzaVokWL2tufetx7771n69Rb2ppsFi5cWJ566ik56qij5Oabb5ZXXnlFzjzzTFu8TsrZvXu3tG/f3pant+9Di466li1b1j6/edttt8lHH31k+6j9qVu3rvTp0yd0aGBfdeKUJuehn2XLlsW00FvTeY2NFqTP6I4dO1b0Q8W6dets2Zrgv/TSS6K3vCOX7OoIHZOXay50Dq8IIIAAAgggkL2AM5iY/8UZITTORAzjzOINF3LJJZeYLl26hN/36NHDOJMywu91xZlgYR544AG7rUiRIuadd94J7//ll190eNP8+OOPdpszCcc4I5p23UlMzdlnn23Xp02bZo4++mjjjEiGz81uZeLEicYZwQzvPv74481rr70Wfq8rkfX8/e9/D9fjJLamVq1a5l//+pdxZoEbba+TwBjnGUz7M3fuXJOenp6rdkRVmOmN9jn7MOV7T6ZaEvP29NNPN84osTn11FPDP07iHa4s0ja88a+V3MRGyw9dA506dTLOBxd7tl5r/fr1s+vOqLHp1q1b5uLt+8x15HTNxSykgBsTFN98XxiciIDfBdL93kH6h4CfBPT2to4c6ahf6Da2jg7pLWsdbdRb0bGW8uXLi44IxlrKlStnN+v5eps5u0VHQqtUqWJHJGMdo6OkkyZNEh2N2rhxY56+EshJUsRJIsVJau1o5fbt2+0orLZJb4XrrfbQSKnWfccdd0isEdVY7fLrts6dO8uTTz6Zq+4VJDY6GtmgQQNxkkxZuHCh/PzzzzHrzEsdub3mYlbERgQQcKUACaUrw0KjEMgqoImVzrrV29fnnHNO1AH9+/cXZ1RI9FnDzIs+3/bpp5+KTrCJtejtZF10gs+RFt2vtz61PGeEMOpQbddjjz1mJwg5o2YyderUPE3m0ecxO3ToYG/Da0J63XXXSbFixewzfHr7/PLLL7e326Mq5U2uBAoaG/02Ab3m9McZ5Y75oSWvdeT2mstVBzkIAQRcIcAzlK4IA41AIGcBnYyzbds2+3ykToyJ/Mk8Oeezzz6zI3r6jOLIkSPtaGHkd1Y6t43tCN+KFSvsc3I6ySKnhPK8886T4sWLy/33328nAelkHB0l1ToWL14sOiv4tNNOswnn/PnzozpUoUIF+2ylPpP5559/Ru0LvdGEZcqUKfaZwBtvvNFu1tHY66+/XnRGeGiE1blFL6HvWwydy2v2AvGIzb333msnXQ0aNChmRTnVoSfl55qLWRkbEUDAlQIklK4MC41CIKuATsbRL5IO3S6MPEInqeitb50Uo4vOtD7rrLPEeXZRnn/+eZk+fbq9XR06Ryd06O3r+vXr28RSJ8vktJQuXVo0qXWepZRjjz3WzrrW5M55Pk5uuOEGmTlzpp2k07p1aznllFPshJxQmTohRxNRHYnU5CPWogmrtltHUiOT24ceesjORNfJQHrrXvulo6QsuROIR2w09vqYgX6giLXkVIeek59rLlZdbEMAAQQQQAABZyJIopfISTnOdwhmqS40QcL5KyjGGS3Msj83G5y/lJLlMOeWvPn999+NTqqJtTh/HcfoMfldtL3ODPb8np7lPOdi9OyknCydyWFDomOj1R+pjnhcczl0McvuBMWX32EIIJCNQPSDUNkcxGYEEPCmgI74Zbfo7WR9PjE/i34NUOZFn6vUEcTsluxGt7I7PvN2ba+OjLLkXSDRsdEW5VSHHlOQa07PZ0EAAfcKkFC6Nza0DIF8Cejtb70Nnd2iM8Tj8fe5syuf7QhkFuCayyzCewT8J5Dmvy7RIwRcLaC35lzdwKA0zvk+T+1qvH8HEl+XXEAJiq9LekczEHCfAJNy3BcTWoQAAggggAACCHhKgITSU+GisQgggAACCCCAgPsESCjdFxNahAACCCCAAAIIeEqAhNJT4aKxCCCAAAIIIICA+wRIKN0XE1qEAAIIIIAAAgh4SoCE0lPhorEIIIAAAggggID7BEgo3RcTWoQAAggggAACCHhKgITSU+GisQgggAACCCCAgPsE+Es57osJLUIAAQQKJOD8XW1Zv369FCtWTMqUKSMlS5YsUHmcjAACCOQkwAhlTkLsRwABBDwkMH36dPunNe+//37p3Lmz3HXXXUds/ezZs2XXrl32mD///NP+ve05c+ZkOeerr76yf9Lzhx9+yLKPDQgggAAJJdcAAggg4COBQYMGyb///W957rnnpFu3bjn27PHHH5edO3eGj9PRzKFDh8qBAwfC23TljjvukKOOOipqG28QQACBkAAJZUiCVwQCLnDmmWeKJhdNmjSRk08+Wb799lvZunWrNG7cOCwzceJEuffee+37li1bir6vUKGCTJkyRTIyMuS6666Thg0bSqtWrWTJkiXh81hJjkDfvn1lzZo10qdPH5k6dWpUpR9++KG0aNFCqlatKt27d5dDhw7Z0cuPP/5YOnbsKP/4xz/s8cccc4yN3zPPPBM+f968eXZ0sm7duuFtul+vlRNOOEHGjh1rt0+YMEFGjRolHTp0kGrVqsngwYPDx7OCAAIIIIAAAvETMG5dSpcubZzbpbZ548ePNxdddJH5/fffTaVKlcJNHjdunHFGwOz7o48+2jgJgz1m7969Zvjw4aZ///7m4MGDxklqzKmnnho+z40rTkhN/MIaLinlXS1SpIhxkkXbjieeeCIcr4ULF5p169YZ5/lKc9ppp5n58+fbY5zEzzjPW9r13bt3m8qVK5uNGzea6tWrm23bttl4Oh8qzPLly03z5s3N999/b4+dNm2acT5E2Pg7I5fGuW1uRo8ebZwPGnZd39esWdMsXbrUHp/sfxIU33CgWUEAgWgBJuVEe/AOgUALtG/f3vb/0ksvFSdBPKKFjnDdc8894iSi9jgdxXKST7ntttvs+xUrVoiTaNqJIUcsiJ1JEWjTpo2Nhz4DqaOKq1evzrbe4447Tq666ip58MEH7fOY9erVk7/97W9Rx3fq1Em2b98uv/32m5QvX16cJNTu19HpUqVK2fV27dqJk1BKs2bNos7lDQII+E+AhNJ/MaVHCBRYQBOF3CzOaFj4sLS0NOnXr580aNDAbrvzzjtJJsM6qV/RZypff/110UcbNL76geBIiz4zqY8+FC1aVObOnRt1qJ47YMAA2bJlizgj0fZ5y1jl5fY6iiqcNwgg4EkBEkpPho1GI5AYAX1mUkevdOavPm+nz9Pptj/++EPKlSsnv/zyi2jiGGvRRGXRokWio1K6OLdXYx3GthQJ6DOSGhNNEH/++edwK/RDwZ49e8LvQys68qwzxTXmtWrVCm22r998843orO/333/fJpNPPfVUeL9eL7rs2LFDFi9eLMOGDQvvYwUBBPwrQELp39jSMwTyLHDrrbfKypUrRb/HUCd1pKen29m9eruzUaNGUqNGjWxHHXVm8NVXXy2tW7cW5zlKadq0qTjP8OW5DZyQGAF9nEEn31SsWDFqBrdO0NFHHC688EK5++67oyrv1atX1PvQmxNPPNEmjFdeeaWUKFFCqlSpEtplJ2PppBznmUs7Yq3XDQsCCPhfIPZQg//7TQ8RSJWAzk1IVd1HrFe/AHvz5s12BFK/EDty0RGs4sWLR27Kdl2fmyxcuLBNRrM9yAU7/hppjffvQNfGV8l11FBHHjOPMuclvqHQ6XWsXzek101oGTNmjL2GRo4caW+p6weSVC0Jim+qukO9CLheIHX/tbuehgYiECwBHWXS/wlnTiZVIbfJpB4b63zdzpJ6gcjkL7I1eYlv6Dy9VjKXp8nqvn377JejFyrEt9KFrHhFIAgC8f50HgQz+ohAQQRcPYJVkI557dwEjWARX5dcCAmKr0t6RzMQcJ8AHyHdFxNahAACCCCAAAIIeEqAhNJT4aKxCCCAAAIIIICA+wRIKN0XE1qEAAIIIIAAAgh4SoCE0lPhorEIIIAAAggggID7BEgo3RcTWoQAAggggAACCHhKgITSU+GisQgggAACCCCAgPsESCjdFxNahAACCCCAAAIIeEqAhNJT4aKxCCCAAAIIIICA+wRIKN0XE1qEAAIIIIAAAgh4SoCE0lPhorEIIIAAAggggID7BEgo3RcTWoQAAggggAACCHhKgITSU+GisQgggAACCCCAgPsE0tzXJFqEgK8FjK97573Oxft3IPF11zUQ7/i6q3e0BgEEEEAAAQRE/pxc++8Zr9atjkXBBDKm1qumlgUrhbMRQACB/Atwyzv/dpyJAAIFFEgrLJ8cMgeWZrxa66wCFhXY0zNer9Xm0N79n6elm08Di0DHEUAAAQQQQCDYAhlTarfePbnWFpLKvF8HmkxaO+c172dzBgIIIIAAAggg4CMBksq8B5NkMu9mnIEAAggggAACPhcgqcx9gEkmc2/FkQgggAACCCAQMAGSypwDTjKZsxFHIIAAAggggEDABWxS+WqtPzRxCjhFlu6TTGYhYQMCCCCAAAIIIBBbgMQpqwsmWU3YggACCCCAAAIIHFGABOowDxaHLVhDAAEEEEAAAQTyJEAiJYJBni4ZDkYAAQQQQAABBLIKBDmhCnLfs14JbEEAAQQQQAABBAogEMTEKoh9LsAlwqkIIIAAAggggEDOAkFKsILU15wjzxEIIIAAAggggEAcBYKQaAWhj3G8JCgKAQQQQAABBBDIu4CfEy4/9y3vkeYMBBBAAAEEEEAggQJ+TLz82KcEXgIUjQACCCCAAAIIFFzATwmYn/pS8MhSAgIIIIAAAgggkEQBPyRifuhDEkNOVQgggAACCCCAQPwFvJyQebnt8Y8kJSKAAAIIIIAAAikU8GJi5sU2pzDEVI0AAi4XSHN5+2geAgh4W8B4u/m+az2/830XUjqEgDsE0t3RDFqBAAJ+FTCGnNINsU1LI5d0QxxoAwJ+FSjk147RLwQQQAABBBBAAIHkCJBQJseZWhBAAAEEEEAAAd8KkFD6NrR0DAEEEEAAAQQQSI4ACWVynKkFAQQQQAABBBDwrQAJpW9DS8cQQAABBBBAAIHkCJBQJseZWhBAAAEEEEAAAd8KkFD6NrR0DAEEEEAAAQQQSI4ACWVynKkFAQQQQAABBBDwrQAJpW9DS8cQQAABBBBAAIHkCJBQJseZWhBAAAEEEEAAAd8KkFD6NrR0DAEE3Crw4YcfyurVq93aPNqFAAII5FmAhDLPZJyAAAJuF2jevLk0adJEDh48GLOpO3fulMqVK0v37t1j7k/0xn79+sns2bMTXQ3lI4AAAkkTIKFMGjUVIYBAMgWWL18uL7zwQswqH330UVm/fn3MfWxEAAEEEMi7AAll3s04AwEEPCDQokULueeee2TXrl1Rrd2wYYOMGTNGdBSTBQEEEEAgPgIklPFxpBQEEHCZQM+ePaVSpUryyCOPRLXsvvvuk7Zt20qbNm2itv/6669y6aWXSsWKFaVKlSqit6V37Nhhj5k3b5506dLFjng2aNBAjjnmGOnTp48cOHDA7tfXUaNGSZ06daRUqVK27FWrVoXLf/7556V27dpStmxZ6datW5YkN3wgKwgggIBHBUgoPRo4mo0AAkcWKFSokIwdO1ZGjx4t69atswd///338tJLL4ne8o5cMjIypF27dlK/fn07WWb69OnyzTffSK9evexhe/bsEd22adMm0Qk17777rkyZMkUmTZpk9+vt8y1btsh7771nzy9RooQMHjzY7ps/f770799fhg0bJjo6OnDgQNm6dWtk9awjgAACCCCAAAIIHEHApGI5/fTTzfjx423VnTp1Mr1797brl1xyiXFGHu36kCFDjDNaaNfffPNNc+yxx5r9+/fb9/rPrFmzjNMv4ySLZsaMGcYZlQzv05UOHToYJzmM2hZ6M3HiRFO9enX7tnPnzuass84K7bKvDRs2NOPGjYvalug32pcjxIldCCCAQIEE0gt0NicjgAACLhfQ0Ui9Te0kmbJw4UL5+eefs7R45cqV9jZ3evrhX4mnnXaaPS7y1nXkiWXKlJF9+/aFNy1YsMCOWGpZGzduDO/T8y+44ILwcawggAACfhTglrcfo0qfEEAgLFCzZk256aab7M/QoUPtM5LhnX+tVK1a1d6OjvyaoS+++MLu1X05LTqb/Oabb5YbbrjB3vYeMWJE+BR9JnPbtm3h96wggAACfhQgofRjVOkTAghECdx777120sygQYOitofe6Ahi0aJF7QQe59az/PTTT3Ym+HnnnWe/rzJ0XHavixcvFp1VrqOaOkFHn5sMLe3bt7fPW+qkH+eWuji3w235of28IoAAAn4QIKH0QxTpAwIIHFGgdOnScscdd0jx4sVjHqf758yZIzNnzhTnWUpp3Lix6LaXX3455vGZN+rIpJ7btGlTad26tZxyyilSuHBhe1jfvn3l3HPPlbp164rzXKWsXbtWLrvsssxF8B4BBBDwtECap1tP4xFAwO0COtfE7W2Map/O+C5SpIhEPk8ZdUA2b3RkUm9tlytXTtLSsv5q1ZnixYoVi7kvmyLjuvmvNmVtWFxroTAEEAiqAL9cghp5+o1AcgQ8l1AmhyX5tZBQJt+cGhEIkgC3vIMUbfqKAAIIIIAAAggkQICEMgGoFIkAAggggAACCARJgIQySNGmrwgggAACCCCAQAIESCgTgEqRCCCAAAIIIIBAkARIKIMUbfqKAAIIIIAAAggkQICEMgGoFIkAAggggAACCARJgIQySNGmrwgggAACCCCAQAIESCgTgEqRCCCAAAIIIIBAkARIKIMUbfqKAAIIIIAAAggkQICEMgGoFIkAAggggAACCARJgIQySNGmrwgggAACCCCAQAIESCgTgEqRCCCAAAIIIIBAkARIKIMUbfqKAAIIIIAAAggkQICEMgGoFIkAAggggAACCARJIC1InaWvCCCQdAGT9Bqp8EgC/M4/kg77EEAg3wL/D8Ukobmjnv6VAAAAAElFTkSuQmCC" alt="Figure 10: Monad type class hierarchy" id="fig:applicatives:hierarchy" />
<p class="caption">Figure 10: Monad type class hierarchy</p>
</div>
<p>Each type class in the hierarchy represents a particular set of sequencing semantics, introduces a set of characteristic methods, and defines the functionality of its supertypes in terms of them:</p>
<ul>
<li>every monad is an applicative;</li>
<li>every applicative a semigroupal;</li>
<li>and so on.</li>
</ul>
<p>Because of the lawful nature of the relationships between the type classes, the inheritance relationships are constant across all instances of a type class. <code>Apply</code> defines <code>product</code> in terms of <code>ap</code> and <code>map</code>; <code>Monad</code> defines <code>product</code>, <code>ap</code>, and <code>map</code>, in terms of <code>pure</code> and <code>flatMap</code>.</p>
<p>To illustrate this let’s consider two hypothetical data types:</p>
<ul>
<li><p><code>Foo</code> is a monad. It has an instance of the <code>Monad</code> type class that implements <code>pure</code> and <code>flatMap</code> and inherits standard definitions of <code>product</code>, <code>map</code>, and <code>ap</code>;</p></li>
<li><p><code>Bar</code> is an applicative functor. It has an instance of <code>Applicative</code> that implements <code>pure</code> and <code>ap</code> and inherits standard definitions of <code>product</code> and <code>map</code>.</p></li>
</ul>
<p>What can we say about these two data types without knowing more about their implementation?</p>
<p>We know strictly more about <code>Foo</code> than <code>Bar</code>: <code>Monad</code> is a subtype of <code>Applicative</code>, so we can guarantee properties of <code>Foo</code> (namely <code>flatMap</code>) that we cannot guarantee with <code>Bar</code>. Conversely, we know that <code>Bar</code> may have a wider range of behaviours than <code>Foo</code>. It has fewer laws to obey (no <code>flatMap</code>), so it can implement behaviours that <code>Foo</code> cannot.</p>
<p>This demonstrates the classic trade-off of power (in the mathematical sense) versus constraint. The more constraints we place on a data type, the more guarantees we have about its behaviour, but the fewer behaviours we can model.</p>
<p>Monads happen to be a sweet spot in this trade-off. They are flexible enough to model a wide range of behaviours and restrictive enough to give strong guarantees about those behaviours. However, there are situations where monads aren’t the right tool for the job. Sometimes we want Thai food, and burritos just won’t satisfy.</p>
<p>Whereas monads impose a strict <em>sequencing</em> on the computations they model, applicatives and semigroupals impose no such restriction. This puts them in a different sweet spot in the hierarchy. We can use them to represent classes of parallel / independent computations that monads cannot.</p>
<p>We choose our semantics by choosing our data structures. If we choose a monad, we get strict sequencing. If we choose an applicative, we lose the ability to <code>flatMap</code>. This is the trade-off enforced by the consistency laws. So choose your types carefully!</p>
<h2 id="summary-5"><span class="header-section-number">6.6</span> Summary</h2>
<p>While monads and functors are the most widely used sequencing data types we’ve covered in this book, semigroupals and applicatives are the most general. These type classes provide a generic mechanism to combine values and apply functions within a context, from which we can fashion monads and a variety of other combinators.</p>
<p><code>Semigroupal</code> and <code>Applicative</code> are most commonly used as a means of combining independent values such as the results of validation rules. Cats provides the <code>Validated</code> type for this specific purpose, along with apply syntax as a convenient way to express the combination of rules.</p>
<p>We have almost covered all of the functional programming concepts on our agenda for this book. The next chapter covers <code>Traverse</code> and <code>Foldable</code>, two powerful type classes for converting between data types. After that we’ll look at several case studies that bring together all of the concepts from Part I.</p>
<h1 id="sec:foldable-traverse"><span class="header-section-number">7</span> Foldable and Traverse</h1>
<p>In this chapter we’ll look at two type classes that capture iteration over collections:</p>
<ul>
<li><code>Foldable</code> abstracts the familiar <code>foldLeft</code> and <code>foldRight</code> operations;</li>
<li><code>Traverse</code> is a higher-level abstraction that uses <code>Applicatives</code> to iterate with less pain than folding.</li>
</ul>
<p>We’ll start by looking at <code>Foldable</code>, and then examine cases where folding becomes complex and <code>Traverse</code> becomes convenient.</p>
<h2 id="sec:foldable"><span class="header-section-number">7.1</span> Foldable</h2>
<p>The <code>Foldable</code> type class captures the <code>foldLeft</code> and <code>foldRight</code> methods we’re used to in sequences like <code>Lists</code>, <code>Vectors</code>, and <code>Streams</code>. Using <code>Foldable</code>, we can write generic folds that work with a variety of sequence types. We can also invent new sequences and plug them into our code. <code>Foldable</code> gives us great use cases for <code>Monoids</code> and the <code>Eval</code> monad.</p>
<h3 id="folds-and-folding"><span class="header-section-number">7.1.1</span> Folds and Folding</h3>
<p>Let’s start with a quick recap of the general concept of folding. We supply an <em>accumulator</em> value and a <em>binary function</em> to combine it with each item in the sequence:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> show[A](list: List[A]): String =
  list.<span class="fu">foldLeft</span>(<span class="st">&quot;nil&quot;</span>)((accum, item) =&gt; s<span class="st">&quot;$item then $accum&quot;</span>)

<span class="fu">show</span>(Nil)
<span class="co">// res0: String = nil</span>

<span class="fu">show</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res1: String = 3 then 2 then 1 then nil</span></code></pre></div>
<p>The <code>foldLeft</code> method works recursively down the sequence. Our binary function is called repeatedly for each item, the result of each call becoming the accumulator for the next. When we reach the end of the sequence, the final accumulator becomes our final result.</p>
<p>Depending on the operation we’re performing, the order in which we fold may be important. Because of this there are two standard variants of fold:</p>
<ul>
<li><code>foldLeft</code> traverses from “left” to “right” (start to finish);</li>
<li><code>foldRight</code> traverses from “right” to “left” (finish to start).</li>
</ul>
<p>Figure 11 illustrates each direction.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjIwMHB4IiBoZWlnaHQ9IjgwMHB4IiB2aWV3Qm94PSIwIDAgMjIwMCA4MDAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQxLjIgKDM1Mzk3KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5mb2xkPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImZvbGRyaWdodC1zdW0iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzMDcuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICA8ZWxsaXBzZSBpZD0iT3ZhbC0xIiBmaWxsPSIjMDAwMDAwIiBjeD0iMTMxLjY0NjI1OSIgY3k9IjIyLjMxMjkyNTIiIHJ4PSIyMi4zMTI5MjUyIiByeT0iMjIuMzEyOTI1MiI+PC9lbGxpcHNlPgogICAgICAgICAgICA8dGV4dCBpZD0iMSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0Ni44NTcxNDI5IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI2LjAyNDQ4OTgiIHk9IjE0OC44NzA3NDgiPjE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIxIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQ2Ljg1NzE0MjkiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjcuMTQwMTM2MDUiIHk9IjY5My4zMDYxMjIiPjE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0xNTMuOTU5MTg0LDQ0LjYyNTg1MDMgTDIyMC44OTc5NTksMTExLjU2NDYyNiIgaWQ9IkxpbmUiIHN0cm9rZT0iI0Y2QTYyMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0xMDkuMzMzMzMzLDQ0LjYyNTg1MDMgTDQyLjM5NDU1NzgsMTExLjU2NDYyNiIgaWQ9IkxpbmUiIHN0cm9rZT0iI0Y2QTYyMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgIDxlbGxpcHNlIGlkPSJPdmFsLTEiIGZpbGw9IiMwMDAwMDAiIGN4PSIyMzkuODYzOTQ2IiBjeT0iMTMzLjg3NzU1MSIgcng9IjIyLjMxMjkyNTIiIHJ5PSIyMi4zMTI5MjUyIj48L2VsbGlwc2U+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yNjIuMTc2ODcxLDE1Ni4xOTA0NzYgTDMyOS4xMTU2NDYsMjIzLjEyOTI1MiIgaWQ9IkxpbmUiIHN0cm9rZT0iI0Y2QTYyMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yMTcuNTUxMDIsMTU2LjE5MDQ3NiBMMTUwLjYxMjI0NSwyMjMuMTI5MjUyIiBpZD0iTGluZSIgc3Ryb2tlPSIjRjZBNjIzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJzcXVhcmUiPjwvcGF0aD4KICAgICAgICAgICAgPGNpcmNsZSBpZD0iT3ZhbC0xIiBmaWxsPSIjMDAwMDAwIiBjeD0iMzU1Ljg5MTE1NiIgY3k9IjI0NS40NDIxNzciIHI9IjIyLjMxMjkyNTIiPjwvY2lyY2xlPgogICAgICAgICAgICA8cGF0aCBkPSJNMzc4LjIwNDA4MiwyNjcuNzU1MTAyIEw0MzUuMTEyOTc4LDMyNC42NjM5OTkiIGlkPSJMaW5lIiBzdHJva2U9IiNGNkE2MjMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMzMzLjU3ODIzMSwyNjcuNzU1MTAyIEwyNjYuNjM5NDU2LDMzNC42OTM4NzgiIGlkPSJMaW5lIiBzdHJva2U9IiNGNkE2MjMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNNDg4LjY1MzA2MSwzMzQuNjkzODc4IEw0NDQuMDI3MjExLDM3OS4zMTk3MjgiIGlkPSJMaW5lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iMTAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTQ4OC42NTMwNjEsMzM0LjY5Mzg3OCBMNDQ0LjAyNzIxMSwzNzkuMzE5NzI4IiBpZD0iTGluZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0NjYuMzQwMTM2LCAzNTcuMDA2ODAzKSByb3RhdGUoOTAuMDAwMDAwKSB0cmFuc2xhdGUoLTQ2Ni4zNDAxMzYsIC0zNTcuMDA2ODAzKSAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTIyNC4yNDQ4OTgsNDkwLjg4NDM1NCBDMjI0LjI0NDg5OCw1MDMuNTI4Nzg2IDIzNC4zMDQ0MzgsNTE0LjA0MTI3MSAyNDYuNTU3ODIzLDUxNC4wNDEyNyBDMjU4LjgxMTIwOSw1MTQuMDQxMjY5IDMyNC4yNzcwMDYsNTE0LjA0MTI2OSAzMzUuODA5NTI0LDUxNC4wNDEyNjkgQzM0Ny4zNDIwNDIsNTE0LjA0MTI2OSAzNTguMTIyNDQ5LDUyMy44MzQwOCAzNTguMTIyNDQ5LDUzNS41MTAyMDMiIGlkPSJQYXRoLTI1IiBzdHJva2U9IiM0OTkwRTIiIHN0cm9rZS13aWR0aD0iNCI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMzU4LjEyMjQ0OSw0OTAuODg0MzU0IEMzNTguMTIyNDQ5LDUwMy41Mjg3ODYgMzY4LjE4MTk4OSw1MTQuMDQxMjcxIDM4MC40MzUzNzQsNTE0LjA0MTI3IEMzOTIuNjg4NzYsNTE0LjA0MTI2OSA0NTguMTU0NTU3LDUxNC4wNDEyNjkgNDY5LjY4NzA3NSw1MTQuMDQxMjY5IEM0ODEuMjE5NTkzLDUxNC4wNDEyNjkgNDkyLDUyMy44MzQwOCA0OTIsNTM1LjUxMDIwMyIgaWQ9IlBhdGgtMjUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0MjUuMDYxMjI0LCA1MTMuMTk3Mjc4KSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC00MjUuMDYxMjI0LCAtNTEzLjE5NzI3OCkgIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yMjQuMjQ0ODk4LDQ5MC44ODQzNTQgQzIyNC4yNDQ4OTgsNTAzLjUyODc4NiAyMzQuMzA0NDM4LDUxNC4wNDEyNzEgMjQ2LjU1NzgyMyw1MTQuMDQxMjcgQzI1OC44MTEyMDksNTE0LjA0MTI2OSAzMjQuMjc3MDA2LDUxNC4wNDEyNjkgMzM1LjgwOTUyNCw1MTQuMDQxMjY5IEMzNDcuMzQyMDQyLDUxNC4wNDEyNjkgMzU4LjEyMjQ0OSw1MjMuODM0MDggMzU4LjEyMjQ0OSw1MzUuNTEwMjAzIiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTM1OC4xMjI0NDksNDkwLjg4NDM1NCBDMzU4LjEyMjQ0OSw1MDMuNTI4Nzg2IDM2OC4xODE5ODksNTE0LjA0MTI3MSAzODAuNDM1Mzc0LDUxNC4wNDEyNyBDMzkyLjY4ODc2LDUxNC4wNDEyNjkgNDU4LjE1NDU1Nyw1MTQuMDQxMjY5IDQ2OS42ODcwNzUsNTE0LjA0MTI2OSBDNDgxLjIxOTU5Myw1MTQuMDQxMjY5IDQ5Miw1MjMuODM0MDggNDkyLDUzNS41MTAyMDMiIGlkPSJQYXRoLTI1IiBzdHJva2U9IiM0OTkwRTIiIHN0cm9rZS13aWR0aD0iNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDI1LjA2MTIyNCwgNTEzLjE5NzI3OCkgc2NhbGUoLTEsIDEpIHRyYW5zbGF0ZSgtNDI1LjA2MTIyNCwgLTUxMy4xOTcyNzgpICI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMTExLjU2NDYyNiw1OTAuMTc2ODcxIEMxMTEuNTY0NjI2LDYwMi44MjEzMDMgMTIxLjYyNDE2Niw2MTMuMzMzNzg4IDEzMy44Nzc1NTEsNjEzLjMzMzc4NyBDMTQ2LjEzMDkzNiw2MTMuMzMzNzg2IDIxMS41OTY3MzMsNjEzLjMzMzc4NiAyMjMuMTI5MjUyLDYxMy4zMzM3ODYgQzIzNC42NjE3Nyw2MTMuMzMzNzg2IDI0NS40NDIxNzcsNjIzLjEyNjU5NyAyNDUuNDQyMTc3LDYzNC44MDI3MiIgaWQ9IlBhdGgtMjUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0Ij48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yNDUuNDQyMTc3LDU5MC4xNzY4NzEgQzI0NS40NDIxNzcsNjAyLjgyMTMwMyAyNTUuNTAxNzE3LDYxMy4zMzM3ODggMjY3Ljc1NTEwMiw2MTMuMzMzNzg3IEMyODAuMDA4NDg3LDYxMy4zMzM3ODYgMzQ1LjQ3NDI4NCw2MTMuMzMzNzg2IDM1Ny4wMDY4MDMsNjEzLjMzMzc4NiBDMzY4LjUzOTMyMSw2MTMuMzMzNzg2IDM3OS4zMTk3MjgsNjIzLjEyNjU5NyAzNzkuMzE5NzI4LDYzNC44MDI3MiIgaWQ9IlBhdGgtMjUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMTIuMzgwOTUyLCA2MTIuNDg5Nzk1KSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0zMTIuMzgwOTUyLCAtNjEyLjQ4OTc5NSkgIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0wLDY5OC4zOTQ1NTggQy0yLjYwOTYxNTYyZS0xMSw3MTEuMDM4OTkgMTAuMDU5NTM5OCw3MjEuNTUxNDc1IDIyLjMxMjkyNTIsNzIxLjU1MTQ3NCBDMzQuNTY2MzEwNiw3MjEuNTUxNDczIDEwMC4wMzIxMDgsNzIxLjU1MTQ3MyAxMTEuNTY0NjI2LDcyMS41NTE0NzMgQzEyMy4wOTcxNDQsNzIxLjU1MTQ3MyAxMzMuODc3NTUxLDczMS4zNDQyODQgMTMzLjg3NzU1MSw3NDMuMDIwNDA3IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTEzMy44Nzc1NTEsNjk4LjM5NDU1OCBDMTMzLjg3NzU1MSw3MTEuMDM4OTkgMTQzLjkzNzA5MSw3MjEuNTUxNDc1IDE1Ni4xOTA0NzYsNzIxLjU1MTQ3NCBDMTY4LjQ0Mzg2Miw3MjEuNTUxNDczIDIzMy45MDk2NTksNzIxLjU1MTQ3MyAyNDUuNDQyMTc3LDcyMS41NTE0NzMgQzI1Ni45NzQ2OTUsNzIxLjU1MTQ3MyAyNjcuNzU1MTAyLDczMS4zNDQyODQgMjY3Ljc1NTEwMiw3NDMuMDIwNDA3IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMC44MTYzMjcsIDcyMC43MDc0ODMpIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwMC44MTYzMjcsIC03MjAuNzA3NDgzKSAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTI1MS4wMjA0MDgsMzg5LjkxODM2NyBMMjUxLjAyMDQwOCw0MzcuODkxMTU2IiBpZD0iTGluZSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJzcXVhcmUiIHN0cm9rZS1kYXNoYXJyYXk9IjEwLDEwLDEwLDEwIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0xMzEuNjQ2MjU5LDI3OS40NjkzODggTDEzMS42NDYyNTksNTI2LjU4NzU1MyIgaWQ9IkxpbmUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIiBzdHJva2UtZGFzaGFycmF5PSIxMCwxMCwxMCwxMCI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMjEuMTk3Mjc4OSwxNjUuNjczNDY5IEwyMS4xOTcyNzg5LDYzNy4wMzUzNDEiIGlkPSJMaW5lIiBzdHJva2U9IiM0OTkwRTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSIgc3Ryb2tlLWRhc2hhcnJheT0iMTAsMTAsMTAsMTAiPjwvcGF0aD4KICAgICAgICAgICAgPHRleHQgaWQ9IjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDYuODU3MTQyOSIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTE4LjcwNDc2MiIgeT0iMjY0Ljg5Nzk1OSI+MjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDYuODU3MTQyOSIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTE3LjU4OTExNiIgeT0iNTgwLjYyNTg1Ij4yPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iMyIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0Ni44NTcxNDI5IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIyMzYuOTYzMjY1IiB5PSIzNzguNjkzODc4Ij4zPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iMyIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0Ni44NTcxNDI5IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIyMzYuOTYzMjY1IiB5PSI0ODYuOTExNTY1Ij4zPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iMCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0Ni44NTcxNDI5IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI0NTIuMjgyOTkzIiB5PSI0ODYuOTExNTY1Ij4wPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iMyIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0Ni44NTcxNDI5IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIzNDUuMTgwOTUyIiB5PSI1ODAuNjI1ODUiPjM8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSI1IiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQ2Ljg1NzE0MjkiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjIzMi41MDA2OCIgeT0iNjg5Ljk1OTE4NCI+NTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjYiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDYuODU3MTQyOSIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTE5LjgyMDQwOCIgeT0iNzg4LjEzNjA1NCI+NjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IisiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDYuODU3MTQyOSIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzQ5OTBFMiI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzQyLjk0OTY2IiB5PSI0OTEuMzc0MTUiPis8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIrIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQ2Ljg1NzE0MjkiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiM0OTkwRTIiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjIzMC4yNjkzODgiIHk9IjU4MC42MjU4NSI+KzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IisiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDYuODU3MTQyOSIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzQ5OTBFMiI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTE4LjcwNDc2MiIgeT0iNjkyLjE5MDQ3NiI+KzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICAgICAgPGcgaWQ9ImZvbGRsZWZ0LXN1bSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjk5LjAwMDAwMCwgMC4wMDAwMDApIj4KICAgICAgICAgICAgPGVsbGlwc2UgaWQ9Ik92YWwtMSIgZmlsbD0iIzAwMDAwMCIgY3g9IjM4Ny41IiBjeT0iMjQuMjA1NzQ4OSIgcng9IjI0LjIxODc1IiByeT0iMjQuMjA1NzQ4OSI+PC9lbGxpcHNlPgogICAgICAgICAgICA8cGF0aCBkPSJNNDExLjcxODc1LDQ4LjQxMTQ5NzcgTDQ4NC4zNzUsMTIxLjAyODc0NCIgaWQ9IkxpbmUiIHN0cm9rZT0iI0Y2QTYyMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0zNjMuMjgxMjUsNDguNDExNDk3NyBMMjkwLjYyNSwxMjEuMDI4NzQ0IiBpZD0iTGluZSIgc3Ryb2tlPSIjRjZBNjIzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJzcXVhcmUiPjwvcGF0aD4KICAgICAgICAgICAgPGVsbGlwc2UgaWQ9Ik92YWwtMSIgZmlsbD0iIzAwMDAwMCIgY3g9IjUwNC45NjA5MzgiIGN5PSIxNDUuMjM0NDkzIiByeD0iMjQuMjE4NzUiIHJ5PSIyNC4yMDU3NDg5Ij48L2VsbGlwc2U+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik01MjkuMTc5Njg4LDE2OS40NDAyNDIgTDYwMS44MzU5MzgsMjQyLjA1NzQ4OSIgaWQ9IkxpbmUiIHN0cm9rZT0iI0Y2QTYyMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik00ODAuNzQyMTg3LDE2OS40NDAyNDIgTDQwOC4wODU5MzgsMjQyLjA1NzQ4OSIgaWQ9IkxpbmUiIHN0cm9rZT0iI0Y2QTYyMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIj48L3BhdGg+CiAgICAgICAgICAgIDxlbGxpcHNlIGlkPSJPdmFsLTEiIGZpbGw9IiMwMDAwMDAiIGN4PSI2MzAuODk4NDM4IiBjeT0iMjY2LjI2MzIzOCIgcng9IjI0LjIxODc1IiByeT0iMjQuMjA1NzQ4OSI+PC9lbGxpcHNlPgogICAgICAgICAgICA8cGF0aCBkPSJNNjU1LjExNzE4OCwyOTAuNDY4OTg2IEw3MTYuODg2ODcyLDM1Mi4yMDU1MTEiIGlkPSJMaW5lIiBzdHJva2U9IiNGNkE2MjMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNNjA2LjY3OTY4OCwyOTAuNDY4OTg2IEw1MzQuMDIzNDM4LDM2My4wODYyMzMiIGlkPSJMaW5lIiBzdHJva2U9IiNGNkE2MjMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNNzc1LDM2My4wODYyMzMgTDcyNi41NjI1LDQxMS40OTc3MzEiIGlkPSJMaW5lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iMTAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTc3NSwzNjMuMDg2MjMzIEw3MjYuNTYyNSw0MTEuNDk3NzMxIiBpZD0iTGluZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3NTAuNzgxMjUwLCAzODcuMjkxOTgyKSByb3RhdGUoOTAuMDAwMDAwKSB0cmFuc2xhdGUoLTc1MC43ODEyNTAsIC0zODcuMjkxOTgyKSAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTI0Mi4xODc1LDY4OS44NjM4NDMgQzI0Mi4xODc1LDcwMy41ODA5MTIgMjUzLjEwNjI2LDcxNC45ODUxOCAyNjYuNDA2MjUsNzE0Ljk4NTE3OSBDMjc5LjcwNjI0LDcxNC45ODUxNzggMzUwLjc2MzY5OSw3MTQuOTg1MTc4IDM2My4yODEyNSw3MTQuOTg1MTc4IEMzNzUuNzk4ODAxLDcxNC45ODUxNzggMzg3LjUsNzI1LjYwODcyMSAzODcuNSw3MzguMjc1MzM5IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTM4Ny41LDY4OS44NjM4NDMgQzM4Ny41LDcwMy41ODA5MTIgMzk4LjQxODc2LDcxNC45ODUxOCA0MTEuNzE4NzUsNzE0Ljk4NTE3OSBDNDI1LjAxODc0LDcxNC45ODUxNzggNDk2LjA3NjE5OSw3MTQuOTg1MTc4IDUwOC41OTM3NSw3MTQuOTg1MTc4IEM1MjEuMTExMzAxLDcxNC45ODUxNzggNTMyLjgxMjUsNzI1LjYwODcyMSA1MzIuODEyNSw3MzguMjc1MzM5IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ2MC4xNTYyNTAsIDcxNC4wNjk1OTEpIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTQ2MC4xNTYyNTAsIC03MTQuMDY5NTkxKSAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTI0Mi4xODc1LDY4OS44NjM4NDMgQzI0Mi4xODc1LDcwMy41ODA5MTIgMjUzLjEwNjI2LDcxNC45ODUxOCAyNjYuNDA2MjUsNzE0Ljk4NTE3OSBDMjc5LjcwNjI0LDcxNC45ODUxNzggMzUwLjc2MzY5OSw3MTQuOTg1MTc4IDM2My4yODEyNSw3MTQuOTg1MTc4IEMzNzUuNzk4ODAxLDcxNC45ODUxNzggMzg3LjUsNzI1LjYwODcyMSAzODcuNSw3MzguMjc1MzM5IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTM4Ny41LDY4OS44NjM4NDMgQzM4Ny41LDcwMy41ODA5MTIgMzk4LjQxODc2LDcxNC45ODUxOCA0MTEuNzE4NzUsNzE0Ljk4NTE3OSBDNDI1LjAxODc0LDcxNC45ODUxNzggNDk2LjA3NjE5OSw3MTQuOTg1MTc4IDUwOC41OTM3NSw3MTQuOTg1MTc4IEM1MjEuMTExMzAxLDcxNC45ODUxNzggNTMyLjgxMjUsNzI1LjYwODcyMSA1MzIuODEyNSw3MzguMjc1MzM5IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ2MC4xNTYyNTAsIDcxNC4wNjk1OTEpIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTQ2MC4xNTYyNTAsIC03MTQuMDY5NTkxKSAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTEyMS4wOTM3NSw1NzYuMDk2ODIzIEMxMjEuMDkzNzUsNTg5LjgxMzg5MyAxMzIuMDEyNTEsNjAxLjIxODE2IDE0NS4zMTI1LDYwMS4yMTgxNTkgQzE1OC42MTI0OSw2MDEuMjE4MTU4IDIyOS42Njk5NDksNjAxLjIxODE1OCAyNDIuMTg3NSw2MDEuMjE4MTU4IEMyNTQuNzA1MDUxLDYwMS4yMTgxNTggMjY2LjQwNjI1LDYxMS44NDE3MDEgMjY2LjQwNjI1LDYyNC41MDgzMiIgaWQ9IlBhdGgtMjUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0Ij48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yNjYuNDA2MjUsNTc2LjA5NjgyMyBDMjY2LjQwNjI1LDU4OS44MTM4OTMgMjc3LjMyNTAxLDYwMS4yMTgxNiAyOTAuNjI1LDYwMS4yMTgxNTkgQzMwMy45MjQ5OSw2MDEuMjE4MTU4IDM3NC45ODI0NDksNjAxLjIxODE1OCAzODcuNSw2MDEuMjE4MTU4IEM0MDAuMDE3NTUxLDYwMS4yMTgxNTggNDExLjcxODc1LDYxMS44NDE3MDEgNDExLjcxODc1LDYyNC41MDgzMiIgaWQ9IlBhdGgtMjUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMzkuMDYyNTAwLCA2MDAuMzAyNTcxKSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0zMzkuMDYyNTAwLCAtNjAwLjMwMjU3MSkgIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0wLDQ2My41NDAwOTEgQy0yLjgzMjUxMmUtMTEsNDc3LjI1NzE2IDEwLjkxODc2MDIsNDg4LjY2MTQyOCAyNC4yMTg3NSw0ODguNjYxNDI3IEMzNy41MTg3Mzk4LDQ4OC42NjE0MjYgMTA4LjU3NjE5OSw0ODguNjYxNDI2IDEyMS4wOTM3NSw0ODguNjYxNDI2IEMxMzMuNjExMzAxLDQ4OC42NjE0MjYgMTQ1LjMxMjUsNDk5LjI4NDk2OSAxNDUuMzEyNSw1MTEuOTUxNTg4IiBpZD0iUGF0aC0yNSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTE0NS4zMTI1LDQ2My41NDAwOTEgQzE0NS4zMTI1LDQ3Ny4yNTcxNiAxNTYuMjMxMjYsNDg4LjY2MTQyOCAxNjkuNTMxMjUsNDg4LjY2MTQyNyBDMTgyLjgzMTI0LDQ4OC42NjE0MjYgMjUzLjg4ODY5OSw0ODguNjYxNDI2IDI2Ni40MDYyNSw0ODguNjYxNDI2IEMyNzguOTIzODAxLDQ4OC42NjE0MjYgMjkwLjYyNSw0OTkuMjg0OTY5IDI5MC42MjUsNTExLjk1MTU4OCIgaWQ9IlBhdGgtMjUiIHN0cm9rZT0iIzQ5OTBFMiIgc3Ryb2tlLXdpZHRoPSI0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMTcuOTY4NzUwLCA0ODcuNzQ1ODM5KSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0yMTcuOTY4NzUwLCAtNDg3Ljc0NTgzOSkgIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik01MDguNTkzNzUsNDIyLjk5NTQ2MSBMNTA4LjU5Mzc1LDYyMy40Mjk2MTQiIGlkPSJMaW5lIiBzdHJva2U9IiM0OTkwRTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSIgc3Ryb2tlLWRhc2hhcnJheT0iMTAsMTAsMTAsMTAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTM4Ny41LDMwMy4xNzcwMDUgTDM4Ny41LDUwOC4zNzc4NDYiIGlkPSJMaW5lIiBzdHJva2U9IiM0OTkwRTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InNxdWFyZSIgc3Ryb2tlLWRhc2hhcnJheT0iMTAsMTAsMTAsMTAiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTI2Ny42MTcxODgsMTc5LjcyNzY4NSBMMjY3LjYxNzE4OCw0MDAuNjA1MTQ0IiBpZD0iTGluZSIgc3Ryb2tlPSIjNDk5MEUyIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJzcXVhcmUiIHN0cm9rZS1kYXNoYXJyYXk9IjEwLDEwLDEwLDEwIj48L3BhdGg+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIxIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjUwLjgzMjA3MjYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjI1MS4xNTY2MjgiIHk9IjE2MS43NjcwMiI+MTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzcyLjI1MDM3OCIgeT0iMjg2LjQyNjYyNiI+MjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjMiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNDkzLjM0NDEyOCIgeT0iNDA2LjI0NTA4MyI+MzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjEiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjUxLjE1NjYyOCIgeT0iNDUzLjQ0NjI5MyI+MTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzcyLjI1MDM3OCIgeT0iNTU5Ljk1MTU4OSI+MjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjMiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNDkzLjM0NDEyOCIgeT0iNjc5Ljc3MDA0NSI+MzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iOC45NjkxMjgyMSIgeT0iNDUzLjQ0NjI5MyI+MDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjEiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTMwLjA2Mjg3OCIgeT0iNTU5Ljk1MTU4OSI+MTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjMiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjUxLjE1NjYyOCIgeT0iNjc5Ljc3MDA0NSI+MzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IisiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzQ5OTBFMiI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTMwLjA2Mjg3OCIgeT0iNDUzLjQ0NjI5MyI+KzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IisiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzQ5OTBFMiI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjUxLjE1NjYyOCIgeT0iNTU5Ljk1MTU4OSI+KzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IisiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzQ5OTBFMiI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzcyLjI1MDM3OCIgeT0iNjc5Ljc3MDA0NSI+KzwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjYiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNTAuODMyMDcyNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzcyLjI1MDM3OCIgeT0iNzg3LjQ4NTYyOCI+NjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 11: Illustration of foldLeft and foldRight" id="fig:foldable-traverse:fold" />
<p class="caption">Figure 11: Illustration of foldLeft and foldRight</p>
</div>
<p><code>foldLeft</code> and <code>foldRight</code> are equivalent if our binary operation is commutative. For example, we can sum a <code>List[Int]</code> by folding in either direction, using <code>0</code> as our accumulator and addition as our operation:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ + _)
<span class="co">// res2: Int = 6</span>

List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldRight</span>(<span class="dv">0</span>)(_ + _)
<span class="co">// res3: Int = 6</span></code></pre></div>
<p>If we provide a non-commutative operator the order of evaluation makes a difference. For example, if we fold using subtraction, we get different results in each direction:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ - _)
<span class="co">// res4: Int = -6</span>

List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldRight</span>(<span class="dv">0</span>)(_ - _)
<span class="co">// res5: Int = 2</span></code></pre></div>
<h3 id="exercise-reflecting-on-folds"><span class="header-section-number">7.1.2</span> Exercise: Reflecting on Folds</h3>
<p>Try using <code>foldLeft</code> and <code>foldRight</code> with an empty list as the accumulator and <code>::</code> as the binary operator. What results do you get in each case?</p>
<div class="solution">
<p>Folding from left to right reverses the list:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldLeft</span>(List.<span class="fu">empty</span>[Int])((a, i) =&gt; i :: a)
<span class="co">// res6: List[Int] = List(3, 2, 1)</span></code></pre></div>
<p>Folding right to left copies the list, leaving the order intact:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldRight</span>(List.<span class="fu">empty</span>[Int])((i, a) =&gt; i :: a)
<span class="co">// res7: List[Int] = List(1, 2, 3)</span></code></pre></div>
<p>Note that we have to carefully specify the type of the accumulator to avoid a type error. We use <code>List.empty[Int]</code> to avoid inferring the accumulator type as <code>Nil.type</code> or <code>List[Nothing]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldRight</span>(Nil)(_ :: _)
<span class="co">// &lt;console&gt;:13: error: type mismatch;</span>
<span class="co">//  found   : List[Int]</span>
<span class="co">//  required: scala.collection.immutable.Nil.type</span>
<span class="co">//        List(1, 2, 3).foldRight(Nil)(_ :: _)</span>
<span class="co">//                                       ^</span></code></pre></div>
</div>
<h3 id="exercise-scaf-fold-ing-other-methods"><span class="header-section-number">7.1.3</span> Exercise: Scaf-fold-ing Other Methods</h3>
<p><code>foldLeft</code> and <code>foldRight</code> are very general methods. We can use them to implement many of the other high-level sequence operations we know. Prove this to yourself by implementing substitutes for <code>List's</code> <code>map</code>, <code>flatMap</code>, <code>filter</code>, and <code>sum</code> methods in terms of <code>foldRight</code>.</p>
<div class="solution">
<p>Here are the solutions:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> map[A, B](list: List[A])(func: A =&gt; B): List[B] =
  list.<span class="fu">foldRight</span>(List.<span class="fu">empty</span>[B]) { (item, accum) =&gt;
    <span class="fu">func</span>(item) :: accum
  }

<span class="fu">map</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(_ * <span class="dv">2</span>)
<span class="co">// res9: List[Int] = List(2, 4, 6)</span>

<span class="kw">def</span> flatMap[A, B](list: List[A])(func: A =&gt; List[B]): List[B] =
  list.<span class="fu">foldRight</span>(List.<span class="fu">empty</span>[B]) { (item, accum) =&gt;
    <span class="fu">func</span>(item) ::: accum
  }

<span class="fu">flatMap</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(a =&gt; List(a, a * <span class="dv">10</span>, a * <span class="dv">100</span>))
<span class="co">// res10: List[Int] = List(1, 10, 100, 2, 20, 200, 3, 30, 300)</span>

<span class="kw">def</span> filter[A](list: List[A])(func: A =&gt; Boolean): List[A] =
  list.<span class="fu">foldRight</span>(List.<span class="fu">empty</span>[A]) { (item, accum) =&gt;
    <span class="kw">if</span>(<span class="fu">func</span>(item)) item :: accum <span class="kw">else</span> accum
  }

<span class="fu">filter</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(_ % <span class="dv">2</span> == <span class="dv">1</span>)
<span class="co">// res11: List[Int] = List(1, 3)</span></code></pre></div>
<p>We’ve provided two definitions of <code>sum</code>, one using <code>scala.math.Numeric</code> (which recreates the built-in functionality accurately)…</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">math</span>.<span class="fu">Numeric</span>

<span class="kw">def</span> sumWithNumeric[A](list: List[A])
      (<span class="kw">implicit</span> numeric: Numeric[A]): A =
  list.<span class="fu">foldRight</span>(numeric.<span class="fu">zero</span>)(numeric.<span class="fu">plus</span>)

<span class="fu">sumWithNumeric</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res13: Int = 6</span></code></pre></div>
<p>and one using <code>cats.Monoid</code> (which is more appropriate to the content of this book):</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>

<span class="kw">def</span> sumWithMonoid[A](list: List[A])
      (<span class="kw">implicit</span> monoid: Monoid[A]): A =
  list.<span class="fu">foldRight</span>(monoid.<span class="fu">empty</span>)(monoid.<span class="fu">combine</span>)

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

<span class="fu">sumWithMonoid</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res16: Int = 6</span></code></pre></div>
</div>
<h3 id="foldable-in-cats"><span class="header-section-number">7.1.4</span> Foldable in Cats</h3>
<p>Cats’ <code>Foldable</code> abstracts <code>foldLeft</code> and <code>foldRight</code> into a type class. Instances of <code>Foldable</code> define these two methods and inherit a host of derived methods. Cats provides out-of-the-box instances of <code>Foldable</code> for a handful of Scala data types: <code>List</code>, <code>Vector</code>, <code>Stream</code>, and <code>Option</code>.</p>
<p>We can summon instances as usual using <code>Foldable.apply</code> and call their implementations of <code>foldLeft</code> directly. Here is an example using <code>List</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Foldable</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Foldable</span>

<span class="kw">val</span> ints = List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)

Foldable[List].<span class="fu">foldLeft</span>(ints, <span class="dv">0</span>)(_ + _)
<span class="co">// res1: Int = 6</span></code></pre></div>
<p>Other sequences like <code>Vector</code> and <code>Stream</code> work in the same way. Here is an example using <code>Option</code>, which is treated like a sequence of zero or one elements:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Foldable</span>

<span class="kw">val</span> maybeInt = Option(<span class="dv">123</span>)

Foldable[Option].<span class="fu">foldLeft</span>(maybeInt, <span class="dv">10</span>)(_ * _)
<span class="co">// res3: Int = 1230</span></code></pre></div>
<h4 id="folding-right"><span class="header-section-number">7.1.4.1</span> Folding Right</h4>
<p><code>Foldable</code> defines <code>foldRight</code> differently to <code>foldLeft</code>, in terms of the <code>Eval</code> monad:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> foldRight[A, B](fa: F[A], lb: Eval[B])
                     (f: (A, Eval[B]) =&gt; Eval[B]): Eval[B]</code></pre></div>
<p>Using <code>Eval</code> means folding is always <em>stack safe</em>, even when the collection’s default definition of <code>foldRight</code> is not. For example, the default implementation of <code>foldRight</code> for <code>Stream</code> is not stack safe. The longer the stream, the larger the stack requirements for the fold. A sufficiently large stream will trigger a <code>StackOverflowError</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Eval</span>
<span class="kw">import</span> cats.<span class="fu">Foldable</span>

<span class="kw">def</span> bigData = (<span class="dv">1</span> to <span class="dv">100000</span>).<span class="fu">toStream</span>

bigData.<span class="fu">foldRight</span>(0L)(_ + _)
<span class="co">// java.lang.StackOverflowError ...</span></code></pre></div>
<p>Using <code>Foldable</code> forces us to use stack safe operations, which fixes the overflow exception:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">stream</span>._ <span class="co">// for Foldable</span>

<span class="kw">val</span> eval: Eval[Long] =
  Foldable[Stream].
    <span class="fu">foldRight</span>(bigData, Eval.<span class="fu">now</span>(0L)) { (num, eval) =&gt;
      eval.<span class="fu">map</span>(_ + num)
    }

eval.<span class="fu">value</span>
<span class="co">// res7: Long = 5000050000</span></code></pre></div>
<div class="callout callout-info">
<p><em>Stack Safety in the Standard Library</em></p>
<p>Stack safety isn’t typically an issue when using the standard library. The most commonly used collection types, such as <code>List</code> and <code>Vector</code>, provide stack safe implementations of <code>foldRight</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="dv">1</span> to <span class="dv">100000</span>).<span class="fu">toList</span>.<span class="fu">foldRight</span>(0L)(_ + _)
<span class="co">// res8: Long = 5000050000</span>

(<span class="dv">1</span> to <span class="dv">100000</span>).<span class="fu">toVector</span>.<span class="fu">foldRight</span>(0L)(_ + _)
<span class="co">// res9: Long = 5000050000</span></code></pre></div>
<p>We’ve called out <code>Stream</code> because it is an exception to this rule. Whatever data type we’re using, though, it’s useful to know that <code>Eval</code> has our back.</p>
</div>
<h4 id="folding-with-monoids"><span class="header-section-number">7.1.4.2</span> Folding with Monoids</h4>
<p><code>Foldable</code> provides us with a host of useful methods defined on top of <code>foldLeft</code>. Many of these are facsimiles of familiar methods from the standard library: <code>find</code>, <code>exists</code>, <code>forall</code>, <code>toList</code>, <code>isEmpty</code>, <code>nonEmpty</code>, and so on:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Foldable[Option].<span class="fu">nonEmpty</span>(Option(<span class="dv">42</span>))
<span class="co">// res10: Boolean = true</span>

Foldable[List].<span class="fu">find</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(_ % <span class="dv">2</span> == <span class="dv">0</span>)
<span class="co">// res11: Option[Int] = Some(2)</span></code></pre></div>
<p>In addition to these familiar methods, Cats provides two methods that make use of <code>Monoids</code>:</p>
<ul>
<li><p><code>combineAll</code> (and its alias <code>fold</code>) combines all elements in the sequence using their <code>Monoid</code>;</p></li>
<li><p><code>foldMap</code> maps a user-supplied function over the sequence and combines the results using a <code>Monoid</code>.</p></li>
</ul>
<p>For example, we can use <code>combineAll</code> to sum over a <code>List[Int]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

Foldable[List].<span class="fu">combineAll</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res12: Int = 6</span></code></pre></div>
<p>Alternatively, we can use <code>foldMap</code> to convert each <code>Int</code> to a <code>String</code> and concatenate them:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>

Foldable[List].<span class="fu">foldMap</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(_.<span class="fu">toString</span>)
<span class="co">// res13: String = 123</span></code></pre></div>
<p>Finally, we can compose <code>Foldables</code> to support deep traversal of nested sequences:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Monoid</span>

<span class="kw">val</span> ints = List(Vector(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), Vector(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))

(Foldable[List] compose Foldable[Vector]).<span class="fu">combineAll</span>(ints)
<span class="co">// res15: Int = 21</span></code></pre></div>
<h4 id="syntax-for-foldable"><span class="header-section-number">7.1.4.3</span> Syntax for Foldable</h4>
<p>Every method in <code>Foldable</code> is available in syntax form via <a href="http://typelevel.org/cats/api/cats/syntax/package$$foldable$"><code>cats.syntax.foldable</code></a>. In each case, the first argument to the method on <code>Foldable</code> becomes the receiver of the method call:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">foldable</span>._ <span class="co">// for combineAll and foldMap</span>

List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">combineAll</span>
<span class="co">// res16: Int = 6</span>

List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldMap</span>(_.<span class="fu">toString</span>)
<span class="co">// res17: String = 123</span></code></pre></div>
<div class="callout callout-info">
<p><em>Explicits over Implicits</em></p>
<p>Remember that Scala will only use an instance of <code>Foldable</code> if the method isn’t explicitly available on the receiver. For example, the following code will use the version of <code>foldLeft</code> defined on <code>List</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>).<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ + _)
<span class="co">// res18: Int = 6</span></code></pre></div>
<p>whereas the following generic code will use <code>Foldable</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">def</span> sum[F[_]: Foldable](values: F[Int]): Int =
  values.<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ + _)
<span class="co">// sum: [F[_]](values: F[Int])(implicit evidence$1: cats.Foldable[F])Int</span></code></pre></div>
<p>We typically don’t need to worry about this distinction. It’s a feature! We call the method we want and the compiler uses a <code>Foldable</code> when needed to ensure our code works as expected. If we need a stack-safe implementation of <code>foldRight</code>, using <code>Eval</code> as the accumulator is enough to force the compiler to select the method from Cats.</p>
</div>
<h2 id="sec:traverse"><span class="header-section-number">7.2</span> Traverse</h2>
<p><code>foldLeft</code> and <code>foldRight</code> are flexible iteration methods but they require us to do a lot of work to define accumulators and combinator functions. The <code>Traverse</code> type class is a higher level tool that leverages <code>Applicatives</code> to provide a more convenient, more lawful, pattern for iteration.</p>
<h3 id="traversing-with-futures"><span class="header-section-number">7.2.1</span> Traversing with Futures</h3>
<p>We can demonstrate <code>Traverse</code> using the <code>Future.traverse</code> and <code>Future.sequence</code> methods in the Scala standard library. These methods provide <code>Future</code>-specific implementations of the traverse pattern. As an example, suppose we have a list of server hostnames and a method to poll a host for its uptime:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>

<span class="kw">val</span> hostnames = List(
  <span class="st">&quot;alpha.example.com&quot;</span>,
  <span class="st">&quot;beta.example.com&quot;</span>,
  <span class="st">&quot;gamma.demo.com&quot;</span>
)

<span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Future[Int] =
  Future(hostname.<span class="fu">length</span> * <span class="dv">60</span>) <span class="co">// just for demonstration</span></code></pre></div>
<p>Now, suppose we want to poll all of the hosts and collect all of their uptimes. We can’t simply <code>map</code> over <code>hostnames</code> because the result—a <code>List[Future[Int]]</code>—would contain more than one <code>Future</code>. We need to reduce the results to a single <code>Future</code> to get something we can block on. Let’s start by doing this manually using a fold:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> allUptimes: Future[List[Int]] =
  hostnames.<span class="fu">foldLeft</span>(Future(List.<span class="fu">empty</span>[Int])) {
    (accum, host) =&gt;
      <span class="kw">val</span> uptime = <span class="fu">getUptime</span>(host)
      <span class="kw">for</span> {
        accum  &lt;- accum
        uptime &lt;- uptime
      } <span class="kw">yield</span> accum :+ uptime
  }

Await.<span class="fu">result</span>(allUptimes, <span class="fl">1.</span>second)
<span class="co">// res2: List[Int] = List(1020, 960, 840)</span></code></pre></div>
<p>Intuitively, we iterate over <code>hostnames</code>, call <code>func</code> for each item, and combine the results into a list. This sounds simple, but the code is fairly unwieldy because of the need to create and combine <code>Futures</code> at every iteration. We can improve on things greatly using <code>Future.traverse</code>, which is tailor-made for this pattern:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> allUptimes: Future[List[Int]] =
  Future.<span class="fu">traverse</span>(hostnames)(getUptime)

Await.<span class="fu">result</span>(allUptimes, <span class="fl">1.</span>second)
<span class="co">// res3: List[Int] = List(1020, 960, 840)</span></code></pre></div>
<p>This is much clearer and more concise—let’s see how it works. If we ignore distractions like <code>CanBuildFrom</code> and <code>ExecutionContext</code>, the implementation of <code>Future.traverse</code> in the standard library looks like this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> traverse[A, B](values: List[A])
    (func: A =&gt; Future[B]): Future[List[B]] =
  values.<span class="fu">foldLeft</span>(Future(List.<span class="fu">empty</span>[A])) { (accum, host) =&gt;
    <span class="kw">val</span> item = <span class="fu">func</span>(host)
    <span class="kw">for</span> {
      accum &lt;- accum
      item  &lt;- item
    } <span class="kw">yield</span> accum :+ item
  }</code></pre></div>
<p>This is essentially the same as our example code above. <code>Future.traverse</code> is abstracting away the pain of folding and defining accumulators and combination functions. It gives us a clean high-level interface to do what we want:</p>
<ul>
<li>start with a <code>List[A]</code>;</li>
<li>provide a function <code>A =&gt; Future[B]</code>;</li>
<li>end up with a <code>Future[List[B]]</code>.</li>
</ul>
<p>The standard library also provides another method, <code>Future.sequence</code>, that assumes we’re starting with a <code>List[Future[B]]</code> and don’t need to provide an identity function:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Future {
  <span class="kw">def</span> sequence[B](futures: List[Future[B]]): Future[List[B]] =
    <span class="fu">traverse</span>(futures)(identity)

  <span class="co">// etc...</span>
}</code></pre></div>
<p>In this case the intuitive understanding is even simpler:</p>
<ul>
<li>start with a <code>List[Future[A]]</code>;</li>
<li>end up with a <code>Future[List[A]]</code>.</li>
</ul>
<p><code>Future.traverse</code> and <code>Future.sequence</code> solve a very specific problem: they allow us to iterate over a sequence of <code>Futures</code> and accumulate a result. The simplified examples above only work with <code>Lists</code>, but the real <code>Future.traverse</code> and <code>Future.sequence</code> work with any standard Scala collection.</p>
<p>Cats’ <code>Traverse</code> type class generalises these patterns to work with any type of <code>Applicative</code>: <code>Future</code>, <code>Option</code>, <code>Validated</code>, and so on. We’ll approach <code>Traverse</code> in the next sections in two steps: first we’ll generalise over the <code>Applicative</code>, then we’ll generalise over the sequence type. We’ll end up with an extremely valuable tool that trivialises many operations involving sequences and other data types.</p>
<h3 id="traversing-with-applicatives"><span class="header-section-number">7.2.2</span> Traversing with Applicatives</h3>
<p>If we squint, we’ll see that we can rewrite <code>traverse</code> in terms of an <code>Applicative</code>. Our accumulator from the example above:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Future(List.<span class="fu">empty</span>[Int])</code></pre></div>
<p>is equivalent to <code>Applicative.pure</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Applicative</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._   <span class="co">// for Applicative</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">applicative</span>._ <span class="co">// for pure</span>

List.<span class="fu">empty</span>[Int].<span class="fu">pure</span>[Future]</code></pre></div>
<p>Our combinator, which used to be this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">oldCombine</span>(
  accum : Future[List[Int]],
  host  : String
): Future[List[Int]] = {
  <span class="kw">val</span> uptime = <span class="fu">getUptime</span>(host)
  <span class="kw">for</span> {
    accum  &lt;- accum
    uptime &lt;- uptime
  } <span class="kw">yield</span> accum :+ uptime
}</code></pre></div>
<p>is now equivalent to <code>Semigroupal.combine</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._ <span class="co">// for mapN</span>

<span class="co">// Combining accumulator and hostname using an Applicative:</span>
<span class="kw">def</span> <span class="fu">newCombine</span>(accum: Future[List[Int]],
      host: String): Future[List[Int]] =
  (accum, <span class="fu">getUptime</span>(host)).<span class="fu">mapN</span>(_ :+ _)</code></pre></div>
<p>By substituting these snippets back into the definition of <code>traverse</code> we can generalise it to to work with any <code>Applicative</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>

<span class="kw">def</span> listTraverse[F[_]: Applicative, A, B]
      (list: List[A])(func: A =&gt; F[B]): F[List[B]] =
  list.<span class="fu">foldLeft</span>(List.<span class="fu">empty</span>[B].<span class="fu">pure</span>[F]) { (accum, item) =&gt;
    (accum, <span class="fu">func</span>(item)).<span class="fu">mapN</span>(_ :+ _)
  }

<span class="kw">def</span> listSequence[F[_]: Applicative, B]
      (list: List[F[B]]): F[List[B]] =
  <span class="fu">listTraverse</span>(list)(identity)</code></pre></div>
<p>We can use <code>listTraverse</code> to re-implement our uptime example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> totalUptime = <span class="fu">listTraverse</span>(hostnames)(getUptime)

Await.<span class="fu">result</span>(totalUptime, <span class="fl">1.</span>second)
<span class="co">// res11: List[Int] = List(1020, 960, 840)</span></code></pre></div>
<p>or we can use it with with other <code>Applicative</code> data types as shown in the following exercises.</p>
<h4 id="exercise-traversing-with-vectors"><span class="header-section-number">7.2.2.1</span> Exercise: Traversing with Vectors</h4>
<p>What is the result of the following?</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Applicative</span>

<span class="fu">listSequence</span>(List(Vector(<span class="dv">1</span>, <span class="dv">2</span>), Vector(<span class="dv">3</span>, <span class="dv">4</span>)))</code></pre></div>
<div class="solution">
<p>The argument is of type <code>List[Vector[Int]]</code>, so we’re using the <code>Applicative</code> for <code>Vector</code> and the return type is going to be <code>Vector[List[Int]]</code>.</p>
<p><code>Vector</code> is a monad, so its semigroupal <code>combine</code> function is based on <code>flatMap</code>. We’ll end up with a <code>Vector</code> of <code>Lists</code> of all the possible combinations of <code>List(1, 2)</code> and <code>List(3, 4)</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">listSequence</span>(List(Vector(<span class="dv">1</span>, <span class="dv">2</span>), Vector(<span class="dv">3</span>, <span class="dv">4</span>)))
<span class="co">// res14: scala.collection.immutable.Vector[List[Int]] = Vector(List(1, 3), List(1, 4), List(2, 3), List(2, 4))</span></code></pre></div>
</div>
<p>What about a list of three parameters?</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">listSequence</span>(List(Vector(<span class="dv">1</span>, <span class="dv">2</span>), Vector(<span class="dv">3</span>, <span class="dv">4</span>), Vector(<span class="dv">5</span>, <span class="dv">6</span>)))</code></pre></div>
<div class="solution">
<p>With three items in the input list, we end up with combinations of three <code>Ints</code>: one from the first item, one from the second, and one from the third:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">listSequence</span>(List(Vector(<span class="dv">1</span>, <span class="dv">2</span>), Vector(<span class="dv">3</span>, <span class="dv">4</span>), Vector(<span class="dv">5</span>, <span class="dv">6</span>)))
<span class="co">// res16: scala.collection.immutable.Vector[List[Int]] = Vector(List(1, 3, 5), List(1, 3, 6), List(1, 4, 5), List(1, 4, 6), List(2, 3, 5), List(2, 3, 6), List(2, 4, 5), List(2, 4, 6))</span></code></pre></div>
</div>
<h4 id="exercise-traversing-with-options"><span class="header-section-number">7.2.2.2</span> Exercise: Traversing with Options</h4>
<p>Here’s an example that uses <code>Options</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">option</span>._ <span class="co">// for Applicative</span>

<span class="kw">def</span> <span class="fu">process</span>(inputs: List[Int]) =
  <span class="fu">listTraverse</span>(inputs)(n =&gt; <span class="kw">if</span>(n % <span class="dv">2</span> == <span class="dv">0</span>) Some(n) <span class="kw">else</span> None)</code></pre></div>
<p>What is the return type of this method? What does it produce for the following inputs?</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">process</span>(List(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>))
<span class="fu">process</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</code></pre></div>
<div class="solution">
<p>The arguments to <code>listTraverse</code> are of types <code>List[Int]</code> and <code>Int =&gt; Option[Int]</code>, so the return type is <code>Option[List[Int]]</code>. Again, <code>Option</code> is a monad, so the semigroupal <code>combine</code> function follows from <code>flatMap</code>. The semantics are therefore fail-fast error handling: if all inputs are even, we get a list of outputs. Otherwise we get <code>None</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">process</span>(List(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>))
<span class="co">// res20: Option[List[Int]] = Some(List(2, 4, 6))</span>

<span class="fu">process</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res21: Option[List[Int]] = None</span></code></pre></div>
</div>
<h4 id="exercise-traversing-with-validated"><span class="header-section-number">7.2.2.3</span> Exercise: Traversing with Validated</h4>
<p>Finally, here is an example that uses <code>Validated</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Monoid</span>

<span class="kw">type</span> ErrorsOr[A] = Validated[List[String], A]

<span class="kw">def</span> <span class="fu">process</span>(inputs: List[Int]): ErrorsOr[List[Int]] =
  <span class="fu">listTraverse</span>(inputs) { n =&gt;
    <span class="kw">if</span>(n % <span class="dv">2</span> == <span class="dv">0</span>) {
      Validated.<span class="fu">valid</span>(n)
    } <span class="kw">else</span> {
      Validated.<span class="fu">invalid</span>(List(s<span class="st">&quot;$n is not even&quot;</span>))
    }
  }</code></pre></div>
<p>What does this method produce for the following inputs?</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">process</span>(List(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>))
<span class="fu">process</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</code></pre></div>
<div class="solution">
<p>The return type here is <code>ErrorsOr[List[Int]]</code>, which expands to <code>Validated[List[String], List[Int]]</code>. The semantics for semigroupal <code>combine</code> on validated are accumulating error handling, so the result is either a list of even <code>Ints</code>, or a list of errors detailing which <code>Ints</code> failed the test:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">process</span>(List(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>))
<span class="co">// res26: ErrorsOr[List[Int]] = Valid(List(2, 4, 6))</span>

<span class="fu">process</span>(List(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))
<span class="co">// res27: ErrorsOr[List[Int]] = Invalid(List(1 is not even, 3 is not even))</span></code></pre></div>
</div>
<h3 id="traverse-in-cats"><span class="header-section-number">7.2.3</span> Traverse in Cats</h3>
<p>Our <code>listTraverse</code> and <code>listSequence</code> methods work with any type of <code>Applicative</code>, but they only work with one type of sequence: <code>List</code>. We can generalise over different sequence types using a type class, which brings us to Cats’ <code>Traverse</code>. Here’s the abbreviated definition:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">trait</span> Traverse[F[_]] {
  <span class="kw">def</span> traverse[G[_]: Applicative, A, B]
      (inputs: F[A])(func: A =&gt; G[B]): G[F[B]]

  <span class="kw">def</span> sequence[G[_]: Applicative, B]
      (inputs: F[G[B]]): G[F[B]] =
    <span class="fu">traverse</span>(inputs)(identity)
}</code></pre></div>
<p>Cats provides instances of <code>Traverse</code> for <code>List</code>, <code>Vector</code>, <code>Stream</code>, <code>Option</code>, <code>Either</code>, and a variety of other types. We can summon instances as usual using <code>Traverse.apply</code> and use the <code>traverse</code> and <code>sequence</code> methods as described in the previous section:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Traverse</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Applicative</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Traverse</span>

<span class="kw">val</span> totalUptime: Future[List[Int]] =
  Traverse[List].<span class="fu">traverse</span>(hostnames)(getUptime)

Await.<span class="fu">result</span>(totalUptime, <span class="fl">1.</span>second)
<span class="co">// res1: List[Int] = List(1020, 960, 840)</span>

<span class="kw">val</span> numbers = List(Future(<span class="dv">1</span>), Future(<span class="dv">2</span>), Future(<span class="dv">3</span>))

<span class="kw">val</span> numbers2: Future[List[Int]] =
  Traverse[List].<span class="fu">sequence</span>(numbers)

Await.<span class="fu">result</span>(numbers2, <span class="fl">1.</span>second)
<span class="co">// res3: List[Int] = List(1, 2, 3)</span></code></pre></div>
<p>There are also syntax versions of the methods, imported via <a href="http://typelevel.org/cats/api/cats/syntax/package$$traverse$"><code>cats.syntax.traverse</code></a>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">traverse</span>._ <span class="co">// for sequence and traverse</span>

Await.<span class="fu">result</span>(hostnames.<span class="fu">traverse</span>(getUptime), <span class="fl">1.</span>second)
<span class="co">// res4: List[Int] = List(1020, 960, 840)</span>

Await.<span class="fu">result</span>(numbers.<span class="fu">sequence</span>, <span class="fl">1.</span>second)
<span class="co">// res5: List[Int] = List(1, 2, 3)</span></code></pre></div>
<p>As you can see, this is much more compact and readable than the <code>foldLeft</code> code we started with earlier this chapter!</p>
<h2 id="summary-6"><span class="header-section-number">7.3</span> Summary</h2>
<p>In this chapter we were introduced to <code>Foldable</code> and <code>Traverse</code>, two type classes for iterating over sequences.</p>
<p><code>Foldable</code> abstracts the <code>foldLeft</code> and <code>foldRight</code> methods we know from collections in the standard library. It adds stack-safe implementations of these methods to a handful of extra data types, and defines a host of situationally useful additions. That said, <code>Foldable</code> doesn’t introduce much that we didn’t already know.</p>
<p>The real power comes from <code>Traverse</code>, which abstracts and generalises the <code>traverse</code> and <code>sequence</code> methods we know from <code>Future</code>. Using these methods we can turn an <code>F[G[A]]</code> into a <code>G[F[A]]</code> for any <code>F</code> with an instance of <code>Traverse</code> and any <code>G</code> with an instance of <code>Applicative</code>. In terms of the reduction we get in lines of code, <code>Traverse</code> is one of the most powerful patterns in this book. We can reduce <code>folds</code> of many lines down to a single <code>foo.traverse</code>.</p>
<hr />
<p>…and with that, we’ve finished all of the theory in this book. There’s plenty more to come, though, as we put everything we’ve learned into practice in a series of in-depth case studies in Part II!</p>
<p> </p>
<h1 id="sec:case-studies:testing"><span class="header-section-number">8</span> Case Study: Testing Asynchronous Code</h1>
<p>We’ll start with a straightforward case study: how to simplify unit tests for asynchronous code by making them synchronous.</p>
<p>Let’s return to the example from Chapter 7 where we’re measuring the uptime on a set of servers. We’ll flesh out the code into a more complete structure. There will be two components. The first is an <code>UptimeClient</code> that polls remote servers for their uptime:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Future</span>

<span class="kw">trait</span> UptimeClient {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Future[Int]
}</code></pre></div>
<p>We’ll also have an <code>UptimeService</code> that maintains a list of servers and allows the user to poll them for their total uptime:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Applicative</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Traverse</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">traverse</span>._  <span class="co">// for traverse</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>

<span class="kw">class</span> <span class="fu">UptimeService</span>(client: UptimeClient) {
  <span class="kw">def</span> <span class="fu">getTotalUptime</span>(hostnames: List[String]): Future[Int] =
    hostnames.<span class="fu">traverse</span>(client.<span class="fu">getUptime</span>).<span class="fu">map</span>(_.<span class="fu">sum</span>)
}</code></pre></div>
<p>We’ve modelled <code>UptimeClient</code> as a trait because we’re going to want to stub it out in unit tests. For example, we can write a test client that allows us to provide dummy data rather than calling out to actual servers:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">class</span> <span class="fu">TestUptimeClient</span>(hosts: Map[String, Int]) <span class="kw">extends</span> UptimeClient {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Future[Int] =
    Future.<span class="fu">successful</span>(hosts.<span class="fu">getOrElse</span>(hostname, <span class="dv">0</span>))
}</code></pre></div>
<p>Now, suppose we’re writing unit tests for <code>UptimeService</code>. We want to test its ability to sum values, regardless of where it is getting them from. Here’s an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">testTotalUptime</span>() = {
  <span class="kw">val</span> hosts    = Map(<span class="st">&quot;host1&quot;</span> -&gt; <span class="dv">10</span>, <span class="st">&quot;host2&quot;</span> -&gt; <span class="dv">6</span>)
  <span class="kw">val</span> client   = <span class="kw">new</span> <span class="fu">TestUptimeClient</span>(hosts)
  <span class="kw">val</span> service  = <span class="kw">new</span> <span class="fu">UptimeService</span>(client)
  <span class="kw">val</span> actual   = service.<span class="fu">getTotalUptime</span>(hosts.<span class="fu">keys</span>.<span class="fu">toList</span>)
  <span class="kw">val</span> expected = hosts.<span class="fu">values</span>.<span class="fu">sum</span>
  <span class="fu">assert</span>(actual == expected)
}
<span class="co">// &lt;console&gt;:31: warning: scala.concurrent.Future[Int] and Int are unrelated: they will most likely never compare equal</span>
<span class="co">//          assert(actual == expected)</span>
<span class="co">//                        ^</span>
<span class="co">// error: No warnings can be incurred under -Xfatal-warnings.</span></code></pre></div>
<p>The code doesn’t compile because we’ve made a classic error<a href="#fn12" class="footnoteRef" id="fnref12"><sup>12</sup></a>. We forgot that our application code is asynchronous. Our <code>actual</code> result is of type <code>Future[Int]</code> and out <code>expected</code> result is of type <code>Int</code>. We can’t compare them directly!</p>
<p>There are a couple of ways to solve this problem. We could alter our test code to accommodate the asynchronousness. However, there is another alternative. Let’s make our service code synchronous so our test works without modification!</p>
<h2 id="abstracting-over-type-constructors"><span class="header-section-number">8.1</span> Abstracting over Type Constructors</h2>
<p>We need to implement two versions of <code>UptimeClient</code>: an asynchronous one for use in production and a synchronous one for use in our unit tests:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> RealUptimeClient <span class="kw">extends</span> UptimeClient {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Future[Int]
}

<span class="kw">trait</span> TestUptimeClient <span class="kw">extends</span> UptimeClient {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Int
}</code></pre></div>
<p>The question is: what result type should we give to the abstract method in <code>UptimeClient</code>? We need to abstract over <code>Future[Int]</code> and <code>Int</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> UptimeClient {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): ???
}</code></pre></div>
<p>At first this may seem difficult. We want to retain the <code>Int</code> part from each type but “throw away” the <code>Future</code> part in the test code. Fortunately, Cats provides a solution in terms of the <em>identity type</em>, <code>Id</code>, that we discussed way back in Section 4.3. <code>Id</code> allows us to “wrap” types in a type constructor without changing their meaning:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">package</span> cats

<span class="kw">type</span> Id[A] = A</code></pre></div>
<p><code>Id</code> allows us to abstract over the return types in <code>UptimeClient</code>. Implement this now:</p>
<ul>
<li><p>write a trait definition for <code>UptimeClient</code> that accepts a type constructor <code>F[_]</code> as a parameter;</p></li>
<li><p>extend it with two traits, <code>RealUptimeClient</code> and <code>TestUptimeClient</code>, that bind <code>F</code> to <code>Future</code> and <code>Id</code> respectively;</p></li>
<li><p>write out the method signature for <code>getUptime</code> in each case to verify that it compiles.</p></li>
</ul>
<div class="solution">
<p>Here’s the implementation:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">language</span>.<span class="fu">higherKinds</span>
<span class="kw">import</span> cats.<span class="fu">Id</span>

<span class="kw">trait</span> UptimeClient[F[_]] {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): F[Int]
}

<span class="kw">trait</span> RealUptimeClient <span class="kw">extends</span> UptimeClient[Future] {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Future[Int]
}

<span class="kw">trait</span> TestUptimeClient <span class="kw">extends</span> UptimeClient[Id] {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Id[Int]
}</code></pre></div>
<p>Note that, because <code>Id[A]</code> is just a simple alias for <code>A</code>, we don’t need to refer to the type in <code>TestUptimeClient</code> as <code>Id[Int]</code>—we can simply write <code>Int</code> instead:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> TestUptimeClient <span class="kw">extends</span> UptimeClient[Id] {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Int
}</code></pre></div>
<p>Of course, technically speaking we don’t need to redeclare <code>getUptime</code> in <code>RealUptimeClient</code> or <code>TestUptimeClient</code>. However, writing everything out helps illustrate the technique.</p>
</div>
<p>You should now be able to flesh your definition of <code>TestUptimeClient</code> out into a full class based on a <code>Map[String, Int]</code> as before.</p>
<div class="solution">
<p>The final code is similar to our original implementation of <code>TestUptimeClient</code>, except we no longer need the call to <code>Future.successful</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">class</span> <span class="fu">TestUptimeClient</span>(hosts: Map[String, Int])
  <span class="kw">extends</span> UptimeClient[Id] {
  <span class="kw">def</span> <span class="fu">getUptime</span>(hostname: String): Int =
    hosts.<span class="fu">getOrElse</span>(hostname, <span class="dv">0</span>)
}</code></pre></div>
</div>
<h2 id="abstracting-over-monads"><span class="header-section-number">8.2</span> Abstracting over Monads</h2>
<p>Let’s turn our attention to <code>UptimeService</code>. We need to rewrite it to abstract over the two types of <code>UptimeClient</code>. We’ll do this in two stages: first we’ll rewrite the class and method signatures, then the method bodies. Starting with the method signatures:</p>
<ul>
<li><p>comment out the body of <code>getTotalUptime</code> (replace it with <code>???</code> to make everything compile);</p></li>
<li><p>add a type parameter <code>F[_]</code> to <code>UptimeService</code> and pass it on to <code>UptimeClient</code>.</p></li>
</ul>
<div class="solution">
<p>The code should look like this:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">class</span> UptimeService[F[_]](client: UptimeClient[F]) {
  <span class="kw">def</span> <span class="fu">getTotalUptime</span>(hostnames: List[String]): F[Int] =
    ???
    <span class="co">// hostnames.traverse(client.getUptime).map(_.sum)</span>
}</code></pre></div>
</div>
<p>Now uncomment the body of <code>getTotalUptime</code>. You should get a compilation error similar to the following:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// &lt;console&gt;:28: error: could not find implicit value for</span>
<span class="co">//               evidence parameter of type cats.Applicative[F]</span>
<span class="co">//            hostnames.traverse(client.getUptime).map(_.sum)</span>
<span class="co">//                              ^</span></code></pre></div>
<p>The problem here is that <code>traverse</code> only works on sequences of values that have an <code>Applicative</code>. In our original code we were traversing a <code>List[Future[Int]]</code>. There is an applicative for <code>Future</code> so that was fine. In this version we are traversing a <code>List[F[Int]]</code>. We need to <em>prove</em> to the compiler that <code>F</code> has an <code>Applicative</code>. Do this by adding an implicit constructor parameter to <code>UptimeService</code>.</p>
<div class="solution">
<p>We can write this as an implicit parameter:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Applicative</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">functor</span>._ <span class="co">// for map</span>

<span class="kw">class</span> UptimeService[F[_]](client: UptimeClient[F])
    (<span class="kw">implicit</span> a: Applicative[F]) {

  <span class="kw">def</span> <span class="fu">getTotalUptime</span>(hostnames: List[String]): F[Int] =
    hostnames.<span class="fu">traverse</span>(client.<span class="fu">getUptime</span>).<span class="fu">map</span>(_.<span class="fu">sum</span>)
}</code></pre></div>
<p>or more tersely as a context bound:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">class</span> UptimeService[F[_]: Applicative]
    (client: UptimeClient[F]) {

  <span class="kw">def</span> <span class="fu">getTotalUptime</span>(hostnames: List[String]): F[Int] =
    hostnames.<span class="fu">traverse</span>(client.<span class="fu">getUptime</span>).<span class="fu">map</span>(_.<span class="fu">sum</span>)
}</code></pre></div>
<p>Note that we need to import <code>cats.syntax.functor</code> as well as <code>cats.Applicative</code>. This is because we’re switching from using <code>future.map</code> to the Cats’ generic extension method that requires an implicit <code>Functor</code> parameter.</p>
</div>
<p>Finally, let’s turn our attention to our unit tests. Our test code now works as intended without any modification. We create an instance of <code>TestUptimeClient</code> and wrap it in an <code>UptimeService</code>. This effectively binds <code>F</code> to <code>Id</code>, allowing the rest of the code to operate synchronously without worrying about monads or applicatives:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">testTotalUptime</span>() = {
  <span class="kw">val</span> hosts    = Map(<span class="st">&quot;host1&quot;</span> -&gt; <span class="dv">10</span>, <span class="st">&quot;host2&quot;</span> -&gt; <span class="dv">6</span>)
  <span class="kw">val</span> client   = <span class="kw">new</span> <span class="fu">TestUptimeClient</span>(hosts)
  <span class="kw">val</span> service  = <span class="kw">new</span> <span class="fu">UptimeService</span>(client)
  <span class="kw">val</span> actual   = service.<span class="fu">getTotalUptime</span>(hosts.<span class="fu">keys</span>.<span class="fu">toList</span>)
  <span class="kw">val</span> expected = hosts.<span class="fu">values</span>.<span class="fu">sum</span>
  <span class="fu">assert</span>(actual == expected)
}

<span class="fu">testTotalUptime</span>()</code></pre></div>
<h2 id="summary-7"><span class="header-section-number">8.3</span> Summary</h2>
<p>This case study provides an example of how Cats can help us abstract over different computational scenarios. We used the <code>Applicative</code> type class to abstract over asynchronous and synchronous code. Leaning on a functional abstraction allows us to specify the sequence of computations we want to perform without worrying about the details of the implementation.</p>
<p>Back in Figure 10, we showed a “stack” of computational type classes that are meant for exactly this kind of abstraction. Type classes like <code>Functor</code>, <code>Applicative</code>, <code>Monad</code>, and <code>Traverse</code> provide abstract implementations of patterns such as mapping, zipping, sequencing, and iteration. The mathematical laws on those types ensure that they work together with a consistent set of semantics.</p>
<p>We used <code>Applicative</code> in this case study because it was the least powerful type class that did what we needed. If we had required <code>flatMap</code>, we could have swapped out <code>Applicative</code> for <code>Monad</code>. If we had needed to abstract over different sequence types, we could have used <code>Traverse</code>. There are also type classes like <code>ApplicativeError</code> and <code>MonadError</code> that help model failures as well as successful computations.</p>
<p>Let’s move on now to a more complex case study where type classes will help us produce something more interesting: a map-reduce-style framework for parallel processing.</p>
<h1 id="map-reduce"><span class="header-section-number">9</span> Case Study: Map-Reduce</h1>
<!--
TODO:

- DONE - talk about map-reduce - it's just foldMap
- DONE - introduce/reimplement foldMap
- DONE - implement parallelFoldMap to mimic map-reduce
  - DONE - mention that we're specifically imitating multi-machine
           map-reduce where we need to split data between machines
           in large blocks
  - DONE - implement in terms of our foldMap first
  - DONE - then implement in terms of Cats' foldMap
  - DONE - talk about traverse
- summary
  - DONE - real-world map-reduce has communication costs
  - DONE - multi-cpu map-reduce doesn't have communication costs
  - DONE - parallelFoldMap mimics multi-machine
  - DONE - our final version of parallelFoldMap (based on traverse) is far simpler
  - talk about substitution and the things it doesn't model:
    - performance
    - parallelism
    - side-effects (future starts immediately)
    - etc...

TODO:

- DONE - drop the current foldMapM stuff
- DONE - maybe move it elsewhere
-->
<p>In this case study we’re going to implement a simple-but-powerful parallel processing framework using <code>Monoids</code>, <code>Functors</code>, and a host of other goodies.</p>
<p>If you have used Hadoop or otherwise worked in “big data” you will have heard of <a href="http://research.google.com/archive/map-reduce.html">MapReduce</a>, which is a programming model for doing parallel data processing across clusters of machines (aka “nodes”). As the name suggests, the model is built around a <em>map</em> phase, which is the same <code>map</code> function we know from Scala and the <code>Functor</code> type class, and a <em>reduce</em> phase, which we usually call <code>fold</code><a href="#fn13" class="footnoteRef" id="fnref13"><sup>13</sup></a> in Scala.</p>
<h2 id="parallelizing-map-and-fold"><span class="header-section-number">9.1</span> Parallelizing <em>map</em> and <em>fold</em></h2>
<p>Recall the general signature for <code>map</code> is to apply a function <code>A =&gt; B</code> to a <code>F[A]</code>, returning a <code>F[B]</code>:</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE1NjdweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE1NjcgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MCAoMzM3NjIpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPgogICAgPHRpdGxlPmdlbmVyaWMtbWFwPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMSIgY3g9IjgwIiBjeT0iODAiIHJ4PSI4MCIgcnk9IjgwIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTMiIGN4PSI2MzIiIGN5PSIxNDAiIHJ4PSI4MCIgcnk9IjgwIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTUiIHBvaW50cz0iOTQ1LjU5NTA4NiAxOTQgODkyLjY5NDQxNCAyMjEuODExNTI5IDkwMi43OTc1NDMgMTYyLjkwNTc2NSA4NjAgMTIxLjE4ODQ3MSA5MTkuMTQ0NzUgMTEyLjU5NDIzNSA5NDUuNTk1MDg2IDU5IDk3Mi4wNDU0MjMgMTEyLjU5NDIzNSAxMDMxLjE5MDE3IDEyMS4xODg0NzEgOTg4LjM5MjYzIDE2Mi45MDU3NjUgOTk4LjQ5NTc1OSAyMjEuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzEuMTkwMTczIiBoZWlnaHQ9IjE2Mi44MTE1MjkiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNyIgcG9pbnRzPSI4NS41OTUwODY1IDEzNSAzMi42OTQ0MTM4IDE2Mi44MTE1MjkgNDIuNzk3NTQzMiAxMDMuOTA1NzY1IC0xLjE3MjM5NTUxZS0xMyA2Mi4xODg0NzA1IDU5LjE0NDc1MDEgNTMuNTk0MjM1MyA4NS41OTUwODY1IDAgMTEyLjA0NTQyMyA1My41OTQyMzUzIDE3MS4xOTAxNzMgNjIuMTg4NDcwNSAxMjguMzkyNjMgMTAzLjkwNTc2NSAxMzguNDk1NzU5IDE2Mi44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay04IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC05IiBwb2ludHM9Ijc1NCAxMjAgNzk0IDEyMCA3OTQgMTAwIDgzNCAxMzkuNDk3NzY3IDc5NCAxODAgNzk0IDE2MCA3NTQgMTYwIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTEiIHg9IjE2NCIgeT0iMzciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiByeD0iOCI+PC9yZWN0PgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEzIiB4PSIxMjA0IiB5PSIzNyIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZ2VuZXJpYy1tYXAiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE1NjciIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxODQuMDAwMDAwLCA1Ny4wMDAwMDApIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEiIG1hc2s9InVybCgjbWFzay0yKSIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay00KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay02KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjIwLjAwMDAwMCwgNTcuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiMwMDAwMDAiIHhsaW5rOmhyZWY9IiNwYXRoLTkiPjwvdXNlPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjEwODQgMTIwIDExMjQgMTIwIDExMjQgMTAwIDExNjQgMTM5LjQ5Nzc2NyAxMTI0IDE4MCAxMTI0IDE2MCAxMDg0IDE2MCI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iRltBXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjEzLjYiIHk9IjMxNCI+RltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkZbQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEyNTcuNiIgeT0iMzE0Ij5GW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1CIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI3MjguNCIgeT0iMzE0Ij5BID0mZ3Q7IEI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx1c2UgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMikiIHN0cm9rZS13aWR0aD0iOCIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTQpIiBzdHJva2Utd2lkdGg9IjgiIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICAgICAgPHRleHQgaWQ9Im1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQwNC40IiB5PSIxNTUiPm1hcDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 12: Type chart: functor map" id="fig:map-reduce:functor-type-chart" />
<p class="caption">Figure 12: Type chart: functor map</p>
</div>
<p><code>map</code> transforms each individual element in a sequence independently. We can easily parallelize <code>map</code> because there are no dependencies between the transformations applied to different elements (the type signature of the function <code>A =&gt; B</code> shows us this, assuming we don’t use side-effects not reflected in the types).</p>
<p>What about <code>fold</code>? We can implement this step with an instance of <code>Foldable</code>. Not every functor also has an instance of foldable but we can implement a map-reduce system on top of any data type that has both of these type classes. Our reduction step becomes a <code>foldLeft</code> over the results of the distributed <code>map</code>.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjQwMHB4IiBoZWlnaHQ9IjM2MHB4IiB2aWV3Qm94PSIwIDAgMjQwMCAzNjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQxLjIgKDM1Mzk3KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5nZW5lcmljLWZvbGRsZWZ0PC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMSIgY3g9IjEzNzMiIGN5PSIxNDAiIHJ4PSI4MCIgcnk9IjgwIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTMiIHBvaW50cz0iMjA0Ny41OTUwOSAxOTIgMTk5NC42OTQ0MSAyMTkuODExNTI5IDIwMDQuNzk3NTQgMTYwLjkwNTc2NSAxOTYyIDExOS4xODg0NzEgMjAyMS4xNDQ3NSAxMTAuNTk0MjM1IDIwNDcuNTk1MDkgNTcgMjA3NC4wNDU0MiAxMTAuNTk0MjM1IDIxMzMuMTkwMTcgMTE5LjE4ODQ3MSAyMDkwLjM5MjYzIDE2MC45MDU3NjUgMjEwMC40OTU3NiAyMTkuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzEuMTkwMTczIiBoZWlnaHQ9IjE2Mi44MTE1MjkiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNSIgcG9pbnRzPSIxMTc5LjU5NTA5IDE5NCAxMTI2LjY5NDQxIDIyMS44MTE1MjkgMTEzNi43OTc1NCAxNjIuOTA1NzY1IDEwOTQgMTIxLjE4ODQ3MSAxMTUzLjE0NDc1IDExMi41OTQyMzUgMTE3OS41OTUwOSA1OSAxMjA2LjA0NTQyIDExMi41OTQyMzUgMTI2NS4xOTAxNyAxMjEuMTg4NDcxIDEyMjIuMzkyNjMgMTYyLjkwNTc2NSAxMjMyLjQ5NTc2IDIyMS44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay02IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC03IiBwb2ludHM9IjE2OTIuNTk1MDkgMTk1IDE2MzkuNjk0NDEgMjIyLjgxMTUyOSAxNjQ5Ljc5NzU0IDE2My45MDU3NjUgMTYwNyAxMjIuMTg4NDcxIDE2NjYuMTQ0NzUgMTEzLjU5NDIzNSAxNjkyLjU5NTA5IDYwIDE3MTkuMDQ1NDIgMTEzLjU5NDIzNSAxNzc4LjE5MDE3IDEyMi4xODg0NzEgMTczNS4zOTI2MyAxNjMuOTA1NzY1IDE3NDUuNDk1NzYgMjIyLjgxMTUyOSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTgiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTcxLjE5MDE3MyIgaGVpZ2h0PSIxNjIuODExNTI5IiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTkiIHBvaW50cz0iOTI2LjU5NTA4NiAxOTQgODczLjY5NDQxNCAyMjEuODExNTI5IDg4My43OTc1NDMgMTYyLjkwNTc2NSA4NDEgMTIxLjE4ODQ3MSA5MDAuMTQ0NzUgMTEyLjU5NDIzNSA5MjYuNTk1MDg2IDU5IDk1My4wNDU0MjMgMTEyLjU5NDIzNSAxMDEyLjE5MDE3IDEyMS4xODg0NzEgOTY5LjM5MjYzIDE2Mi45MDU3NjUgOTc5LjQ5NTc1OSAyMjEuODExNTI5Ij48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTcxLjE5MDE3MyIgaGVpZ2h0PSIxNjIuODExNTI5IiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTExIiBwb2ludHM9IjE0OTggMTIwIDE1MzggMTIwIDE1MzggMTAwIDE1NzggMTM5LjQ5Nzc2NyAxNTM4IDE4MCAxNTM4IDE2MCAxNDk4IDE2MCI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xMyIgY3g9IjEyNSIgY3k9IjExOCIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTMiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xNSIgY3g9IjEwMyIgY3k9Ijk4IiByeD0iODAiIHJ5PSI4MCI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE2IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTE3IiBjeD0iODAiIGN5PSI4MCIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xOCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJnZW5lcmljLWZvbGRsZWZ0Ij4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIyNDAwIiBoZWlnaHQ9IjM2MCI+PC9yZWN0PgogICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTIpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTYpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTgpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTEwKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgPHVzZSBpZD0iUGF0aC0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iIzAwMDAwMCIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjE4MjYgMTIwIDE4NjYgMTIwIDE4NjYgMTAwIDE5MDYgMTM5LjQ5Nzc2NyAxODY2IDE4MCAxODY2IDE2MCAxODI2IDE2MCI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iRltBXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzEwLjEiIHk9IjMxNCI+RltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjIwMzYuNCIgeT0iMzE0Ij5CPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iKEIsLUEpLT0mZ3Q7LUIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEzMDMuNCIgeT0iMzE0Ij4oQiwgQSkgPSZndDsgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjkxNy40IiB5PSIzMTQiPkI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjYxLjAwMDAwMCwgNDAuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBtYXNrPSJ1cmwoI21hc2stMTQpIiB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEiIG1hc2s9InVybCgjbWFzay0xNikiIHhsaW5rOmhyZWY9IiNwYXRoLTE1Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTE4KSIgeGxpbms6aHJlZj0iI3BhdGgtMTciPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJmb2xkTGVmdCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjUwMC44IiB5PSIxNTUiPmZvbGRMZWZ0PC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iLCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEwMzIuNiIgeT0iMTUxIj4sPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 13: Type chart: fold" id="fig:map-reduce:foldleft-type-chart" />
<p class="caption">Figure 13: Type chart: fold</p>
</div>
<p>By distributing the reduce step we lose control over the order of traversal. Our overall reduction may not be entirely left-to-right—we may reduce left-to-right across several subsequences and then combine the results. To ensure correctness we need a reduction operation that is <em>associative</em>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">reduce</span>(a1, <span class="fu">reduce</span>(a2, a3)) == <span class="fu">reduce</span>(<span class="fu">reduce</span>(a1, a2), a3)</code></pre></div>
<p>If we have associativity, we can arbitrarily distribute work between our nodes provided the subsequences at every node stay in the same order as the initial dataset.</p>
<p>Our fold operation requires us to seed the computation with an element of type <code>B</code>. Since fold may be split into an arbitrary number of parallel steps, the seed should not affect the result of the computation. This naturally requires the seed to be an <em>identity</em> element:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">reduce</span>(seed, a1) == <span class="fu">reduce</span>(a1, seed) == a1</code></pre></div>
<p>In summary, our parallel fold will yield the correct results if:</p>
<ul>
<li>we require the reducer function to be associative;</li>
<li>we seed the computation with the identity of this function.</li>
</ul>
<p>What does this pattern sound like? That’s right, we’ve come full circle back to <code>Monoid</code>, the first type class we discussed in this book. We are not the first to recognise the importance of monoids. The <a href="http://arxiv.org/abs/1304.7544">monoid design pattern for map-reduce jobs</a> is at the core of recent big data systems such as Twitter’s <a href="https://github.com/twitter/summingbird">Summingbird</a>.</p>
<p>In this project we’re going to implement a very simple single-machine map-reduce. We’ll start by implementing a method called <code>foldMap</code> to model the data-flow we need.</p>
<h2 id="implementing-foldmap"><span class="header-section-number">9.2</span> Implementing <em>foldMap</em></h2>
<p>We saw <code>foldMap</code> briefly back when we covered <code>Foldable</code>. It is one of the derived operations that sits on top of <code>foldLeft</code> and <code>foldRight</code>. However, rather than use <code>Foldable</code>, we will re-implement <code>foldMap</code> here ourselves as it will provide useful insight into the structure of map-reduce.</p>
<p>Start by writing out the signature of <code>foldMap</code>. It should accept the following parameters:</p>
<ul>
<li>a sequence of type <code>Vector[A]</code>;</li>
<li>a function of type <code>A =&gt; B</code>, where there is a <code>Monoid</code> for <code>B</code>;</li>
</ul>
<p>You will have to add implicit parameters or context bounds to complete the type signature.</p>
<div class="solution">
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>

<span class="co">/**</span> Single<span class="co">-</span>threaded map<span class="co">-</span>reduce function<span class="co">.</span>
  <span class="co">*</span> Maps <span class="co">`</span>func<span class="co">`</span> over <span class="co">`</span>values<span class="co">`</span> and reduces using a <span class="co">`</span>Monoid<span class="co">[</span>B<span class="co">]`.</span>
  <span class="co">*/</span>
<span class="kw">def</span> foldMap[A, B: Monoid](values: Vector[A])(func: A =&gt; B): B =
  ???</code></pre></div>
</div>
<p>Now implement the body of <code>foldMap</code>. Use the flow chart in Figure 14 as a guide to the steps required:</p>
<ol style="list-style-type: decimal">
<li>start with a sequence of items of type <code>A</code>;</li>
<li>map over the list to produce a sequence of items of type <code>B</code>;</li>
<li>use the <code>Monoid</code> to reduce the items to a single <code>B</code>.</li>
</ol>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTQyMHB4IiBoZWlnaHQ9IjEwNDFweCIgdmlld0JveD0iMCAwIDE0MjAgMTA0MSIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggNDIgKDM2NzgxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5mb2xkLW1hcDwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEiIHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMyIgcG9pbnRzPSI1MC41OTUwODY1IDc2LjE4MDY4NjUgMjQuMjY5ODc1MyA5MC4wMjA2NjkxIDI5LjI5NzU0MzIgNjAuNzA3MTE1NiA4IDM5Ljk0NzE0MTggMzcuNDMyNDgwOSAzNS42NzAzNTIgNTAuNTk1MDg2NSA5IDYzLjc1NzY5MjEgMzUuNjcwMzUyIDkzLjE5MDE3MjkgMzkuOTQ3MTQxOCA3MS44OTI2Mjk3IDYwLjcwNzExNTYgNzYuOTIwMjk3NyA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtNSIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci02Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03IiB4PSIxMDAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItOCI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtOSIgeD0iMjAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTEwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0xMSIgcG9pbnRzPSI1MC41OTUwODY1IDc2LjE4MDY4NjUgMjQuMjY5ODc1MyA5MC4wMjA2NjkxIDI5LjI5NzU0MzIgNjAuNzA3MTE1NiA4IDM5Ljk0NzE0MTggMzcuNDMyNDgwOSAzNS42NzAzNTIgNTAuNTk1MDg2NSA5IDYzLjc1NzY5MjEgMzUuNjcwMzUyIDkzLjE5MDE3MjkgMzkuOTQ3MTQxOCA3MS44OTI2Mjk3IDYwLjcwNzExNTYgNzYuOTIwMjk3NyA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTIiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0xMyIgcG9pbnRzPSIxNDkuNTk1MDg2IDc2LjE4MDY4NjUgMTIzLjI2OTg3NSA5MC4wMjA2NjkxIDEyOC4yOTc1NDMgNjAuNzA3MTE1NiAxMDcgMzkuOTQ3MTQxOCAxMzYuNDMyNDgxIDM1LjY3MDM1MiAxNDkuNTk1MDg2IDkgMTYyLjc1NzY5MiAzNS42NzAzNTIgMTkyLjE5MDE3MyAzOS45NDcxNDE4IDE3MC44OTI2MyA2MC43MDcxMTU2IDE3NS45MjAyOTggOTAuMDIwNjY5MSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg1LjE5MDE3MjkiIGhlaWdodD0iODEuMDIwNjY5MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMTUiIHBvaW50cz0iMjQ5LjU5NTA4NiA3Ni4xODA2ODY1IDIyMy4yNjk4NzUgOTAuMDIwNjY5MSAyMjguMjk3NTQzIDYwLjcwNzExNTYgMjA3IDM5Ljk0NzE0MTggMjM2LjQzMjQ4MSAzNS42NzAzNTIgMjQ5LjU5NTA4NiA5IDI2Mi43NTc2OTIgMzUuNjcwMzUyIDI5Mi4xOTAxNzMgMzkuOTQ3MTQxOCAyNzAuODkyNjMgNjAuNzA3MTE1NiAyNzUuOTIwMjk4IDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTE3IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTE4Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xOSIgeD0iMTAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTIwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0yMSIgeD0iMjAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTIyIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0yMyIgY3g9IjUwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0yNCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTIzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMjUiIGN4PSIxNTAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTI2IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMjUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0yNyIgY3g9IjI1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMjgiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0yNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgPC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImZvbGQtbWFwIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0zIiBmaWxsPSIjRkZGRkZGIiB4PSIwIiB5PSIwIiB3aWR0aD0iMTQyMCIgaGVpZ2h0PSIxMDQxIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJyZWR1Y2VkLUIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDY1Mi4wMDAwMDAsIDc4MC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMikiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktMTgiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxnIGlkPSJtYXBwZWQtQiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTUyLjAwMDAwMCwgNDgwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci02KSIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTgpIiB4bGluazpocmVmPSIjcGF0aC03Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC03Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMTApIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMS1Db3B5LTIyIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktMjYiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTE0KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS0zMCIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTYpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTE1Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0iSW5pdGlhbC1BIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1NTIuMDAwMDAwLCAxODAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTE3Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0xNyI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0yMCkiIHhsaW5rOmhyZWY9IiNwYXRoLTE5Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0xOSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMjEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0yMikiIHhsaW5rOmhyZWY9IiNwYXRoLTIxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0yMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS0yMCIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMjQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTIzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTIxIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0yNikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMjUiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHktMjIiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTI4KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0yNyI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHRleHQgaWQ9InJlc3VsdC1sYWJlbCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTkzLjQ1NjA1NSIgeT0iOTgwIj40LiBGaW5hbCByZXN1bHQ8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxnIGlkPSJyZWR1Y2UtbGFiZWwiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU0Ny4wMDAwMDAsIDY0OC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJhcnJvdyIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU0LjA3MTYxOCwgNDAuMDAwMDAwKSByb3RhdGUoLTI3MC4wMDAwMDApIHRyYW5zbGF0ZSgtMTU0LjA3MTYxOCwgLTQwLjAwMDAwMCkgIiBwb2ludHM9IjExNC4wNzE2MTggMjAgMTU0LjA3MTYxOCAyMCAxNTQuMDcxNjE4IDMuNTUyNzEzNjhlLTE1IDE5NC4wNzE2MTggMzkuNDk3NzY3MSAxNTQuMDcxNjE4IDgwIDE1NC4wNzE2MTggNjAgMTE0LjA3MTYxOCA2MCI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHRleHQgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjAuNDEwMTU2MjUiIHk9IjQ0Ij4zLiBGb2xkL3JlZHVjZSBzdGVwPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0ibWFwLWxhYmVsIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MDcuMDAwMDAwLCAzNTAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iYXJyb3ciIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDk5LjAwMDAwMCwgNDAuMDAwMDAwKSByb3RhdGUoLTI3MC4wMDAwMDApIHRyYW5zbGF0ZSgtOTkuMDAwMDAwLCAtNDAuMDAwMDAwKSAiIHBvaW50cz0iNTkgMjAgOTkgMjAgOTkgMy41NTI3MTM2OGUtMTUgMTM5IDM5LjQ5Nzc2NzEgOTkgODAgOTkgNjAgNTkgNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDx0ZXh0IGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIwLjQ0ODI0MjE4OCIgeT0iNDIiPjIuIE1hcCBzdGVwPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iaW5pdGlhbC1sYWJlbCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTE2LjM2NzE4OCIgeT0iOTQiPjEuIEluaXRpYWwgZGF0YSBzZXF1ZW5jZTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 14: foldMap algorithm" id="fig:map-reduce:fold-map" />
<p class="caption">Figure 14: <em>foldMap</em> algorithm</p>
</div>
<p>Here’s some sample output for reference:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

<span class="fu">foldMap</span>(Vector(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(identity)
<span class="co">// res2: Int = 6</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>

<span class="co">// Mapping to a String uses the concatenation monoid:</span>
<span class="fu">foldMap</span>(Vector(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))(_.<span class="fu">toString</span> + <span class="st">&quot;! &quot;</span>)
<span class="co">// res4: String = &quot;1! 2! 3! &quot;</span>

<span class="co">// Mapping over a String to produce a String:</span>
<span class="fu">foldMap</span>(<span class="st">&quot;Hello world!&quot;</span>.<span class="fu">toVector</span>)(_.<span class="fu">toString</span>.<span class="fu">toUpperCase</span>)
<span class="co">// res6: String = HELLO WORLD!</span></code></pre></div>
<div class="solution">
<p>We have to modify the type signature to accept a <code>Monoid</code> for <code>B</code>. With that change we can use the <code>Monoid</code> <code>empty</code> and <code>|+|</code> syntax as described in Section 2.5.3:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">string</span>._ <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">def</span> foldMap[A, B : Monoid](as: Vector[A])(func: A =&gt; B): B =
  as.<span class="fu">map</span>(func).<span class="fu">foldLeft</span>(Monoid[B].<span class="fu">empty</span>)(_ |+| _)</code></pre></div>
<p>We can make a slight alteration to this code to do everything in one step:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> foldMap[A, B : Monoid](as: Vector[A])(func: A =&gt; B): B =
  as.<span class="fu">foldLeft</span>(Monoid[B].<span class="fu">empty</span>)(_ |+| <span class="fu">func</span>(_))</code></pre></div>
</div>
<h2 id="parallelising-foldmap"><span class="header-section-number">9.3</span> Parallelising <em>foldMap</em></h2>
<p>Now we have a working single-threaded implementation of <code>foldMap</code>, let’s look at distributing work to run in parallel. We’ll use our single-threaded version of <code>foldMap</code> as a building block.</p>
<p>We’ll write a multi-CPU implementation that simulates the way we would distribute work in a map-reduce cluster as shown in Figure 15:</p>
<ol style="list-style-type: decimal">
<li>we start with an initial list of all the data we need to process;</li>
<li>we divide the data into batches, sending one batch to each CPU;</li>
<li>the CPUs run a batch-level map phase in parallel;</li>
<li>the CPUs run a batch-level reduce phase in parallel, producing a local result for each batch;</li>
<li>we reduce the results for each batch to a single final result.</li>
</ol>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTQyMHB4IiBoZWlnaHQ9IjE2NDBweCIgdmlld0JveD0iMCAwIDE0MjAgMTY0MCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggNDIgKDM2NzgxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5wYXJhbGxlbC1mb2xkLW1hcDwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEiIHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMyIgcG9pbnRzPSI1MC41OTUwODY1IDc2LjY3MDM1MiAyNC4yNjk4NzUzIDkwLjUxMDMzNDUgMjkuMjk3NTQzMiA2MS4xOTY3ODExIDggNDAuNDM2ODA3MyAzNy40MzI0ODA5IDM2LjE2MDAxNzQgNTAuNTk1MDg2NSA5LjQ4OTY2NTQ1IDYzLjc1NzY5MjEgMzYuMTYwMDE3NCA5My4xOTAxNzI5IDQwLjQzNjgwNzMgNzEuODkyNjI5NyA2MS4xOTY3ODExIDc2LjkyMDI5NzcgOTAuNTEwMzM0NSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTUiIHg9Ii0xLjQyMTA4NTQ3ZS0xNCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci02Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03IiB4PSI3MjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItOCI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtOSIgeD0iMzYwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTEwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xMSIgeD0iMTA4MCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0xMiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMTMiIHBvaW50cz0iNTAuNTk1MDg2NSA3Ni4xODA2ODY1IDI0LjI2OTg3NTMgOTAuMDIwNjY5MSAyOS4yOTc1NDMyIDYwLjcwNzExNTYgOCAzOS45NDcxNDE4IDM3LjQzMjQ4MDkgMzUuNjcwMzUyIDUwLjU5NTA4NjUgOSA2My43NTc2OTIxIDM1LjY3MDM1MiA5My4xOTAxNzI5IDM5Ljk0NzE0MTggNzEuODkyNjI5NyA2MC43MDcxMTU2IDc2LjkyMDI5NzcgOTAuMDIwNjY5MSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg1LjE5MDE3MjkiIGhlaWdodD0iODEuMDIwNjY5MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMTUiIHBvaW50cz0iNDEwLjU5NTA4NiA3Ni4xODA2ODY1IDM4NC4yNjk4NzUgOTAuMDIwNjY5MSAzODkuMjk3NTQzIDYwLjcwNzExNTYgMzY4IDM5Ljk0NzE0MTggMzk3LjQzMjQ4MSAzNS42NzAzNTIgNDEwLjU5NTA4NiA5IDQyMy43NTc2OTIgMzUuNjcwMzUyIDQ1My4xOTAxNzMgMzkuOTQ3MTQxOCA0MzEuODkyNjMgNjAuNzA3MTE1NiA0MzYuOTIwMjk4IDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTE3IiBwb2ludHM9Ijc3MC41OTUwODYgNzYuMTgwNjg2NSA3NDQuMjY5ODc1IDkwLjAyMDY2OTEgNzQ5LjI5NzU0MyA2MC43MDcxMTU2IDcyOCAzOS45NDcxNDE4IDc1Ny40MzI0ODEgMzUuNjcwMzUyIDc3MC41OTUwODYgOSA3ODMuNzU3NjkyIDM1LjY3MDM1MiA4MTMuMTkwMTczIDM5Ljk0NzE0MTggNzkxLjg5MjYzIDYwLjcwNzExNTYgNzk2LjkyMDI5OCA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTgiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC0xOSIgcG9pbnRzPSIxMTMwLjU5NTA5IDc2LjE4MDY4NjUgMTEwNC4yNjk4OCA5MC4wMjA2NjkxIDExMDkuMjk3NTQgNjAuNzA3MTE1NiAxMDg4IDM5Ljk0NzE0MTggMTExNy40MzI0OCAzNS42NzAzNTIgMTEzMC41OTUwOSA5IDExNDMuNzU3NjkgMzUuNjcwMzUyIDExNzMuMTkwMTcgMzkuOTQ3MTQxOCAxMTUxLjg5MjYzIDYwLjcwNzExNTYgMTE1Ni45MjAzIDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0yMCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTIxIiB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTIyIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0yMyIgeD0iNzIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTI0Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0yNSIgeD0iMTAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTI2Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0yNyIgeD0iODIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTI4Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0yOSIgeD0iMjAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTMwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0zMSIgeD0iOTIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTMyIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0zMyIgeD0iMzYwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTM0Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0zNSIgeD0iMTA4MCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0zNiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMzciIHg9IjQ2MCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0zOCI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMzkiIHg9IjExODAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItNDAiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTQxIiB4PSI1NjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItNDIiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTQzIiB4PSIxMjgwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTQ0Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC00NSIgcG9pbnRzPSI1MC41OTUwODY1IDc2LjE4MDY4NjUgMjQuMjY5ODc1MyA5MC4wMjA2NjkxIDI5LjI5NzU0MzIgNjAuNzA3MTE1NiA4IDM5Ljk0NzE0MTggMzcuNDMyNDgwOSAzNS42NzAzNTIgNTAuNTk1MDg2NSA5IDYzLjc1NzY5MjEgMzUuNjcwMzUyIDkzLjE5MDE3MjkgMzkuOTQ3MTQxOCA3MS44OTI2Mjk3IDYwLjcwNzExNTYgNzYuOTIwMjk3NyA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNDYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNDUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC00NyIgcG9pbnRzPSI0MTAuNTk1MDg2IDc2LjE4MDY4NjUgMzg0LjI2OTg3NSA5MC4wMjA2NjkxIDM4OS4yOTc1NDMgNjAuNzA3MTE1NiAzNjggMzkuOTQ3MTQxOCAzOTcuNDMyNDgxIDM1LjY3MDM1MiA0MTAuNTk1MDg2IDkgNDIzLjc1NzY5MiAzNS42NzAzNTIgNDUzLjE5MDE3MyAzOS45NDcxNDE4IDQzMS44OTI2MyA2MC43MDcxMTU2IDQzNi45MjAyOTggOTAuMDIwNjY5MSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTQ4IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg1LjE5MDE3MjkiIGhlaWdodD0iODEuMDIwNjY5MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTQ3Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNDkiIHBvaW50cz0iNzcwLjU5NTA4NiA3Ni4xODA2ODY1IDc0NC4yNjk4NzUgOTAuMDIwNjY5MSA3NDkuMjk3NTQzIDYwLjcwNzExNTYgNzI4IDM5Ljk0NzE0MTggNzU3LjQzMjQ4MSAzNS42NzAzNTIgNzcwLjU5NTA4NiA5IDc4My43NTc2OTIgMzUuNjcwMzUyIDgxMy4xOTAxNzMgMzkuOTQ3MTQxOCA3OTEuODkyNjMgNjAuNzA3MTE1NiA3OTYuOTIwMjk4IDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay01MCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC00OSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTUxIiBwb2ludHM9IjExMzAuNTk1MDkgNzYuMTgwNjg2NSAxMTA0LjI2OTg4IDkwLjAyMDY2OTEgMTEwOS4yOTc1NCA2MC43MDcxMTU2IDEwODggMzkuOTQ3MTQxOCAxMTE3LjQzMjQ4IDM1LjY3MDM1MiAxMTMwLjU5NTA5IDkgMTE0My43NTc2OSAzNS42NzAzNTIgMTE3My4xOTAxNyAzOS45NDcxNDE4IDExNTEuODkyNjMgNjAuNzA3MTE1NiAxMTU2LjkyMDMgOTAuMDIwNjY5MSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTUyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg1LjE5MDE3MjkiIGhlaWdodD0iODEuMDIwNjY5MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTUxIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNTMiIHBvaW50cz0iMTQ5LjU5NTA4NiA3Ni4xODA2ODY1IDEyMy4yNjk4NzUgOTAuMDIwNjY5MSAxMjguMjk3NTQzIDYwLjcwNzExNTYgMTA3IDM5Ljk0NzE0MTggMTM2LjQzMjQ4MSAzNS42NzAzNTIgMTQ5LjU5NTA4NiA5IDE2Mi43NTc2OTIgMzUuNjcwMzUyIDE5Mi4xOTAxNzMgMzkuOTQ3MTQxOCAxNzAuODkyNjMgNjAuNzA3MTE1NiAxNzUuOTIwMjk4IDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay01NCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC01MyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTU1IiBwb2ludHM9IjUwOS41OTUwODYgNzYuMTgwNjg2NSA0ODMuMjY5ODc1IDkwLjAyMDY2OTEgNDg4LjI5NzU0MyA2MC43MDcxMTU2IDQ2NyAzOS45NDcxNDE4IDQ5Ni40MzI0ODEgMzUuNjcwMzUyIDUwOS41OTUwODYgOSA1MjIuNzU3NjkyIDM1LjY3MDM1MiA1NTIuMTkwMTczIDM5Ljk0NzE0MTggNTMwLjg5MjYzIDYwLjcwNzExNTYgNTM1LjkyMDI5OCA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNTYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC01NyIgcG9pbnRzPSI4NjkuNTk1MDg2IDc2LjE4MDY4NjUgODQzLjI2OTg3NSA5MC4wMjA2NjkxIDg0OC4yOTc1NDMgNjAuNzA3MTE1NiA4MjcgMzkuOTQ3MTQxOCA4NTYuNDMyNDgxIDM1LjY3MDM1MiA4NjkuNTk1MDg2IDkgODgyLjc1NzY5MiAzNS42NzAzNTIgOTEyLjE5MDE3MyAzOS45NDcxNDE4IDg5MC44OTI2MyA2MC43MDcxMTU2IDg5NS45MjAyOTggOTAuMDIwNjY5MSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTU4IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg1LjE5MDE3MjkiIGhlaWdodD0iODEuMDIwNjY5MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTU3Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNTkiIHBvaW50cz0iMTIyOS41OTUwOSA3Ni4xODA2ODY1IDEyMDMuMjY5ODggOTAuMDIwNjY5MSAxMjA4LjI5NzU0IDYwLjcwNzExNTYgMTE4NyAzOS45NDcxNDE4IDEyMTYuNDMyNDggMzUuNjcwMzUyIDEyMjkuNTk1MDkgOSAxMjQyLjc1NzY5IDM1LjY3MDM1MiAxMjcyLjE5MDE3IDM5Ljk0NzE0MTggMTI1MC44OTI2MyA2MC43MDcxMTU2IDEyNTUuOTIwMyA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNjAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNTkiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC02MSIgcG9pbnRzPSIyNDkuNTk1MDg2IDc2LjE4MDY4NjUgMjIzLjI2OTg3NSA5MC4wMjA2NjkxIDIyOC4yOTc1NDMgNjAuNzA3MTE1NiAyMDcgMzkuOTQ3MTQxOCAyMzYuNDMyNDgxIDM1LjY3MDM1MiAyNDkuNTk1MDg2IDkgMjYyLjc1NzY5MiAzNS42NzAzNTIgMjkyLjE5MDE3MyAzOS45NDcxNDE4IDI3MC44OTI2MyA2MC43MDcxMTU2IDI3NS45MjAyOTggOTAuMDIwNjY5MSI+PC9wb2x5Z29uPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTYyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9Ijg1LjE5MDE3MjkiIGhlaWdodD0iODEuMDIwNjY5MSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTYxIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNjMiIHBvaW50cz0iNjA5LjU5NTA4NiA3Ni4xODA2ODY1IDU4My4yNjk4NzUgOTAuMDIwNjY5MSA1ODguMjk3NTQzIDYwLjcwNzExNTYgNTY3IDM5Ljk0NzE0MTggNTk2LjQzMjQ4MSAzNS42NzAzNTIgNjA5LjU5NTA4NiA5IDYyMi43NTc2OTIgMzUuNjcwMzUyIDY1Mi4xOTAxNzMgMzkuOTQ3MTQxOCA2MzAuODkyNjMgNjAuNzA3MTE1NiA2MzUuOTIwMjk4IDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay02NCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC02MyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTY1IiBwb2ludHM9Ijk2OS41OTUwODYgNzYuMTgwNjg2NSA5NDMuMjY5ODc1IDkwLjAyMDY2OTEgOTQ4LjI5NzU0MyA2MC43MDcxMTU2IDkyNyAzOS45NDcxNDE4IDk1Ni40MzI0ODEgMzUuNjcwMzUyIDk2OS41OTUwODYgOSA5ODIuNzU3NjkyIDM1LjY3MDM1MiAxMDEyLjE5MDE3IDM5Ljk0NzE0MTggOTkwLjg5MjYzIDYwLjcwNzExNTYgOTk1LjkyMDI5OCA5MC4wMjA2NjkxIj48L3BvbHlnb24+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stNjYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iODUuMTkwMTcyOSIgaGVpZ2h0PSI4MS4wMjA2NjkxIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtNjUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC02NyIgcG9pbnRzPSIxMzI5LjU5NTA5IDc2LjE4MDY4NjUgMTMwMy4yNjk4OCA5MC4wMjA2NjkxIDEzMDguMjk3NTQgNjAuNzA3MTE1NiAxMjg3IDM5Ljk0NzE0MTggMTMxNi40MzI0OCAzNS42NzAzNTIgMTMyOS41OTUwOSA5IDEzNDIuNzU3NjkgMzUuNjcwMzUyIDEzNzIuMTkwMTcgMzkuOTQ3MTQxOCAxMzUwLjg5MjYzIDYwLjcwNzExNTYgMTM1NS45MjAzIDkwLjAyMDY2OTEiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay02OCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4NS4xOTAxNzI5IiBoZWlnaHQ9IjgxLjAyMDY2OTEiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC02NyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTY5IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTcwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03MSIgeD0iNzIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTcyIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03MyIgeD0iMTAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTc0Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03NSIgeD0iODIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTc2Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03NyIgeD0iMjAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTc4Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC03OSIgeD0iOTIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTgwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC04MSIgeD0iMzYwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTgyIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC04MyIgeD0iMTA4MCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci04NCI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtODUiIHg9IjQ2MCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci04NiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtODciIHg9IjExODAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItODgiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTg5IiB4PSI1NjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItOTAiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTkxIiB4PSIxMjgwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTkyIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC05MyIgY3g9IjExMjkuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTk0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOTMiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC05NSIgY3g9IjEyMjkuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTk2IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC05NyIgY3g9IjEzMjkuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTk4IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC05OSIgY3g9Ijc3MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTAwIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOTkiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xMDEiIGN4PSI4NzAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEwMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEwMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTEwMyIgY3g9Ijk3MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTA0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTAzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTA1IiBjeD0iNDEwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMDYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xMDUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xMDciIGN4PSI1MTAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTEwOCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEwNyI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTEwOSIgY3g9IjYxMC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTEwIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTA5Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTExIiBjeD0iNTAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTExMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTExMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTExMyIgY3g9IjE1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTE0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTE1IiBjeD0iMjUwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMTYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xMTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xMTciIHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMTE4Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xMTkiIHg9IjYwMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0xMjAiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEyMSIgeD0iMTAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTEyMiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTIzIiB4PSI3MDAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMTI0Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xMjUiIHg9IjIwMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0xMjYiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEyNyIgeD0iODAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTEyOCI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTI5IiB4PSIzMDAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMTMwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xMzEiIHg9IjkwMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwvcmVjdD4KICAgICAgICA8ZmlsdGVyIHg9Ii01MCUiIHk9Ii01MCUiIHdpZHRoPSIyMDAlIiBoZWlnaHQ9IjIwMCUiIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaWQ9ImZpbHRlci0xMzIiPgogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxLjUiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dCbHVySW5uZXIxIj48L2ZlR2F1c3NpYW5CbHVyPgogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIxIiBpbj0ic2hhZG93Qmx1cklubmVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRJbm5lcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUNvbXBvc2l0ZSBpbj0ic2hhZG93T2Zmc2V0SW5uZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iYXJpdGhtZXRpYyIgazI9Ii0xIiBrMz0iMSIgcmVzdWx0PSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbXBvc2l0ZT4KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuNSAwIiB0eXBlPSJtYXRyaXgiIGluPSJzaGFkb3dJbm5lcklubmVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgICAgIDxyZWN0IGlkPSJwYXRoLTEzMyIgeD0iNDAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTEzNCI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTM1IiB4PSIxMDAwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgIDxmaWx0ZXIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiBpZD0iZmlsdGVyLTEzNiI+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjEuNSIgaW49IlNvdXJjZUFscGhhIiByZXN1bHQ9InNoYWRvd0JsdXJJbm5lcjEiPjwvZmVHYXVzc2lhbkJsdXI+CiAgICAgICAgICAgIDxmZU9mZnNldCBkeD0iMCIgZHk9IjEiIGluPSJzaGFkb3dCbHVySW5uZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldElubmVyMSI+PC9mZU9mZnNldD4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRJbm5lcjEiIGluMj0iU291cmNlQWxwaGEiIG9wZXJhdG9yPSJhcml0aG1ldGljIiBrMj0iLTEiIGszPSIxIiByZXN1bHQ9InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29tcG9zaXRlPgogICAgICAgICAgICA8ZmVDb2xvck1hdHJpeCB2YWx1ZXM9IjAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgIDAgMCAwIDAgMCAgMCAwIDAgMC41IDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0lubmVySW5uZXIxIj48L2ZlQ29sb3JNYXRyaXg+CiAgICAgICAgPC9maWx0ZXI+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTM3IiB4PSI1MDAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMTM4Ij4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8cmVjdCBpZD0icGF0aC0xMzkiIHg9IjExMDAiIHk9IjAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgPGZpbHRlciB4PSItNTAlIiB5PSItNTAlIiB3aWR0aD0iMjAwJSIgaGVpZ2h0PSIyMDAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMTQwIj4KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMS41IiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93Qmx1cklubmVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMSIgaW49InNoYWRvd0JsdXJJbm5lcjEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0SW5uZXIxIj48L2ZlT2Zmc2V0PgogICAgICAgICAgICA8ZmVDb21wb3NpdGUgaW49InNoYWRvd09mZnNldElubmVyMSIgaW4yPSJTb3VyY2VBbHBoYSIgb3BlcmF0b3I9ImFyaXRobWV0aWMiIGsyPSItMSIgazM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93SW5uZXJJbm5lcjEiPjwvZmVDb2xvck1hdHJpeD4KICAgICAgICA8L2ZpbHRlcj4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xNDEiIGN4PSI1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTQyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTQxIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTQzIiBjeD0iMTUwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNDQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNDMiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xNDUiIGN4PSIyNTAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE0NiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTE0NSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTE0NyIgY3g9IjM1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTQ4IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTQ3Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTQ5IiBjeD0iNjUwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNTAiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNDkiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xNTEiIGN4PSI5NTAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE1MiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTE1MSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTE1MyIgY3g9IjQ1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTU0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTUzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTU1IiBjeD0iNzUwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNTYiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNTUiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xNTciIGN4PSIxMDUwLjUiIGN5PSI1MC41IiByeD0iMzYuNSIgcnk9IjM2LjUiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0xNTgiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iNzMiIGhlaWdodD0iNzMiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xNTkiIGN4PSI1NTAuNSIgY3k9IjUwLjUiIHJ4PSIzNi41IiByeT0iMzYuNSI+PC9lbGxpcHNlPgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE2MCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI3MyIgaGVpZ2h0PSI3MyIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTE1OSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTE2MSIgY3g9Ijg1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTYyIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTYxIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTYzIiBjeD0iMTE1MC41IiBjeT0iNTAuNSIgcng9IjM2LjUiIHJ5PSIzNi41Ij48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTY0IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjczIiBoZWlnaHQ9IjczIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMTYzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0icGFyYWxsZWwtZm9sZC1tYXAiPgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTMiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNDIwIiBoZWlnaHQ9IjE2NDAiPjwvcmVjdD4KICAgICAgICAgICAgPGcgaWQ9ImZpbmFsLUIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDY2MC4wMDAwMDAsIDEzNjAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNCI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0yKSIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iOCIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS0xNCIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stNCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMyI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9InJlZHVjZWQtYmF0Y2hlcy1vZi1CIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjAuMDAwMDAwLCAxMDYwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci02KSIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iOCIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNCI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci04KSIgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iOCIgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHkiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMTApIiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiB4bGluazpocmVmPSIjcGF0aC05Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weS03Ij4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xMikiIHhsaW5rOmhyZWY9IiNwYXRoLTExIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiB4bGluazpocmVmPSIjcGF0aC0xMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS0xMyIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMS1Db3B5LTE0IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xNikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTUiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktMTUiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTE4KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xNyI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS0xNiIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMjApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTE5Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0iYmF0Y2hlcy1vZi1CIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMC4wMDAwMDAsIDc2MC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0zIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTIyKSIgeGxpbms6aHJlZj0iI3BhdGgtMjEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0yMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weS0zIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIzIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTI0KSIgeGxpbms6aHJlZj0iI3BhdGgtMjMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0yMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMjUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMjYpIiB4bGluazpocmVmPSIjcGF0aC0yNSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTI1Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS1Db3B5LTQiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMjciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMjgpIiB4bGluazpocmVmPSIjcGF0aC0yNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTI3Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0yOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0zMCkiIHhsaW5rOmhyZWY9IiNwYXRoLTI5Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMjkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0zMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0zMikiIHhsaW5rOmhyZWY9IiNwYXRoLTMxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMzEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTMzIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTM0KSIgeGxpbms6aHJlZj0iI3BhdGgtMzMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0zMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weS02Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTM1Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTM2KSIgeGxpbms6aHJlZj0iI3BhdGgtMzUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0zNSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0zNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0zOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTM3Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMzciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0zOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci00MCkiIHhsaW5rOmhyZWY9IiNwYXRoLTM5Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMzkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktMiI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC00MSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci00MikiIHhsaW5rOmhyZWY9IiNwYXRoLTQxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtNDEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktOCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC00MyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci00NCkiIHhsaW5rOmhyZWY9IiNwYXRoLTQzIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtNDMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSIzNjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSI3MjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSIxMDgwIiB5PSIwIiB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHkiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTQ2KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC00NSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS00IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay00OCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtNDciPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktNyIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stNTApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTQ5Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMS1Db3B5LTEwIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay01MikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtNTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktMiIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stNTQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTUzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMS1Db3B5LTUiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTU2KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01NSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS04IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay01OCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtNTciPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktMTEiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTYwKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC01OSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS0zIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay02MikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtNjEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xLUNvcHktNiIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stNjQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTYzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9IlN0YXItMS1Db3B5LTkiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTY2KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC02NSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJTdGFyLTEtQ29weS0xMiIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stNjgpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTY3Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0iYmF0Y2hlcy1vZi1BIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMC4wMDAwMDAsIDQ2MC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTY5Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTcwKSIgeGxpbms6aHJlZj0iI3BhdGgtNjkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC02OSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weS0zIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTcxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTcyKSIgeGxpbms6aHJlZj0iI3BhdGgtNzEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC03MSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNzMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItNzQpIiB4bGluazpocmVmPSIjcGF0aC03MyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTczIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS1Db3B5LTQiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNzUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItNzYpIiB4bGluazpocmVmPSIjcGF0aC03NSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTc1Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC03NyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci03OCkiIHhsaW5rOmhyZWY9IiNwYXRoLTc3Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtNzciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC03OSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci04MCkiIHhsaW5rOmhyZWY9IiNwYXRoLTc5Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtNzkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTgxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTgyKSIgeGxpbms6aHJlZj0iI3BhdGgtODEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC04MSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weS02Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTgzIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTg0KSIgeGxpbms6aHJlZj0iI3BhdGgtODMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC04MyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC04NSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci04NikiIHhsaW5rOmhyZWY9IiNwYXRoLTg1Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtODUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC04NyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci04OCkiIHhsaW5rOmhyZWY9IiNwYXRoLTg3Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtODciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktMiI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC04OSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci05MCkiIHhsaW5rOmhyZWY9IiNwYXRoLTg5Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtODkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktOCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC05MSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci05MikiIHhsaW5rOmhyZWY9IiNwYXRoLTkxIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtOTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSIzNjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSI3MjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSIxMDgwIiB5PSIwIiB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEwMCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHktOCIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stOTQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTkzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTkiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTk2KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC05NSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS0xMCIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stOTgpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTk3Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTgiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTEwMCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtOTkiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHktOSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTAyKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xMDEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHktMTAiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTEwNCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTAzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTgiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTEwNikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTA1Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTkiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTEwOCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTA3Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTEwIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMTApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTEwOSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS04IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMTIpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTExMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS05IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xMTQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTExMyI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS0xMCIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTE2KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xMTUiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxnIGlkPSJpbml0aWFsLUEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMC4wMDAwMDAsIDE2MC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xMTciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xMTgpIiB4bGluazpocmVmPSIjcGF0aC0xMTciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTExNyI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktMyI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTExOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTEyMCkiIHhsaW5rOmhyZWY9IiNwYXRoLTExOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMTE5Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xMjEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xMjIpIiB4bGluazpocmVmPSIjcGF0aC0xMjEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTEyMSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNCI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEyMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTEyNCkiIHhsaW5rOmhyZWY9IiNwYXRoLTEyMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMTIzIj48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xMjUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xMjYpIiB4bGluazpocmVmPSIjcGF0aC0xMjUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTEyNSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEyNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTEyOCkiIHhsaW5rOmhyZWY9IiNwYXRoLTEyNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMTI3Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xMjkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xMzApIiB4bGluazpocmVmPSIjcGF0aC0xMjkiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTEyOSI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktNiI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEzMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTEzMikiIHhsaW5rOmhyZWY9IiNwYXRoLTEzMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMTMxIj48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEzMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTEzNCkiIHhsaW5rOmhyZWY9IiNwYXRoLTEzMyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMTMzIj48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtQ29weS03Ij4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMTM1Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjEiIGZpbHRlcj0idXJsKCNmaWx0ZXItMTM2KSIgeGxpbms6aHJlZj0iI3BhdGgtMTM1Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8dXNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4bGluazpocmVmPSIjcGF0aC0xMzUiPjwvdXNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS1Db3B5LTIiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xMzciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0xMzgpIiB4bGluazpocmVmPSIjcGF0aC0xMzciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDx1c2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHhsaW5rOmhyZWY9IiNwYXRoLTEzNyI+PC91c2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLUNvcHktOCI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEzOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTE0MCkiIHhsaW5rOmhyZWY9IiNwYXRoLTEzOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeGxpbms6aHJlZj0iI3BhdGgtMTM5Ij48L3VzZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSIzMDAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSI2MDAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTIiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB4PSI5MDAiIHk9IjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTAwIj48L3JlY3Q+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTQyKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xNDEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHkiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTE0NCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTQzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xNDYpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTE0NSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTQ4KSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xNDciPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHktMiIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTUwKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xNDkiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHktNSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTUyKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xNTEiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xLUNvcHkiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTE1NCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTUzIj48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTMiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTE1NikiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTU1Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5LTYiIHN0cm9rZT0iIzAwMDAwMCIgbWFzaz0idXJsKCNtYXNrLTE1OCkiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTU3Ij48L3VzZT4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMS1Db3B5IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xNjApIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTE1OSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS00IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xNjIpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTE2MSI+PC91c2U+CiAgICAgICAgICAgICAgICA8dXNlIGlkPSJPdmFsLTEtQ29weS03IiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0xNjQpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTE2MyI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHRleHQgaWQ9InJlc3VsdC1sYWJlbCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNjAyLjQ1NjA1NSIgeT0iMTU3MiI+Ni4gRmluYWwgcmVzdWx0PC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8ZyBpZD0icmVkdWNlLWFsbC1sYWJlbCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjcxLjAwMDAwMCwgMTIxMS4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1Ni41Njg1NDIsIDU2LjU2ODU0Mikgcm90YXRlKC0zMTUuMDAwMDAwKSB0cmFuc2xhdGUoLTU2LjU2ODU0MiwgLTU2LjU2ODU0MikgIiBwb2ludHM9IjE2LjU2ODU0MjUgMzYuNTY4NTQyNSA1Ni41Njg1NDI1IDM2LjU2ODU0MjUgNTYuNTY4NTQyNSAxNi41Njg1NDI1IDk2LjU2ODU0MjUgNTYuMDY2MzA5NiA1Ni41Njg1NDI1IDk2LjU2ODU0MjUgNTYuNTY4NTQyNSA3Ni41Njg1NDI1IDE2LjU2ODU0MjUgNzYuNTY4NTQyNSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM0OS40NDk0MzksIDU3LjQ0OTQzOSkgcm90YXRlKC0yOTMuMDAwMDAwKSB0cmFuc2xhdGUoLTM0OS40NDk0MzksIC01Ny40NDk0MzkpICIgcG9pbnRzPSIzMDkuNDQ5NDM5IDM3LjQ0OTQzOTMgMzQ5LjQ0OTQzOSAzNy40NDk0MzkzIDM0OS40NDk0MzkgMTcuNDQ5NDM5MyAzODkuNDQ5NDM5IDU2Ljk0NzIwNjQgMzQ5LjQ0OTQzOSA5Ny40NDk0MzkzIDM0OS40NDk0MzkgNzcuNDQ5NDM5MyAzMDkuNDQ5NDM5IDc3LjQ0OTQzOTMiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1NTMuNDQ5NDM5LCA1Ny40NDk0MzkpIHJvdGF0ZSgtMjQ3LjAwMDAwMCkgdHJhbnNsYXRlKC01NTMuNDQ5NDM5LCAtNTcuNDQ5NDM5KSAiIHBvaW50cz0iNTEzLjQ0OTQzOSAzNy40NDk0MzkzIDU1My40NDk0MzkgMzcuNDQ5NDM5MyA1NTMuNDQ5NDM5IDE3LjQ0OTQzOTMgNTkzLjQ0OTQzOSA1Ni45NDcyMDY0IDU1My40NDk0MzkgOTcuNDQ5NDM5MyA1NTMuNDQ5NDM5IDc3LjQ0OTQzOTMgNTEzLjQ0OTQzOSA3Ny40NDk0MzkzIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMyIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODE5LjU2ODU0MiwgNTcuNTY4NTQyKSByb3RhdGUoLTIyNS4wMDAwMDApIHRyYW5zbGF0ZSgtODE5LjU2ODU0MiwgLTU3LjU2ODU0MikgIiBwb2ludHM9Ijc3OS41Njg1NDIgMzcuNTY4NTQyNSA4MTkuNTY4NTQyIDM3LjU2ODU0MjUgODE5LjU2ODU0MiAxNy41Njg1NDI1IDg1OS41Njg1NDIgNTcuMDY2MzA5NiA4MTkuNTY4NTQyIDk3LjU2ODU0MjUgODE5LjU2ODU0MiA3Ny41Njg1NDI1IDc3OS41Njg1NDIgNzcuNTY4NTQyNSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IjUuLVJlZHVjZS10aGUtYmF0Y2hlIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjU5LjM3Njk1MyIgeT0iNjEiPjUuIFJlZHVjZSB0aGUgYmF0Y2hlczwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9InJlZHVjZS1iYXRjaGVzLWxhYmVsIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzAuMDAwMDAwLCA5MjguMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDAuMDcxNjE4LCA0MC4wMDAwMDApIHJvdGF0ZSgtMjcwLjAwMDAwMCkgdHJhbnNsYXRlKC00MC4wNzE2MTgsIC00MC4wMDAwMDApICIgcG9pbnRzPSIwLjA3MTYxNzkxOTMgMjAgNDAuMDcxNjE3OSAyMCA0MC4wNzE2MTc5IDMuNTUyNzEzNjhlLTE1IDgwLjA3MTYxNzkgMzkuNDk3NzY3MSA0MC4wNzE2MTc5IDgwIDQwLjA3MTYxNzkgNjAgMC4wNzE2MTc5MTkzIDYwIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNDAxLjE3NzY0NywgNDAuMTA2MDI5KSByb3RhdGUoLTI3MC4wMDAwMDApIHRyYW5zbGF0ZSgtNDAxLjE3NzY0NywgLTQwLjEwNjAyOSkgIiBwb2ludHM9IjM2MS4xNzc2NDcgMjAuMTA2MDI4OSA0MDEuMTc3NjQ3IDIwLjEwNjAyODkgNDAxLjE3NzY0NyAwLjEwNjAyODg2OSA0NDEuMTc3NjQ3IDM5LjYwMzc5NiA0MDEuMTc3NjQ3IDgwLjEwNjAyODkgNDAxLjE3NzY0NyA2MC4xMDYwMjg5IDM2MS4xNzc2NDcgNjAuMTA2MDI4OSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDc2MS4xNzc2NDcsIDQwLjEwNjAyOSkgcm90YXRlKC0yNzAuMDAwMDAwKSB0cmFuc2xhdGUoLTc2MS4xNzc2NDcsIC00MC4xMDYwMjkpICIgcG9pbnRzPSI3MjEuMTc3NjQ3IDIwLjEwNjAyODkgNzYxLjE3NzY0NyAyMC4xMDYwMjg5IDc2MS4xNzc2NDcgMC4xMDYwMjg4NjkgODAxLjE3NzY0NyAzOS42MDM3OTYgNzYxLjE3NzY0NyA4MC4xMDYwMjg5IDc2MS4xNzc2NDcgNjAuMTA2MDI4OSA3MjEuMTc3NjQ3IDYwLjEwNjAyODkiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0zIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTIxLjAwMDAwMCwgNDAuMDAwMDAwKSByb3RhdGUoLTI3MC4wMDAwMDApIHRyYW5zbGF0ZSgtMTEyMS4wMDAwMDAsIC00MC4wMDAwMDApICIgcG9pbnRzPSIxMDgxIDIwIDExMjEgMjAgMTEyMSAzLjU1MjcxMzY4ZS0xNSAxMTYxIDM5LjQ5Nzc2NzEgMTEyMSA4MCAxMTIxIDYwIDEwODEgNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSI0Li1SZWR1Y2UtZWFjaC1iYXRjaCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjMyMy4zMzIwMzEiIHk9IjQ0Ij40LiBSZWR1Y2UgZWFjaCBiYXRjaCBpbiBwYXJhbGxlbDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Im1hcC1sYWJlbCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTMwLjAwMDAwMCwgNjMwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwLjAwMDAwMCwgNDAuMDAwMDAwKSByb3RhdGUoLTI3MC4wMDAwMDApIHRyYW5zbGF0ZSgtNDAuMDAwMDAwLCAtNDAuMDAwMDAwKSAiIHBvaW50cz0iMCAyMCA0MCAyMCA0MCAzLjU1MjcxMzY4ZS0xNSA4MCAzOS40OTc3NjcxIDQwIDgwIDQwIDYwIDAgNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0MDEuMDAwMDAwLCA0MC4wMDAwMDApIHJvdGF0ZSgtMjcwLjAwMDAwMCkgdHJhbnNsYXRlKC00MDEuMDAwMDAwLCAtNDAuMDAwMDAwKSAiIHBvaW50cz0iMzYxIDIwIDQwMSAyMCA0MDEgMy41NTI3MTM2OGUtMTUgNDQxIDM5LjQ5Nzc2NzEgNDAxIDgwIDQwMSA2MCAzNjEgNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3NjEuMDAwMDAwLCA0MC4wMDAwMDApIHJvdGF0ZSgtMjcwLjAwMDAwMCkgdHJhbnNsYXRlKC03NjEuMDAwMDAwLCAtNDAuMDAwMDAwKSAiIHBvaW50cz0iNzIxIDIwIDc2MSAyMCA3NjEgMy41NTI3MTM2OGUtMTUgODAxIDM5LjQ5Nzc2NzEgNzYxIDgwIDc2MSA2MCA3MjEgNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0zIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTIxLjAwMDAwMCwgNDAuMDAwMDAwKSByb3RhdGUoLTI3MC4wMDAwMDApIHRyYW5zbGF0ZSgtMTEyMS4wMDAwMDAsIC00MC4wMDAwMDApICIgcG9pbnRzPSIxMDgxIDIwIDExMjEgMjAgMTEyMSAzLjU1MjcxMzY4ZS0xNSAxMTYxIDM5LjQ5Nzc2NzEgMTEyMSA4MCAxMTIxIDYwIDEwODEgNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSIzLi1NYXAtb3Zlci10aGUtYmF0YyIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjMwNS4zNDA4MiIgeT0iNDIiPjMuIE1hcCBvdmVyIHRoZSBiYXRjaGVzIGluIHBhcmFsbGVsPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0iZGl2aWRlLWxhYmVsIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNTYuMDAwMDAwLCAzMTYuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTIuMDcxNjE4LCA1Mi4wNzE2MTgpIHJvdGF0ZSgtMjQ4LjAwMDAwMCkgdHJhbnNsYXRlKC01Mi4wNzE2MTgsIC01Mi4wNzE2MTgpICIgcG9pbnRzPSIxMi4wNzE2MTc5IDMyLjA3MTYxNzkgNTIuMDcxNjE3OSAzMi4wNzE2MTc5IDUyLjA3MTYxNzkgMTIuMDcxNjE3OSA5Mi4wNzE2MTc5IDUxLjU2OTM4NSA1Mi4wNzE2MTc5IDkyLjA3MTYxNzkgNTIuMDcxNjE3OSA3Mi4wNzE2MTc5IDEyLjA3MTYxNzkgNzIuMDcxNjE3OSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM4OC4wMDAwMDAsIDUyLjAwMDAwMCkgcm90YXRlKC0yNjIuMDAwMDAwKSB0cmFuc2xhdGUoLTM4OC4wMDAwMDAsIC01Mi4wMDAwMDApICIgcG9pbnRzPSIzNDggMzIgMzg4IDMyIDM4OCAxMiA0MjggNTEuNDk3NzY3MSAzODggOTIgMzg4IDcyIDM0OCA3MiI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcyMC4wMDAwMDAsIDUyLjAwMDAwMCkgcm90YXRlKC0yNzguMDAwMDAwKSB0cmFuc2xhdGUoLTcyMC4wMDAwMDAsIC01Mi4wMDAwMDApICIgcG9pbnRzPSI2ODAgMzIgNzIwIDMyIDcyMCAxMiA3NjAgNTEuNDk3NzY3MSA3MjAgOTIgNzIwIDcyIDY4MCA3MiI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTMiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEwNTMuNDc1OTYyLCA1Mi40NzU5NjIpIHJvdGF0ZSgtMjkwLjAwMDAwMCkgdHJhbnNsYXRlKC0xMDUzLjQ3NTk2MiwgLTUyLjQ3NTk2MikgIiBwb2ludHM9IjEwMTMuNDc1OTYgMzIuNDc1OTYyMSAxMDUzLjQ3NTk2IDMyLjQ3NTk2MjEgMTA1My40NzU5NiAxMi40NzU5NjIxIDEwOTMuNDc1OTYgNTEuOTczNzI5MiAxMDUzLjQ3NTk2IDkyLjQ3NTk2MjEgMTA1My40NzU5NiA3Mi40NzU5NjIxIDEwMTMuNDc1OTYgNzIuNDc1OTYyMSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IjIuLURpdmlkZS1pbnRvLWJhdGNoIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjY5LjM1NjQ0NSIgeT0iNTYiPjIuIERpdmlkZSBpbnRvIGJhdGNoZXMgZm9yIGVhY2ggQ1BVPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iaW5pdGlhbC1sYWJlbCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTI1LjM2NzE4OCIgeT0iOTEiPjEuIEluaXRpYWwgZGF0YSBzZXF1ZW5jZTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 15: parallelFoldMap algorithm" id="fig:map-reduce:parallel-fold-map" />
<p class="caption">Figure 15: <em>parallelFoldMap</em> algorithm</p>
</div>
<p>Scala provides some simple tools to distribute work amongst threads. We could use the <a href="http://docs.scala-lang.org/overviews/parallel-collections/overview.html">parallel collections library</a> to implement a solution, but let’s challenge ourselves by diving a bit deeper and implementing the algorithm ourselves using <code>Futures</code>.</p>
<h3 id="futures-thread-pools-and-executioncontexts"><span class="header-section-number">9.3.1</span> <em>Futures</em>, Thread Pools, and ExecutionContexts</h3>
<p>We already know a fair amount about the monadic nature of <code>Futures</code>. Let’s take a moment for a quick recap, and to describe how Scala futures are scheduled behind the scenes.</p>
<p><code>Futures</code> run on a thread pool, determined by an implicit <code>ExecutionContext</code> parameter. Whenever we create a <code>Future</code>, whether through a call to <code>Future.apply</code> or some other combinator, we must have an implicit <code>ExecutionContext</code> in scope:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Future</span>
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span>

<span class="kw">val</span> future1 = Future {
  (<span class="dv">1</span> to <span class="dv">100</span>).<span class="fu">toList</span>.<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ + _)
}
<span class="co">// future1: scala.concurrent.Future[Int] = Future(&lt;not completed&gt;)</span>

<span class="kw">val</span> future2 = Future {
  (<span class="dv">100</span> to <span class="dv">200</span>).<span class="fu">toList</span>.<span class="fu">foldLeft</span>(<span class="dv">0</span>)(_ + _)
}
<span class="co">// future2: scala.concurrent.Future[Int] = Future(&lt;not completed&gt;)</span></code></pre></div>
<p>In this example we’ve imported a <code>ExecutionContext.Implicits.global</code>. This default context allocates a thread pool with one thread per CPU in our machine. When we create a <code>Future</code> the <code>ExecutionContext</code> schedules it for execution. If there is a free thread in the pool, the <code>Future</code> starts executing immediately. Most modern machines have at least two CPUs, so in our example it is likely that <code>future1</code> and <code>future2</code> will execute in parellel.</p>
<p>Some combinators create new <code>Futures</code> that schedule work based on the results of other <code>Futures</code>. The <code>map</code> and <code>flatMap</code> methods, for example, schedule computations that run as soon as their input values are computed and a CPU is available:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> future3 = future1.<span class="fu">map</span>(_.<span class="fu">toString</span>)
<span class="co">// future3: scala.concurrent.Future[String] = Future(&lt;not completed&gt;)</span>

<span class="kw">val</span> future4 = <span class="kw">for</span> {
  a &lt;- future1
  b &lt;- future2
} <span class="kw">yield</span> a + b
<span class="co">// future4: scala.concurrent.Future[Int] = Future(&lt;not completed&gt;)</span></code></pre></div>
<p>As we saw in Section 7.2, we can convert a <code>List[Future[A]]</code> to a <code>Future[List[A]]</code> using <code>Future.sequence</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Future.<span class="fu">sequence</span>(List(Future(<span class="dv">1</span>), Future(<span class="dv">2</span>), Future(<span class="dv">3</span>)))
<span class="co">// res8: scala.concurrent.Future[List[Int]] = Future(&lt;not completed&gt;)</span></code></pre></div>
<p>or an instance of <code>Traverse</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Applicative</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Traverse</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">traverse</span>._  <span class="co">// for sequence</span>

List(Future(<span class="dv">1</span>), Future(<span class="dv">2</span>), Future(<span class="dv">3</span>)).<span class="fu">sequence</span>
<span class="co">// res9: scala.concurrent.Future[List[Int]] = Future(&lt;not completed&gt;)</span></code></pre></div>
<p>An <code>ExecutionContext</code> is required in either case. Finally, we can use <code>Await.result</code> to block on a <code>Future</code> until a result is available:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._

Await.<span class="fu">result</span>(Future(<span class="dv">1</span>), <span class="fl">1.</span>second) <span class="co">// wait for the result</span>
<span class="co">// res10: Int = 1</span></code></pre></div>
<p>There are also <code>Monad</code> and <code>Monoid</code> implementations for <code>Future</code> available from <code>cats.instances.future</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.{Monad, Monoid}
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Monad and Monoid</span>

Monad[Future].<span class="fu">pure</span>(<span class="dv">42</span>)

Monoid[Future[Int]].<span class="fu">combine</span>(Future(<span class="dv">1</span>), Future(<span class="dv">2</span>))</code></pre></div>
<h3 id="dividing-work"><span class="header-section-number">9.3.2</span> Dividing Work</h3>
<p>Now we’ve refreshed our memory of <code>Futures</code>, let’s look at how we can divide work into batches. We can query the number of available CPUs on our machine using an API call from the Java standard library:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">Runtime.<span class="fu">getRuntime</span>.<span class="fu">availableProcessors</span>
<span class="co">// res15: Int = 2</span></code></pre></div>
<p>We can partition a sequence (actually anything that implements <code>Vector</code>) using the <code>grouped</code> method. We’ll use this to split off batches of work for each CPU:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="dv">1</span> to <span class="dv">10</span>).<span class="fu">toList</span>.<span class="fu">grouped</span>(<span class="dv">3</span>).<span class="fu">toList</span>
<span class="co">// res16: List[List[Int]] = List(List(1, 2, 3), List(4, 5, 6), List(7, 8, 9), List(10))</span></code></pre></div>
<h3 id="implementing-parallelfoldmap"><span class="header-section-number">9.3.3</span> Implementing <em>parallelFoldMap</em></h3>
<p>Implement a parallel version of <code>foldMap</code> called <code>parallelFoldMap</code>. Here is the type signature:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> parallelFoldMap[A, B : Monoid]
      (values: Vector[A])
      (func: A =&gt; B): Future[B] = ???</code></pre></div>
<p>Use the techniques described above to split the work into batches, one batch per CPU. Process each batch in a parallel thread. Refer back to Figure 15 if you need to review the overall algorithm.</p>
<p>For bonus points, process the batches for each CPU using your implementation of <code>foldMap</code> from above.</p>
<div class="solution">
<p>Here is an annotated solution that splits out each <code>map</code> and <code>fold</code> into a separate line of code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>.<span class="fu">Duration</span>

<span class="kw">def</span> parallelFoldMap[A, B: Monoid]
      (values: Vector[A])
      (func: A =&gt; B): Future[B] = {
  <span class="co">// Calculate the number of items to pass to each CPU:</span>
  <span class="kw">val</span> numCores  = Runtime.<span class="fu">getRuntime</span>.<span class="fu">availableProcessors</span>
  <span class="kw">val</span> groupSize = (<span class="fl">1.0</span> * values.<span class="fu">size</span> / numCores).<span class="fu">ceil</span>.<span class="fu">toInt</span>

  <span class="co">// Create one group for each CPU:</span>
  <span class="kw">val</span> groups: Iterator[Vector[A]] =
    values.<span class="fu">grouped</span>(groupSize)

  <span class="co">// Create a future to foldMap each group:</span>
  <span class="kw">val</span> futures: Iterator[Future[B]] =
    groups map { group =&gt;
      Future {
        group.<span class="fu">foldLeft</span>(Monoid[B].<span class="fu">empty</span>)(_ |+| <span class="fu">func</span>(_))
      }
    }

  <span class="co">// foldMap over the groups to calculate a final result:</span>
  Future.<span class="fu">sequence</span>(futures) map { iterable =&gt;
    iterable.<span class="fu">foldLeft</span>(Monoid[B].<span class="fu">empty</span>)(_ |+| _)
  }
}

<span class="kw">val</span> result: Future[Int] =
  <span class="fu">parallelFoldMap</span>((<span class="dv">1</span> to <span class="dv">1000000</span>).<span class="fu">toVector</span>)(identity)

Await.<span class="fu">result</span>(result, <span class="fl">1.</span>second)
<span class="co">// res19: Int = 1784293664</span></code></pre></div>
<p>We can re-use our definition of <code>foldMap</code> for a more concise solution. Note that the local maps and reduces in steps 3 and 4 of Figure 15 are actually equivalent to a single call to <code>foldMap</code>, shortening the entire algorithm as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> parallelFoldMap[A, B: Monoid]
      (values: Vector[A])
      (func: A =&gt; B): Future[B] = {
  <span class="kw">val</span> numCores  = Runtime.<span class="fu">getRuntime</span>.<span class="fu">availableProcessors</span>
  <span class="kw">val</span> groupSize = (<span class="fl">1.0</span> * values.<span class="fu">size</span> / numCores).<span class="fu">ceil</span>.<span class="fu">toInt</span>

  <span class="kw">val</span> groups: Iterator[Vector[A]] =
    values.<span class="fu">grouped</span>(groupSize)

  <span class="kw">val</span> futures: Iterator[Future[B]] =
    groups.<span class="fu">map</span>(group =&gt; Future(<span class="fu">foldMap</span>(group)(func)))

  Future.<span class="fu">sequence</span>(futures) map { iterable =&gt;
    iterable.<span class="fu">foldLeft</span>(Monoid[B].<span class="fu">empty</span>)(_ |+| _)
  }
}

<span class="kw">val</span> result: Future[Int] =
  <span class="fu">parallelFoldMap</span>((<span class="dv">1</span> to <span class="dv">1000000</span>).<span class="fu">toVector</span>)(identity)

Await.<span class="fu">result</span>(result, <span class="fl">1.</span>second)
<span class="co">// res21: Int = 1784293664</span></code></pre></div>
</div>
<h3 id="parallelfoldmap-with-more-cats"><span class="header-section-number">9.3.4</span> <em>parallelFoldMap</em> with more Cats</h3>
<p>Although we implemented <code>foldMap</code> ourselves above, the method is also available as part of the <code>Foldable</code> type class we discussed in Section 7.1.</p>
<p>Reimplement <code>parallelFoldMap</code> using Cats’ <code>Foldable</code> and <code>Traverseable</code> type classes.</p>
<div class="solution">
<p>We’ll restate all of the necessary imports for completeness:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Monoid</span>
<span class="kw">import</span> cats.<span class="fu">Foldable</span>
<span class="kw">import</span> cats.<span class="fu">Traverse</span>

<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">future</span>._ <span class="co">// for Applicative and Monad</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">vector</span>._ <span class="co">// for Foldable and Traverse</span>

<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">foldable</span>._  <span class="co">// for combineAll and foldMap</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">traverse</span>._  <span class="co">// for traverse</span>

<span class="kw">import</span> scala.<span class="fu">concurrent</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._
<span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">ExecutionContext</span>.<span class="fu">Implicits</span>.<span class="fu">global</span></code></pre></div>
<p>Here’s the implementation of <code>parallelFoldMap</code> delegating as much of the method body to Cats as possible:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> parallelFoldMap[A, B: Monoid]
      (values: Vector[A])
      (func: A =&gt; B): Future[B] = {
  <span class="kw">val</span> numCores  = Runtime.<span class="fu">getRuntime</span>.<span class="fu">availableProcessors</span>
  <span class="kw">val</span> groupSize = (<span class="fl">1.0</span> * values.<span class="fu">size</span> / numCores).<span class="fu">ceil</span>.<span class="fu">toInt</span>

  values
    .<span class="fu">grouped</span>(groupSize)
    .<span class="fu">toVector</span>
    .<span class="fu">traverse</span>(group =&gt; Future(group.<span class="fu">toVector</span>.<span class="fu">foldMap</span>(func)))
    .<span class="fu">map</span>(_.<span class="fu">combineAll</span>)
}

<span class="kw">val</span> future: Future[Int] =
  <span class="fu">parallelFoldMap</span>((<span class="dv">1</span> to <span class="dv">1000</span>).<span class="fu">toVector</span>)(_ * <span class="dv">1000</span>)

Await.<span class="fu">result</span>(future, <span class="fl">1.</span>second)
<span class="co">// res3: Int = 500500000</span></code></pre></div>
<p>The call to <code>vector.grouped</code> returns an <code>Iterable[Iterator[Int]]</code>. We sprinkle calls to <code>toVector</code> through the code to convert the data back to a form that Cats can understand. The call to <code>traverse</code> creates a <code>Future[Vector[Int]]</code> containing one <code>Int</code> per batch. The call to <code>map</code> then combines the <code>match</code> using the <code>combineAll</code> method from <code>Foldable</code>.</p>
</div>
<h2 id="summary-8"><span class="header-section-number">9.4</span> Summary</h2>
<p>In this case study we implemented a system that imitates map-reduce as performed on a cluster. Our algorithm followed three steps:</p>
<ol style="list-style-type: decimal">
<li>batch the data and send one batch to each “node”;</li>
<li>perform a local map-reduce on each batch;</li>
<li>combine the results using monoid addition.</li>
</ol>
<p>Our toy system emulates the batching behaviour of real-world map-reduce systems such as Hadoop. However, in reality we are running all of our work on a single machine where communcation between nodes is negligible. We don’t actually need to batch data to gain efficient parallel processing of a list. We can simply map using a <code>Functor</code> and reduce using a <code>Monoid</code>.</p>
<p>Regardless of the batching strategy, mapping and reducing with <code>Monoids</code> is a powerful and general framework that isn’t limited to simple tasks like addition and string concatenation. Most of the tasks data scientists perform in their day-to-day analyses can be cast as monoids. There are monoids for all the following:</p>
<ul>
<li>approximate sets such as the Bloom filter;</li>
<li>set cardinality estimators, such as the HyperLogLog algorithm;</li>
<li>vectors and vector operations like stochastic gradient descent;</li>
<li>quantile estimators such as the t-digest</li>
</ul>
<p>to name but a few.</p>
<h1 id="case-study-data-validation"><span class="header-section-number">10</span> Case Study: Data Validation</h1>
<p>In this case study we will build a library for validation. What do we mean by validation? Almost all programs must check their input meets certain criteria. Usernames must not be blank, email addresses must be valid, and so on. This type of validation often occurs in web forms, but it could be performed on configuration files, on web service responses, and any other case where we have to deal with data that we can’t guarantee is correct. Authentication, for example, is just a specialised form of validation.</p>
<p>We want to build a library that performs these checks. What design goals should we have? For inspiration, let’s look at some examples of the types of checks we want to perform:</p>
<ul>
<li><p>A user must be over 18 years old or must have parental consent.</p></li>
<li><p>A <code>String</code> ID must be parsable as a <code>Int</code> and the <code>Int</code> must correspond to a valid record ID.</p></li>
<li><p>A bid in an auction must apply to one or more items and have a positive value.</p></li>
<li><p>A username must contain at least four characters and all characters must be alphanumeric.</p></li>
<li><p>An email address must contain a single <code>@</code> sign. Split the string at the <code>@</code>. The string to the left must not be empty. The string to the right must be at least three characters long and contain a dot.</p></li>
</ul>
<p>With these examples in mind we can state some goals:</p>
<ul>
<li><p>We should be able to associate meaningful messages with each validation failure, so the user knows why their data is not valid.</p></li>
<li><p>We should be able to combine small checks into larger ones. Taking the username example above, we should be able to express this by combining a check of length and a check for alphanumeric values.</p></li>
<li><p>We should be able to transform data while we are checking it. There is an example above requiring we parse data, changing its type from <code>String</code> to <code>Int</code>.</p></li>
<li><p>Finally, we should be able to accumulate all the failures in one go, so the user can correct all the issues before resubmitting.</p></li>
</ul>
<p>These goals assume we’re checking a single piece of data. We will also need to combine checks across multiple pieces of data. For a login form, for example, we’ll need to combine the check results for the username and the password. This will turn out to be quite a small component of the library, so the majority of our time will focus on checking a single data item.</p>
<h2 id="sketching-the-library-structure"><span class="header-section-number">10.1</span> Sketching the Library Structure</h2>
<p>Let’s start at the bottom, checking individual pieces of data. Before we start coding let’s try to develop a feel for what we’ll be building. We can use a graphical notation to help us. We’ll go through our goals one by one.</p>
<p><strong>Providing error messages</strong></p>
<p>Our first goal requires us to associate useful error messages with a check failure. The output of a check could be either the value being checked, if it passed the check, or some kind of error message. We can abstractly represent this as a value in a context, where the context is the possibility of an error message as shown in Figure 16.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTkyMXB4IiBoZWlnaHQ9IjM2MHB4IiB2aWV3Qm94PSIwIDAgMTkyMSAzNjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5yZXN1bHQ8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8Y2lyY2xlIGlkPSJwYXRoLTEiIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjgwIj48L2NpcmNsZT4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJyZXN1bHQiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE5MjEiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4NjEuMDAwMDAwLCAzOC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJGW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTAuMSIgeT0iMjc2Ij5GW0FdPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0xMSI+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGNpcmNsZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNzgiPjwvY2lyY2xlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSIyIiB5PSIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 16: A validation result" id="fig:validation:result" />
<p class="caption">Figure 16: A validation result</p>
</div>
<p>A check itself is therefore a function that transforms a value into a value in a context as shown in Figure 17.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTkyMXB4IiBoZWlnaHQ9IjM2MHB4IiB2aWV3Qm94PSIwIDAgMTkyMSAzNjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5jaGVjazwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPgogICAgICAgIDxjaXJjbGUgaWQ9InBhdGgtMSIgY3g9IjgwIiBjeT0iMTAwIiByPSI4MCI+PC9jaXJjbGU+CiAgICAgICAgPGNpcmNsZSBpZD0icGF0aC0yIiBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCI+PC9jaXJjbGU+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iY2hlY2siPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE5MjEiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0zIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3MDIuMDAwMDAwLCA0MC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8Y2lyY2xlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iODAiIGN5PSIxMDAiIHI9Ijc4Ij48L2NpcmNsZT4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzE4LjAwMDAwMCwgMC4wMDAwMDApIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8Y2lyY2xlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iMTAwIiBjeT0iMTAwIiByPSI3OCI+PC9jaXJjbGU+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIiIHk9IjIiIHdpZHRoPSIxOTYiIGhlaWdodD0iMTk2IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIyMDAgODAgMjQwIDgwIDI0MCA2MCAyODAgOTkuNDk3NzY3MSAyNDAgMTQwIDI0MCAxMjAgMjAwIDEyMCI+PC9wb2x5Z29uPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBLT0mZ3Q7LUZbQV0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijg0Ny4xIiB5PSIzMTQiPkEgPSZndDsgRltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 17: A validation check" id="fig:validation:check" />
<p class="caption">Figure 17: A validation check</p>
</div>
<p><strong>Combine checks</strong></p>
<p>How do we combine smaller checks into larger ones? Is this an applicative or semigroupal as shown in Figure 18?</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjAxN3B4IiBoZWlnaHQ9IjI3MnB4IiB2aWV3Qm94PSIwIDAgMjAxNyAyNzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5hcHBsaWNhdGl2ZTwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTEiIGN4PSI2OC4xMjM5ODA0IiBjeT0iODUuMjEwNTI2MyIgcng9IjY4LjEyMzk4MDQiIHJ5PSI2OC4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMiIgY3g9Ijg2LjEyMzk4MDQiIGN5PSI4NS4yMTA1MjYzIiByeD0iNjguMTIzOTgwNCIgcnk9IjY4LjIxMDUyNjMiPjwvZWxsaXBzZT4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0zIiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2OC4xMjM5ODA0IiByeT0iNjguMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTQiIGN4PSI4NS4xMjM5ODA0IiBjeT0iODYuMjEwNTI2MyIgcng9IjY4LjEyMzk4MDQiIHJ5PSI2OC4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtNSIgY3g9IjY4LjEyMzk4MDQiIGN5PSI4NS4yMTA1MjYzIiByeD0iNjguMTIzOTgwNCIgcnk9IjY4LjIxMDUyNjMiPjwvZWxsaXBzZT4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC02IiBjeD0iODkuMTIzOTgwNCIgY3k9Ijg2LjIxMDUyNjMiIHJ4PSI2OC4xMjM5ODA0IiByeT0iNjguMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTciIGN4PSIyNDAuMTIzOTgiIGN5PSI4Ni4yMTA1MjYzIiByeD0iNjguMTIzOTgwNCIgcnk9IjY4LjIxMDUyNjMiPjwvZWxsaXBzZT4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJhcHBsaWNhdGl2ZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTQ0LjAwMDAwMCwgLTYwLjAwMDAwMCkiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIxMDUiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC03IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4NC4wMDAwMDAsIDYxLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNzIuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMiI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iODYuMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSIyIiB5PSIyIiB3aWR0aD0iMTY2LjMwOTk1MSIgaGVpZ2h0PSIxNjYuNTI2MzE2IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNzEgNzAuMDUyNjMxNiAyMDUuMDYxOTkgNzAuMDUyNjMxNiAyMDUuMDYxOTkgNTMgMjM5LjEyMzk4IDg2LjY3NzA0MzYgMjA1LjA2MTk5IDEyMS4yMTA1MjYgMjA1LjA2MTk5IDEwNC4xNTc4OTUgMTcxIDEwNC4xNTc4OTUiPjwvcG9seWdvbj4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxOTEuOTM2ODY4IiB5PSIzMjUiPkEgPSZndDsgRltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU4NC4wMDAwMDAsIDYwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNzMuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIiIHk9IjIiIHdpZHRoPSIxNjYuMzA5OTUxIiBoZWlnaHQ9IjE2Ni41MjYzMTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC00Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI4NS4xMjM5ODA0IiBjeT0iODYuMjEwNTI2MyIgcng9IjY2LjEyMzk4MDQiIHJ5PSI2Ni4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNzIgNzEuMDUyNjMxNiAyMDYuMDYxOTkgNzEuMDUyNjMxNiAyMDYuMDYxOTkgNTQgMjQwLjEyMzk4IDg3LjY3NzA0MzYgMjA2LjA2MTk5IDEyMi4yMTA1MjYgMjA2LjA2MTk5IDEwNS4xNTc4OTUgMTcyIDEwNS4xNTc4OTUiPjwvcG9seWdvbj4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI2OTEuMzUxMjIzIiB5PSIzMjQiPkEgPSZndDsgRltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstRlsoQSwtQSldIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxNTgzLjYzNDI2IiB5PSIzMjQiPkEgPSZndDsgRlsoQSwgQSldPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTQ2MC4wMDAwMDAsIDYwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNzEgNjguMDUyNjMxNiAyMDUuMDYxOTkgNjguMDUyNjMxNiAyMDUuMDYxOTkgNTEgMjM5LjEyMzk4IDg0LjY3NzA0MzYgMjA1LjA2MTk5IDExOS4yMTA1MjYgMjA1LjA2MTk5IDEwMi4xNTc4OTUgMTcxIDEwMi4xNTc4OTUiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC00IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNzIuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIuNjkwMDQ4OTQiIHk9IjIiIHdpZHRoPSIzMjMuNjQ0MzcyIiBoZWlnaHQ9IjE2Ni41MjYzMTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC02Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI4OS4xMjM5ODA0IiBjeT0iODYuMjEwNTI2MyIgcng9IjY2LjEyMzk4MDQiIHJ5PSI2Ni4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNyI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iMjQwLjEyMzk4IiBjeT0iODYuMjEwNTI2MyIgcng9IjY2LjEyMzk4MDQiIHJ5PSI2Ni4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iMTM0NCAxMjcgMTM4NCAxMjcgMTM4NCAxMDcgMTQyNCAxNDYuNDk3NzY3IDEzODQgMTg3IDEzODQgMTY3IDEzNDQgMTY3Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIsIiBmb250LWZhbWlseT0iRmlyYU1vbm8tQm9sZCwgRmlyYSBNb25vIiBmb250LXNpemU9IjU2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI0Y2QTYyMyI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTQwLjIiIHk9IjE2OSI+LDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IikudHVwbGVkIiBmb250LWZhbWlseT0iRmlyYU1vbm8tQm9sZCwgRmlyYSBNb25vIiBmb250LXNpemU9IjU2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI0Y2QTYyMyI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTA0My4xIiB5PSIxNjkiPikudHVwbGVkPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iKCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI1NiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjM5LjIiIHk9IjE2OSI+KDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 18: Applicative combination of checks" id="fig:validation:applicative" />
<p class="caption">Figure 18: Applicative combination of checks</p>
</div>
<p>Not really. With applicative combination, both checks are applied to the same value and result in a tuple with the value repeated. What we want feels more like a monoid as shown in Figure 19. We can define a sensible identity—a check that always passes—and two binary combination operators—<em>and</em> and <em>or</em>:</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTY0M3B4IiBoZWlnaHQ9IjI3MHB4IiB2aWV3Qm94PSIwIDAgMTY0MyAyNzAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5tb25vaWQ8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC0xIiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2OC4xMjM5ODA0IiByeT0iNjguMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTIiIGN4PSI4Ni4xMjM5ODA0IiBjeT0iODUuMjEwNTI2MyIgcng9IjY4LjEyMzk4MDQiIHJ5PSI2OC4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMyIgY3g9IjY4LjEyMzk4MDQiIGN5PSI4NS4yMTA1MjYzIiByeD0iNjguMTIzOTgwNCIgcnk9IjY4LjIxMDUyNjMiPjwvZWxsaXBzZT4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC00IiBjeD0iODUuMTIzOTgwNCIgY3k9Ijg2LjIxMDUyNjMiIHJ4PSI2OC4xMjM5ODA0IiByeT0iNjguMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTUiIGN4PSI2OC4xMjM5ODA0IiBjeT0iODUuMjEwNTI2MyIgcng9IjY4LjEyMzk4MDQiIHJ5PSI2OC4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtNiIgY3g9Ijg1LjEyMzk4MDQiIGN5PSI4Ni4yMTA1MjYzIiByeD0iNjguMTIzOTgwNCIgcnk9IjY4LjIxMDUyNjMiPjwvZWxsaXBzZT4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJtb25vaWQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMzkuMDAwMDAwLCAtNjAuMDAwMDAwKSI+CiAgICAgICAgICAgIDxyZWN0IGlkPSJCYWNrZ3JvdW5kIiB4PSIwIiB5PSIwIiB3aWR0aD0iMTkyMSIgaGVpZ2h0PSIzNjAiPjwvcmVjdD4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTciIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzOS4wMDAwMDAsIDYxLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNzIuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMiI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iODYuMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSIyIiB5PSIyIiB3aWR0aD0iMTY2LjMwOTk1MSIgaGVpZ2h0PSIxNjYuNTI2MzE2IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNzEgNzAuMDUyNjMxNiAyMDUuMDYxOTkgNzAuMDUyNjMxNiAyMDUuMDYxOTkgNTMgMjM5LjEyMzk4IDg2LjY3NzA0MzYgMjA1LjA2MTk5IDEyMS4yMTA1MjYgMjA1LjA2MTk5IDEwNC4xNTc4OTUgMTcxIDEwNC4xNTc4OTUiPjwvcG9seWdvbj4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIyNDYuOTM2ODY4IiB5PSIzMjUiPkEgPSZndDsgRltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDczOS4wMDAwMDAsIDYwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNjguMTIzOTgwNCIgY3k9Ijg1LjIxMDUyNjMiIHJ4PSI2Ni4xMjM5ODA0IiByeT0iNjYuMjEwNTI2MyI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNzMuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIiIHk9IjIiIHdpZHRoPSIxNjYuMzA5OTUxIiBoZWlnaHQ9IjE2Ni41MjYzMTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC00Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI4NS4xMjM5ODA0IiBjeT0iODYuMjEwNTI2MyIgcng9IjY2LjEyMzk4MDQiIHJ5PSI2Ni4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxNzIgNzEuMDUyNjMxNiAyMDYuMDYxOTkgNzEuMDUyNjMxNiAyMDYuMDYxOTkgNTQgMjQwLjEyMzk4IDg3LjY3NzA0MzYgMjA2LjA2MTk5IDEyMi4yMTA1MjYgMjA2LjA2MTk5IDEwNS4xNTc4OTUgMTcyIDEwNS4xNTc4OTUiPjwvcG9seWdvbj4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI4NDYuMzUxMjIzIiB5PSIzMjQiPkEgPSZndDsgRltBXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstRltBXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTQ0Ni42MzQyNiIgeT0iMzI0Ij5BID0mZ3Q7IEZbQV08L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC01IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzM5LjAwMDAwMCwgNjAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI2OC4xMjM5ODA0IiBjeT0iODUuMjEwNTI2MyIgcng9IjY2LjEyMzk4MDQiIHJ5PSI2Ni4yMTA1MjYzIj48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjE3MSA2OC4wNTI2MzE2IDIwNS4wNjE5OSA2OC4wNTI2MzE2IDIwNS4wNjE5OSA1MSAyMzkuMTIzOTggODQuNjc3MDQzNiAyMDUuMDYxOTkgMTE5LjIxMDUyNiAyMDUuMDYxOTkgMTAyLjE1Nzg5NSAxNzEgMTAyLjE1Nzg5NSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI3Mi4wMDAwMDAsIDAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iMi42OTAwNDg5NCIgeT0iMiIgd2lkdGg9IjE2Ni4zMDk5NTEiIGhlaWdodD0iMTY2LjUyNjMxNiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTYiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8ZWxsaXBzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9Ijg1LjEyMzk4MDQiIGN5PSI4Ni4yMTA1MjYzIiByeD0iNjYuMTIzOTgwNCIgcnk9IjY2LjIxMDUyNjMiPjwvZWxsaXBzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIxMjIxIDEyNyAxMjYxIDEyNyAxMjYxIDEwNyAxMzAxIDE0Ni40OTc3NjcgMTI2MSAxODcgMTI2MSAxNjcgMTIyMSAxNjciPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9InwrfCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI1NiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYxMS4xIiB5PSIxNjkiPnwrfDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 19: Monoid combination of checks" id="fig:validation:monoid" />
<p class="caption">Figure 19: Monoid combination of checks</p>
</div>
<p>We’ll probably be using <em>and</em> and <em>or</em> about equally often with our validation library and it will be annoying to continuously switch between two monoids for combining rules. We consequently won’t actually use the monoid API: we’ll use two separate methods, <code>and</code> and <code>or</code>, instead.</p>
<p><strong>Accumulating errors as we check</strong></p>
<p>Monoids also feel like a good mechanism for accumulating error messages. If we store messages as a <code>List</code> or <code>NonEmptyList</code>, we can even use a pre-existing monoid from inside Cats.</p>
<p><strong>Transforming data as we check it</strong></p>
<p>In addition to checking data, we also have the goal of transforming it. This seems like it should be a <code>map</code> or a <code>flatMap</code> depending on whether the transform can fail or not, so it seems we also want checks to be a monad as shown in Figure 20.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTYxNHB4IiBoZWlnaHQ9IjU0MnB4IiB2aWV3Qm94PSIwIDAgMTYxNCA1NDIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5tb25hZDwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTEiIHBvaW50cz0iMjc5LjM4NTY2MyAxMDAuMDEzNDcxIDI0NS4xNTEyNTcgMTE3Ljg5NTggMjUxLjY4OTQ0NyA4MC4wMjA0MTk2IDIyMy45OTMyMyA1My4xOTY5MjY1IDI2Mi4yNjg0NiA0Ny42NzA5ODMxIDI3OS4zODU2NjMgMTMuMjEwODIzOSAyOTYuNTAyODY3IDQ3LjY3MDk4MzEgMzM0Ljc3ODA5NyA1My4xOTY5MjY1IDMwNy4wODE4OCA4MC4wMjA0MTk2IDMxMy42MjAwNyAxMTcuODk1OCI+PC9wb2x5Z29uPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTIiIGN4PSI1My4xNjgzMjkiIGN5PSI2Ni4xMDQyODUzIiByeD0iNTMuMTY4MzI5IiByeT0iNTIuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTMiIHBvaW50cz0iMjY3LjAyNjg2MyA5OC4xMzYyNDk2IDIzMi43OTI0NTYgMTE2LjAxODU3OCAyMzkuMzMwNjQ2IDc4LjE0MzE5ODMgMjExLjYzNDQyOSA1MS4zMTk3MDUyIDI0OS45MDk2NTkgNDUuNzkzNzYxNyAyNjcuMDI2ODYzIDExLjMzMzYwMjYgMjg0LjE0NDA2NiA0NS43OTM3NjE3IDMyMi40MTkyOTYgNTEuMzE5NzA1MiAyOTQuNzIzMDc5IDc4LjE0MzE5ODMgMzAxLjI2MTI2OSAxMTYuMDE4NTc4Ij48L3BvbHlnb24+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtNCIgY3g9IjUzLjI5Njk1NTciIGN5PSI2Ny4zMjg4NDExIiByeD0iNTMuMTY4MzI5IiByeT0iNTIuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTUiIGN4PSI1My40MjI2ODEiIGN5PSI2Ni4zMjg4NDExIiByeD0iNTMuMTY4MzI5IiByeT0iNTIuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTYiIGN4PSI1My42MjY3NDI5IiBjeT0iNjYuMzUxNDU4MiIgcng9IjUzLjE2ODMyOSIgcnk9IjUyLjg5MzQ2MTQiPjwvZWxsaXBzZT4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC03IiBwb2ludHM9IjI3OS44NDQwNzcgOTkuNDg1MTk5NSAyNDUuNjA5NjcxIDExNy4zNjc1MjggMjUyLjE0Nzg2MSA3OS40OTIxNDgyIDIyNC40NTE2NDQgNTIuNjY4NjU1MSAyNjIuNzI2ODc0IDQ3LjE0MjcxMTcgMjc5Ljg0NDA3NyAxMi42ODI1NTI1IDI5Ni45NjEyODEgNDcuMTQyNzExNyAzMzUuMjM2NTExIDUyLjY2ODY1NTEgMzA3LjU0MDI5NCA3OS40OTIxNDgyIDMxNC4wNzg0ODQgMTE3LjM2NzUyOCI+PC9wb2x5Z29uPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTgiIGN4PSI1My4xODM4MDI5IiBjeT0iNjYuNTc2MDEzOSIgcng9IjUzLjE2ODMyOSIgcnk9IjUyLjg5MzQ2MTQiPjwvZWxsaXBzZT4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC05IiBwb2ludHM9IjU1LjY0MDk4MjYgODcuMjYwNjQzOCAyMS40MDY1NzYxIDEwNS4xNDI5NzMgMjcuOTQ0NzY2IDY3LjI2NzU5MjUgMC4yNDg1NDkzMjMgNDAuNDQ0MDk5NCAzOC41MjM3Nzk0IDM0LjkxODE1NTkgNTUuNjQwOTgyNiAwLjQ1Nzk5Njc2OSA3Mi43NTgxODU4IDM0LjkxODE1NTkgMTExLjAzMzQxNiA0MC40NDQwOTk0IDgzLjMzNzE5OTIgNjcuMjY3NTkyNSA4OS44NzUzODkxIDEwNS4xNDI5NzMiPjwvcG9seWdvbj4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJtb25hZCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1NS4wMDAwMDAsIC0zNy4wMDAwMDApIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTIxIiBoZWlnaHQ9IjYyMSI+PC9yZWN0PgogICAgICAgICAgICA8ZyBpZD0iZmxhdG1hcCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU1LjAwMDAwMCwgMzU4LjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjAwMDAwMCwgMi4wMDAwMDApIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iU3Rhci0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTEiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTI0Ny44MTAwOTUsMTE0LjI1MDU0NSBMMjUzLjY2MDI5OCw4MC4zNjA2MzUzIEwyNTMuODQwMDk1LDc5LjMxOTA3ODcgTDI1My4wODA4NDQsNzguNTgzNzUyMSBMMjI4LjMxMDg4Myw1NC41OTQzMDY2IEwyNjIuNTU0MjQ1LDQ5LjY1MDQ1OTUgTDI2My41OTI4MzMsNDkuNTAwNTE0NSBMMjY0LjA1OTY1NSw0OC41NjA3MTM0IEwyNzkuMzg1NjYzLDE3LjcwNjU2NzkgTDI5NC43MTE2NzIsNDguNTYwNzEzNCBMMjk1LjE3ODQ5NCw0OS41MDA1MTQ1IEwyOTYuMjE3MDgyLDQ5LjY1MDQ1OTUgTDMzMC40NjA0NDQsNTQuNTk0MzA2NiBMMzA1LjY5MDQ4Myw3OC41ODM3NTIxIEwzMDQuOTMxMjMyLDc5LjMxOTA3ODcgTDMwNS4xMTEwMjksODAuMzYwNjM1MyBMMzEwLjk2MTIzMiwxMTQuMjUwNTQ1IEwyODAuMzExNjQ2LDk4LjI0MDc0NTMgTDI3OS4zODU2NjMsOTcuNzU3MDU4NyBMMjc4LjQ1OTY4MSw5OC4yNDA3NDUzIEwyNDcuODEwMDk1LDExNC4yNTA1NDUgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8ZWxsaXBzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjUzLjE2ODMyOSIgY3k9IjY2LjEwNDI4NTMiIHJ4PSI1MS4xNjgzMjkiIHJ5PSI1MC44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIxNC4yODYyNjciIHk9IjIuMDI4MjcxNDEiIHdpZHRoPSIxMjguOTIwODIzIiBoZWlnaHQ9IjEyOC4yMzM2NTQiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMzMuNDU5MzgxIDU0LjM1MDE4MjggMTYwLjA0MzU0NiA1NC4zNTAxODI4IDE2MC4wNDM1NDYgNDEuMTI2ODE3NCAxODYuNjI3NzEgNjcuMjQxNDg3NyAxNjAuMDQzNTQ2IDk0LjAyMDI3ODkgMTYwLjA0MzU0NiA4MC43OTY5MTM1IDEzMy40NTkzODEgODAuNzk2OTEzNSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTgiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU4Ni4wMDAwMDAsIDAuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9IlN0YXItMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPHBhdGggc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGQ9Ik0yMzUuNDUxMjk0LDExMi4zNzMzMjMgTDI0MS4zMDE0OTcsNzguNDgzNDE0IEwyNDEuNDgxMjk0LDc3LjQ0MTg1NzQgTDI0MC43MjIwNDMsNzYuNzA2NTMwOCBMMjE1Ljk1MjA4Miw1Mi43MTcwODUyIEwyNTAuMTk1NDQ0LDQ3Ljc3MzIzODIgTDI1MS4yMzQwMzIsNDcuNjIzMjkzMiBMMjUxLjcwMDg1NSw0Ni42ODM0OTIxIEwyNjcuMDI2ODYzLDE1LjgyOTM0NjYgTDI4Mi4zNTI4NzEsNDYuNjgzNDkyMSBMMjgyLjgxOTY5Myw0Ny42MjMyOTMyIEwyODMuODU4MjgxLDQ3Ljc3MzIzODIgTDMxOC4xMDE2NDMsNTIuNzE3MDg1MiBMMjkzLjMzMTY4Miw3Ni43MDY1MzA4IEwyOTIuNTcyNDMxLDc3LjQ0MTg1NzQgTDI5Mi43NTIyMjgsNzguNDgzNDE0IEwyOTguNjAyNDMxLDExMi4zNzMzMjMgTDI2Ny45NTI4NDUsOTYuMzYzNTI0IEwyNjcuMDI2ODYzLDk1Ljg3OTgzNzMgTDI2Ni4xMDA4OCw5Ni4zNjM1MjQgTDIzNS40NTEyOTQsMTEyLjM3MzMyMyBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMzQ3LjQzNTIwMyA1My4yNDg0MDU3IDM3NC4wMTkzNjggNTMuMjQ4NDA1NyAzNzQuMDE5MzY4IDQwLjAyNTA0MDQgNDAwLjYwMzUzMiA2Ni4xMzk3MTA3IDM3NC4wMTkzNjggOTIuOTE4NTAxOCAzNzQuMDE5MzY4IDc5LjY5NTEzNjUgMzQ3LjQzNTIwMyA3OS42OTUxMzY1Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iNDI4LjgwMDY0NyIgeT0iMi40NzczODI4OCIgd2lkdGg9IjEyOC45MjA4MjMiIGhlaWdodD0iMTI4LjIzMzY1NCIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTQiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8ZWxsaXBzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjUzLjI5Njk1NTciIGN5PSI2Ny4zMjg4NDExIiByeD0iNTEuMTY4MzI5IiByeT0iNTAuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEzMy41ODgwMDggNTUuNTc0NzM4NSAxNjAuMTcyMTcyIDU1LjU3NDczODUgMTYwLjE3MjE3MiA0Mi4zNTEzNzMyIDE4Ni43NTYzMzcgNjguNDY2MDQzNSAxNjAuMTcyMTcyIDk1LjI0NDgzNDYgMTYwLjE3MjE3MiA4Mi4wMjE0NjkzIDEzMy41ODgwMDggODIuMDIxNDY5MyI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQb2x5Z29uIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZmlsbD0iI0ZGRkZGRiIgcG9pbnRzPSI0OTMuMDgyNTk3IDIzIDUzOS4xNjUxOTQgNTYuMjY1NjE2NyA1MjEuNTYzMjA4IDExMC4wOTA1MTUgNDY0LjYwMTk4NiAxMTAuMDkwNTE1IDQ0NyA1Ni4yNjU2MTY3Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0JdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTkuNDY3MDIxMyIgeT0iMjE1Ij5BID0mZ3Q7IEZbQl08L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IkItPSZndDstKEEtPSZndDstRltDXSkiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI2NjQuNTcwNjk2IiB5PSIyMTUiPkIgPSZndDsgKEEgPSZndDsgRltDXSk8L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstRltDXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEzMjcuMTEwMyIgeT0iMjE1Ij5BID0mZ3Q7IEZbQ108L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEyNjguMDAwMDAwLCAxLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNTMuNDIyNjgxIiBjeT0iNjYuMzI4ODQxMSIgcng9IjUxLjE2ODMyOSIgcnk9IjUwLjg5MzQ2MTQiPjwvZWxsaXBzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMzMuNzEzNzMzIDUzLjAyMzg1IDE2MC4yOTc4OTggNTMuMDIzODUgMTYwLjI5Nzg5OCAzOS44MDA0ODQ3IDE4Ni44ODIwNjIgNjUuOTE1MTU0OSAxNjAuMjk3ODk4IDkyLjY5Mzk0NjEgMTYwLjI5Nzg5OCA3OS40NzA1ODA3IDEzMy43MTM3MzMgNzkuNDcwNTgwNyI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIxNS4wNzkxNzciIHk9IjIuMjUyODI3MTQiIHdpZHRoPSIxMjguOTIwODIzIiBoZWlnaHQ9IjEyOC4yMzM2NTQiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24iIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSIjRkZGRkZGIiBwb2ludHM9IjI4MC4wODI1OTcgMjMgMzI2LjE2NTE5NCA1Ni4yNjU2MTY3IDMwOC41NjMyMDggMTEwLjA5MDUxNSAyNTEuNjAxOTg2IDExMC4wOTA1MTUgMjM0IDU2LjI2NTYxNjciPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iMTE3OC41MDA5NyA1My4yMDc1OTI5IDEyMDkuNzE5NTQgNTMuMjA3NTkyOSAxMjA5LjcxOTU0IDM3LjY5ODcwNzYgMTI0MC45MzgxIDY4LjMyNzAyNDYgMTIwOS43MTk1NCA5OS43MzQyNDg4IDEyMDkuNzE5NTQgODQuMjI1MzYzNSAxMTc4LjUwMDk3IDg0LjIyNTM2MzUiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJmbGF0TWFwIiBmb250LWZhbWlseT0iRmlyYU1vbm8tQm9sZCwgRmlyYSBNb25vIiBmb250LXNpemU9IjQ1IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI0Y2QTYyMyI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjM3NS43ODE2NzMiIHk9IjgyIj5mbGF0TWFwPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0ibWFwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMjAuMDAwMDAwLCAzNy4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJBLT0mZ3Q7LUZbQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI2NS4xMzc4MTQzIiB5PSIyMTQiPkEgPSZndDsgRltCXTwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuMDAwMDAwLCAxLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNiI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNTMuNjI2NzQyOSIgY3k9IjY2LjM1MTQ1ODIiIHJ4PSI1MS4xNjgzMjkiIHJ5PSI1MC44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjIxNC43NDQ2ODEiIHk9IjIuMjc1NDQ0MjYiIHdpZHRoPSIxMjguOTIwODIzIiBoZWlnaHQ9IjEyOC4yMzM2NTQiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIxMzMuOTE3Nzk1IDU0LjU5NzM1NTcgMTYwLjUwMTk1OSA1NC41OTczNTU3IDE2MC41MDE5NTkgNDEuMzczOTkwMyAxODcuMDg2MTI0IDY3LjQ4ODY2MDYgMTYwLjUwMTk1OSA5NC4yNjc0NTE3IDE2MC41MDE5NTkgODEuMDQ0MDg2NCAxMzMuOTE3Nzk1IDgxLjA0NDA4NjQiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iU3Rhci0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTI0OC4yNjg1MDksMTEzLjcyMjI3MyBMMjU0LjExODcxMiw3OS44MzIzNjM5IEwyNTQuMjk4NTA5LDc4Ljc5MDgwNzMgTDI1My41MzkyNTgsNzguMDU1NDgwNyBMMjI4Ljc2OTI5Nyw1NC4wNjYwMzUyIEwyNjMuMDEyNjU5LDQ5LjEyMjE4ODEgTDI2NC4wNTEyNDcsNDguOTcyMjQzMSBMMjY0LjUxODA2OSw0OC4wMzI0NDIgTDI3OS44NDQwNzcsMTcuMTc4Mjk2NSBMMjk1LjE3MDA4Niw0OC4wMzI0NDIgTDI5NS42MzY5MDgsNDguOTcyMjQzMSBMMjk2LjY3NTQ5Niw0OS4xMjIxODgxIEwzMzAuOTE4ODU4LDU0LjA2NjAzNTIgTDMwNi4xNDg4OTcsNzguMDU1NDgwNyBMMzA1LjM4OTY0Niw3OC43OTA4MDczIEwzMDUuNTY5NDQzLDc5LjgzMjM2MzkgTDMxMS40MTk2NDYsMTEzLjcyMjI3MyBMMjgwLjc3MDA2LDk3LjcxMjQ3MzkgTDI3OS44NDQwNzcsOTcuMjI4Nzg3MiBMMjc4LjkxODA5NSw5Ny43MTI0NzM5IEwyNDguMjY4NTA5LDExMy43MjIyNzMgWiI+PC9wYXRoPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJCLT0mZ3Q7LUMiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI1NzAuOTAwNjE2IiB5PSIyMTQiPkIgPSZndDsgQzwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0NdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAwMS41MTAzIiB5PSIyMTQiPkEgPSZndDsgRltDXTwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjgzNy4xMTYwNTQgNTIuNDU0NzY1OCA4NjguMzM0NjIzIDUyLjQ1NDc2NTggODY4LjMzNDYyMyAzNi45NDU4ODA1IDg5OS41NTMxOTEgNjcuNTc0MTk3NSA4NjguMzM0NjIzIDk4Ljk4MTQyMTYgODY4LjMzNDYyMyA4My40NzI1MzYzIDgzNy4xMTYwNTQgODMuNDcyNTM2MyI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHRleHQgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0NSIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIzODAuMjM4Mzk1IiB5PSI4MS42MTk1NDc3Ij5tYXA8L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwLTEyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg5MzcuMDAwMDAwLCAwLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtOCI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNTMuMTgzODAyOSIgY3k9IjY2LjU3NjAxMzkiIHJ4PSI1MS4xNjgzMjkiIHJ5PSI1MC44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTMzLjQ3NDg1NSA1My4yNzEwMjI5IDE2MC4wNTkwMTkgNTMuMjcxMDIyOSAxNjAuMDU5MDE5IDQwLjA0NzY1NzUgMTg2LjY0MzE4NCA2Ni4xNjIzMjc4IDE2MC4wNTkwMTkgOTIuOTQxMTE5IDE2MC4wNTkwMTkgNzkuNzE3NzUzNiAxMzMuNDc0ODU1IDc5LjcxNzc1MzYiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSIyMTQuODQwMjk5IiB5PSIyLjUiIHdpZHRoPSIxMjguOTIwODIzIiBoZWlnaHQ9IjEyOC4yMzM2NTQiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24iIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSIjRkZGRkZGIiBwb2ludHM9IjI3OS41OTc0NDcgMjMuMDgyNzY2IDMyNS42ODAwNDQgNTYuMzQ4MzgyNyAzMDguMDc4MDU4IDExMC4xNzMyODEgMjUxLjExNjgzNiAxMTAuMTczMjgxIDIzMy41MTQ4NSA1Ni4zNDgzODI3Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ4OC4wMDAwMDAsIDE0LjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNMjQuMDY1NDEzOSwxMDEuNDk3NzE3IEwyOS45MTU2MTY5LDY3LjYwNzgwODIgTDMwLjA5NTQxNDMsNjYuNTY2MjUxNiBMMjkuMzM2MTYzMyw2NS44MzA5MjUgTDQuNTY2MjAyMTQsNDEuODQxNDc5NCBMMzguODA5NTY0MSwzNi44OTc2MzI0IEwzOS44NDgxNTIzLDM2Ljc0NzY4NzQgTDQwLjMxNDk3NDQsMzUuODA3ODg2MyBMNTUuNjQwOTgyNiw0Ljk1Mzc0MDc2IEw3MC45NjY5OTA4LDM1LjgwNzg4NjMgTDcxLjQzMzgxMjksMzYuNzQ3Njg3NCBMNzIuNDcyNDAxMSwzNi44OTc2MzI0IEwxMDYuNzE1NzYzLDQxLjg0MTQ3OTQgTDgxLjk0NTgwMTksNjUuODMwOTI1IEw4MS4xODY1NTA5LDY2LjU2NjI1MTYgTDgxLjM2NjM0ODMsNjcuNjA3ODA4MiBMODcuMjE2NTUxMywxMDEuNDk3NzE3IEw1Ni41NjY5NjUyLDg1LjQ4NzkxODEgTDU1LjY0MDk4MjYsODUuMDA0MjMxNSBMNTQuNzE1LDg1LjQ4NzkxODEgTDI0LjA2NTQxMzksMTAxLjQ5NzcxNyBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTM2LjgyOTc4NyA0MS41OTczNTU3IDE2My40MTM5NTIgNDEuNTk3MzU1NyAxNjMuNDEzOTUyIDI4LjM3Mzk5MDMgMTg5Ljk5ODExNiA1NC40ODg2NjA2IDE2My40MTM5NTIgODEuMjY3NDUxNyAxNjMuNDEzOTUyIDY4LjA0NDA4NjQgMTM2LjgyOTc4NyA2OC4wNDQwODY0Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24iIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSIjRkZGRkZGIiBwb2ludHM9IjI2My4zMDAxOTkgOC4yMTI0Mzk0MiAzMDkuMzgyNzk2IDQxLjQ3ODA1NjEgMjkxLjc4MDgxIDk1LjMwMjk1NDUgMjM0LjgxOTU4NyA5NS4zMDI5NTQ1IDIxNy4yMTc2MDIgNDEuNDc4MDU2MSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8L2c+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 20: Monadic combination of checks" id="fig:validation:monad" />
<p class="caption">Figure 20: Monadic combination of checks</p>
</div>
<p>We’ve now broken down our library into familiar abstractions and are in a good position to begin development.</p>
<h2 id="the-check-datatype"><span class="header-section-number">10.2</span> The Check Datatype</h2>
<p>Our design revolves around a <code>Check</code>, which we said was a function from a value to a value in a context. As soon as you see this description you should think of something like</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Check[A] = A =&gt; Either[String, A]</code></pre></div>
<p>Here we’ve represented the error message as a <code>String</code>. This is probably not the best representation. We may want to accumulate messages in a <code>List</code>, for example, or even use a different representation that allows for internationalization or standard error codes.</p>
<p>We could attempt to build some kind of <code>ErrorMessage</code> type that holds all the information we can think of. However, we can’t predict the user’s requirements. Instead let’s let the user specify what they want. We can do this by adding a second type parameter to <code>Check</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Check[E, A] = A =&gt; Either[E, A]</code></pre></div>
<p>We will probably want to add custom methods to <code>Check</code> so let’s declare it as a <code>trait</code> instead of a type alias:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Check[E, A] {
  <span class="kw">def</span> <span class="fu">apply</span>(value: A): Either[E, A]

  <span class="co">// other methods...</span>
}</code></pre></div>
<p>As we said in <a href="http://underscore.io/books/essential-scala">Essential Scala</a>, there are two functional programming patterns that we should consider when defining a trait:</p>
<ul>
<li>we can make it a typeclass, or;</li>
<li>we can make it an algebraic data type (and hence seal it).</li>
</ul>
<p>Type classes allow us to unify disparate data types with a common interface. This doesn’t seem like what we’re trying to do here. That leaves us with an algebraic data type. Let’s keep that thought in mind as we explore the design a bit further.</p>
<h2 id="basic-combinators"><span class="header-section-number">10.3</span> Basic Combinators</h2>
<p>Let’s add some combinator methods to <code>Check</code>, starting with <code>and</code>. This method combines two checks into one, succeeding only if both checks succeed. Think about implementing this method now. You should hit some problems. Read on when you do!</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Check[E, A] {
  <span class="kw">def</span> <span class="fu">and</span>(that: Check[E, A]): Check[E, A] =
    ???

  <span class="co">// other methods...</span>
}</code></pre></div>
<p>The problem is: what do you do when <em>both</em> checks fail? The correct thing to do is to return both errors, but we don’t currently have any way to combine <code>Es</code>. We need a <em>type class</em> that abstracts over the concept of “accumulating” errors as shown in Figure 21 What type class do we know that looks like this? What method or operator should we use to implement the <code>•</code> operation?</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTkyMXB4IiBoZWlnaHQ9IjY2MHB4IiB2aWV3Qm94PSIwIDAgMTkyMSA2NjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5lcnJvci1zZW1pZ3JvdXA8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz48L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iZXJyb3Itc2VtaWdyb3VwIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTIxIiBoZWlnaHQ9IjY2MCI+PC9yZWN0PgogICAgICAgICAgICA8dGV4dCBpZD0iRS3igKItRS09Jmd0Oy1FIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI4NDAiIHk9IjMxOSI+RSDigKIgRSA9Jmd0OyBFPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iTGlzdFtTdHJpbmddLeKAoi1MaXN0WyIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNDE5LjIiIHk9IjYwMSI+TGlzdFtTdHJpbmddIOKAoiBMaXN0W1N0cmluZ10gPSZndDsgTGlzdFtTdHJpbmddPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTciIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU4MC4wMDAwMDAsIDQyLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24tMiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHBvaW50cz0iMzY0LjUgMSA0NDEuMDYwMDUgNTYuNjI0MTMyIDQxMS44MTY3MTMgMTQ2LjYyNTg2OCAzMTcuMTgzMjg3IDE0Ni42MjU4NjggMjg3LjkzOTk1IDU2LjYyNDEzMiI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24tMiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHBvaW50cz0iNzYuNTYwMDQ5NiAwIDE1My4xMjAwOTkgNTUuNjI0MTMyIDEyMy44NzY3NjIgMTQ1LjYyNTg2OCAyOS4yNDMzMzY4IDE0NS42MjU4NjggLTEuNDIxMDg1NDdlLTE0IDU1LjYyNDEzMiI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24tMiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHBvaW50cz0iNjgzLjU2MDA1IDAgNzYwLjEyMDA5OSA1NS42MjQxMzIgNzMwLjg3Njc2MiAxNDUuNjI1ODY4IDYzNi4yNDMzMzcgMTQ1LjYyNTg2OCA2MDcgNTUuNjI0MTMyIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjQ4NSA2MCA1MjUgNjAgNTI1IDQwIDU2NSA3OS40OTc3NjcxIDUyNSAxMjAgNTI1IDEwMCA0ODUgMTAwIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8Y2lyY2xlIGlkPSJPdmFsIiBmaWxsPSIjMDAwMDAwIiBjeD0iMjE5IiBjeT0iODEiIHI9IjIwIj48L2NpcmNsZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMjAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDU2NS4wMDAwMDAsIDMzNC4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0xOCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjg5LjAwMDAwMCwgOS4wMDAwMDApIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24tMiIgcG9pbnRzPSI5NS41NjAwNDk2IDI3IDE3Mi4xMjAwOTkgODIuNjI0MTMyIDE0Mi44NzY3NjIgMTcyLjYyNTg2OCA0OC4yNDMzMzY4IDE3Mi42MjU4NjggMTkgODIuNjI0MTMyIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24tMiIgcG9pbnRzPSI3Ni41NjAwNDk2IDAgMTUzLjEyMDA5OSA1NS42MjQxMzIgMTIzLjg3Njc2MiAxNDUuNjI1ODY4IDI5LjI0MzMzNjggMTQ1LjYyNTg2OCAtMS40MjEwODU0N2UtMTQgNTUuNjI0MTMyIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTgiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuMDAwMDAwLCA1LjAwMDAwMCkiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlPSIjMDAwMDAwIiBmaWxsPSIjRkZGRkZGIj4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbi0yIiBwb2ludHM9Ijk1LjU2MDA0OTYgMjcgMTcyLjEyMDA5OSA4Mi42MjQxMzIgMTQyLjg3Njc2MiAxNzIuNjI1ODY4IDQ4LjI0MzMzNjggMTcyLjYyNTg2OCAxOSA4Mi42MjQxMzIiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbi0yIiBwb2ludHM9Ijc2LjU2MDA0OTYgMCAxNTMuMTIwMDk5IDU1LjYyNDEzMiAxMjMuODc2NzYyIDE0NS42MjU4NjggMjkuMjQzMzM2OCAxNDUuNjI1ODY4IC0xLjQyMTA4NTQ3ZS0xNCA1NS42MjQxMzIiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC0xOSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTk3LjAwMDAwMCwgMC4wMDAwMDApIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI0ZGRkZGRiI+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24tMiIgcG9pbnRzPSIxMTYuNTYwMDUgNDIgMTkzLjEyMDA5OSA5Ny42MjQxMzIgMTYzLjg3Njc2MiAxODcuNjI1ODY4IDY5LjI0MzMzNjggMTg3LjYyNTg2OCA0MCA5Ny42MjQxMzIiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbi0yIiBwb2ludHM9Ijk1LjU2MDA0OTYgMjIgMTcyLjEyMDA5OSA3Ny42MjQxMzIgMTQyLjg3Njc2MiAxNjcuNjI1ODY4IDQ4LjI0MzMzNjggMTY3LjYyNTg2OCAxOSA3Ny42MjQxMzIiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbi0yIiBwb2ludHM9Ijc2LjU2MDA0OTYgMCAxNTMuMTIwMDk5IDU1LjYyNDEzMiAxMjMuODc2NzYyIDE0NS42MjU4NjggMjkuMjQzMzM2OCAxNDUuNjI1ODY4IC0xLjQyMTA4NTQ3ZS0xNCA1NS42MjQxMzIiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iNDk0IDgyIDUzNCA4MiA1MzQgNjIgNTc0IDEwMS40OTc3NjcgNTM0IDE0MiA1MzQgMTIyIDQ5NCAxMjIiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxjaXJjbGUgaWQ9Ik92YWwiIGZpbGw9IiMwMDAwMDAiIGN4PSIyMjgiIGN5PSIxMDMiIHI9IjIwIj48L2NpcmNsZT4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 21: Combining error messages" id="fig:validation:error-semigroup" />
<p class="caption">Figure 21: Combining error messages</p>
</div>
<div class="solution">
<p>We need a <code>Semigroup</code> for <code>E</code>. Then we can combine values of <code>E</code> using the <code>combine</code> method or its associated <code>|+|</code> syntax:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">val</span> semigroup = Semigroup[List[String]]

<span class="co">// Combination using methods on Semigroup</span>
semigroup.<span class="fu">combine</span>(List(<span class="st">&quot;Badness&quot;</span>), List(<span class="st">&quot;More badness&quot;</span>))
<span class="co">// res2: List[String] = List(Badness, More badness)</span>

<span class="co">// Combination using Semigroup syntax</span>
List(<span class="st">&quot;Oh noes&quot;</span>) |+| List(<span class="st">&quot;Fail happened&quot;</span>)
<span class="co">// res4: List[String] = List(Oh noes, Fail happened)</span></code></pre></div>
<p>Note we don’t need a full <code>Monoid</code> because we don’t need the identity element. We should always try to keep our constraints as small as possible!</p>
</div>
<p>There is another semantic issue that will come up quite quickly: should <code>and</code> short-circuit if the first check fails. What do you think the most useful behaviour is?</p>
<div class="solution">
<p>We want to report all the errors we can, so we should prefer <em>not</em> short-circuiting whenever possible.</p>
<p>In the case of the <code>and</code> method, the two checks we’re combining are independent of one another. We can always run both rules and combine any errors we see.</p>
</div>
<p>Use this knowledge to implement <code>and</code>. Make sure you end up with the behaviour you expect!</p>
<div class="solution">
<p>There are at least two implementation strategies.</p>
<p>In the first we represent checks as functions. The <code>Check</code> data type becomes a simple wrapper for a function that provides our library of combinator methods. For the sake of disambiguation, we’ll call this implementation <code>CheckF</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">either</span>._    <span class="co">// for asLeft and asRight</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> CheckF[E, A](func: A =&gt; Either[E, A]) {
  <span class="kw">def</span> <span class="fu">apply</span>(a: A): Either[E, A] =
    <span class="fu">func</span>(a)

  <span class="kw">def</span> <span class="fu">and</span>(that: CheckF[E, A])
        (<span class="kw">implicit</span> s: Semigroup[E]): CheckF[E, A] =
    CheckF { a =&gt;
      (<span class="kw">this</span>(a), <span class="fu">that</span>(a)) <span class="kw">match</span> {
        <span class="kw">case</span> (<span class="fu">Left</span>(e1),  <span class="fu">Left</span>(e2))  =&gt; (e1 |+| e2).<span class="fu">asLeft</span>
        <span class="kw">case</span> (<span class="fu">Left</span>(e),   <span class="fu">Right</span>(a))  =&gt; e.<span class="fu">asLeft</span>
        <span class="kw">case</span> (<span class="fu">Right</span>(a),  <span class="fu">Left</span>(e))   =&gt; e.<span class="fu">asLeft</span>
        <span class="kw">case</span> (<span class="fu">Right</span>(a1), <span class="fu">Right</span>(a2)) =&gt; a.<span class="fu">asRight</span>
      }
    }
}</code></pre></div>
<p>Let’s test the behaviour we get. First we’ll setup some checks:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Semigroup</span>

<span class="kw">val</span> a: CheckF[List[String], Int] =
  CheckF { v =&gt;
    <span class="kw">if</span>(v &gt; <span class="dv">2</span>) v.<span class="fu">asRight</span>
    <span class="kw">else</span> List(<span class="st">&quot;Must be &gt; 2&quot;</span>).<span class="fu">asLeft</span>
  }

<span class="kw">val</span> b: CheckF[List[String], Int] =
  CheckF { v =&gt;
    <span class="kw">if</span>(v &lt; -<span class="dv">2</span>) v.<span class="fu">asRight</span>
    <span class="kw">else</span> List(<span class="st">&quot;Must be &lt; -2&quot;</span>).<span class="fu">asLeft</span>
  }

<span class="kw">val</span> check: CheckF[List[String], Int] =
  a and b</code></pre></div>
<p>Now run the check with some data:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">check</span>(<span class="dv">5</span>)
<span class="co">// res8: Either[List[String],Int] = Left(List(Must be &lt; -2))</span>

<span class="fu">check</span>(<span class="dv">0</span>)
<span class="co">// res9: Either[List[String],Int] = Left(List(Must be &gt; 2, Must be &lt; -2))</span></code></pre></div>
<p>Excellent! Everything works as expected! We’re running both checks and accumulating errors as required.</p>
<p>What happens if we try to create checks that fail with a type that we can’t accumulate? For example, there is no <code>Semigroup</code> instance for <code>Nothing</code>. What happens if we create instances of <code>CheckF[Nothing, A]</code>?</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> a: CheckF[Nothing, Int] =
  <span class="fu">CheckF</span>(v =&gt; v.<span class="fu">asRight</span>)

<span class="kw">val</span> b: CheckF[Nothing, Int] =
  <span class="fu">CheckF</span>(v =&gt; v.<span class="fu">asRight</span>)</code></pre></div>
<p>We can create checks just fine but when we come to combine them we get an error we might expect:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> check = a and b
<span class="co">// &lt;console&gt;:31: error: could not find implicit value for parameter s: cats.Semigroup[Nothing]</span>
<span class="co">//        val check = a and b</span>
<span class="co">//                      ^</span></code></pre></div>
<p>Now let’s see another implementation strategy. In this approach we model checks as an algebraic data type, with an explicit data type for each combinator. We’ll call this implementation <code>Check</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A] {
  <span class="kw">def</span> <span class="fu">and</span>(that: Check[E, A]): Check[E, A] =
    <span class="fu">And</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Either[E, A] =
    <span class="kw">this</span> <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Pure</span>(func) =&gt;
        <span class="fu">func</span>(a)

      <span class="kw">case</span> <span class="fu">And</span>(left, right) =&gt;
        (<span class="fu">left</span>(a), <span class="fu">right</span>(a)) <span class="kw">match</span> {
          <span class="kw">case</span> (<span class="fu">Left</span>(e1),  <span class="fu">Left</span>(e2))  =&gt; (e1 |+| e2).<span class="fu">asLeft</span>
          <span class="kw">case</span> (<span class="fu">Left</span>(e),   <span class="fu">Right</span>(a))  =&gt; e.<span class="fu">asLeft</span>
          <span class="kw">case</span> (<span class="fu">Right</span>(a),  <span class="fu">Left</span>(e))   =&gt; e.<span class="fu">asLeft</span>
          <span class="kw">case</span> (<span class="fu">Right</span>(a1), <span class="fu">Right</span>(a2)) =&gt; a.<span class="fu">asRight</span>
        }
    }
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> And[E, A](
  left: Check[E, A],
  right: Check[E, A]) <span class="kw">extends</span> Check[E, A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A](
  func: A =&gt; Either[E, A]) <span class="kw">extends</span> Check[E, A]</code></pre></div>
<p>Let’s see an example:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> a: Check[List[String], Int] =
  Pure { v =&gt;
    <span class="kw">if</span>(v &gt; <span class="dv">2</span>) v.<span class="fu">asRight</span>
    <span class="kw">else</span> List(<span class="st">&quot;Must be &gt; 2&quot;</span>).<span class="fu">asLeft</span>
  }

<span class="kw">val</span> b: Check[List[String], Int] =
  Pure { v =&gt;
    <span class="kw">if</span>(v &lt; -<span class="dv">2</span>) v.<span class="fu">asRight</span>
    <span class="kw">else</span> List(<span class="st">&quot;Must be &lt; -2&quot;</span>).<span class="fu">asLeft</span>
  }

<span class="kw">val</span> check: Check[List[String], Int] =
  a and b</code></pre></div>
<p>While the ADT implementation is more verbose than the function wrapper implementation, it has the advantage of cleanly separating the structure of the computation (the ADT instance we create) from the process that gives it meaning (the <code>apply</code> method). From here we have a number of options:</p>
<ul>
<li>inspect and refactor checks after they are created;</li>
<li>move the <code>apply</code> “interpreter” out into its own module;</li>
<li>implement alternative interpreters providing other functionality (for example visualizing checks).</li>
</ul>
<p>Because of its flexibility, we will use the ADT implementation for the rest of this case study.</p>
</div>
<p>Strictly speaking, <code>Either[E, A]</code> is the wrong abstraction for the output of our check. Why is this the case? What other data type could we use instead? Switch your implementation over to this new data type.</p>
<div class="solution">
<p>The implementation of <code>apply</code> for <code>And</code> is using the pattern for applicative functors. <code>Either</code> has an <code>Applicative</code> instance, but it doesn’t have the semantics we want. It fails fast instead of accumulating errors.</p>
<p>If we want to accumulate errors <code>Validated</code> is a more appropriate abstraction. As a bonus, we get more code reuse because we can lean on the applicative instance of <code>Validated</code> in the implementation of <code>apply</code>.</p>
<p>Here’s the complete implementation:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._     <span class="co">// for mapN</span>

<span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A] {
  <span class="kw">def</span> <span class="fu">and</span>(that: Check[E, A]): Check[E, A] =
    <span class="fu">And</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, A] =
    <span class="kw">this</span> <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Pure</span>(func) =&gt;
        <span class="fu">func</span>(a)

      <span class="kw">case</span> <span class="fu">And</span>(left, right) =&gt;
        (<span class="fu">left</span>(a), <span class="fu">right</span>(a)).<span class="fu">mapN</span>((_, _) =&gt; a)
    }
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> And[E, A](
  left: Check[E, A],
  right: Check[E, A]) <span class="kw">extends</span> Check[E, A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A](
  func: A =&gt; Validated[E, A]) <span class="kw">extends</span> Check[E, A]</code></pre></div>
</div>
<p>Our implementation is looking pretty good now. Implement an <code>or</code> combinator to complement <code>and</code>.</p>
<div class="solution">
<p>This reuses the same technique for <code>and</code>. We have to do a bit more work in the <code>apply</code> method. Note that it’s OK to short-circuit in this case because the choice of rules is implicit in the semantics of “or”.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._     <span class="co">// for mapN</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>._   <span class="co">// for Valid and Invalid</span>

<span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A] {
  <span class="kw">def</span> <span class="fu">and</span>(that: Check[E, A]): Check[E, A] =
    <span class="fu">And</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">or</span>(that: Check[E, A]): Check[E, A] =
    <span class="fu">Or</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, A] =
    <span class="kw">this</span> <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Pure</span>(func) =&gt;
        <span class="fu">func</span>(a)

      <span class="kw">case</span> <span class="fu">And</span>(left, right) =&gt;
        (<span class="fu">left</span>(a), <span class="fu">right</span>(a)).<span class="fu">mapN</span>((_, _) =&gt; a)

      <span class="kw">case</span> <span class="fu">Or</span>(left, right) =&gt;
        <span class="fu">left</span>(a) <span class="kw">match</span> {
          <span class="kw">case</span> <span class="fu">Valid</span>(a)    =&gt; <span class="fu">Valid</span>(a)
          <span class="kw">case</span> Invalid(e1) =&gt;
            <span class="fu">right</span>(a) <span class="kw">match</span> {
              <span class="kw">case</span> <span class="fu">Valid</span>(a)    =&gt; <span class="fu">Valid</span>(a)
              <span class="kw">case</span> Invalid(e2) =&gt; Invalid(e1 |+| e2)
            }
        }
    }
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> And[E, A](
  left: Check[E, A],
  right: Check[E, A]) <span class="kw">extends</span> Check[E, A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Or[E, A](
  left: Check[E, A],
  right: Check[E, A]) <span class="kw">extends</span> Check[E, A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A](
  func: A =&gt; Validated[E, A]) <span class="kw">extends</span> Check[E, A]</code></pre></div>
</div>
<p>With <code>and</code> and <code>or</code> we can implement many of checks we’ll want in practice. However, we still have a few more methods to add. We’ll turn to <code>map</code> and related methods next.</p>
<h2 id="transforming-data"><span class="header-section-number">10.4</span> Transforming Data</h2>
<p>One of our requirements is the ability to transform data. This allows us to support additional scenarios like parsing input. In this section we’ll extend our check library with this additional functionality.</p>
<p>The obvious starting point is <code>map</code>. When we try to implement this, we immediately run into a wall. Our current definition of <code>Check</code> requires the input and output types to be the same:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Check[E, A] = A =&gt; Either[E, A]</code></pre></div>
<p>When we map over a check, what type do we assign to the result? It can’t be <code>A</code> and it can’t be <code>B</code>. We are at an impasse:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">map</span>(check: Check[E, A])(func: A =&gt; B): Check[E, ???]</code></pre></div>
<p>To implement <code>map</code> we need to change the definition of <code>Check</code>. Specifically, we need to a new type variable to separate the input type from the output:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Check[E, A, B] = A =&gt; Either[E, B]</code></pre></div>
<p>Checks can now represent operations like parsing a <code>String</code> as an <code>Int</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> parseInt: Check[List[String], String, Int] =
  <span class="co">// etc...</span></code></pre></div>
<p>However, splitting our input and output types raises another issue. Up until now we have operated under the assumption that a <code>Check</code> always returns its input when successful. We used this in <code>and</code> and <code>or</code> to ignore the output of the left and right rules and simply return the original input on success:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">(<span class="kw">this</span>(a), <span class="fu">that</span>(a)) <span class="kw">match</span> {
  <span class="kw">case</span> <span class="fu">And</span>(left, right) =&gt;
    (<span class="fu">left</span>(a), <span class="fu">right</span>(a))
      .<span class="fu">mapN</span>((result1, result2) =&gt; <span class="fu">Right</span>(a))

  <span class="co">// etc...</span>
}</code></pre></div>
<p>In our new formulation we can’t return <code>Right(a)</code> because its type is <code>Either[E, A]</code> not <code>Either[E, B]</code>. We’re forced to make an arbitrary choice between returning <code>Right(result1)</code> and <code>Right(result2)</code>. The same is true of the <code>or</code> method. From this we can derive two things:</p>
<ul>
<li>we should strive to make the laws we adhere to explicit; and</li>
<li>the code is telling us we have the wrong abstraction in <code>Check</code>.</li>
</ul>
<h3 id="predicates"><span class="header-section-number">10.4.1</span> Predicates</h3>
<p>We can make progress by pulling apart the concept of a <em>predicate</em>, which can be combined using logical operations such as <em>and</em> and <em>or</em>, and the concept of a <em>check</em>, which can transform data.</p>
<p>What we have called <code>Check</code> so far we will call <code>Predicate</code>. For <code>Predicate</code> we can state the following <em>identity law</em> encoding the notion that a predicate always returns its input if it succeeds:</p>
<blockquote>
<p>For a predicate <code>p</code> of type <code>Predicate[E, A]</code> and elements <code>a1</code> and <code>a2</code> of type <code>A</code>, if <code>p(a1) == Success(a2)</code> then <code>a1 == a2</code>.</p>
</blockquote>
<p>Making this change gives us the following code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._     <span class="co">// for mapN</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>._   <span class="co">// for Valid and Invalid</span>

<span class="kw">sealed</span> <span class="kw">trait</span> Predicate[E, A] {
  <span class="kw">def</span> <span class="fu">and</span>(that: Predicate[E, A]): Predicate[E, A] =
    <span class="fu">And</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">or</span>(that: Predicate[E, A]): Predicate[E, A] =
    <span class="fu">Or</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, A] =
    <span class="kw">this</span> <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Pure</span>(func) =&gt;
        <span class="fu">func</span>(a)

      <span class="kw">case</span> <span class="fu">And</span>(left, right) =&gt;
        (<span class="fu">left</span>(a), <span class="fu">right</span>(a)).<span class="fu">mapN</span>((_, _) =&gt; a)

      <span class="kw">case</span> <span class="fu">Or</span>(left, right) =&gt;
        <span class="fu">left</span>(a) <span class="kw">match</span> {
          <span class="kw">case</span> <span class="fu">Valid</span>(a1)   =&gt; <span class="fu">Valid</span>(a)
          <span class="kw">case</span> Invalid(e1) =&gt;
            <span class="fu">right</span>(a) <span class="kw">match</span> {
              <span class="kw">case</span> <span class="fu">Valid</span>(a2)   =&gt; <span class="fu">Valid</span>(a)
              <span class="kw">case</span> Invalid(e2) =&gt; Invalid(e1 |+| e2)
            }
        }
    }
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> And[E, A](
  left: Predicate[E, A],
  right: Predicate[E, A]) <span class="kw">extends</span> Predicate[E, A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Or[E, A](
  left: Predicate[E, A],
  right: Predicate[E, A]) <span class="kw">extends</span> Predicate[E, A]

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A](
  func: A =&gt; Validated[E, A]) <span class="kw">extends</span> Predicate[E, A]</code></pre></div>
<h3 id="checks"><span class="header-section-number">10.4.2</span> Checks</h3>
<p>We’ll use <code>Check</code> to represent a structure we build from a <code>Predicate</code> that also allows transformation of its input. Implement <code>Check</code> with the following interface:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A, B] {
  <span class="kw">def</span> <span class="fu">apply</span>(a: A): Validated[E, B] =
    ???

  <span class="kw">def</span> map[C](func: B =&gt; C): Check[E, A, C] =
    ???
}</code></pre></div>
<div class="solution">
<p>If you follow the same strategy as <code>Predicate</code> you should be able to create code similar to the below:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>

<span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A, B] {
  <span class="kw">def</span> <span class="fu">apply</span>(in: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, B]

  <span class="kw">def</span> map[C](f: B =&gt; C): Check[E, A, C] =
    Map[E, A, B, C](<span class="kw">this</span>, f)
}

<span class="kw">object</span> Check {
  <span class="kw">def</span> apply[E, A](pred: Predicate[E, A]): Check[E, A, A] =
    <span class="fu">Pure</span>(pred)
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Map[E, A, B, C](
  check: Check[E, A, B],
  func: B =&gt; C) <span class="kw">extends</span> Check[E, A, C] {

  <span class="kw">def</span> <span class="fu">apply</span>(in: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, C] =
    <span class="fu">check</span>(in).<span class="fu">map</span>(func)
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A](
  pred: Predicate[E, A]) <span class="kw">extends</span> Check[E, A, A] {

  <span class="kw">def</span> <span class="fu">apply</span>(in: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, A] =
    <span class="fu">pred</span>(in)
}</code></pre></div>
</div>
<p>What about <code>flatMap</code>? The semantics are a bit unclear here. The method is simple enough to declare but it’s not so obvious what it means or how we should implement <code>apply</code>. The general shape of <code>flatMap</code> is shown in Figure 22.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjE5MjFweCIgaGVpZ2h0PSIzNjBweCIgdmlld0JveD0iMCAwIDE5MjEgMzYwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgPCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA0MC4zICgzMzgzOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+CiAgICA8dGl0bGU+Z2VuZXJpYy1mbGF0bWFwPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMSIgY3g9Ijg4NSIgY3k9IjE0MCIgcng9IjgwIiByeT0iODAiPjwvZWxsaXBzZT4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMyIgcG9pbnRzPSIxMDEuNTk1MDg2IDE1NSA0OC42OTQ0MTM4IDE4Mi44MTE1MjkgNTguNzk3NTQzMiAxMjMuOTA1NzY1IDE2IDgyLjE4ODQ3MDUgNzUuMTQ0NzUwMSA3My41OTQyMzUzIDEwMS41OTUwODYgMjAgMTI4LjA0NTQyMyA3My41OTQyMzUzIDE4Ny4xOTAxNzMgODIuMTg4NDcwNSAxNDQuMzkyNjMgMTIzLjkwNTc2NSAxNTQuNDk1NzU5IDE4Mi44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay00IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cmVjdCBpZD0icGF0aC01IiB4PSIwIiB5PSIwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgcng9IjgiPjwvcmVjdD4KICAgICAgICA8bWFzayBpZD0ibWFzay02IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNyIgcG9pbnRzPSIxMDEuNTk1MDg2IDE1NSA0OC42OTQ0MTM4IDE4Mi44MTE1MjkgNTguNzk3NTQzMiAxMjMuOTA1NzY1IDE2IDgyLjE4ODQ3MDUgNzUuMTQ0NzUwMSA3My41OTQyMzUzIDEwMS41OTUwODYgMjAgMTI4LjA0NTQyMyA3My41OTQyMzUzIDE4Ny4xOTAxNzMgODIuMTg4NDcwNSAxNDQuMzkyNjMgMTIzLjkwNTc2NSAxNTQuNDk1NzU5IDE4Mi44MTE1MjkiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay04IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3MS4xOTAxNzMiIGhlaWdodD0iMTYyLjgxMTUyOSIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgIDwvbWFzaz4KICAgICAgICA8cmVjdCBpZD0icGF0aC05IiB4PSIwIiB5PSIwIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgcng9IjgiPjwvcmVjdD4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMCIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtOSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDxwb2x5Z29uIGlkPSJwYXRoLTExIiBwb2ludHM9Ijk5NCAxMjAgMTAzNCAxMjAgMTAzNCAxMDAgMTA3NCAxMzkuNDk3NzY3IDEwMzQgMTgwIDEwMzQgMTYwIDk5NCAxNjAiPjwvcG9seWdvbj4KICAgICAgICA8bWFzayBpZD0ibWFzay0xMiIgbWFza0NvbnRlbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIG1hc2tVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIHg9IjAiIHk9IjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTExIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMTMiIGN4PSIxMDAiIGN5PSIxMDAiIHJ4PSI4MCIgcnk9IjgwIj48L2VsbGlwc2U+CiAgICAgICAgPG1hc2sgaWQ9Im1hc2stMTQiIG1hc2tDb250ZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBtYXNrVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwIiB5PSIwIiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgZmlsbD0id2hpdGUiPgogICAgICAgICAgICA8dXNlIHhsaW5rOmhyZWY9IiNwYXRoLTEzIj48L3VzZT4KICAgICAgICA8L21hc2s+CiAgICAgICAgPHJlY3QgaWQ9InBhdGgtMTUiIHg9IjAiIHk9IjAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiByeD0iOCI+PC9yZWN0PgogICAgICAgIDxtYXNrIGlkPSJtYXNrLTE2IiBtYXNrQ29udGVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgbWFza1VuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeD0iMCIgeT0iMCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IndoaXRlIj4KICAgICAgICAgICAgPHVzZSB4bGluazpocmVmPSIjcGF0aC0xNSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgPC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImdlbmVyaWMtZmxhdG1hcCI+CiAgICAgICAgICAgIDxyZWN0IGlkPSJCYWNrZ3JvdW5kIiBmaWxsPSIjRkZGRkZGIiB4PSIwIiB5PSIwIiB3aWR0aD0iMTkyMSIgaGVpZ2h0PSIzNjAiPjwvcmVjdD4KICAgICAgICAgICAgPHVzZSBpZD0iT3ZhbC0xIiBzdHJva2U9IiMwMDAwMDAiIG1hc2s9InVybCgjbWFzay0yKSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSIjRkZGRkZGIiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNDU5LjAwMDAwMCwgMzcuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stNCkiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUmVjdGFuZ2xlLTEiIG1hc2s9InVybCgjbWFzay02KSIgeGxpbms6aHJlZj0iI3BhdGgtNSI+PC91c2U+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMDk5LjAwMDAwMCwgMzkuMDAwMDAwKSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjgiPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iU3Rhci0xIiBtYXNrPSJ1cmwoI21hc2stOCkiIGZpbGw9IiNGRkZGRkYiIHhsaW5rOmhyZWY9IiNwYXRoLTciPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUmVjdGFuZ2xlLTEiIG1hc2s9InVybCgjbWFzay0xMCkiIHhsaW5rOmhyZWY9IiNwYXRoLTkiPjwvdXNlPgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDx1c2UgaWQ9IlBhdGgtMSIgc3Ryb2tlPSIjMDAwMDAwIiBtYXNrPSJ1cmwoI21hc2stMTIpIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9IiMwMDAwMDAiIHhsaW5rOmhyZWY9IiNwYXRoLTExIj48L3VzZT4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIxMzM5IDEyMCAxMzc5IDEyMCAxMzc5IDEwMCAxNDE5IDEzOS40OTc3NjcgMTM3OSAxODAgMTM3OSAxNjAgMTMzOSAxNjAiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkZbQV0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjMwMC4xIiB5PSIzMTQiPkZbQV08L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJGW0JdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxNTEyLjYiIHk9IjMxNCI+RltCXTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstRltCXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iOTQ1LjYiIHk9IjMxNCI+QSA9Jmd0OyBGW0JdPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1NS4wMDAwMDAsIDM4LjAwMDAwMCkiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI4Ij4KICAgICAgICAgICAgICAgIDx1c2UgaWQ9Ik92YWwtMSIgbWFzaz0idXJsKCNtYXNrLTE0KSIgZmlsbD0iI0ZGRkZGRiIgeGxpbms6aHJlZj0iI3BhdGgtMTMiPjwvdXNlPgogICAgICAgICAgICAgICAgPHVzZSBpZD0iUmVjdGFuZ2xlLTEiIG1hc2s9InVybCgjbWFzay0xNikiIHhsaW5rOmhyZWY9IiNwYXRoLTE1Ij48L3VzZT4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8dGV4dCBpZD0iZmxhdE1hcCIgZm9udC1mYW1pbHk9IkZpcmFNb25vLUJvbGQsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI2NCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNGNkE2MjMiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjQ5Ni4yIiB5PSIxNTUiPmZsYXRNYXA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 22: Type chart for flatMap" id="fig:validation:generic-flatmap" />
<p class="caption">Figure 22: Type chart for flatMap</p>
</div>
<p>How do we relate <code>F</code> in the figure to <code>Check</code> in our code? <code>Check</code> has <em>three</em> type variables while <code>F</code> only has one.</p>
<p>To unify the types we need to fix two of the type parameters. The idiomatic choices are the error type <code>E</code> and the input type <code>A</code>. This gives us the relationships shown in Figure 23. In other words, the semantics of applying a <code>FlatMap</code> are:</p>
<ul>
<li><p>given an input of type <code>A</code>, convert to <code>F[B]</code>;</p></li>
<li><p>use the output of type <code>B</code> to choose a <code>Check[E, A, C]</code>;</p></li>
<li><p>return to the <em>original</em> input of type <code>A</code> and apply it to the chosen check to generate the final result of type <code>F[C]</code>.</p></li>
</ul>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTYxNHB4IiBoZWlnaHQ9IjIyMXB4IiB2aWV3Qm94PSIwIDAgMTYxNCAyMjEiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5mbGF0bWFwPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMSIgcG9pbnRzPSIyNzkuMzg1NjYzIDEwMC4wMTM0NzEgMjQ1LjE1MTI1NyAxMTcuODk1OCAyNTEuNjg5NDQ3IDgwLjAyMDQxOTYgMjIzLjk5MzIzIDUzLjE5NjkyNjUgMjYyLjI2ODQ2IDQ3LjY3MDk4MzEgMjc5LjM4NTY2MyAxMy4yMTA4MjM5IDI5Ni41MDI4NjcgNDcuNjcwOTgzMSAzMzQuNzc4MDk3IDUzLjE5NjkyNjUgMzA3LjA4MTg4IDgwLjAyMDQxOTYgMzEzLjYyMDA3IDExNy44OTU4Ij48L3BvbHlnb24+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMiIgY3g9IjUzLjE2ODMyOSIgY3k9IjY2LjEwNDI4NTMiIHJ4PSI1My4xNjgzMjkiIHJ5PSI1Mi44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtMyIgcG9pbnRzPSIyNjcuMDI2ODYzIDk4LjEzNjI0OTYgMjMyLjc5MjQ1NiAxMTYuMDE4NTc4IDIzOS4zMzA2NDYgNzguMTQzMTk4MyAyMTEuNjM0NDI5IDUxLjMxOTcwNTIgMjQ5LjkwOTY1OSA0NS43OTM3NjE3IDI2Ny4wMjY4NjMgMTEuMzMzNjAyNiAyODQuMTQ0MDY2IDQ1Ljc5Mzc2MTcgMzIyLjQxOTI5NiA1MS4zMTk3MDUyIDI5NC43MjMwNzkgNzguMTQzMTk4MyAzMDEuMjYxMjY5IDExNi4wMTg1NzgiPjwvcG9seWdvbj4KICAgICAgICA8ZWxsaXBzZSBpZD0icGF0aC00IiBjeD0iNTMuMjk2OTU1NyIgY3k9IjY3LjMyODg0MTEiIHJ4PSI1My4xNjgzMjkiIHJ5PSI1Mi44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtNSIgY3g9IjUzLjQyMjY4MSIgY3k9IjY2LjMyODg0MTEiIHJ4PSI1My4xNjgzMjkiIHJ5PSI1Mi44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0ibW9uYWRpYyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1NS4wMDAwMDAsIC0zNTguMDAwMDAwKSI+CiAgICAgICAgICAgIDxnIGlkPSJmbGF0bWFwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNTUuMDAwMDAwLCAzNTguMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMTAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuMDAwMDAwLCAyLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNMjQ3LjgxMDA5NSwxMTQuMjUwNTQ1IEwyNTMuNjYwMjk4LDgwLjM2MDYzNTMgTDI1My44NDAwOTUsNzkuMzE5MDc4NyBMMjUzLjA4MDg0NCw3OC41ODM3NTIxIEwyMjguMzEwODgzLDU0LjU5NDMwNjYgTDI2Mi41NTQyNDUsNDkuNjUwNDU5NSBMMjYzLjU5MjgzMyw0OS41MDA1MTQ1IEwyNjQuMDU5NjU1LDQ4LjU2MDcxMzQgTDI3OS4zODU2NjMsMTcuNzA2NTY3OSBMMjk0LjcxMTY3Miw0OC41NjA3MTM0IEwyOTUuMTc4NDk0LDQ5LjUwMDUxNDUgTDI5Ni4yMTcwODIsNDkuNjUwNDU5NSBMMzMwLjQ2MDQ0NCw1NC41OTQzMDY2IEwzMDUuNjkwNDgzLDc4LjU4Mzc1MjEgTDMwNC45MzEyMzIsNzkuMzE5MDc4NyBMMzA1LjExMTAyOSw4MC4zNjA2MzUzIEwzMTAuOTYxMjMyLDExNC4yNTA1NDUgTDI4MC4zMTE2NDYsOTguMjQwNzQ1MyBMMjc5LjM4NTY2Myw5Ny43NTcwNTg3IEwyNzguNDU5NjgxLDk4LjI0MDc0NTMgTDI0Ny44MTAwOTUsMTE0LjI1MDU0NSBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMiI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNTMuMTY4MzI5IiBjeT0iNjYuMTA0Mjg1MyIgcng9IjUxLjE2ODMyOSIgcnk9IjUwLjg5MzQ2MTQiPjwvZWxsaXBzZT4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iMjE0LjI4NjI2NyIgeT0iMi4wMjgyNzE0MSIgd2lkdGg9IjEyOC45MjA4MjMiIGhlaWdodD0iMTI4LjIzMzY1NCIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEzMy40NTkzODEgNTQuMzUwMTgyOCAxNjAuMDQzNTQ2IDU0LjM1MDE4MjggMTYwLjA0MzU0NiA0MS4xMjY4MTc0IDE4Ni42Mjc3MSA2Ny4yNDE0ODc3IDE2MC4wNDM1NDYgOTQuMDIwMjc4OSAxNjAuMDQzNTQ2IDgwLjc5NjkxMzUgMTMzLjQ1OTM4MSA4MC43OTY5MTM1Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtOCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTg2LjAwMDAwMCwgMC4wMDAwMDApIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iU3Rhci0xIj4KICAgICAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTMiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTIzNS40NTEyOTQsMTEyLjM3MzMyMyBMMjQxLjMwMTQ5Nyw3OC40ODM0MTQgTDI0MS40ODEyOTQsNzcuNDQxODU3NCBMMjQwLjcyMjA0Myw3Ni43MDY1MzA4IEwyMTUuOTUyMDgyLDUyLjcxNzA4NTIgTDI1MC4xOTU0NDQsNDcuNzczMjM4MiBMMjUxLjIzNDAzMiw0Ny42MjMyOTMyIEwyNTEuNzAwODU1LDQ2LjY4MzQ5MjEgTDI2Ny4wMjY4NjMsMTUuODI5MzQ2NiBMMjgyLjM1Mjg3MSw0Ni42ODM0OTIxIEwyODIuODE5NjkzLDQ3LjYyMzI5MzIgTDI4My44NTgyODEsNDcuNzczMjM4MiBMMzE4LjEwMTY0Myw1Mi43MTcwODUyIEwyOTMuMzMxNjgyLDc2LjcwNjUzMDggTDI5Mi41NzI0MzEsNzcuNDQxODU3NCBMMjkyLjc1MjIyOCw3OC40ODM0MTQgTDI5OC42MDI0MzEsMTEyLjM3MzMyMyBMMjY3Ljk1Mjg0NSw5Ni4zNjM1MjQgTDI2Ny4wMjY4NjMsOTUuODc5ODM3MyBMMjY2LjEwMDg4LDk2LjM2MzUyNCBMMjM1LjQ1MTI5NCwxMTIuMzczMzIzIFoiPjwvcGF0aD4KICAgICAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iIzAwMDAwMCIgcG9pbnRzPSIzNDcuNDM1MjAzIDUzLjI0ODQwNTcgMzc0LjAxOTM2OCA1My4yNDg0MDU3IDM3NC4wMTkzNjggNDAuMDI1MDQwNCA0MDAuNjAzNTMyIDY2LjEzOTcxMDcgMzc0LjAxOTM2OCA5Mi45MTg1MDE4IDM3NC4wMTkzNjggNzkuNjk1MTM2NSAzNDcuNDM1MjAzIDc5LjY5NTEzNjUiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSI0MjguODAwNjQ3IiB5PSIyLjQ3NzM4Mjg4IiB3aWR0aD0iMTI4LjkyMDgyMyIgaGVpZ2h0PSIxMjguMjMzNjU0IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtNCI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iNTMuMjk2OTU1NyIgY3k9IjY3LjMyODg0MTEiIHJ4PSI1MS4xNjgzMjkiIHJ5PSI1MC44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTMzLjU4ODAwOCA1NS41NzQ3Mzg1IDE2MC4xNzIxNzIgNTUuNTc0NzM4NSAxNjAuMTcyMTcyIDQyLjM1MTM3MzIgMTg2Ljc1NjMzNyA2OC40NjYwNDM1IDE2MC4xNzIxNzIgOTUuMjQ0ODM0NiAxNjAuMTcyMTcyIDgyLjAyMTQ2OTMgMTMzLjU4ODAwOCA4Mi4wMjE0NjkzIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24iIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSIjRkZGRkZGIiBwb2ludHM9IjQ5My4wODI1OTcgMjMgNTM5LjE2NTE5NCA1Ni4yNjU2MTY3IDUyMS41NjMyMDggMTEwLjA5MDUxNSA0NjQuNjAxOTg2IDExMC4wOTA1MTUgNDQ3IDU2LjI2NTYxNjciPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDx0ZXh0IGlkPSJBLT0mZ3Q7LUZbQl0iIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI1OS40NjcwMjEzIiB5PSIyMTUiPkEgPSZndDsgRltCXTwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQi09Jmd0Oy0oQS09Jmd0Oy1GW0NdKSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjY2NC41NzA2OTYiIHk9IjIxNSI+QiA9Jmd0OyAoQSA9Jmd0OyBGW0NdKTwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0NdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTMyNy4xMTAzIiB5PSIyMTUiPkEgPSZndDsgRltDXTwvdHNwYW4+CiAgICAgICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtOSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTI2OC4wMDAwMDAsIDEuMDAwMDAwKSI+CiAgICAgICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC01Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI1My40MjI2ODEiIGN5PSI2Ni4zMjg4NDExIiByeD0iNTEuMTY4MzI5IiByeT0iNTAuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEzMy43MTM3MzMgNTMuMDIzODUgMTYwLjI5Nzg5OCA1My4wMjM4NSAxNjAuMjk3ODk4IDM5LjgwMDQ4NDcgMTg2Ljg4MjA2MiA2NS45MTUxNTQ5IDE2MC4yOTc4OTggOTIuNjkzOTQ2MSAxNjAuMjk3ODk4IDc5LjQ3MDU4MDcgMTMzLjcxMzczMyA3OS40NzA1ODA3Ij48L3BvbHlnb24+CiAgICAgICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iMjE1LjA3OTE3NyIgeT0iMi4yNTI4MjcxNCIgd2lkdGg9IjEyOC45MjA4MjMiIGhlaWdodD0iMTI4LjIzMzY1NCIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUG9seWdvbiIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGZpbGw9IiNGRkZGRkYiIHBvaW50cz0iMjgwLjA4MjU5NyAyMyAzMjYuMTY1MTk0IDU2LjI2NTYxNjcgMzA4LjU2MzIwOCAxMTAuMDkwNTE1IDI1MS42MDE5ODYgMTEwLjA5MDUxNSAyMzQgNTYuMjY1NjE2NyI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMSIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIxMTc4LjUwMDk3IDUzLjIwNzU5MjkgMTIwOS43MTk1NCA1My4yMDc1OTI5IDEyMDkuNzE5NTQgMzcuNjk4NzA3NiAxMjQwLjkzODEgNjguMzI3MDI0NiAxMjA5LjcxOTU0IDk5LjczNDI0ODggMTIwOS43MTk1NCA4NC4yMjUzNjM1IDExNzguNTAwOTcgODQuMjI1MzYzNSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHRleHQgaWQ9ImZsYXRNYXAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1Cb2xkLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDUiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRjZBNjIzIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzc1Ljc4MTY3MyIgeT0iODIiPmZsYXRNYXA8L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8L2c+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 23: Type chart for flatMap applied to Check" id="fig:validation:check-flatmap" />
<p class="caption">Figure 23: Type chart for flatMap applied to Check</p>
</div>
<p>This is quite an odd method. We can implement it, but it is hard to find a use for it. Go ahead and implement <code>flatMap</code> for <code>Check</code>, and then we’ll see a more generally useful method.</p>
<div class="solution">
<p>It’s the same implementation strategy as before with one wrinkle: <code>Validated</code> doesn’t have a <code>flatMap</code> method. To implement <code>flatMap</code> we must momentarily switch to <code>Either</code> and then switch back to <code>Validated</code>. The <code>withEither</code> method on <code>Validated</code> does exactly this. From here we can just follow the types to implement <code>apply</code>.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>

<span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A, B] {
  <span class="kw">def</span> <span class="fu">apply</span>(in: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, B]

  <span class="kw">def</span> flatMap[C](f: B =&gt; Check[E, A, C]) =
    FlatMap[E, A, B, C](<span class="kw">this</span>, f)

  <span class="co">// other methods...</span>
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> FlatMap[E, A, B, C](
  check: Check[E, A, B],
  func: B =&gt; Check[E, A, C]) <span class="kw">extends</span> Check[E, A, C] {

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, C] =
    <span class="fu">check</span>(a).<span class="fu">withEither</span>(_.<span class="fu">flatMap</span>(b =&gt; <span class="fu">func</span>(b)(a).<span class="fu">toEither</span>))
}

<span class="co">// other data types...</span></code></pre></div>
</div>
<p>We can write a more useful combinator that chains together two <code>Checks</code>. The output of the first check is connected to the input of the second. This is analogous to function composition using <code>andThen</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> f: A =&gt; B = ???
<span class="kw">val</span> g: B =&gt; C = ???
<span class="kw">val</span> h: A =&gt; C = f andThen g</code></pre></div>
<p>A <code>Check</code> is basically a function <code>A =&gt; Validated[E, B]</code> so we can define an analagous <code>andThen</code> method:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Check[E, A, B] {
  <span class="kw">def</span> andThen[C](that: Check[E, B, C]): Check[E, A, C]
}</code></pre></div>
<p>Implement <code>andThen</code> now!</p>
<div class="solution">
<p>Here’s a minimal definition of <code>andThen</code> and its corresponding <code>AndThen</code> class:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A, B] {
  <span class="kw">import</span> Check._

  <span class="kw">def</span> <span class="fu">apply</span>(in: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, B]

  <span class="kw">def</span> andThen[C](that: Check[E, B, C]): Check[E, A, C] =
    AndThen[E, A, B, C](<span class="kw">this</span>, that)
}

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> AndThen[E, A, B, C](
  check1: Check[E, A, B],
  check2: Check[E, B, C]) <span class="kw">extends</span> Check[E, A, C] {

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, C] =
    <span class="fu">check1</span>(a).<span class="fu">withEither</span>(_.<span class="fu">flatMap</span>(b =&gt; <span class="fu">check2</span>(b).<span class="fu">toEither</span>))
}</code></pre></div>
</div>
<h3 id="recap"><span class="header-section-number">10.4.3</span> Recap</h3>
<p>We now have two algebraic data types, <code>Predicate</code> and <code>Check</code>, and a host of combinators with their associated case class implementations. Look at the following solution for a complete definition of each ADT.</p>
<div class="solution">
<p>Here’s our final implementaton, including some tidying and repackaging of the code:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>._   <span class="co">// for Valid and Invalid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._     <span class="co">// for mapN</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">validated</span>._ <span class="co">// for valid and invalid</span></code></pre></div>
<p>Here is our complete implementation of <code>Predicate</code>, including the <code>and</code> and <code>or</code> combinators and a <code>Predicate.apply</code> method to create a <code>Predicate</code> from a function:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Predicate[E, A] {
  <span class="kw">import</span> Predicate._

  <span class="kw">def</span> <span class="fu">and</span>(that: Predicate[E, A]): Predicate[E, A] =
    <span class="fu">And</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">or</span>(that: Predicate[E, A]): Predicate[E, A] =
    <span class="fu">Or</span>(<span class="kw">this</span>, that)

  <span class="kw">def</span> <span class="fu">apply</span>(a: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, A] =
    <span class="kw">this</span> <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Pure</span>(func) =&gt;
        <span class="fu">func</span>(a)

      <span class="kw">case</span> <span class="fu">And</span>(left, right) =&gt;
        (<span class="fu">left</span>(a), <span class="fu">right</span>(a)).<span class="fu">mapN</span>((_, _) =&gt; a)

      <span class="kw">case</span> <span class="fu">Or</span>(left, right) =&gt;
        <span class="fu">left</span>(a) <span class="kw">match</span> {
          <span class="kw">case</span> <span class="fu">Valid</span>(a1)   =&gt; <span class="fu">Valid</span>(a)
          <span class="kw">case</span> Invalid(e1) =&gt;
            <span class="fu">right</span>(a) <span class="kw">match</span> {
              <span class="kw">case</span> <span class="fu">Valid</span>(a2)   =&gt; <span class="fu">Valid</span>(a)
              <span class="kw">case</span> Invalid(e2) =&gt; Invalid(e1 |+| e2)
            }
        }
    }
}

<span class="kw">object</span> Predicate {
  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> And[E, A](
    left: Predicate[E, A],
    right: Predicate[E, A]) <span class="kw">extends</span> Predicate[E, A]

  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Or[E, A](
    left: Predicate[E, A],
    right: Predicate[E, A]) <span class="kw">extends</span> Predicate[E, A]

  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A](
    func: A =&gt; Validated[E, A]) <span class="kw">extends</span> Predicate[E, A]

  <span class="kw">def</span> apply[E, A](f: A =&gt; Validated[E, A]): Predicate[E, A] =
    <span class="fu">Pure</span>(f)

  <span class="kw">def</span> lift[E, A](err: E, fn: A =&gt; Boolean): Predicate[E, A] =
    <span class="fu">Pure</span>(a =&gt; <span class="kw">if</span>(<span class="fu">fn</span>(a)) a.<span class="fu">valid</span> <span class="kw">else</span> err.<span class="fu">invalid</span>)
}</code></pre></div>
<p>Here is a complete implementation of <code>Check</code>. Due to <a href="https://issues.scala-lang.org/browse/SI-6680">a type inference bug</a> in Scala’s pattern matching, we’ve switched to implementing <code>apply</code> using inheritance:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Check[E, A, B] {
  <span class="kw">import</span> Check._

  <span class="kw">def</span> <span class="fu">apply</span>(in: A)(<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, B]

  <span class="kw">def</span> map[C](f: B =&gt; C): Check[E, A, C] =
    Map[E, A, B, C](<span class="kw">this</span>, f)

  <span class="kw">def</span> flatMap[C](f: B =&gt; Check[E, A, C]) =
    FlatMap[E, A, B, C](<span class="kw">this</span>, f)

  <span class="kw">def</span> andThen[C](next: Check[E, B, C]): Check[E, A, C] =
    AndThen[E, A, B, C](<span class="kw">this</span>, next)
}

<span class="kw">object</span> Check {
  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Map[E, A, B, C](
    check: Check[E, A, B],
    func: B =&gt; C) <span class="kw">extends</span> Check[E, A, C] {

    <span class="kw">def</span> <span class="fu">apply</span>(a: A)
        (<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, C] =
      <span class="fu">check</span>(a) map func
  }

  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> FlatMap[E, A, B, C](
    check: Check[E, A, B],
    func: B =&gt; Check[E, A, C]) <span class="kw">extends</span> Check[E, A, C] {

    <span class="kw">def</span> <span class="fu">apply</span>(a: A)
        (<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, C] =
      <span class="fu">check</span>(a).<span class="fu">withEither</span>(_.<span class="fu">flatMap</span>(b =&gt; <span class="fu">func</span>(b)(a).<span class="fu">toEither</span>))
  }

  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> AndThen[E, A, B, C](
    check: Check[E, A, B],
    next: Check[E, B, C]) <span class="kw">extends</span> Check[E, A, C] {

    <span class="kw">def</span> <span class="fu">apply</span>(a: A)
        (<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, C] =
      <span class="fu">check</span>(a).<span class="fu">withEither</span>(_.<span class="fu">flatMap</span>(b =&gt; <span class="fu">next</span>(b).<span class="fu">toEither</span>))
  }

  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> Pure[E, A, B](
    func: A =&gt; Validated[E, B]) <span class="kw">extends</span> Check[E, A, B] {

    <span class="kw">def</span> <span class="fu">apply</span>(a: A)
        (<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, B] =
      <span class="fu">func</span>(a)
  }

  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> PurePredicate[E, A](
    pred: Predicate[E, A]) <span class="kw">extends</span> Check[E, A, A] {

    <span class="kw">def</span> <span class="fu">apply</span>(a: A)
        (<span class="kw">implicit</span> s: Semigroup[E]): Validated[E, A] =
      <span class="fu">pred</span>(a)
  }

  <span class="kw">def</span> apply[E, A](pred: Predicate[E, A]): Check[E, A, A] =
    <span class="fu">PurePredicate</span>(pred)

  <span class="kw">def</span> apply[E, A, B]
      (func: A =&gt; Validated[E, B]): Check[E, A, B] =
    <span class="fu">Pure</span>(func)
}</code></pre></div>
</div>
<p>We have a complete implementation of <code>Check</code> and <code>Predicate</code> that do most of what we originally set out to do. However, we are not finished yet. You have probably recognised structure in <code>Predicate</code> and <code>Check</code> that we can abstract over: <code>Predicate</code> has a monoid and <code>Check</code> has a monad. Furthermore, in implementing <code>Check</code> you might have felt the implementation doesn’t do much—all we do is call through to underlying methods on <code>Predicate</code> and <code>Validated</code>.</p>
<p>There are a lot of ways this library could be cleaned up. However, let’s implement some examples to prove to ourselves that our library really does work, and then we’ll turn to improving it.</p>
<p>Implement checks for some of the examples given in the introduction:</p>
<ul>
<li><p>A username must contain at least four characters and consist entirely of alphanumeric characters</p></li>
<li><p>An email address must contain an <code>@</code> sign. Split the string at the <code>@</code>. The string to the left must not be empty. The string to the right must be at least three characters long and contain a dot.</p></li>
</ul>
<p>You might find the following predicates useful:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.{NonEmptyList, Validated}

<span class="kw">type</span> Errors = NonEmptyList[String]

<span class="kw">def</span> <span class="fu">error</span>(s: String): NonEmptyList[String] =
  <span class="fu">NonEmptyList</span>(s, Nil)

<span class="kw">def</span> <span class="fu">longerThan</span>(n: Int): Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must be longer than $n characters&quot;</span>),
    str =&gt; str.<span class="fu">size</span> &gt; n)

<span class="kw">val</span> alphanumeric: Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must be all alphanumeric characters&quot;</span>),
    str =&gt; str.<span class="fu">forall</span>(_.<span class="fu">isLetterOrDigit</span>))

<span class="kw">def</span> <span class="fu">contains</span>(<span class="dt">char</span>: Char): Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must contain the character $char&quot;</span>),
    str =&gt; str.<span class="fu">contains</span>(<span class="dt">char</span>))

<span class="kw">def</span> <span class="fu">containsOnce</span>(<span class="dt">char</span>: Char): Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must contain the character $char only once&quot;</span>),
    str =&gt; str.<span class="fu">filter</span>(c =&gt; c == <span class="dt">char</span>).<span class="fu">size</span> == <span class="dv">1</span>)</code></pre></div>
<div class="solution">
<p>Here’s our reference solution. Implementing this required more thought than we expected. Switching between <code>Check</code> and <code>Predicate</code> at appropriate places felt a bit like guesswork till we got the rule into our heads that <code>Predicate</code> doesn’t transform its input. With this rule in mind things went fairly smoothly. In later sections we’ll make some changes that make the library easier to use.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.{NonEmptyList, Validated}
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">apply</span>._     <span class="co">// for mapN</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">validated</span>._ <span class="co">// for valid and invalid</span></code></pre></div>
<p>Here’s the implementation of <code>checkUsername</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// A username must contain at least four characters</span>
<span class="co">// and consist entirely of alphanumeric characters</span>

<span class="kw">val</span> checkUsername: Check[Errors, String, String] =
  <span class="fu">Check</span>(<span class="fu">longerThan</span>(<span class="dv">3</span>) and alphanumeric)</code></pre></div>
<p>And here’s the implementation of <code>checkEmail</code>, built up from a number of smaller components:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">// An email address must contain a single `@` sign.</span>
<span class="co">// Split the string at the `@`.</span>
<span class="co">// The string to the left must not be empty.</span>
<span class="co">// The string to the right must be</span>
<span class="co">// at least three characters long and contain a dot.</span>

<span class="kw">val</span> splitEmail: Check[Errors, String, (String, String)] =
  <span class="fu">Check</span>(_.<span class="fu">split</span>(<span class="ch">'@'</span>) <span class="kw">match</span> {
    <span class="kw">case</span> Array(name, domain) =&gt;
      (name, domain).<span class="fu">validNel</span>[String]

    <span class="kw">case</span> other =&gt;
      <span class="st">&quot;Must contain a single @ character&quot;</span>.
        invalidNel[(String, String)]
  })

<span class="kw">val</span> checkLeft: Check[Errors, String, String] =
  <span class="fu">Check</span>(<span class="fu">longerThan</span>(<span class="dv">0</span>))

<span class="kw">val</span> checkRight: Check[Errors, String, String] =
  <span class="fu">Check</span>(<span class="fu">longerThan</span>(<span class="dv">3</span>) and <span class="fu">contains</span>(<span class="ch">'.'</span>))

<span class="kw">val</span> joinEmail: Check[Errors, (String, String), String] =
  Check { <span class="kw">case</span> (l, r) =&gt;
    (<span class="fu">checkLeft</span>(l), <span class="fu">checkRight</span>(r)).<span class="fu">mapN</span>(_ + <span class="st">&quot;@&quot;</span> + _)
  }

<span class="kw">val</span> checkEmail: Check[Errors, String, String] =
  splitEmail andThen joinEmail</code></pre></div>
<p>Finally, here’s a check for a <code>User</code> that depends on <code>checkUsername</code> and <code>checkEmail</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">User</span>(username: String, email: String)

<span class="kw">def</span> <span class="fu">createUser</span>(
      username: String,
      email: String): Validated[Errors, User] =
  (<span class="fu">checkUsername</span>(username), <span class="fu">checkEmail</span>(email)).<span class="fu">mapN</span>(User)</code></pre></div>
<p>We can check our work by creating a couple of example users:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="fu">createUser</span>(<span class="st">&quot;Noel&quot;</span>, <span class="st">&quot;noel@underscore.io&quot;</span>)
<span class="co">// res14: cats.data.Validated[wrapper.Errors,User] = Valid(User(Noel,noel@underscore.io))</span>

<span class="fu">createUser</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;dave@underscore@io&quot;</span>)
<span class="co">// res15: cats.data.Validated[wrapper.Errors,User] = Invalid(NonEmptyList(Must be longer than 3 characters, Must contain a single @ character))</span></code></pre></div>
<p>One distinct disadvantage of our example is that it doesn’t tell us <em>where</em> the errors came from. We can either achieve that through judicious manipulation of error messages, or we can modify our library to track error locations as well as messages. Tracking error locations is outside the scope of this case study, so we’ll leave this as an exercise to the reader.</p>
</div>
<h2 id="kleislis"><span class="header-section-number">10.5</span> Kleislis</h2>
<p>We’ll finish off this case study by cleaning up the implementation of <code>Check</code>. A justifiable criticism of our approach is that we’ve written a lot of code to do very little. A <code>Predicate</code> is essentially a function <code>A =&gt; Validated[E, A]</code>, and a <code>Check</code> is basically a wrapper that lets us compose these functions.</p>
<p>We can abstract <code>A =&gt; Validated[E, A]</code> to <code>A =&gt; F[B]</code>, which you’ll recognise as the type of function you pass to the <code>flatMap</code> method on a monad. Imagine we have the following sequence of operations:</p>
<ul>
<li><p>We lift some value into a monad (by using <code>pure</code>, for example). This is a function with type <code>A =&gt; F[A]</code>.</p></li>
<li><p>We then sequence some transformations on the monad using <code>flatMap</code>.</p></li>
</ul>
<p>We can illustrate this as shown in Figure <strong>¿sec:validation:kleisli?</strong>. We can also write out this example using the monad API as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> aToB: A =&gt; F[B] = ???
<span class="kw">val</span> bToC: B =&gt; F[C] = ???

<span class="kw">def</span> example[A, C](a: A): F[C] =
  <span class="fu">aToB</span>(a).<span class="fu">flatMap</span>(bToC)</code></pre></div>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTQ3NnB4IiBoZWlnaHQ9IjIyMHB4IiB2aWV3Qm94PSIwIDAgMTQ3NiAyMjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5rbGVpc2xpPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMSIgY3g9IjUzLjE2ODMyOSIgY3k9IjY3Ljg5MzQ2MTQiIHJ4PSI1My4xNjgzMjkiIHJ5PSI1Mi44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgPGVsbGlwc2UgaWQ9InBhdGgtMiIgY3g9IjI3OS4xNjgzMjkiIGN5PSI2Ny44OTM0NjE0IiByeD0iNTMuMTY4MzI5IiByeT0iNTIuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgIDxlbGxpcHNlIGlkPSJwYXRoLTMiIGN4PSI2MjcuMTY4MzI5IiBjeT0iNjUuODkzNDYxNCIgcng9IjUzLjE2ODMyOSIgcnk9IjUyLjg5MzQ2MTQiPjwvZWxsaXBzZT4KICAgICAgICA8cG9seWdvbiBpZD0icGF0aC00IiBwb2ludHM9Ijg1My4zOTI0MzMgOTkuODAyNjQ3IDgxOS4xNTgwMjcgMTE3LjY4NDk3NiA4MjUuNjk2MjE3IDc5LjgwOTU5NTcgNzk4IDUyLjk4NjEwMjYgODM2LjI3NTIzIDQ3LjQ2MDE1OTIgODUzLjM5MjQzMyAxMyA4NzAuNTA5NjM3IDQ3LjQ2MDE1OTIgOTA4Ljc4NDg2NyA1Mi45ODYxMDI2IDg4MS4wODg2NSA3OS44MDk1OTU3IDg4Ny42MjY4NCAxMTcuNjg0OTc2Ij48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9InBhdGgtNSIgcG9pbnRzPSIxMjAxLjM5MjQzIDk5LjgwMjY0NyAxMTY3LjE1ODAzIDExNy42ODQ5NzYgMTE3My42OTYyMiA3OS44MDk1OTU3IDExNDYgNTIuOTg2MTAyNiAxMTg0LjI3NTIzIDQ3LjQ2MDE1OTIgMTIwMS4zOTI0MyAxMyAxMjE4LjUwOTY0IDQ3LjQ2MDE1OTIgMTI1Ni43ODQ4NyA1Mi45ODYxMDI2IDEyMjkuMDg4NjUgNzkuODA5NTk1NyAxMjM1LjYyNjg0IDExNy42ODQ5NzYiPjwvcG9seWdvbj4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJrbGVpc2xpIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjIzLjAwMDAwMCwgLTM4LjAwMDAwMCkiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgeD0iMCIgeT0iMCIgd2lkdGg9IjE5MjEiIGhlaWdodD0iMzAwIj48L3JlY3Q+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cC0xNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjIzLjAwMDAwMCwgMzguMDAwMDAwKSI+CiAgICAgICAgICAgICAgICA8ZyBpZD0iT3ZhbC0xIj4KICAgICAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgICAgICAgICAgPGVsbGlwc2Ugc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIGN4PSI1My4xNjgzMjkiIGN5PSI2Ny44OTM0NjE0IiByeD0iNTEuMTY4MzI5IiByeT0iNTAuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTIiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxlbGxpcHNlIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBjeD0iMjc5LjE2ODMyOSIgY3k9IjY3Ljg5MzQ2MTQiIHJ4PSI1MS4xNjgzMjkiIHJ5PSI1MC44OTM0NjE0Ij48L2VsbGlwc2U+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSIyMTQiIHk9IjQiIHdpZHRoPSIxMjguOTIwODIzIiBoZWlnaHQ9IjEyOC4yMzM2NTQiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xIiBmaWxsPSIjMDAwMDAwIiBwb2ludHM9IjEzMyA1Ni4yMjMzNjU0IDE1OS41ODQxNjUgNTYuMjIzMzY1NCAxNTkuNTg0MTY1IDQzIDE4Ni4xNjgzMjkgNjkuMTE0NjcwMyAxNTkuNTg0MTY1IDk1Ljg5MzQ2MTQgMTU5LjU4NDE2NSA4Mi42NzAwOTYxIDEzMyA4Mi42NzAwOTYxIj48L3BvbHlnb24+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQS09Jmd0Oy1GW0FdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTkuNDY3MDIxMyIgeT0iMjE1Ij5BID0mZ3Q7IEZbQV08L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9ImZsYXRNYXAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1Cb2xkLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDUiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRjZBNjIzIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMzY1Ljc4MTY3MyIgeT0iODIiPmZsYXRNYXA8L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9ImZsYXRNYXAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1Cb2xkLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNDUiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRjZBNjIzIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iOTQwLjc4MTY3MyIgeT0iODIiPmZsYXRNYXA8L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPHRleHQgaWQ9IkEtPSZndDstRltCXSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYzOC4xMzc4MTQiIHk9IjIxMyI+QSA9Jmd0OyBGW0JdPC90c3Bhbj4KICAgICAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC0zIj48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8ZWxsaXBzZSBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgY3g9IjYyNy4xNjgzMjkiIGN5PSI2NS44OTM0NjE0IiByeD0iNTEuMTY4MzI5IiByeT0iNTAuODkzNDYxNCI+PC9lbGxpcHNlPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iNzg4IiB5PSIyIiB3aWR0aD0iMTI4LjkyMDgyMyIgaGVpZ2h0PSIxMjguMjMzNjU0IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iMTM0NSIgeT0iMiIgd2lkdGg9IjEyOC45MjA4MjMiIGhlaWdodD0iMTI4LjIzMzY1NCIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iNzA3IDU0LjIyMzM2NTQgNzMzLjU4NDE2NSA1NC4yMjMzNjU0IDczMy41ODQxNjUgNDEgNzYwLjE2ODMyOSA2Ny4xMTQ2NzAzIDczMy41ODQxNjUgOTMuODkzNDYxNCA3MzMuNTg0MTY1IDgwLjY3MDA5NjEgNzA3IDgwLjY3MDA5NjEiPjwvcG9seWdvbj4KICAgICAgICAgICAgICAgIDxnIGlkPSJTdGFyLTEiPgogICAgICAgICAgICAgICAgICAgIDx1c2UgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIiB4bGluazpocmVmPSIjcGF0aC00Ij48L3VzZT4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgZD0iTTgyMS44MTY4NjUsMTE0LjAzOTcyMSBMODI3LjY2NzA2OCw4MC4xNDk4MTE0IEw4MjcuODQ2ODY1LDc5LjEwODI1NDggTDgyNy4wODc2MTQsNzguMzcyOTI4MiBMODAyLjMxNzY1Myw1NC4zODM0ODI3IEw4MzYuNTYxMDE1LDQ5LjQzOTYzNTYgTDgzNy41OTk2MDMsNDkuMjg5NjkwNiBMODM4LjA2NjQyNSw0OC4zNDk4ODk1IEw4NTMuMzkyNDMzLDE3LjQ5NTc0NCBMODY4LjcxODQ0MSw0OC4zNDk4ODk1IEw4NjkuMTg1MjY0LDQ5LjI4OTY5MDYgTDg3MC4yMjM4NTIsNDkuNDM5NjM1NiBMOTA0LjQ2NzIxNCw1NC4zODM0ODI3IEw4NzkuNjk3MjUzLDc4LjM3MjkyODIgTDg3OC45MzgwMDIsNzkuMTA4MjU0OCBMODc5LjExNzc5OSw4MC4xNDk4MTE0IEw4ODQuOTY4MDAyLDExNC4wMzk3MjEgTDg1NC4zMTg0MTYsOTguMDI5OTIxNCBMODUzLjM5MjQzMyw5Ny41NDYyMzQ3IEw4NTIuNDY2NDUxLDk4LjAyOTkyMTQgTDgyMS44MTY4NjUsMTE0LjAzOTcyMSBaIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgICAgICA8dGV4dCBpZD0iQi09Jmd0Oy1GW0NdIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjQwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTE5My40MDA2MiIgeT0iMjEzIj5CID0mZ3Q7IEZbQ108L3RzcGFuPgogICAgICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICAgICAgPGcgaWQ9IlN0YXItMSI+CiAgICAgICAgICAgICAgICAgICAgPHVzZSBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHhsaW5rOmhyZWY9IiNwYXRoLTUiPjwvdXNlPgogICAgICAgICAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBkPSJNMTE2OS44MTY4NiwxMTQuMDM5NzIxIEwxMTc1LjY2NzA3LDgwLjE0OTgxMTQgTDExNzUuODQ2ODYsNzkuMTA4MjU0OCBMMTE3NS4wODc2MSw3OC4zNzI5MjgyIEwxMTUwLjMxNzY1LDU0LjM4MzQ4MjcgTDExODQuNTYxMDEsNDkuNDM5NjM1NiBMMTE4NS41OTk2LDQ5LjI4OTY5MDYgTDExODYuMDY2NDMsNDguMzQ5ODg5NSBMMTIwMS4zOTI0MywxNy40OTU3NDQgTDEyMTYuNzE4NDQsNDguMzQ5ODg5NSBMMTIxNy4xODUyNiw0OS4yODk2OTA2IEwxMjE4LjIyMzg1LDQ5LjQzOTYzNTYgTDEyNTIuNDY3MjEsNTQuMzgzNDgyNyBMMTIyNy42OTcyNSw3OC4zNzI5MjgyIEwxMjI2LjkzOCw3OS4xMDgyNTQ4IEwxMjI3LjExNzgsODAuMTQ5ODExNCBMMTIzMi45NjgsMTE0LjAzOTcyMSBMMTIwMi4zMTg0Miw5OC4wMjk5MjE0IEwxMjAxLjM5MjQzLDk3LjU0NjIzNDcgTDEyMDAuNDY2NDUsOTguMDI5OTIxNCBMMTE2OS44MTY4NiwxMTQuMDM5NzIxIFoiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iMTI4MyA1NC4yMjMzNjU0IDEzMDkuNTg0MTYgNTQuMjIzMzY1NCAxMzA5LjU4NDE2IDQxIDEzMzYuMTY4MzMgNjcuMTE0NjcwMyAxMzA5LjU4NDE2IDkzLjg5MzQ2MTQgMTMwOS41ODQxNiA4MC42NzAwOTYxIDEyODMgODAuNjcwMDk2MSI+PC9wb2x5Z29uPgogICAgICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBvbHlnb24iIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSIjRkZGRkZGIiBwb2ludHM9IjE0MDkuMDgyNiAyMSAxNDU1LjE2NTE5IDU0LjI2NTYxNjcgMTQzNy41NjMyMSAxMDguMDkwNTE1IDEzODAuNjAxOTkgMTA4LjA5MDUxNSAxMzYzIDU0LjI2NTYxNjciPjwvcG9seWdvbj4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Sequencing monadic transforms" id="sec:validation:kleisli" />
<p class="caption">Sequencing monadic transforms</p>
</div>
<p>Recall that <code>Check</code> is, in the abstract, allowing us to compose functions of type <code>A =&gt; F[B]</code>. We can write the above in terms of <code>andThen</code> as:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> aToC = aToB andThen bToC</code></pre></div>
<p>The result is a (wrapped) function <code>aToC</code> of type <code>A =&gt; F[C]</code> that we can subsequently apply to a value of type <code>A</code>.</p>
<p>We have achieved the same thing as the <code>example</code> method without having to reference an argument of type <code>A</code>. The <code>andThen</code> method on <code>Check</code> is analogous to function composition, but is composing function <code>A =&gt; F[B]</code> instead of <code>A =&gt; B</code>.</p>
<p>The abstract concept of composing functions of type <code>A =&gt; F[B]</code> has a name: a <em>Kleisli</em>.</p>
<p>Cats contains a data type <a href="http://typelevel.org/cats/api/cats/data/Kleisli.html"><code>cats.data.Kleisli</code></a> that wraps a function just as <code>Check</code> does. <code>Kleisli</code> has all the methods of <code>Check</code> plus some additional ones. If <code>Kleisli</code> seems familiar to you, then congratulations. You’ve seen through its disguise and recognised it as another concept from earlier in the book: <code>Kleisli</code> is just another name for <code>ReaderT</code>.</p>
<p>Here is a simple example using <code>Kleisli</code> to transform an integer into a list of integers through three steps:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Kleisli</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._ <span class="co">// for Monad</span></code></pre></div>
<p>These steps each transform an input <code>Int</code> into an output of type <code>List[Int]</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> step1: Kleisli[List, Int, Int] =
  <span class="fu">Kleisli</span>(x =&gt; List(x + <span class="dv">1</span>, x - <span class="dv">1</span>))

<span class="kw">val</span> step2: Kleisli[List, Int, Int] =
  <span class="fu">Kleisli</span>(x =&gt; List(x, -x))

<span class="kw">val</span> step3: Kleisli[List, Int, Int] =
  <span class="fu">Kleisli</span>(x =&gt; List(x * <span class="dv">2</span>, x / <span class="dv">2</span>))</code></pre></div>
<p>We can combine the steps into a single pipeline that combines the underlying <code>Lists</code> using <code>flatMap</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> pipeline = step1 andThen step2 andThen step3</code></pre></div>
<p>The result is a function that consumes a single <code>Int</code> and returns eight outputs, each produced by a different combination of transformations from <code>step1</code>, <code>step2</code>, and <code>step3</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">pipeline.<span class="fu">run</span>(<span class="dv">20</span>)
<span class="co">// res2: List[Int] = List(42, 10, -42, -10, 38, 9, -38, -9)</span></code></pre></div>
<p>The only notable difference between <code>Kleisli</code> and <code>Check</code> in terms of API is that <code>Kleisli</code> renames our <code>apply</code> method to <code>run</code>.</p>
<p>Let’s replace <code>Check</code> with <code>Kleisli</code> in our validation examples. To do so we need to make a few changes to <code>Predicate</code>. We must be able to convert a <code>Predicate</code> to a function, as <code>Kleisli</code> only works with functions. Somewhat more subtly, when we convert a <code>Predicate</code> to a function, it should have type <code>A =&gt; Either[E, A]</code> rather than <code>A =&gt; Validated[E, A]</code> because <code>Kleisli</code> relies on the wrapped function returning a monad.</p>
<p>Add a method to <code>Predicate</code> called <code>run</code> that returns a function of the correct type. Leave the rest of the code in <code>Predicate</code> the same.</p>
<div class="solution">
<p>Here’s an abbreviated definition of <code>run</code>. Like <code>apply</code>, the method must accept an implicit <code>Semigroup</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">Semigroup</span>
<span class="kw">import</span> cats.<span class="fu">data</span>.<span class="fu">Validated</span>

<span class="kw">sealed</span> <span class="kw">trait</span> Predicate[E, A] {
  <span class="kw">def</span> <span class="fu">run</span>(<span class="kw">implicit</span> s: Semigroup[E]): A =&gt; Either[E, A] =
    (a: A) =&gt; <span class="kw">this</span>(a).<span class="fu">toEither</span>

  <span class="kw">def</span> <span class="fu">apply</span>(a: A): Validated[E, A] =
    ??? <span class="co">// etc...</span>

  <span class="co">// other methods...</span>
}</code></pre></div>
</div>
<p>Now rewrite our username and email validation example in terms of <code>Kleisli</code> and <code>Predicate</code>. Here are few tips in case you get stuck:</p>
<p>First, remember that the <code>run</code> method on <code>Predicate</code> takes an implicit parameter. If you call <code>aPredicate.run(a)</code> it will try to pass the implicit parameter explicitly. If you want to create a function from a <code>Predicate</code> and immediately apply that function, use <code>aPredicate.run.apply(a)</code></p>
<p>Second, type inference can be tricky in this exercise. We found that the following definitions helped us to write code with fewer type declarations.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Result[A] = Either[Errors, A]

<span class="kw">type</span> Check[A, B] = Kleisli[Result, A, B]

<span class="co">// Create a check from a function:</span>
<span class="kw">def</span> check[A, B](func: A =&gt; Result[B]): Check[A, B] =
  <span class="fu">Kleisli</span>(func)

<span class="co">// Create a check from a Predicate:</span>
<span class="kw">def</span> checkPred[A](pred: Predicate[Errors, A]): Check[A, A] =
  Kleisli[Result, A, A](pred.<span class="fu">run</span>)</code></pre></div>
<div class="solution">
<p>Working around limitations of type inference can be quite frustrating when writing this code, Working out when to convert between <code>Predicates</code>, functions, and <code>Validated</code>, and <code>Either</code> simplifies things, but the process is still complex:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">data</span>.{Kleisli, NonEmptyList, Validated}
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">either</span>._   <span class="co">// for Semigroupal</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._     <span class="co">// for Monad</span></code></pre></div>
<p>Here is the preamble we suggested in the main text of the case study:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">type</span> Errors = NonEmptyList[String]

<span class="kw">def</span> <span class="fu">error</span>(s: String): NonEmptyList[String] =
  <span class="fu">NonEmptyList</span>(s, Nil)

<span class="kw">type</span> Result[A] = Either[Errors, A]

<span class="kw">type</span> Check[A, B] = Kleisli[Result, A, B]

<span class="kw">def</span> check[A, B](func: A =&gt; Result[B]): Check[A, B] =
  <span class="fu">Kleisli</span>(func)

<span class="kw">def</span> checkPred[A](pred: Predicate[Errors, A]): Check[A, A] =
  Kleisli[Result, A, A](pred.<span class="fu">run</span>)</code></pre></div>
<p>Our base predicate definitions are essenitally unchanged:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">longerThan</span>(n: Int): Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must be longer than $n characters&quot;</span>),
    str =&gt; str.<span class="fu">size</span> &gt; n)

<span class="kw">val</span> alphanumeric: Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must be all alphanumeric characters&quot;</span>),
    str =&gt; str.<span class="fu">forall</span>(_.<span class="fu">isLetterOrDigit</span>))

<span class="kw">def</span> <span class="fu">contains</span>(<span class="dt">char</span>: Char): Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must contain the character $char&quot;</span>),
    str =&gt; str.<span class="fu">contains</span>(<span class="dt">char</span>))

<span class="kw">def</span> <span class="fu">containsOnce</span>(<span class="dt">char</span>: Char): Predicate[Errors, String] =
  Predicate.<span class="fu">lift</span>(
    <span class="fu">error</span>(s<span class="st">&quot;Must contain the character $char only once&quot;</span>),
    str =&gt; str.<span class="fu">filter</span>(c =&gt; c == <span class="dt">char</span>).<span class="fu">size</span> == <span class="dv">1</span>)</code></pre></div>
<p>Our username and email examples are slightly different in that we make use of <code>check()</code> and <code>checkPred()</code> in different situations:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">val</span> checkUsername: Check[String, String] =
  <span class="fu">checkPred</span>(<span class="fu">longerThan</span>(<span class="dv">3</span>) and alphanumeric)

<span class="kw">val</span> splitEmail: Check[String, (String, String)] =
  <span class="fu">check</span>(_.<span class="fu">split</span>(<span class="ch">'@'</span>) <span class="kw">match</span> {
    <span class="kw">case</span> Array(name, domain) =&gt;
      <span class="fu">Right</span>((name, domain))

    <span class="kw">case</span> other =&gt;
      <span class="fu">Left</span>(<span class="fu">error</span>(<span class="st">&quot;Must contain a single @ character&quot;</span>))
  })

<span class="kw">val</span> checkLeft: Check[String, String] =
  <span class="fu">checkPred</span>(<span class="fu">longerThan</span>(<span class="dv">0</span>))

<span class="kw">val</span> checkRight: Check[String, String] =
  <span class="fu">checkPred</span>(<span class="fu">longerThan</span>(<span class="dv">3</span>) and <span class="fu">contains</span>(<span class="ch">'.'</span>))

<span class="kw">val</span> joinEmail: Check[(String, String), String] =
  check {
    <span class="kw">case</span> (l, r) =&gt;
      (<span class="fu">checkLeft</span>(l), <span class="fu">checkRight</span>(r)).<span class="fu">mapN</span>(_ + <span class="st">&quot;@&quot;</span> + _)
  }

<span class="kw">val</span> checkEmail: Check[String, String] =
  splitEmail andThen joinEmail</code></pre></div>
<p>Finally, we can see that our <code>createUser</code> example works as expected using <code>Kleisli</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">User</span>(username: String, email: String)

<span class="kw">def</span> <span class="fu">createUser</span>(
      username: String,
      email: String): Either[Errors, User] = (
  checkUsername.<span class="fu">run</span>(username),
  checkEmail.<span class="fu">run</span>(email)
).<span class="fu">mapN</span>(User)

<span class="fu">createUser</span>(<span class="st">&quot;Noel&quot;</span>, <span class="st">&quot;noel@underscore.io&quot;</span>)
<span class="co">// res16: Either[Errors,User] = Right(User(Noel,noel@underscore.io))</span>

<span class="fu">createUser</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;dave@underscore@io&quot;</span>)
<span class="co">// res17: Either[Errors,User] = Left(NonEmptyList(Must be longer than 3 characters))</span></code></pre></div>
</div>
<p>We have now written our code entirely in terms of <code>Kleisli</code> and <code>Predicate</code>, completely removing <code>Check</code>. This is a good first step to simplifying our library. There’s still plenty more to do, but we have a sophisticated building block from Cats to work with. We’ll leave further improvements up to the reader.</p>
<h2 id="summary-9"><span class="header-section-number">10.6</span> Summary</h2>
<p>This case study has been an exercise in removing rather than building abstractions. We started with a fairly complex <code>Check</code> type. Once we realised we were conflating two concepts, we separated out <code>Predicate</code> leaving us with something that could be implemented with <code>Kleisli</code>.</p>
<!--
`Predicate` is very much like a stripped down version
of the matchers found in testing libraries like ScalaTest and Specs2.
One next step would be to develop
a more elaborate predicate library along these lines.
There are a few other directions to consider.

With the current representation of `Predicate`
there is no way to implement logical negation.
To implement negation we need to know the error message
that a successful predicate would have returned if it had failed
(so that the negation can return that message).
One way to implement this is to have a predicate return a `Boolean` flag
indicating success or failure and the associated message.

We could also do better in how error messages are represented.
At the moment there is no indication with an error message
of the structure of the predicates that failed.
For example, if we represent error messsages as a `List[String]`
and we get back the message:

```scala
List("Must be longer than 4 characters",
     "Must not contain a number")
```

does this message indicate a failing conjunction (two `ands`)
or a failing disjunction (two `ors`)?
We can probably guess in this case
but in general we don't have sufficient information to work this out.
We can solve this problem by wrapping all messages in a type as follows:

```scala
object wrapper {
  sealed trait Structure[E]

  final case class Or[E](messages: List[Structure[E]])
    extends Structure[E]

  final case class And[E](messages: List[Structure[E]])
    extends Structure[E]

  final case class Not[E](messages: List[Structure[E]])
    extends Structure[E]

  final case class Pure[E](message: E)
    extends Structure[E]
}; import wrapper._
```

We can simplify this structure by converting all predicates into a normal form.
For example, if we use disjunctive normal form
the structure of the predicate will always be
a disjunction (logical or) of conjunctions (logical and).
By doing so we could errors as a `List[List[Either[E, E]]]`,
with the outer list representing disjunction,
the inner list representing conjunction,
and the `Either` representing negation.
-->
<p>We made several design choices above that reasonable developers may disagree with. Should the method that converts a <code>Predicate</code> to a function really be called <code>run</code> instead of, say, <code>toFunction</code>? Should <code>Predicate</code> be a subtype of <code>Function</code> to begin with? Many functional programmers prefer to avoid subtyping because it plays poorly with implicit resolution and type inference, but there could be an argument to use it here. As always the best decisions depend on the context in which the library will be used.</p>
<h1 id="case-study-crdts"><span class="header-section-number">11</span> Case Study: CRDTs</h1>
<p>In this case study we will explore <em>Commutative Replicated Data Types (CRDTs)</em>, a family of data structures that can be used to reconcile eventually consistent data.</p>
<p>We’ll start by describing the utility and difficulty of eventually consistent systems, then show how we can use monoids and their extensions to solve the issues that arise. Finally, we will model the solutions in Scala.</p>
<p>Our goal here is to focus on the implementation in Scala of a particular type of CRDT. We’re not aiming at a comprehensive survey of all CRDTs. CRDTs are a fast-moving field and we advise you to read the literature to learn about more.</p>
<h2 id="eventual-consistency"><span class="header-section-number">11.1</span> Eventual Consistency</h2>
<p>As soon as a system scales beyond a single machine we have to make a fundamental choice about how we manage data.</p>
<p>One approach is to build a system that is <em>consistent</em>, meaning that all machines have the same view of data. For example, if a user changes their password then all machines that store a copy of that password must accept the change before we consider the operation to have completed successfully.</p>
<p>Consistent systems are easy to work with but they have their disadvantages. They tend to have high latency because a single change can result in many messages being sent between machines. They also tend to have relatively low uptime because outages can cut communications between machines creating a <em>network partition</em>. When there is a network partition, a consistent system may refuse further updates to prevent inconsistencies across machines.</p>
<p>An alternative approach is an <em>eventually consistent</em> system. This means that at any particular point in time machines are allowed to have differing views of data. However, if all machines can communicate and there are no further updates they will eventually all have the same view of data.</p>
<p>Eventually consistent systems require less communication between machines so latency can be lower. A partitioned machine can still accept updates and reconcile its changes when the network is fixed, so systems can also can have better uptime.</p>
<p>The big question is: how do we do this reconciliation between machines? CRDTs provide one approach to the problem.</p>
<h2 id="the-gcounter"><span class="header-section-number">11.2</span> The GCounter</h2>
<p>Let’s look at one particular CRDT implementation. Then we’ll attempt to generalise properties to see if we can find a general pattern.</p>
<p>The data structure we will look at is called a <em>GCounter</em>. It is a distributed <em>increment-only</em> counter that can be used, for example, to count the number of visitors to a web site where requests are served by many web servers.</p>
<h3 id="simple-counters"><span class="header-section-number">11.2.1</span> Simple Counters</h3>
<p>To see why a straightforward counter won’t work, imagine we have two servers storing a simple count of visitors. Let’s call the machines <code>A</code> and <code>B</code>. Each machine is storing an integer counter and the counters all start at zero as shown in Figure 24.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjM2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSAzNjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5zaW1wbGUtY291bnRlcjE8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz48L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0ic2ltcGxlLWNvdW50ZXIxIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzYxIiBoZWlnaHQ9IjM2MCI+PC9yZWN0PgogICAgICAgICAgICA8dGV4dCBpZD0iTWFjaGluZS1CIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjQyIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI5ODEuMjgzMjAzIiB5PSI2NCI+TWFjaGluZSBCPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSI5ODEiIHk9IjEyMSIgd2lkdGg9IjE5NiIgaGVpZ2h0PSIxOTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJNYWNoaW5lLUEiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjU4My40MzE2NDEiIHk9IjY0Ij5NYWNoaW5lIEE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIwIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI2NTYiIHk9IjI0NiI+MDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEwNTUiIHk9IjI0NiI+MDwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iNTgyIiB5PSIxMjEiIHdpZHRoPSIxOTYiIGhlaWdodD0iMTk2IiByeD0iOCI+PC9yZWN0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 24: Simple counters: initial state" id="fig:crdt:simple-counter1" />
<p class="caption">Figure 24: Simple counters: initial state</p>
</div>
<p>Now imagine we receive some web traffic. Our load balancer distributes five incoming requests to <code>A</code> and <code>B</code>, <code>A</code> serving three visitors and <code>B</code> two. The machines have inconsistent views of the system state that they need to <em>reconcile</em> to achieve consistency. One reconciliation strategy with simple counters is to exchange counts and add them as shown in Figure 25.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjY2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSA2NjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5zaW1wbGUtY291bnRlcjM8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz48L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0ic2ltcGxlLWNvdW50ZXIzIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzYxIiBoZWlnaHQ9IjY2MCI+PC9yZWN0PgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSI5ODEiIHk9IjQyMiIgd2lkdGg9IjE5NiIgaGVpZ2h0PSIxOTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgIDx0ZXh0IGlkPSI1IiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSI2NTYiIHk9IjU0OCI+NTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IjUiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEwNTUiIHk9IjU0NyI+NTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iNTgyIiB5PSI0MjIiIHdpZHRoPSIxOTYiIGhlaWdodD0iMTk2IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODg1LjQwMTA4NSwgMzc0LjQwMTA4NSkgcm90YXRlKC0zMTUuMDAwMDAwKSB0cmFuc2xhdGUoLTg4NS40MDEwODUsIC0zNzQuNDAxMDg1KSAiIHBvaW50cz0iNzc3Ljc1NTY1NSAzNTQuNjkxOTQ2IDk1My4wNDY1MTUgMzU0LjQwMTA4NSA5NTMuMDQ2NTE1IDMzNC40MDEwODUgOTkzLjA0NjUxNSAzNzMuODk4ODUyIDk1My4wNDY1MTUgNDE0LjQwMTA4NSA5NTMuMDQ2NTE1IDM5NC40MDEwODUgNzc3Ljc1NTY1NSAzOTQuNjkxOTQ2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4NzguNDAxMDg1LCAzNzQuNDAxMDg1KSByb3RhdGUoLTIyNS4wMDAwMDApIHRyYW5zbGF0ZSgtODc4LjQwMTA4NSwgLTM3NC40MDEwODUpICIgcG9pbnRzPSI3NzAuNzU1NjU1IDM1NC42OTE5NDYgOTQ2LjA0NjUxNSAzNTQuNDAxMDg1IDk0Ni4wNDY1MTUgMzM0LjQwMTA4NSA5ODYuMDQ2NTE1IDM3My44OTg4NTIgOTQ2LjA0NjUxNSA0MTQuNDAxMDg1IDk0Ni4wNDY1MTUgMzk0LjQwMTA4NSA3NzAuNzU1NjU1IDM5NC42OTE5NDYiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS0xIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNCIgeD0iOTgxIiB5PSIxMjIiIHdpZHRoPSIxOTYiIGhlaWdodD0iMTk2IiByeD0iOCI+PC9yZWN0PgogICAgICAgICAgICA8dGV4dCBpZD0iMyIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI4MCIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNjU2IiB5PSIyNDciPjM8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIyIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDU1IiB5PSIyNDciPjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iMTIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQiIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iOTgxLjI4MzIwMyIgeT0iNzAiPk1hY2hpbmUgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTgzLjQzMTY0MSIgeT0iNzAiPk1hY2hpbmUgQTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkFkZC1jb3VudGVycyIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNzc1LjQzMzU5NCIgeT0iMzg0Ij5BZGQgY291bnRlcnM8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzI3LjY0NTQzMCwgMjIwLjAwMDAwMCkgc2NhbGUoLTEsIDEpIHRyYW5zbGF0ZSgtMTMyNy42NDU0MzAsIC0yMjAuMDAwMDAwKSAiIHBvaW50cz0iMTIyMCAyMDAuMjkwODYxIDEzOTUuMjkwODYgMjAwIDEzOTUuMjkwODYgMTgwIDE0MzUuMjkwODYgMjE5LjQ5Nzc2NyAxMzk1LjI5MDg2IDI2MCAxMzk1LjI5MDg2IDI0MCAxMjIwIDI0MC4yOTA4NjEiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkluY29taW5nLXJlcXVlc3RzIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMjc0LjQyMzgzIiB5PSIxODEiPkluY29taW5nIHJlcXVlc3RzPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIzMjYgMjAwLjI5MDg2MSA1MDEuMjkwODYxIDIwMCA1MDEuMjkwODYxIDE4MCA1NDEuMjkwODYxIDIxOS40OTc3NjcgNTAxLjI5MDg2MSAyNjAgNTAxLjI5MDg2MSAyNDAgMzI2IDI0MC4yOTA4NjEiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkluY29taW5nLXJlcXVlc3RzIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxOTAuNDIzODI4IiB5PSIxODEiPkluY29taW5nIHJlcXVlc3RzPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 25: Simple counters: first round of requests and reconciliation" id="fig:crdt:simple-counter3" />
<p class="caption">Figure 25: Simple counters: first round of requests and reconciliation</p>
</div>
<p>So far so good, but things will start to fall apart shortly. Suppose <code>A</code> serves a single visitor, which means we’ve seen six visitors in total. The machines attempt to reconcile state again using addition leading to the answer shown in Figure 26.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjY2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSA2NjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5zaW1wbGUtY291bnRlcjU8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZGVmcz48L2RlZnM+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0ic2ltcGxlLWNvdW50ZXI1Ij4KICAgICAgICAgICAgPHJlY3QgaWQ9IkJhY2tncm91bmQiIGZpbGw9IiNGRkZGRkYiIHg9IjAiIHk9IjAiIHdpZHRoPSIxNzYxIiBoZWlnaHQ9IjY2MCI+PC9yZWN0PgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSI5ODEiIHk9IjQyMiIgd2lkdGg9IjE5NiIgaGVpZ2h0PSIxOTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgIDx0ZXh0IGlkPSIxMSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI4MCIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNjMyIiB5PSI1NDgiPjExPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iMTEiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEwMzEiIHk9IjU0NyI+MTE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iNDIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDg4NS40MDEwODUsIDM3NC40MDEwODUpIHJvdGF0ZSgtMzE1LjAwMDAwMCkgdHJhbnNsYXRlKC04ODUuNDAxMDg1LCAtMzc0LjQwMTA4NSkgIiBwb2ludHM9Ijc3Ny43NTU2NTUgMzU0LjY5MTk0NiA5NTMuMDQ2NTE1IDM1NC40MDEwODUgOTUzLjA0NjUxNSAzMzQuNDAxMDg1IDk5My4wNDY1MTUgMzczLjg5ODg1MiA5NTMuMDQ2NTE1IDQxNC40MDEwODUgOTUzLjA0NjUxNSAzOTQuNDAxMDg1IDc3Ny43NTU2NTUgMzk0LjY5MTk0NiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODc4LjQwMTA4NSwgMzc0LjQwMTA4NSkgcm90YXRlKC0yMjUuMDAwMDAwKSB0cmFuc2xhdGUoLTg3OC40MDEwODUsIC0zNzQuNDAxMDg1KSAiIHBvaW50cz0iNzcwLjc1NTY1NSAzNTQuNjkxOTQ2IDk0Ni4wNDY1MTUgMzU0LjQwMTA4NSA5NDYuMDQ2NTE1IDMzNC40MDEwODUgOTg2LjA0NjUxNSAzNzMuODk4ODUyIDk0Ni4wNDY1MTUgNDE0LjQwMTA4NSA5NDYuMDQ2NTE1IDM5NC40MDEwODUgNzcwLjc1NTY1NSAzOTQuNjkxOTQ2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MSIgeT0iMTIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9IjYiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjY1NiIgeT0iMjQ3Ij42PC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iNSIgZm9udC1mYW1pbHk9IkZpcmFNb25vLVJlZ3VsYXIsIEZpcmEgTW9ubyIgZm9udC1zaXplPSI4MCIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTA1NSIgeT0iMjQ3Ij41PC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTEiIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSI0IiB4PSI1ODIiIHk9IjEyMiIgd2lkdGg9IjE5NiIgaGVpZ2h0PSIxOTYiIHJ4PSI4Ij48L3JlY3Q+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJNYWNoaW5lLUIiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijk4MS4yODMyMDMiIHk9IjcwIj5NYWNoaW5lIEI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJNYWNoaW5lLUEiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjU4My40MzE2NDEiIHk9IjcwIj5NYWNoaW5lIEE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBZGQtY291bnRlcnMiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijc3NS40MzM1OTQiIHk9IjM4MiI+QWRkIGNvdW50ZXJzPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8dGV4dCBpZD0iSW5jb3JyZWN0LXJlc3VsdCEiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEzMTguOTU5OTYiIHk9IjUyOSI+SW5jb3JyZWN0IHJlc3VsdCE8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxnIGlkPSJHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTI3Mi42Nzk0NTUsIDUxOS42Nzk0NTUpIHJvdGF0ZSgtMzE1LjAwMDAwMCkgdHJhbnNsYXRlKC0xMjcyLjY3OTQ1NSwgLTUxOS42Nzk0NTUpIHRyYW5zbGF0ZSgxMjM1LjY3OTQ1NSwgNDgyLjE3OTQ1NSkiIGZpbGw9IiNGRjAwMDAiPgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZSIgeD0iMCIgeT0iMjYuNTQ3NzI3MiIgd2lkdGg9IjczLjc0MzY4NjciIGhlaWdodD0iMjAuNjQ4MjMyMyI+PC9yZWN0PgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzYuODcxODQzLCAzNy4yNDA1NjIpIHJvdGF0ZSgtOTAuMDAwMDAwKSB0cmFuc2xhdGUoLTM2Ljg3MTg0MywgLTM3LjI0MDU2MikgIiB4PSIwIiB5PSIyOC4wMjI2MDA5IiB3aWR0aD0iNzMuNzQzNjg2NyIgaGVpZ2h0PSIxOC40MzU5MjE3Ij48L3JlY3Q+CiAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHBvaW50cz0iMzI2IDIwMS4yOTA4NjEgNTAxLjI5MDg2MSAyMDEgNTAxLjI5MDg2MSAxODEgNTQxLjI5MDg2MSAyMjAuNDk3NzY3IDUwMS4yOTA4NjEgMjYxIDUwMS4yOTA4NjEgMjQxIDMyNiAyNDEuMjkwODYxIj48L3BvbHlnb24+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJJbmNvbWluZy1yZXF1ZXN0IiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIyMTEuNDIzODI4IiB5PSIxODIiPkluY29taW5nIHJlcXVlc3Q8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 26: Simple counters: second round of requests and (incorrect) reconciliation" id="fig:crdt:simple-counter5" />
<p class="caption">Figure 26: Simple counters: second round of requests and (incorrect) reconciliation</p>
</div>
<p>This is clearly wrong! The problem is that simple counters don’t give us enough information about the history of interactions between the machines. Fortunately we don’t need to store the <em>complete</em> history to get the correct answer—just a summary of it. Let’s look at the GCounter see how it solves this problem.</p>
<h3 id="gcounters"><span class="header-section-number">11.2.2</span> GCounters</h3>
<p>The first clever idea in the GCounter is to have each machine storing a <em>separate</em> counter for every machine it knows about (including itself). In the previous example we had two machines, <code>A</code> and <code>B</code>. In this situation both machines would store a counter for <code>A</code> and a counter for <code>B</code> as shown in Figure 27.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjM2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSAzNjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5nLWNvdW50ZXIxPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImctY291bnRlcjEiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjEiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJNYWNoaW5lLUIiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iNDIiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9Ijk4MS4yODMyMDMiIHk9IjY0Ij5NYWNoaW5lIEI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MSIgeT0iMTIxIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTgzLjQzMTY0MSIgeT0iNjQiPk1hY2hpbmUgQTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9IkE6MC1COjAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iMjA1Ij5BOjA8L3RzcGFuPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iMjc3Ij5COjA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBOjAtQjowIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjYwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDI1IiB5PSIyMDYiPkE6MDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAyNSIgeT0iMjc4Ij5COjA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iMTIxIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==" alt="Figure 27: GCounter: initial state" id="fig:crdt:g-counter1" />
<p class="caption">Figure 27: GCounter: initial state</p>
</div>
<p>The rule with GCounters is that a given machine is only allowed to increment its own counter. If <code>A</code> serves three visitors and <code>B</code> serves two visitors the counters look as shown in Figure 28.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjM2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSAzNjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5nLWNvdW50ZXIyPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImctY291bnRlcjIiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjEiIGhlaWdodD0iMzYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MCIgeT0iMTIzIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9IkE6My1COjAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNSIgeT0iMjA1Ij5BOjM8L3RzcGFuPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNSIgeT0iMjc3Ij5COjA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBOjAtQjoyIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjYwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDI0IiB5PSIyMDUiPkE6MDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAyNCIgeT0iMjc3Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MSIgeT0iMTIzIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQiIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iOTgwLjI4MzIwMyIgeT0iNzEiPk1hY2hpbmUgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTgyLjQzMTY0MSIgeT0iNzEiPk1hY2hpbmUgQTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzMjcuNjQ1NDMwLCAyMjEuMDAwMDAwKSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0xMzI3LjY0NTQzMCwgLTIyMS4wMDAwMDApICIgcG9pbnRzPSIxMjIwIDIwMS4yOTA4NjEgMTM5NS4yOTA4NiAyMDEgMTM5NS4yOTA4NiAxODEgMTQzNS4yOTA4NiAyMjAuNDk3NzY3IDEzOTUuMjkwODYgMjYxIDEzOTUuMjkwODYgMjQxIDEyMjAgMjQxLjI5MDg2MSI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iSW5jb21pbmctcmVxdWVzdHMiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEyNzQuNDIzODMiIHk9IjE4MiI+SW5jb21pbmcgcmVxdWVzdHM8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjMyNiAyMDEuMjkwODYxIDUwMS4yOTA4NjEgMjAxIDUwMS4yOTA4NjEgMTgxIDU0MS4yOTA4NjEgMjIwLjQ5Nzc2NyA1MDEuMjkwODYxIDI2MSA1MDEuMjkwODYxIDI0MSAzMjYgMjQxLjI5MDg2MSI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iSW5jb21pbmctcmVxdWVzdHMiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjE5MC40MjM4MjgiIHk9IjE4MiI+SW5jb21pbmcgcmVxdWVzdHM8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=" alt="Figure 28: GCounter: first round of web requests" id="fig:crdt:g-counter2" />
<p class="caption">Figure 28: GCounter: first round of web requests</p>
</div>
<p>When two machines reconcile their counters the rule is to take the largest value stored for each machine. In our example, the result of the first merge will be as shown in Figure 29.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjY2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSA2NjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5nLWNvdW50ZXIzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImctY291bnRlcjMiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjEiIGhlaWdodD0iNjYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MSIgeT0iNDIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9IkE6My1COjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iNTA0Ij5BOjM8L3RzcGFuPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iNTc2Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBOjMtQjoyIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjYwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDI1IiB5PSI1MDMiPkE6MzwvdHNwYW4+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAyNSIgeT0iNTc1Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iNDIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDg4NS40MDEwODUsIDM3NC40MDEwODUpIHJvdGF0ZSgtMzE1LjAwMDAwMCkgdHJhbnNsYXRlKC04ODUuNDAxMDg1LCAtMzc0LjQwMTA4NSkgIiBwb2ludHM9Ijc3Ny43NTU2NTUgMzU0LjY5MTk0NiA5NTMuMDQ2NTE1IDM1NC40MDEwODUgOTUzLjA0NjUxNSAzMzQuNDAxMDg1IDk5My4wNDY1MTUgMzczLjg5ODg1MiA5NTMuMDQ2NTE1IDQxNC40MDEwODUgOTUzLjA0NjUxNSAzOTQuNDAxMDg1IDc3Ny43NTU2NTUgMzk0LjY5MTk0NiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODc4LjQwMTA4NSwgMzc0LjQwMTA4NSkgcm90YXRlKC0yMjUuMDAwMDAwKSB0cmFuc2xhdGUoLTg3OC40MDEwODUsIC0zNzQuNDAxMDg1KSAiIHBvaW50cz0iNzcwLjc1NTY1NSAzNTQuNjkxOTQ2IDk0Ni4wNDY1MTUgMzU0LjQwMTA4NSA5NDYuMDQ2NTE1IDMzNC40MDEwODUgOTg2LjA0NjUxNSAzNzMuODk4ODUyIDk0Ni4wNDY1MTUgNDE0LjQwMTA4NSA5NDYuMDQ2NTE1IDM5NC40MDEwODUgNzcwLjc1NTY1NSAzOTQuNjkxOTQ2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MSIgeT0iMTIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9IkE6My1COjAiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iMjAzIj5BOjM8L3RzcGFuPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iMjc1Ij5COjA8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBOjAtQjoyIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjYwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDI1IiB5PSIyMDMiPkE6MDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAyNSIgeT0iMjc1Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iMTIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQiIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iOTgxLjI4MzIwMyIgeT0iNzAiPk1hY2hpbmUgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTgzLjQzMTY0MSIgeT0iNzAiPk1hY2hpbmUgQTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1lcmdlLC10YWtlLW1heCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNzQ3LjQ0OTIxOSIgeT0iMzg0Ij5NZXJnZSwgdGFrZSBtYXg8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMzI4LjY0NTQzMCwgMjIwLjAwMDAwMCkgc2NhbGUoLTEsIDEpIHRyYW5zbGF0ZSgtMTMyOC42NDU0MzAsIC0yMjAuMDAwMDAwKSAiIHBvaW50cz0iMTIyMSAyMDAuMjkwODYxIDEzOTYuMjkwODYgMjAwIDEzOTYuMjkwODYgMTgwIDE0MzYuMjkwODYgMjE5LjQ5Nzc2NyAxMzk2LjI5MDg2IDI2MCAxMzk2LjI5MDg2IDI0MCAxMjIxIDI0MC4yOTA4NjEiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkluY29taW5nLXJlcXVlc3RzIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMjc1LjQyMzgzIiB5PSIxODEiPkluY29taW5nIHJlcXVlc3RzPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgcG9pbnRzPSIzMjcgMjAwLjI5MDg2MSA1MDIuMjkwODYxIDIwMCA1MDIuMjkwODYxIDE4MCA1NDIuMjkwODYxIDIxOS40OTc3NjcgNTAyLjI5MDg2MSAyNjAgNTAyLjI5MDg2MSAyNDAgMzI3IDI0MC4yOTA4NjEiPjwvcG9seWdvbj4KICAgICAgICAgICAgPHRleHQgaWQ9IkluY29taW5nLXJlcXVlc3RzIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjM2IiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxOTEuNDIzODI4IiB5PSIxODEiPkluY29taW5nIHJlcXVlc3RzPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 29: GCounter: first reconciliation" id="fig:crdt:g-counter3" />
<p class="caption">Figure 29: GCounter: first reconciliation</p>
</div>
<p>Subsequent incoming web requests are handled using the increment-own-counter rule and subsequent merges are handled using the take-maximum-value rule, producing the same correct values for each machine as shown in Figure 30.</p>
<div class="figure">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTc2MXB4IiBoZWlnaHQ9IjY2MHB4IiB2aWV3Qm94PSIwIDAgMTc2MSA2NjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDQzLjIgKDM5MDY5KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5nLWNvdW50ZXI1PC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImctY291bnRlcjUiPgogICAgICAgICAgICA8cmVjdCBpZD0iQmFja2dyb3VuZCIgZmlsbD0iI0ZGRkZGRiIgeD0iMCIgeT0iMCIgd2lkdGg9IjE3NjEiIGhlaWdodD0iNjYwIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MSIgeT0iNDIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9IkE6NC1COjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iNTA3Ij5BOjQ8L3RzcGFuPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iNTc5Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBOjQtQjoyIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjYwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDI1IiB5PSI1MDYiPkE6NDwvdHNwYW4+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAyNSIgeT0iNTc4Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iNDIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgtMS1Db3B5LTIiIGZpbGw9IiNGNkE2MjMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDg4NS40MDEwODUsIDM3NC40MDEwODUpIHJvdGF0ZSgtMzE1LjAwMDAwMCkgdHJhbnNsYXRlKC04ODUuNDAxMDg1LCAtMzc0LjQwMTA4NSkgIiBwb2ludHM9Ijc3Ny43NTU2NTUgMzU0LjY5MTk0NiA5NTMuMDQ2NTE1IDM1NC40MDEwODUgOTUzLjA0NjUxNSAzMzQuNDAxMDg1IDk5My4wNDY1MTUgMzczLjg5ODg1MiA5NTMuMDQ2NTE1IDQxNC40MDEwODUgOTUzLjA0NjUxNSAzOTQuNDAxMDg1IDc3Ny43NTU2NTUgMzk0LjY5MTk0NiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aC0xLUNvcHktMiIgZmlsbD0iI0Y2QTYyMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODc4LjQwMTA4NSwgMzc0LjQwMTA4NSkgcm90YXRlKC0yMjUuMDAwMDAwKSB0cmFuc2xhdGUoLTg3OC40MDEwODUsIC0zNzQuNDAxMDg1KSAiIHBvaW50cz0iNzcwLjc1NTY1NSAzNTQuNjkxOTQ2IDk0Ni4wNDY1MTUgMzU0LjQwMTA4NSA5NDYuMDQ2NTE1IDMzNC40MDEwODUgOTg2LjA0NjUxNSAzNzMuODk4ODUyIDk0Ni4wNDY1MTUgNDE0LjQwMTA4NSA5NDYuMDQ2NTE1IDM5NC40MDEwODUgNzcwLjc1NTY1NSAzOTQuNjkxOTQ2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9Ijk4MSIgeT0iMTIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9IkE6NC1COjIiIGZvbnQtZmFtaWx5PSJGaXJhTW9uby1SZWd1bGFyLCBGaXJhIE1vbm8iIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iMjA2Ij5BOjQ8L3RzcGFuPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjYyNiIgeT0iMjc4Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJBOjMtQjoyIiBmb250LWZhbWlseT0iRmlyYU1vbm8tUmVndWxhciwgRmlyYSBNb25vIiBmb250LXNpemU9IjYwIiBmb250LXdlaWdodD0ibm9ybWFsIiBmaWxsPSIjMDAwMDAwIj4KICAgICAgICAgICAgICAgIDx0c3BhbiB4PSIxMDI1IiB5PSIyMDYiPkE6MzwvdHNwYW4+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMTAyNSIgeT0iMjc4Ij5COjI8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtMSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjQiIHg9IjU4MiIgeT0iMTIyIiB3aWR0aD0iMTk2IiBoZWlnaHQ9IjE5NiIgcng9IjgiPjwvcmVjdD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQiIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iOTgxLjI4MzIwMyIgeT0iNzAiPk1hY2hpbmUgQjwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1hY2hpbmUtQSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSI0MiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNTgzLjQzMTY0MSIgeT0iNzAiPk1hY2hpbmUgQTwvdHNwYW4+CiAgICAgICAgICAgIDwvdGV4dD4KICAgICAgICAgICAgPHRleHQgaWQ9Ik1lcmdlLC10YWtlLW1heCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iNzQ3LjQ0OTIxOSIgeT0iMzgyIj5NZXJnZSwgdGFrZSBtYXg8L3RzcGFuPgogICAgICAgICAgICA8L3RleHQ+CiAgICAgICAgICAgIDx0ZXh0IGlkPSJDb3JyZWN0LXJlc3VsdCEiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMzYiIGZvbnQtd2VpZ2h0PSJub3JtYWwiIGZpbGw9IiMwMDAwMDAiPgogICAgICAgICAgICAgICAgPHRzcGFuIHg9IjEzMjkuOTcyNjYiIHk9IjUyOSI+Q29ycmVjdCByZXN1bHQhPC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgICAgICA8ZyBpZD0iR3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEyNzQuNDQ3MjIyLCA1MTIuOTYxOTQxKSByb3RhdGUoLTMxNS4wMDAwMDApIHRyYW5zbGF0ZSgtMTI3NC40NDcyMjIsIC01MTIuOTYxOTQxKSB0cmFuc2xhdGUoMTI1NS45NDcyMjIsIDQ3NS40NjE5NDEpIiBmaWxsPSIjNDE3NTA1Ij4KICAgICAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUiIHg9Ii0yLjI3MzczNjc1ZS0xMyIgeT0iNTMuNzYwOTMwNyIgd2lkdGg9IjM2LjExNjI2OTciIGhlaWdodD0iMjAuNjQ4MjMyMyI+PC9yZWN0PgogICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjcuNTI4Njk4LCAzNy41ODM3MDgpIHJvdGF0ZSgtOTAuMDAwMDAwKSB0cmFuc2xhdGUoLTI3LjUyODY5OCwgLTM3LjU4MzcwOCkgIiB4PSItOS4zNDMxNDU3NSIgeT0iMjguMzY1NzQ2NyIgd2lkdGg9IjczLjc0MzY4NjciIGhlaWdodD0iMTguNDM1OTIxNyI+PC9yZWN0PgogICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTEtQ29weS0yIiBmaWxsPSIjRjZBNjIzIiBwb2ludHM9IjMyNiAyMDAuMjkwODYxIDUwMS4yOTA4NjEgMjAwIDUwMS4yOTA4NjEgMTgwIDU0MS4yOTA4NjEgMjE5LjQ5Nzc2NyA1MDEuMjkwODYxIDI2MCA1MDEuMjkwODYxIDI0MCAzMjYgMjQwLjI5MDg2MSI+PC9wb2x5Z29uPgogICAgICAgICAgICA8dGV4dCBpZD0iSW5jb21pbmctcmVxdWVzdCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9Im5vcm1hbCIgZmlsbD0iIzAwMDAwMCI+CiAgICAgICAgICAgICAgICA8dHNwYW4geD0iMjExLjQyMzgyOCIgeT0iMTgxIj5JbmNvbWluZyByZXF1ZXN0PC90c3Bhbj4KICAgICAgICAgICAgPC90ZXh0PgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+" alt="Figure 30: GCounter: second reconciliation" id="fig:crdt:g-counter5" />
<p class="caption">Figure 30: GCounter: second reconciliation</p>
</div>
<p>GCounters allow each machine to keep an accurate account of the state of the whole system without storing the complete history of interactions. If a machine wants to calculate the total traffic for the whole web site, it sums up all the per-machine counters. The result is accurate or near-accurate depending on how recently we performed a reconciliation. Eventually, regardless of network outages, the system will always converge on a consistent state.</p>
<h3 id="exercise-gcounter-implementation"><span class="header-section-number">11.2.3</span> Exercise: GCounter Implementation</h3>
<p>We can implement a GCounter with the following interface, where we represent machine IDs as <code>Strings</code>.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">GCounter</span>(counters: Map[String, Int]) {
  <span class="kw">def</span> <span class="fu">increment</span>(machine: String, amount: Int) =
    ???

  <span class="kw">def</span> <span class="fu">merge</span>(that: GCounter): GCounter =
    ???

  <span class="kw">def</span> total: Int =
    ???
}</code></pre></div>
<p>Finish the implementation!</p>
<div class="solution">
<p>Hopefully the description above was clear enough that you can get to an implementation like the one below.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">GCounter</span>(counters: Map[String, Int]) {
  <span class="kw">def</span> <span class="fu">increment</span>(machine: String, amount: Int) = {
    <span class="kw">val</span> value = amount + counters.<span class="fu">getOrElse</span>(machine, <span class="dv">0</span>)
    <span class="fu">GCounter</span>(counters + (machine -&gt; value))
  }

  <span class="kw">def</span> <span class="fu">merge</span>(that: GCounter): GCounter =
    <span class="fu">GCounter</span>(that.<span class="fu">counters</span> ++ <span class="kw">this</span>.<span class="fu">counters</span>.<span class="fu">map</span> {
      <span class="kw">case</span> (k, v) =&gt;
        k -&gt; (v max that.<span class="fu">counters</span>.<span class="fu">getOrElse</span>(k, <span class="dv">0</span>))
    })

  <span class="kw">def</span> total: Int =
    counters.<span class="fu">values</span>.<span class="fu">sum</span>
}</code></pre></div>
</div>
<h2 id="generalisation"><span class="header-section-number">11.3</span> Generalisation</h2>
<p>We’ve now created a distributed, eventually consistent, increment-only counter. This is a useful achievement but we don’t want to stop here. In this section we will attempt to abstract the operations in the GCounter so it will work with more data types than just natural numbers.</p>
<p>The GCounter uses the following operations on natural numbers:</p>
<ul>
<li>addition (in <code>increment</code> and <code>total</code>);</li>
<li>maximum (in <code>merge</code>);</li>
<li>and the identity element 0 (in <code>increment</code> and <code>merge</code>).</li>
</ul>
<p>You can probably guess that there’s a monoid in here somewhere, but let’s look in more detail at the properties we’re relying on.</p>
<p>As a refresher, in Chapter 2 we saw that monoids must satisfy two laws. The binary operation <code>+</code> must be associative:</p>
<p><code>(a + b) + c == a + (b + c)</code></p>
<p>and the empty element must be an identity:</p>
<p><code>0 + a == a + 0 == a</code></p>
<p>We need an identity in <code>increment</code> to initialise the counter. We also rely on associativity to ensure the specific sequence of <code>merges</code> gives the correct value.</p>
<p>In <code>total</code> we implicitly rely on associativity and commutativity to ensure we get the correct value no matter what arbitrary order we choose to sum the per-machine counters. We also implicitly assume an identity, which allows us to skip machines for which we do not store a counter.</p>
<p>The properties of <code>merge</code> are a bit more interesting. We rely on commutativity to ensure that machine <code>A</code> merging with machine <code>B</code> yields the same result as machine <code>B</code> merging with machine <code>A</code>. We need associativity to ensure we obtain the correct result when three or more machines are merging data. We need an identity element to initialise empty counters. Finally, we need an additional property, called <em>idempotency</em>, to ensure that if two machines hold the same data in a per-machine counter, merging data will not lead to an incorrect result. Idempotent operations are ones that return the same result again and again if they are executed multiple times. Formally, a binary operation <code>max</code> is idempotent if the following relationship holds:</p>
<pre><code>a max a = a</code></pre>
<p>Written more compactly, we have:</p>
<div class="table-responsive">
<table style="width:96%;">
<colgroup>
<col width="20%"></col>
<col width="16%"></col>
<col width="19%"></col>
<col width="19%"></col>
<col width="19%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="center">Method</th>
<th align="center">Identity</th>
<th align="center">Commutative</th>
<th align="center">Associative</th>
<th align="center">Idempotent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>increment</code></td>
<td align="center">Y</td>
<td align="center">N</td>
<td align="center">Y</td>
<td align="center">N</td>
</tr>
<tr class="even">
<td align="center"><code>merge</code></td>
<td align="center">Y</td>
<td align="center">Y</td>
<td align="center">Y</td>
<td align="center">Y</td>
</tr>
<tr class="odd">
<td align="center"><code>total</code></td>
<td align="center">Y</td>
<td align="center">Y</td>
<td align="center">Y</td>
<td align="center">N</td>
</tr>
</tbody>
</table>
</div>
<p>From this we can see that</p>
<ul>
<li><code>increment</code> requires a monoid;</li>
<li><code>total</code> requires a commutative monoid; and</li>
<li><code>merge</code> required an idempotent commutative monoid, also called a <em>bounded semilattice</em>.</li>
</ul>
<p>Since <code>increment</code> and <code>get</code> both use the same binary operation (addition) it’s usual to require the same commutative monoid for both.</p>
<p>This investigation demonstrates the powers of thinking about properties or laws of abstractions. Now we have identified these properties we can substitute the natural numbers used in our GCounter with any data type with operations satisfying these properties. A simple example is a set, with the binary operation being union and the identity element the empty set. With this simple substitution of <code>Int</code> for <code>Set[A]</code> we can create a GSet type.</p>
<h3 id="implementation"><span class="header-section-number">11.3.1</span> Implementation</h3>
<p>Let’s implement this generalisation in code. Remember <code>increment</code> and <code>total</code> require a commutative monoid and <code>merge</code> requires a bounded semilattice (or idempotent commutative monoid).</p>
<p>Cats provides a type class for both <code>Monoid</code> and <code>CommutativeMonoid</code>, but doesn’t provide one for bounded semilattice<a href="#fn14" class="footnoteRef" id="fnref14"><sup>14</sup></a>. That’s why we’re going to implement our own <code>BoundedSemiLattice</code> type class.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">kernel</span>.<span class="fu">CommutativeMonoid</span>

<span class="kw">trait</span> BoundedSemiLattice[A] <span class="kw">extends</span> CommutativeMonoid[A] {
  <span class="kw">def</span> <span class="fu">combine</span>(a1: A, a2: A): A
  <span class="kw">def</span> empty: A
}</code></pre></div>
<p>In the implementation above, <code>BoundedSemiLattice[A]</code> extends <code>CommutativeMonoid[A]</code> because a bounded semilattice is a commutative monoid (a commutative idempotent one, to be exact).</p>
<h3 id="exercise-boundedsemilattice-instances"><span class="header-section-number">11.3.2</span> Exercise: BoundedSemiLattice Instances</h3>
<p>Implement <code>BoundedSemiLattice</code> type class instances for <code>Ints</code> and for <code>Sets</code>. The instance for <code>Int</code> will technically only hold for non-negative numbers, but you don’t need to model non-negativity explicitly in the types.</p>
<div class="solution">
<p>It’s common to place the instances in the companion object of <code>BoundedSemiLattice</code> so they are in the implicit scope without importing them.</p>
<p>Implementing the instance for <code>Set</code> provides good practice with implicit methods.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> BoundedSemiLattice[A] <span class="kw">extends</span> CommutativeMonoid[A] {
  <span class="kw">def</span> <span class="fu">combine</span>(a1: A, a2: A): A
  <span class="kw">def</span> empty: A
}

<span class="kw">object</span> BoundedSemiLattice {
  <span class="kw">implicit</span> <span class="kw">val</span> intInstance: BoundedSemiLattice[Int] =
    <span class="kw">new</span> BoundedSemiLattice[Int] {
      <span class="kw">def</span> <span class="fu">combine</span>(a1: Int, a2: Int): Int =
        a1 max a2

      <span class="kw">val</span> empty: Int =
        <span class="dv">0</span>
    }

  <span class="kw">implicit</span> <span class="kw">def</span> setInstance[A]: BoundedSemiLattice[Set[A]] =
    <span class="kw">new</span> BoundedSemiLattice[Set[A]]{
      <span class="kw">def</span> <span class="fu">combine</span>(a1: Set[A], a2: Set[A]): Set[A] =
        a1 union a2

      <span class="kw">val</span> empty: Set[A] =
        Set.<span class="fu">empty</span>[A]
    }
}</code></pre></div>
</div>
<h3 id="exercise-generic-gcounter"><span class="header-section-number">11.3.3</span> Exercise: Generic GCounter</h3>
<p>Using <code>CommutativeMonoid</code> and <code>BoundedSemiLattice</code>, generalise <code>GCounter</code>.</p>
<p>When you implement this, look for opportunities to use methods and syntax on <code>Monoid</code> to simplify your implementation. This is a good example of how type class abstractions work at multiple levels in our code. We’re using monoids to design a large component—our CRDTs—but they are also useful in the small, simplifying our code and making it shorter and clearer.</p>
<div class="solution">
<p>Here’s a working implementation. Note the use of <code>|+|</code> in the definition of <code>merge</code>, which significantly simplifies the process of merging and maximising counters:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">map</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">foldable</span>._  <span class="co">// for combineAll</span>

<span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> GCounter[A](counters: Map[String,A]) {
  <span class="kw">def</span> <span class="fu">increment</span>(machine: String, amount: A)
        (<span class="kw">implicit</span> m: CommutativeMonoid[A]): GCounter[A] = {
    <span class="kw">val</span> value = amount |+| counters.<span class="fu">getOrElse</span>(machine, m.<span class="fu">empty</span>)
    <span class="fu">GCounter</span>(counters + (machine -&gt; value))
  }

  <span class="kw">def</span> <span class="fu">merge</span>(that: GCounter[A])
        (<span class="kw">implicit</span> b: BoundedSemiLattice[A]): GCounter[A] =
    <span class="fu">GCounter</span>(<span class="kw">this</span>.<span class="fu">counters</span> |+| that.<span class="fu">counters</span>)

  <span class="kw">def</span> <span class="fu">total</span>(<span class="kw">implicit</span> m: CommutativeMonoid[A]): A =
    <span class="kw">this</span>.<span class="fu">counters</span>.<span class="fu">values</span>.<span class="fu">toList</span>.<span class="fu">combineAll</span>
}</code></pre></div>
</div>
<h2 id="abstracting-gcounter-to-a-type-class"><span class="header-section-number">11.4</span> Abstracting GCounter to a Type Class</h2>
<p>We’ve created a generic GCounter that works with any value that has instances of <code>BoundedSemiLattice</code> and <code>CommutativeMonoid</code>. However we’re still tied to a particular representation of the map from machine IDs to values. There is no need to have this restriction, and indeed it can be useful to abstract away from it. There are many key-value stores that we want to work with, from a simple <code>Map</code> to a relational database.</p>
<p>If we define a <code>GCounter</code> type class we can abstract over different concrete implementations. This allows us to, for example, seamlessly substitute an in-memory store for a persistent store when we want to change performance and durability tradeoffs.</p>
<p>There are a number of ways we can implement this. One approach is to define a <code>GCounter</code> type class with dependencies on <code>CommutativeMonoid</code> and <code>BoundedSemiLattice</code>. We define this as a type class that takes a type constructor with <em>two</em> type parameters represent the key and value types of the map abstraction.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> GCounter[F[_,_],K, V] {
  <span class="kw">def</span> <span class="fu">increment</span>(f: F[K, V])(k: K, v: V)
        (<span class="kw">implicit</span> m: CommutativeMonoid[V]): F[K, V]

  <span class="kw">def</span> <span class="fu">merge</span>(f1: F[K, V], f2: F[K, V])
        (<span class="kw">implicit</span> b: BoundedSemiLattice[V]): F[K, V]

  <span class="kw">def</span> <span class="fu">total</span>(f: F[K, V])
        (<span class="kw">implicit</span> m: CommutativeMonoid[V]): V
}

<span class="kw">object</span> GCounter {
  <span class="kw">def</span> apply[F[_,_], K, V]
        (<span class="kw">implicit</span> counter: GCounter[F, K, V]) =
    counter
}</code></pre></div>
<p>Try defining an instance of this type class for <code>Map</code>. You should be able to reuse your code from the case class version of <code>GCounter</code> with some minor modifications.</p>
<div class="solution">
<p>Here’s the complete code for the instance. Write this definition in the companion object for <code>GCounter</code> to place it in glocal implicit scope:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">list</span>._   <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">map</span>._    <span class="co">// for Monoid</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">semigroup</span>._ <span class="co">// for |+|</span>
<span class="kw">import</span> cats.<span class="fu">syntax</span>.<span class="fu">foldable</span>._  <span class="co">// for combineAll</span>

<span class="kw">implicit</span> <span class="kw">def</span> mapInstance[K, V]: GCounter[Map, K, V] =
  <span class="kw">new</span> GCounter[Map, K, V] {
    <span class="kw">def</span> <span class="fu">increment</span>(map: Map[K, V])(key: K, value: V)
          (<span class="kw">implicit</span> m: CommutativeMonoid[V]): Map[K, V] = {
      <span class="kw">val</span> total = map.<span class="fu">getOrElse</span>(key, m.<span class="fu">empty</span>) |+| value
      map + (key -&gt; total)
    }

    <span class="kw">def</span> <span class="fu">merge</span>(map1: Map[K, V], map2: Map[K, V])
          (<span class="kw">implicit</span> b: BoundedSemiLattice[V]): Map[K, V] =
      map1 |+| map2

    <span class="kw">def</span> <span class="fu">total</span>(map: Map[K, V])
        (<span class="kw">implicit</span> m: CommutativeMonoid[V]): V =
      map.<span class="fu">values</span>.<span class="fu">toList</span>.<span class="fu">combineAll</span>
  }</code></pre></div>
</div>
<p>You should be able to use your instance as follows:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> cats.<span class="fu">instances</span>.<span class="fu">int</span>._ <span class="co">// for Monoid</span>

<span class="kw">val</span> g1 = Map(<span class="st">&quot;a&quot;</span> -&gt; <span class="dv">7</span>, <span class="st">&quot;b&quot;</span> -&gt; <span class="dv">3</span>)
<span class="kw">val</span> g2 = Map(<span class="st">&quot;a&quot;</span> -&gt; <span class="dv">2</span>, <span class="st">&quot;b&quot;</span> -&gt; <span class="dv">5</span>)

<span class="kw">val</span> counter = GCounter[Map, String, Int]

<span class="kw">val</span> merged = counter.<span class="fu">merge</span>(g1, g2)
<span class="co">// merged: Map[String,Int] = Map(a -&gt; 7, b -&gt; 5)</span>

<span class="kw">val</span> total  = counter.<span class="fu">total</span>(merged)
<span class="co">// total: Int = 12</span></code></pre></div>
<p>The implementation strategy for the type class instance is a bit unsatisfying. Although the structure of the implementation will be the same for most instances we define, we won’t get any code reuse.</p>
<h2 id="abstracting-a-key-value-store"><span class="header-section-number">11.5</span> Abstracting a Key Value Store</h2>
<p>One solution is to capture the idea of a key-value store within a type class, and then generate <code>GCounter</code> instances for any type that has a <code>KeyValueStore</code> instance. Here’s the code for such a type class:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> KeyValueStore[F[_,_]] {
  <span class="kw">def</span> put[K, V](f: F[K, V])(k: K, v: V): F[K, V]

  <span class="kw">def</span> get[K, V](f: F[K, V])(k: K): Option[V]

  <span class="kw">def</span> getOrElse[K, V](f: F[K, V])(k: K, default: V): V =
    <span class="fu">get</span>(f)(k).<span class="fu">getOrElse</span>(default)

  <span class="kw">def</span> values[K, V](f: F[K, V]): List[V]
}</code></pre></div>
<p>Implement your own instance for <code>Map</code>.</p>
<div class="solution">
<p>Here’s the code for the instance. Write the definition in the companion object for <code>KeyValueStore</code> to place it in global implicit scope:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">val</span> mapInstance: KeyValueStore[Map] =
  <span class="kw">new</span> KeyValueStore[Map] {
    <span class="kw">def</span> put[K, V](f: Map[K, V])(k: K, v: V): Map[K, V] =
      f + (k -&gt; v)

    <span class="kw">def</span> get[K, V](f: Map[K, V])(k: K): Option[V] =
      f.<span class="fu">get</span>(k)

    <span class="kw">override</span> <span class="kw">def</span> getOrElse[K, V](f: Map[K, V])
        (k: K, default: V): V =
      f.<span class="fu">getOrElse</span>(k, default)

    <span class="kw">def</span> values[K, V](f: Map[K, V]): List[V] =
      f.<span class="fu">values</span>.<span class="fu">toList</span>
  }</code></pre></div>
</div>
<p>With our type class in place we can implement syntax to enhance data types for which we have instances:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">class</span> KvsOps[F[_,_], K, V](f: F[K, V]) {
  <span class="kw">def</span> <span class="fu">put</span>(key: K, value: V)
        (<span class="kw">implicit</span> kvs: KeyValueStore[F]): F[K, V] =
    kvs.<span class="fu">put</span>(f)(key, value)

  <span class="kw">def</span> <span class="fu">get</span>(key: K)(<span class="kw">implicit</span> kvs: KeyValueStore[F]): Option[V] =
    kvs.<span class="fu">get</span>(f)(key)

  <span class="kw">def</span> <span class="fu">getOrElse</span>(key: K, default: V)
        (<span class="kw">implicit</span> kvs: KeyValueStore[F]): V =
    kvs.<span class="fu">getOrElse</span>(f)(key, default)

  <span class="kw">def</span> <span class="fu">values</span>(<span class="kw">implicit</span> kvs: KeyValueStore[F]): List[V] =
    kvs.<span class="fu">values</span>(f)
}</code></pre></div>
<p>Now we can generate <code>GCounter</code> instances for any data type that has instances of <code>KeyValueStore</code> and <code>CommutativeMonoid</code> using an <code>implicit def</code>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">implicit</span> <span class="kw">def</span> gcounterInstance[F[_,_], K, V]
    (<span class="kw">implicit</span> kvs: KeyValueStore[F], km: CommutativeMonoid[F[K, V]]) =
  <span class="kw">new</span> GCounter[F, K, V] {
    <span class="kw">def</span> <span class="fu">increment</span>(f: F[K, V])(key: K, value: V)
          (<span class="kw">implicit</span> m: CommutativeMonoid[V]): F[K, V] = {
      <span class="kw">val</span> total = f.<span class="fu">getOrElse</span>(key, m.<span class="fu">empty</span>) |+| value
      f.<span class="fu">put</span>(key, total)
    }

    <span class="kw">def</span> <span class="fu">merge</span>(f1: F[K, V], f2: F[K, V])
          (<span class="kw">implicit</span> b: BoundedSemiLattice[V]): F[K, V] =
      f1 |+| f2

    <span class="kw">def</span> <span class="fu">total</span>(f: F[K, V])(<span class="kw">implicit</span> m: CommutativeMonoid[V]): V =
      f.<span class="fu">values</span>.<span class="fu">combineAll</span>
  }</code></pre></div>
<p>The complete code for this case study is quite long, but most of it is boilerplate setting up syntax for operations on the type class. We can cut down on this using compiler plugins such as <a href="https://github.com/mpilquist/simulacrum">Simulacrum</a> and <a href="https://github.com/non/kind-projector">Kind Projector</a>.</p>
<h2 id="summary-10"><span class="header-section-number">11.6</span> Summary</h2>
<p>In this case study we’ve seen how we can use type classes to model a simple CRDT, the GCounter, in Scala. Our implementation gives us a lot of flexibility and code reuse: we aren’t tied to the data type we “count”, nor to the data type that maps machine IDs to counters.</p>
<p>The focus in this case study has been on using the tools that Scala provides, not on exploring CRDTs. There are many other CRDTs, some of which operate in a similar manner to the GCounter, and some of which have very different implementations. A <a href="https://hal.inria.fr/inria-00609399v2/document">fairly recent survey</a> gives a good overview of many of the basic CRDTs. However this is an active area of research and we encourage you to read the recent publications in the field if CRDTs and eventually consistency interest you.</p>
<p> </p>

<p></p>
<p>   </p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>We assume you are using SBT 0.13.13 or newer.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>The word “class” doesn’t strictly mean <code>class</code> in the Scala or Java sense.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>You may occasionally see extension methods referred to as “type enrichment” or “pimping”. These are older terms that we don’t use anymore.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>If you’re interested in the finer rules of implicit resolution in Scala, start by taking a look at <a href="https://stackoverflow.com/questions/5598085/where-does-scala-look-for-implicits">this Stack Overflow post on implicit scope</a> and <a href="http://eed3si9n.com/revisiting-implicits-without-import-tax">this blog post on implicit priority</a>.<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p><code>implicit objects</code> are treated the same way.<a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>In some libraries and languages, notably Scalaz and Haskell, <code>pure</code> is referred to as <code>point</code> or <code>return</code> and <code>flatMap</code> is referred to as <code>bind</code> or <code>&gt;&gt;=</code>. This is purely a difference in terminology. We’ll use the term <code>flatMap</code> for compatibility with Cats and the Scala standard library.<a href="#fnref6">↩</a></p></li>
<li id="fn7"><p>Cats provides an instance of <code>MonadError</code> for <code>EitherT</code>, allowing us to create instances using <code>raiseError</code> as well as <code>pure</code>.<a href="#fnref7">↩</a></p></li>
<li id="fn8"><p>It is a well known fact that Autobot neural nets are implemented in Scala. Decepticon brains are, of course, dynamically typed.<a href="#fnref8">↩</a></p></li>
<li id="fn9"><p>It is also the winner of Underscore’s 2017 award for the most difficult functional programming term to work into a coherent English sentence.<a href="#fnref9">↩</a></p></li>
<li id="fn10"><p>Semigroupal is referred to as “monoidal” in the paper.<a href="#fnref10">↩</a></p></li>
<li id="fn11"><p>See <a href="https://github.com/tpolecat/cats-infographic">Rob Norris’ infographic</a> for a the complete picture.<a href="#fnref11">↩</a></p></li>
<li id="fn12"><p>Technically this is a <em>warning</em> not an error. It has been promoted to an error in our case because we’re using the <code>-Xfatal-warnings</code> flag on <code>scalac</code>.<a href="#fnref12">↩</a></p></li>
<li id="fn13"><p>In Hadoop there is also a shuffle phase that we will ignore here.<a href="#fnref13">↩</a></p></li>
<li id="fn14"><p>A closely related library called <a href="https://github.com/non/spire">Spire</a> already provides that abstractions.<a href="#fnref14">↩</a></p></li>
</ol>
</div>
</article>

</div>

<footer>
  <div class="container">
    <div class="text-center">
      <img class="footer-brand" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNS4xLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB3aWR0aD0iMjcycHgiIGhlaWdodD0iMTIwcHgiIHZpZXdCb3g9IjAgMCAyNzIgMTIwIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNzIgMTIwIiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJCRyI+DQo8L2c+DQo8ZyBpZD0iTG9nb18xXyI+DQoJPGcgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAgICAiPg0KCQk8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMTguMzA5LDg5LjE0NHYxNi4xNjRjMCwxLjU1NCwwLjM1OSwyLjc1NiwxLjA3OSwzLjYwNmMwLjcxOSwwLjg1MiwxLjc5NywxLjI3NywzLjIzNSwxLjI3Nw0KCQkJYzEuMDU4LDAsMi4wNDktMC4yMzUsMi45NzUtMC43MDdjMC45MjUtMC40NzEsMS44MDEtMS4xMTksMi42MjctMS45NDVWODkuMTQ0aDYuMTI0djI1LjQzNmgtMy43NDQNCgkJCWMtMC43OTMsMC0xLjMxMy0wLjM3Mi0xLjU2Mi0xLjExNWwtMC40MjEtMi4wMzNjLTAuNTI5LDAuNTI5LTEuMDc1LDEuMDEzLTEuNjM2LDEuNDVjLTAuNTYyLDAuNDM4LTEuMTYxLDAuODEtMS43OTcsMS4xMTUNCgkJCWMtMC42MzYsMC4zMDctMS4zMjIsMC41NDYtMi4wNTgsMC43MmMtMC43MzUsMC4xNzMtMS41MjQsMC4yNi0yLjM2OCwwLjI2Yy0xLjM4OCwwLTIuNjE1LTAuMjM1LTMuNjgxLTAuNzA2DQoJCQljLTEuMDY2LTAuNDcyLTEuOTYzLTEuMTM3LTIuNjktMS45OTZjLTAuNzI4LTAuODU5LTEuMjc2LTEuODgtMS42NDgtMy4wNjJzLTAuNTU4LTIuNDgyLTAuNTU4LTMuOTA0Vjg5LjE0NEgxOC4zMDl6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik00MC44OTMsMTE0LjU3OVY4OS4xNDRoMy43NDNjMC43OTMsMCwxLjMxNCwwLjM3MiwxLjU2MiwxLjExNmwwLjQyMSwyLjAwOA0KCQkJYzAuNTEyLTAuNTI4LDEuMDU0LTEuMDA4LDEuNjI0LTEuNDM4YzAuNTctMC40MywxLjE3My0wLjgwMiwxLjgxLTEuMTE2YzAuNjM2LTAuMzEzLDEuMzE3LTAuNTUzLDIuMDQ1LTAuNzE5DQoJCQljMC43MjctMC4xNjUsMS41MjEtMC4yNDgsMi4zOC0wLjI0OGMxLjM4OCwwLDIuNjIsMC4yMzUsMy42OTQsMC43MDdjMS4wNzQsMC40NzEsMS45NzEsMS4xMzIsMi42OSwxLjk4Mw0KCQkJYzAuNzE5LDAuODUxLDEuMjY0LDEuODY3LDEuNjM2LDMuMDQ5YzAuMzcyLDEuMTgyLDAuNTU4LDIuNDgzLDAuNTU4LDMuOTA0djE2LjE4OGgtNi4xMjNWOTguMzkxYzAtMS41NTMtMC4zNi0yLjc1Ni0xLjA3OS0zLjYwNg0KCQkJYy0wLjcxOS0wLjg1Mi0xLjc5Ny0xLjI3Ny0zLjIzNS0xLjI3N2MtMS4wNTgsMC0yLjA0OSwwLjI0LTIuOTc1LDAuNzE5Yy0wLjkyNiwwLjQ4LTEuODAyLDEuMTMzLTIuNjI4LDEuOTU5djE4LjM5NUg0MC44OTN6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik04Ni45NzgsMTE0LjU3OWMtMC43OTMsMC0xLjMxMy0wLjM3Mi0xLjU2Mi0xLjExNWwtMC40OTYtMi40NTVjLTAuNTI5LDAuNTk2LTEuMDgzLDEuMTMzLTEuNjYxLDEuNjEyDQoJCQljLTAuNTc5LDAuNDc5LTEuMjAzLDAuODkyLTEuODcyLDEuMjM5Yy0wLjY2OSwwLjM0Ny0xLjM4OSwwLjYxNS0yLjE1NywwLjgwNmMtMC43NjksMC4xODktMS41OTksMC4yODUtMi40OTIsMC4yODUNCgkJCWMtMS4zODgsMC0yLjY2MS0wLjI5LTMuODE4LTAuODY4cy0yLjE1My0xLjQxNy0yLjk4Ny0yLjUxNmMtMC44MzQtMS4xLTEuNDc5LTIuNDU4LTEuOTM0LTQuMDc4cy0wLjY4Mi0zLjQ3MS0wLjY4Mi01LjU1NA0KCQkJYzAtMS44ODQsMC4yNTYtMy42MzYsMC43NjktNS4yNTVjMC41MTItMS42MiwxLjI0OC0zLjAyNCwyLjIwNy00LjIxNWMwLjk1OC0xLjE4OSwyLjEwNy0yLjExOSwzLjQ0Ni0yLjc4OQ0KCQkJYzEuMzM4LTAuNjY5LDIuODQyLTEuMDA0LDQuNTEyLTEuMDA0YzEuNDIxLDAsMi42MzYsMC4yMjgsMy42NDQsMC42ODJjMS4wMDgsMC40NTUsMS45MDksMS4wNjIsMi43MDIsMS44MjJWNzcuNzRoNi4xMjR2MzYuODM5DQoJCQlIODYuOTc4eiBNNzguODIyLDExMC4wOTJjMS4yNzIsMCwyLjM1NS0wLjI2NCwzLjI0OC0wLjc5M3MxLjczNS0xLjI4LDIuNTI4LTIuMjU2Vjk1LjYzOWMtMC42OTQtMC44NDMtMS40NS0xLjQzOC0yLjI2OC0xLjc4NA0KCQkJYy0wLjgxOC0wLjM0OC0xLjY5OC0wLjUyMS0yLjY0LTAuNTIxYy0wLjkyNiwwLTEuNzY1LDAuMTczLTIuNTE2LDAuNTIxYy0wLjc1MiwwLjM0Ny0xLjM4OSwwLjg3Mi0xLjkwOSwxLjU3NA0KCQkJcy0wLjkyMSwxLjU5NS0xLjIwMiwyLjY3N2MtMC4yODEsMS4wODMtMC40MjEsMi4zNTktMC40MjEsMy44M2MwLDEuNDg4LDAuMTIsMi43NDgsMC4zNTksMy43ODENCgkJCWMwLjIzOSwxLjAzMywwLjU4MywxLjg3NiwxLjAyOSwyLjUyOGMwLjQ0NiwwLjY1MywwLjk5MiwxLjEyNCwxLjYzNiwxLjQxM1M3OC4wMjksMTEwLjA5Miw3OC44MjIsMTEwLjA5MnoiLz4NCgkJPHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0iTTEwNy44NTIsODguNzQ3YzEuNjAzLDAsMy4wNzgsMC4yNTcsNC40MjUsMC43NjljMS4zNDcsMC41MTMsMi41MDgsMS4yNjEsMy40ODMsMi4yNDQNCgkJCWMwLjk3NSwwLjk4MywxLjczNSwyLjE4OSwyLjI4MSwzLjYxOXMwLjgxOCwzLjA2MiwwLjgxOCw0Ljg5NmMwLDAuNDYzLTAuMDIxLDAuODQ3LTAuMDYyLDEuMTUyDQoJCQljLTAuMDQyLDAuMzA2LTAuMTE2LDAuNTQ1LTAuMjIzLDAuNzE5cy0wLjI1MiwwLjI5OC0wLjQzNCwwLjM3MmMtMC4xODIsMC4wNzQtMC40MTQsMC4xMTEtMC42OTQsMC4xMTFoLTE1LjcxNw0KCQkJYzAuMTgyLDIuNjExLDAuODg0LDQuNTI4LDIuMTA3LDUuNzUyYzEuMjIzLDEuMjIzLDIuODQyLDEuODM0LDQuODU5LDEuODM0YzAuOTkyLDAsMS44NDctMC4xMTUsMi41NjYtMC4zNDcNCgkJCWMwLjcxOS0wLjIzMSwxLjM0Ny0wLjQ4NywxLjg4NC0wLjc2OXMxLjAwOC0wLjUzNywxLjQxMy0wLjc2OWMwLjQwNS0wLjIzMSwwLjc5Ny0wLjM0OCwxLjE3OC0wLjM0OA0KCQkJYzAuMjQ4LDAsMC40NjIsMC4wNSwwLjY0NSwwLjE0OWMwLjE4MiwwLjA5OSwwLjMzOCwwLjIzOSwwLjQ3MSwwLjQyMWwxLjc4NSwyLjIzMWMtMC42NzgsMC43OTMtMS40MzgsMS40NTktMi4yODEsMS45OTYNCgkJCXMtMS43MjMsMC45NjctMi42NCwxLjI4OWMtMC45MTcsMC4zMjItMS44NTEsMC41NDktMi44MDEsMC42ODJjLTAuOTUxLDAuMTMyLTEuODcyLDAuMTk4LTIuNzY0LDAuMTk4DQoJCQljLTEuNzY5LDAtMy40MTMtMC4yOTQtNC45MzMtMC44OGMtMS41MjEtMC41ODctMi44NDMtMS40NTQtMy45NjctMi42MDRjLTEuMTI0LTEuMTQ4LTIuMDA4LTIuNTY5LTIuNjUyLTQuMjY0DQoJCQlzLTAuOTY3LTMuNjU3LTAuOTY3LTUuODg4YzAtMS43MzUsMC4yODEtMy4zNjcsMC44NDMtNC44OTZjMC41NjItMS41MjgsMS4zNjctMi44NTksMi40MTctMy45OTENCgkJCWMxLjA0OS0xLjEzMiwyLjMzLTIuMDI4LDMuODQyLTIuNjg5QzEwNC4yNDUsODkuMDc4LDEwNS45NTEsODguNzQ3LDEwNy44NTIsODguNzQ3eiBNMTA3Ljk3Niw5My4xMzYNCgkJCWMtMS43ODUsMC0zLjE4MiwwLjUwNC00LjE5LDEuNTEyYy0xLjAwOCwxLjAwOS0xLjY1MywyLjQzOC0xLjkzNCw0LjI4OWgxMS41MDNjMC0wLjc5NC0wLjEwOC0xLjU0MS0wLjMyMi0yLjI0NA0KCQkJYy0wLjIxNS0wLjcwMi0wLjU0NS0xLjMxNy0wLjk5Mi0xLjg0N2MtMC40NDYtMC41MjgtMS4wMDgtMC45NDUtMS42ODYtMS4yNTJDMTA5LjY3Nyw5My4yODgsMTA4Ljg4NCw5My4xMzYsMTA3Ljk3Niw5My4xMzZ6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0xMjMuODQxLDExNC41NzlWODkuMTQ0aDMuNTk1YzAuNjI4LDAsMS4wNjYsMC4xMTYsMS4zMTMsMC4zNDhjMC4yNDgsMC4yMzEsMC40MTMsMC42MjgsMC40OTYsMS4xODkNCgkJCWwwLjM3MiwzLjA3NGMwLjkwOS0xLjU2OSwxLjk3NS0yLjgxLDMuMTk4LTMuNzE5YzEuMjIzLTAuOTA4LDIuNTk0LTEuMzYzLDQuMTE1LTEuMzYzYzEuMjU2LDAsMi4yOTcsMC4yODksMy4xMjQsMC44NjgNCgkJCWwtMC43OTQsNC41ODZjLTAuMDQ5LDAuMjk4LTAuMTU2LDAuNTA4LTAuMzIyLDAuNjMyYy0wLjE2NCwwLjEyNC0wLjM4OCwwLjE4Ny0wLjY2OCwwLjE4N2MtMC4yNDgsMC0wLjU4OC0wLjA1OC0xLjAxOC0wLjE3NA0KCQkJYy0wLjQzLTAuMTE1LTEtMC4xNzQtMS43MS0wLjE3NGMtMS4yNzMsMC0yLjM2NCwwLjM1Mi0zLjI3MiwxLjA1NGMtMC45MDksMC43MDMtMS42NzgsMS43MzEtMi4zMDYsMy4wODd2MTUuODQxSDEyMy44NDF6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0xNTkuMTkxLDk0LjEwM2MtMC4xNjUsMC4yNjQtMC4zMzksMC40NS0wLjUyMSwwLjU1OGMtMC4xODMsMC4xMDctMC40MTMsMC4xNjEtMC42OTQsMC4xNjENCgkJCWMtMC4yOTcsMC0wLjYxNS0wLjA4My0wLjk1NC0wLjI0OHMtMC43MzEtMC4zNTEtMS4xNzgtMC41NThzLTAuOTU0LTAuMzkzLTEuNTI0LTAuNTU4cy0xLjI0NC0wLjI0OC0yLjAyMS0wLjI0OA0KCQkJYy0xLjIwNiwwLTIuMTU3LDAuMjU2LTIuODUxLDAuNzY5Yy0wLjY5NCwwLjUxMi0xLjA0MSwxLjE4Mi0xLjA0MSwyLjAwOGMwLDAuNTQ1LDAuMTc3LDEuMDA0LDAuNTMzLDEuMzc2DQoJCQljMC4zNTQsMC4zNzIsMC44MjYsMC42OTgsMS40MTIsMC45NzljMC41ODcsMC4yODEsMS4yNTIsMC41MzMsMS45OTYsMC43NTdjMC43NDQsMC4yMjMsMS41MDQsMC40NjcsMi4yOCwwLjczMQ0KCQkJczEuNTM3LDAuNTY2LDIuMjgsMC45MDRjMC43NDQsMC4zMzksMS40MSwwLjc2OSwxLjk5NiwxLjI4OWMwLjU4NywwLjUyMSwxLjA1OCwxLjE0NSwxLjQxMywxLjg3MnMwLjUzMywxLjYwNCwwLjUzMywyLjYyOA0KCQkJYzAsMS4yMjMtMC4yMjQsMi4zNTEtMC42NjksMy4zODRjLTAuNDQ3LDEuMDMzLTEuMSwxLjkyNi0xLjk1OSwyLjY3N2MtMC44NTksMC43NTMtMS45MjEsMS4zMzktMy4xODYsMS43NjENCgkJCWMtMS4yNjQsMC40MjEtMi43MTUsMC42MzItNC4zNTEsMC42MzJjLTAuODc2LDAtMS43MzEtMC4wNzgtMi41NjUtMC4yMzVjLTAuODM1LTAuMTU3LTEuNjM3LTAuMzc2LTIuNDA1LTAuNjU3DQoJCQljLTAuNzY5LTAuMjgtMS40NzktMC42MTEtMi4xMzItMC45OTFjLTAuNjUzLTAuMzgtMS4yMjctMC43OTMtMS43MjMtMS4yMzlsMS40MTItMi4zMzFjMC4xODItMC4yOCwwLjM5Ny0wLjQ5NSwwLjY0NS0wLjY0NQ0KCQkJYzAuMjQ4LTAuMTQ4LDAuNTYyLTAuMjIzLDAuOTQzLTAuMjIzYzAuMzc5LDAsMC43MzgsMC4xMDcsMS4wNzgsMC4zMjJjMC4zMzgsMC4yMTUsMC43MywwLjQ0NiwxLjE3OCwwLjY5NA0KCQkJYzAuNDQ1LDAuMjQ4LDAuOTcxLDAuNDc5LDEuNTc0LDAuNjkzYzAuNjAzLDAuMjE2LDEuMzY3LDAuMzIyLDIuMjkzLDAuMzIyYzAuNzI3LDAsMS4zNTEtMC4wODYsMS44NzEtMC4yNg0KCQkJYzAuNTIxLTAuMTc0LDAuOTUtMC40LDEuMjg5LTAuNjgyczAuNTg2LTAuNjA3LDAuNzQ0LTAuOTc5YzAuMTU2LTAuMzcyLDAuMjM1LTAuNzU2LDAuMjM1LTEuMTUyYzAtMC41OTYtMC4xNzgtMS4wODMtMC41MzMtMS40NjMNCgkJCXMtMC44MjctMC43MTEtMS40MTMtMC45OTFjLTAuNTg2LTAuMjgxLTEuMjU2LTAuNTMzLTIuMDA4LTAuNzU3Yy0wLjc1Mi0wLjIyMy0xLjUyMS0wLjQ2Ny0yLjMwNi0wLjczMQ0KCQkJYy0wLjc4NS0wLjI2NC0xLjU1NC0wLjU3My0yLjMwNi0wLjkzYy0wLjc1Mi0wLjM1NC0xLjQyMi0wLjgwNi0yLjAwOC0xLjM1MWMtMC41ODctMC41NDYtMS4wNTgtMS4yMTUtMS40MTMtMi4wMDgNCgkJCWMtMC4zNTUtMC43OTQtMC41MzItMS43NTItMC41MzItMi44NzZjMC0xLjA0MSwwLjIwNS0yLjAzMywwLjYxOS0yLjk3NWMwLjQxMi0wLjk0MiwxLjAyLTEuNzY1LDEuODIyLTIuNDY3DQoJCQljMC44MDEtMC43MDIsMS44MDEtMS4yNjUsMy0xLjY4NmMxLjE5Ny0wLjQyMiwyLjU4Mi0wLjYzMyw0LjE1Mi0wLjYzM2MxLjc1MSwwLDMuMzQ2LDAuMjksNC43ODQsMC44NjgNCgkJCWMxLjQzOCwwLjU3OCwyLjYzNiwxLjMzOSwzLjU5NSwyLjI4TDE1OS4xOTEsOTQuMTAzeiIvPg0KCQk8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMTgzLjYzNSw5NC41MjNjLTAuMTgyLDAuMjMxLTAuMzU5LDAuNDEzLTAuNTMzLDAuNTQ2Yy0wLjE3NCwwLjEzMi0wLjQyNiwwLjE5OC0wLjc1NiwwLjE5OA0KCQkJYy0wLjMxNCwwLTAuNjItMC4wOTYtMC45MTgtMC4yODVjLTAuMjk3LTAuMTktMC42NTItMC40MDUtMS4wNjUtMC42NDVzLTAuOTA1LTAuNDU1LTEuNDc2LTAuNjQ1DQoJCQljLTAuNTctMC4xOS0xLjI3Ni0wLjI4NS0yLjExOS0wLjI4NWMtMS4wNzQsMC0yLjAxNywwLjE5NC0yLjgyNiwwLjU4MmMtMC44MTEsMC4zODktMS40ODMsMC45NDYtMi4wMjEsMS42NzQNCgkJCXMtMC45MzgsMS42MDctMS4yMDIsMi42NGMtMC4yNjUsMS4wMzMtMC4zOTYsMi4yMDMtMC4zOTYsMy41MDhjMCwxLjM1NSwwLjE0NSwyLjU2MiwwLjQzNCwzLjYyczAuNzA3LDEuOTQ2LDEuMjUyLDIuNjY1DQoJCQlzMS4yMDYsMS4yNjQsMS45ODMsMS42MzZjMC43NzYsMC4zNzIsMS42NTIsMC41NTgsMi42MjgsMC41NThjMC45NzUsMCwxLjc2NC0wLjExOSwyLjM2Ny0wLjM1OQ0KCQkJYzAuNjA0LTAuMjM5LDEuMTExLTAuNTA0LDEuNTI1LTAuNzkzYzAuNDEyLTAuMjg5LDAuNzcxLTAuNTU0LDEuMDc4LTAuNzkzYzAuMzA1LTAuMjQsMC42NDgtMC4zNiwxLjAyOC0wLjM2DQoJCQljMC40OTYsMCwwLjg2OCwwLjE5LDEuMTE2LDAuNTdsMS43NiwyLjIzMWMtMC42NzgsMC43OTMtMS40MTMsMS40NTktMi4yMDcsMS45OTZjLTAuNzkzLDAuNTM3LTEuNjE1LDAuOTY3LTIuNDY3LDEuMjg5DQoJCQljLTAuODUxLDAuMzIyLTEuNzMsMC41NDktMi42NCwwLjY4MmMtMC45MDksMC4xMzItMS44MSwwLjE5OC0yLjcwMiwwLjE5OGMtMS41NywwLTMuMDQ5LTAuMjk0LTQuNDM4LTAuODgNCgkJCWMtMS4zODktMC41ODctMi42LTEuNDQyLTMuNjMyLTIuNTY2Yy0xLjAzMy0xLjEyMy0xLjg1MS0yLjQ5OS0yLjQ1NC00LjEyN3MtMC45MDQtMy40ODMtMC45MDQtNS41NjYNCgkJCWMwLTEuODY3LDAuMjY4LTMuNTk4LDAuODA1LTUuMTkzYzAuNTM3LTEuNTk1LDEuMzI2LTIuOTc1LDIuMzY3LTQuMTRjMS4wNDItMS4xNjUsMi4zMzEtMi4wNzgsMy44NjgtMi43MzkNCgkJCWMxLjUzNi0wLjY2MSwzLjMwNi0wLjk5Miw1LjMwNi0wLjk5MmMxLjg5OSwwLDMuNTY0LDAuMzA3LDQuOTk0LDAuOTE4czIuNzE1LDEuNDg3LDMuODU1LDIuNjI3TDE4My42MzUsOTQuNTIzeiIvPg0KCQk8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMjAwLjI2OSw4OC43NDdjMS45LDAsMy42MjQsMC4zMDcsNS4xNjksMC45MThzMi44NjMsMS40NzksMy45NTQsMi42MDNzMS45MzQsMi40OTYsMi41MjgsNC4xMTUNCgkJCWMwLjU5NiwxLjYyLDAuODkzLDMuNDMsMC44OTMsNS40MjljMCwyLjAxNy0wLjI5NywzLjgzNS0wLjg5Myw1LjQ1NGMtMC41OTUsMS42Mi0xLjQzOCwzLTIuNTI4LDQuMTQxDQoJCQljLTEuMDkxLDEuMTQtMi40MDksMi4wMTctMy45NTQsMi42MjhjLTEuNTQ1LDAuNjEtMy4yNjksMC45MTctNS4xNjksMC45MTdzLTMuNjI4LTAuMzA3LTUuMTgxLTAuOTE3DQoJCQljLTEuNTU1LTAuNjExLTIuODgxLTEuNDg4LTMuOTc5LTIuNjI4Yy0xLjEtMS4xNDEtMS45NTEtMi41MjEtMi41NTUtNC4xNDFjLTAuNjA0LTEuNjE5LTAuOTA0LTMuNDM4LTAuOTA0LTUuNDU0DQoJCQljMC0xLjk5OSwwLjMwMS0zLjgwOSwwLjkwNC01LjQyOWMwLjYwNC0xLjYxOSwxLjQ1NS0yLjk5MSwyLjU1NS00LjExNWMxLjA5OC0xLjEyNCwyLjQyNC0xLjk5MSwzLjk3OS0yLjYwMw0KCQkJQzE5Ni42NDEsODkuMDU0LDE5OC4zNjgsODguNzQ3LDIwMC4yNjksODguNzQ3eiBNMjAwLjI2OSwxMTAuMjQxYzIuMTE2LDAsMy42ODItMC43MTEsNC42OTgtMi4xMzMNCgkJCWMxLjAxNi0xLjQyMSwxLjUyNC0zLjUwMywxLjUyNC02LjI0N2MwLTIuNzQzLTAuNTA5LTQuODM0LTEuNTI0LTYuMjcxYy0xLjAxNy0xLjQzOC0yLjU4Mi0yLjE1Ny00LjY5OC0yLjE1Nw0KCQkJYy0yLjE0OCwwLTMuNzM1LDAuNzI0LTQuNzYsMi4xNjljLTEuMDI0LDEuNDQ2LTEuNTM2LDMuNTMzLTEuNTM2LDYuMjZjMCwyLjcyOCwwLjUxMiw0LjgwNiwxLjUzNiw2LjIzNQ0KCQkJUzE5OC4xMiwxMTAuMjQxLDIwMC4yNjksMTEwLjI0MXoiLz4NCgkJPHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0iTTIxNy41OTgsMTE0LjU3OVY4OS4xNDRoMy41OTRjMC42MjksMCwxLjA2NiwwLjExNiwxLjMxNCwwLjM0OHMwLjQxMiwwLjYyOCwwLjQ5NiwxLjE4OWwwLjM3MSwzLjA3NA0KCQkJYzAuOTA5LTEuNTY5LDEuOTc1LTIuODEsMy4xOTgtMy43MTljMS4yMjMtMC45MDgsMi41OTUtMS4zNjMsNC4xMTQtMS4zNjNjMS4yNTYsMCwyLjI5OSwwLjI4OSwzLjEyNSwwLjg2OGwtMC43OTMsNC41ODYNCgkJCWMtMC4wNTEsMC4yOTgtMC4xNTgsMC41MDgtMC4zMjIsMC42MzJjLTAuMTY2LDAuMTI0LTAuMzg5LDAuMTg3LTAuNjcsMC4xODdjLTAuMjQ4LDAtMC41ODgtMC4wNTgtMS4wMTgtMC4xNzQNCgkJCWMtMC40My0wLjExNS0wLjk5OS0wLjE3NC0xLjcwOS0wLjE3NGMtMS4yNzMsMC0yLjM2NCwwLjM1Mi0zLjI3MywxLjA1NGMtMC45MDgsMC43MDMtMS42NzgsMS43MzEtMi4zMDUsMy4wODd2MTUuODQxSDIxNy41OTh6Ii8+DQoJCTxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0yNDguMzYxLDg4Ljc0N2MxLjYwNCwwLDMuMDc4LDAuMjU3LDQuNDI2LDAuNzY5YzEuMzQ3LDAuNTEzLDIuNTA4LDEuMjYxLDMuNDgyLDIuMjQ0DQoJCQljMC45NzYsMC45ODMsMS43MzUsMi4xODksMi4yODEsMy42MTljMC41NDUsMS40MywwLjgxOCwzLjA2MiwwLjgxOCw0Ljg5NmMwLDAuNDYzLTAuMDIxLDAuODQ3LTAuMDYyLDEuMTUyDQoJCQlzLTAuMTE2LDAuNTQ1LTAuMjIzLDAuNzE5Yy0wLjEwOCwwLjE3NC0wLjI1MywwLjI5OC0wLjQzNSwwLjM3MnMtMC40MTMsMC4xMTEtMC42OTMsMC4xMTFoLTE1LjcxOA0KCQkJYzAuMTgyLDIuNjExLDAuODg0LDQuNTI4LDIuMTA3LDUuNzUyYzEuMjIzLDEuMjIzLDIuODQzLDEuODM0LDQuODU4LDEuODM0YzAuOTkyLDAsMS44NDgtMC4xMTUsMi41NjYtMC4zNDcNCgkJCXMxLjM0Ny0wLjQ4NywxLjg4NC0wLjc2OXMxLjAwOC0wLjUzNywxLjQxMy0wLjc2OXMwLjc5Ny0wLjM0OCwxLjE3OC0wLjM0OGMwLjI0OCwwLDAuNDYzLDAuMDUsMC42NDUsMC4xNDkNCgkJCWMwLjE4MiwwLjA5OSwwLjMzOSwwLjIzOSwwLjQ3MSwwLjQyMWwxLjc4NSwyLjIzMWMtMC42NzgsMC43OTMtMS40MzgsMS40NTktMi4yOCwxLjk5NmMtMC44NDQsMC41MzctMS43MjQsMC45NjctMi42NDEsMS4yODkNCgkJCXMtMS44NTIsMC41NDktMi44MDIsMC42ODJjLTAuOTUsMC4xMzItMS44NzEsMC4xOTgtMi43NjQsMC4xOThjLTEuNzY5LDAtMy40MTMtMC4yOTQtNC45MzQtMC44OA0KCQkJYy0xLjUyMS0wLjU4Ny0yLjg0My0xLjQ1NC0zLjk2Ni0yLjYwNGMtMS4xMjUtMS4xNDgtMi4wMDktMi41NjktMi42NTMtNC4yNjRzLTAuOTY3LTMuNjU3LTAuOTY3LTUuODg4DQoJCQljMC0xLjczNSwwLjI4MS0zLjM2NywwLjg0My00Ljg5NmMwLjU2Mi0xLjUyOCwxLjM2OC0yLjg1OSwyLjQxNy0zLjk5MWMxLjA1LTEuMTMyLDIuMzMxLTIuMDI4LDMuODQzLTIuNjg5DQoJCQlDMjQ0Ljc1NSw4OS4wNzgsMjQ2LjQ2MSw4OC43NDcsMjQ4LjM2MSw4OC43NDd6IE0yNDguNDg1LDkzLjEzNmMtMS43ODQsMC0zLjE4MiwwLjUwNC00LjE4OSwxLjUxMg0KCQkJYy0xLjAwOCwxLjAwOS0xLjY1MiwyLjQzOC0xLjkzNCw0LjI4OWgxMS41MDNjMC0wLjc5NC0wLjEwNy0xLjU0MS0wLjMyMi0yLjI0NGMtMC4yMTUtMC43MDItMC41NDYtMS4zMTctMC45OTEtMS44NDcNCgkJCWMtMC40NDYtMC41MjgtMS4wMDktMC45NDUtMS42ODctMS4yNTJDMjUwLjE4OCw5My4yODgsMjQ5LjM5NSw5My4xMzYsMjQ4LjQ4NSw5My4xMzZ6Ii8+DQoJPC9nPg0KCTxwYXRoIGlkPSJJY29uIiBmaWxsPSIjRkZGRkZGIiBkPSJNMTcxLjkyNiwxOS43MDdjLTAuNTAyLTYuNjM5LTYuOTQzLTEyLjYxOC0xNC4wMjktMTMuMDZjLTE1LjA5Mi0wLjg1OS0zMC4xODQtMC44NTktNDUuMjc0LDANCgkJYy03LjA4NywwLjQ0Mi0xMy41MjksNi40MjEtMTQuMDMyLDEzLjA2MWMtMC45MDksMTMuMTI0LTAuOTA5LDI2LjI0OCwwLDM5LjM3MmMwLjUwMyw2LjY0MSw2Ljk0NSwxMi42MTgsMTQuMDMyLDEzLjA2MQ0KCQljMTUuMDkyLDAuODU4LDMwLjE4MywwLjg1OCw0NS4yNzQsMGM3LjA4Ni0wLjQ0MSwxMy41MjctNi40MiwxNC4wMjktMTMuMDYxQzE3Mi44MzUsNDUuOTU0LDE3Mi44MzUsMzIuODMsMTcxLjkyNiwxOS43MDd6DQoJCSBNMTM4Ljg0OCw1Ni43MDNoLTI0Ljc3MXYtNC42OTloMjQuNzcxVjU2LjcwM3ogTTE1NS42MzUsNTYuMTg2Yy0wLjM2NywwLjM2Ny0wLjc5NCwwLjY1NC0xLjI3OSwwLjg1OQ0KCQljLTAuNDg4LDAuMjA0LTEuMDAyLDAuMzA4LTEuNTQxLDAuMzA4Yy0wLjU0MSwwLTEuMDQ5LTAuMTA0LTEuNTIzLTAuMzA4Yy0wLjQ3Ny0wLjIwNS0wLjg5Ni0wLjQ5Mi0xLjI2NC0wLjg1OQ0KCQljLTAuMzY5LTAuMzY3LTAuNjUzLTAuNzg5LTAuODU4LTEuMjYyYy0wLjIwNi0wLjQ3OC0wLjMxLTAuOTg2LTAuMzEtMS41MjdjMC0wLjUzOSwwLjEwNC0xLjA1MywwLjMxLTEuNTM5DQoJCWMwLjIwNS0wLjQ4NiwwLjQ4OS0wLjkxMywwLjg1OC0xLjI4YzAuNzU2LTAuNzU4LDEuNjg3LTEuMTM1LDIuNzg3LTEuMTM1YzAuNTM5LDAsMS4wNTMsMC4wOTgsMS41NDEsMC4yOTMNCgkJYzAuNDg1LDAuMTk0LDAuOTEyLDAuNDc1LDEuMjc5LDAuODQyYzAuNzU2LDAuNzU3LDEuMTM1LDEuNjk2LDEuMTM1LDIuODE5QzE1Ni43Nyw1NC41LDE1Ni4zOTEsNTUuNDMxLDE1NS42MzUsNTYuMTg2eiIvPg0KPC9nPg0KPC9zdmc+DQo=" alt="Underscore" width="200px">
    </div>


    <div class="row sitemap">
      <div class="col-sm-6">
        <h5><a href="http://underscore.io">Underscore</a></h5>
        <ul class="list-unstyled">
          <li><a href="http://underscore.io/training/bookings">Book a Private Course</a></li>
          <li><a href="http://underscore.io/training">Our Course Directory</a></li>
          <li><a href="http://underscore.io/consulting">Our Consulting Services</a></li>
          <li><a href="http://underscore.io/company">About Us</a></li>
        </ul>
      </div>

      <div class="col-sm-6">
        <h5><a href="http://underscore.io/contact">Contact</a></h5>
        <ul class="list-unstyled">
          <li><a href="http://underscore.io">http://underscore.io</a></li>
          <li><a href="tel:+442030955332">+44 (0)20 309 55332</a></li>
          <li><a href="mailto:hello@underscore.io">hello@underscore.io</a></li>
          <li><a href="http://twitter.com/underscoreuk">@underscoreuk</a></li>
        </ul>
      </div>
    </div>

    <p class="copyright text-center">
      Copyright 2014-17 Noel Welsh and Dave Gurnell.
    </p>
  </div>
</footer>

</body>
</html>
